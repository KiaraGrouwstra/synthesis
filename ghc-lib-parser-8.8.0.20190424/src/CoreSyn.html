<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP, DeriveDataTypeable, FlexibleContexts #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-comment">-- | CoreSyn holds all the main data types for use by for the Glasgow Haskell Compiler midsection</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CoreSyn</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>        </span><span class="hs-comment">-- * Main data types</span><span>
</span><a name="line-13"></a><span>        </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#TickishScoping"><span class="hs-identifier hs-type">TickishScoping</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#TickishPlacement"><span class="hs-identifier hs-type">TickishPlacement</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="CoreSyn.html#TaggedExpr"><span class="hs-identifier hs-type">TaggedExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#TaggedAlt"><span class="hs-identifier hs-type">TaggedAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#TaggedBind"><span class="hs-identifier hs-type">TaggedBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#TaggedArg"><span class="hs-identifier hs-type">TaggedArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier hs-type">TaggedBndr</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>        </span><span class="hs-comment">-- * In/Out type synonyms</span><span>
</span><a name="line-19"></a><span>        </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InBind"><span class="hs-identifier hs-type">InBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InAlt"><span class="hs-identifier hs-type">InAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InArg"><span class="hs-identifier hs-type">InArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InType"><span class="hs-identifier hs-type">InType</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InKind"><span class="hs-identifier hs-type">InKind</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>               </span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InCoercion"><span class="hs-identifier hs-type">InCoercion</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#InTyVar"><span class="hs-identifier hs-type">InTyVar</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#InCoVar"><span class="hs-identifier hs-type">InCoVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>        </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutAlt"><span class="hs-identifier hs-type">OutAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutArg"><span class="hs-identifier hs-type">OutArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutType"><span class="hs-identifier hs-type">OutType</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutKind"><span class="hs-identifier hs-type">OutKind</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>               </span><a href="CoreSyn.html#OutBndr"><span class="hs-identifier hs-type">OutBndr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutCoercion"><span class="hs-identifier hs-type">OutCoercion</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutTyVar"><span class="hs-identifier hs-type">OutTyVar</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutCoVar"><span class="hs-identifier hs-type">OutCoVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#MOutCoercion"><span class="hs-identifier hs-type">MOutCoercion</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>
</span><a name="line-24"></a><span>        </span><span class="hs-comment">-- ** 'Expr' construction</span><span>
</span><a name="line-25"></a><span>        </span><a href="CoreSyn.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkLets"><span class="hs-identifier hs-var">mkLets</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkLetNonRec"><span class="hs-identifier hs-var">mkLetNonRec</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkLetRec"><span class="hs-identifier hs-var">mkLetRec</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkTyApps"><span class="hs-identifier hs-var">mkTyApps</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkCoApps"><span class="hs-identifier hs-var">mkCoApps</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkVarApps"><span class="hs-identifier hs-var">mkVarApps</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkTyArg"><span class="hs-identifier hs-var">mkTyArg</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span>        </span><a href="CoreSyn.html#mkIntLit"><span class="hs-identifier hs-var">mkIntLit</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkIntLitInt"><span class="hs-identifier hs-var">mkIntLitInt</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="CoreSyn.html#mkWordLit"><span class="hs-identifier hs-var">mkWordLit</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkWordLitWord"><span class="hs-identifier hs-var">mkWordLitWord</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="CoreSyn.html#mkWord64LitWord64"><span class="hs-identifier hs-var">mkWord64LitWord64</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkInt64LitInt64"><span class="hs-identifier hs-var">mkInt64LitInt64</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="CoreSyn.html#mkCharLit"><span class="hs-identifier hs-var">mkCharLit</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkStringLit"><span class="hs-identifier hs-var">mkStringLit</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="CoreSyn.html#mkFloatLit"><span class="hs-identifier hs-var">mkFloatLit</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkFloatLitFloat"><span class="hs-identifier hs-var">mkFloatLitFloat</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="CoreSyn.html#mkDoubleLit"><span class="hs-identifier hs-var">mkDoubleLit</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkDoubleLitDouble"><span class="hs-identifier hs-var">mkDoubleLitDouble</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span>        </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkConApp2"><span class="hs-identifier hs-var">mkConApp2</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkTyBind"><span class="hs-identifier hs-var">mkTyBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkCoBind"><span class="hs-identifier hs-var">mkCoBind</span></a><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#varsToCoreExprs"><span class="hs-identifier hs-var">varsToCoreExprs</span></a><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>        </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#cmpAltCon"><span class="hs-identifier hs-var">cmpAltCon</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#cmpAlt"><span class="hs-identifier hs-var">cmpAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ltAlt"><span class="hs-identifier hs-var">ltAlt</span></a><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>        </span><span class="hs-comment">-- ** Simple 'Expr' access functions and predicates</span><span>
</span><a name="line-41"></a><span>        </span><a href="CoreSyn.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#bindersOfBinds"><span class="hs-identifier hs-var">bindersOfBinds</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#rhssOfBind"><span class="hs-identifier hs-var">rhssOfBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#rhssOfAlts"><span class="hs-identifier hs-var">rhssOfAlts</span></a><span class="hs-special">,</span><span>
</span><a name="line-42"></a><span>        </span><a href="CoreSyn.html#collectBinders"><span class="hs-identifier hs-var">collectBinders</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#collectTyBinders"><span class="hs-identifier hs-var">collectTyBinders</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#collectTyAndValBinders"><span class="hs-identifier hs-var">collectTyAndValBinders</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="CoreSyn.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#stripNArgs"><span class="hs-identifier hs-var">stripNArgs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#collectArgsTicks"><span class="hs-identifier hs-var">collectArgsTicks</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span>        </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#exprToCoercion_maybe"><span class="hs-identifier hs-var">exprToCoercion_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>        </span><a href="CoreSyn.html#applyTypeToArg"><span class="hs-identifier hs-var">applyTypeToArg</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span>        </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isCoArg"><span class="hs-identifier hs-var">isCoArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isTyCoArg"><span class="hs-identifier hs-var">isTyCoArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#valArgCount"><span class="hs-identifier hs-var">valArgCount</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#valBndrCount"><span class="hs-identifier hs-var">valBndrCount</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>        </span><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier hs-var">isRuntimeArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier hs-var">isRuntimeVar</span></a><span class="hs-special">,</span><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span>        </span><span class="hs-comment">-- * Tick-related functions</span><span>
</span><a name="line-53"></a><span>        </span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>        </span><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier hs-var">mkNoCount</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkNoScope"><span class="hs-identifier hs-var">mkNoScope</span></a><span class="hs-special">,</span><span>
</span><a name="line-55"></a><span>        </span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier hs-var">tickishPlace</span></a><span class="hs-special">,</span><span>
</span><a name="line-56"></a><span>        </span><a href="CoreSyn.html#tickishContains"><span class="hs-identifier hs-var">tickishContains</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>        </span><span class="hs-comment">-- * Unfolding data types</span><span>
</span><a name="line-59"></a><span>        </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>  </span><a href="CoreSyn.html#UnfoldingGuidance"><span class="hs-identifier hs-type">UnfoldingGuidance</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span>        </span><span class="hs-comment">-- ** Constructing 'Unfolding's</span><span>
</span><a name="line-62"></a><span>        </span><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#bootUnfolding"><span class="hs-identifier hs-var">bootUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#evaldUnfolding"><span class="hs-identifier hs-var">evaldUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkOtherCon"><span class="hs-identifier hs-var">mkOtherCon</span></a><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span>        </span><a href="CoreSyn.html#unSaturatedOk"><span class="hs-identifier hs-var">unSaturatedOk</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#needSaturated"><span class="hs-identifier hs-var">needSaturated</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#boringCxtOk"><span class="hs-identifier hs-var">boringCxtOk</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#boringCxtNotOk"><span class="hs-identifier hs-var">boringCxtNotOk</span></a><span class="hs-special">,</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span>        </span><span class="hs-comment">-- ** Predicates and deconstruction on 'Unfolding'</span><span>
</span><a name="line-66"></a><span>        </span><a href="CoreSyn.html#unfoldingTemplate"><span class="hs-identifier hs-var">unfoldingTemplate</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-67"></a><span>        </span><a href="CoreSyn.html#maybeUnfoldingTemplate"><span class="hs-identifier hs-var">maybeUnfoldingTemplate</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#otherCons"><span class="hs-identifier hs-var">otherCons</span></a><span class="hs-special">,</span><span>
</span><a name="line-68"></a><span>        </span><a href="CoreSyn.html#isValueUnfolding"><span class="hs-identifier hs-var">isValueUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isEvaldUnfolding"><span class="hs-identifier hs-var">isEvaldUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isCheapUnfolding"><span class="hs-identifier hs-var">isCheapUnfolding</span></a><span class="hs-special">,</span><span>
</span><a name="line-69"></a><span>        </span><a href="CoreSyn.html#isExpandableUnfolding"><span class="hs-identifier hs-var">isExpandableUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isConLikeUnfolding"><span class="hs-identifier hs-var">isConLikeUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isCompulsoryUnfolding"><span class="hs-identifier hs-var">isCompulsoryUnfolding</span></a><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>        </span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isFragileUnfolding"><span class="hs-identifier hs-var">isFragileUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#hasSomeUnfolding"><span class="hs-identifier hs-var">hasSomeUnfolding</span></a><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>        </span><a href="CoreSyn.html#isBootUnfolding"><span class="hs-identifier hs-var">isBootUnfolding</span></a><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>        </span><a href="CoreSyn.html#canUnfold"><span class="hs-identifier hs-var">canUnfold</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#neverUnfoldGuidance"><span class="hs-identifier hs-var">neverUnfoldGuidance</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span>        </span><span class="hs-comment">-- * Annotated expression data types</span><span>
</span><a name="line-75"></a><span>        </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnExpr%27"><span class="hs-identifier hs-type">AnnExpr'</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnBind"><span class="hs-identifier hs-type">AnnBind</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnAlt"><span class="hs-identifier hs-type">AnnAlt</span></a><span class="hs-special">,</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span>        </span><span class="hs-comment">-- ** Operations on annotated expressions</span><span>
</span><a name="line-78"></a><span>        </span><a href="CoreSyn.html#collectAnnArgs"><span class="hs-identifier hs-var">collectAnnArgs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#collectAnnArgsTicks"><span class="hs-identifier hs-var">collectAnnArgsTicks</span></a><span class="hs-special">,</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span>        </span><span class="hs-comment">-- ** Operations on annotations</span><span>
</span><a name="line-81"></a><span>        </span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#deAnnotate%27"><span class="hs-identifier hs-var">deAnnotate'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#deAnnAlt"><span class="hs-identifier hs-var">deAnnAlt</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#deAnnBind"><span class="hs-identifier hs-var">deAnnBind</span></a><span class="hs-special">,</span><span>
</span><a name="line-82"></a><span>        </span><a href="CoreSyn.html#collectAnnBndrs"><span class="hs-identifier hs-var">collectAnnBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#collectNAnnBndrs"><span class="hs-identifier hs-var">collectNAnnBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>        </span><span class="hs-comment">-- * Orphanhood</span><span>
</span><a name="line-85"></a><span>        </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isOrphan"><span class="hs-identifier hs-var">isOrphan</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#notOrphan"><span class="hs-identifier hs-var">notOrphan</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#chooseOrphanAnchor"><span class="hs-identifier hs-var">chooseOrphanAnchor</span></a><span class="hs-special">,</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span>        </span><span class="hs-comment">-- * Core rule data types</span><span>
</span><a name="line-88"></a><span>        </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span class="hs-special">,</span><span>
</span><a name="line-89"></a><span>        </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#RuleFun"><span class="hs-identifier hs-type">RuleFun</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-90"></a><span>        </span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkRuleEnv"><span class="hs-identifier hs-var">mkRuleEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#emptyRuleEnv"><span class="hs-identifier hs-var">emptyRuleEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>        </span><span class="hs-comment">-- ** Operations on 'CoreRule's</span><span>
</span><a name="line-93"></a><span>        </span><a href="CoreSyn.html#ruleArity"><span class="hs-identifier hs-var">ruleArity</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ruleName"><span class="hs-identifier hs-var">ruleName</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ruleIdName"><span class="hs-identifier hs-var">ruleIdName</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ruleActivation"><span class="hs-identifier hs-var">ruleActivation</span></a><span class="hs-special">,</span><span>
</span><a name="line-94"></a><span>        </span><a href="CoreSyn.html#setRuleIdName"><span class="hs-identifier hs-var">setRuleIdName</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#ruleModule"><span class="hs-identifier hs-var">ruleModule</span></a><span class="hs-special">,</span><span>
</span><a name="line-95"></a><span>        </span><a href="CoreSyn.html#isBuiltinRule"><span class="hs-identifier hs-var">isBuiltinRule</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isLocalRule"><span class="hs-identifier hs-var">isLocalRule</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isAutoRule"><span class="hs-identifier hs-var">isAutoRule</span></a><span class="hs-special">,</span><span>
</span><a name="line-96"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><a href="CostCentre.html"><span class="hs-identifier">CostCentre</span></a><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span class="hs-special">(</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-105"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-106"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-107"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>
</span><a name="line-108"></a><span class="hs-keyword">import</span><span> </span><a href="NameSet.html"><span class="hs-identifier">NameSet</span></a><span>
</span><a name="line-109"></a><span class="hs-keyword">import</span><span> </span><a href="NameEnv.html"><span class="hs-identifier">NameEnv</span></a><span class="hs-special">(</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span class="hs-special">,</span><span> </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span class="hs-keyword">import</span><span> </span><a href="Literal.html"><span class="hs-identifier">Literal</span></a><span>
</span><a name="line-111"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-112"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-113"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-114"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-115"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-116"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-117"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSet.html"><span class="hs-identifier">UniqSet</span></a><span>
</span><a name="line-118"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="SrcLoc.html#RealSrcSpan"><span class="hs-identifier hs-type">RealSrcSpan</span></a><span class="hs-special">,</span><span> </span><a href="SrcLoc.html#containsSpan"><span class="hs-identifier hs-var">containsSpan</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-119"></a><span class="hs-keyword">import</span><span> </span><a href="Binary.html"><span class="hs-identifier">Binary</span></a><span>
</span><a name="line-120"></a><span>
</span><a name="line-121"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Data</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">TyCon</span><span class="hs-special">)</span><span>
</span><a name="line-122"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Int</span><span>
</span><a name="line-123"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Word</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-keyword">infixl</span><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span class="hs-special">,</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkTyApps"><span class="hs-identifier hs-var">mkTyApps</span></a><span class="hs-special">`</span><span class="hs-special">,</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkVarApps"><span class="hs-identifier hs-var">mkVarApps</span></a><span class="hs-special">`</span><span class="hs-special">,</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span class="hs-special">`</span><span class="hs-special">,</span><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkCoApps"><span class="hs-identifier hs-var">mkCoApps</span></a><span class="hs-special">`</span><span>
</span><a name="line-126"></a><span class="hs-comment">-- Left associative, so that we can say (f `mkTyApps` xs `mkVarApps` ys)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{The main data types}
*                                                                      *
************************************************************************

These data types are the heart of the compiler
-}</span><span>
</span><a name="line-137"></a><span>
</span><a name="line-138"></a><span class="hs-comment">-- | This is the data type that represents GHCs core intermediate language. Currently</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- GHC uses System FC &lt;https://www.microsoft.com/en-us/research/publication/system-f-with-type-equality-coercions/&gt; for this purpose,</span><span>
</span><a name="line-140"></a><span class="hs-comment">-- which is closely related to the simpler and better known System F &lt;http://en.wikipedia.org/wiki/System_F&gt;.</span><span>
</span><a name="line-141"></a><span class="hs-comment">--</span><span>
</span><a name="line-142"></a><span class="hs-comment">-- We get from Haskell source to this Core language in a number of stages:</span><span>
</span><a name="line-143"></a><span class="hs-comment">--</span><span>
</span><a name="line-144"></a><span class="hs-comment">-- 1. The source code is parsed into an abstract syntax tree, which is represented</span><span>
</span><a name="line-145"></a><span class="hs-comment">--    by the data type 'HsExpr.HsExpr' with the names being 'RdrName.RdrNames'</span><span>
</span><a name="line-146"></a><span class="hs-comment">--</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- 2. This syntax tree is /renamed/, which attaches a 'Unique.Unique' to every 'RdrName.RdrName'</span><span>
</span><a name="line-148"></a><span class="hs-comment">--    (yielding a 'Name.Name') to disambiguate identifiers which are lexically identical.</span><span>
</span><a name="line-149"></a><span class="hs-comment">--    For example, this program:</span><span>
</span><a name="line-150"></a><span class="hs-comment">--</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-152"></a><span class="hs-comment">--      f x = let f x = x + 1</span><span>
</span><a name="line-153"></a><span class="hs-comment">--            in f (x - 2)</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-155"></a><span class="hs-comment">--</span><span>
</span><a name="line-156"></a><span class="hs-comment">--    Would be renamed by having 'Unique's attached so it looked something like this:</span><span>
</span><a name="line-157"></a><span class="hs-comment">--</span><span>
</span><a name="line-158"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-159"></a><span class="hs-comment">--      f_1 x_2 = let f_3 x_4 = x_4 + 1</span><span>
</span><a name="line-160"></a><span class="hs-comment">--                in f_3 (x_2 - 2)</span><span>
</span><a name="line-161"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-162"></a><span class="hs-comment">--    But see Note [Shadowing] below.</span><span>
</span><a name="line-163"></a><span class="hs-comment">--</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- 3. The resulting syntax tree undergoes type checking (which also deals with instantiating</span><span>
</span><a name="line-165"></a><span class="hs-comment">--    type class arguments) to yield a 'HsExpr.HsExpr' type that has 'Id.Id' as it's names.</span><span>
</span><a name="line-166"></a><span class="hs-comment">--</span><span>
</span><a name="line-167"></a><span class="hs-comment">-- 4. Finally the syntax tree is /desugared/ from the expressive 'HsExpr.HsExpr' type into</span><span>
</span><a name="line-168"></a><span class="hs-comment">--    this 'Expr' type, which has far fewer constructors and hence is easier to perform</span><span>
</span><a name="line-169"></a><span class="hs-comment">--    optimization, analysis and code generation on.</span><span>
</span><a name="line-170"></a><span class="hs-comment">--</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- The type parameter @b@ is for the type of binders in the expression tree.</span><span>
</span><a name="line-172"></a><span class="hs-comment">--</span><span>
</span><a name="line-173"></a><span class="hs-comment">-- The language consists of the following elements:</span><span>
</span><a name="line-174"></a><span class="hs-comment">--</span><span>
</span><a name="line-175"></a><span class="hs-comment">-- *  Variables</span><span>
</span><a name="line-176"></a><span class="hs-comment">--    See Note [Variable occurrences in Core]</span><span>
</span><a name="line-177"></a><span class="hs-comment">--</span><span>
</span><a name="line-178"></a><span class="hs-comment">-- *  Primitive literals</span><span>
</span><a name="line-179"></a><span class="hs-comment">--</span><span>
</span><a name="line-180"></a><span class="hs-comment">-- *  Applications: note that the argument may be a 'Type'.</span><span>
</span><a name="line-181"></a><span class="hs-comment">--    See Note [CoreSyn let/app invariant]</span><span>
</span><a name="line-182"></a><span class="hs-comment">--    See Note [Levity polymorphism invariants]</span><span>
</span><a name="line-183"></a><span class="hs-comment">--</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- *  Lambda abstraction</span><span>
</span><a name="line-185"></a><span class="hs-comment">--    See Note [Levity polymorphism invariants]</span><span>
</span><a name="line-186"></a><span class="hs-comment">--</span><span>
</span><a name="line-187"></a><span class="hs-comment">-- *  Recursive and non recursive @let@s. Operationally</span><span>
</span><a name="line-188"></a><span class="hs-comment">--    this corresponds to allocating a thunk for the things</span><span>
</span><a name="line-189"></a><span class="hs-comment">--    bound and then executing the sub-expression.</span><span>
</span><a name="line-190"></a><span class="hs-comment">--</span><span>
</span><a name="line-191"></a><span class="hs-comment">--    See Note [CoreSyn letrec invariant]</span><span>
</span><a name="line-192"></a><span class="hs-comment">--    See Note [CoreSyn let/app invariant]</span><span>
</span><a name="line-193"></a><span class="hs-comment">--    See Note [Levity polymorphism invariants]</span><span>
</span><a name="line-194"></a><span class="hs-comment">--    See Note [CoreSyn type and coercion invariant]</span><span>
</span><a name="line-195"></a><span class="hs-comment">--</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- *  Case expression. Operationally this corresponds to evaluating</span><span>
</span><a name="line-197"></a><span class="hs-comment">--    the scrutinee (expression examined) to weak head normal form</span><span>
</span><a name="line-198"></a><span class="hs-comment">--    and then examining at most one level of resulting constructor (i.e. you</span><span>
</span><a name="line-199"></a><span class="hs-comment">--    cannot do nested pattern matching directly with this).</span><span>
</span><a name="line-200"></a><span class="hs-comment">--</span><span>
</span><a name="line-201"></a><span class="hs-comment">--    The binder gets bound to the value of the scrutinee,</span><span>
</span><a name="line-202"></a><span class="hs-comment">--    and the 'Type' must be that of all the case alternatives</span><span>
</span><a name="line-203"></a><span class="hs-comment">--</span><span>
</span><a name="line-204"></a><span class="hs-comment">--    #case_invariants#</span><span>
</span><a name="line-205"></a><span class="hs-comment">--    This is one of the more complicated elements of the Core language,</span><span>
</span><a name="line-206"></a><span class="hs-comment">--    and comes with a number of restrictions:</span><span>
</span><a name="line-207"></a><span class="hs-comment">--</span><span>
</span><a name="line-208"></a><span class="hs-comment">--    1. The list of alternatives may be empty;</span><span>
</span><a name="line-209"></a><span class="hs-comment">--       See Note [Empty case alternatives]</span><span>
</span><a name="line-210"></a><span class="hs-comment">--</span><span>
</span><a name="line-211"></a><span class="hs-comment">--    2. The 'DEFAULT' case alternative must be first in the list,</span><span>
</span><a name="line-212"></a><span class="hs-comment">--       if it occurs at all.</span><span>
</span><a name="line-213"></a><span class="hs-comment">--</span><span>
</span><a name="line-214"></a><span class="hs-comment">--    3. The remaining cases are in order of increasing</span><span>
</span><a name="line-215"></a><span class="hs-comment">--         tag  (for 'DataAlts') or</span><span>
</span><a name="line-216"></a><span class="hs-comment">--         lit  (for 'LitAlts').</span><span>
</span><a name="line-217"></a><span class="hs-comment">--       This makes finding the relevant constructor easy,</span><span>
</span><a name="line-218"></a><span class="hs-comment">--       and makes comparison easier too.</span><span>
</span><a name="line-219"></a><span class="hs-comment">--</span><span>
</span><a name="line-220"></a><span class="hs-comment">--    4. The list of alternatives must be exhaustive. An /exhaustive/ case</span><span>
</span><a name="line-221"></a><span class="hs-comment">--       does not necessarily mention all constructors:</span><span>
</span><a name="line-222"></a><span class="hs-comment">--</span><span>
</span><a name="line-223"></a><span class="hs-comment">--       @</span><span>
</span><a name="line-224"></a><span class="hs-comment">--            data Foo = Red | Green | Blue</span><span>
</span><a name="line-225"></a><span class="hs-comment">--       ... case x of</span><span>
</span><a name="line-226"></a><span class="hs-comment">--            Red   -&gt; True</span><span>
</span><a name="line-227"></a><span class="hs-comment">--            other -&gt; f (case x of</span><span>
</span><a name="line-228"></a><span class="hs-comment">--                            Green -&gt; ...</span><span>
</span><a name="line-229"></a><span class="hs-comment">--                            Blue  -&gt; ... ) ...</span><span>
</span><a name="line-230"></a><span class="hs-comment">--       @</span><span>
</span><a name="line-231"></a><span class="hs-comment">--</span><span>
</span><a name="line-232"></a><span class="hs-comment">--       The inner case does not need a @Red@ alternative, because @x@</span><span>
</span><a name="line-233"></a><span class="hs-comment">--       can't be @Red@ at that program point.</span><span>
</span><a name="line-234"></a><span class="hs-comment">--</span><span>
</span><a name="line-235"></a><span class="hs-comment">--    5. Floating-point values must not be scrutinised against literals.</span><span>
</span><a name="line-236"></a><span class="hs-comment">--       See Trac #9238 and Note [Rules for floating-point comparisons]</span><span>
</span><a name="line-237"></a><span class="hs-comment">--       in PrelRules for rationale.</span><span>
</span><a name="line-238"></a><span class="hs-comment">--</span><span>
</span><a name="line-239"></a><span class="hs-comment">-- *  Cast an expression to a particular type.</span><span>
</span><a name="line-240"></a><span class="hs-comment">--    This is used to implement @newtype@s (a @newtype@ constructor or</span><span>
</span><a name="line-241"></a><span class="hs-comment">--    destructor just becomes a 'Cast' in Core) and GADTs.</span><span>
</span><a name="line-242"></a><span class="hs-comment">--</span><span>
</span><a name="line-243"></a><span class="hs-comment">-- *  Notes. These allow general information to be added to expressions</span><span>
</span><a name="line-244"></a><span class="hs-comment">--    in the syntax tree</span><span>
</span><a name="line-245"></a><span class="hs-comment">--</span><span>
</span><a name="line-246"></a><span class="hs-comment">-- *  A type: this should only show up at the top level of an Arg</span><span>
</span><a name="line-247"></a><span class="hs-comment">--</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- *  A coercion</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-comment">-- If you edit this type, you may need to update the GHC formalism</span><span>
</span><a name="line-251"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-252"></a><span class="hs-keyword">data</span><span> </span><a name="Expr"><a href="CoreSyn.html#Expr"><span class="hs-identifier">Expr</span></a></a><span> </span><a name="local-6989586621682264216"><a href="#local-6989586621682264216"><span class="hs-identifier">b</span></a></a><span>
</span><a name="line-253"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Var"><a href="CoreSyn.html#Var"><span class="hs-identifier">Var</span></a></a><span>   </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-254"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Lit"><a href="CoreSyn.html#Lit"><span class="hs-identifier">Lit</span></a></a><span>   </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span>
</span><a name="line-255"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="App"><a href="CoreSyn.html#App"><span class="hs-identifier">App</span></a></a><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Lam"><a href="CoreSyn.html#Lam"><span class="hs-identifier">Lam</span></a></a><span>   </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-257"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Let"><a href="CoreSyn.html#Let"><span class="hs-identifier">Let</span></a></a><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Case"><a href="CoreSyn.html#Case"><span class="hs-identifier">Case</span></a></a><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>       </span><span class="hs-comment">-- See #case_invariants#</span><span>
</span><a name="line-259"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Cast"><a href="CoreSyn.html#Cast"><span class="hs-identifier">Cast</span></a></a><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-260"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Tick"><a href="CoreSyn.html#Tick"><span class="hs-identifier">Tick</span></a></a><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264216"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Type"><a href="CoreSyn.html#Type"><span class="hs-identifier">Type</span></a></a><span>  </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Coercion"><a href="CoreSyn.html#Coercion"><span class="hs-identifier">Coercion</span></a></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Data</span><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span class="hs-comment">-- | Type synonym for expressions that occur in function argument positions.</span><span>
</span><a name="line-266"></a><span class="hs-comment">-- Only 'Arg' should contain a 'Type' at top level, general 'Expr' should not</span><span>
</span><a name="line-267"></a><span class="hs-keyword">type</span><span> </span><a name="Arg"><a href="CoreSyn.html#Arg"><span class="hs-identifier">Arg</span></a></a><span> </span><a name="local-6989586621682264215"><a href="#local-6989586621682264215"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264215"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">-- | A case split alternative. Consists of the constructor leading to the alternative,</span><span>
</span><a name="line-270"></a><span class="hs-comment">-- the variables bound from the constructor, and the expression to be executed given that binding.</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- The default alternative is @(DEFAULT, [], rhs)@</span><span>
</span><a name="line-272"></a><span>
</span><a name="line-273"></a><span class="hs-comment">-- If you edit this type, you may need to update the GHC formalism</span><span>
</span><a name="line-274"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-275"></a><span class="hs-keyword">type</span><span> </span><a name="Alt"><a href="CoreSyn.html#Alt"><span class="hs-identifier">Alt</span></a></a><span> </span><a name="local-6989586621682264214"><a href="#local-6989586621682264214"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264214"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264214"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">-- | A case alternative constructor (i.e. pattern match)</span><span>
</span><a name="line-278"></a><span>
</span><a name="line-279"></a><span class="hs-comment">-- If you edit this type, you may need to update the GHC formalism</span><span>
</span><a name="line-280"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-281"></a><span class="hs-keyword">data</span><span> </span><a name="AltCon"><a href="CoreSyn.html#AltCon"><span class="hs-identifier">AltCon</span></a></a><span>
</span><a name="line-282"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="DataAlt"><a href="CoreSyn.html#DataAlt"><span class="hs-identifier">DataAlt</span></a></a><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span>   </span><span class="hs-comment">--  ^ A plain data constructor: @case e of { Foo x -&gt; ... }@.</span><span>
</span><a name="line-283"></a><span>                      </span><span class="hs-comment">-- Invariant: the 'DataCon' is always from a @data@ type, and never from a @newtype@</span><span>
</span><a name="line-284"></a><span>
</span><a name="line-285"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LitAlt"><a href="CoreSyn.html#LitAlt"><span class="hs-identifier">LitAlt</span></a></a><span>  </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span>   </span><span class="hs-comment">-- ^ A literal: @case e of { 1 -&gt; ... }@</span><span>
</span><a name="line-286"></a><span>                      </span><span class="hs-comment">-- Invariant: always an *unlifted* literal</span><span>
</span><a name="line-287"></a><span>                      </span><span class="hs-comment">-- See Note [Literal alternatives]</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DEFAULT"><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier">DEFAULT</span></a></a><span>           </span><span class="hs-comment">-- ^ Trivial alternative: @case e of { _ -&gt; ... }@</span><span>
</span><a name="line-290"></a><span>   </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span class="hs-special">)</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-comment">-- This instance is a bit shady. It can only be used to compare AltCons for</span><span>
</span><a name="line-293"></a><span class="hs-comment">-- a single type constructor. Fortunately, it seems quite unlikely that we'll</span><span>
</span><a name="line-294"></a><span class="hs-comment">-- ever need to compare AltCons for different type constructors.</span><span>
</span><a name="line-295"></a><span class="hs-comment">-- The instance adheres to the order described in [CoreSyn case invariants]</span><span>
</span><a name="line-296"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-297"></a><span>  </span><a name="local-8214565720323790496"><span class="hs-identifier">compare</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621682264228"><a href="#local-6989586621682264228"><span class="hs-identifier">con1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621682264229"><a href="#local-6989586621682264229"><span class="hs-identifier">con2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-298"></a><span>    </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">dataConTyCon</span><span> </span><span class="hs-identifier">con1</span><span> </span><a href="DataCon.html#dataConTyCon"><span class="hs-operator hs-var">==</span></a><span> </span><span class="hs-identifier">dataConTyCon</span><span> </span><span class="hs-identifier">con2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-identifier hs-var">compare</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConTag"><span class="hs-identifier hs-var">dataConTag</span></a><span> </span><a href="#local-6989586621682264228"><span class="hs-identifier hs-var">con1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConTag"><span class="hs-identifier hs-var">dataConTag</span></a><span> </span><a href="#local-6989586621682264229"><span class="hs-identifier hs-var">con2</span></a><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-302"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a name="local-6989586621682264230"><a href="#local-6989586621682264230"><span class="hs-identifier">l1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a name="local-6989586621682264231"><a href="#local-6989586621682264231"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621682264230"><span class="hs-identifier hs-var">l1</span></a><span> </span><a href="#local-6989586621682264231"><span class="hs-identifier hs-var">l2</span></a><span>
</span><a name="line-303"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-304"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-identifier">compare</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-comment">-- | Binding, used for top level bindings in a module and local bindings in a @let@.</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-comment">-- If you edit this type, you may need to update the GHC formalism</span><span>
</span><a name="line-310"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-311"></a><span class="hs-keyword">data</span><span> </span><a name="Bind"><a href="CoreSyn.html#Bind"><span class="hs-identifier">Bind</span></a></a><span> </span><a name="local-6989586621682264213"><a href="#local-6989586621682264213"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="NonRec"><a href="CoreSyn.html#NonRec"><span class="hs-identifier">NonRec</span></a></a><span> </span><a href="#local-6989586621682264213"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264213"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-312"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a name="Rec"><a href="CoreSyn.html#Rec"><span class="hs-identifier">Rec</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682264213"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264213"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-313"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Data</span><span>
</span><a name="line-314"></a><span>
</span><a name="line-315"></a><span class="hs-comment">{-
Note [Shadowing]
~~~~~~~~~~~~~~~~
While various passes attempt to rename on-the-fly in a manner that
avoids &quot;shadowing&quot; (thereby simplifying downstream optimizations),
neither the simplifier nor any other pass GUARANTEES that shadowing is
avoided. Thus, all passes SHOULD work fine even in the presence of
arbitrary shadowing in their inputs.

In particular, scrutinee variables `x` in expressions of the form
`Case e x t` are often renamed to variables with a prefix
&quot;wild_&quot;. These &quot;wild&quot; variables may appear in the body of the
case-expression, and further, may be shadowed within the body.

So the Unique in a Var is not really unique at all.  Still, it's very
useful to give a constant-time equality/ordering for Vars, and to give
a key that can be used to make sets of Vars (VarSet), or mappings from
Vars to other things (VarEnv).   Moreover, if you do want to eliminate
shadowing, you can give a new Unique to an Id without changing its
printable name, which makes debugging easier.

Note [Literal alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
Literal alternatives (LitAlt lit) are always for *un-lifted* literals.
We have one literal, a literal Integer, that is lifted, and we don't
allow in a LitAlt, because LitAlt cases don't do any evaluation. Also
(see Trac #5603) if you say
    case 3 of
      S# x -&gt; ...
      J# _ _ -&gt; ...
(where S#, J# are the constructors for Integer) we don't want the
simplifier calling findAlt with argument (LitAlt 3).  No no.  Integer
literals are an opaque encoding of an algebraic data type, not of
an unlifted literal, like all the others.

Also, we do not permit case analysis with literal patterns on floating-point
types. See Trac #9238 and Note [Rules for floating-point comparisons] in
PrelRules for the rationale for this restriction.

-------------------------- CoreSyn INVARIANTS ---------------------------

Note [Variable occurrences in Core]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Variable /occurrences/ are never CoVars, though /bindings/ can be.
All CoVars appear in Coercions.

For example
  \(c :: Age~#Int) (d::Int). d |&gt; (sym c)
Here 'c' is a CoVar, which is lambda-bound, but it /occurs/ in
a Coercion, (sym c).

Note [CoreSyn letrec invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The right hand sides of all top-level and recursive @let@s
/must/ be of lifted type (see &quot;Type#type_classification&quot; for
the meaning of /lifted/ vs. /unlifted/).

There is one exception to this rule, top-level @let@s are
allowed to bind primitive string literals: see
Note [CoreSyn top-level string literals].

Note [CoreSyn top-level string literals]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
As an exception to the usual rule that top-level binders must be lifted,
we allow binding primitive string literals (of type Addr#) of type Addr# at the
top level. This allows us to share string literals earlier in the pipeline and
crucially allows other optimizations in the Core2Core pipeline to fire.
Consider,

  f n = let a::Addr# = &quot;foo&quot;#
        in \x -&gt; blah

In order to be able to inline `f`, we would like to float `a` to the top.
Another option would be to inline `a`, but that would lead to duplicating string
literals, which we want to avoid. See Trac #8472.

The solution is simply to allow top-level unlifted binders. We can't allow
arbitrary unlifted expression at the top-level though, unlifted binders cannot
be thunks, so we just allow string literals.

We allow the top-level primitive string literals to be wrapped in Ticks
in the same way they can be wrapped when nested in an expression.
CoreToSTG currently discards Ticks around top-level primitive string literals.
See Trac #14779.

Also see Note [Compilation plan for top-level string literals].

Note [Compilation plan for top-level string literals]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Here is a summary on how top-level string literals are handled by various
parts of the compilation pipeline.

* In the source language, there is no way to bind a primitive string literal
  at the top level.

* In Core, we have a special rule that permits top-level Addr# bindings. See
  Note [CoreSyn top-level string literals]. Core-to-core passes may introduce
  new top-level string literals.

* In STG, top-level string literals are explicitly represented in the syntax
  tree.

* A top-level string literal may end up exported from a module. In this case,
  in the object file, the content of the exported literal is given a label with
  the _bytes suffix.

Note [CoreSyn let/app invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The let/app invariant
     the right hand side of a non-recursive 'Let', and
     the argument of an 'App',
    /may/ be of unlifted type, but only if
    the expression is ok-for-speculation
    or the 'Let' is for a join point.

This means that the let can be floated around
without difficulty. For example, this is OK:

   y::Int# = x +# 1#

But this is not, as it may affect termination if the
expression is floated out:

   y::Int# = fac 4#

In this situation you should use @case@ rather than a @let@. The function
'CoreUtils.needsCaseBinding' can help you determine which to generate, or
alternatively use 'MkCore.mkCoreLet' rather than this constructor directly,
which will generate a @case@ if necessary

The let/app invariant is initially enforced by mkCoreLet and mkCoreApp in
coreSyn/MkCore.

Note [CoreSyn type and coercion invariant]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We allow a /non-recursive/, /non-top-level/ let to bind type and
coercion variables.  These can be very convenient for postponing type
substitutions until the next run of the simplifier.

* A type variable binding must have a RHS of (Type ty)

* A coercion variable binding must have a RHS of (Coercion co)

  It is possible to have terms that return a coercion, but we use
  case-binding for those; e.g.
     case (eq_sel d) of (co :: a ~# b) -&gt; blah
  where eq_sel :: (a~b) -&gt; (a~#b)

  Or even even
      case (df @Int) of (co :: a ~# b) -&gt; blah
  Which is very exotic, and I think never encountered; but see
  Note [Equality superclasses in quantified constraints]
  in TcCanonical

Note [CoreSyn case invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See #case_invariants#

Note [Levity polymorphism invariants]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The levity-polymorphism invariants are these (as per &quot;Levity Polymorphism&quot;,
PLDI '17):

* The type of a term-binder must not be levity-polymorphic,
  unless it is a let(rec)-bound join point
     (see Note [Invariants on join points])

* The type of the argument of an App must not be levity-polymorphic.

A type (t::TYPE r) is &quot;levity polymorphic&quot; if 'r' has any free variables.

For example
  \(r::RuntimeRep). \(a::TYPE r). \(x::a). e
is illegal because x's type has kind (TYPE r), which has 'r' free.

See Note [Levity polymorphism checking] in DsMonad to see where these
invariants are established for user-written code.

Note [CoreSyn let goal]
~~~~~~~~~~~~~~~~~~~~~~~
* The simplifier tries to ensure that if the RHS of a let is a constructor
  application, its arguments are trivial, so that the constructor can be
  inlined vigorously.

Note [Type let]
~~~~~~~~~~~~~~~
See #type_let#

Note [Empty case alternatives]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The alternatives of a case expression should be exhaustive.  But
this exhaustive list can be empty!

* A case expression can have empty alternatives if (and only if) the
  scrutinee is bound to raise an exception or diverge. When do we know
  this?  See Note [Bottoming expressions] in CoreUtils.

* The possibility of empty alternatives is one reason we need a type on
  the case expression: if the alternatives are empty we can't get the
  type from the alternatives!

* In the case of empty types (see Note [Bottoming expressions]), say
    data T
  we do NOT want to replace
    case (x::T) of Bool {}   --&gt;   error Bool &quot;Inaccessible case&quot;
  because x might raise an exception, and *that*'s what we want to see!
  (Trac #6067 is an example.) To preserve semantics we'd have to say
     x `seq` error Bool &quot;Inaccessible case&quot;
  but the 'seq' is just a case, so we are back to square 1.  Or I suppose
  we could say
     x |&gt; UnsafeCoerce T Bool
  but that loses all trace of the fact that this originated with an empty
  set of alternatives.

* We can use the empty-alternative construct to coerce error values from
  one type to another.  For example

    f :: Int -&gt; Int
    f n = error &quot;urk&quot;

    g :: Int -&gt; (# Char, Bool #)
    g x = case f x of { 0 -&gt; ..., n -&gt; ... }

  Then if we inline f in g's RHS we get
    case (error Int &quot;urk&quot;) of (# Char, Bool #) { ... }
  and we can discard the alternatives since the scrutinee is bottom to give
    case (error Int &quot;urk&quot;) of (# Char, Bool #) {}

  This is nicer than using an unsafe coerce between Int ~ (# Char,Bool #),
  if for no other reason that we don't need to instantiate the (~) at an
  unboxed type.

* We treat a case expression with empty alternatives as trivial iff
  its scrutinee is (see CoreUtils.exprIsTrivial).  This is actually
  important; see Note [Empty case is trivial] in CoreUtils

* An empty case is replaced by its scrutinee during the CoreToStg
  conversion; remember STG is un-typed, so there is no need for
  the empty case to do the type conversion.

Note [Join points]
~~~~~~~~~~~~~~~~~~
In Core, a *join point* is a specially tagged function whose only occurrences
are saturated tail calls. A tail call can appear in these places:

  1. In the branches (not the scrutinee) of a case
  2. Underneath a let (value or join point)
  3. Inside another join point

We write a join-point declaration as
  join j @a @b x y = e1 in e2,
like a let binding but with &quot;join&quot; instead (or &quot;join rec&quot; for &quot;let rec&quot;). Note
that we put the parameters before the = rather than using lambdas; this is
because it's relevant how many parameters the join point takes *as a join
point.* This number is called the *join arity,* distinct from arity because it
counts types as well as values. Note that a join point may return a lambda! So
  join j x = x + 1
is different from
  join j = \x -&gt; x + 1
The former has join arity 1, while the latter has join arity 0.

The identifier for a join point is called a join id or a *label.* An invocation
is called a *jump.* We write a jump using the jump keyword:

  jump j 3

The words *label* and *jump* are evocative of assembly code (or Cmm) for a
reason: join points are indeed compiled as labeled blocks, and jumps become
actual jumps (plus argument passing and stack adjustment). There is no closure
allocated and only a fraction of the function-call overhead. Hence we would
like as many functions as possible to become join points (see OccurAnal) and
the type rules for join points ensure we preserve the properties that make them
efficient.

In the actual AST, a join point is indicated by the IdDetails of the binder: a
local value binding gets 'VanillaId' but a join point gets a 'JoinId' with its
join arity.

For more details, see the paper:

  Luke Maurer, Paul Downen, Zena Ariola, and Simon Peyton Jones. &quot;Compiling
  without continuations.&quot; Submitted to PLDI'17.

  https://www.microsoft.com/en-us/research/publication/compiling-without-continuations/

Note [Invariants on join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Join points must follow these invariants:

  1. All occurrences must be tail calls. Each of these tail calls must pass the
     same number of arguments, counting both types and values; we call this the
     &quot;join arity&quot; (to distinguish from regular arity, which only counts values).

  2. For join arity n, the right-hand side must begin with at least n lambdas.
     No ticks, no casts, just lambdas!  C.f. CoreUtils.joinRhsArity.

  2a. Moreover, this same constraint applies to any unfolding of the binder.
     Reason: if we want to push a continuation into the RHS we must push it
     into the unfolding as well.

  3. If the binding is recursive, then all other bindings in the recursive group
     must also be join points.

  4. The binding's type must not be polymorphic in its return type (as defined
     in Note [The polymorphism rule of join points]).

However, join points have simpler invariants in other ways

  5. A join point can have an unboxed type without the RHS being
     ok-for-speculation (i.e. drop the let/app invariant)
     e.g.  let j :: Int# = factorial x in ...

  6. A join point can have a levity-polymorphic RHS
     e.g.  let j :: r :: TYPE l = fail void# in ...
     This happened in an intermediate program Trac #13394

Examples:

  join j1  x = 1 + x in jump j (jump j x)  -- Fails 1: non-tail call
  join j1' x = 1 + x in if even a
                          then jump j1 a
                          else jump j1 a b -- Fails 1: inconsistent calls
  join j2  x = flip (+) x in j2 1 2        -- Fails 2: not enough lambdas
  join j2' x = \y -&gt; x + y in j3 1         -- Passes: extra lams ok
  join j @a (x :: a) = x                   -- Fails 4: polymorphic in ret type

Invariant 1 applies to left-hand sides of rewrite rules, so a rule for a join
point must have an exact call as its LHS.

Strictly speaking, invariant 3 is redundant, since a call from inside a lazy
binding isn't a tail call. Since a let-bound value can't invoke a free join
point, then, they can't be mutually recursive. (A Core binding group *can*
include spurious extra bindings if the occurrence analyser hasn't run, so
invariant 3 does still need to be checked.) For the rigorous definition of
&quot;tail call&quot;, see Section 3 of the paper (Note [Join points]).

Invariant 4 is subtle; see Note [The polymorphism rule of join points].

Core Lint will check these invariants, anticipating that any binder whose
OccInfo is marked AlwaysTailCalled will become a join point as soon as the
simplifier (or simpleOptPgm) runs.

Note [The type of a join point]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
A join point has the same type it would have as a function. That is, if it takes
an Int and a Bool and its body produces a String, its type is `Int -&gt; Bool -&gt;
String`. Natural as this may seem, it can be awkward. A join point shouldn't be
thought to &quot;return&quot; in the same sense a function does---a jump is one-way. This
is crucial for understanding how case-of-case interacts with join points:

  case (join
          j :: Int -&gt; Bool -&gt; String
          j x y = ...
        in
          jump j z w) of
    &quot;&quot; -&gt; True
    _  -&gt; False

The simplifier will pull the case into the join point (see Note [Case-of-case
and join points] in Simplify):

  join
    j :: Int -&gt; Bool -&gt; Bool -- changed!
    j x y = case ... of &quot;&quot; -&gt; True
                        _  -&gt; False
  in
    jump j z w

The body of the join point now returns a Bool, so the label `j` has to have its
type updated accordingly. Inconvenient though this may be, it has the advantage
that 'CoreUtils.exprType' can still return a type for any expression, including
a jump.

This differs from the paper (see Note [Invariants on join points]). In the
paper, we instead give j the type `Int -&gt; Bool -&gt; forall a. a`. Then each jump
carries the &quot;return type&quot; as a parameter, exactly the way other non-returning
functions like `error` work:

  case (join
          j :: Int -&gt; Bool -&gt; forall a. a
          j x y = ...
        in
          jump j z w @String) of
    &quot;&quot; -&gt; True
    _  -&gt; False

Now we can move the case inward and we only have to change the jump:

  join
    j :: Int -&gt; Bool -&gt; forall a. a
    j x y = case ... of &quot;&quot; -&gt; True
                        _  -&gt; False
  in
    jump j z w @Bool

(Core Lint would still check that the body of the join point has the right type;
that type would simply not be reflected in the join id.)

Note [The polymorphism rule of join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Invariant 4 of Note [Invariants on join points] forbids a join point to be
polymorphic in its return type. That is, if its type is

  forall a1 ... ak. t1 -&gt; ... -&gt; tn -&gt; r

where its join arity is k+n, none of the type parameters ai may occur free in r.

In some way, this falls out of the fact that given

  join
     j @a1 ... @ak x1 ... xn = e1
  in e2

then all calls to `j` are in tail-call positions of `e`, and expressions in
tail-call positions in `e` have the same type as `e`.
Therefore the type of `e1` -- the return type of the join point -- must be the
same as the type of e2.
Since the type variables aren't bound in `e2`, its type can't include them, and
thus neither can the type of `e1`.

This unfortunately prevents the `go` in the following code from being a
join-point:

  iter :: forall a. Int -&gt; (a -&gt; a) -&gt; a -&gt; a
  iter @a n f x = go @a n f x
    where
      go :: forall a. Int -&gt; (a -&gt; a) -&gt; a -&gt; a
      go @a 0 _ x = x
      go @a n f x = go @a (n-1) f (f x)

In this case, a static argument transformation would fix that (see
ticket #14620):

  iter :: forall a. Int -&gt; (a -&gt; a) -&gt; a -&gt; a
  iter @a n f x = go' @a n f x
    where
      go' :: Int -&gt; (a -&gt; a) -&gt; a -&gt; a
      go' 0 _ x = x
      go' n f x = go' (n-1) f (f x)

In general, loopification could be employed to do that (see #14068.)

Can we simply drop the requirement, and allow `go` to be a join-point? We
could, and it would work. But we could not longer apply the case-of-join-point
transformation universally. This transformation would do:

  case (join go @a n f x = case n of 0 -&gt; x
                                     n -&gt; go @a (n-1) f (f x)
        in go @Bool n neg True) of
    True -&gt; e1; False -&gt; e2

 ===&gt;

  join go @a n f x = case n of 0 -&gt; case x of True -&gt; e1; False -&gt; e2
                          n -&gt; go @a (n-1) f (f x)
  in go @Bool n neg True

but that is ill-typed, as `x` is type `a`, not `Bool`.


This also justifies why we do not consider the `e` in `e |&gt; co` to be in
tail position: A cast changes the type, but the type must be the same. But
operationally, casts are vacuous, so this is a bit unfortunate! See #14610 for
ideas how to fix this.

************************************************************************
*                                                                      *
            In/Out type synonyms
*                                                                      *
********************************************************************* -}</span><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span class="hs-comment">{- Many passes apply a substitution, and it's very handy to have type
   synonyms to remind us whether or not the substitution has been applied -}</span><span>
</span><a name="line-788"></a><span>
</span><a name="line-789"></a><span class="hs-comment">-- Pre-cloning or substitution</span><span>
</span><a name="line-790"></a><span class="hs-keyword">type</span><span> </span><a name="InBndr"><a href="CoreSyn.html#InBndr"><span class="hs-identifier">InBndr</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-791"></a><span class="hs-keyword">type</span><span> </span><a name="InType"><a href="CoreSyn.html#InType"><span class="hs-identifier">InType</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-792"></a><span class="hs-keyword">type</span><span> </span><a name="InKind"><a href="CoreSyn.html#InKind"><span class="hs-identifier">InKind</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-793"></a><span class="hs-keyword">type</span><span> </span><a name="InBind"><a href="CoreSyn.html#InBind"><span class="hs-identifier">InBind</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-794"></a><span class="hs-keyword">type</span><span> </span><a name="InExpr"><a href="CoreSyn.html#InExpr"><span class="hs-identifier">InExpr</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-795"></a><span class="hs-keyword">type</span><span> </span><a name="InAlt"><a href="CoreSyn.html#InAlt"><span class="hs-identifier">InAlt</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-796"></a><span class="hs-keyword">type</span><span> </span><a name="InArg"><a href="CoreSyn.html#InArg"><span class="hs-identifier">InArg</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span>
</span><a name="line-797"></a><span class="hs-keyword">type</span><span> </span><a name="InCoercion"><a href="CoreSyn.html#InCoercion"><span class="hs-identifier">InCoercion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-798"></a><span>
</span><a name="line-799"></a><span class="hs-comment">-- Post-cloning or substitution</span><span>
</span><a name="line-800"></a><span class="hs-keyword">type</span><span> </span><a name="OutBndr"><a href="CoreSyn.html#OutBndr"><span class="hs-identifier">OutBndr</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-801"></a><span class="hs-keyword">type</span><span> </span><a name="OutType"><a href="CoreSyn.html#OutType"><span class="hs-identifier">OutType</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-802"></a><span class="hs-keyword">type</span><span> </span><a name="OutKind"><a href="CoreSyn.html#OutKind"><span class="hs-identifier">OutKind</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Kind"><span class="hs-identifier hs-type">Kind</span></a><span>
</span><a name="line-803"></a><span class="hs-keyword">type</span><span> </span><a name="OutCoercion"><a href="CoreSyn.html#OutCoercion"><span class="hs-identifier">OutCoercion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-804"></a><span class="hs-keyword">type</span><span> </span><a name="OutBind"><a href="CoreSyn.html#OutBind"><span class="hs-identifier">OutBind</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-805"></a><span class="hs-keyword">type</span><span> </span><a name="OutExpr"><a href="CoreSyn.html#OutExpr"><span class="hs-identifier">OutExpr</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-806"></a><span class="hs-keyword">type</span><span> </span><a name="OutAlt"><a href="CoreSyn.html#OutAlt"><span class="hs-identifier">OutAlt</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-807"></a><span class="hs-keyword">type</span><span> </span><a name="OutArg"><a href="CoreSyn.html#OutArg"><span class="hs-identifier">OutArg</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span>
</span><a name="line-808"></a><span class="hs-keyword">type</span><span> </span><a name="MOutCoercion"><a href="CoreSyn.html#MOutCoercion"><span class="hs-identifier">MOutCoercion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span>
</span><a name="line-809"></a><span>
</span><a name="line-810"></a><span>
</span><a name="line-811"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
              Ticks
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-817"></a><span>
</span><a name="line-818"></a><span class="hs-comment">-- | Allows attaching extra information to points in expressions</span><span>
</span><a name="line-819"></a><span>
</span><a name="line-820"></a><span class="hs-comment">-- If you edit this type, you may need to update the GHC formalism</span><span>
</span><a name="line-821"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-822"></a><span class="hs-keyword">data</span><span> </span><a name="Tickish"><a href="CoreSyn.html#Tickish"><span class="hs-identifier">Tickish</span></a></a><span> </span><a name="local-6989586621682264212"><a href="#local-6989586621682264212"><span class="hs-identifier">id</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-823"></a><span>    </span><span class="hs-comment">-- | An @{-# SCC #-}@ profiling annotation, either automatically</span><span>
</span><a name="line-824"></a><span>    </span><span class="hs-comment">-- added by the desugarer as a result of -auto-all, or added by</span><span>
</span><a name="line-825"></a><span>    </span><span class="hs-comment">-- the user.</span><span>
</span><a name="line-826"></a><span>    </span><a name="ProfNote"><a href="CoreSyn.html#ProfNote"><span class="hs-identifier">ProfNote</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-827"></a><span>      </span><a name="profNoteCC"><a href="CoreSyn.html#profNoteCC"><span class="hs-identifier">profNoteCC</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="CostCentre.html#CostCentre"><span class="hs-identifier hs-type">CostCentre</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ the cost centre</span><span>
</span><a name="line-828"></a><span>      </span><a name="profNoteCount"><a href="CoreSyn.html#profNoteCount"><span class="hs-identifier">profNoteCount</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- ^ bump the entry count?</span><span>
</span><a name="line-829"></a><span>      </span><a name="profNoteScope"><a href="CoreSyn.html#profNoteScope"><span class="hs-identifier">profNoteScope</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Bool</span><span>       </span><span class="hs-comment">-- ^ scopes over the enclosed expression</span><span>
</span><a name="line-830"></a><span>                                   </span><span class="hs-comment">-- (i.e. not just a tick)</span><span>
</span><a name="line-831"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span>  </span><span class="hs-comment">-- | A &quot;tick&quot; used by HPC to track the execution of each</span><span>
</span><a name="line-834"></a><span>  </span><span class="hs-comment">-- subexpression in the original source code.</span><span>
</span><a name="line-835"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="HpcTick"><a href="CoreSyn.html#HpcTick"><span class="hs-identifier">HpcTick</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-836"></a><span>      </span><a name="tickModule"><a href="CoreSyn.html#tickModule"><span class="hs-identifier">tickModule</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span>
</span><a name="line-837"></a><span>      </span><a name="tickId"><a href="CoreSyn.html#tickId"><span class="hs-identifier">tickId</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-838"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-839"></a><span>
</span><a name="line-840"></a><span>  </span><span class="hs-comment">-- | A breakpoint for the GHCi debugger.  This behaves like an HPC</span><span>
</span><a name="line-841"></a><span>  </span><span class="hs-comment">-- tick, but has a list of free variables which will be available</span><span>
</span><a name="line-842"></a><span>  </span><span class="hs-comment">-- for inspection in GHCi when the program stops at the breakpoint.</span><span>
</span><a name="line-843"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-844"></a><span>  </span><span class="hs-comment">-- NB. we must take account of these Ids when (a) counting free variables,</span><span>
</span><a name="line-845"></a><span>  </span><span class="hs-comment">-- and (b) substituting (don't substitute for them)</span><span>
</span><a name="line-846"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Breakpoint"><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier">Breakpoint</span></a></a><span>
</span><a name="line-847"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="breakpointId"><a href="CoreSyn.html#breakpointId"><span class="hs-identifier">breakpointId</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-848"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="breakpointFVs"><a href="CoreSyn.html#breakpointFVs"><span class="hs-identifier">breakpointFVs</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264212"><span class="hs-identifier hs-type">id</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ the order of this list is important:</span><span>
</span><a name="line-849"></a><span>                                </span><span class="hs-comment">-- it matches the order of the lists in the</span><span>
</span><a name="line-850"></a><span>                                </span><span class="hs-comment">-- appropriate entry in HscTypes.ModBreaks.</span><span>
</span><a name="line-851"></a><span>                                </span><span class="hs-comment">--</span><span>
</span><a name="line-852"></a><span>                                </span><span class="hs-comment">-- Careful about substitution!  See</span><span>
</span><a name="line-853"></a><span>                                </span><span class="hs-comment">-- Note [substTickish] in CoreSubst.</span><span>
</span><a name="line-854"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-855"></a><span>
</span><a name="line-856"></a><span>  </span><span class="hs-comment">-- | A source note.</span><span>
</span><a name="line-857"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-858"></a><span>  </span><span class="hs-comment">-- Source notes are pure annotations: Their presence should neither</span><span>
</span><a name="line-859"></a><span>  </span><span class="hs-comment">-- influence compilation nor execution. The semantics are given by</span><span>
</span><a name="line-860"></a><span>  </span><span class="hs-comment">-- causality: The presence of a source note means that a local</span><span>
</span><a name="line-861"></a><span>  </span><span class="hs-comment">-- change in the referenced source code span will possibly provoke</span><span>
</span><a name="line-862"></a><span>  </span><span class="hs-comment">-- the generated code to change. On the flip-side, the functionality</span><span>
</span><a name="line-863"></a><span>  </span><span class="hs-comment">-- of annotated code *must* be invariant against changes to all</span><span>
</span><a name="line-864"></a><span>  </span><span class="hs-comment">-- source code *except* the spans referenced in the source notes</span><span>
</span><a name="line-865"></a><span>  </span><span class="hs-comment">-- (see &quot;Causality of optimized Haskell&quot; paper for details).</span><span>
</span><a name="line-866"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-867"></a><span>  </span><span class="hs-comment">-- Therefore extending the scope of any given source note is always</span><span>
</span><a name="line-868"></a><span>  </span><span class="hs-comment">-- valid. Note that it is still undesirable though, as this reduces</span><span>
</span><a name="line-869"></a><span>  </span><span class="hs-comment">-- their usefulness for debugging and profiling. Therefore we will</span><span>
</span><a name="line-870"></a><span>  </span><span class="hs-comment">-- generally try only to make use of this property where it is</span><span>
</span><a name="line-871"></a><span>  </span><span class="hs-comment">-- necessary to enable optimizations.</span><span>
</span><a name="line-872"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SourceNote"><a href="CoreSyn.html#SourceNote"><span class="hs-identifier">SourceNote</span></a></a><span>
</span><a name="line-873"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="sourceSpan"><a href="CoreSyn.html#sourceSpan"><span class="hs-identifier">sourceSpan</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="SrcLoc.html#RealSrcSpan"><span class="hs-identifier hs-type">RealSrcSpan</span></a><span> </span><span class="hs-comment">-- ^ Source covered</span><span>
</span><a name="line-874"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="sourceName"><a href="CoreSyn.html#sourceName"><span class="hs-identifier">sourceName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>      </span><span class="hs-comment">-- ^ Name for source location</span><span>
</span><a name="line-875"></a><span>                                </span><span class="hs-comment">--   (uses same names as CCs)</span><span>
</span><a name="line-876"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-877"></a><span>
</span><a name="line-878"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span class="hs-special">)</span><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span class="hs-comment">-- | A &quot;counting tick&quot; (where tickishCounts is True) is one that</span><span>
</span><a name="line-881"></a><span class="hs-comment">-- counts evaluations in some way.  We cannot discard a counting tick,</span><span>
</span><a name="line-882"></a><span class="hs-comment">-- and the compiler should preserve the number of counting ticks as</span><span>
</span><a name="line-883"></a><span class="hs-comment">-- far as possible.</span><span>
</span><a name="line-884"></a><span class="hs-comment">--</span><span>
</span><a name="line-885"></a><span class="hs-comment">-- However, we still allow the simplifier to increase or decrease</span><span>
</span><a name="line-886"></a><span class="hs-comment">-- sharing, so in practice the actual number of ticks may vary, except</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- that we never change the value from zero to non-zero or vice versa.</span><span>
</span><a name="line-888"></a><span class="hs-identifier">tickishCounts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264305"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-889"></a><a name="tickishCounts"><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier">tickishCounts</span></a></a><span> </span><a name="local-6989586621682264306"><a href="#local-6989586621682264306"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">profNoteCount</span><span> </span><a href="#local-6989586621682264306"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-890"></a><span class="hs-identifier">tickishCounts</span><span> </span><a href="CoreSyn.html#HpcTick"><span class="hs-identifier hs-var">HpcTick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-891"></a><span class="hs-identifier">tickishCounts</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-892"></a><span class="hs-identifier">tickishCounts</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-893"></a><span>
</span><a name="line-894"></a><span>
</span><a name="line-895"></a><span class="hs-comment">-- | Specifies the scoping behaviour of ticks. This governs the</span><span>
</span><a name="line-896"></a><span class="hs-comment">-- behaviour of ticks that care about the covered code and the cost</span><span>
</span><a name="line-897"></a><span class="hs-comment">-- associated with it. Important for ticks relating to profiling.</span><span>
</span><a name="line-898"></a><span class="hs-keyword">data</span><span> </span><a name="TickishScoping"><a href="CoreSyn.html#TickishScoping"><span class="hs-identifier">TickishScoping</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-899"></a><span>    </span><span class="hs-comment">-- | No scoping: The tick does not care about what code it</span><span>
</span><a name="line-900"></a><span>    </span><span class="hs-comment">-- covers. Transformations can freely move code inside as well as</span><span>
</span><a name="line-901"></a><span>    </span><span class="hs-comment">-- outside without any additional annotation obligations</span><span>
</span><a name="line-902"></a><span>    </span><a name="NoScope"><a href="CoreSyn.html#NoScope"><span class="hs-identifier">NoScope</span></a></a><span>
</span><a name="line-903"></a><span>
</span><a name="line-904"></a><span>    </span><span class="hs-comment">-- | Soft scoping: We want all code that is covered to stay</span><span>
</span><a name="line-905"></a><span>    </span><span class="hs-comment">-- covered.  Note that this scope type does not forbid</span><span>
</span><a name="line-906"></a><span>    </span><span class="hs-comment">-- transformations from happening, as long as all results of</span><span>
</span><a name="line-907"></a><span>    </span><span class="hs-comment">-- the transformations are still covered by this tick or a copy of</span><span>
</span><a name="line-908"></a><span>    </span><span class="hs-comment">-- it. For example</span><span>
</span><a name="line-909"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-910"></a><span>    </span><span class="hs-comment">--   let x = tick&lt;...&gt; (let y = foo in bar) in baz</span><span>
</span><a name="line-911"></a><span>    </span><span class="hs-comment">--     ===&gt;</span><span>
</span><a name="line-912"></a><span>    </span><span class="hs-comment">--   let x = tick&lt;...&gt; bar; y = tick&lt;...&gt; foo in baz</span><span>
</span><a name="line-913"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-914"></a><span>    </span><span class="hs-comment">-- Is a valid transformation as far as &quot;bar&quot; and &quot;foo&quot; is</span><span>
</span><a name="line-915"></a><span>    </span><span class="hs-comment">-- concerned, because both still are scoped over by the tick.</span><span>
</span><a name="line-916"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-917"></a><span>    </span><span class="hs-comment">-- Note though that one might object to the &quot;let&quot; not being</span><span>
</span><a name="line-918"></a><span>    </span><span class="hs-comment">-- covered by the tick any more. However, we are generally lax</span><span>
</span><a name="line-919"></a><span>    </span><span class="hs-comment">-- with this - constant costs don't matter too much, and given</span><span>
</span><a name="line-920"></a><span>    </span><span class="hs-comment">-- that the &quot;let&quot; was effectively merged we can view it as having</span><span>
</span><a name="line-921"></a><span>    </span><span class="hs-comment">-- lost its identity anyway.</span><span>
</span><a name="line-922"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-923"></a><span>    </span><span class="hs-comment">-- Also note that this scoping behaviour allows floating a tick</span><span>
</span><a name="line-924"></a><span>    </span><span class="hs-comment">-- &quot;upwards&quot; in pretty much any situation. For example:</span><span>
</span><a name="line-925"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-926"></a><span>    </span><span class="hs-comment">--   case foo of x -&gt; tick&lt;...&gt; bar</span><span>
</span><a name="line-927"></a><span>    </span><span class="hs-comment">--     ==&gt;</span><span>
</span><a name="line-928"></a><span>    </span><span class="hs-comment">--   tick&lt;...&gt; case foo of x -&gt; bar</span><span>
</span><a name="line-929"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-930"></a><span>    </span><span class="hs-comment">-- While this is always leagl, we want to make a best effort to</span><span>
</span><a name="line-931"></a><span>    </span><span class="hs-comment">-- only make us of this where it exposes transformation</span><span>
</span><a name="line-932"></a><span>    </span><span class="hs-comment">-- opportunities.</span><span>
</span><a name="line-933"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="SoftScope"><a href="CoreSyn.html#SoftScope"><span class="hs-identifier">SoftScope</span></a></a><span>
</span><a name="line-934"></a><span>
</span><a name="line-935"></a><span>    </span><span class="hs-comment">-- | Cost centre scoping: We don't want any costs to move to other</span><span>
</span><a name="line-936"></a><span>    </span><span class="hs-comment">-- cost-centre stacks. This means we not only want no code or cost</span><span>
</span><a name="line-937"></a><span>    </span><span class="hs-comment">-- to get moved out of their cost centres, but we also object to</span><span>
</span><a name="line-938"></a><span>    </span><span class="hs-comment">-- code getting associated with new cost-centre ticks - or</span><span>
</span><a name="line-939"></a><span>    </span><span class="hs-comment">-- changing the order in which they get applied.</span><span>
</span><a name="line-940"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-941"></a><span>    </span><span class="hs-comment">-- A rule of thumb is that we don't want any code to gain new</span><span>
</span><a name="line-942"></a><span>    </span><span class="hs-comment">-- annotations. However, there are notable exceptions, for</span><span>
</span><a name="line-943"></a><span>    </span><span class="hs-comment">-- example:</span><span>
</span><a name="line-944"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-945"></a><span>    </span><span class="hs-comment">--   let f = \y -&gt; foo in tick&lt;...&gt; ... (f x) ...</span><span>
</span><a name="line-946"></a><span>    </span><span class="hs-comment">--     ==&gt;</span><span>
</span><a name="line-947"></a><span>    </span><span class="hs-comment">--   tick&lt;...&gt; ... foo[x/y] ...</span><span>
</span><a name="line-948"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-949"></a><span>    </span><span class="hs-comment">-- In-lining lambdas like this is always legal, because inlining a</span><span>
</span><a name="line-950"></a><span>    </span><span class="hs-comment">-- function does not change the cost-centre stack when the</span><span>
</span><a name="line-951"></a><span>    </span><span class="hs-comment">-- function is called.</span><span>
</span><a name="line-952"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CostCentreScope"><a href="CoreSyn.html#CostCentreScope"><span class="hs-identifier">CostCentreScope</span></a></a><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>
</span><a name="line-956"></a><span class="hs-comment">-- | Returns the intended scoping rule for a Tickish</span><span>
</span><a name="line-957"></a><span class="hs-identifier">tickishScoped</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264304"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#TickishScoping"><span class="hs-identifier hs-type">TickishScoping</span></a><span>
</span><a name="line-958"></a><a name="tickishScoped"><a href="CoreSyn.html#tickishScoped"><span class="hs-identifier">tickishScoped</span></a></a><span> </span><a name="local-6989586621682264307"><a href="#local-6989586621682264307"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-959"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">profNoteScope</span><span> </span><a href="#local-6989586621682264307"><span class="hs-identifier hs-var">n</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CostCentreScope"><span class="hs-identifier hs-var">CostCentreScope</span></a><span>
</span><a name="line-960"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>
</span><a name="line-961"></a><span class="hs-identifier">tickishScoped</span><span> </span><a href="CoreSyn.html#HpcTick"><span class="hs-identifier hs-var">HpcTick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>
</span><a name="line-962"></a><span class="hs-identifier">tickishScoped</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#CostCentreScope"><span class="hs-identifier hs-var">CostCentreScope</span></a><span>
</span><a name="line-963"></a><span>   </span><span class="hs-comment">-- Breakpoints are scoped: eventually we're going to do call</span><span>
</span><a name="line-964"></a><span>   </span><span class="hs-comment">-- stacks, but also this helps prevent the simplifier from moving</span><span>
</span><a name="line-965"></a><span>   </span><span class="hs-comment">-- breakpoints around and changing their result type (see #1531).</span><span>
</span><a name="line-966"></a><span class="hs-identifier">tickishScoped</span><span> </span><a href="CoreSyn.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span class="hs-comment">-- | Returns whether the tick scoping rule is at least as permissive</span><span>
</span><a name="line-969"></a><span class="hs-comment">-- as the given scoping rule.</span><span>
</span><a name="line-970"></a><span class="hs-identifier">tickishScopesLike</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264303"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#TickishScoping"><span class="hs-identifier hs-type">TickishScoping</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-971"></a><a name="tickishScopesLike"><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier">tickishScopesLike</span></a></a><span> </span><a name="local-6989586621682264308"><a href="#local-6989586621682264308"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621682264309"><a href="#local-6989586621682264309"><span class="hs-identifier">scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a><span> </span><a href="#local-6989586621682264308"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621682264310"><span class="hs-identifier hs-var">like</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682264309"><span class="hs-identifier hs-var">scope</span></a><span>
</span><a name="line-972"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>         </span><span class="hs-special">`</span><a name="local-6989586621682264310"><a href="#local-6989586621682264310"><span class="hs-identifier">like</span></a></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-973"></a><span>        </span><span class="hs-identifier">_</span><span>               </span><span class="hs-special">`</span><span class="hs-identifier">like</span><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-974"></a><span>        </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>       </span><span class="hs-special">`</span><span class="hs-identifier">like</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-975"></a><span>        </span><span class="hs-identifier">_</span><span>               </span><span class="hs-special">`</span><span class="hs-identifier">like</span><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-976"></a><span>        </span><a href="CoreSyn.html#CostCentreScope"><span class="hs-identifier hs-var">CostCentreScope</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">like</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-977"></a><span>
</span><a name="line-978"></a><span class="hs-comment">-- | Returns @True@ for ticks that can be floated upwards easily even</span><span>
</span><a name="line-979"></a><span class="hs-comment">-- where it might change execution counts, such as:</span><span>
</span><a name="line-980"></a><span class="hs-comment">--</span><span>
</span><a name="line-981"></a><span class="hs-comment">--   Just (tick&lt;...&gt; foo)</span><span>
</span><a name="line-982"></a><span class="hs-comment">--     ==&gt;</span><span>
</span><a name="line-983"></a><span class="hs-comment">--   tick&lt;...&gt; (Just foo)</span><span>
</span><a name="line-984"></a><span class="hs-comment">--</span><span>
</span><a name="line-985"></a><span class="hs-comment">-- This is a combination of @tickishSoftScope@ and</span><span>
</span><a name="line-986"></a><span class="hs-comment">-- @tickishCounts@. Note that in principle splittable ticks can become</span><span>
</span><a name="line-987"></a><span class="hs-comment">-- floatable using @mkNoTick@ -- even though there's currently no</span><span>
</span><a name="line-988"></a><span class="hs-comment">-- tickish for which that is the case.</span><span>
</span><a name="line-989"></a><span class="hs-identifier">tickishFloatable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264302"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-990"></a><a name="tickishFloatable"><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier">tickishFloatable</span></a></a><span> </span><a name="local-6989586621682264311"><a href="#local-6989586621682264311"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264311"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-6989586621682264311"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-991"></a><span>
</span><a name="line-992"></a><span class="hs-comment">-- | Returns @True@ for a tick that is both counting /and/ scoping and</span><span>
</span><a name="line-993"></a><span class="hs-comment">-- can be split into its (tick, scope) parts using 'mkNoScope' and</span><span>
</span><a name="line-994"></a><span class="hs-comment">-- 'mkNoTick' respectively.</span><span>
</span><a name="line-995"></a><span class="hs-identifier">tickishCanSplit</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264301"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-996"></a><a name="tickishCanSplit"><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier">tickishCanSplit</span></a></a><span> </span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-identifier">profNoteScope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">profNoteCount</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">}</span><span>
</span><a name="line-997"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-998"></a><span class="hs-identifier">tickishCanSplit</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-999"></a><span>
</span><a name="line-1000"></a><span class="hs-identifier">mkNoCount</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264300"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264300"><span class="hs-identifier hs-type">id</span></a><span>
</span><a name="line-1001"></a><a name="mkNoCount"><a href="CoreSyn.html#mkNoCount"><span class="hs-identifier">mkNoCount</span></a></a><span> </span><a name="local-6989586621682264312"><a href="#local-6989586621682264312"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCounts"><span class="hs-identifier hs-var">tickishCounts</span></a><span> </span><a href="#local-6989586621682264312"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264312"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1002"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a><span> </span><a href="#local-6989586621682264312"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkNoCount: Cannot split!&quot;</span><span>
</span><a name="line-1003"></a><span class="hs-identifier">mkNoCount</span><span> </span><a name="local-6989586621682264313"><a href="#local-6989586621682264313"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264313"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">profNoteCount</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">}</span><span>
</span><a name="line-1004"></a><span class="hs-identifier">mkNoCount</span><span> </span><span class="hs-identifier">_</span><span>                           </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkNoCount: Undefined split!&quot;</span><span>
</span><a name="line-1005"></a><span>
</span><a name="line-1006"></a><span class="hs-identifier">mkNoScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264299"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264299"><span class="hs-identifier hs-type">id</span></a><span>
</span><a name="line-1007"></a><a name="mkNoScope"><a href="CoreSyn.html#mkNoScope"><span class="hs-identifier">mkNoScope</span></a></a><span> </span><a name="local-6989586621682264314"><a href="#local-6989586621682264314"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishScoped"><span class="hs-identifier hs-var">tickishScoped</span></a><span> </span><a href="#local-6989586621682264314"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="CoreSyn.html#NoScope"><span class="hs-identifier hs-var">NoScope</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264314"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1008"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishCanSplit"><span class="hs-identifier hs-var">tickishCanSplit</span></a><span> </span><a href="#local-6989586621682264314"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkNoScope: Cannot split!&quot;</span><span>
</span><a name="line-1009"></a><span class="hs-identifier">mkNoScope</span><span> </span><a name="local-6989586621682264315"><a href="#local-6989586621682264315"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>                    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264315"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">profNoteScope</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">}</span><span>
</span><a name="line-1010"></a><span class="hs-identifier">mkNoScope</span><span> </span><span class="hs-identifier">_</span><span>                               </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;mkNoScope: Undefined split!&quot;</span><span>
</span><a name="line-1011"></a><span>
</span><a name="line-1012"></a><span class="hs-comment">-- | Return @True@ if this source annotation compiles to some backend</span><span>
</span><a name="line-1013"></a><span class="hs-comment">-- code. Without this flag, the tickish is seen as a simple annotation</span><span>
</span><a name="line-1014"></a><span class="hs-comment">-- that does not have any associated evaluation code.</span><span>
</span><a name="line-1015"></a><span class="hs-comment">--</span><span>
</span><a name="line-1016"></a><span class="hs-comment">-- What this means that we are allowed to disregard the tick if doing</span><span>
</span><a name="line-1017"></a><span class="hs-comment">-- so means that we can skip generating any code in the first place. A</span><span>
</span><a name="line-1018"></a><span class="hs-comment">-- typical example is top-level bindings:</span><span>
</span><a name="line-1019"></a><span class="hs-comment">--</span><span>
</span><a name="line-1020"></a><span class="hs-comment">--   foo = tick&lt;...&gt; \y -&gt; ...</span><span>
</span><a name="line-1021"></a><span class="hs-comment">--     ==&gt;</span><span>
</span><a name="line-1022"></a><span class="hs-comment">--   foo = \y -&gt; tick&lt;...&gt; ...</span><span>
</span><a name="line-1023"></a><span class="hs-comment">--</span><span>
</span><a name="line-1024"></a><span class="hs-comment">-- Here there is just no operational difference between the first and</span><span>
</span><a name="line-1025"></a><span class="hs-comment">-- the second version. Therefore code generation should simply</span><span>
</span><a name="line-1026"></a><span class="hs-comment">-- translate the code as if it found the latter.</span><span>
</span><a name="line-1027"></a><span class="hs-identifier">tickishIsCode</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264298"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1028"></a><a name="tickishIsCode"><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier">tickishIsCode</span></a></a><span> </span><a href="CoreSyn.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1029"></a><span class="hs-identifier">tickishIsCode</span><span> </span><a name="local-6989586621682264316"><a href="#local-6989586621682264316"><span class="hs-identifier">_tickish</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>  </span><span class="hs-comment">-- all the rest for now</span><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span>
</span><a name="line-1032"></a><span class="hs-comment">-- | Governs the kind of expression that the tick gets placed on when</span><span>
</span><a name="line-1033"></a><span class="hs-comment">-- annotating for example using @mkTick@. If we find that we want to</span><span>
</span><a name="line-1034"></a><span class="hs-comment">-- put a tickish on an expression ruled out here, we try to float it</span><span>
</span><a name="line-1035"></a><span class="hs-comment">-- inwards until we find a suitable expression.</span><span>
</span><a name="line-1036"></a><span class="hs-keyword">data</span><span> </span><a name="TickishPlacement"><a href="CoreSyn.html#TickishPlacement"><span class="hs-identifier">TickishPlacement</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1037"></a><span>
</span><a name="line-1038"></a><span>    </span><span class="hs-comment">-- | Place ticks exactly on run-time expressions. We can still</span><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-comment">-- move the tick through pure compile-time constructs such as</span><span>
</span><a name="line-1040"></a><span>    </span><span class="hs-comment">-- other ticks, casts or type lambdas. This is the most</span><span>
</span><a name="line-1041"></a><span>    </span><span class="hs-comment">-- restrictive placement rule for ticks, as all tickishs have in</span><span>
</span><a name="line-1042"></a><span>    </span><span class="hs-comment">-- common that they want to track runtime processes. The only</span><span>
</span><a name="line-1043"></a><span>    </span><span class="hs-comment">-- legal placement rule for counting ticks.</span><span>
</span><a name="line-1044"></a><span>    </span><a name="PlaceRuntime"><a href="CoreSyn.html#PlaceRuntime"><span class="hs-identifier">PlaceRuntime</span></a></a><span>
</span><a name="line-1045"></a><span>
</span><a name="line-1046"></a><span>    </span><span class="hs-comment">-- | As @PlaceRuntime@, but we float the tick through all</span><span>
</span><a name="line-1047"></a><span>    </span><span class="hs-comment">-- lambdas. This makes sense where there is little difference</span><span>
</span><a name="line-1048"></a><span>    </span><span class="hs-comment">-- between annotating the lambda and annotating the lambda's code.</span><span>
</span><a name="line-1049"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PlaceNonLam"><a href="CoreSyn.html#PlaceNonLam"><span class="hs-identifier">PlaceNonLam</span></a></a><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span>    </span><span class="hs-comment">-- | In addition to floating through lambdas, cost-centre style</span><span>
</span><a name="line-1052"></a><span>    </span><span class="hs-comment">-- tickishs can also be moved from constructors, non-function</span><span>
</span><a name="line-1053"></a><span>    </span><span class="hs-comment">-- variables and literals. For example:</span><span>
</span><a name="line-1054"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1055"></a><span>    </span><span class="hs-comment">--   let x = scc&lt;...&gt; C (scc&lt;...&gt; y) (scc&lt;...&gt; 3) in ...</span><span>
</span><a name="line-1056"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1057"></a><span>    </span><span class="hs-comment">-- Neither the constructor application, the variable or the</span><span>
</span><a name="line-1058"></a><span>    </span><span class="hs-comment">-- literal are likely to have any cost worth mentioning. And even</span><span>
</span><a name="line-1059"></a><span>    </span><span class="hs-comment">-- if y names a thunk, the call would not care about the</span><span>
</span><a name="line-1060"></a><span>    </span><span class="hs-comment">-- evaluation context. Therefore removing all annotations in the</span><span>
</span><a name="line-1061"></a><span>    </span><span class="hs-comment">-- above example is safe.</span><span>
</span><a name="line-1062"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="PlaceCostCentre"><a href="CoreSyn.html#PlaceCostCentre"><span class="hs-identifier">PlaceCostCentre</span></a></a><span>
</span><a name="line-1063"></a><span>
</span><a name="line-1064"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1065"></a><span>
</span><a name="line-1066"></a><span class="hs-comment">-- | Placement behaviour we want for the ticks</span><span>
</span><a name="line-1067"></a><span class="hs-identifier">tickishPlace</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264297"><span class="hs-identifier hs-type">id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#TickishPlacement"><span class="hs-identifier hs-type">TickishPlacement</span></a><span>
</span><a name="line-1068"></a><a name="tickishPlace"><a href="CoreSyn.html#tickishPlace"><span class="hs-identifier">tickishPlace</span></a></a><span> </span><a name="local-6989586621682264317"><a href="#local-6989586621682264317"><span class="hs-identifier">n</span></a></a><span class="hs-glyph">@</span><a href="CoreSyn.html#ProfNote"><span class="hs-identifier hs-var">ProfNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><a name="line-1069"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">profNoteCount</span><span> </span><a href="#local-6989586621682264317"><span class="hs-identifier hs-var">n</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#PlaceRuntime"><span class="hs-identifier hs-var">PlaceRuntime</span></a><span>
</span><a name="line-1070"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#PlaceCostCentre"><span class="hs-identifier hs-var">PlaceCostCentre</span></a><span>
</span><a name="line-1071"></a><span class="hs-identifier">tickishPlace</span><span> </span><a href="CoreSyn.html#HpcTick"><span class="hs-identifier hs-var">HpcTick</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#PlaceRuntime"><span class="hs-identifier hs-var">PlaceRuntime</span></a><span>
</span><a name="line-1072"></a><span class="hs-identifier">tickishPlace</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#PlaceRuntime"><span class="hs-identifier hs-var">PlaceRuntime</span></a><span>
</span><a name="line-1073"></a><span class="hs-identifier">tickishPlace</span><span> </span><a href="CoreSyn.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#PlaceNonLam"><span class="hs-identifier hs-var">PlaceNonLam</span></a><span>
</span><a name="line-1074"></a><span>
</span><a name="line-1075"></a><span class="hs-comment">-- | Returns whether one tick &quot;contains&quot; the other one, therefore</span><span>
</span><a name="line-1076"></a><span class="hs-comment">-- making the second tick redundant.</span><span>
</span><a name="line-1077"></a><span class="hs-identifier">tickishContains</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Eq</span><span> </span><a href="#local-6989586621682264296"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264296"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="#local-6989586621682264296"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1078"></a><a name="tickishContains"><a href="CoreSyn.html#tickishContains"><span class="hs-identifier">tickishContains</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a><span> </span><a name="local-6989586621682264318"><a href="#local-6989586621682264318"><span class="hs-identifier">sp1</span></a></a><span> </span><a name="local-6989586621682264319"><a href="#local-6989586621682264319"><span class="hs-identifier">n1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#SourceNote"><span class="hs-identifier hs-var">SourceNote</span></a><span> </span><a name="local-6989586621682264320"><a href="#local-6989586621682264320"><span class="hs-identifier">sp2</span></a></a><span> </span><a name="local-6989586621682264321"><a href="#local-6989586621682264321"><span class="hs-identifier">n2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="SrcLoc.html#containsSpan"><span class="hs-identifier hs-var">containsSpan</span></a><span> </span><a href="#local-6989586621682264318"><span class="hs-identifier hs-var">sp1</span></a><span> </span><a href="#local-6989586621682264320"><span class="hs-identifier hs-var">sp2</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621682264319"><span class="hs-identifier hs-var">n1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682264321"><span class="hs-identifier hs-var">n2</span></a><span>
</span><a name="line-1080"></a><span>    </span><span class="hs-comment">-- compare the String last</span><span>
</span><a name="line-1081"></a><span class="hs-identifier">tickishContains</span><span> </span><a name="local-6989586621682264322"><a href="#local-6989586621682264322"><span class="hs-identifier">t1</span></a></a><span> </span><a name="local-6989586621682264323"><a href="#local-6989586621682264323"><span class="hs-identifier">t2</span></a></a><span>
</span><a name="line-1082"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264322"><span class="hs-identifier hs-var">t1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621682264323"><span class="hs-identifier hs-var">t2</span></a><span>
</span><a name="line-1083"></a><span>
</span><a name="line-1084"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Orphans
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1091"></a><span>
</span><a name="line-1092"></a><span class="hs-comment">-- | Is this instance an orphan?  If it is not an orphan, contains an 'OccName'</span><span>
</span><a name="line-1093"></a><span class="hs-comment">-- witnessing the instance's non-orphanhood.</span><span>
</span><a name="line-1094"></a><span class="hs-comment">-- See Note [Orphans]</span><span>
</span><a name="line-1095"></a><span class="hs-keyword">data</span><span> </span><a name="IsOrphan"><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier">IsOrphan</span></a></a><span>
</span><a name="line-1096"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="IsOrphan"><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier">IsOrphan</span></a></a><span>
</span><a name="line-1097"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="NotOrphan"><a href="CoreSyn.html#NotOrphan"><span class="hs-identifier">NotOrphan</span></a></a><span> </span><a href="OccName.html#OccName"><span class="hs-identifier hs-type">OccName</span></a><span> </span><span class="hs-comment">-- The OccName 'n' witnesses the instance's non-orphanhood</span><span>
</span><a name="line-1098"></a><span>                      </span><span class="hs-comment">-- In that case, the instance is fingerprinted as part</span><span>
</span><a name="line-1099"></a><span>                      </span><span class="hs-comment">-- of the definition of 'n's definition</span><span>
</span><a name="line-1100"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Data</span><span>
</span><a name="line-1101"></a><span>
</span><a name="line-1102"></a><span class="hs-comment">-- | Returns true if 'IsOrphan' is orphan.</span><span>
</span><a name="line-1103"></a><span class="hs-identifier">isOrphan</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1104"></a><a name="isOrphan"><a href="CoreSyn.html#isOrphan"><span class="hs-identifier">isOrphan</span></a></a><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-var">IsOrphan</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1105"></a><span class="hs-identifier">isOrphan</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1106"></a><span>
</span><a name="line-1107"></a><span class="hs-comment">-- | Returns true if 'IsOrphan' is not an orphan.</span><span>
</span><a name="line-1108"></a><span class="hs-identifier">notOrphan</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1109"></a><a name="notOrphan"><a href="CoreSyn.html#notOrphan"><span class="hs-identifier">notOrphan</span></a></a><span> </span><a href="CoreSyn.html#NotOrphan"><span class="hs-identifier hs-var">NotOrphan</span></a><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1110"></a><span class="hs-identifier">notOrphan</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span class="hs-identifier">chooseOrphanAnchor</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NameSet.html#NameSet"><span class="hs-identifier hs-type">NameSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a><span>
</span><a name="line-1113"></a><span class="hs-comment">-- Something (rule, instance) is relate to all the Names in this</span><span>
</span><a name="line-1114"></a><span class="hs-comment">-- list. Choose one of them to be an &quot;anchor&quot; for the orphan.  We make</span><span>
</span><a name="line-1115"></a><span class="hs-comment">-- the choice deterministic to avoid gratuitious changes in the ABI</span><span>
</span><a name="line-1116"></a><span class="hs-comment">-- hash (Trac #4012).  Specifically, use lexicographic comparison of</span><span>
</span><a name="line-1117"></a><span class="hs-comment">-- OccName rather than comparing Uniques</span><span>
</span><a name="line-1118"></a><span class="hs-comment">--</span><span>
</span><a name="line-1119"></a><span class="hs-comment">-- NB: 'minimum' use Ord, and (Ord OccName) works lexicographically</span><span>
</span><a name="line-1120"></a><span class="hs-comment">--</span><span>
</span><a name="line-1121"></a><a name="chooseOrphanAnchor"><a href="CoreSyn.html#chooseOrphanAnchor"><span class="hs-identifier">chooseOrphanAnchor</span></a></a><span> </span><a name="local-6989586621682264324"><a href="#local-6989586621682264324"><span class="hs-identifier">local_names</span></a></a><span>
</span><a name="line-1122"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="NameSet.html#isEmptyNameSet"><span class="hs-identifier hs-var">isEmptyNameSet</span></a><span> </span><a href="#local-6989586621682264324"><span class="hs-identifier hs-var">local_names</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-var">IsOrphan</span></a><span>
</span><a name="line-1123"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NotOrphan"><span class="hs-identifier hs-var">NotOrphan</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">minimum</span><span> </span><a href="#local-6989586621682264325"><span class="hs-identifier hs-var">occs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1125"></a><span>    </span><a name="local-6989586621682264325"><a href="#local-6989586621682264325"><span class="hs-identifier">occs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Name.html#nameOccName"><span class="hs-identifier hs-var">nameOccName</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UniqSet.html#nonDetEltsUniqSet"><span class="hs-identifier hs-var">nonDetEltsUniqSet</span></a><span> </span><a href="#local-6989586621682264324"><span class="hs-identifier hs-var">local_names</span></a><span>
</span><a name="line-1126"></a><span>    </span><span class="hs-comment">-- It's OK to use nonDetEltsUFM here, see comments above</span><span>
</span><a name="line-1127"></a><span>
</span><a name="line-1128"></a><span class="hs-keyword">instance</span><span> </span><a href="Binary.html#Binary"><span class="hs-identifier hs-type">Binary</span></a><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1129"></a><span>    </span><a name="local-8214565720325095592"><a href="Binary.html#put_"><span class="hs-identifier">put_</span></a></a><span> </span><a name="local-6989586621682264222"><a href="#local-6989586621682264222"><span class="hs-identifier">bh</span></a></a><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-var">IsOrphan</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682264222"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-1130"></a><span>    </span><span class="hs-identifier">put_</span><span> </span><a name="local-6989586621682264223"><a href="#local-6989586621682264223"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NotOrphan"><span class="hs-identifier hs-var">NotOrphan</span></a><span> </span><a name="local-6989586621682264224"><a href="#local-6989586621682264224"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1131"></a><span>        </span><a href="Binary.html#putByte"><span class="hs-identifier hs-var">putByte</span></a><span> </span><a href="#local-6989586621682264223"><span class="hs-identifier hs-var">bh</span></a><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1132"></a><span>        </span><a href="Binary.html#put_"><span class="hs-identifier hs-var">put_</span></a><span> </span><a href="#local-6989586621682264223"><span class="hs-identifier hs-var">bh</span></a><span> </span><a href="#local-6989586621682264224"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1133"></a><span>    </span><a name="local-8214565720325095594"><a href="Binary.html#get"><span class="hs-identifier">get</span></a></a><span> </span><a name="local-6989586621682264225"><a href="#local-6989586621682264225"><span class="hs-identifier">bh</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1134"></a><span>        </span><a name="local-6989586621682264226"><a href="#local-6989586621682264226"><span class="hs-identifier">h</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#getByte"><span class="hs-identifier hs-var">getByte</span></a><span> </span><a href="#local-6989586621682264225"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-1135"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621682264226"><span class="hs-identifier hs-var">h</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1136"></a><span>            </span><span class="hs-number">0</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-var">IsOrphan</span></a><span>
</span><a name="line-1137"></a><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1138"></a><span>                </span><a name="local-6989586621682264227"><a href="#local-6989586621682264227"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Binary.html#get"><span class="hs-identifier hs-var">get</span></a><span> </span><a href="#local-6989586621682264225"><span class="hs-identifier hs-var">bh</span></a><span>
</span><a name="line-1139"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CoreSyn.html#NotOrphan"><span class="hs-identifier hs-var">NotOrphan</span></a><span> </span><a href="#local-6989586621682264227"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1140"></a><span>
</span><a name="line-1141"></a><span class="hs-comment">{-
Note [Orphans]
~~~~~~~~~~~~~~
Class instances, rules, and family instances are divided into orphans
and non-orphans.  Roughly speaking, an instance/rule is an orphan if
its left hand side mentions nothing defined in this module.  Orphan-hood
has two major consequences

 * A module that contains orphans is called an &quot;orphan module&quot;.  If
   the module being compiled depends (transitively) on an oprhan
   module M, then M.hi is read in regardless of whether M is oherwise
   needed. This is to ensure that we don't miss any instance decls in
   M.  But it's painful, because it means we need to keep track of all
   the orphan modules below us.

 * A non-orphan is not finger-printed separately.  Instead, for
   fingerprinting purposes it is treated as part of the entity it
   mentions on the LHS.  For example
      data T = T1 | T2
      instance Eq T where ....
   The instance (Eq T) is incorprated as part of T's fingerprint.

   In contrast, orphans are all fingerprinted together in the
   mi_orph_hash field of the ModIface.

   See MkIface.addFingerprints.

Orphan-hood is computed
  * For class instances:
      when we make a ClsInst
    (because it is needed during instance lookup)

  * For rules and family instances:
       when we generate an IfaceRule (MkIface.coreRuleToIfaceRule)
                     or IfaceFamInst (MkIface.instanceToIfaceInst)
-}</span><span>
</span><a name="line-1177"></a><span>
</span><a name="line-1178"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Transformation rules}
*                                                                      *
************************************************************************

The CoreRule type and its friends are dealt with mainly in CoreRules,
but CoreFVs, Subst, PprCore, CoreTidy also inspect the representation.
-}</span><span>
</span><a name="line-1188"></a><span>
</span><a name="line-1189"></a><span class="hs-comment">-- | Gathers a collection of 'CoreRule's. Maps (the name of) an 'Id' to its rules</span><span>
</span><a name="line-1190"></a><span class="hs-keyword">type</span><span> </span><a name="RuleBase"><a href="CoreSyn.html#RuleBase"><span class="hs-identifier">RuleBase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NameEnv.html#NameEnv"><span class="hs-identifier hs-type">NameEnv</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-1191"></a><span>        </span><span class="hs-comment">-- The rules are unordered;</span><span>
</span><a name="line-1192"></a><span>        </span><span class="hs-comment">-- we sort out any overlaps on lookup</span><span>
</span><a name="line-1193"></a><span>
</span><a name="line-1194"></a><span class="hs-comment">-- | A full rule environment which we can apply rules from.  Like a 'RuleBase',</span><span>
</span><a name="line-1195"></a><span class="hs-comment">-- but it also includes the set of visible orphans we use to filter out orphan</span><span>
</span><a name="line-1196"></a><span class="hs-comment">-- rules which are not visible (even though we can see them...)</span><span>
</span><a name="line-1197"></a><span class="hs-keyword">data</span><span> </span><a name="RuleEnv"><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier">RuleEnv</span></a></a><span>
</span><a name="line-1198"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="RuleEnv"><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier">RuleEnv</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="re_base"><a href="CoreSyn.html#re_base"><span class="hs-identifier">re_base</span></a></a><span>          </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span>
</span><a name="line-1199"></a><span>              </span><span class="hs-special">,</span><span> </span><a name="re_visible_orphs"><a href="CoreSyn.html#re_visible_orphs"><span class="hs-identifier">re_visible_orphs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#ModuleSet"><span class="hs-identifier hs-type">ModuleSet</span></a><span>
</span><a name="line-1200"></a><span>              </span><span class="hs-special">}</span><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span class="hs-identifier">mkRuleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleBase"><span class="hs-identifier hs-type">RuleBase</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a><span>
</span><a name="line-1203"></a><a name="mkRuleEnv"><a href="CoreSyn.html#mkRuleEnv"><span class="hs-identifier">mkRuleEnv</span></a></a><span> </span><a name="local-6989586621682264326"><a href="#local-6989586621682264326"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621682264327"><a href="#local-6989586621682264327"><span class="hs-identifier">vis_orphs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-var">RuleEnv</span></a><span> </span><a href="#local-6989586621682264326"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#mkModuleSet"><span class="hs-identifier hs-var">mkModuleSet</span></a><span> </span><a href="#local-6989586621682264327"><span class="hs-identifier hs-var">vis_orphs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1204"></a><span>
</span><a name="line-1205"></a><span class="hs-identifier">emptyRuleEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-type">RuleEnv</span></a><span>
</span><a name="line-1206"></a><a name="emptyRuleEnv"><a href="CoreSyn.html#emptyRuleEnv"><span class="hs-identifier">emptyRuleEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#RuleEnv"><span class="hs-identifier hs-var">RuleEnv</span></a><span> </span><a href="NameEnv.html#emptyNameEnv"><span class="hs-identifier hs-var">emptyNameEnv</span></a><span> </span><a href="Module.html#emptyModuleSet"><span class="hs-identifier hs-var">emptyModuleSet</span></a><span>
</span><a name="line-1207"></a><span>
</span><a name="line-1208"></a><span class="hs-comment">-- | A 'CoreRule' is:</span><span>
</span><a name="line-1209"></a><span class="hs-comment">--</span><span>
</span><a name="line-1210"></a><span class="hs-comment">-- * \&quot;Local\&quot; if the function it is a rule for is defined in the</span><span>
</span><a name="line-1211"></a><span class="hs-comment">--   same module as the rule itself.</span><span>
</span><a name="line-1212"></a><span class="hs-comment">--</span><span>
</span><a name="line-1213"></a><span class="hs-comment">-- * \&quot;Orphan\&quot; if nothing on the LHS is defined in the same module</span><span>
</span><a name="line-1214"></a><span class="hs-comment">--   as the rule itself</span><span>
</span><a name="line-1215"></a><span class="hs-keyword">data</span><span> </span><a name="CoreRule"><a href="CoreSyn.html#CoreRule"><span class="hs-identifier">CoreRule</span></a></a><span>
</span><a name="line-1216"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Rule"><a href="CoreSyn.html#Rule"><span class="hs-identifier">Rule</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1217"></a><span>        </span><a name="ru_name"><a href="CoreSyn.html#ru_name"><span class="hs-identifier">ru_name</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span class="hs-special">,</span><span>            </span><span class="hs-comment">-- ^ Name of the rule, for communication with the user</span><span>
</span><a name="line-1218"></a><span>        </span><a name="ru_act"><a href="CoreSyn.html#ru_act"><span class="hs-identifier">ru_act</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- ^ When the rule is active</span><span>
</span><a name="line-1219"></a><span>
</span><a name="line-1220"></a><span>        </span><span class="hs-comment">-- Rough-matching stuff</span><span>
</span><a name="line-1221"></a><span>        </span><span class="hs-comment">-- see comments with InstEnv.ClsInst( is_cls, is_rough )</span><span>
</span><a name="line-1222"></a><span>        </span><a name="ru_fn"><a href="CoreSyn.html#ru_fn"><span class="hs-identifier">ru_fn</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span>               </span><span class="hs-comment">-- ^ Name of the 'Id.Id' at the head of this rule</span><span>
</span><a name="line-1223"></a><span>        </span><a name="ru_rough"><a href="CoreSyn.html#ru_rough"><span class="hs-identifier">ru_rough</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- ^ Name at the head of each argument to the left hand side</span><span>
</span><a name="line-1224"></a><span>
</span><a name="line-1225"></a><span>        </span><span class="hs-comment">-- Proper-matching stuff</span><span>
</span><a name="line-1226"></a><span>        </span><span class="hs-comment">-- see comments with InstEnv.ClsInst( is_tvs, is_tys )</span><span>
</span><a name="line-1227"></a><span>        </span><a name="ru_bndrs"><a href="CoreSyn.html#ru_bndrs"><span class="hs-identifier">ru_bndrs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- ^ Variables quantified over</span><span>
</span><a name="line-1228"></a><span>        </span><a name="ru_args"><a href="CoreSyn.html#ru_args"><span class="hs-identifier">ru_args</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- ^ Left hand side arguments</span><span>
</span><a name="line-1229"></a><span>
</span><a name="line-1230"></a><span>        </span><span class="hs-comment">-- And the right-hand side</span><span>
</span><a name="line-1231"></a><span>        </span><a name="ru_rhs"><a href="CoreSyn.html#ru_rhs"><span class="hs-identifier">ru_rhs</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span>           </span><span class="hs-comment">-- ^ Right hand side of the rule</span><span>
</span><a name="line-1232"></a><span>                                        </span><span class="hs-comment">-- Occurrence info is guaranteed correct</span><span>
</span><a name="line-1233"></a><span>                                        </span><span class="hs-comment">-- See Note [OccInfo in unfoldings and rules]</span><span>
</span><a name="line-1234"></a><span>
</span><a name="line-1235"></a><span>        </span><span class="hs-comment">-- Locality</span><span>
</span><a name="line-1236"></a><span>        </span><a name="ru_auto"><a href="CoreSyn.html#ru_auto"><span class="hs-identifier">ru_auto</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- ^ @True@  &lt;=&gt; this rule is auto-generated</span><span>
</span><a name="line-1237"></a><span>                           </span><span class="hs-comment">--               (notably by Specialise or SpecConstr)</span><span>
</span><a name="line-1238"></a><span>                           </span><span class="hs-comment">--   @False@ &lt;=&gt; generated at the user's behest</span><span>
</span><a name="line-1239"></a><span>                           </span><span class="hs-comment">-- See Note [Trimming auto-rules] in TidyPgm</span><span>
</span><a name="line-1240"></a><span>                           </span><span class="hs-comment">-- for the sole purpose of this field.</span><span>
</span><a name="line-1241"></a><span>
</span><a name="line-1242"></a><span>        </span><a name="ru_origin"><a href="CoreSyn.html#ru_origin"><span class="hs-identifier">ru_origin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- ^ 'Module' the rule was defined in, used</span><span>
</span><a name="line-1243"></a><span>                                </span><span class="hs-comment">-- to test if we should see an orphan rule.</span><span>
</span><a name="line-1244"></a><span>
</span><a name="line-1245"></a><span>        </span><a name="ru_orphan"><a href="CoreSyn.html#ru_orphan"><span class="hs-identifier">ru_orphan</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="CoreSyn.html#IsOrphan"><span class="hs-identifier hs-type">IsOrphan</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- ^ Whether or not the rule is an orphan.</span><span>
</span><a name="line-1246"></a><span>
</span><a name="line-1247"></a><span>        </span><a name="ru_local"><a href="CoreSyn.html#ru_local"><span class="hs-identifier">ru_local</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>        </span><span class="hs-comment">-- ^ @True@ iff the fn at the head of the rule is</span><span>
</span><a name="line-1248"></a><span>                                </span><span class="hs-comment">-- defined in the same module as the rule</span><span>
</span><a name="line-1249"></a><span>                                </span><span class="hs-comment">-- and is not an implicit 'Id' (like a record selector,</span><span>
</span><a name="line-1250"></a><span>                                </span><span class="hs-comment">-- class operation, or data constructor).  This</span><span>
</span><a name="line-1251"></a><span>                                </span><span class="hs-comment">-- is different from 'ru_orphan', where a rule</span><span>
</span><a name="line-1252"></a><span>                                </span><span class="hs-comment">-- can avoid being an orphan if *any* Name in</span><span>
</span><a name="line-1253"></a><span>                                </span><span class="hs-comment">-- LHS of the rule was defined in the same</span><span>
</span><a name="line-1254"></a><span>                                </span><span class="hs-comment">-- module as the rule.</span><span>
</span><a name="line-1255"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1256"></a><span>
</span><a name="line-1257"></a><span>  </span><span class="hs-comment">-- | Built-in rules are used for constant folding</span><span>
</span><a name="line-1258"></a><span>  </span><span class="hs-comment">-- and suchlike.  They have no free variables.</span><span>
</span><a name="line-1259"></a><span>  </span><span class="hs-comment">-- A built-in rule is always visible (there is no such thing as</span><span>
</span><a name="line-1260"></a><span>  </span><span class="hs-comment">-- an orphan built-in rule.)</span><span>
</span><a name="line-1261"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="BuiltinRule"><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier">BuiltinRule</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1262"></a><span>        </span><a name="ru_name"><a href="CoreSyn.html#ru_name"><span class="hs-identifier">ru_name</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span class="hs-special">,</span><span>   </span><span class="hs-comment">-- ^ As above</span><span>
</span><a name="line-1263"></a><span>        </span><a name="ru_fn"><a href="CoreSyn.html#ru_fn"><span class="hs-identifier">ru_fn</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span>       </span><span class="hs-comment">-- ^ As above</span><span>
</span><a name="line-1264"></a><span>        </span><a name="ru_nargs"><a href="CoreSyn.html#ru_nargs"><span class="hs-identifier">ru_nargs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- ^ Number of arguments that 'ru_try' consumes,</span><span>
</span><a name="line-1265"></a><span>                                </span><span class="hs-comment">-- if it fires, including type arguments</span><span>
</span><a name="line-1266"></a><span>        </span><a name="ru_try"><a href="CoreSyn.html#ru_try"><span class="hs-identifier">ru_try</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#RuleFun"><span class="hs-identifier hs-type">RuleFun</span></a><span>
</span><a name="line-1267"></a><span>                </span><span class="hs-comment">-- ^ This function does the rewrite.  It given too many</span><span>
</span><a name="line-1268"></a><span>                </span><span class="hs-comment">-- arguments, it simply discards them; the returned 'CoreExpr'</span><span>
</span><a name="line-1269"></a><span>                </span><span class="hs-comment">-- is just the rewrite of 'ru_fn' applied to the first 'ru_nargs' args</span><span>
</span><a name="line-1270"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1271"></a><span>                </span><span class="hs-comment">-- See Note [Extra args in rule matching] in Rules.hs</span><span>
</span><a name="line-1272"></a><span>
</span><a name="line-1273"></a><span class="hs-keyword">type</span><span> </span><a name="RuleFun"><a href="CoreSyn.html#RuleFun"><span class="hs-identifier">RuleFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1274"></a><span class="hs-keyword">type</span><span> </span><a name="InScopeEnv"><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier">InScopeEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a><span class="hs-special">)</span><span>
</span><a name="line-1275"></a><span>
</span><a name="line-1276"></a><span class="hs-keyword">type</span><span> </span><a name="IdUnfoldingFun"><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier">IdUnfoldingFun</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-1277"></a><span class="hs-comment">-- A function that embodies how to unfold an Id if you need</span><span>
</span><a name="line-1278"></a><span class="hs-comment">-- to do that in the Rule.  The reason we need to pass this info in</span><span>
</span><a name="line-1279"></a><span class="hs-comment">-- is that whether an Id is unfoldable depends on the simplifier phase</span><span>
</span><a name="line-1280"></a><span>
</span><a name="line-1281"></a><span class="hs-identifier">isBuiltinRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1282"></a><a name="isBuiltinRule"><a href="CoreSyn.html#isBuiltinRule"><span class="hs-identifier">isBuiltinRule</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1283"></a><span class="hs-identifier">isBuiltinRule</span><span> </span><span class="hs-identifier">_</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1284"></a><span>
</span><a name="line-1285"></a><span class="hs-identifier">isAutoRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1286"></a><a name="isAutoRule"><a href="CoreSyn.html#isAutoRule"><span class="hs-identifier">isAutoRule</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1287"></a><span class="hs-identifier">isAutoRule</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_auto</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264328"><a href="#local-6989586621682264328"><span class="hs-identifier">is_auto</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264328"><span class="hs-identifier hs-var">is_auto</span></a><span>
</span><a name="line-1288"></a><span>
</span><a name="line-1289"></a><span class="hs-comment">-- | The number of arguments the 'ru_fn' must be applied</span><span>
</span><a name="line-1290"></a><span class="hs-comment">-- to before the rule can match on it</span><span>
</span><a name="line-1291"></a><span class="hs-identifier">ruleArity</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1292"></a><a name="ruleArity"><a href="CoreSyn.html#ruleArity"><span class="hs-identifier">ruleArity</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ru_nargs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264329"><a href="#local-6989586621682264329"><span class="hs-identifier">n</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264329"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-1293"></a><span class="hs-identifier">ruleArity</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264330"><a href="#local-6989586621682264330"><span class="hs-identifier">args</span></a></a><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621682264330"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1294"></a><span>
</span><a name="line-1295"></a><span class="hs-identifier">ruleName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#RuleName"><span class="hs-identifier hs-type">RuleName</span></a><span>
</span><a name="line-1296"></a><a name="ruleName"><a href="CoreSyn.html#ruleName"><span class="hs-identifier">ruleName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ru_name</span><span>
</span><a name="line-1297"></a><span>
</span><a name="line-1298"></a><span class="hs-identifier">ruleModule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-1299"></a><a name="ruleModule"><a href="CoreSyn.html#ruleModule"><span class="hs-identifier">ruleModule</span></a></a><span> </span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><a name="local-6989586621682264331"><a href="#local-6989586621682264331"><span class="hs-identifier">ru_origin</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682264331"><span class="hs-identifier hs-var">ru_origin</span></a><span>
</span><a name="line-1300"></a><span class="hs-identifier">ruleModule</span><span> </span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1301"></a><span>
</span><a name="line-1302"></a><span class="hs-identifier">ruleActivation</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#Activation"><span class="hs-identifier hs-type">Activation</span></a><span>
</span><a name="line-1303"></a><a name="ruleActivation"><a href="CoreSyn.html#ruleActivation"><span class="hs-identifier">ruleActivation</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#AlwaysActive"><span class="hs-identifier hs-var">AlwaysActive</span></a><span>
</span><a name="line-1304"></a><span class="hs-identifier">ruleActivation</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_act</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264332"><a href="#local-6989586621682264332"><span class="hs-identifier">act</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264332"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-1305"></a><span>
</span><a name="line-1306"></a><span class="hs-comment">-- | The 'Name' of the 'Id.Id' at the head of the rule left hand side</span><span>
</span><a name="line-1307"></a><span class="hs-identifier">ruleIdName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-1308"></a><a name="ruleIdName"><a href="CoreSyn.html#ruleIdName"><span class="hs-identifier">ruleIdName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ru_fn</span><span>
</span><a name="line-1309"></a><span>
</span><a name="line-1310"></a><span class="hs-identifier">isLocalRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1311"></a><a name="isLocalRule"><a href="CoreSyn.html#isLocalRule"><span class="hs-identifier">isLocalRule</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ru_local</span><span>
</span><a name="line-1312"></a><span>
</span><a name="line-1313"></a><span class="hs-comment">-- | Set the 'Name' of the 'Id.Id' at the head of the rule left hand side</span><span>
</span><a name="line-1314"></a><span class="hs-identifier">setRuleIdName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span>
</span><a name="line-1315"></a><a name="setRuleIdName"><a href="CoreSyn.html#setRuleIdName"><span class="hs-identifier">setRuleIdName</span></a></a><span> </span><a name="local-6989586621682264333"><a href="#local-6989586621682264333"><span class="hs-identifier">nm</span></a></a><span> </span><a name="local-6989586621682264334"><a href="#local-6989586621682264334"><span class="hs-identifier">ru</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264334"><span class="hs-identifier hs-var">ru</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264333"><span class="hs-identifier hs-var">nm</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1316"></a><span>
</span><a name="line-1317"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Unfoldings
*                                                                      *
************************************************************************

The @Unfolding@ type is declared here to avoid numerous loops
-}</span><span>
</span><a name="line-1326"></a><span>
</span><a name="line-1327"></a><span class="hs-comment">-- | Records the /unfolding/ of an identifier, which is approximately the form the</span><span>
</span><a name="line-1328"></a><span class="hs-comment">-- identifier would have if we substituted its definition in for the identifier.</span><span>
</span><a name="line-1329"></a><span class="hs-comment">-- This type should be treated as abstract everywhere except in &quot;CoreUnfold&quot;</span><span>
</span><a name="line-1330"></a><span class="hs-keyword">data</span><span> </span><a name="Unfolding"><a href="CoreSyn.html#Unfolding"><span class="hs-identifier">Unfolding</span></a></a><span>
</span><a name="line-1331"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="NoUnfolding"><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier">NoUnfolding</span></a></a><span>        </span><span class="hs-comment">-- ^ We have no information about the unfolding.</span><span>
</span><a name="line-1332"></a><span>
</span><a name="line-1333"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="BootUnfolding"><a href="CoreSyn.html#BootUnfolding"><span class="hs-identifier">BootUnfolding</span></a></a><span>      </span><span class="hs-comment">-- ^ We have no information about the unfolding, because</span><span>
</span><a name="line-1334"></a><span>                       </span><span class="hs-comment">-- this 'Id' came from an @hi-boot@ file.</span><span>
</span><a name="line-1335"></a><span>                       </span><span class="hs-comment">-- See Note [Inlining and hs-boot files] in ToIface</span><span>
</span><a name="line-1336"></a><span>                       </span><span class="hs-comment">-- for what this is used for.</span><span>
</span><a name="line-1337"></a><span>
</span><a name="line-1338"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="OtherCon"><a href="CoreSyn.html#OtherCon"><span class="hs-identifier">OtherCon</span></a></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ It ain't one of these constructors.</span><span>
</span><a name="line-1339"></a><span>                       </span><span class="hs-comment">-- @OtherCon xs@ also indicates that something has been evaluated</span><span>
</span><a name="line-1340"></a><span>                       </span><span class="hs-comment">-- and hence there's no point in re-evaluating it.</span><span>
</span><a name="line-1341"></a><span>                       </span><span class="hs-comment">-- @OtherCon []@ is used even for non-data-type values</span><span>
</span><a name="line-1342"></a><span>                       </span><span class="hs-comment">-- to indicated evaluated-ness.  Notably:</span><span>
</span><a name="line-1343"></a><span>                       </span><span class="hs-comment">--</span><span>
</span><a name="line-1344"></a><span>                       </span><span class="hs-comment">-- &gt; data C = C !(Int -&gt; Int)</span><span>
</span><a name="line-1345"></a><span>                       </span><span class="hs-comment">-- &gt; case x of { C f -&gt; ... }</span><span>
</span><a name="line-1346"></a><span>                       </span><span class="hs-comment">--</span><span>
</span><a name="line-1347"></a><span>                       </span><span class="hs-comment">-- Here, @f@ gets an @OtherCon []@ unfolding.</span><span>
</span><a name="line-1348"></a><span>
</span><a name="line-1349"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="DFunUnfolding"><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier">DFunUnfolding</span></a></a><span> </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- The Unfolding of a DFunId</span><span>
</span><a name="line-1350"></a><span>                        </span><span class="hs-comment">-- See Note [DFun unfoldings]</span><span>
</span><a name="line-1351"></a><span>                        </span><span class="hs-comment">--     df = /\a1..am. \d1..dn. MkD t1 .. tk</span><span>
</span><a name="line-1352"></a><span>                        </span><span class="hs-comment">--                                 (op1 a1..am d1..dn)</span><span>
</span><a name="line-1353"></a><span>                        </span><span class="hs-comment">--                                 (op2 a1..am d1..dn)</span><span>
</span><a name="line-1354"></a><span>        </span><a name="df_bndrs"><a href="CoreSyn.html#df_bndrs"><span class="hs-identifier">df_bndrs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>      </span><span class="hs-comment">-- The bound variables [a1..m],[d1..dn]</span><span>
</span><a name="line-1355"></a><span>        </span><a name="df_con"><a href="CoreSyn.html#df_con"><span class="hs-identifier">df_con</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span>    </span><span class="hs-comment">-- The dictionary data constructor (never a newtype datacon)</span><span>
</span><a name="line-1356"></a><span>        </span><a name="df_args"><a href="CoreSyn.html#df_args"><span class="hs-identifier">df_args</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- Args of the data con: types, superclasses and methods,</span><span>
</span><a name="line-1357"></a><span>    </span><span class="hs-special">}</span><span>                           </span><span class="hs-comment">-- in positional order</span><span>
</span><a name="line-1358"></a><span>
</span><a name="line-1359"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CoreUnfolding"><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier">CoreUnfolding</span></a></a><span> </span><span class="hs-special">{</span><span>             </span><span class="hs-comment">-- An unfolding for an Id with no pragma,</span><span>
</span><a name="line-1360"></a><span>                                </span><span class="hs-comment">-- or perhaps a NOINLINE pragma</span><span>
</span><a name="line-1361"></a><span>                                </span><span class="hs-comment">-- (For NOINLINE, the phase, if any, is in the</span><span>
</span><a name="line-1362"></a><span>                                </span><span class="hs-comment">-- InlinePragInfo for this Id.)</span><span>
</span><a name="line-1363"></a><span>        </span><a name="uf_tmpl"><a href="CoreSyn.html#uf_tmpl"><span class="hs-identifier">uf_tmpl</span></a></a><span>       </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span>        </span><span class="hs-comment">-- Template; occurrence info is correct</span><span>
</span><a name="line-1364"></a><span>        </span><a name="uf_src"><a href="CoreSyn.html#uf_src"><span class="hs-identifier">uf_src</span></a></a><span>        </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Where the unfolding came from</span><span>
</span><a name="line-1365"></a><span>        </span><a name="uf_is_top"><a href="CoreSyn.html#uf_is_top"><span class="hs-identifier">uf_is_top</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- True &lt;=&gt; top level binding</span><span>
</span><a name="line-1366"></a><span>        </span><a name="uf_is_value"><a href="CoreSyn.html#uf_is_value"><span class="hs-identifier">uf_is_value</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- exprIsHNF template (cached); it is ok to discard</span><span>
</span><a name="line-1367"></a><span>                                        </span><span class="hs-comment">--      a `seq` on this variable</span><span>
</span><a name="line-1368"></a><span>        </span><a name="uf_is_conlike"><a href="CoreSyn.html#uf_is_conlike"><span class="hs-identifier">uf_is_conlike</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- True &lt;=&gt; applicn of constructor or CONLIKE function</span><span>
</span><a name="line-1369"></a><span>                                        </span><span class="hs-comment">--      Cached version of exprIsConLike</span><span>
</span><a name="line-1370"></a><span>        </span><a name="uf_is_work_free"><a href="CoreSyn.html#uf_is_work_free"><span class="hs-identifier">uf_is_work_free</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>                </span><span class="hs-comment">-- True &lt;=&gt; doesn't waste (much) work to expand</span><span>
</span><a name="line-1371"></a><span>                                        </span><span class="hs-comment">--          inside an inlining</span><span>
</span><a name="line-1372"></a><span>                                        </span><span class="hs-comment">--      Cached version of exprIsCheap</span><span>
</span><a name="line-1373"></a><span>        </span><a name="uf_expandable"><a href="CoreSyn.html#uf_expandable"><span class="hs-identifier">uf_expandable</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>          </span><span class="hs-comment">-- True &lt;=&gt; can expand in RULE matching</span><span>
</span><a name="line-1374"></a><span>                                        </span><span class="hs-comment">--      Cached version of exprIsExpandable</span><span>
</span><a name="line-1375"></a><span>        </span><a name="uf_guidance"><a href="CoreSyn.html#uf_guidance"><span class="hs-identifier">uf_guidance</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#UnfoldingGuidance"><span class="hs-identifier hs-type">UnfoldingGuidance</span></a><span>      </span><span class="hs-comment">-- Tells about the *size* of the template.</span><span>
</span><a name="line-1376"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1377"></a><span>  </span><span class="hs-comment">-- ^ An unfolding with redundant cached information. Parameters:</span><span>
</span><a name="line-1378"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1379"></a><span>  </span><span class="hs-comment">--  uf_tmpl: Template used to perform unfolding;</span><span>
</span><a name="line-1380"></a><span>  </span><span class="hs-comment">--           NB: Occurrence info is guaranteed correct:</span><span>
</span><a name="line-1381"></a><span>  </span><span class="hs-comment">--               see Note [OccInfo in unfoldings and rules]</span><span>
</span><a name="line-1382"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1383"></a><span>  </span><span class="hs-comment">--  uf_is_top: Is this a top level binding?</span><span>
</span><a name="line-1384"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1385"></a><span>  </span><span class="hs-comment">--  uf_is_value: 'exprIsHNF' template (cached); it is ok to discard a 'seq' on</span><span>
</span><a name="line-1386"></a><span>  </span><span class="hs-comment">--     this variable</span><span>
</span><a name="line-1387"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1388"></a><span>  </span><span class="hs-comment">--  uf_is_work_free:  Does this waste only a little work if we expand it inside an inlining?</span><span>
</span><a name="line-1389"></a><span>  </span><span class="hs-comment">--     Basically this is a cached version of 'exprIsWorkFree'</span><span>
</span><a name="line-1390"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1391"></a><span>  </span><span class="hs-comment">--  uf_guidance:  Tells us about the /size/ of the unfolding template</span><span>
</span><a name="line-1392"></a><span>
</span><a name="line-1393"></a><span>
</span><a name="line-1394"></a><span class="hs-comment">------------------------------------------------</span><span>
</span><a name="line-1395"></a><span class="hs-keyword">data</span><span> </span><a name="UnfoldingSource"><a href="CoreSyn.html#UnfoldingSource"><span class="hs-identifier">UnfoldingSource</span></a></a><span>
</span><a name="line-1396"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- See also Note [Historical note: unfoldings for wrappers]</span><span>
</span><a name="line-1397"></a><span>
</span><a name="line-1398"></a><span>    </span><a name="InlineRhs"><a href="CoreSyn.html#InlineRhs"><span class="hs-identifier">InlineRhs</span></a></a><span>          </span><span class="hs-comment">-- The current rhs of the function</span><span>
</span><a name="line-1399"></a><span>                       </span><span class="hs-comment">-- Replace uf_tmpl each time around</span><span>
</span><a name="line-1400"></a><span>
</span><a name="line-1401"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InlineStable"><a href="CoreSyn.html#InlineStable"><span class="hs-identifier">InlineStable</span></a></a><span>       </span><span class="hs-comment">-- From an INLINE or INLINABLE pragma</span><span>
</span><a name="line-1402"></a><span>                       </span><span class="hs-comment">--   INLINE     if guidance is UnfWhen</span><span>
</span><a name="line-1403"></a><span>                       </span><span class="hs-comment">--   INLINABLE  if guidance is UnfIfGoodArgs/UnfoldNever</span><span>
</span><a name="line-1404"></a><span>                       </span><span class="hs-comment">-- (well, technically an INLINABLE might be made</span><span>
</span><a name="line-1405"></a><span>                       </span><span class="hs-comment">-- UnfWhen if it was small enough, and then</span><span>
</span><a name="line-1406"></a><span>                       </span><span class="hs-comment">-- it will behave like INLINE outside the current</span><span>
</span><a name="line-1407"></a><span>                       </span><span class="hs-comment">-- module, but that is the way automatic unfoldings</span><span>
</span><a name="line-1408"></a><span>                       </span><span class="hs-comment">-- work so it is consistent with the intended</span><span>
</span><a name="line-1409"></a><span>                       </span><span class="hs-comment">-- meaning of INLINABLE).</span><span>
</span><a name="line-1410"></a><span>                       </span><span class="hs-comment">--</span><span>
</span><a name="line-1411"></a><span>                       </span><span class="hs-comment">-- uf_tmpl may change, but only as a result of</span><span>
</span><a name="line-1412"></a><span>                       </span><span class="hs-comment">-- gentle simplification, it doesn't get updated</span><span>
</span><a name="line-1413"></a><span>                       </span><span class="hs-comment">-- to the current RHS during compilation as with</span><span>
</span><a name="line-1414"></a><span>                       </span><span class="hs-comment">-- InlineRhs.</span><span>
</span><a name="line-1415"></a><span>                       </span><span class="hs-comment">--</span><span>
</span><a name="line-1416"></a><span>                       </span><span class="hs-comment">-- See Note [InlineStable]</span><span>
</span><a name="line-1417"></a><span>
</span><a name="line-1418"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="InlineCompulsory"><a href="CoreSyn.html#InlineCompulsory"><span class="hs-identifier">InlineCompulsory</span></a></a><span>   </span><span class="hs-comment">-- Something that *has* no binding, so you *must* inline it</span><span>
</span><a name="line-1419"></a><span>                       </span><span class="hs-comment">-- Only a few primop-like things have this property</span><span>
</span><a name="line-1420"></a><span>                       </span><span class="hs-comment">-- (see MkId.hs, calls to mkCompulsoryUnfolding).</span><span>
</span><a name="line-1421"></a><span>                       </span><span class="hs-comment">-- Inline absolutely always, however boring the context.</span><span>
</span><a name="line-1422"></a><span>
</span><a name="line-1423"></a><span>
</span><a name="line-1424"></a><span>
</span><a name="line-1425"></a><span class="hs-comment">-- | 'UnfoldingGuidance' says when unfolding should take place</span><span>
</span><a name="line-1426"></a><span class="hs-keyword">data</span><span> </span><a name="UnfoldingGuidance"><a href="CoreSyn.html#UnfoldingGuidance"><span class="hs-identifier">UnfoldingGuidance</span></a></a><span>
</span><a name="line-1427"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="UnfWhen"><a href="CoreSyn.html#UnfWhen"><span class="hs-identifier">UnfWhen</span></a></a><span> </span><span class="hs-special">{</span><span>   </span><span class="hs-comment">-- Inline without thinking about the *size* of the uf_tmpl</span><span>
</span><a name="line-1428"></a><span>                </span><span class="hs-comment">-- Used (a) for small *and* cheap unfoldings</span><span>
</span><a name="line-1429"></a><span>                </span><span class="hs-comment">--      (b) for INLINE functions</span><span>
</span><a name="line-1430"></a><span>                </span><span class="hs-comment">-- See Note [INLINE for small functions] in CoreUnfold</span><span>
</span><a name="line-1431"></a><span>      </span><a name="ug_arity"><a href="CoreSyn.html#ug_arity"><span class="hs-identifier">ug_arity</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#Arity"><span class="hs-identifier hs-type">Arity</span></a><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- Number of value arguments expected</span><span>
</span><a name="line-1432"></a><span>
</span><a name="line-1433"></a><span>      </span><a name="ug_unsat_ok"><a href="CoreSyn.html#ug_unsat_ok"><span class="hs-identifier">ug_unsat_ok</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- True &lt;=&gt; ok to inline even if unsaturated</span><span>
</span><a name="line-1434"></a><span>      </span><a name="ug_boring_ok"><a href="CoreSyn.html#ug_boring_ok"><span class="hs-identifier">ug_boring_ok</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>      </span><span class="hs-comment">-- True &lt;=&gt; ok to inline even if the context is boring</span><span>
</span><a name="line-1435"></a><span>                </span><span class="hs-comment">-- So True,True means &quot;always&quot;</span><span>
</span><a name="line-1436"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1437"></a><span>
</span><a name="line-1438"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UnfIfGoodArgs"><a href="CoreSyn.html#UnfIfGoodArgs"><span class="hs-identifier">UnfIfGoodArgs</span></a></a><span> </span><span class="hs-special">{</span><span>     </span><span class="hs-comment">-- Arose from a normal Id; the info here is the</span><span>
</span><a name="line-1439"></a><span>                        </span><span class="hs-comment">-- result of a simple analysis of the RHS</span><span>
</span><a name="line-1440"></a><span>
</span><a name="line-1441"></a><span>      </span><a name="ug_args"><a href="CoreSyn.html#ug_args"><span class="hs-identifier">ug_args</span></a></a><span> </span><span class="hs-glyph">::</span><span>  </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- Discount if the argument is evaluated.</span><span>
</span><a name="line-1442"></a><span>                          </span><span class="hs-comment">-- (i.e., a simplification will definitely</span><span>
</span><a name="line-1443"></a><span>                          </span><span class="hs-comment">-- be possible).  One elt of the list per *value* arg.</span><span>
</span><a name="line-1444"></a><span>
</span><a name="line-1445"></a><span>      </span><a name="ug_size"><a href="CoreSyn.html#ug_size"><span class="hs-identifier">ug_size</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span>     </span><span class="hs-comment">-- The &quot;size&quot; of the unfolding.</span><span>
</span><a name="line-1446"></a><span>
</span><a name="line-1447"></a><span>      </span><a name="ug_res"><a href="CoreSyn.html#ug_res"><span class="hs-identifier">ug_res</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>       </span><span class="hs-comment">-- Scrutinee discount: the discount to substract if the thing is in</span><span>
</span><a name="line-1448"></a><span>    </span><span class="hs-special">}</span><span>                     </span><span class="hs-comment">-- a context (case (thing args) of ...),</span><span>
</span><a name="line-1449"></a><span>                          </span><span class="hs-comment">-- (where there are the right number of arguments.)</span><span>
</span><a name="line-1450"></a><span>
</span><a name="line-1451"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="UnfNever"><a href="CoreSyn.html#UnfNever"><span class="hs-identifier">UnfNever</span></a></a><span>        </span><span class="hs-comment">-- The RHS is big, so don't inline it</span><span>
</span><a name="line-1452"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-1453"></a><span>
</span><a name="line-1454"></a><span class="hs-comment">{-
Note [Historical note: unfoldings for wrappers]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We used to have a nice clever scheme in interface files for
wrappers. A wrapper's unfolding can be reconstructed from its worker's
id and its strictness. This decreased .hi file size (sometimes
significantly, for modules like GHC.Classes with many high-arity w/w
splits) and had a slight corresponding effect on compile times.

However, when we added the second demand analysis, this scheme lead to
some Core lint errors. The second analysis could change the strictness
signatures, which sometimes resulted in a wrapper's regenerated
unfolding applying the wrapper to too many arguments.

Instead of repairing the clever .hi scheme, we abandoned it in favor
of simplicity. The .hi sizes are usually insignificant (excluding the
+1M for base libraries), and compile time barely increases (~+1% for
nofib). The nicer upshot is that the UnfoldingSource no longer mentions
an Id, so, eg, substitutions need not traverse them.


Note [DFun unfoldings]
~~~~~~~~~~~~~~~~~~~~~~
The Arity in a DFunUnfolding is total number of args (type and value)
that the DFun needs to produce a dictionary.  That's not necessarily
related to the ordinary arity of the dfun Id, esp if the class has
one method, so the dictionary is represented by a newtype.  Example

     class C a where { op :: a -&gt; Int }
     instance C a -&gt; C [a] where op xs = op (head xs)

The instance translates to

     $dfCList :: forall a. C a =&gt; C [a]  -- Arity 2!
     $dfCList = /\a.\d. $copList {a} d |&gt; co

     $copList :: forall a. C a =&gt; [a] -&gt; Int  -- Arity 2!
     $copList = /\a.\d.\xs. op {a} d (head xs)

Now we might encounter (op (dfCList {ty} d) a1 a2)
and we want the (op (dfList {ty} d)) rule to fire, because $dfCList
has all its arguments, even though its (value) arity is 2.  That's
why we record the number of expected arguments in the DFunUnfolding.

Note that although it's an Arity, it's most convenient for it to give
the *total* number of arguments, both type and value.  See the use
site in exprIsConApp_maybe.
-}</span><span>
</span><a name="line-1502"></a><span>
</span><a name="line-1503"></a><span class="hs-comment">-- Constants for the UnfWhen constructor</span><span>
</span><a name="line-1504"></a><span class="hs-identifier">needSaturated</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">unSaturatedOk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1505"></a><a name="needSaturated"><a href="CoreSyn.html#needSaturated"><span class="hs-identifier">needSaturated</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1506"></a><a name="unSaturatedOk"><a href="CoreSyn.html#unSaturatedOk"><span class="hs-identifier">unSaturatedOk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1507"></a><span>
</span><a name="line-1508"></a><span class="hs-identifier">boringCxtNotOk</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">boringCxtOk</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1509"></a><a name="boringCxtOk"><a href="CoreSyn.html#boringCxtOk"><span class="hs-identifier">boringCxtOk</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1510"></a><a name="boringCxtNotOk"><a href="CoreSyn.html#boringCxtNotOk"><span class="hs-identifier">boringCxtNotOk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1511"></a><span>
</span><a name="line-1512"></a><span class="hs-comment">------------------------------------------------</span><span>
</span><a name="line-1513"></a><span class="hs-identifier">noUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-1514"></a><span class="hs-comment">-- ^ There is no known 'Unfolding'</span><span>
</span><a name="line-1515"></a><span class="hs-identifier">evaldUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-1516"></a><span class="hs-comment">-- ^ This unfolding marks the associated thing as being evaluated</span><span>
</span><a name="line-1517"></a><span>
</span><a name="line-1518"></a><a name="noUnfolding"><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier">noUnfolding</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>
</span><a name="line-1519"></a><a name="evaldUnfolding"><a href="CoreSyn.html#evaldUnfolding"><span class="hs-identifier">evaldUnfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1520"></a><span>
</span><a name="line-1521"></a><span class="hs-comment">-- | There is no known 'Unfolding', because this came from an</span><span>
</span><a name="line-1522"></a><span class="hs-comment">-- hi-boot file.</span><span>
</span><a name="line-1523"></a><span class="hs-identifier">bootUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-1524"></a><a name="bootUnfolding"><a href="CoreSyn.html#bootUnfolding"><span class="hs-identifier">bootUnfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#BootUnfolding"><span class="hs-identifier hs-var">BootUnfolding</span></a><span>
</span><a name="line-1525"></a><span>
</span><a name="line-1526"></a><span class="hs-identifier">mkOtherCon</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-1527"></a><a name="mkOtherCon"><a href="CoreSyn.html#mkOtherCon"><span class="hs-identifier">mkOtherCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span>
</span><a name="line-1528"></a><span>
</span><a name="line-1529"></a><span class="hs-identifier">isStableSource</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#UnfoldingSource"><span class="hs-identifier hs-type">UnfoldingSource</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1530"></a><span class="hs-comment">-- Keep the unfolding template</span><span>
</span><a name="line-1531"></a><a name="isStableSource"><a href="CoreSyn.html#isStableSource"><span class="hs-identifier">isStableSource</span></a></a><span> </span><a href="CoreSyn.html#InlineCompulsory"><span class="hs-identifier hs-var">InlineCompulsory</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1532"></a><span class="hs-identifier">isStableSource</span><span> </span><a href="CoreSyn.html#InlineStable"><span class="hs-identifier hs-var">InlineStable</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1533"></a><span class="hs-identifier">isStableSource</span><span> </span><a href="CoreSyn.html#InlineRhs"><span class="hs-identifier hs-var">InlineRhs</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1534"></a><span>
</span><a name="line-1535"></a><span class="hs-comment">-- | Retrieves the template of an unfolding: panics if none is known</span><span>
</span><a name="line-1536"></a><span class="hs-identifier">unfoldingTemplate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1537"></a><a name="unfoldingTemplate"><a href="CoreSyn.html#unfoldingTemplate"><span class="hs-identifier">unfoldingTemplate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uf_tmpl</span><span>
</span><a name="line-1538"></a><span>
</span><a name="line-1539"></a><span class="hs-comment">-- | Retrieves the template of an unfolding if possible</span><span>
</span><a name="line-1540"></a><span class="hs-comment">-- maybeUnfoldingTemplate is used mainly wnen specialising, and we do</span><span>
</span><a name="line-1541"></a><span class="hs-comment">-- want to specialise DFuns, so it's important to return a template</span><span>
</span><a name="line-1542"></a><span class="hs-comment">-- for DFunUnfoldings</span><span>
</span><a name="line-1543"></a><span class="hs-identifier">maybeUnfoldingTemplate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1544"></a><a name="maybeUnfoldingTemplate"><a href="CoreSyn.html#maybeUnfoldingTemplate"><span class="hs-identifier">maybeUnfoldingTemplate</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264335"><a href="#local-6989586621682264335"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1545"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682264335"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-1546"></a><span class="hs-identifier">maybeUnfoldingTemplate</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264336"><a href="#local-6989586621682264336"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264337"><a href="#local-6989586621682264337"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264338"><a href="#local-6989586621682264338"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-1547"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621682264336"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a><span> </span><a href="#local-6989586621682264337"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264338"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1548"></a><span class="hs-identifier">maybeUnfoldingTemplate</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1549"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1550"></a><span>
</span><a name="line-1551"></a><span class="hs-comment">-- | The constructors that the unfolding could never be:</span><span>
</span><a name="line-1552"></a><span class="hs-comment">-- returns @[]@ if no information is available</span><span>
</span><a name="line-1553"></a><span class="hs-identifier">otherCons</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">]</span><span>
</span><a name="line-1554"></a><a name="otherCons"><a href="CoreSyn.html#otherCons"><span class="hs-identifier">otherCons</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><a name="local-6989586621682264339"><a href="#local-6989586621682264339"><span class="hs-identifier">cons</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264339"><span class="hs-identifier hs-var">cons</span></a><span>
</span><a name="line-1555"></a><span class="hs-identifier">otherCons</span><span> </span><span class="hs-identifier">_</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1556"></a><span>
</span><a name="line-1557"></a><span class="hs-comment">-- | Determines if it is certainly the case that the unfolding will</span><span>
</span><a name="line-1558"></a><span class="hs-comment">-- yield a value (something in HNF): returns @False@ if unsure</span><span>
</span><a name="line-1559"></a><span class="hs-identifier">isValueUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1560"></a><span>        </span><span class="hs-comment">-- Returns False for OtherCon</span><span>
</span><a name="line-1561"></a><a name="isValueUnfolding"><a href="CoreSyn.html#isValueUnfolding"><span class="hs-identifier">isValueUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_is_value</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264340"><a href="#local-6989586621682264340"><span class="hs-identifier">is_evald</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264340"><span class="hs-identifier hs-var">is_evald</span></a><span>
</span><a name="line-1562"></a><span class="hs-identifier">isValueUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1563"></a><span>
</span><a name="line-1564"></a><span class="hs-comment">-- | Determines if it possibly the case that the unfolding will</span><span>
</span><a name="line-1565"></a><span class="hs-comment">-- yield a value. Unlike 'isValueUnfolding' it returns @True@</span><span>
</span><a name="line-1566"></a><span class="hs-comment">-- for 'OtherCon'</span><span>
</span><a name="line-1567"></a><span class="hs-identifier">isEvaldUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1568"></a><span>        </span><span class="hs-comment">-- Returns True for OtherCon</span><span>
</span><a name="line-1569"></a><a name="isEvaldUnfolding"><a href="CoreSyn.html#isEvaldUnfolding"><span class="hs-identifier">isEvaldUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1570"></a><span class="hs-identifier">isEvaldUnfolding</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_is_value</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264341"><a href="#local-6989586621682264341"><span class="hs-identifier">is_evald</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264341"><span class="hs-identifier hs-var">is_evald</span></a><span>
</span><a name="line-1571"></a><span class="hs-identifier">isEvaldUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1572"></a><span>
</span><a name="line-1573"></a><span class="hs-comment">-- | @True@ if the unfolding is a constructor application, the application</span><span>
</span><a name="line-1574"></a><span class="hs-comment">-- of a CONLIKE function or 'OtherCon'</span><span>
</span><a name="line-1575"></a><span class="hs-identifier">isConLikeUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1576"></a><a name="isConLikeUnfolding"><a href="CoreSyn.html#isConLikeUnfolding"><span class="hs-identifier">isConLikeUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#OtherCon"><span class="hs-identifier hs-var">OtherCon</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1577"></a><span class="hs-identifier">isConLikeUnfolding</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_is_conlike</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264342"><a href="#local-6989586621682264342"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264342"><span class="hs-identifier hs-var">con</span></a><span>
</span><a name="line-1578"></a><span class="hs-identifier">isConLikeUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span class="hs-comment">-- | Is the thing we will unfold into certainly cheap?</span><span>
</span><a name="line-1581"></a><span class="hs-identifier">isCheapUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1582"></a><a name="isCheapUnfolding"><a href="CoreSyn.html#isCheapUnfolding"><span class="hs-identifier">isCheapUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_is_work_free</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264343"><a href="#local-6989586621682264343"><span class="hs-identifier">is_wf</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264343"><span class="hs-identifier hs-var">is_wf</span></a><span>
</span><a name="line-1583"></a><span class="hs-identifier">isCheapUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1584"></a><span>
</span><a name="line-1585"></a><span class="hs-identifier">isExpandableUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1586"></a><a name="isExpandableUnfolding"><a href="CoreSyn.html#isExpandableUnfolding"><span class="hs-identifier">isExpandableUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_expandable</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264344"><a href="#local-6989586621682264344"><span class="hs-identifier">is_expable</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264344"><span class="hs-identifier hs-var">is_expable</span></a><span>
</span><a name="line-1587"></a><span class="hs-identifier">isExpandableUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1588"></a><span>
</span><a name="line-1589"></a><span class="hs-identifier">expandUnfolding_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1590"></a><span class="hs-comment">-- Expand an expandable unfolding; this is used in rule matching</span><span>
</span><a name="line-1591"></a><span class="hs-comment">--   See Note [Expanding variables] in Rules.hs</span><span>
</span><a name="line-1592"></a><span class="hs-comment">-- The key point here is that CONLIKE things can be expanded</span><span>
</span><a name="line-1593"></a><a name="expandUnfolding_maybe"><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier">expandUnfolding_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_expandable</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264345"><a href="#local-6989586621682264345"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682264345"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1594"></a><span class="hs-identifier">expandUnfolding_maybe</span><span> </span><span class="hs-identifier">_</span><span>                                                       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1595"></a><span>
</span><a name="line-1596"></a><span class="hs-identifier">isCompulsoryUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1597"></a><a name="isCompulsoryUnfolding"><a href="CoreSyn.html#isCompulsoryUnfolding"><span class="hs-identifier">isCompulsoryUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#InlineCompulsory"><span class="hs-identifier hs-var">InlineCompulsory</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1598"></a><span class="hs-identifier">isCompulsoryUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1599"></a><span>
</span><a name="line-1600"></a><span class="hs-identifier">isStableUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1601"></a><span class="hs-comment">-- True of unfoldings that should not be overwritten</span><span>
</span><a name="line-1602"></a><span class="hs-comment">-- by a CoreUnfolding for the RHS of a let-binding</span><span>
</span><a name="line-1603"></a><a name="isStableUnfolding"><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier">isStableUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264346"><a href="#local-6989586621682264346"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621682264346"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-1604"></a><span class="hs-identifier">isStableUnfolding</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1605"></a><span class="hs-identifier">isStableUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1606"></a><span>
</span><a name="line-1607"></a><span class="hs-comment">-- | Only returns False if there is no unfolding information available at all</span><span>
</span><a name="line-1608"></a><span class="hs-identifier">hasSomeUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1609"></a><a name="hasSomeUnfolding"><a href="CoreSyn.html#hasSomeUnfolding"><span class="hs-identifier">hasSomeUnfolding</span></a></a><span> </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1610"></a><span class="hs-identifier">hasSomeUnfolding</span><span> </span><a href="CoreSyn.html#BootUnfolding"><span class="hs-identifier hs-var">BootUnfolding</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1611"></a><span class="hs-identifier">hasSomeUnfolding</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1612"></a><span>
</span><a name="line-1613"></a><span class="hs-identifier">isBootUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1614"></a><a name="isBootUnfolding"><a href="CoreSyn.html#isBootUnfolding"><span class="hs-identifier">isBootUnfolding</span></a></a><span> </span><a href="CoreSyn.html#BootUnfolding"><span class="hs-identifier hs-var">BootUnfolding</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1615"></a><span class="hs-identifier">isBootUnfolding</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1616"></a><span>
</span><a name="line-1617"></a><span class="hs-identifier">neverUnfoldGuidance</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#UnfoldingGuidance"><span class="hs-identifier hs-type">UnfoldingGuidance</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1618"></a><a name="neverUnfoldGuidance"><a href="CoreSyn.html#neverUnfoldGuidance"><span class="hs-identifier">neverUnfoldGuidance</span></a></a><span> </span><a href="CoreSyn.html#UnfNever"><span class="hs-identifier hs-var">UnfNever</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1619"></a><span class="hs-identifier">neverUnfoldGuidance</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1620"></a><span>
</span><a name="line-1621"></a><span class="hs-identifier">isFragileUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1622"></a><span class="hs-comment">-- An unfolding is fragile if it mentions free variables or</span><span>
</span><a name="line-1623"></a><span class="hs-comment">-- is otherwise subject to change.  A robust one can be kept.</span><span>
</span><a name="line-1624"></a><span class="hs-comment">-- See Note [Fragile unfoldings]</span><span>
</span><a name="line-1625"></a><a name="isFragileUnfolding"><a href="CoreSyn.html#isFragileUnfolding"><span class="hs-identifier">isFragileUnfolding</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1626"></a><span class="hs-identifier">isFragileUnfolding</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-1627"></a><span class="hs-identifier">isFragileUnfolding</span><span> </span><span class="hs-identifier">_</span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1628"></a><span>  </span><span class="hs-comment">-- NoUnfolding, BootUnfolding, OtherCon are all non-fragile</span><span>
</span><a name="line-1629"></a><span>
</span><a name="line-1630"></a><span class="hs-identifier">canUnfold</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1631"></a><a name="canUnfold"><a href="CoreSyn.html#canUnfold"><span class="hs-identifier">canUnfold</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_guidance</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621682264347"><a href="#local-6989586621682264347"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#neverUnfoldGuidance"><span class="hs-identifier hs-var">neverUnfoldGuidance</span></a><span> </span><a href="#local-6989586621682264347"><span class="hs-identifier hs-var">g</span></a><span class="hs-special">)</span><span>
</span><a name="line-1632"></a><span class="hs-identifier">canUnfold</span><span> </span><span class="hs-identifier">_</span><span>                                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1633"></a><span>
</span><a name="line-1634"></a><span class="hs-comment">{- Note [Fragile unfoldings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~
An unfolding is &quot;fragile&quot; if it mentions free variables (and hence would
need substitution) or might be affected by optimisation.  The non-fragile
ones are

   NoUnfolding, BootUnfolding

   OtherCon {}    If we know this binder (say a lambda binder) will be
                  bound to an evaluated thing, we want to retain that
                  info in simpleOptExpr; see Trac #13077.

We consider even a StableUnfolding as fragile, because it needs substitution.

Note [InlineStable]
~~~~~~~~~~~~~~~~~
When you say
      {-# INLINE f #-}
      f x = &lt;rhs&gt;
you intend that calls (f e) are replaced by &lt;rhs&gt;[e/x] So we
should capture (\x.&lt;rhs&gt;) in the Unfolding of 'f', and never meddle
with it.  Meanwhile, we can optimise &lt;rhs&gt; to our heart's content,
leaving the original unfolding intact in Unfolding of 'f'. For example
        all xs = foldr (&amp;&amp;) True xs
        any p = all . map p  {-# INLINE any #-}
We optimise any's RHS fully, but leave the InlineRule saying &quot;all . map p&quot;,
which deforests well at the call site.

So INLINE pragma gives rise to an InlineRule, which captures the original RHS.

Moreover, it's only used when 'f' is applied to the
specified number of arguments; that is, the number of argument on
the LHS of the '=' sign in the original source definition.
For example, (.) is now defined in the libraries like this
   {-# INLINE (.) #-}
   (.) f g = \x -&gt; f (g x)
so that it'll inline when applied to two arguments. If 'x' appeared
on the left, thus
   (.) f g x = f (g x)
it'd only inline when applied to three arguments.  This slightly-experimental
change was requested by Roman, but it seems to make sense.

See also Note [Inlining an InlineRule] in CoreUnfold.


Note [OccInfo in unfoldings and rules]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In unfoldings and rules, we guarantee that the template is occ-analysed,
so that the occurrence info on the binders is correct.  This is important,
because the Simplifier does not re-analyse the template when using it. If
the occurrence info is wrong
  - We may get more simplifier iterations than necessary, because
    once-occ info isn't there
  - More seriously, we may get an infinite loop if there's a Rec
    without a loop breaker marked


************************************************************************
*                                                                      *
                  AltCon
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1697"></a><span>
</span><a name="line-1698"></a><span class="hs-comment">-- The Ord is needed for the FiniteMap used in the lookForConstructor</span><span>
</span><a name="line-1699"></a><span class="hs-comment">-- in SimplEnv.  If you declared that lookForConstructor *ignores*</span><span>
</span><a name="line-1700"></a><span class="hs-comment">-- constructor-applications with LitArg args, then you could get</span><span>
</span><a name="line-1701"></a><span class="hs-comment">-- rid of this Ord.</span><span>
</span><a name="line-1702"></a><span>
</span><a name="line-1703"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1704"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621682264220"><a href="#local-6989586621682264220"><span class="hs-identifier">dc</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682264220"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1705"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><a name="local-6989586621682264221"><a href="#local-6989586621682264221"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682264221"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-1706"></a><span>  </span><span class="hs-identifier">ppr</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;__DEFAULT&quot;</span><span>
</span><a name="line-1707"></a><span>
</span><a name="line-1708"></a><span class="hs-identifier">cmpAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264294"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264295"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264294"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264295"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-1709"></a><a name="cmpAlt"><a href="CoreSyn.html#cmpAlt"><span class="hs-identifier">cmpAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682264348"><a href="#local-6989586621682264348"><span class="hs-identifier">con1</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682264349"><a href="#local-6989586621682264349"><span class="hs-identifier">con2</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264348"><span class="hs-identifier hs-var">con1</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#cmpAltCon"><span class="hs-identifier hs-var">cmpAltCon</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682264349"><span class="hs-identifier hs-var">con2</span></a><span>
</span><a name="line-1710"></a><span>
</span><a name="line-1711"></a><span class="hs-identifier">ltAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264292"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264293"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264292"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264293"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1712"></a><a name="ltAlt"><a href="CoreSyn.html#ltAlt"><span class="hs-identifier">ltAlt</span></a></a><span> </span><a name="local-6989586621682264350"><a href="#local-6989586621682264350"><span class="hs-identifier">a1</span></a></a><span> </span><a name="local-6989586621682264351"><a href="#local-6989586621682264351"><span class="hs-identifier">a2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264350"><span class="hs-identifier hs-var">a1</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#cmpAlt"><span class="hs-identifier hs-var">cmpAlt</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621682264351"><span class="hs-identifier hs-var">a2</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-1713"></a><span>
</span><a name="line-1714"></a><span class="hs-identifier">cmpAltCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-1715"></a><span class="hs-comment">-- ^ Compares 'AltCon's within a single list of alternatives</span><span>
</span><a name="line-1716"></a><span class="hs-comment">-- DEFAULT comes out smallest, so that sorting by AltCon</span><span>
</span><a name="line-1717"></a><span class="hs-comment">-- puts alternatives in the order required by #case_invariants#</span><span>
</span><a name="line-1718"></a><a name="cmpAltCon"><a href="CoreSyn.html#cmpAltCon"><span class="hs-identifier">cmpAltCon</span></a></a><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>      </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-1719"></a><span class="hs-identifier">cmpAltCon</span><span> </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>      </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-1720"></a><span>
</span><a name="line-1721"></a><span class="hs-identifier">cmpAltCon</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621682264352"><a href="#local-6989586621682264352"><span class="hs-identifier">d1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a name="local-6989586621682264353"><a href="#local-6989586621682264353"><span class="hs-identifier">d2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConTag"><span class="hs-identifier hs-var">dataConTag</span></a><span> </span><a href="#local-6989586621682264352"><span class="hs-identifier hs-var">d1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="DataCon.html#dataConTag"><span class="hs-identifier hs-var">dataConTag</span></a><span> </span><a href="#local-6989586621682264353"><span class="hs-identifier hs-var">d2</span></a><span>
</span><a name="line-1722"></a><span class="hs-identifier">cmpAltCon</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-1723"></a><span class="hs-identifier">cmpAltCon</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span>  </span><a name="local-6989586621682264354"><a href="#local-6989586621682264354"><span class="hs-identifier">l1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span>  </span><a name="local-6989586621682264355"><a href="#local-6989586621682264355"><span class="hs-identifier">l2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264354"><span class="hs-identifier hs-var">l1</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621682264355"><span class="hs-identifier hs-var">l2</span></a><span>
</span><a name="line-1724"></a><span class="hs-identifier">cmpAltCon</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#LitAlt"><span class="hs-identifier hs-var">LitAlt</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-1725"></a><span>
</span><a name="line-1726"></a><span class="hs-identifier">cmpAltCon</span><span> </span><a name="local-6989586621682264356"><a href="#local-6989586621682264356"><span class="hs-identifier">con1</span></a></a><span> </span><a name="local-6989586621682264357"><a href="#local-6989586621682264357"><span class="hs-identifier">con2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;Comparing incomparable AltCons&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span>
</span><a name="line-1727"></a><span>                                  </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">con1</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">con2</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1728"></a><span>                      </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-1729"></a><span>
</span><a name="line-1730"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Useful synonyms}
*                                                                      *
************************************************************************

Note [CoreProgram]
~~~~~~~~~~~~~~~~~~
The top level bindings of a program, a CoreProgram, are represented as
a list of CoreBind

 * Later bindings in the list can refer to earlier ones, but not vice
   versa.  So this is OK
      NonRec { x = 4 }
      Rec { p = ...q...x...
          ; q = ...p...x }
      Rec { f = ...p..x..f.. }
      NonRec { g = ..f..q...x.. }
   But it would NOT be ok for 'f' to refer to 'g'.

 * The occurrence analyser does strongly-connected component analysis
   on each Rec binding, and splits it into a sequence of smaller
   bindings where possible.  So the program typically starts life as a
   single giant Rec, which is then dependency-analysed into smaller
   chunks.
-}</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span class="hs-comment">-- If you edit this type, you may need to update the GHC formalism</span><span>
</span><a name="line-1759"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-1760"></a><span class="hs-keyword">type</span><span> </span><a name="CoreProgram"><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier">CoreProgram</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- See Note [CoreProgram]</span><span>
</span><a name="line-1761"></a><span>
</span><a name="line-1762"></a><span class="hs-comment">-- | The common case for the type of binders and variables when</span><span>
</span><a name="line-1763"></a><span class="hs-comment">-- we are manipulating the Core language within GHC</span><span>
</span><a name="line-1764"></a><span class="hs-keyword">type</span><span> </span><a name="CoreBndr"><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier">CoreBndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>
</span><a name="line-1765"></a><span class="hs-comment">-- | Expressions where binders are 'CoreBndr's</span><span>
</span><a name="line-1766"></a><span class="hs-keyword">type</span><span> </span><a name="CoreExpr"><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier">CoreExpr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-1767"></a><span class="hs-comment">-- | Argument expressions where binders are 'CoreBndr's</span><span>
</span><a name="line-1768"></a><span class="hs-keyword">type</span><span> </span><a name="CoreArg"><a href="CoreSyn.html#CoreArg"><span class="hs-identifier">CoreArg</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span>  </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-1769"></a><span class="hs-comment">-- | Binding groups where binders are 'CoreBndr's</span><span>
</span><a name="line-1770"></a><span class="hs-keyword">type</span><span> </span><a name="CoreBind"><a href="CoreSyn.html#CoreBind"><span class="hs-identifier">CoreBind</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-1771"></a><span class="hs-comment">-- | Case alternatives where binders are 'CoreBndr's</span><span>
</span><a name="line-1772"></a><span class="hs-keyword">type</span><span> </span><a name="CoreAlt"><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier">CoreAlt</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span>  </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Tagging}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1781"></a><span>
</span><a name="line-1782"></a><span class="hs-comment">-- | Binders are /tagged/ with a t</span><span>
</span><a name="line-1783"></a><span class="hs-keyword">data</span><span> </span><a name="TaggedBndr"><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier">TaggedBndr</span></a></a><span> </span><a name="local-6989586621682264211"><a href="#local-6989586621682264211"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TB"><a href="CoreSyn.html#TB"><span class="hs-identifier">TB</span></a></a><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span> </span><a href="#local-6989586621682264211"><span class="hs-identifier hs-type">t</span></a><span>       </span><span class="hs-comment">-- TB for &quot;tagged binder&quot;</span><span>
</span><a name="line-1784"></a><span>
</span><a name="line-1785"></a><span class="hs-keyword">type</span><span> </span><a name="TaggedBind"><a href="CoreSyn.html#TaggedBind"><span class="hs-identifier">TaggedBind</span></a></a><span> </span><a name="local-6989586621682264210"><a href="#local-6989586621682264210"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier hs-type">TaggedBndr</span></a><span> </span><a href="#local-6989586621682264210"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1786"></a><span class="hs-keyword">type</span><span> </span><a name="TaggedExpr"><a href="CoreSyn.html#TaggedExpr"><span class="hs-identifier">TaggedExpr</span></a></a><span> </span><a name="local-6989586621682264209"><a href="#local-6989586621682264209"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier hs-type">TaggedBndr</span></a><span> </span><a href="#local-6989586621682264209"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1787"></a><span class="hs-keyword">type</span><span> </span><a name="TaggedArg"><a href="CoreSyn.html#TaggedArg"><span class="hs-identifier">TaggedArg</span></a></a><span>  </span><a name="local-6989586621682264208"><a href="#local-6989586621682264208"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier hs-type">TaggedBndr</span></a><span> </span><a href="#local-6989586621682264208"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1788"></a><span class="hs-keyword">type</span><span> </span><a name="TaggedAlt"><a href="CoreSyn.html#TaggedAlt"><span class="hs-identifier">TaggedAlt</span></a></a><span>  </span><a name="local-6989586621682264207"><a href="#local-6989586621682264207"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span>  </span><span class="hs-special">(</span><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier hs-type">TaggedBndr</span></a><span> </span><a href="#local-6989586621682264207"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1789"></a><span>
</span><a name="line-1790"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621682264217"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TaggedBndr"><span class="hs-identifier hs-type">TaggedBndr</span></a><span> </span><a href="#local-6989586621682264217"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1791"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TB"><span class="hs-identifier hs-var">TB</span></a><span> </span><a name="local-6989586621682264218"><a href="#local-6989586621682264218"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264219"><a href="#local-6989586621682264219"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'&lt;'</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682264218"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621682264219"><span class="hs-identifier hs-var">l</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'&gt;'</span><span>
</span><a name="line-1792"></a><span>
</span><a name="line-1793"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#TaggedExpr"><span class="hs-identifier hs-type">TaggedExpr</span></a><span> </span><a href="#local-6989586621682264291"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-1794"></a><a name="deTagExpr"><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier">deTagExpr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621682264358"><a href="#local-6989586621682264358"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621682264358"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-1795"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621682264359"><a href="#local-6989586621682264359"><span class="hs-identifier">l</span></a></a><span class="hs-special">)</span><span>                   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621682264359"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-1796"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621682264360"><a href="#local-6989586621682264360"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621682264360"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1797"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621682264361"><a href="#local-6989586621682264361"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621682264361"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1798"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621682264362"><a href="#local-6989586621682264362"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621682264363"><a href="#local-6989586621682264363"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264362"><span class="hs-identifier hs-var">e1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264363"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1799"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TB"><span class="hs-identifier hs-var">TB</span></a><span> </span><a name="local-6989586621682264364"><a href="#local-6989586621682264364"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682264365"><a href="#local-6989586621682264365"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621682264364"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264365"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1800"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621682264366"><a href="#local-6989586621682264366"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621682264367"><a href="#local-6989586621682264367"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagBind"><span class="hs-identifier hs-var">deTagBind</span></a><span> </span><a href="#local-6989586621682264366"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264367"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-1801"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621682264368"><a href="#local-6989586621682264368"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TB"><span class="hs-identifier hs-var">TB</span></a><span> </span><a name="local-6989586621682264369"><a href="#local-6989586621682264369"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682264370"><a href="#local-6989586621682264370"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621682264371"><a href="#local-6989586621682264371"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264368"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264369"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621682264370"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#deTagAlt"><span class="hs-identifier hs-var">deTagAlt</span></a><span> </span><a href="#local-6989586621682264371"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1802"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621682264372"><a href="#local-6989586621682264372"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621682264373"><a href="#local-6989586621682264373"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>                </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621682264372"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264373"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1803"></a><span class="hs-identifier">deTagExpr</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621682264374"><a href="#local-6989586621682264374"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682264375"><a href="#local-6989586621682264375"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>               </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264374"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264375"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1804"></a><span>
</span><a name="line-1805"></a><span class="hs-identifier">deTagBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#TaggedBind"><span class="hs-identifier hs-type">TaggedBind</span></a><span> </span><a href="#local-6989586621682264290"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-1806"></a><a name="deTagBind"><a href="CoreSyn.html#deTagBind"><span class="hs-identifier">deTagBind</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TB"><span class="hs-identifier hs-var">TB</span></a><span> </span><a name="local-6989586621682264376"><a href="#local-6989586621682264376"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682264377"><a href="#local-6989586621682264377"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621682264376"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264377"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1807"></a><span class="hs-identifier">deTagBind</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621682264378"><a href="#local-6989586621682264378"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>             </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682264379"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264380"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#TB"><span class="hs-identifier hs-var">TB</span></a><span> </span><a name="local-6989586621682264379"><a href="#local-6989586621682264379"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682264380"><a href="#local-6989586621682264380"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682264378"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">]</span><span>
</span><a name="line-1808"></a><span>
</span><a name="line-1809"></a><span class="hs-identifier">deTagAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#TaggedAlt"><span class="hs-identifier hs-type">TaggedAlt</span></a><span> </span><a href="#local-6989586621682264289"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-1810"></a><a name="deTagAlt"><a href="CoreSyn.html#deTagAlt"><span class="hs-identifier">deTagAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682264381"><a href="#local-6989586621682264381"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682264382"><a href="#local-6989586621682264382"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682264383"><a href="#local-6989586621682264383"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264381"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264384"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#TB"><span class="hs-identifier hs-var">TB</span></a><span> </span><a name="local-6989586621682264384"><a href="#local-6989586621682264384"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682264382"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#deTagExpr"><span class="hs-identifier hs-var">deTagExpr</span></a><span> </span><a href="#local-6989586621682264383"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1811"></a><span>
</span><a name="line-1812"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Core-constructing functions with checking}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1819"></a><span>
</span><a name="line-1820"></a><span class="hs-comment">-- | Apply a list of argument expressions to a function expression in a nested fashion. Prefer to</span><span>
</span><a name="line-1821"></a><span class="hs-comment">-- use 'MkCore.mkCoreApps' if possible</span><span>
</span><a name="line-1822"></a><span class="hs-identifier">mkApps</span><span>    </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264288"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="#local-6989586621682264288"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264288"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1823"></a><span class="hs-comment">-- | Apply a list of type argument expressions to a function expression in a nested fashion</span><span>
</span><a name="line-1824"></a><span class="hs-identifier">mkTyApps</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264287"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264287"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1825"></a><span class="hs-comment">-- | Apply a list of coercion argument expressions to a function expression in a nested fashion</span><span>
</span><a name="line-1826"></a><span class="hs-identifier">mkCoApps</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264286"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264286"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1827"></a><span class="hs-comment">-- | Apply a list of type or value variables to a function expression in a nested fashion</span><span>
</span><a name="line-1828"></a><span class="hs-identifier">mkVarApps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264285"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264285"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1829"></a><span class="hs-comment">-- | Apply a list of argument expressions to a data constructor in a nested fashion. Prefer to</span><span>
</span><a name="line-1830"></a><span class="hs-comment">-- use 'MkCore.mkCoreConApps' if possible</span><span>
</span><a name="line-1831"></a><span class="hs-identifier">mkConApp</span><span>      </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="#local-6989586621682264284"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264284"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1832"></a><span>
</span><a name="line-1833"></a><a name="mkApps"><a href="CoreSyn.html#mkApps"><span class="hs-identifier">mkApps</span></a></a><span>    </span><a name="local-6989586621682264385"><a href="#local-6989586621682264385"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264386"><a href="#local-6989586621682264386"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span>                       </span><a href="#local-6989586621682264385"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682264386"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1834"></a><a name="mkCoApps"><a href="CoreSyn.html#mkCoApps"><span class="hs-identifier">mkCoApps</span></a></a><span>  </span><a name="local-6989586621682264387"><a href="#local-6989586621682264387"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264388"><a href="#local-6989586621682264388"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682264389"><a href="#local-6989586621682264389"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682264390"><a href="#local-6989586621682264390"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621682264389"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621682264390"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264387"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682264388"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1835"></a><a name="mkVarApps"><a href="CoreSyn.html#mkVarApps"><span class="hs-identifier">mkVarApps</span></a></a><span> </span><a name="local-6989586621682264391"><a href="#local-6989586621682264391"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264392"><a href="#local-6989586621682264392"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682264393"><a href="#local-6989586621682264393"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682264394"><a href="#local-6989586621682264394"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621682264393"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a><span> </span><a href="#local-6989586621682264394"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264391"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682264392"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-1836"></a><a name="mkConApp"><a href="CoreSyn.html#mkConApp"><span class="hs-identifier">mkConApp</span></a></a><span> </span><a name="local-6989586621682264395"><a href="#local-6989586621682264395"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621682264396"><a href="#local-6989586621682264396"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a><span> </span><a href="#local-6989586621682264395"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264396"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1837"></a><span>
</span><a name="line-1838"></a><a name="mkTyApps"><a href="CoreSyn.html#mkTyApps"><span class="hs-identifier">mkTyApps</span></a></a><span>  </span><a name="local-6989586621682264397"><a href="#local-6989586621682264397"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264398"><a href="#local-6989586621682264398"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621682264399"><a href="#local-6989586621682264399"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621682264400"><a href="#local-6989586621682264400"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621682264399"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#mkTyArg"><span class="hs-identifier hs-var">mkTyArg</span></a><span> </span><a href="#local-6989586621682264400"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264397"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621682264398"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-1839"></a><span>
</span><a name="line-1840"></a><span class="hs-identifier">mkConApp2</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264283"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1841"></a><a name="mkConApp2"><a href="CoreSyn.html#mkConApp2"><span class="hs-identifier">mkConApp2</span></a></a><span> </span><a name="local-6989586621682264401"><a href="#local-6989586621682264401"><span class="hs-identifier">con</span></a></a><span> </span><a name="local-6989586621682264402"><a href="#local-6989586621682264402"><span class="hs-identifier">tys</span></a></a><span> </span><a name="local-6989586621682264403"><a href="#local-6989586621682264403"><span class="hs-identifier">arg_ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConWorkId"><span class="hs-identifier hs-var">dataConWorkId</span></a><span> </span><a href="#local-6989586621682264401"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span>
</span><a name="line-1842"></a><span>                            </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621682264402"><span class="hs-identifier hs-var">tys</span></a><span>
</span><a name="line-1843"></a><span>                            </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a><span> </span><a href="#local-6989586621682264403"><span class="hs-identifier hs-var">arg_ids</span></a><span>
</span><a name="line-1844"></a><span>
</span><a name="line-1845"></a><span class="hs-identifier">mkTyArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264282"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1846"></a><a name="mkTyArg"><a href="CoreSyn.html#mkTyArg"><span class="hs-identifier">mkTyArg</span></a></a><span> </span><a name="local-6989586621682264404"><a href="#local-6989586621682264404"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1847"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621682264405"><a href="#local-6989586621682264405"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#isCoercionTy_maybe"><span class="hs-identifier hs-var">isCoercionTy_maybe</span></a><span> </span><a href="#local-6989586621682264404"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621682264405"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1848"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621682264404"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1849"></a><span>
</span><a name="line-1850"></a><span class="hs-comment">-- | Create a machine integer literal expression of type @Int#@ from an @Integer@.</span><span>
</span><a name="line-1851"></a><span class="hs-comment">-- If you want an expression of type @Int@ use 'MkCore.mkIntExpr'</span><span>
</span><a name="line-1852"></a><span class="hs-identifier">mkIntLit</span><span>      </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264281"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1853"></a><span class="hs-comment">-- | Create a machine integer literal expression of type @Int#@ from an @Int@.</span><span>
</span><a name="line-1854"></a><span class="hs-comment">-- If you want an expression of type @Int@ use 'MkCore.mkIntExpr'</span><span>
</span><a name="line-1855"></a><span class="hs-identifier">mkIntLitInt</span><span>   </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264280"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1856"></a><span>
</span><a name="line-1857"></a><a name="mkIntLit"><a href="CoreSyn.html#mkIntLit"><span class="hs-identifier">mkIntLit</span></a></a><span>    </span><a name="local-6989586621682264406"><a href="#local-6989586621682264406"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682264407"><a href="#local-6989586621682264407"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitInt"><span class="hs-identifier hs-var">mkLitInt</span></a><span> </span><a href="#local-6989586621682264406"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682264407"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-1858"></a><a name="mkIntLitInt"><a href="CoreSyn.html#mkIntLitInt"><span class="hs-identifier">mkIntLitInt</span></a></a><span> </span><a name="local-6989586621682264408"><a href="#local-6989586621682264408"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682264409"><a href="#local-6989586621682264409"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitInt"><span class="hs-identifier hs-var">mkLitInt</span></a><span> </span><a href="#local-6989586621682264408"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621682264409"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1859"></a><span>
</span><a name="line-1860"></a><span class="hs-comment">-- | Create a machine word literal expression of type  @Word#@ from an @Integer@.</span><span>
</span><a name="line-1861"></a><span class="hs-comment">-- If you want an expression of type @Word@ use 'MkCore.mkWordExpr'</span><span>
</span><a name="line-1862"></a><span class="hs-identifier">mkWordLit</span><span>     </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Integer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264279"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1863"></a><span class="hs-comment">-- | Create a machine word literal expression of type  @Word#@ from a @Word@.</span><span>
</span><a name="line-1864"></a><span class="hs-comment">-- If you want an expression of type @Word@ use 'MkCore.mkWordExpr'</span><span>
</span><a name="line-1865"></a><span class="hs-identifier">mkWordLitWord</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264278"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1866"></a><span>
</span><a name="line-1867"></a><a name="mkWordLit"><a href="CoreSyn.html#mkWordLit"><span class="hs-identifier">mkWordLit</span></a></a><span>     </span><a name="local-6989586621682264410"><a href="#local-6989586621682264410"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682264411"><a href="#local-6989586621682264411"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitWord"><span class="hs-identifier hs-var">mkLitWord</span></a><span> </span><a href="#local-6989586621682264410"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621682264411"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span>
</span><a name="line-1868"></a><a name="mkWordLitWord"><a href="CoreSyn.html#mkWordLitWord"><span class="hs-identifier">mkWordLitWord</span></a></a><span> </span><a name="local-6989586621682264412"><a href="#local-6989586621682264412"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621682264413"><a href="#local-6989586621682264413"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitWord"><span class="hs-identifier hs-var">mkLitWord</span></a><span> </span><a href="#local-6989586621682264412"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621682264413"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1869"></a><span>
</span><a name="line-1870"></a><span class="hs-identifier">mkWord64LitWord64</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264277"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1871"></a><a name="mkWord64LitWord64"><a href="CoreSyn.html#mkWord64LitWord64"><span class="hs-identifier">mkWord64LitWord64</span></a></a><span> </span><a name="local-6989586621682264414"><a href="#local-6989586621682264414"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitWord64"><span class="hs-identifier hs-var">mkLitWord64</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621682264414"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1872"></a><span>
</span><a name="line-1873"></a><span class="hs-identifier">mkInt64LitInt64</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264276"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1874"></a><a name="mkInt64LitInt64"><a href="CoreSyn.html#mkInt64LitInt64"><span class="hs-identifier">mkInt64LitInt64</span></a></a><span> </span><a name="local-6989586621682264415"><a href="#local-6989586621682264415"><span class="hs-identifier">w</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitInt64"><span class="hs-identifier hs-var">mkLitInt64</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toInteger</span><span> </span><a href="#local-6989586621682264415"><span class="hs-identifier hs-var">w</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1875"></a><span>
</span><a name="line-1876"></a><span class="hs-comment">-- | Create a machine character literal expression of type @Char#@.</span><span>
</span><a name="line-1877"></a><span class="hs-comment">-- If you want an expression of type @Char@ use 'MkCore.mkCharExpr'</span><span>
</span><a name="line-1878"></a><span class="hs-identifier">mkCharLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Char</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264275"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1879"></a><span class="hs-comment">-- | Create a machine string literal expression of type @Addr#@.</span><span>
</span><a name="line-1880"></a><span class="hs-comment">-- If you want an expression of type @String@ use 'MkCore.mkStringExpr'</span><span>
</span><a name="line-1881"></a><span class="hs-identifier">mkStringLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264274"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1882"></a><span>
</span><a name="line-1883"></a><a name="mkCharLit"><a href="CoreSyn.html#mkCharLit"><span class="hs-identifier">mkCharLit</span></a></a><span>   </span><a name="local-6989586621682264416"><a href="#local-6989586621682264416"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitChar"><span class="hs-identifier hs-var">mkLitChar</span></a><span> </span><a href="#local-6989586621682264416"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-1884"></a><a name="mkStringLit"><a href="CoreSyn.html#mkStringLit"><span class="hs-identifier">mkStringLit</span></a></a><span> </span><a name="local-6989586621682264417"><a href="#local-6989586621682264417"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitString"><span class="hs-identifier hs-var">mkLitString</span></a><span> </span><a href="#local-6989586621682264417"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-1885"></a><span>
</span><a name="line-1886"></a><span class="hs-comment">-- | Create a machine single precision literal expression of type @Float#@ from a @Rational@.</span><span>
</span><a name="line-1887"></a><span class="hs-comment">-- If you want an expression of type @Float@ use 'MkCore.mkFloatExpr'</span><span>
</span><a name="line-1888"></a><span class="hs-identifier">mkFloatLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Rational</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264273"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1889"></a><span class="hs-comment">-- | Create a machine single precision literal expression of type @Float#@ from a @Float@.</span><span>
</span><a name="line-1890"></a><span class="hs-comment">-- If you want an expression of type @Float@ use 'MkCore.mkFloatExpr'</span><span>
</span><a name="line-1891"></a><span class="hs-identifier">mkFloatLitFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264272"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1892"></a><span>
</span><a name="line-1893"></a><a name="mkFloatLit"><a href="CoreSyn.html#mkFloatLit"><span class="hs-identifier">mkFloatLit</span></a></a><span>      </span><a name="local-6989586621682264418"><a href="#local-6989586621682264418"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitFloat"><span class="hs-identifier hs-var">mkLitFloat</span></a><span> </span><a href="#local-6989586621682264418"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1894"></a><a name="mkFloatLitFloat"><a href="CoreSyn.html#mkFloatLitFloat"><span class="hs-identifier">mkFloatLitFloat</span></a></a><span> </span><a name="local-6989586621682264419"><a href="#local-6989586621682264419"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitFloat"><span class="hs-identifier hs-var">mkLitFloat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toRational</span><span> </span><a href="#local-6989586621682264419"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1895"></a><span>
</span><a name="line-1896"></a><span class="hs-comment">-- | Create a machine double precision literal expression of type @Double#@ from a @Rational@.</span><span>
</span><a name="line-1897"></a><span class="hs-comment">-- If you want an expression of type @Double@ use 'MkCore.mkDoubleExpr'</span><span>
</span><a name="line-1898"></a><span class="hs-identifier">mkDoubleLit</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Rational</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264271"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1899"></a><span class="hs-comment">-- | Create a machine double precision literal expression of type @Double#@ from a @Double@.</span><span>
</span><a name="line-1900"></a><span class="hs-comment">-- If you want an expression of type @Double@ use 'MkCore.mkDoubleExpr'</span><span>
</span><a name="line-1901"></a><span class="hs-identifier">mkDoubleLitDouble</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264270"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1902"></a><span>
</span><a name="line-1903"></a><a name="mkDoubleLit"><a href="CoreSyn.html#mkDoubleLit"><span class="hs-identifier">mkDoubleLit</span></a></a><span>       </span><a name="local-6989586621682264420"><a href="#local-6989586621682264420"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitDouble"><span class="hs-identifier hs-var">mkLitDouble</span></a><span> </span><a href="#local-6989586621682264420"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span>
</span><a name="line-1904"></a><a name="mkDoubleLitDouble"><a href="CoreSyn.html#mkDoubleLitDouble"><span class="hs-identifier">mkDoubleLitDouble</span></a></a><span> </span><a name="local-6989586621682264421"><a href="#local-6989586621682264421"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#mkLitDouble"><span class="hs-identifier hs-var">mkLitDouble</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toRational</span><span> </span><a href="#local-6989586621682264421"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1905"></a><span>
</span><a name="line-1906"></a><span class="hs-comment">-- | Bind all supplied binding groups over an expression in a nested let expression. Assumes</span><span>
</span><a name="line-1907"></a><span class="hs-comment">-- that the rhs satisfies the let/app invariant.  Prefer to use 'MkCore.mkCoreLets' if</span><span>
</span><a name="line-1908"></a><span class="hs-comment">-- possible, which does guarantee the invariant</span><span>
</span><a name="line-1909"></a><span class="hs-identifier">mkLets</span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264269"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264269"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264269"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1910"></a><span class="hs-comment">-- | Bind all supplied binders over an expression in a nested lambda expression. Prefer to</span><span>
</span><a name="line-1911"></a><span class="hs-comment">-- use 'MkCore.mkCoreLams' if possible</span><span>
</span><a name="line-1912"></a><span class="hs-identifier">mkLams</span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264268"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264268"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264268"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1913"></a><span>
</span><a name="line-1914"></a><a name="mkLams"><a href="CoreSyn.html#mkLams"><span class="hs-identifier">mkLams</span></a></a><span> </span><a name="local-6989586621682264422"><a href="#local-6989586621682264422"><span class="hs-identifier">binders</span></a></a><span> </span><a name="local-6989586621682264423"><a href="#local-6989586621682264423"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621682264423"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682264422"><span class="hs-identifier hs-var">binders</span></a><span>
</span><a name="line-1915"></a><a name="mkLets"><a href="CoreSyn.html#mkLets"><span class="hs-identifier">mkLets</span></a></a><span> </span><a name="local-6989586621682264424"><a href="#local-6989586621682264424"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621682264425"><a href="#local-6989586621682264425"><span class="hs-identifier">body</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="CoreSyn.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a><span> </span><a href="#local-6989586621682264425"><span class="hs-identifier hs-var">body</span></a><span> </span><a href="#local-6989586621682264424"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1916"></a><span>
</span><a name="line-1917"></a><span class="hs-identifier">mkLet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264267"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264267"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264267"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1918"></a><span class="hs-comment">-- The desugarer sometimes generates an empty Rec group</span><span>
</span><a name="line-1919"></a><span class="hs-comment">-- which Lint rejects, so we kill it off right away</span><span>
</span><a name="line-1920"></a><a name="mkLet"><a href="CoreSyn.html#mkLet"><span class="hs-identifier">mkLet</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a name="local-6989586621682264426"><a href="#local-6989586621682264426"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264426"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1921"></a><span class="hs-identifier">mkLet</span><span> </span><a name="local-6989586621682264427"><a href="#local-6989586621682264427"><span class="hs-identifier">bind</span></a></a><span>     </span><a name="local-6989586621682264428"><a href="#local-6989586621682264428"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-6989586621682264427"><span class="hs-identifier hs-var">bind</span></a><span> </span><a href="#local-6989586621682264428"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1922"></a><span>
</span><a name="line-1923"></a><span class="hs-comment">-- | @mkLetNonRec bndr rhs body@ wraps @body@ in a @let@ binding @bndr@.</span><span>
</span><a name="line-1924"></a><span class="hs-identifier">mkLetNonRec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621682264266"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264266"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264266"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264266"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1925"></a><a name="mkLetNonRec"><a href="CoreSyn.html#mkLetNonRec"><span class="hs-identifier">mkLetNonRec</span></a></a><span> </span><a name="local-6989586621682264429"><a href="#local-6989586621682264429"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264430"><a href="#local-6989586621682264430"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621682264431"><a href="#local-6989586621682264431"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621682264429"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621682264430"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264431"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1926"></a><span>
</span><a name="line-1927"></a><span class="hs-comment">-- | @mkLetRec binds body@ wraps @body@ in a @let rec@ with the given set of</span><span>
</span><a name="line-1928"></a><span class="hs-comment">-- @binds@ if binds is non-empty.</span><span>
</span><a name="line-1929"></a><span class="hs-identifier">mkLetRec</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682264265"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264265"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264265"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264265"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1930"></a><a name="mkLetRec"><a href="CoreSyn.html#mkLetRec"><span class="hs-identifier">mkLetRec</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621682264432"><a href="#local-6989586621682264432"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264432"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1931"></a><span class="hs-identifier">mkLetRec</span><span> </span><a name="local-6989586621682264433"><a href="#local-6989586621682264433"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682264434"><a href="#local-6989586621682264434"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a href="#local-6989586621682264433"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264434"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-1932"></a><span>
</span><a name="line-1933"></a><span class="hs-comment">-- | Create a binding group where a type variable is bound to a type. Per &quot;CoreSyn#type_let&quot;,</span><span>
</span><a name="line-1934"></a><span class="hs-comment">-- this can only be used to bind something in a non-recursive @let@ expression</span><span>
</span><a name="line-1935"></a><span class="hs-identifier">mkTyBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-1936"></a><a name="mkTyBind"><a href="CoreSyn.html#mkTyBind"><span class="hs-identifier">mkTyBind</span></a></a><span> </span><a name="local-6989586621682264435"><a href="#local-6989586621682264435"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621682264436"><a href="#local-6989586621682264436"><span class="hs-identifier">ty</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621682264435"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621682264436"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1937"></a><span>
</span><a name="line-1938"></a><span class="hs-comment">-- | Create a binding group where a type variable is bound to a type. Per &quot;CoreSyn#type_let&quot;,</span><span>
</span><a name="line-1939"></a><span class="hs-comment">-- this can only be used to bind something in a non-recursive @let@ expression</span><span>
</span><a name="line-1940"></a><span class="hs-identifier">mkCoBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-1941"></a><a name="mkCoBind"><a href="CoreSyn.html#mkCoBind"><span class="hs-identifier">mkCoBind</span></a></a><span> </span><a name="local-6989586621682264437"><a href="#local-6989586621682264437"><span class="hs-identifier">cv</span></a></a><span> </span><a name="local-6989586621682264438"><a href="#local-6989586621682264438"><span class="hs-identifier">co</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621682264437"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621682264438"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1942"></a><span>
</span><a name="line-1943"></a><span class="hs-comment">-- | Convert a binder into either a 'Var' or 'Type' 'Expr' appropriately</span><span>
</span><a name="line-1944"></a><span class="hs-identifier">varToCoreExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264264"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-1945"></a><a name="varToCoreExpr"><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier">varToCoreExpr</span></a></a><span> </span><a name="local-6989586621682264439"><a href="#local-6989586621682264439"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682264439"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621682264439"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1946"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621682264439"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621682264439"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-1947"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">Var</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-1948"></a><span>
</span><a name="line-1949"></a><span class="hs-identifier">varsToCoreExprs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264263"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1950"></a><a name="varsToCoreExprs"><a href="CoreSyn.html#varsToCoreExprs"><span class="hs-identifier">varsToCoreExprs</span></a></a><span> </span><a name="local-6989586621682264440"><a href="#local-6989586621682264440"><span class="hs-identifier">vs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#varToCoreExpr"><span class="hs-identifier hs-var">varToCoreExpr</span></a><span> </span><a href="#local-6989586621682264440"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-1951"></a><span>
</span><a name="line-1952"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
   Getting a result type
*                                                                      *
************************************************************************

These are defined here to avoid a module loop between CoreUtils and CoreFVs

-}</span><span>
</span><a name="line-1962"></a><span>
</span><a name="line-1963"></a><span class="hs-identifier">applyTypeToArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1964"></a><span class="hs-comment">-- ^ Determines the type resulting from applying an expression with given type</span><span>
</span><a name="line-1965"></a><span class="hs-comment">-- to a given argument expression</span><span>
</span><a name="line-1966"></a><a name="applyTypeToArg"><a href="CoreSyn.html#applyTypeToArg"><span class="hs-identifier">applyTypeToArg</span></a></a><span> </span><a name="local-6989586621682264441"><a href="#local-6989586621682264441"><span class="hs-identifier">fun_ty</span></a></a><span> </span><a name="local-6989586621682264442"><a href="#local-6989586621682264442"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#piResultTy"><span class="hs-identifier hs-var">piResultTy</span></a><span> </span><a href="#local-6989586621682264441"><span class="hs-identifier hs-var">fun_ty</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span> </span><a href="#local-6989586621682264442"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1967"></a><span>
</span><a name="line-1968"></a><span class="hs-comment">-- | If the expression is a 'Type', converts. Otherwise,</span><span>
</span><a name="line-1969"></a><span class="hs-comment">-- panics. NB: This does /not/ convert 'Coercion' to 'CoercionTy'.</span><span>
</span><a name="line-1970"></a><span class="hs-identifier">exprToType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-1971"></a><a name="exprToType"><a href="CoreSyn.html#exprToType"><span class="hs-identifier">exprToType</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621682264443"><a href="#local-6989586621682264443"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264443"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-1972"></a><span class="hs-identifier">exprToType</span><span> </span><a name="local-6989586621682264444"><a href="#local-6989586621682264444"><span class="hs-identifier">_bad</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;exprToType&quot;</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">empty</span></a><span>
</span><a name="line-1973"></a><span>
</span><a name="line-1974"></a><span class="hs-comment">-- | If the expression is a 'Coercion', converts.</span><span>
</span><a name="line-1975"></a><span class="hs-identifier">exprToCoercion_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1976"></a><a name="exprToCoercion_maybe"><a href="CoreSyn.html#exprToCoercion_maybe"><span class="hs-identifier">exprToCoercion_maybe</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621682264445"><a href="#local-6989586621682264445"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682264445"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1977"></a><span class="hs-identifier">exprToCoercion_maybe</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1978"></a><span>
</span><a name="line-1979"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Simple access functions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-1986"></a><span>
</span><a name="line-1987"></a><span class="hs-comment">-- | Extract every variable by this group</span><span>
</span><a name="line-1988"></a><span class="hs-identifier">bindersOf</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264262"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264262"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1989"></a><span class="hs-comment">-- If you edit this function, you may need to update the GHC formalism</span><span>
</span><a name="line-1990"></a><span class="hs-comment">-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span><span>
</span><a name="line-1991"></a><a name="bindersOf"><a href="CoreSyn.html#bindersOf"><span class="hs-identifier">bindersOf</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621682264446"><a href="#local-6989586621682264446"><span class="hs-identifier">binder</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264446"><span class="hs-identifier hs-var">binder</span></a><span class="hs-special">]</span><span>
</span><a name="line-1992"></a><span class="hs-identifier">bindersOf</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621682264447"><a href="#local-6989586621682264447"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264448"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682264448"><a href="#local-6989586621682264448"><span class="hs-identifier">binder</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682264447"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span>
</span><a name="line-1993"></a><span>
</span><a name="line-1994"></a><span class="hs-comment">-- | 'bindersOf' applied to a list of binding groups</span><span>
</span><a name="line-1995"></a><span class="hs-identifier">bindersOfBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264261"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264261"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1996"></a><a name="bindersOfBinds"><a href="CoreSyn.html#bindersOfBinds"><span class="hs-identifier">bindersOfBinds</span></a></a><span> </span><a name="local-6989586621682264449"><a href="#local-6989586621682264449"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoreSyn.html#bindersOf"><span class="hs-identifier hs-var">bindersOf</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264449"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-1997"></a><span>
</span><a name="line-1998"></a><span class="hs-identifier">rhssOfBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264260"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264260"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-1999"></a><a name="rhssOfBind"><a href="CoreSyn.html#rhssOfBind"><span class="hs-identifier">rhssOfBind</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682264450"><a href="#local-6989586621682264450"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264450"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">]</span><span>
</span><a name="line-2000"></a><span class="hs-identifier">rhssOfBind</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621682264451"><a href="#local-6989586621682264451"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264452"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682264452"><a href="#local-6989586621682264452"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682264451"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span>
</span><a name="line-2001"></a><span>
</span><a name="line-2002"></a><span class="hs-identifier">rhssOfAlts</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span> </span><a href="#local-6989586621682264259"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264259"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span>
</span><a name="line-2003"></a><a name="rhssOfAlts"><a href="CoreSyn.html#rhssOfAlts"><span class="hs-identifier">rhssOfAlts</span></a></a><span> </span><a name="local-6989586621682264453"><a href="#local-6989586621682264453"><span class="hs-identifier">alts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264454"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682264454"><a href="#local-6989586621682264454"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682264453"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">]</span><span>
</span><a name="line-2004"></a><span>
</span><a name="line-2005"></a><span class="hs-comment">-- | Collapse all the bindings in the supplied groups into a single</span><span>
</span><a name="line-2006"></a><span class="hs-comment">-- list of lhs\/rhs pairs suitable for binding in a 'Rec' binding group</span><span>
</span><a name="line-2007"></a><span class="hs-identifier">flattenBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264258"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682264258"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264258"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2008"></a><a name="flattenBinds"><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier">flattenBinds</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621682264455"><a href="#local-6989586621682264455"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264456"><a href="#local-6989586621682264456"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682264457"><a href="#local-6989586621682264457"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264455"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><a href="#local-6989586621682264456"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a><span> </span><a href="#local-6989586621682264457"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-2009"></a><span class="hs-identifier">flattenBinds</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621682264458"><a href="#local-6989586621682264458"><span class="hs-identifier">prs1</span></a></a><span>   </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621682264459"><a href="#local-6989586621682264459"><span class="hs-identifier">binds</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264458"><span class="hs-identifier hs-var">prs1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="CoreSyn.html#flattenBinds"><span class="hs-identifier hs-var">flattenBinds</span></a><span> </span><a href="#local-6989586621682264459"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-2010"></a><span class="hs-identifier">flattenBinds</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2011"></a><span>
</span><a name="line-2012"></a><span class="hs-comment">-- | We often want to strip off leading lambdas before getting down to</span><span>
</span><a name="line-2013"></a><span class="hs-comment">-- business. Variants are 'collectTyBinders', 'collectValBinders',</span><span>
</span><a name="line-2014"></a><span class="hs-comment">-- and 'collectTyAndValBinders'</span><span>
</span><a name="line-2015"></a><span class="hs-identifier">collectBinders</span><span>         </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264257"><span class="hs-identifier hs-type">b</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682264257"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>     </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264257"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-2016"></a><span class="hs-identifier">collectTyBinders</span><span>       </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2017"></a><span class="hs-identifier">collectValBinders</span><span>      </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>    </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2018"></a><span class="hs-identifier">collectTyAndValBinders</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2019"></a><span class="hs-comment">-- | Strip off exactly N leading lambdas (type or value). Good for use with</span><span>
</span><a name="line-2020"></a><span class="hs-comment">-- join points.</span><span>
</span><a name="line-2021"></a><span class="hs-identifier">collectNBinders</span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264256"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682264256"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264256"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-2022"></a><span>
</span><a name="line-2023"></a><a name="collectBinders"><a href="CoreSyn.html#collectBinders"><span class="hs-identifier">collectBinders</span></a></a><span> </span><a name="local-6989586621682264460"><a href="#local-6989586621682264460"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2024"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264461"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264460"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-2025"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2026"></a><span>    </span><a name="local-6989586621682264461"><a href="#local-6989586621682264461"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682264462"><a href="#local-6989586621682264462"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621682264463"><a href="#local-6989586621682264463"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264464"><a href="#local-6989586621682264464"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264461"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264463"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264462"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264464"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2027"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264465"><a href="#local-6989586621682264465"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682264466"><a href="#local-6989586621682264466"><span class="hs-identifier">e</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264465"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264466"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><span>
</span><a name="line-2029"></a><a name="collectTyBinders"><a href="CoreSyn.html#collectTyBinders"><span class="hs-identifier">collectTyBinders</span></a></a><span> </span><a name="local-6989586621682264467"><a href="#local-6989586621682264467"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2030"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264468"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264467"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-2031"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2032"></a><span>    </span><a name="local-6989586621682264468"><a href="#local-6989586621682264468"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682264469"><a href="#local-6989586621682264469"><span class="hs-identifier">tvs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621682264470"><a href="#local-6989586621682264470"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264471"><a href="#local-6989586621682264471"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621682264470"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264468"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264470"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264469"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264471"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2033"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264472"><a href="#local-6989586621682264472"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621682264473"><a href="#local-6989586621682264473"><span class="hs-identifier">e</span></a></a><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264472"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264473"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-2034"></a><span>
</span><a name="line-2035"></a><a name="collectValBinders"><a href="CoreSyn.html#collectValBinders"><span class="hs-identifier">collectValBinders</span></a></a><span> </span><a name="local-6989586621682264474"><a href="#local-6989586621682264474"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2036"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264475"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264474"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-2037"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2038"></a><span>    </span><a name="local-6989586621682264475"><a href="#local-6989586621682264475"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621682264476"><a href="#local-6989586621682264476"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621682264477"><a href="#local-6989586621682264477"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264478"><a href="#local-6989586621682264478"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621682264477"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264475"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264477"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264476"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264478"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2039"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264479"><a href="#local-6989586621682264479"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621682264480"><a href="#local-6989586621682264480"><span class="hs-identifier">body</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264479"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264480"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2040"></a><span>
</span><a name="line-2041"></a><a name="collectTyAndValBinders"><a href="CoreSyn.html#collectTyAndValBinders"><span class="hs-identifier">collectTyAndValBinders</span></a></a><span> </span><a name="local-6989586621682264481"><a href="#local-6989586621682264481"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2042"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264482"><span class="hs-identifier hs-var">tvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264484"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264485"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2043"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2044"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682264482"><a href="#local-6989586621682264482"><span class="hs-identifier">tvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682264483"><a href="#local-6989586621682264483"><span class="hs-identifier">body1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectTyBinders"><span class="hs-identifier hs-var">collectTyBinders</span></a><span> </span><a href="#local-6989586621682264481"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-2045"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621682264484"><a href="#local-6989586621682264484"><span class="hs-identifier">ids</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621682264485"><a href="#local-6989586621682264485"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectValBinders"><span class="hs-identifier hs-var">collectValBinders</span></a><span> </span><a href="#local-6989586621682264483"><span class="hs-identifier hs-var">body1</span></a><span>
</span><a name="line-2046"></a><span>
</span><a name="line-2047"></a><a name="collectNBinders"><a href="CoreSyn.html#collectNBinders"><span class="hs-identifier">collectNBinders</span></a></a><span> </span><a name="local-6989586621682264486"><a href="#local-6989586621682264486"><span class="hs-identifier">orig_n</span></a></a><span> </span><a name="local-6989586621682264487"><a href="#local-6989586621682264487"><span class="hs-identifier">orig_expr</span></a></a><span>
</span><a name="line-2048"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264488"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264486"><span class="hs-identifier hs-var">orig_n</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264487"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-2049"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2050"></a><span>    </span><a name="local-6989586621682264488"><a href="#local-6989586621682264488"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621682264489"><a href="#local-6989586621682264489"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682264490"><a href="#local-6989586621682264490"><span class="hs-identifier">expr</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264489"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264490"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-2051"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264491"><a href="#local-6989586621682264491"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682264492"><a href="#local-6989586621682264492"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621682264493"><a href="#local-6989586621682264493"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264494"><a href="#local-6989586621682264494"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264488"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264491"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264493"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264492"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264494"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2052"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;collectNBinders&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-6989586621682264486"><span class="hs-identifier hs-var">orig_n</span></a><span>
</span><a name="line-2053"></a><span>
</span><a name="line-2054"></a><span class="hs-comment">-- | Takes a nested application expression and returns the function</span><span>
</span><a name="line-2055"></a><span class="hs-comment">-- being applied and the arguments to which it is applied</span><span>
</span><a name="line-2056"></a><span class="hs-identifier">collectArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264255"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264255"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="#local-6989586621682264255"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2057"></a><a name="collectArgs"><a href="CoreSyn.html#collectArgs"><span class="hs-identifier">collectArgs</span></a></a><span> </span><a name="local-6989586621682264495"><a href="#local-6989586621682264495"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2058"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264496"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264495"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2059"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2060"></a><span>    </span><a name="local-6989586621682264496"><a href="#local-6989586621682264496"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621682264497"><a href="#local-6989586621682264497"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264498"><a href="#local-6989586621682264498"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264496"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264497"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264498"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-2061"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264500"><a href="#local-6989586621682264500"><span class="hs-identifier">e</span></a></a><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264500"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-2062"></a><span>
</span><a name="line-2063"></a><span class="hs-comment">-- | Attempt to remove the last N arguments of a function call.</span><span>
</span><a name="line-2064"></a><span class="hs-comment">-- Strip off any ticks or coercions encountered along the way and any</span><span>
</span><a name="line-2065"></a><span class="hs-comment">-- at the end.</span><span>
</span><a name="line-2066"></a><span class="hs-identifier">stripNArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264254"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264254"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-2067"></a><a name="stripNArgs"><a href="CoreSyn.html#stripNArgs"><span class="hs-identifier">stripNArgs</span></a></a><span> </span><span class="hs-glyph">!</span><a name="local-6989586621682264502"><a href="#local-6989586621682264502"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621682264503"><a href="#local-6989586621682264503"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#stripNArgs"><span class="hs-identifier hs-var">stripNArgs</span></a><span> </span><a href="#local-6989586621682264502"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682264503"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2068"></a><span class="hs-identifier">stripNArgs</span><span> </span><a name="local-6989586621682264504"><a href="#local-6989586621682264504"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621682264505"><a href="#local-6989586621682264505"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#stripNArgs"><span class="hs-identifier hs-var">stripNArgs</span></a><span> </span><a href="#local-6989586621682264504"><span class="hs-identifier hs-var">n</span></a><span> </span><a href="#local-6989586621682264505"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-2069"></a><span class="hs-identifier">stripNArgs</span><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621682264506"><a href="#local-6989586621682264506"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621682264506"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2070"></a><span class="hs-identifier">stripNArgs</span><span> </span><a name="local-6989586621682264507"><a href="#local-6989586621682264507"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621682264508"><a href="#local-6989586621682264508"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#stripNArgs"><span class="hs-identifier hs-var">stripNArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264507"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264508"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-2071"></a><span class="hs-identifier">stripNArgs</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-2072"></a><span>
</span><a name="line-2073"></a><span class="hs-comment">-- | Like @collectArgs@, but also collects looks through floatable</span><span>
</span><a name="line-2074"></a><span class="hs-comment">-- ticks if it means that we can find more arguments.</span><span>
</span><a name="line-2075"></a><span class="hs-identifier">collectArgsTicks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264253"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-2076"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264253"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="#local-6989586621682264253"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2077"></a><a name="collectArgsTicks"><a href="CoreSyn.html#collectArgsTicks"><span class="hs-identifier">collectArgsTicks</span></a></a><span> </span><a name="local-6989586621682264509"><a href="#local-6989586621682264509"><span class="hs-identifier">skipTick</span></a></a><span> </span><a name="local-6989586621682264510"><a href="#local-6989586621682264510"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2078"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264511"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264510"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2079"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2080"></a><span>    </span><a name="local-6989586621682264511"><a href="#local-6989586621682264511"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621682264512"><a href="#local-6989586621682264512"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264513"><a href="#local-6989586621682264513"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682264515"><a href="#local-6989586621682264515"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264511"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264512"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264513"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264515"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-2081"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621682264516"><a href="#local-6989586621682264516"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621682264517"><a href="#local-6989586621682264517"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682264519"><a href="#local-6989586621682264519"><span class="hs-identifier">ts</span></a></a><span>
</span><a name="line-2082"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682264509"><span class="hs-identifier hs-var">skipTick</span></a><span> </span><a href="#local-6989586621682264516"><span class="hs-identifier hs-var">t</span></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264511"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264517"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264516"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264519"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2083"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264520"><a href="#local-6989586621682264520"><span class="hs-identifier">e</span></a></a><span>          </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682264522"><a href="#local-6989586621682264522"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264520"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264522"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2084"></a><span>
</span><a name="line-2085"></a><span>
</span><a name="line-2086"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Predicates}
*                                                                      *
************************************************************************

At one time we optionally carried type arguments through to runtime.
@isRuntimeVar v@ returns if (Lam v _) really becomes a lambda at runtime,
i.e. if type applications are actual lambdas because types are kept around
at runtime.  Similarly isRuntimeArg.
-}</span><span>
</span><a name="line-2098"></a><span>
</span><a name="line-2099"></a><span class="hs-comment">-- | Will this variable exist at runtime?</span><span>
</span><a name="line-2100"></a><span class="hs-identifier">isRuntimeVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2101"></a><a name="isRuntimeVar"><a href="CoreSyn.html#isRuntimeVar"><span class="hs-identifier">isRuntimeVar</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span>
</span><a name="line-2102"></a><span>
</span><a name="line-2103"></a><span class="hs-comment">-- | Will this argument expression exist at runtime?</span><span>
</span><a name="line-2104"></a><span class="hs-identifier">isRuntimeArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2105"></a><a name="isRuntimeArg"><a href="CoreSyn.html#isRuntimeArg"><span class="hs-identifier">isRuntimeArg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span>
</span><a name="line-2106"></a><span>
</span><a name="line-2107"></a><span class="hs-comment">-- | Returns @True@ for value arguments, false for type args</span><span>
</span><a name="line-2108"></a><span class="hs-comment">-- NB: coercions are value arguments (zero width, to be sure,</span><span>
</span><a name="line-2109"></a><span class="hs-comment">-- like State#, but still value args).</span><span>
</span><a name="line-2110"></a><span class="hs-identifier">isValArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264252"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2111"></a><a name="isValArg"><a href="CoreSyn.html#isValArg"><span class="hs-identifier">isValArg</span></a></a><span> </span><a name="local-6989586621682264523"><a href="#local-6989586621682264523"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isTypeArg"><span class="hs-identifier hs-var">isTypeArg</span></a><span> </span><a href="#local-6989586621682264523"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-2112"></a><span>
</span><a name="line-2113"></a><span class="hs-comment">-- | Returns @True@ iff the expression is a 'Type' or 'Coercion'</span><span>
</span><a name="line-2114"></a><span class="hs-comment">-- expression at its top level</span><span>
</span><a name="line-2115"></a><span class="hs-identifier">isTyCoArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264251"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2116"></a><a name="isTyCoArg"><a href="CoreSyn.html#isTyCoArg"><span class="hs-identifier">isTyCoArg</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2117"></a><span class="hs-identifier">isTyCoArg</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2118"></a><span class="hs-identifier">isTyCoArg</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2119"></a><span>
</span><a name="line-2120"></a><span class="hs-comment">-- | Returns @True@ iff the expression is a 'Coercion'</span><span>
</span><a name="line-2121"></a><span class="hs-comment">-- expression at its top level</span><span>
</span><a name="line-2122"></a><span class="hs-identifier">isCoArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264250"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2123"></a><a name="isCoArg"><a href="CoreSyn.html#isCoArg"><span class="hs-identifier">isCoArg</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2124"></a><span class="hs-identifier">isCoArg</span><span> </span><span class="hs-identifier">_</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2125"></a><span>
</span><a name="line-2126"></a><span class="hs-comment">-- | Returns @True@ iff the expression is a 'Type' expression at its</span><span>
</span><a name="line-2127"></a><span class="hs-comment">-- top level.  Note this does NOT include 'Coercion's.</span><span>
</span><a name="line-2128"></a><span class="hs-identifier">isTypeArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264249"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2129"></a><a name="isTypeArg"><a href="CoreSyn.html#isTypeArg"><span class="hs-identifier">isTypeArg</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-2130"></a><span class="hs-identifier">isTypeArg</span><span> </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2131"></a><span>
</span><a name="line-2132"></a><span class="hs-comment">-- | The number of binders that bind values rather than types</span><span>
</span><a name="line-2133"></a><span class="hs-identifier">valBndrCount</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreBndr"><span class="hs-identifier hs-type">CoreBndr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-2134"></a><a name="valBndrCount"><a href="CoreSyn.html#valBndrCount"><span class="hs-identifier">valBndrCount</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span>
</span><a name="line-2135"></a><span>
</span><a name="line-2136"></a><span class="hs-comment">-- | The number of argument expressions that are values rather than types at their top level</span><span>
</span><a name="line-2137"></a><span class="hs-identifier">valArgCount</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Arg"><span class="hs-identifier hs-type">Arg</span></a><span> </span><a href="#local-6989586621682264248"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-2138"></a><a name="valArgCount"><a href="CoreSyn.html#valArgCount"><span class="hs-identifier">valArgCount</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span>
</span><a name="line-2139"></a><span>
</span><a name="line-2140"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Annotated core}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-2147"></a><span>
</span><a name="line-2148"></a><span class="hs-comment">-- | Annotated core: allows annotation at every node in the tree</span><span>
</span><a name="line-2149"></a><span class="hs-keyword">type</span><span> </span><a name="AnnExpr"><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier">AnnExpr</span></a></a><span> </span><a name="local-6989586621682264205"><a href="#local-6989586621682264205"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682264206"><a href="#local-6989586621682264206"><span class="hs-identifier">annot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264206"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnExpr%27"><span class="hs-identifier hs-type">AnnExpr'</span></a><span> </span><a href="#local-6989586621682264205"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264206"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2150"></a><span>
</span><a name="line-2151"></a><span class="hs-comment">-- | A clone of the 'Expr' type but allowing annotation at every tree node</span><span>
</span><a name="line-2152"></a><span class="hs-keyword">data</span><span> </span><a name="AnnExpr%27"><a href="CoreSyn.html#AnnExpr%27"><span class="hs-identifier">AnnExpr'</span></a></a><span> </span><a name="local-6989586621682264203"><a href="#local-6989586621682264203"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682264204"><a href="#local-6989586621682264204"><span class="hs-identifier">annot</span></a></a><span>
</span><a name="line-2153"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="AnnVar"><a href="CoreSyn.html#AnnVar"><span class="hs-identifier">AnnVar</span></a></a><span>      </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-2154"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnLit"><a href="CoreSyn.html#AnnLit"><span class="hs-identifier">AnnLit</span></a></a><span>      </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span>
</span><a name="line-2155"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnLam"><a href="CoreSyn.html#AnnLam"><span class="hs-identifier">AnnLam</span></a></a><span>      </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2156"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnApp"><a href="CoreSyn.html#AnnApp"><span class="hs-identifier">AnnApp</span></a></a><span>      </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2157"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnCase"><a href="CoreSyn.html#AnnCase"><span class="hs-identifier">AnnCase</span></a></a><span>     </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AnnAlt"><span class="hs-identifier hs-type">AnnAlt</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">]</span><span>
</span><a name="line-2158"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnLet"><a href="CoreSyn.html#AnnLet"><span class="hs-identifier">AnnLet</span></a></a><span>      </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnBind"><span class="hs-identifier hs-type">AnnBind</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2159"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnCast"><a href="CoreSyn.html#AnnCast"><span class="hs-identifier">AnnCast</span></a></a><span>     </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-2160"></a><span>                   </span><span class="hs-comment">-- Put an annotation on the (root of) the coercion</span><span>
</span><a name="line-2161"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnTick"><a href="CoreSyn.html#AnnTick"><span class="hs-identifier">AnnTick</span></a></a><span>     </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264203"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264204"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2162"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnType"><a href="CoreSyn.html#AnnType"><span class="hs-identifier">AnnType</span></a></a><span>     </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-2163"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnCoercion"><a href="CoreSyn.html#AnnCoercion"><span class="hs-identifier">AnnCoercion</span></a></a><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-2164"></a><span>
</span><a name="line-2165"></a><span class="hs-comment">-- | A clone of the 'Alt' type but allowing annotation at every tree node</span><span>
</span><a name="line-2166"></a><span class="hs-keyword">type</span><span> </span><a name="AnnAlt"><a href="CoreSyn.html#AnnAlt"><span class="hs-identifier">AnnAlt</span></a></a><span> </span><a name="local-6989586621682264201"><a href="#local-6989586621682264201"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682264202"><a href="#local-6989586621682264202"><span class="hs-identifier">annot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AltCon"><span class="hs-identifier hs-type">AltCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621682264201"><span class="hs-identifier hs-type">bndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264201"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264202"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2167"></a><span>
</span><a name="line-2168"></a><span class="hs-comment">-- | A clone of the 'Bind' type but allowing annotation at every tree node</span><span>
</span><a name="line-2169"></a><span class="hs-keyword">data</span><span> </span><a name="AnnBind"><a href="CoreSyn.html#AnnBind"><span class="hs-identifier">AnnBind</span></a></a><span> </span><a name="local-6989586621682264199"><a href="#local-6989586621682264199"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621682264200"><a href="#local-6989586621682264200"><span class="hs-identifier">annot</span></a></a><span>
</span><a name="line-2170"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="AnnNonRec"><a href="CoreSyn.html#AnnNonRec"><span class="hs-identifier">AnnNonRec</span></a></a><span> </span><a href="#local-6989586621682264199"><span class="hs-identifier hs-type">bndr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264199"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264200"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2171"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="AnnRec"><a href="CoreSyn.html#AnnRec"><span class="hs-identifier">AnnRec</span></a></a><span>    </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682264199"><span class="hs-identifier hs-type">bndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264199"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264200"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2172"></a><span>
</span><a name="line-2173"></a><span class="hs-comment">-- | Takes a nested application expression and returns the function</span><span>
</span><a name="line-2174"></a><span class="hs-comment">-- being applied and the arguments to which it is applied</span><span>
</span><a name="line-2175"></a><span class="hs-identifier">collectAnnArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264246"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264247"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264246"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264247"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264246"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264247"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2176"></a><a name="collectAnnArgs"><a href="CoreSyn.html#collectAnnArgs"><span class="hs-identifier">collectAnnArgs</span></a></a><span> </span><a name="local-6989586621682264524"><a href="#local-6989586621682264524"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2177"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264525"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264524"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2178"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2179"></a><span>    </span><a name="local-6989586621682264525"><a href="#local-6989586621682264525"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnApp"><span class="hs-identifier hs-var">AnnApp</span></a><span> </span><a name="local-6989586621682264526"><a href="#local-6989586621682264526"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264527"><a href="#local-6989586621682264527"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264525"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264526"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264527"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-2180"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264529"><a href="#local-6989586621682264529"><span class="hs-identifier">e</span></a></a><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264529"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-2181"></a><span>
</span><a name="line-2182"></a><span class="hs-identifier">collectAnnArgsTicks</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264244"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264245"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2183"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264244"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264245"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264244"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264245"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-2184"></a><a name="collectAnnArgsTicks"><a href="CoreSyn.html#collectAnnArgsTicks"><span class="hs-identifier">collectAnnArgsTicks</span></a></a><span> </span><a name="local-6989586621682264531"><a href="#local-6989586621682264531"><span class="hs-identifier">tickishOk</span></a></a><span> </span><a name="local-6989586621682264532"><a href="#local-6989586621682264532"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-2185"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264533"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264532"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2186"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2187"></a><span>    </span><a name="local-6989586621682264533"><a href="#local-6989586621682264533"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnApp"><span class="hs-identifier hs-var">AnnApp</span></a><span> </span><a name="local-6989586621682264534"><a href="#local-6989586621682264534"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621682264535"><a href="#local-6989586621682264535"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682264537"><a href="#local-6989586621682264537"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264533"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264534"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264535"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264537"><span class="hs-identifier hs-var">ts</span></a><span>
</span><a name="line-2188"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnTick"><span class="hs-identifier hs-var">AnnTick</span></a><span> </span><a name="local-6989586621682264538"><a href="#local-6989586621682264538"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621682264539"><a href="#local-6989586621682264539"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682264541"><a href="#local-6989586621682264541"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621682264531"><span class="hs-identifier hs-var">tickishOk</span></a><span> </span><a href="#local-6989586621682264538"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2189"></a><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264533"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621682264539"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264538"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264541"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2190"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621682264542"><a href="#local-6989586621682264542"><span class="hs-identifier">e</span></a></a><span>                </span><span class="hs-keyword">as</span><span> </span><a name="local-6989586621682264544"><a href="#local-6989586621682264544"><span class="hs-identifier">ts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264542"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264544"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2191"></a><span>
</span><a name="line-2192"></a><span class="hs-identifier">deAnnotate</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264242"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264243"><span class="hs-identifier hs-type">annot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264242"><span class="hs-identifier hs-type">bndr</span></a><span>
</span><a name="line-2193"></a><a name="deAnnotate"><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier">deAnnotate</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621682264545"><a href="#local-6989586621682264545"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#deAnnotate%27"><span class="hs-identifier hs-var">deAnnotate'</span></a><span> </span><a href="#local-6989586621682264545"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2194"></a><span>
</span><a name="line-2195"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AnnExpr%27"><span class="hs-identifier hs-type">AnnExpr'</span></a><span> </span><a href="#local-6989586621682264240"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264241"><span class="hs-identifier hs-type">annot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Expr"><span class="hs-identifier hs-type">Expr</span></a><span> </span><a href="#local-6989586621682264240"><span class="hs-identifier hs-type">bndr</span></a><span>
</span><a name="line-2196"></a><a name="deAnnotate%27"><a href="CoreSyn.html#deAnnotate%27"><span class="hs-identifier">deAnnotate'</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnType"><span class="hs-identifier hs-var">AnnType</span></a><span> </span><a name="local-6989586621682264546"><a href="#local-6989586621682264546"><span class="hs-identifier">t</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621682264546"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-2197"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnCoercion"><span class="hs-identifier hs-var">AnnCoercion</span></a><span> </span><a name="local-6989586621682264547"><a href="#local-6989586621682264547"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a href="#local-6989586621682264547"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2198"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnVar"><span class="hs-identifier hs-var">AnnVar</span></a><span>  </span><a name="local-6989586621682264548"><a href="#local-6989586621682264548"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621682264548"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-2199"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnLit"><span class="hs-identifier hs-var">AnnLit</span></a><span>  </span><a name="local-6989586621682264549"><a href="#local-6989586621682264549"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621682264549"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-2200"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnLam"><span class="hs-identifier hs-var">AnnLam</span></a><span>  </span><a name="local-6989586621682264550"><a href="#local-6989586621682264550"><span class="hs-identifier">binder</span></a></a><span> </span><a name="local-6989586621682264551"><a href="#local-6989586621682264551"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621682264550"><span class="hs-identifier hs-var">binder</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264551"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2201"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnApp"><span class="hs-identifier hs-var">AnnApp</span></a><span>  </span><a name="local-6989586621682264552"><a href="#local-6989586621682264552"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621682264553"><a href="#local-6989586621682264553"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264552"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264553"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-2202"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnCast"><span class="hs-identifier hs-var">AnnCast</span></a><span> </span><a name="local-6989586621682264554"><a href="#local-6989586621682264554"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><a name="local-6989586621682264555"><a href="#local-6989586621682264555"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264554"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264555"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-2203"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnTick"><span class="hs-identifier hs-var">AnnTick</span></a><span> </span><a name="local-6989586621682264556"><a href="#local-6989586621682264556"><span class="hs-identifier">tick</span></a></a><span> </span><a name="local-6989586621682264557"><a href="#local-6989586621682264557"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a href="#local-6989586621682264556"><span class="hs-identifier hs-var">tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264557"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2204"></a><span>
</span><a name="line-2205"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnLet"><span class="hs-identifier hs-var">AnnLet</span></a><span> </span><a name="local-6989586621682264558"><a href="#local-6989586621682264558"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621682264559"><a href="#local-6989586621682264559"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2206"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnBind"><span class="hs-identifier hs-var">deAnnBind</span></a><span> </span><a href="#local-6989586621682264558"><span class="hs-identifier hs-var">bind</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264559"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2207"></a><span class="hs-identifier">deAnnotate'</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnCase"><span class="hs-identifier hs-var">AnnCase</span></a><span> </span><a name="local-6989586621682264560"><a href="#local-6989586621682264560"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621682264561"><a href="#local-6989586621682264561"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621682264562"><a href="#local-6989586621682264562"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621682264563"><a href="#local-6989586621682264563"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2208"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264560"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264561"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621682264562"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#deAnnAlt"><span class="hs-identifier hs-var">deAnnAlt</span></a><span> </span><a href="#local-6989586621682264563"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-2209"></a><span>
</span><a name="line-2210"></a><span class="hs-identifier">deAnnAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AnnAlt"><span class="hs-identifier hs-type">AnnAlt</span></a><span> </span><a href="#local-6989586621682264238"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264239"><span class="hs-identifier hs-type">annot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Alt"><span class="hs-identifier hs-type">Alt</span></a><span> </span><a href="#local-6989586621682264238"><span class="hs-identifier hs-type">bndr</span></a><span>
</span><a name="line-2211"></a><a name="deAnnAlt"><a href="CoreSyn.html#deAnnAlt"><span class="hs-identifier">deAnnAlt</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621682264564"><a href="#local-6989586621682264564"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><a name="local-6989586621682264565"><a href="#local-6989586621682264565"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><a name="local-6989586621682264566"><a href="#local-6989586621682264566"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264564"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><a href="#local-6989586621682264565"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264566"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2212"></a><span>
</span><a name="line-2213"></a><span class="hs-identifier">deAnnBind</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AnnBind"><span class="hs-identifier hs-type">AnnBind</span></a><span> </span><a href="#local-6989586621682264236"><span class="hs-identifier hs-type">b</span></a><span> </span><a href="#local-6989586621682264237"><span class="hs-identifier hs-type">annot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Bind"><span class="hs-identifier hs-type">Bind</span></a><span> </span><a href="#local-6989586621682264236"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-2214"></a><a name="deAnnBind"><a href="CoreSyn.html#deAnnBind"><span class="hs-identifier">deAnnBind</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnNonRec"><span class="hs-identifier hs-var">AnnNonRec</span></a><span> </span><a name="local-6989586621682264567"><a href="#local-6989586621682264567"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621682264568"><a href="#local-6989586621682264568"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621682264567"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264568"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2215"></a><span class="hs-identifier">deAnnBind</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#AnnRec"><span class="hs-identifier hs-var">AnnRec</span></a><span> </span><a name="local-6989586621682264569"><a href="#local-6989586621682264569"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621682264570"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="CoreSyn.html#deAnnotate"><span class="hs-identifier hs-var">deAnnotate</span></a><span> </span><a href="#local-6989586621682264571"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621682264570"><a href="#local-6989586621682264570"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><a name="local-6989586621682264571"><a href="#local-6989586621682264571"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621682264569"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span>
</span><a name="line-2216"></a><span>
</span><a name="line-2217"></a><span class="hs-comment">-- | As 'collectBinders' but for 'AnnExpr' rather than 'Expr'</span><span>
</span><a name="line-2218"></a><span class="hs-identifier">collectAnnBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264234"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264235"><span class="hs-identifier hs-type">annot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682264234"><span class="hs-identifier hs-type">bndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264234"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264235"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2219"></a><a name="collectAnnBndrs"><a href="CoreSyn.html#collectAnnBndrs"><span class="hs-identifier">collectAnnBndrs</span></a></a><span> </span><a name="local-6989586621682264572"><a href="#local-6989586621682264572"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-2220"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264573"><span class="hs-identifier hs-var">collect</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264572"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2221"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2222"></a><span>    </span><a name="local-6989586621682264573"><a href="#local-6989586621682264573"><span class="hs-identifier">collect</span></a></a><span> </span><a name="local-6989586621682264574"><a href="#local-6989586621682264574"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnLam"><span class="hs-identifier hs-var">AnnLam</span></a><span> </span><a name="local-6989586621682264575"><a href="#local-6989586621682264575"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264576"><a href="#local-6989586621682264576"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264573"><span class="hs-identifier hs-var">collect</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264575"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264574"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264576"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-2223"></a><span>    </span><span class="hs-identifier">collect</span><span> </span><a name="local-6989586621682264577"><a href="#local-6989586621682264577"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682264578"><a href="#local-6989586621682264578"><span class="hs-identifier">body</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264577"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264578"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2224"></a><span>
</span><a name="line-2225"></a><span class="hs-comment">-- | As 'collectNBinders' but for 'AnnExpr' rather than 'Expr'</span><span>
</span><a name="line-2226"></a><span class="hs-identifier">collectNAnnBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264232"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264233"><span class="hs-identifier hs-type">annot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="#local-6989586621682264232"><span class="hs-identifier hs-type">bndr</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnExpr"><span class="hs-identifier hs-type">AnnExpr</span></a><span> </span><a href="#local-6989586621682264232"><span class="hs-identifier hs-type">bndr</span></a><span> </span><a href="#local-6989586621682264233"><span class="hs-identifier hs-type">annot</span></a><span class="hs-special">)</span><span>
</span><a name="line-2227"></a><a name="collectNAnnBndrs"><a href="CoreSyn.html#collectNAnnBndrs"><span class="hs-identifier">collectNAnnBndrs</span></a></a><span> </span><a name="local-6989586621682264579"><a href="#local-6989586621682264579"><span class="hs-identifier">orig_n</span></a></a><span> </span><a name="local-6989586621682264580"><a href="#local-6989586621682264580"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-2228"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264581"><span class="hs-identifier hs-var">collect</span></a><span> </span><a href="#local-6989586621682264579"><span class="hs-identifier hs-var">orig_n</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621682264580"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-2229"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-2230"></a><span>    </span><a name="local-6989586621682264581"><a href="#local-6989586621682264581"><span class="hs-identifier">collect</span></a></a><span> </span><span class="hs-number">0</span><span> </span><a name="local-6989586621682264582"><a href="#local-6989586621682264582"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621682264583"><a href="#local-6989586621682264583"><span class="hs-identifier">body</span></a></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621682264582"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621682264583"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-2231"></a><span>    </span><span class="hs-identifier">collect</span><span> </span><a name="local-6989586621682264584"><a href="#local-6989586621682264584"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621682264585"><a href="#local-6989586621682264585"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#AnnLam"><span class="hs-identifier hs-var">AnnLam</span></a><span> </span><a name="local-6989586621682264586"><a href="#local-6989586621682264586"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621682264587"><a href="#local-6989586621682264587"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621682264581"><span class="hs-identifier hs-var">collect</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264584"><span class="hs-identifier hs-var">n</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621682264586"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621682264585"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621682264587"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-2232"></a><span>    </span><span class="hs-identifier">collect</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-identifier">_</span><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;collectNBinders&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Outputable.html#int"><span class="hs-identifier hs-var">int</span></a><span> </span><a href="#local-6989586621682264579"><span class="hs-identifier hs-var">orig_n</span></a><span>
</span><a name="line-2233"></a></pre></body></html>