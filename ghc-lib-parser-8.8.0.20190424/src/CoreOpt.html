<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
-}</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-7"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CoreOpt</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-8"></a><span>        </span><span class="hs-comment">-- ** Simple expression optimiser</span><span>
</span><a name="line-9"></a><span>        </span><a href="CoreOpt.html#simpleOptPgm"><span class="hs-identifier hs-var">simpleOptPgm</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#simpleOptExpr"><span class="hs-identifier hs-var">simpleOptExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span>        </span><span class="hs-comment">-- ** Join points</span><span>
</span><a name="line-12"></a><span>        </span><a href="CoreOpt.html#joinPointBinding_maybe"><span class="hs-identifier hs-var">joinPointBinding_maybe</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#joinPointBindings_maybe"><span class="hs-identifier hs-var">joinPointBindings_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>
</span><a name="line-14"></a><span>        </span><span class="hs-comment">-- ** Predicates on expressions</span><span>
</span><a name="line-15"></a><span>        </span><a href="CoreOpt.html#exprIsConApp_maybe"><span class="hs-identifier hs-var">exprIsConApp_maybe</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>        </span><span class="hs-comment">-- ** Coercions and casts</span><span>
</span><a name="line-18"></a><span>        </span><a href="CoreOpt.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#collectBindersPushingCo"><span class="hs-identifier hs-var">collectBindersPushingCo</span></a><span>
</span><a name="line-19"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="CoreArity.html"><span class="hs-identifier">CoreArity</span></a><span class="hs-special">(</span><span> </span><a href="CoreArity.html#etaExpandToJoinPoint"><span class="hs-identifier hs-var">etaExpandToJoinPoint</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSubst.html"><span class="hs-identifier">CoreSubst</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="PprCore.html#pprCoreBindings"><span class="hs-identifier hs-var">pprCoreBindings</span></a><span class="hs-special">,</span><span> </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="OccurAnal.html"><span class="hs-identifier">OccurAnal</span></a><span class="hs-special">(</span><span> </span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span class="hs-special">,</span><span> </span><a href="OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var">occurAnalysePgm</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Literal.html"><span class="hs-identifier">Literal</span></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span class="hs-special">(</span><a href="Literal.html#LitString"><span class="hs-identifier hs-var">LitString</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>      </span><span class="hs-special">(</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">isNonCoVarId</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><a href="DataCon.html"><span class="hs-identifier">DataCon</span></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="Demand.html"><span class="hs-identifier">Demand</span></a><span class="hs-special">(</span><span> </span><a href="Demand.html#etaExpandStrictSig"><span class="hs-identifier hs-var">etaExpandStrictSig</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span> </span><a href="OptCoercion.html"><span class="hs-identifier">OptCoercion</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>     </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubstList"><span class="hs-identifier hs-var">extendTvSubstList</span></a><span>
</span><a name="line-42"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#cloneTyVarBndr"><span class="hs-identifier hs-var">cloneTyVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="TyCon.html"><span class="hs-identifier">TyCon</span></a><span>        </span><span class="hs-special">(</span><span> </span><a href="TyCon.html#tyConArity"><span class="hs-identifier hs-var">tyConArity</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><a href="TysWiredIn.html"><span class="hs-identifier">TysWiredIn</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-47"></a><span class="hs-keyword">import</span><span> </span><a href="BasicTypes.html"><span class="hs-identifier">BasicTypes</span></a><span>
</span><a name="line-48"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-52"></a><span class="hs-keyword">import</span><span> </span><a href="Pair.html"><span class="hs-identifier">Pair</span></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>       </span><span class="hs-special">(</span><span> </span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.ByteString</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">BS</span><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        The Simple Optimiser
*                                                                      *
************************************************************************

Note [The simple optimiser]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The simple optimiser is a lightweight, pure (non-monadic) function
that rapidly does a lot of simple optimisations, including

  - inlining things that occur just once,
      or whose RHS turns out to be trivial
  - beta reduction
  - case of known constructor
  - dead code elimination

It does NOT do any call-site inlining; it only inlines a function if
it can do so unconditionally, dropping the binding.  It thereby
guarantees to leave no un-reduced beta-redexes.

It is careful to follow the guidance of &quot;Secrets of the GHC inliner&quot;,
and in particular the pre-inline-unconditionally and
post-inline-unconditionally story, to do effective beta reduction on
functions called precisely once, without repeatedly optimising the same
expression.  In fact, the simple optimiser is a good example of this
little dance in action; the full Simplifier is a lot more complicated.

-}</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-identifier">simpleOptExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-91"></a><span class="hs-comment">-- See Note [The simple optimiser]</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- Do simple optimisation on an expression</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- The optimisation is very straightforward: just</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- inline non-recursive bindings that are used only once,</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- or where the RHS is trivial</span><span>
</span><a name="line-96"></a><span class="hs-comment">--</span><span>
</span><a name="line-97"></a><span class="hs-comment">-- We also inline bindings that bind a Eq# box: see</span><span>
</span><a name="line-98"></a><span class="hs-comment">-- See Note [Getting the map/coerce RULE to work].</span><span>
</span><a name="line-99"></a><span class="hs-comment">--</span><span>
</span><a name="line-100"></a><span class="hs-comment">-- Also we convert functions to join points where possible (as</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- the occurrence analyser does most of the work anyway).</span><span>
</span><a name="line-102"></a><span class="hs-comment">--</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- The result is NOT guaranteed occurrence-analysed, because</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- in  (let x = y in ....) we substitute for x; so y's occ-info</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- may change radically</span><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><a name="simpleOptExpr"><a href="CoreOpt.html#simpleOptExpr"><span class="hs-identifier">simpleOptExpr</span></a></a><span> </span><a name="local-6989586621684747216"><a href="#local-6989586621684747216"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684747217"><a href="#local-6989586621684747217"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-108"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;simpleOptExpr&quot; (ppr init_subst $$ ppr expr)</span><span>
</span><a name="line-109"></a><span>    </span><a href="CoreOpt.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span> </span><a href="#local-6989586621684747216"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621684747218"><span class="hs-identifier hs-var">init_subst</span></a><span> </span><a href="#local-6989586621684747217"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-110"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-111"></a><span>    </span><a name="local-6989586621684747218"><a href="#local-6989586621684747218"><span class="hs-identifier">init_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#mkInScopeSet"><span class="hs-identifier hs-var">mkInScopeSet</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><a href="#local-6989586621684747217"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>        </span><span class="hs-comment">-- It's potentially important to make a proper in-scope set</span><span>
</span><a name="line-113"></a><span>        </span><span class="hs-comment">-- Consider  let x = ..y.. in \y. ...x...</span><span>
</span><a name="line-114"></a><span>        </span><span class="hs-comment">-- Then we should remember to clone y before substituting</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-comment">-- for x.  It's very unlikely to occur, because we probably</span><span>
</span><a name="line-116"></a><span>        </span><span class="hs-comment">-- won't *be* substituting for x if it occurs inside a</span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-comment">-- lambda.</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-119"></a><span>        </span><span class="hs-comment">-- It's a bit painful to call exprFreeVars, because it makes</span><span>
</span><a name="line-120"></a><span>        </span><span class="hs-comment">-- three passes instead of two (occ-anal, and go)</span><span>
</span><a name="line-121"></a><span>
</span><a name="line-122"></a><span class="hs-identifier">simpleOptExprWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-123"></a><span class="hs-comment">-- See Note [The simple optimiser]</span><span>
</span><a name="line-124"></a><a name="simpleOptExprWith"><a href="CoreOpt.html#simpleOptExprWith"><span class="hs-identifier">simpleOptExprWith</span></a></a><span> </span><a name="local-6989586621684747219"><a href="#local-6989586621684747219"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684747220"><a href="#local-6989586621684747220"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684747221"><a href="#local-6989586621684747221"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-125"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747222"><span class="hs-identifier hs-var">init_env</span></a><span> </span><span class="hs-special">(</span><a href="OccurAnal.html#occurAnalyseExpr"><span class="hs-identifier hs-var">occurAnalyseExpr</span></a><span> </span><a href="#local-6989586621684747221"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-127"></a><span>    </span><a name="local-6989586621684747222"><a href="#local-6989586621684747222"><span class="hs-identifier">init_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747219"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-128"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-129"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747220"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-132"></a><span class="hs-identifier">simpleOptPgm</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-133"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-134"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span class="hs-comment">-- See Note [The simple optimiser]</span><span>
</span><a name="line-136"></a><a name="simpleOptPgm"><a href="CoreOpt.html#simpleOptPgm"><span class="hs-identifier">simpleOptPgm</span></a></a><span> </span><a name="local-6989586621684747223"><a href="#local-6989586621684747223"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621684747224"><a href="#local-6989586621684747224"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621684747225"><a href="#local-6989586621684747225"><span class="hs-identifier">binds</span></a></a><span> </span><a name="local-6989586621684747226"><a href="#local-6989586621684747226"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><a href="ErrUtils.html#dumpIfSet_dyn"><span class="hs-identifier hs-var">dumpIfSet_dyn</span></a><span> </span><a href="#local-6989586621684747223"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="DynFlags.html#Opt_D_dump_occur_anal"><span class="hs-identifier hs-var">Opt_D_dump_occur_anal</span></a><span> </span><span class="hs-string">&quot;Occurrence analysis&quot;</span><span>
</span><a name="line-138"></a><span>                       </span><span class="hs-special">(</span><a href="PprCore.html#pprCoreBindings"><span class="hs-identifier hs-var">pprCoreBindings</span></a><span> </span><a href="#local-6989586621684747227"><span class="hs-identifier hs-var">occ_anald_binds</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="PprCore.html#pprRules"><span class="hs-identifier hs-var">pprRules</span></a><span> </span><a href="#local-6989586621684747226"><span class="hs-identifier hs-var">rules</span></a><span> </span><span class="hs-special">)</span><span class="hs-special">;</span><span>
</span><a name="line-139"></a><span>
</span><a name="line-140"></a><span>       </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684747229"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747231"><span class="hs-identifier hs-var">rules'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-141"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-142"></a><span>    </span><a name="local-6989586621684747227"><a href="#local-6989586621684747227"><span class="hs-identifier">occ_anald_binds</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="OccurAnal.html#occurAnalysePgm"><span class="hs-identifier hs-var">occurAnalysePgm</span></a><span> </span><a href="#local-6989586621684747224"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-143"></a><span>                          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">{- All unfoldings active -}</span><span>
</span><a name="line-144"></a><span>                          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-comment">{- No rules active -}</span><span>
</span><a name="line-145"></a><span>                          </span><a href="#local-6989586621684747226"><span class="hs-identifier hs-var">rules</span></a><span> </span><a href="#local-6989586621684747225"><span class="hs-identifier hs-var">binds</span></a><span>
</span><a name="line-146"></a><span>
</span><a name="line-147"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747228"><a href="#local-6989586621684747228"><span class="hs-identifier">final_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747229"><a href="#local-6989586621684747229"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684747232"><span class="hs-identifier hs-var">do_one</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#emptyEnv"><span class="hs-identifier hs-var">emptyEnv</span></a><span> </span><a href="#local-6989586621684747223"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747227"><span class="hs-identifier hs-var">occ_anald_binds</span></a><span>
</span><a name="line-148"></a><span>    </span><a name="local-6989586621684747230"><a href="#local-6989586621684747230"><span class="hs-identifier">final_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747228"><span class="hs-identifier hs-var">final_env</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span>    </span><a name="local-6989586621684747231"><a href="#local-6989586621684747231"><span class="hs-identifier">rules'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substRulesForImportedIds"><span class="hs-identifier hs-var">substRulesForImportedIds</span></a><span> </span><a href="#local-6989586621684747230"><span class="hs-identifier hs-var">final_subst</span></a><span> </span><a href="#local-6989586621684747226"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-151"></a><span>             </span><span class="hs-comment">-- We never unconditionally inline into rules,</span><span>
</span><a name="line-152"></a><span>             </span><span class="hs-comment">-- hence paying just a substitution</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span>    </span><a name="local-6989586621684747232"><a href="#local-6989586621684747232"><span class="hs-identifier">do_one</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747233"><a href="#local-6989586621684747233"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747234"><a href="#local-6989586621684747234"><span class="hs-identifier">binds'</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747235"><a href="#local-6989586621684747235"><span class="hs-identifier">bind</span></a></a><span>
</span><a name="line-155"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreOpt.html#simple_opt_bind"><span class="hs-identifier hs-var">simple_opt_bind</span></a><span> </span><a href="#local-6989586621684747233"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747235"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-156"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684747236"><a href="#local-6989586621684747236"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747236"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747234"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>          </span><span class="hs-special">(</span><a name="local-6989586621684747237"><a href="#local-6989586621684747237"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747238"><a href="#local-6989586621684747238"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747237"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747238"><span class="hs-identifier hs-var">bind'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747234"><span class="hs-identifier hs-var">binds'</span></a><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span>
</span><a name="line-159"></a><span class="hs-comment">-- In these functions the substitution maps InVar -&gt; OutExpr</span><span>
</span><a name="line-160"></a><span>
</span><a name="line-161"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-162"></a><span class="hs-keyword">type</span><span> </span><a name="SimpleClo"><a href="CoreOpt.html#SimpleClo"><span class="hs-identifier">SimpleClo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>
</span><a name="line-164"></a><span class="hs-keyword">data</span><span> </span><a name="SimpleOptEnv"><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier">SimpleOptEnv</span></a></a><span>
</span><a name="line-165"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="SOE"><a href="CoreOpt.html#SOE"><span class="hs-identifier">SOE</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="soe_dflags"><a href="CoreOpt.html#soe_dflags"><span class="hs-identifier">soe_dflags</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-166"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="soe_inl"><a href="CoreOpt.html#soe_inl"><span class="hs-identifier">soe_inl</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="CoreOpt.html#SimpleClo"><span class="hs-identifier hs-type">SimpleClo</span></a><span>
</span><a name="line-167"></a><span>             </span><span class="hs-comment">-- Deals with preInlineUnconditionally; things</span><span>
</span><a name="line-168"></a><span>             </span><span class="hs-comment">-- that occur exactly once and are inlined</span><span>
</span><a name="line-169"></a><span>             </span><span class="hs-comment">-- without having first been simplified</span><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="soe_subst"><a href="CoreOpt.html#soe_subst"><span class="hs-identifier">soe_subst</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-172"></a><span>             </span><span class="hs-comment">-- Deals with cloning; includes the InScopeSet</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-176"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747214"><a href="#local-6989586621684747214"><span class="hs-identifier">inl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747215"><a href="#local-6989586621684747215"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;SOE {&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;soe_inl   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747214"><span class="hs-identifier hs-var">inl</span></a><span>
</span><a name="line-178"></a><span>                            </span><span class="hs-special">,</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;soe_subst =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747215"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-179"></a><span>                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;}&quot;</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-identifier">emptyEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span>
</span><a name="line-182"></a><a name="emptyEnv"><a href="CoreOpt.html#emptyEnv"><span class="hs-identifier">emptyEnv</span></a></a><span> </span><a name="local-6989586621684747239"><a href="#local-6989586621684747239"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-183"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_dflags</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747239"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-184"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-185"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-186"></a><span>
</span><a name="line-187"></a><span class="hs-identifier">soeZapSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span>
</span><a name="line-188"></a><a name="soeZapSubst"><a href="CoreOpt.html#soeZapSubst"><span class="hs-identifier">soeZapSubst</span></a></a><span> </span><a name="local-6989586621684747240"><a href="#local-6989586621684747240"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747241"><a href="#local-6989586621684747241"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747240"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span> </span><a href="#local-6989586621684747241"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span class="hs-identifier">soeSetInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- Take in-scope set from env1, and the rest from env2</span><span>
</span><a name="line-193"></a><a name="soeSetInScope"><a href="CoreOpt.html#soeSetInScope"><span class="hs-identifier">soeSetInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747242"><a href="#local-6989586621684747242"><span class="hs-identifier">subst1</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-194"></a><span>              </span><a name="local-6989586621684747243"><a href="#local-6989586621684747243"><span class="hs-identifier">env2</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747244"><a href="#local-6989586621684747244"><span class="hs-identifier">subst2</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747243"><span class="hs-identifier hs-var">env2</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#setInScope"><span class="hs-identifier hs-var">setInScope</span></a><span> </span><a href="#local-6989586621684747244"><span class="hs-identifier hs-var">subst2</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span> </span><a href="#local-6989586621684747242"><span class="hs-identifier hs-var">subst1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">---------------</span><span>
</span><a name="line-198"></a><span class="hs-identifier">simple_opt_clo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#SimpleClo"><span class="hs-identifier hs-type">SimpleClo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-199"></a><a name="simple_opt_clo"><a href="CoreOpt.html#simple_opt_clo"><span class="hs-identifier">simple_opt_clo</span></a></a><span> </span><a name="local-6989586621684747245"><a href="#local-6989586621684747245"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747246"><a href="#local-6989586621684747246"><span class="hs-identifier">e_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747247"><a href="#local-6989586621684747247"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-200"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#soeSetInScope"><span class="hs-identifier hs-var">soeSetInScope</span></a><span> </span><a href="#local-6989586621684747245"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747246"><span class="hs-identifier hs-var">e_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747247"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-identifier">simple_opt_expr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-203"></a><a name="simple_opt_expr"><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier">simple_opt_expr</span></a></a><span> </span><a name="local-6989586621684747248"><a href="#local-6989586621684747248"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747249"><a href="#local-6989586621684747249"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-204"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747249"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-206"></a><span>    </span><a name="local-6989586621684747250"><a href="#local-6989586621684747250"><span class="hs-identifier">subst</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-207"></a><span>    </span><a name="local-6989586621684747251"><a href="#local-6989586621684747251"><span class="hs-identifier">in_scope</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span> </span><a href="#local-6989586621684747250"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-208"></a><span>    </span><a name="local-6989586621684747252"><a href="#local-6989586621684747252"><span class="hs-identifier">in_scope_env</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747251"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#simpleUnfoldingFun"><span class="hs-identifier hs-var">simpleUnfoldingFun</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span>    </span><a name="local-6989586621684747253"><a href="#local-6989586621684747253"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747256"><a href="#local-6989586621684747256"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747257"><a href="#local-6989586621684747257"><span class="hs-identifier">clo</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_inl</span><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747256"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-212"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_opt_clo"><span class="hs-identifier hs-var">simple_opt_clo</span></a><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747257"><span class="hs-identifier hs-var">clo</span></a><span>
</span><a name="line-213"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-214"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;simpleOptExpr&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747256"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684747258"><a href="#local-6989586621684747258"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684747259"><a href="#local-6989586621684747259"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747258"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><a href="#local-6989586621684747259"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-217"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684747260"><a href="#local-6989586621684747260"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span>     </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684747250"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747260"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-218"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684747261"><a href="#local-6989586621684747261"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_dflags</span><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621684747250"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747261"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621684747262"><a href="#local-6989586621684747262"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621684747262"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-220"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684747263"><a href="#local-6989586621684747263"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621684747264"><a href="#local-6989586621684747264"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a><span> </span><a href="#local-6989586621684747250"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747263"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747264"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-221"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684747265"><a href="#local-6989586621684747265"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684747266"><a href="#local-6989586621684747266"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621684747267"><span class="hs-identifier hs-var">co'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747265"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-222"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747265"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747267"><span class="hs-identifier hs-var">co'</span></a><span>
</span><a name="line-223"></a><span>                        </span><span class="hs-keyword">where</span><span>
</span><a name="line-224"></a><span>                          </span><a name="local-6989586621684747267"><a href="#local-6989586621684747267"><span class="hs-identifier">co'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_dflags</span><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621684747250"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747266"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684747268"><a href="#local-6989586621684747268"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684747269"><a href="#local-6989586621684747269"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreOpt.html#simple_opt_bind"><span class="hs-identifier hs-var">simple_opt_bind</span></a><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747268"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-227"></a><span>                           </span><span class="hs-special">(</span><a name="local-6989586621684747270"><a href="#local-6989586621684747270"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747270"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684747269"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-228"></a><span>                           </span><span class="hs-special">(</span><a name="local-6989586621684747271"><a href="#local-6989586621684747271"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747272"><a href="#local-6989586621684747272"><span class="hs-identifier">bind</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-6989586621684747272"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747271"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684747269"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684747273"><a href="#local-6989586621684747273"><span class="hs-identifier">lam</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747255"><span class="hs-identifier hs-var">go_lam</span></a><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684747273"><span class="hs-identifier hs-var">lam</span></a><span>
</span><a name="line-231"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684747274"><a href="#local-6989586621684747274"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684747275"><a href="#local-6989586621684747275"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747276"><a href="#local-6989586621684747276"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-232"></a><span>       </span><span class="hs-comment">-- See Note [Getting the map/coerce RULE to work]</span><span>
</span><a name="line-233"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621684747275"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-234"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747281"><a href="#local-6989586621684747281"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747282"><a href="#local-6989586621684747282"><span class="hs-identifier">_tys</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747283"><a href="#local-6989586621684747283"><span class="hs-identifier">es</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsConApp_maybe"><span class="hs-identifier hs-var">exprIsConApp_maybe</span></a><span> </span><a href="#local-6989586621684747252"><span class="hs-identifier hs-var">in_scope_env</span></a><span> </span><a href="#local-6989586621684747278"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-235"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747284"><a href="#local-6989586621684747284"><span class="hs-identifier">altcon</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747285"><a href="#local-6989586621684747285"><span class="hs-identifier">bs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747286"><a href="#local-6989586621684747286"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#findAlt"><span class="hs-identifier hs-var">findAlt</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#DataAlt"><span class="hs-identifier hs-var">DataAlt</span></a><span> </span><a href="#local-6989586621684747281"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-236"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747284"><span class="hs-identifier hs-var">altcon</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-237"></a><span>          </span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747286"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-238"></a><span>          </span><span class="hs-identifier">_</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="CoreOpt.html#wrapLet"><span class="hs-identifier hs-var">wrapLet</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747287"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684747286"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747288"><span class="hs-identifier hs-var">mb_prs</span></a><span>
</span><a name="line-239"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-240"></a><span>              </span><span class="hs-special">(</span><a name="local-6989586621684747287"><a href="#local-6989586621684747287"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747288"><a href="#local-6989586621684747288"><span class="hs-identifier">mb_prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="CoreOpt.html#simple_out_bind"><span class="hs-identifier hs-var">simple_out_bind</span></a><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-241"></a><span>                               </span><a href="Util.html#zipEqual"><span class="hs-identifier hs-var">zipEqual</span></a><span> </span><span class="hs-string">&quot;simpleOptExpr&quot;</span><span> </span><a href="#local-6989586621684747285"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684747283"><span class="hs-identifier hs-var">es</span></a><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span>         </span><span class="hs-comment">-- Note [Getting the map/coerce RULE to work]</span><span>
</span><a name="line-244"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isDeadBinder"><span class="hs-identifier hs-var">isDeadBinder</span></a><span> </span><a href="#local-6989586621684747275"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-245"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#DEFAULT"><span class="hs-identifier hs-var">DEFAULT</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684747289"><a href="#local-6989586621684747289"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-246"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Type.html#isCoVarType"><span class="hs-identifier hs-var">isCoVarType</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">varType</span><span> </span><a href="#local-6989586621684747275"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-247"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747290"><a href="#local-6989586621684747290"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747291"><a href="#local-6989586621684747291"><span class="hs-identifier">_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span> </span><a href="#local-6989586621684747274"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-248"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747290"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleSCSelIdKey"><span class="hs-identifier hs-var">coercibleSCSelIdKey</span></a><span>
</span><a name="line-249"></a><span>         </span><span class="hs-comment">-- without this last check, we get #11230</span><span>
</span><a name="line-250"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747289"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-253"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a href="#local-6989586621684747278"><span class="hs-identifier hs-var">e'</span></a><span> </span><a href="#local-6989586621684747280"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684747250"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747276"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-254"></a><span>                   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747254"><span class="hs-identifier hs-var">go_alt</span></a><span> </span><a href="#local-6989586621684747279"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-255"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-256"></a><span>        </span><a name="local-6989586621684747278"><a href="#local-6989586621684747278"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747253"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747274"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-257"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684747279"><a href="#local-6989586621684747279"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747280"><a href="#local-6989586621684747280"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-6989586621684747248"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747275"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span>    </span><span class="hs-comment">----------------------</span><span>
</span><a name="line-260"></a><span>    </span><a name="local-6989586621684747254"><a href="#local-6989586621684747254"><span class="hs-identifier">go_alt</span></a></a><span> </span><a name="local-6989586621684747292"><a href="#local-6989586621684747292"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747293"><a href="#local-6989586621684747293"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747294"><a href="#local-6989586621684747294"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747295"><a href="#local-6989586621684747295"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-261"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747293"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747297"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747296"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684747295"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-262"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-263"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684747296"><a href="#local-6989586621684747296"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747297"><a href="#local-6989586621684747297"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#subst_opt_bndrs"><span class="hs-identifier hs-var">subst_opt_bndrs</span></a><span> </span><a href="#local-6989586621684747292"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747294"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-264"></a><span>
</span><a name="line-265"></a><span>    </span><span class="hs-comment">----------------------</span><span>
</span><a name="line-266"></a><span>    </span><span class="hs-comment">-- go_lam tries eta reduction</span><span>
</span><a name="line-267"></a><span>    </span><a name="local-6989586621684747255"><a href="#local-6989586621684747255"><span class="hs-identifier">go_lam</span></a></a><span> </span><a name="local-6989586621684747298"><a href="#local-6989586621684747298"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747299"><a href="#local-6989586621684747299"><span class="hs-identifier">bs'</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684747300"><a href="#local-6989586621684747300"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747301"><a href="#local-6989586621684747301"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747255"><span class="hs-identifier hs-var">go_lam</span></a><span> </span><a href="#local-6989586621684747302"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747303"><span class="hs-identifier hs-var">b'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747299"><span class="hs-identifier hs-var">bs'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747301"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-269"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-270"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621684747302"><a href="#local-6989586621684747302"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747303"><a href="#local-6989586621684747303"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-6989586621684747298"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747300"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-271"></a><span>    </span><span class="hs-identifier">go_lam</span><span> </span><a name="local-6989586621684747304"><a href="#local-6989586621684747304"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747305"><a href="#local-6989586621684747305"><span class="hs-identifier">bs'</span></a></a><span> </span><a name="local-6989586621684747306"><a href="#local-6989586621684747306"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-272"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747309"><a href="#local-6989586621684747309"><span class="hs-identifier">etad_e</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreUtils.html#tryEtaReduce"><span class="hs-identifier hs-var">tryEtaReduce</span></a><span> </span><a href="#local-6989586621684747307"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684747308"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747309"><span class="hs-identifier hs-var">etad_e</span></a><span>
</span><a name="line-273"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                         </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621684747307"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684747308"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-274"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-275"></a><span>         </span><a name="local-6989586621684747307"><a href="#local-6989586621684747307"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684747305"><span class="hs-identifier hs-var">bs'</span></a><span>
</span><a name="line-276"></a><span>         </span><a name="local-6989586621684747308"><a href="#local-6989586621684747308"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747304"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747306"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-277"></a><span>
</span><a name="line-278"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-279"></a><span class="hs-comment">-- simple_app collects arguments for beta reduction</span><span>
</span><a name="line-280"></a><span class="hs-identifier">simple_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreOpt.html#SimpleClo"><span class="hs-identifier hs-type">SimpleClo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><a name="simple_app"><a href="CoreOpt.html#simple_app"><span class="hs-identifier">simple_app</span></a></a><span> </span><a name="local-6989586621684747310"><a href="#local-6989586621684747310"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747311"><a href="#local-6989586621684747311"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747313"><a href="#local-6989586621684747313"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747314"><a href="#local-6989586621684747314"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_inl</span><span> </span><a href="#local-6989586621684747310"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747311"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-284"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#soeSetInScope"><span class="hs-identifier hs-var">soeSetInScope</span></a><span> </span><a href="#local-6989586621684747310"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747313"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747314"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-285"></a><span>
</span><a name="line-286"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747315"><a href="#local-6989586621684747315"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-6989586621684747311"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-287"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#isCompulsoryUnfolding"><span class="hs-identifier hs-var">isCompulsoryUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-6989586621684747311"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-6989586621684747311"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-289"></a><span>    </span><span class="hs-comment">-- See Note [Unfold compulsory unfoldings in LHSs]</span><span>
</span><a name="line-290"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#soeZapSubst"><span class="hs-identifier hs-var">soeZapSubst</span></a><span> </span><a href="#local-6989586621684747310"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#unfoldingTemplate"><span class="hs-identifier hs-var">unfoldingTemplate</span></a><span> </span><a href="#local-6989586621684747315"><span class="hs-identifier hs-var">unf</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-293"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747316"><a href="#local-6989586621684747316"><span class="hs-identifier">out_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;simple_app&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747310"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747311"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-294"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#finish_app"><span class="hs-identifier hs-var">finish_app</span></a><span> </span><a href="#local-6989586621684747310"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747316"><span class="hs-identifier hs-var">out_fn</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-6989586621684747317"><a href="#local-6989586621684747317"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684747318"><a href="#local-6989586621684747318"><span class="hs-identifier">e1</span></a></a><span> </span><a name="local-6989586621684747319"><a href="#local-6989586621684747319"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-297"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-6989586621684747317"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747318"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684747317"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747319"><span class="hs-identifier hs-var">e2</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-6989586621684747321"><a href="#local-6989586621684747321"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684747322"><a href="#local-6989586621684747322"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747323"><a href="#local-6989586621684747323"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747324"><a href="#local-6989586621684747324"><span class="hs-identifier">a</span></a></a><span class="hs-glyph">:</span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#wrapLet"><span class="hs-identifier hs-var">wrapLet</span></a><span> </span><a href="#local-6989586621684747327"><span class="hs-identifier hs-var">mb_pr</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-6989586621684747326"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684747323"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-302"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621684747326"><a href="#local-6989586621684747326"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747327"><a href="#local-6989586621684747327"><span class="hs-identifier">mb_pr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_bind_pair"><span class="hs-identifier hs-var">simple_bind_pair</span></a><span> </span><a href="#local-6989586621684747321"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747322"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684747324"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-6989586621684747328"><a href="#local-6989586621684747328"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684747329"><a href="#local-6989586621684747329"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684747330"><a href="#local-6989586621684747330"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-305"></a><span>  </span><span class="hs-comment">-- Okay to do &quot;(Tick t e) x ==&gt; Tick t (e x)&quot;?</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684747329"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#tickishScopesLike"><span class="hs-identifier hs-var">tickishScopesLike</span></a><span class="hs-special">`</span><span> </span><a href="CoreSyn.html#SoftScope"><span class="hs-identifier hs-var">SoftScope</span></a><span>
</span><a name="line-307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><a href="#local-6989586621684747329"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CoreOpt.html#simple_app"><span class="hs-identifier hs-var">simple_app</span></a><span> </span><a href="#local-6989586621684747328"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747330"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-identifier">simple_app</span><span> </span><a name="local-6989586621684747332"><a href="#local-6989586621684747332"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747333"><a href="#local-6989586621684747333"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-310"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#finish_app"><span class="hs-identifier hs-var">finish_app</span></a><span> </span><a href="#local-6989586621684747332"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747332"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747333"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-identifier">finish_app</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreOpt.html#SimpleClo"><span class="hs-identifier hs-type">SimpleClo</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-313"></a><a name="finish_app"><a href="CoreOpt.html#finish_app"><span class="hs-identifier">finish_app</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684747335"><a href="#local-6989586621684747335"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-314"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747335"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-315"></a><span class="hs-identifier">finish_app</span><span> </span><a name="local-6989586621684747336"><a href="#local-6989586621684747336"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747337"><a href="#local-6989586621684747337"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747338"><a href="#local-6989586621684747338"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684747339"><a href="#local-6989586621684747339"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#finish_app"><span class="hs-identifier hs-var">finish_app</span></a><span> </span><a href="#local-6989586621684747336"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a href="#local-6989586621684747337"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#simple_opt_clo"><span class="hs-identifier hs-var">simple_opt_clo</span></a><span> </span><a href="#local-6989586621684747336"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747338"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747339"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-319"></a><span class="hs-identifier">simple_opt_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InBind"><span class="hs-identifier hs-type">InBind</span></a><span>
</span><a name="line-320"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="CoreSyn.html#OutBind"><span class="hs-identifier hs-type">OutBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-321"></a><a name="simple_opt_bind"><a href="CoreOpt.html#simple_opt_bind"><span class="hs-identifier">simple_opt_bind</span></a></a><span> </span><a name="local-6989586621684747340"><a href="#local-6989586621684747340"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621684747341"><a href="#local-6989586621684747341"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747342"><a href="#local-6989586621684747342"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747345"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747346"><span class="hs-identifier hs-var">mb_pr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-323"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-324"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747347"><a href="#local-6989586621684747347"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747348"><a href="#local-6989586621684747348"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684747347"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684747348"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-325"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-326"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747343"><a href="#local-6989586621684747343"><span class="hs-identifier">b'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747344"><a href="#local-6989586621684747344"><span class="hs-identifier">r'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#joinPointBinding_maybe"><span class="hs-identifier hs-var">joinPointBinding_maybe</span></a><span> </span><a href="#local-6989586621684747341"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684747342"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747341"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747342"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747345"><a href="#local-6989586621684747345"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747346"><a href="#local-6989586621684747346"><span class="hs-identifier">mb_pr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_bind_pair"><span class="hs-identifier hs-var">simple_bind_pair</span></a><span> </span><a href="#local-6989586621684747340"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747343"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747340"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><a href="#local-6989586621684747344"><span class="hs-identifier hs-var">r'</span></a><span class="hs-special">)</span><span>
</span><a name="line-328"></a><span>
</span><a name="line-329"></a><span class="hs-identifier">simple_opt_bind</span><span> </span><a name="local-6989586621684747349"><a href="#local-6989586621684747349"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621684747350"><a href="#local-6989586621684747350"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-330"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747355"><span class="hs-identifier hs-var">env''</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747351"><span class="hs-identifier hs-var">res_bind</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-332"></a><span>    </span><a name="local-6989586621684747351"><a href="#local-6989586621684747351"><span class="hs-identifier">res_bind</span></a></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684747356"><span class="hs-identifier hs-var">rev_prs'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-333"></a><span>    </span><a name="local-6989586621684747352"><a href="#local-6989586621684747352"><span class="hs-identifier">prs'</span></a></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#joinPointBindings_maybe"><span class="hs-identifier hs-var">joinPointBindings_maybe</span></a><span> </span><a href="#local-6989586621684747350"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747350"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-334"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747353"><a href="#local-6989586621684747353"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747354"><a href="#local-6989586621684747354"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#subst_opt_bndrs"><span class="hs-identifier hs-var">subst_opt_bndrs</span></a><span> </span><a href="#local-6989586621684747349"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><a href="#local-6989586621684747352"><span class="hs-identifier hs-var">prs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747355"><a href="#local-6989586621684747355"><span class="hs-identifier">env''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747356"><a href="#local-6989586621684747356"><span class="hs-identifier">rev_prs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684747357"><span class="hs-identifier hs-var">do_pr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747353"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747352"><span class="hs-identifier hs-var">prs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747354"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">)</span><span>
</span><a name="line-336"></a><span>    </span><a name="local-6989586621684747357"><a href="#local-6989586621684747357"><span class="hs-identifier">do_pr</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747358"><a href="#local-6989586621684747358"><span class="hs-identifier">env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747359"><a href="#local-6989586621684747359"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684747360"><a href="#local-6989586621684747360"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747361"><a href="#local-6989586621684747361"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684747362"><a href="#local-6989586621684747362"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-337"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747363"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747364"><span class="hs-identifier hs-var">mb_pr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-338"></a><span>                  </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747365"><a href="#local-6989586621684747365"><span class="hs-identifier">pr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684747365"><span class="hs-identifier hs-var">pr</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684747359"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-339"></a><span>                  </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684747359"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>
</span><a name="line-340"></a><span>       </span><span class="hs-keyword">where</span><span>
</span><a name="line-341"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621684747363"><a href="#local-6989586621684747363"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747364"><a href="#local-6989586621684747364"><span class="hs-identifier">mb_pr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_bind_pair"><span class="hs-identifier hs-var">simple_bind_pair</span></a><span> </span><a href="#local-6989586621684747358"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747360"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684747362"><span class="hs-identifier hs-var">b'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747358"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><a href="#local-6989586621684747361"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-344"></a><span class="hs-identifier">simple_bind_pair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span>
</span><a name="line-345"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span>
</span><a name="line-346"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#SimpleClo"><span class="hs-identifier hs-type">SimpleClo</span></a><span>
</span><a name="line-347"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-348"></a><span>    </span><span class="hs-comment">-- (simple_bind_pair subst in_var out_rhs)</span><span>
</span><a name="line-349"></a><span>    </span><span class="hs-comment">--   either extends subst with (in_var -&gt; out_rhs)</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-comment">--   or     returns Nothing</span><span>
</span><a name="line-351"></a><a name="simple_bind_pair"><a href="CoreOpt.html#simple_bind_pair"><span class="hs-identifier">simple_bind_pair</span></a></a><span> </span><a name="local-6989586621684747366"><a href="#local-6989586621684747366"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747367"><a href="#local-6989586621684747367"><span class="hs-identifier">inl_env</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747368"><a href="#local-6989586621684747368"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-352"></a><span>                 </span><a name="local-6989586621684747369"><a href="#local-6989586621684747369"><span class="hs-identifier">in_bndr</span></a></a><span> </span><a name="local-6989586621684747370"><a href="#local-6989586621684747370"><span class="hs-identifier">mb_out_bndr</span></a></a><span> </span><a name="local-6989586621684747371"><a href="#local-6989586621684747371"><span class="hs-identifier">clo</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684747372"><a href="#local-6989586621684747372"><span class="hs-identifier">rhs_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747373"><a href="#local-6989586621684747373"><span class="hs-identifier">in_rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684747389"><a href="#local-6989586621684747389"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684747373"><span class="hs-identifier hs-var">in_rhs</span></a><span>        </span><span class="hs-comment">-- let a::* = TYPE ty in &lt;body&gt;</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747390"><a href="#local-6989586621684747390"><span class="hs-identifier">out_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747372"><span class="hs-identifier hs-var">rhs_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747389"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-355"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">in_bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-356"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621684747368"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747390"><span class="hs-identifier hs-var">out_ty</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-357"></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684747391"><a href="#local-6989586621684747391"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684747373"><span class="hs-identifier hs-var">in_rhs</span></a><span>
</span><a name="line-359"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747392"><a href="#local-6989586621684747392"><span class="hs-identifier">out_co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="OptCoercion.html#optCoercion"><span class="hs-identifier hs-var">optCoercion</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_dflags</span><span> </span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747372"><span class="hs-identifier hs-var">rhs_env</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747391"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-360"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">in_bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-6989586621684747368"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747392"><span class="hs-identifier hs-var">out_co</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>
</span><a name="line-363"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNonCoVarId</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">in_bndr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>    </span><span class="hs-comment">-- The previous two guards got rid of tyvars and coercions</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-comment">-- See Note [CoreSyn type and coercion invariant] in CoreSyn</span><span>
</span><a name="line-366"></a><span>    </span><a href="#local-6989586621684747379"><span class="hs-identifier hs-var">pre_inline_unconditionally</span></a><span>
</span><a name="line-367"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684747367"><span class="hs-identifier hs-var">inl_env</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747371"><span class="hs-identifier hs-var">clo</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>
</span><a name="line-369"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-370"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_out_bind_pair"><span class="hs-identifier hs-var">simple_out_bind_pair</span></a><span> </span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747370"><span class="hs-identifier hs-var">mb_out_bndr</span></a><span> </span><a href="#local-6989586621684747377"><span class="hs-identifier hs-var">out_rhs</span></a><span>
</span><a name="line-371"></a><span>                         </span><a href="#local-6989586621684747376"><span class="hs-identifier hs-var">occ</span></a><span> </span><a href="#local-6989586621684747375"><span class="hs-identifier hs-var">active</span></a><span> </span><a href="#local-6989586621684747374"><span class="hs-identifier hs-var">stable_unf</span></a><span>
</span><a name="line-372"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-373"></a><span>    </span><a name="local-6989586621684747374"><a href="#local-6989586621684747374"><span class="hs-identifier">stable_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-374"></a><span>    </span><a name="local-6989586621684747375"><a href="#local-6989586621684747375"><span class="hs-identifier">active</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-6989586621684747376"><a href="#local-6989586621684747376"><span class="hs-identifier">occ</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span>
</span><a name="line-376"></a><span>
</span><a name="line-377"></a><span>    </span><a name="local-6989586621684747377"><a href="#local-6989586621684747377"><span class="hs-identifier">out_rhs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747381"><a href="#local-6989586621684747381"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#isJoinId_maybe"><span class="hs-identifier hs-var">isJoinId_maybe</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span>
</span><a name="line-378"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747378"><span class="hs-identifier hs-var">simple_join_rhs</span></a><span> </span><a href="#local-6989586621684747381"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-379"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-380"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_opt_clo"><span class="hs-identifier hs-var">simple_opt_clo</span></a><span> </span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747371"><span class="hs-identifier hs-var">clo</span></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span>    </span><a name="local-6989586621684747378"><a href="#local-6989586621684747378"><span class="hs-identifier">simple_join_rhs</span></a></a><span> </span><a name="local-6989586621684747382"><a href="#local-6989586621684747382"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-comment">-- See Note [Preserve join-binding arity]</span><span>
</span><a name="line-383"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621684747387"><span class="hs-identifier hs-var">join_bndrs'</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#simple_opt_expr"><span class="hs-identifier hs-var">simple_opt_expr</span></a><span> </span><a href="#local-6989586621684747386"><span class="hs-identifier hs-var">env_body</span></a><span> </span><a href="#local-6989586621684747385"><span class="hs-identifier hs-var">join_body</span></a><span class="hs-special">)</span><span>
</span><a name="line-384"></a><span>      </span><span class="hs-keyword">where</span><span>
</span><a name="line-385"></a><span>        </span><a name="local-6989586621684747383"><a href="#local-6989586621684747383"><span class="hs-identifier">env0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#soeSetInScope"><span class="hs-identifier hs-var">soeSetInScope</span></a><span> </span><a href="#local-6989586621684747366"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747372"><span class="hs-identifier hs-var">rhs_env</span></a><span>
</span><a name="line-386"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684747384"><a href="#local-6989586621684747384"><span class="hs-identifier">join_bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747385"><a href="#local-6989586621684747385"><span class="hs-identifier">join_body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#collectNBinders"><span class="hs-identifier hs-var">collectNBinders</span></a><span> </span><a href="#local-6989586621684747382"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><a href="#local-6989586621684747373"><span class="hs-identifier hs-var">in_rhs</span></a><span>
</span><a name="line-387"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684747386"><a href="#local-6989586621684747386"><span class="hs-identifier">env_body</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747387"><a href="#local-6989586621684747387"><span class="hs-identifier">join_bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#subst_opt_bndrs"><span class="hs-identifier hs-var">subst_opt_bndrs</span></a><span> </span><a href="#local-6989586621684747383"><span class="hs-identifier hs-var">env0</span></a><span> </span><a href="#local-6989586621684747384"><span class="hs-identifier hs-var">join_bndrs</span></a><span>
</span><a name="line-388"></a><span>
</span><a name="line-389"></a><span>    </span><span class="hs-identifier">pre_inline_unconditionally</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-390"></a><span>    </span><a name="local-6989586621684747379"><a href="#local-6989586621684747379"><span class="hs-identifier">pre_inline_unconditionally</span></a></a><span>
</span><a name="line-391"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a><span> </span><a href="#local-6989586621684747369"><span class="hs-identifier hs-var">in_bndr</span></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-392"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684747374"><span class="hs-identifier hs-var">stable_unf</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-393"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684747375"><span class="hs-identifier hs-var">active</span></a><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>    </span><span class="hs-comment">-- Note [Inline prag in simplOpt]</span><span>
</span><a name="line-394"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747380"><span class="hs-identifier hs-var">safe_to_inline</span></a><span> </span><a href="#local-6989586621684747376"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-395"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-396"></a><span>
</span><a name="line-397"></a><span>        </span><span class="hs-comment">-- Unconditionally safe to inline</span><span>
</span><a name="line-398"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-399"></a><span>    </span><a name="local-6989586621684747380"><a href="#local-6989586621684747380"><span class="hs-identifier">safe_to_inline</span></a></a><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#IAmALoopBreaker"><span class="hs-identifier hs-var">IAmALoopBreaker</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-400"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><a href="BasicTypes.html#IAmDead"><span class="hs-identifier hs-var">IAmDead</span></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-401"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><a name="local-6989586621684747388"><a href="#local-6989586621684747388"><span class="hs-identifier">occ</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="BasicTypes.html#OneOcc"><span class="hs-identifier hs-var">OneOcc</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>      </span><span class="hs-glyph">=</span><span>  </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">occ_in_lam</span><span> </span><a href="#local-6989586621684747388"><span class="hs-identifier hs-var">occ</span></a><span class="hs-special">)</span><span>
</span><a name="line-402"></a><span>                                        </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier">occ_one_br</span><span> </span><a href="#local-6989586621684747388"><span class="hs-identifier hs-var">occ</span></a><span>
</span><a name="line-403"></a><span>    </span><span class="hs-identifier">safe_to_inline</span><span> </span><span class="hs-special">(</span><a href="BasicTypes.html#ManyOccs"><span class="hs-identifier hs-var">ManyOccs</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-404"></a><span>
</span><a name="line-405"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-406"></a><span class="hs-identifier">simple_out_bind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-407"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-408"></a><a name="simple_out_bind"><a href="CoreOpt.html#simple_out_bind"><span class="hs-identifier">simple_out_bind</span></a></a><span> </span><a name="local-6989586621684747393"><a href="#local-6989586621684747393"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747394"><a href="#local-6989586621684747394"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747395"><a href="#local-6989586621684747395"><span class="hs-identifier">in_bndr</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747396"><a href="#local-6989586621684747396"><span class="hs-identifier">out_rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-409"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684747397"><a href="#local-6989586621684747397"><span class="hs-identifier">out_ty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684747396"><span class="hs-identifier hs-var">out_rhs</span></a><span>
</span><a name="line-410"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">in_bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684747393"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621684747394"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747395"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747397"><span class="hs-identifier hs-var">out_ty</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-412"></a><span>
</span><a name="line-413"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684747398"><a href="#local-6989586621684747398"><span class="hs-identifier">out_co</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684747396"><span class="hs-identifier hs-var">out_rhs</span></a><span>
</span><a name="line-414"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">in_bndr</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684747393"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span> </span><a href="#local-6989586621684747394"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747395"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747398"><span class="hs-identifier hs-var">out_co</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>
</span><a name="line-417"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-418"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simple_out_bind_pair"><span class="hs-identifier hs-var">simple_out_bind_pair</span></a><span> </span><a href="#local-6989586621684747393"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747395"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a href="#local-6989586621684747396"><span class="hs-identifier hs-var">out_rhs</span></a><span>
</span><a name="line-419"></a><span>                         </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684747395"><span class="hs-identifier hs-var">in_bndr</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">-------------------</span><span>
</span><a name="line-422"></a><span class="hs-identifier">simple_out_bind_pair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span>
</span><a name="line-423"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span>
</span><a name="line-424"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><a href="BasicTypes.html#OccInfo"><span class="hs-identifier hs-type">OccInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-425"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#OutExpr"><span class="hs-identifier hs-type">OutExpr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-426"></a><a name="simple_out_bind_pair"><a href="CoreOpt.html#simple_out_bind_pair"><span class="hs-identifier">simple_out_bind_pair</span></a></a><span> </span><a name="local-6989586621684747399"><a href="#local-6989586621684747399"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747400"><a href="#local-6989586621684747400"><span class="hs-identifier">in_bndr</span></a></a><span> </span><a name="local-6989586621684747401"><a href="#local-6989586621684747401"><span class="hs-identifier">mb_out_bndr</span></a></a><span> </span><a name="local-6989586621684747402"><a href="#local-6989586621684747402"><span class="hs-identifier">out_rhs</span></a></a><span>
</span><a name="line-427"></a><span>                     </span><a name="local-6989586621684747403"><a href="#local-6989586621684747403"><span class="hs-identifier">occ_info</span></a></a><span> </span><a name="local-6989586621684747404"><a href="#local-6989586621684747404"><span class="hs-identifier">active</span></a></a><span> </span><a name="local-6989586621684747405"><a href="#local-6989586621684747405"><span class="hs-identifier">stable_unf</span></a></a><span>
</span><a name="line-428"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNonCoVarId</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">in_bndr</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747400"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-429"></a><span>    </span><span class="hs-comment">-- Type and coercion bindings are caught earlier</span><span>
</span><a name="line-430"></a><span>    </span><span class="hs-comment">-- See Note [CoreSyn type and coercion invariant]</span><span>
</span><a name="line-431"></a><span>    </span><a href="#local-6989586621684747409"><span class="hs-identifier hs-var">post_inline_unconditionally</span></a><span>
</span><a name="line-432"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684747406"><span class="hs-identifier hs-var">env'</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747399"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747400"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747402"><span class="hs-identifier hs-var">out_rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-433"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-436"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621684747406"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747408"><span class="hs-identifier hs-var">out_bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747402"><span class="hs-identifier hs-var">out_rhs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-438"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747406"><a href="#local-6989586621684747406"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747407"><a href="#local-6989586621684747407"><span class="hs-identifier">bndr1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747401"><span class="hs-identifier hs-var">mb_out_bndr</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-439"></a><span>                      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747412"><a href="#local-6989586621684747412"><span class="hs-identifier">out_bndr</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747399"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747412"><span class="hs-identifier hs-var">out_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-440"></a><span>                      </span><span class="hs-identifier hs-var">Nothing</span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-6989586621684747399"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747400"><span class="hs-identifier hs-var">in_bndr</span></a><span>
</span><a name="line-441"></a><span>    </span><a name="local-6989586621684747408"><a href="#local-6989586621684747408"><span class="hs-identifier">out_bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#add_info"><span class="hs-identifier hs-var">add_info</span></a><span> </span><a href="#local-6989586621684747406"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684747400"><span class="hs-identifier hs-var">in_bndr</span></a><span> </span><a href="#local-6989586621684747407"><span class="hs-identifier hs-var">bndr1</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span>    </span><span class="hs-identifier">post_inline_unconditionally</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-444"></a><span>    </span><a name="local-6989586621684747409"><a href="#local-6989586621684747409"><span class="hs-identifier">post_inline_unconditionally</span></a></a><span>
</span><a name="line-445"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isExportedId"><span class="hs-identifier hs-var">isExportedId</span></a><span> </span><a href="#local-6989586621684747400"><span class="hs-identifier hs-var">in_bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- Note [Exported Ids and trivial RHSs]</span><span>
</span><a name="line-446"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684747405"><span class="hs-identifier hs-var">stable_unf</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- Note [Stable unfoldings and postInlineUnconditionally]</span><span>
</span><a name="line-447"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621684747404"><span class="hs-identifier hs-var">active</span></a><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">--     in SimplUtils</span><span>
</span><a name="line-448"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684747410"><span class="hs-identifier hs-var">is_loop_breaker</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- If it's a loop-breaker of any kind, don't inline</span><span>
</span><a name="line-449"></a><span>                                       </span><span class="hs-comment">-- because it might be referred to &quot;earlier&quot;</span><span>
</span><a name="line-450"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-6989586621684747402"><span class="hs-identifier hs-var">out_rhs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-451"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684747411"><span class="hs-identifier hs-var">coercible_hack</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-452"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-453"></a><span>
</span><a name="line-454"></a><span>    </span><a name="local-6989586621684747410"><a href="#local-6989586621684747410"><span class="hs-identifier">is_loop_breaker</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="BasicTypes.html#isWeakLoopBreaker"><span class="hs-identifier hs-var">isWeakLoopBreaker</span></a><span> </span><a href="#local-6989586621684747403"><span class="hs-identifier hs-var">occ_info</span></a><span>
</span><a name="line-455"></a><span>
</span><a name="line-456"></a><span>    </span><span class="hs-comment">-- See Note [Getting the map/coerce RULE to work]</span><span>
</span><a name="line-457"></a><span>    </span><a name="local-6989586621684747411"><a href="#local-6989586621684747411"><span class="hs-identifier">coercible_hack</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747413"><a href="#local-6989586621684747413"><span class="hs-identifier">fun</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747414"><a href="#local-6989586621684747414"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#collectArgs"><span class="hs-identifier hs-var">collectArgs</span></a><span> </span><a href="#local-6989586621684747402"><span class="hs-identifier hs-var">out_rhs</span></a><span>
</span><a name="line-458"></a><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747415"><a href="#local-6989586621684747415"><span class="hs-identifier">dc</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a><span> </span><a href="#local-6989586621684747413"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-459"></a><span>                   </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747415"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#heqDataConKey"><span class="hs-identifier hs-var">heqDataConKey</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684747415"><span class="hs-identifier hs-var">dc</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#coercibleDataConKey"><span class="hs-identifier hs-var">coercibleDataConKey</span></a><span>
</span><a name="line-460"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-6989586621684747414"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-461"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-462"></a><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-463"></a><span>
</span><a name="line-464"></a><span class="hs-comment">{- Note [Exported Ids and trivial RHSs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We obviously do not want to unconditionally inline an Id that is exported.
In SimplUtils, Note [Top level and postInlineUnconditionally], we
explain why we don't inline /any/ top-level things unconditionally, even
trivial ones.  But we do here!  Why?  In the simple optimiser

  * We do no rule rewrites
  * We do no call-site inlining

Those differences obviate the reasons for not inlining a trivial rhs,
and increase the benefit for doing so.  So we unconditionally inline trivial
rhss here.

Note [Preserve join-binding arity]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Be careful /not/ to eta-reduce the RHS of a join point, lest we lose
the join-point arity invariant.  Trac #15108 was caused by simplifying
the RHS with simple_opt_expr, which does eta-reduction.  Solution:
simplify the RHS of a join point by simplifying under the lambdas
(which of course should be there).
-}</span><span>
</span><a name="line-486"></a><span>
</span><a name="line-487"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-488"></a><span class="hs-identifier">subst_opt_bndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-489"></a><a name="subst_opt_bndrs"><a href="CoreOpt.html#subst_opt_bndrs"><span class="hs-identifier">subst_opt_bndrs</span></a></a><span> </span><a name="local-6989586621684747416"><a href="#local-6989586621684747416"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747417"><a href="#local-6989586621684747417"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="CoreOpt.html#subst_opt_bndr"><span class="hs-identifier hs-var">subst_opt_bndr</span></a><span> </span><a href="#local-6989586621684747416"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747417"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span class="hs-identifier">subst_opt_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-492"></a><a name="subst_opt_bndr"><a href="CoreOpt.html#subst_opt_bndr"><span class="hs-identifier">subst_opt_bndr</span></a></a><span> </span><a name="local-6989586621684747418"><a href="#local-6989586621684747418"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747419"><a href="#local-6989586621684747419"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-493"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684747419"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747418"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747421"><span class="hs-identifier hs-var">subst_tv</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747422"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-494"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684747419"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747418"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747423"><span class="hs-identifier hs-var">subst_cv</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747424"><span class="hs-identifier hs-var">cv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#subst_opt_id_bndr"><span class="hs-identifier hs-var">subst_opt_id_bndr</span></a><span> </span><a href="#local-6989586621684747418"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747419"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-496"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-497"></a><span>    </span><a name="local-6989586621684747420"><a href="#local-6989586621684747420"><span class="hs-identifier">subst</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747418"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-498"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747421"><a href="#local-6989586621684747421"><span class="hs-identifier">subst_tv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747422"><a href="#local-6989586621684747422"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><a href="#local-6989586621684747420"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747419"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-499"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684747423"><a href="#local-6989586621684747423"><span class="hs-identifier">subst_cv</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747424"><a href="#local-6989586621684747424"><span class="hs-identifier">cv'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><a href="#local-6989586621684747420"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747419"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-500"></a><span>
</span><a name="line-501"></a><span class="hs-identifier">subst_opt_id_bndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InId"><span class="hs-identifier hs-type">InId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#OutId"><span class="hs-identifier hs-type">OutId</span></a><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span class="hs-comment">-- Nuke all fragile IdInfo, unfolding, and RULES;</span><span>
</span><a name="line-503"></a><span class="hs-comment">--    it gets added back later by add_info</span><span>
</span><a name="line-504"></a><span class="hs-comment">-- Rather like SimplEnv.substIdBndr</span><span>
</span><a name="line-505"></a><span class="hs-comment">--</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- It's important to zap fragile OccInfo (which CoreSubst.substIdBndr</span><span>
</span><a name="line-507"></a><span class="hs-comment">-- carefully does not do) because simplOptExpr invalidates it</span><span>
</span><a name="line-508"></a><span>
</span><a name="line-509"></a><a name="subst_opt_id_bndr"><a href="CoreOpt.html#subst_opt_id_bndr"><span class="hs-identifier">subst_opt_id_bndr</span></a></a><span> </span><a name="local-6989586621684747425"><a href="#local-6989586621684747425"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreOpt.html#SOE"><span class="hs-identifier hs-var">SOE</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747426"><a href="#local-6989586621684747426"><span class="hs-identifier">subst</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747427"><a href="#local-6989586621684747427"><span class="hs-identifier">inl</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684747428"><a href="#local-6989586621684747428"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-510"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747425"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747439"><span class="hs-identifier hs-var">new_subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">soe_inl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747440"><span class="hs-identifier hs-var">new_inl</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747435"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-511"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-512"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684747429"><a href="#local-6989586621684747429"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684747430"><a href="#local-6989586621684747430"><span class="hs-identifier">id_subst</span></a></a><span> </span><a name="local-6989586621684747431"><a href="#local-6989586621684747431"><span class="hs-identifier">tv_subst</span></a></a><span> </span><a name="local-6989586621684747432"><a href="#local-6989586621684747432"><span class="hs-identifier">cv_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747426"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-513"></a><span>
</span><a name="line-514"></a><span>    </span><a name="local-6989586621684747433"><a href="#local-6989586621684747433"><span class="hs-identifier">id1</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><a href="#local-6989586621684747429"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684747428"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-515"></a><span>    </span><a name="local-6989586621684747434"><a href="#local-6989586621684747434"><span class="hs-identifier">id2</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span> </span><a href="#local-6989586621684747433"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684747426"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684747428"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>    </span><a name="local-6989586621684747435"><a href="#local-6989586621684747435"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#zapFragileIdInfo"><span class="hs-identifier hs-var">zapFragileIdInfo</span></a><span> </span><a href="#local-6989586621684747434"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-517"></a><span>             </span><span class="hs-comment">-- Zaps rules, unfolding, and fragile OccInfo</span><span>
</span><a name="line-518"></a><span>             </span><span class="hs-comment">-- The unfolding and rules will get added back later, by add_info</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span>    </span><a name="local-6989586621684747436"><a href="#local-6989586621684747436"><span class="hs-identifier">new_in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747429"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747435"><span class="hs-identifier hs-var">new_id</span></a><span>
</span><a name="line-521"></a><span>
</span><a name="line-522"></a><span>    </span><a name="local-6989586621684747437"><a href="#local-6989586621684747437"><span class="hs-identifier">no_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747435"><span class="hs-identifier hs-var">new_id</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684747428"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span>        </span><span class="hs-comment">-- Extend the substitution if the unique has changed,</span><span>
</span><a name="line-525"></a><span>        </span><span class="hs-comment">-- See the notes with substTyVarBndr for the delSubstEnv</span><span>
</span><a name="line-526"></a><span>    </span><a name="local-6989586621684747438"><a href="#local-6989586621684747438"><span class="hs-identifier">new_id_subst</span></a></a><span>
</span><a name="line-527"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684747437"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-6989586621684747430"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621684747428"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-528"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684747430"><span class="hs-identifier hs-var">id_subst</span></a><span> </span><a href="#local-6989586621684747428"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684747435"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span>
</span><a name="line-530"></a><span>    </span><a name="local-6989586621684747439"><a href="#local-6989586621684747439"><span class="hs-identifier">new_subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684747436"><span class="hs-identifier hs-var">new_in_scope</span></a><span> </span><a href="#local-6989586621684747438"><span class="hs-identifier hs-var">new_id_subst</span></a><span> </span><a href="#local-6989586621684747431"><span class="hs-identifier hs-var">tv_subst</span></a><span> </span><a href="#local-6989586621684747432"><span class="hs-identifier hs-var">cv_subst</span></a><span>
</span><a name="line-531"></a><span>    </span><a name="local-6989586621684747440"><a href="#local-6989586621684747440"><span class="hs-identifier">new_inl</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-6989586621684747427"><span class="hs-identifier hs-var">inl</span></a><span> </span><a href="#local-6989586621684747428"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-532"></a><span>
</span><a name="line-533"></a><span class="hs-comment">----------------------</span><span>
</span><a name="line-534"></a><span class="hs-identifier">add_info</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreOpt.html#SimpleOptEnv"><span class="hs-identifier hs-type">SimpleOptEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#InVar"><span class="hs-identifier hs-type">InVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#OutVar"><span class="hs-identifier hs-type">OutVar</span></a><span>
</span><a name="line-535"></a><a name="add_info"><a href="CoreOpt.html#add_info"><span class="hs-identifier">add_info</span></a></a><span> </span><a name="local-6989586621684747441"><a href="#local-6989586621684747441"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684747442"><a href="#local-6989586621684747442"><span class="hs-identifier">old_bndr</span></a></a><span> </span><a name="local-6989586621684747443"><a href="#local-6989586621684747443"><span class="hs-identifier">new_bndr</span></a></a><span>
</span><a name="line-536"></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684747442"><span class="hs-identifier hs-var">old_bndr</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747443"><span class="hs-identifier hs-var">new_bndr</span></a><span>
</span><a name="line-537"></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a><span> </span><a href="#local-6989586621684747445"><span class="hs-identifier hs-var">mb_new_info</span></a><span> </span><a href="#local-6989586621684747443"><span class="hs-identifier hs-var">new_bndr</span></a><span>
</span><a name="line-538"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-539"></a><span>   </span><a name="local-6989586621684747444"><a href="#local-6989586621684747444"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">soe_subst</span><span> </span><a href="#local-6989586621684747441"><span class="hs-identifier hs-var">env</span></a><span>
</span><a name="line-540"></a><span>   </span><a name="local-6989586621684747445"><a href="#local-6989586621684747445"><span class="hs-identifier">mb_new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span> </span><a href="#local-6989586621684747444"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747443"><span class="hs-identifier hs-var">new_bndr</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621684747442"><span class="hs-identifier hs-var">old_bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><span class="hs-identifier">simpleUnfoldingFun</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#IdUnfoldingFun"><span class="hs-identifier hs-type">IdUnfoldingFun</span></a><span>
</span><a name="line-543"></a><a name="simpleUnfoldingFun"><a href="CoreOpt.html#simpleUnfoldingFun"><span class="hs-identifier">simpleUnfoldingFun</span></a></a><span> </span><a name="local-6989586621684747446"><a href="#local-6989586621684747446"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-544"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#isAlwaysActive"><span class="hs-identifier hs-var">isAlwaysActive</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idInlineActivation"><span class="hs-identifier hs-var">idInlineActivation</span></a><span> </span><a href="#local-6989586621684747446"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idUnfolding"><span class="hs-identifier hs-var">idUnfolding</span></a><span> </span><a href="#local-6989586621684747446"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-545"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                              </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#noUnfolding"><span class="hs-identifier hs-var">noUnfolding</span></a><span>
</span><a name="line-546"></a><span>
</span><a name="line-547"></a><span class="hs-identifier">wrapLet</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-548"></a><a name="wrapLet"><a href="CoreOpt.html#wrapLet"><span class="hs-identifier">wrapLet</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span>      </span><a name="local-6989586621684747447"><a href="#local-6989586621684747447"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747447"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-549"></a><span class="hs-identifier">wrapLet</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747448"><a href="#local-6989586621684747448"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747449"><a href="#local-6989586621684747449"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684747450"><a href="#local-6989586621684747450"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684747448"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684747449"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747450"><span class="hs-identifier hs-var">body</span></a><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-comment">{-
Note [Inline prag in simplOpt]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If there's an INLINE/NOINLINE pragma that restricts the phase in
which the binder can be inlined, we don't inline here; after all,
we don't know what phase we're in.  Here's an example

  foo :: Int -&gt; Int -&gt; Int
  {-# INLINE foo #-}
  foo m n = inner m
     where
       {-# INLINE [1] inner #-}
       inner m = m+n

  bar :: Int -&gt; Int
  bar n = foo n 1

When inlining 'foo' in 'bar' we want the let-binding for 'inner'
to remain visible until Phase 1

Note [Unfold compulsory unfoldings in LHSs]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When the user writes `RULES map coerce = coerce` as a rule, the rule
will only ever match if simpleOptExpr replaces coerce by its unfolding
on the LHS, because that is the core that the rule matching engine
will find. So do that for everything that has a compulsory
unfolding. Also see Note [Desugaring coerce as cast] in Desugar.

However, we don't want to inline 'seq', which happens to also have a
compulsory unfolding, so we only do this unfolding only for things
that are always-active.  See Note [User-defined RULES for seq] in MkId.

Note [Getting the map/coerce RULE to work]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We wish to allow the &quot;map/coerce&quot; RULE to fire:

  {-# RULES &quot;map/coerce&quot; map coerce = coerce #-}

The naive core produced for this is

  forall a b (dict :: Coercible * a b).
    map @a @b (coerce @a @b @dict) = coerce @[a] @[b] @dict'

  where dict' :: Coercible [a] [b]
        dict' = ...

This matches literal uses of `map coerce` in code, but that's not what we
want. We want it to match, say, `map MkAge` (where newtype Age = MkAge Int)
too. Some of this is addressed by compulsorily unfolding coerce on the LHS,
yielding

  forall a b (dict :: Coercible * a b).
    map @a @b (\(x :: a) -&gt; case dict of
      MkCoercible (co :: a ~R# b) -&gt; x |&gt; co) = ...

Getting better. But this isn't exactly what gets produced. This is because
Coercible essentially has ~R# as a superclass, and superclasses get eagerly
extracted during solving. So we get this:

  forall a b (dict :: Coercible * a b).
    case Coercible_SCSel @* @a @b dict of
      _ [Dead] -&gt; map @a @b (\(x :: a) -&gt; case dict of
                               MkCoercible (co :: a ~R# b) -&gt; x |&gt; co) = ...

Unfortunately, this still abstracts over a Coercible dictionary. We really
want it to abstract over the ~R# evidence. So, we have Desugar.unfold_coerce,
which transforms the above to (see also Note [Desugaring coerce as cast] in
Desugar)

  forall a b (co :: a ~R# b).
    let dict = MkCoercible @* @a @b co in
    case Coercible_SCSel @* @a @b dict of
      _ [Dead] -&gt; map @a @b (\(x :: a) -&gt; case dict of
         MkCoercible (co :: a ~R# b) -&gt; x |&gt; co) = let dict = ... in ...

Now, we need simpleOptExpr to fix this up. It does so by taking three
separate actions:
  1. Inline certain non-recursive bindings. The choice whether to inline
     is made in simple_bind_pair. Note the rather specific check for
     MkCoercible in there.

  2. Stripping case expressions like the Coercible_SCSel one.
     See the `Case` case of simple_opt_expr's `go` function.

  3. Look for case expressions that unpack something that was
     just packed and inline them. This is also done in simple_opt_expr's
     `go` function.

This is all a fair amount of special-purpose hackery, but it's for
a good cause. And it won't hurt other RULES and such that it comes across.


************************************************************************
*                                                                      *
                Join points
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">-- | Returns Just (bndr,rhs) if the binding is a join point:</span><span>
</span><a name="line-651"></a><span class="hs-comment">-- If it's a JoinId, just return it</span><span>
</span><a name="line-652"></a><span class="hs-comment">-- If it's not yet a JoinId but is always tail-called,</span><span>
</span><a name="line-653"></a><span class="hs-comment">--    make it into a JoinId and return it.</span><span>
</span><a name="line-654"></a><span class="hs-comment">-- In the latter case, eta-expand the RHS if necessary, to make the</span><span>
</span><a name="line-655"></a><span class="hs-comment">-- lambdas explicit, as is required for join points</span><span>
</span><a name="line-656"></a><span class="hs-comment">--</span><span>
</span><a name="line-657"></a><span class="hs-comment">-- Precondition: the InBndr has been occurrence-analysed,</span><span>
</span><a name="line-658"></a><span class="hs-comment">--               so its OccInfo is valid</span><span>
</span><a name="line-659"></a><span class="hs-identifier">joinPointBinding_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-660"></a><a name="joinPointBinding_maybe"><a href="CoreOpt.html#joinPointBinding_maybe"><span class="hs-identifier">joinPointBinding_maybe</span></a></a><span> </span><a name="local-6989586621684747451"><a href="#local-6989586621684747451"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684747452"><a href="#local-6989586621684747452"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684747451"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-662"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-663"></a><span>
</span><a name="line-664"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#isJoinId"><span class="hs-identifier hs-var">isJoinId</span></a><span> </span><a href="#local-6989586621684747451"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-665"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747451"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747452"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="BasicTypes.html#AlwaysTailCalled"><span class="hs-identifier hs-var">AlwaysTailCalled</span></a><span> </span><a name="local-6989586621684747453"><a href="#local-6989586621684747453"><span class="hs-identifier">join_arity</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="BasicTypes.html#tailCallInfo"><span class="hs-identifier hs-var">tailCallInfo</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idOccInfo"><span class="hs-identifier hs-var">idOccInfo</span></a><span> </span><a href="#local-6989586621684747451"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">)</span><span>
</span><a name="line-668"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747454"><a href="#local-6989586621684747454"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747455"><a href="#local-6989586621684747455"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreArity.html#etaExpandToJoinPoint"><span class="hs-identifier hs-var">etaExpandToJoinPoint</span></a><span> </span><a href="#local-6989586621684747453"><span class="hs-identifier hs-var">join_arity</span></a><span> </span><a href="#local-6989586621684747452"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-669"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747456"><a href="#local-6989586621684747456"><span class="hs-identifier">str_sig</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idStrictness"><span class="hs-identifier hs-var">idStrictness</span></a><span> </span><a href="#local-6989586621684747451"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-670"></a><span>        </span><a name="local-6989586621684747457"><a href="#local-6989586621684747457"><span class="hs-identifier">str_arity</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684747454"><span class="hs-identifier hs-var">bndrs</span></a><span>  </span><span class="hs-comment">-- Strictness demands are for Ids only</span><span>
</span><a name="line-671"></a><span>        </span><a name="local-6989586621684747458"><a href="#local-6989586621684747458"><span class="hs-identifier">join_bndr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747451"><span class="hs-identifier hs-var">bndr</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#asJoinId"><span class="hs-identifier hs-var">asJoinId</span></a><span class="hs-special">`</span><span>        </span><a href="#local-6989586621684747453"><span class="hs-identifier hs-var">join_arity</span></a><span>
</span><a name="line-672"></a><span>                         </span><span class="hs-special">`</span><a href="Id.html#setIdStrictness"><span class="hs-identifier hs-var">setIdStrictness</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#etaExpandStrictSig"><span class="hs-identifier hs-var">etaExpandStrictSig</span></a><span> </span><a href="#local-6989586621684747457"><span class="hs-identifier hs-var">str_arity</span></a><span> </span><a href="#local-6989586621684747456"><span class="hs-identifier hs-var">str_sig</span></a><span>
</span><a name="line-673"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747458"><span class="hs-identifier hs-var">join_bndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#mkLams"><span class="hs-identifier hs-var">mkLams</span></a><span> </span><a href="#local-6989586621684747454"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><a href="#local-6989586621684747455"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-674"></a><span>
</span><a name="line-675"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-676"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-677"></a><span>
</span><a name="line-678"></a><span class="hs-identifier">joinPointBindings_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="CoreSyn.html#InBndr"><span class="hs-identifier hs-type">InBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#InExpr"><span class="hs-identifier hs-type">InExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-679"></a><a name="joinPointBindings_maybe"><a href="CoreOpt.html#joinPointBindings_maybe"><span class="hs-identifier">joinPointBindings_maybe</span></a></a><span> </span><a name="local-6989586621684747459"><a href="#local-6989586621684747459"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-680"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">uncurry</span><span> </span><a href="CoreOpt.html#joinPointBinding_maybe"><span class="hs-identifier hs-var">joinPointBinding_maybe</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747459"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-681"></a><span>
</span><a name="line-682"></a><span>
</span><a name="line-683"></a><span class="hs-comment">{- Note [Strictness and join points]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Suppose we have

   let f = \x.  if x&gt;200 then e1 else e1

and we know that f is strict in x.  Then if we subsequently
discover that f is an arity-2 join point, we'll eta-expand it to

   let f = \x y.  if x&gt;200 then e1 else e1

and now it's only strict if applied to two arguments.  So we should
adjust the strictness info.

A more common case is when

   f = \x. error &quot;..&quot;

and again its arity increses (Trac #15517)
-}</span><span>
</span><a name="line-703"></a><span>
</span><a name="line-704"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
         exprIsConApp_maybe
*                                                                      *
************************************************************************

Note [exprIsConApp_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~
exprIsConApp_maybe is a very important function.  There are two principal
uses:
  * case e of { .... }
  * cls_op e, where cls_op is a class operation

In both cases you want to know if e is of form (C e1..en) where C is
a data constructor.

However e might not *look* as if


Note [exprIsConApp_maybe on literal strings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
See #9400 and #13317.

Conceptually, a string literal &quot;abc&quot; is just ('a':'b':'c':[]), but in Core
they are represented as unpackCString# &quot;abc&quot;# by MkCore.mkStringExprFS, or
unpackCStringUtf8# when the literal contains multi-byte UTF8 characters.

For optimizations we want to be able to treat it as a list, so they can be
decomposed when used in a case-statement. exprIsConApp_maybe detects those
calls to unpackCString# and returns:

Just (':', [Char], ['a', unpackCString# &quot;bc&quot;]).

We need to be careful about UTF8 strings here. &quot;&quot;# contains a ByteString, so
we must parse it back into a FastString to split off the first character.
That way we can treat unpackCString# and unpackCStringUtf8# in the same way.

We must also be caeful about
   lvl = &quot;foo&quot;#
   ...(unpackCString# lvl)...
to ensure that we see through the let-binding for 'lvl'.  Hence the
(exprIsLiteral_maybe .. arg) in the guard before the call to
dealWithStringLiteral.

Note [Push coercions in exprIsConApp_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In Trac #13025 I found a case where we had
    op (df @t1 @t2)     -- op is a ClassOp
where
    df = (/\a b. K e1 e2) |&gt; g

To get this to come out we need to simplify on the fly
   ((/\a b. K e1 e2) |&gt; g) @t1 @t2

Hence the use of pushCoArgs.
-}</span><span>
</span><a name="line-760"></a><span>
</span><a name="line-761"></a><span class="hs-keyword">data</span><span> </span><a name="ConCont"><a href="CoreOpt.html#ConCont"><span class="hs-identifier">ConCont</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CC"><a href="CoreOpt.html#CC"><span class="hs-identifier">CC</span></a></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-762"></a><span>                  </span><span class="hs-comment">-- Substitution already applied</span><span>
</span><a name="line-763"></a><span>
</span><a name="line-764"></a><span class="hs-comment">-- | Returns @Just (dc, [t1..tk], [x1..xn])@ if the argument expression is</span><span>
</span><a name="line-765"></a><span class="hs-comment">-- a *saturated* constructor application of the form @dc t1..tk x1 .. xn@,</span><span>
</span><a name="line-766"></a><span class="hs-comment">-- where t1..tk are the *universally-quantified* type args of 'dc'</span><span>
</span><a name="line-767"></a><span class="hs-identifier">exprIsConApp_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><a name="exprIsConApp_maybe"><a href="CoreOpt.html#exprIsConApp_maybe"><span class="hs-identifier">exprIsConApp_maybe</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747460"><a href="#local-6989586621684747460"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747461"><a href="#local-6989586621684747461"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747462"><a href="#local-6989586621684747462"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-769"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621684747460"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747462"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span> </span><span class="hs-special">(</span><a href="CoreUtils.html#exprType"><span class="hs-identifier hs-var">exprType</span></a><span> </span><a href="#local-6989586621684747462"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-770"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-771"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-772"></a><span>             </span><span class="hs-comment">-- Left in-scope  means &quot;empty substitution&quot;</span><span>
</span><a name="line-773"></a><span>             </span><span class="hs-comment">-- Right subst    means &quot;apply this substitution to the CoreExpr&quot;</span><span>
</span><a name="line-774"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#ConCont"><span class="hs-identifier hs-type">ConCont</span></a><span>
</span><a name="line-775"></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-776"></a><span>    </span><a name="local-6989586621684747463"><a href="#local-6989586621684747463"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684747467"><a href="#local-6989586621684747467"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684747468"><a href="#local-6989586621684747468"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684747469"><a href="#local-6989586621684747469"><span class="hs-identifier">expr</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747470"><a href="#local-6989586621684747470"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-777"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#tickishIsCode"><span class="hs-identifier hs-var">tickishIsCode</span></a><span> </span><a href="#local-6989586621684747468"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747467"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747469"><span class="hs-identifier hs-var">expr</span></a><span> </span><a href="#local-6989586621684747470"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-778"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684747471"><a href="#local-6989586621684747471"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684747472"><a href="#local-6989586621684747472"><span class="hs-identifier">expr</span></a></a><span> </span><a name="local-6989586621684747473"><a href="#local-6989586621684747473"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a name="local-6989586621684747474"><a href="#local-6989586621684747474"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684747475"><a href="#local-6989586621684747475"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-779"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747476"><a href="#local-6989586621684747476"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747477"><a href="#local-6989586621684747477"><span class="hs-identifier">m_co1'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoArgs"><span class="hs-identifier hs-var">pushCoArgs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747464"><span class="hs-identifier hs-var">subst_co</span></a><span> </span><a href="#local-6989586621684747471"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747473"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747474"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-780"></a><span>            </span><span class="hs-comment">-- See Note [Push coercions in exprIsConApp_maybe]</span><span>
</span><a name="line-781"></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747477"><span class="hs-identifier hs-var">m_co1'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-782"></a><span>           </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621684747478"><a href="#local-6989586621684747478"><span class="hs-identifier">co1'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747471"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747472"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a href="#local-6989586621684747476"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747478"><span class="hs-identifier hs-var">co1'</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747475"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-783"></a><span>           </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747471"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747472"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a href="#local-6989586621684747476"><span class="hs-identifier hs-var">args'</span></a><span> </span><a href="#local-6989586621684747475"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-784"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684747479"><a href="#local-6989586621684747479"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684747480"><a href="#local-6989586621684747480"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621684747481"><a href="#local-6989586621684747481"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a name="local-6989586621684747482"><a href="#local-6989586621684747482"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684747483"><a href="#local-6989586621684747483"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684747479"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747480"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747465"><span class="hs-identifier hs-var">subst_arg</span></a><span> </span><a href="#local-6989586621684747479"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747481"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684747482"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747483"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-786"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684747484"><a href="#local-6989586621684747484"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684747485"><a href="#local-6989586621684747485"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684747486"><a href="#local-6989586621684747486"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747487"><a href="#local-6989586621684747487"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684747488"><a href="#local-6989586621684747488"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747489"><a href="#local-6989586621684747489"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-787"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="CoreUtils.html#exprIsTrivial"><span class="hs-identifier hs-var">exprIsTrivial</span></a><span> </span><a href="#local-6989586621684747487"><span class="hs-identifier hs-var">arg</span></a><span>          </span><span class="hs-comment">-- Don't duplicate stuff!</span><span>
</span><a name="line-788"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747466"><span class="hs-identifier hs-var">extend</span></a><span> </span><a href="#local-6989586621684747484"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747485"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684747487"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747486"><span class="hs-identifier hs-var">body</span></a><span> </span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a href="#local-6989586621684747488"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684747489"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-789"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621684747490"><a href="#local-6989586621684747490"><span class="hs-identifier">sub</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747491"><a href="#local-6989586621684747491"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747492"><a href="#local-6989586621684747492"><span class="hs-identifier">cont</span></a></a><span>
</span><a name="line-790"></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span> </span><a href="#local-6989586621684747490"><span class="hs-identifier hs-var">sub</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-791"></a><span>            </span><span class="hs-special">(</span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exprIsConApp&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747462"><span class="hs-identifier hs-var">expr</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747490"><span class="hs-identifier hs-var">sub</span></a><span> </span><a href="#local-6989586621684747491"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-792"></a><span>            </span><a href="#local-6989586621684747492"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-793"></a><span>
</span><a name="line-794"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621684747493"><a href="#local-6989586621684747493"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747494"><a href="#local-6989586621684747494"><span class="hs-identifier">fun</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747495"><a href="#local-6989586621684747495"><span class="hs-identifier">cont</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreOpt.html#CC"><span class="hs-identifier hs-var">CC</span></a><span> </span><a name="local-6989586621684747496"><a href="#local-6989586621684747496"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621684747497"><a href="#local-6989586621684747497"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-795"></a><span>
</span><a name="line-796"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747499"><a href="#local-6989586621684747499"><span class="hs-identifier">con</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Id.html#isDataConWorkId_maybe"><span class="hs-identifier hs-var">isDataConWorkId_maybe</span></a><span> </span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-797"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span> </span><a href="#local-6989586621684747496"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-798"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#pushCoDataCon"><span class="hs-identifier hs-var">pushCoDataCon</span></a><span> </span><a href="#local-6989586621684747499"><span class="hs-identifier hs-var">con</span></a><span> </span><a href="#local-6989586621684747496"><span class="hs-identifier hs-var">args</span></a><span> </span><a href="#local-6989586621684747497"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-799"></a><span>
</span><a name="line-800"></a><span>        </span><span class="hs-comment">-- Look through dictionary functions; see Note [Unfolding DFuns]</span><span>
</span><a name="line-801"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747500"><a href="#local-6989586621684747500"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_con</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747501"><a href="#local-6989586621684747501"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684747502"><a href="#local-6989586621684747502"><span class="hs-identifier">dfun_args</span></a></a><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684747498"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-802"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747500"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><a href="Util.html#equalLength"><span class="hs-identifier hs-var">equalLength</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747496"><span class="hs-identifier hs-var">args</span></a><span>    </span><span class="hs-comment">-- See Note [DFun arity check]</span><span>
</span><a name="line-803"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747503"><a href="#local-6989586621684747503"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#mkOpenSubst"><span class="hs-identifier hs-var">mkOpenSubst</span></a><span> </span><a href="#local-6989586621684747493"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747500"><span class="hs-identifier hs-var">bndrs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747496"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">)</span><span>
</span><a name="line-804"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#pushCoDataCon"><span class="hs-identifier hs-var">pushCoDataCon</span></a><span> </span><a href="#local-6989586621684747501"><span class="hs-identifier hs-var">con</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exprIsConApp1&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747503"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747502"><span class="hs-identifier hs-var">dfun_args</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747497"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-805"></a><span>
</span><a name="line-806"></a><span>        </span><span class="hs-comment">-- Look through unfoldings, but only arity-zero one;</span><span>
</span><a name="line-807"></a><span>        </span><span class="hs-comment">-- if arity &gt; 0 we are effectively inlining a function call,</span><span>
</span><a name="line-808"></a><span>        </span><span class="hs-comment">-- and that is the business of callSiteInline.</span><span>
</span><a name="line-809"></a><span>        </span><span class="hs-comment">-- In practice, without this test, most of the &quot;hits&quot; were</span><span>
</span><a name="line-810"></a><span>        </span><span class="hs-comment">-- CPR'd workers getting inlined back into their wrappers,</span><span>
</span><a name="line-811"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-812"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747504"><a href="#local-6989586621684747504"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><a href="#local-6989586621684747498"><span class="hs-identifier hs-var">unfolding</span></a><span>
</span><a name="line-813"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747505"><a href="#local-6989586621684747505"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a><span> </span><a href="#local-6989586621684747493"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="CoreFVs.html#exprFreeVars"><span class="hs-identifier hs-var">exprFreeVars</span></a><span> </span><a href="#local-6989586621684747504"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-814"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747463"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a href="#local-6989586621684747505"><span class="hs-identifier hs-var">in_scope'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747504"><span class="hs-identifier hs-var">rhs</span></a><span> </span><a href="#local-6989586621684747495"><span class="hs-identifier hs-var">cont</span></a><span>
</span><a name="line-815"></a><span>
</span><a name="line-816"></a><span>        </span><span class="hs-comment">-- See Note [exprIsConApp_maybe on literal strings]</span><span>
</span><a name="line-817"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#unpackCStringIdKey"><span class="hs-identifier hs-var">unpackCStringIdKey</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-818"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span> </span><span class="hs-special">`</span><a href="Unique.html#hasKey"><span class="hs-identifier hs-var">hasKey</span></a><span class="hs-special">`</span><span> </span><a href="PrelNames.html#unpackCStringUtf8IdKey"><span class="hs-identifier hs-var">unpackCStringUtf8IdKey</span></a><span class="hs-special">)</span><span>
</span><a name="line-819"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a name="local-6989586621684747506"><a href="#local-6989586621684747506"><span class="hs-identifier">arg</span></a></a><span class="hs-special">]</span><span>                </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684747496"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-820"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Literal.html#LitString"><span class="hs-identifier hs-var">LitString</span></a><span> </span><a name="local-6989586621684747507"><a href="#local-6989586621684747507"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747493"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747461"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747506"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-821"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#dealWithStringLiteral"><span class="hs-identifier hs-var">dealWithStringLiteral</span></a><span> </span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span> </span><a href="#local-6989586621684747507"><span class="hs-identifier hs-var">str</span></a><span> </span><a href="#local-6989586621684747497"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-822"></a><span>        </span><span class="hs-keyword">where</span><span>
</span><a name="line-823"></a><span>          </span><a name="local-6989586621684747498"><a href="#local-6989586621684747498"><span class="hs-identifier">unfolding</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747461"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><a href="#local-6989586621684747494"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-824"></a><span>
</span><a name="line-825"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-826"></a><span>
</span><a name="line-827"></a><span>    </span><span class="hs-comment">----------------------------</span><span>
</span><a name="line-828"></a><span>    </span><span class="hs-comment">-- Operations on the (Either InScopeSet CoreSubst)</span><span>
</span><a name="line-829"></a><span>    </span><span class="hs-comment">-- The Left case is wildly dominant</span><span>
</span><a name="line-830"></a><span>    </span><a name="local-6989586621684747464"><a href="#local-6989586621684747464"><span class="hs-identifier">subst_co</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684747508"><a href="#local-6989586621684747508"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747508"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-831"></a><span>    </span><span class="hs-identifier">subst_co</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621684747509"><a href="#local-6989586621684747509"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747510"><a href="#local-6989586621684747510"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">CoreSubst.substCo</span></a><span> </span><a href="#local-6989586621684747509"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621684747510"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span>    </span><a name="local-6989586621684747465"><a href="#local-6989586621684747465"><span class="hs-identifier">subst_arg</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684747511"><a href="#local-6989586621684747511"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747511"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-834"></a><span>    </span><span class="hs-identifier">subst_arg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621684747512"><a href="#local-6989586621684747512"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747513"><a href="#local-6989586621684747513"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exprIsConApp2&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747512"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621684747513"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-835"></a><span>
</span><a name="line-836"></a><span>    </span><a name="local-6989586621684747466"><a href="#local-6989586621684747466"><span class="hs-identifier">extend</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621684747514"><a href="#local-6989586621684747514"><span class="hs-identifier">in_scope</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747515"><a href="#local-6989586621684747515"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684747516"><a href="#local-6989586621684747516"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-6989586621684747514"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747515"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684747516"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-837"></a><span>    </span><span class="hs-identifier">extend</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621684747517"><a href="#local-6989586621684747517"><span class="hs-identifier">s</span></a></a><span class="hs-special">)</span><span>       </span><a name="local-6989586621684747518"><a href="#local-6989586621684747518"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684747519"><a href="#local-6989586621684747519"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span> </span><a href="#local-6989586621684747517"><span class="hs-identifier hs-var">s</span></a><span> </span><a href="#local-6989586621684747518"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684747519"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>
</span><a name="line-839"></a><span>
</span><a name="line-840"></a><span class="hs-comment">-- See Note [exprIsConApp_maybe on literal strings]</span><span>
</span><a name="line-841"></a><span class="hs-identifier">dealWithStringLiteral</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">BS.ByteString</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-842"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-843"></a><span>
</span><a name="line-844"></a><span class="hs-comment">-- This is not possible with user-supplied empty literals, MkCore.mkStringExprFS</span><span>
</span><a name="line-845"></a><span class="hs-comment">-- turns those into [] automatically, but just in case something else in GHC</span><span>
</span><a name="line-846"></a><span class="hs-comment">-- generates a string literal directly.</span><span>
</span><a name="line-847"></a><a name="dealWithStringLiteral"><a href="CoreOpt.html#dealWithStringLiteral"><span class="hs-identifier">dealWithStringLiteral</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621684747520"><a href="#local-6989586621684747520"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621684747521"><a href="#local-6989586621684747521"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-848"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">BS.null</span><span> </span><a href="#local-6989586621684747520"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-849"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#pushCoDataCon"><span class="hs-identifier hs-var">pushCoDataCon</span></a><span> </span><a href="TysWiredIn.html#nilDataCon"><span class="hs-identifier hs-var">nilDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="TysWiredIn.html#charTy"><span class="hs-identifier hs-var">charTy</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684747521"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span class="hs-identifier">dealWithStringLiteral</span><span> </span><a name="local-6989586621684747522"><a href="#local-6989586621684747522"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621684747523"><a href="#local-6989586621684747523"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621684747524"><a href="#local-6989586621684747524"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-852"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747525"><a href="#local-6989586621684747525"><span class="hs-identifier">strFS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastStringByteString"><span class="hs-identifier hs-var">mkFastStringByteString</span></a><span> </span><a href="#local-6989586621684747523"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-853"></a><span>
</span><a name="line-854"></a><span>        </span><a name="local-6989586621684747526"><a href="#local-6989586621684747526"><span class="hs-identifier">char</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="TysWiredIn.html#charDataCon"><span class="hs-identifier hs-var">charDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#mkCharLit"><span class="hs-identifier hs-var">mkCharLit</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#headFS"><span class="hs-identifier hs-var">headFS</span></a><span> </span><a href="#local-6989586621684747525"><span class="hs-identifier hs-var">strFS</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-855"></a><span>        </span><a name="local-6989586621684747527"><a href="#local-6989586621684747527"><span class="hs-identifier">charTail</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#fastStringToByteString"><span class="hs-identifier hs-var">fastStringToByteString</span></a><span> </span><span class="hs-special">(</span><a href="FastString.html#tailFS"><span class="hs-identifier hs-var">tailFS</span></a><span> </span><a href="#local-6989586621684747525"><span class="hs-identifier hs-var">strFS</span></a><span class="hs-special">)</span><span>
</span><a name="line-856"></a><span>
</span><a name="line-857"></a><span>        </span><span class="hs-comment">-- In singleton strings, just add [] instead of unpackCstring# &quot;&quot;#.</span><span>
</span><a name="line-858"></a><span>        </span><a name="local-6989586621684747528"><a href="#local-6989586621684747528"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">BS.null</span><span> </span><a href="#local-6989586621684747527"><span class="hs-identifier hs-var">charTail</span></a><span>
</span><a name="line-859"></a><span>                 </span><span class="hs-keyword">then</span><span> </span><a href="CoreSyn.html#mkConApp"><span class="hs-identifier hs-var">mkConApp</span></a><span> </span><a href="TysWiredIn.html#nilDataCon"><span class="hs-identifier hs-var">nilDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="TysWiredIn.html#charTy"><span class="hs-identifier hs-var">charTy</span></a><span class="hs-special">]</span><span>
</span><a name="line-860"></a><span>                 </span><span class="hs-keyword">else</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684747522"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span>
</span><a name="line-861"></a><span>                          </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><span class="hs-special">(</span><a href="Literal.html#LitString"><span class="hs-identifier hs-var">LitString</span></a><span> </span><a href="#local-6989586621684747527"><span class="hs-identifier hs-var">charTail</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>
</span><a name="line-863"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="CoreOpt.html#pushCoDataCon"><span class="hs-identifier hs-var">pushCoDataCon</span></a><span> </span><a href="TysWiredIn.html#consDataCon"><span class="hs-identifier hs-var">consDataCon</span></a><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="TysWiredIn.html#charTy"><span class="hs-identifier hs-var">charTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747526"><span class="hs-identifier hs-var">char</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747528"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621684747524"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-comment">{-
Note [Unfolding DFuns]
~~~~~~~~~~~~~~~~~~~~~~
DFuns look like

  df :: forall a b. (Eq a, Eq b) -&gt; Eq (a,b)
  df a b d_a d_b = MkEqD (a,b) ($c1 a b d_a d_b)
                               ($c2 a b d_a d_b)

So to split it up we just need to apply the ops $c1, $c2 etc
to the very same args as the dfun.  It takes a little more work
to compute the type arguments to the dictionary constructor.

Note [DFun arity check]
~~~~~~~~~~~~~~~~~~~~~~~
Here we check that the total number of supplied arguments (inclding
type args) matches what the dfun is expecting.  This may be *less*
than the ordinary arity of the dfun: see Note [DFun unfoldings] in CoreSyn
-}</span><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span class="hs-identifier">exprIsLiteral_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Literal.html#Literal"><span class="hs-identifier hs-type">Literal</span></a><span>
</span><a name="line-886"></a><span class="hs-comment">-- Same deal as exprIsConApp_maybe, but much simpler</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- Nevertheless we do need to look through unfoldings for</span><span>
</span><a name="line-888"></a><span class="hs-comment">-- Integer and string literals, which are vigorously hoisted to top level</span><span>
</span><a name="line-889"></a><span class="hs-comment">-- and not subsequently inlined</span><span>
</span><a name="line-890"></a><a name="exprIsLiteral_maybe"><a href="CoreOpt.html#exprIsLiteral_maybe"><span class="hs-identifier">exprIsLiteral_maybe</span></a></a><span> </span><a name="local-6989586621684747529"><a href="#local-6989586621684747529"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684747530"><a href="#local-6989586621684747530"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747531"><a href="#local-6989586621684747531"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-891"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747531"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-892"></a><span>      </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621684747532"><a href="#local-6989586621684747532"><span class="hs-identifier">l</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621684747532"><span class="hs-identifier hs-var">l</span></a><span>
</span><a name="line-893"></a><span>      </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684747533"><a href="#local-6989586621684747533"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span> </span><a href="#local-6989586621684747529"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747533"><span class="hs-identifier hs-var">e'</span></a><span> </span><span class="hs-comment">-- dubious?</span><span>
</span><a name="line-894"></a><span>      </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747534"><a href="#local-6989586621684747534"><span class="hs-identifier">v</span></a></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747535"><a href="#local-6989586621684747535"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747530"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><a href="#local-6989586621684747534"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-895"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreOpt.html#exprIsLiteral_maybe"><span class="hs-identifier hs-var">exprIsLiteral_maybe</span></a><span> </span><a href="#local-6989586621684747529"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684747535"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-896"></a><span>      </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-897"></a><span>
</span><a name="line-898"></a><span class="hs-comment">{-
Note [exprIsLambda_maybe]
~~~~~~~~~~~~~~~~~~~~~~~~~~
exprIsLambda_maybe will, given an expression `e`, try to turn it into the form
`Lam v e'` (returned as `Just (v,e')`). Besides using lambdas, it looks through
casts (using the Push rule), and it unfolds function calls if the unfolding
has a greater arity than arguments are present.

Currently, it is used in Rules.match, and is required to make
&quot;map coerce = coerce&quot; match.
-}</span><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#InScopeEnv"><span class="hs-identifier hs-type">InScopeEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-911"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">,</span><span class="hs-special">[</span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-912"></a><span>    </span><span class="hs-comment">-- See Note [exprIsLambda_maybe]</span><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span class="hs-comment">-- The simple case: It is a lambda already</span><span>
</span><a name="line-915"></a><a name="exprIsLambda_maybe"><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier">exprIsLambda_maybe</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684747536"><a href="#local-6989586621684747536"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684747537"><a href="#local-6989586621684747537"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-916"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747536"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747537"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-917"></a><span>
</span><a name="line-918"></a><span class="hs-comment">-- Still straightforward: Ticks that we can float out of the way</span><span>
</span><a name="line-919"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747538"><a href="#local-6989586621684747538"><span class="hs-identifier">in_scope_set</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747539"><a href="#local-6989586621684747539"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684747540"><a href="#local-6989586621684747540"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684747541"><a href="#local-6989586621684747541"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-920"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-6989586621684747540"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-921"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747542"><a href="#local-6989586621684747542"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747543"><a href="#local-6989586621684747543"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747544"><a href="#local-6989586621684747544"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747538"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747539"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747541"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-922"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747542"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747543"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747540"><span class="hs-identifier hs-var">t</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747544"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-923"></a><span>
</span><a name="line-924"></a><span class="hs-comment">-- Also possible: A casted lambda. Push the coercion inside</span><span>
</span><a name="line-925"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747545"><a href="#local-6989586621684747545"><span class="hs-identifier">in_scope_set</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747546"><a href="#local-6989586621684747546"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684747547"><a href="#local-6989586621684747547"><span class="hs-identifier">casted_e</span></a></a><span> </span><a name="local-6989586621684747548"><a href="#local-6989586621684747548"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-926"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747549"><a href="#local-6989586621684747549"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747550"><a href="#local-6989586621684747550"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747551"><a href="#local-6989586621684747551"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747545"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747546"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747547"><span class="hs-identifier hs-var">casted_e</span></a><span>
</span><a name="line-927"></a><span>    </span><span class="hs-comment">-- Only do value lambdas.</span><span>
</span><a name="line-928"></a><span>    </span><span class="hs-comment">-- this implies that x is not in scope in gamma (makes this code simpler)</span><span>
</span><a name="line-929"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684747549"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684747549"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-930"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier hs-var">x</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">elemVarSet</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">tyCoVarsOfCo</span><span> </span><span class="hs-identifier">co</span><span class="hs-special">)</span><span> </span><a href="TyCoRep.html#tyCoVarsOfCo"><span class="hs-identifier hs-var">True</span></a><span>
</span><a name="line-931"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747552"><a href="#local-6989586621684747552"><span class="hs-identifier">x'</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747553"><a href="#local-6989586621684747553"><span class="hs-identifier">e'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoercionIntoLambda"><span class="hs-identifier hs-var">pushCoercionIntoLambda</span></a><span> </span><a href="#local-6989586621684747545"><span class="hs-identifier hs-var">in_scope_set</span></a><span> </span><a href="#local-6989586621684747549"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684747550"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684747548"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-932"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747554"><a href="#local-6989586621684747554"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747552"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><a href="#local-6989586621684747553"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">,</span><a href="#local-6989586621684747551"><span class="hs-identifier hs-var">ts</span></a><span class="hs-special">)</span><span>
</span><a name="line-933"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">--pprTrace &quot;exprIsLambda_maybe:Cast&quot; (vcat [ppr casted_e,ppr co,ppr res)])</span><span>
</span><a name="line-934"></a><span>      </span><a href="#local-6989586621684747554"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-935"></a><span>
</span><a name="line-936"></a><span class="hs-comment">-- Another attempt: See if we find a partial unfolding</span><span>
</span><a name="line-937"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747555"><a href="#local-6989586621684747555"><span class="hs-identifier">in_scope_set</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747556"><a href="#local-6989586621684747556"><span class="hs-identifier">id_unf</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747557"><a href="#local-6989586621684747557"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-938"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684747558"><a href="#local-6989586621684747558"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684747560"><a href="#local-6989586621684747560"><span class="hs-identifier">ts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#collectArgsTicks"><span class="hs-identifier hs-var">collectArgsTicks</span></a><span> </span><a href="CoreSyn.html#tickishFloatable"><span class="hs-identifier hs-var">tickishFloatable</span></a><span> </span><a href="#local-6989586621684747557"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-939"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Id.html#idArity"><span class="hs-identifier hs-var">idArity</span></a><span> </span><a href="#local-6989586621684747558"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="Util.html#count"><span class="hs-identifier hs-var">count</span></a><span> </span><a href="CoreSyn.html#isValArg"><span class="hs-identifier hs-var">isValArg</span></a><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-940"></a><span>    </span><span class="hs-comment">-- Make sure there is hope to get a lambda</span><span>
</span><a name="line-941"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684747561"><a href="#local-6989586621684747561"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreSyn.html#expandUnfolding_maybe"><span class="hs-identifier hs-var">expandUnfolding_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747556"><span class="hs-identifier hs-var">id_unf</span></a><span> </span><a href="#local-6989586621684747558"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-942"></a><span>    </span><span class="hs-comment">-- Optimize, for beta-reduction</span><span>
</span><a name="line-943"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747562"><a href="#local-6989586621684747562"><span class="hs-identifier">e'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreOpt.html#simpleOptExprWith"><span class="hs-identifier hs-var">simpleOptExprWith</span></a><span> </span><a href="DynFlags.html#unsafeGlobalDynFlags"><span class="hs-identifier hs-var">unsafeGlobalDynFlags</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-6989586621684747555"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747561"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">`</span><a href="CoreSyn.html#mkApps"><span class="hs-identifier hs-var">mkApps</span></a><span class="hs-special">`</span><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-944"></a><span>    </span><span class="hs-comment">-- Recurse, because of possible casts</span><span>
</span><a name="line-945"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747563"><a href="#local-6989586621684747563"><span class="hs-identifier">x'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747564"><a href="#local-6989586621684747564"><span class="hs-identifier">e''</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747565"><a href="#local-6989586621684747565"><span class="hs-identifier">ts'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#exprIsLambda_maybe"><span class="hs-identifier hs-var">exprIsLambda_maybe</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747555"><span class="hs-identifier hs-var">in_scope_set</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747556"><span class="hs-identifier hs-var">id_unf</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747562"><span class="hs-identifier hs-var">e'</span></a><span>
</span><a name="line-946"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747566"><a href="#local-6989586621684747566"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747563"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747564"><span class="hs-identifier hs-var">e''</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747560"><span class="hs-identifier hs-var">ts</span></a><span class="hs-operator hs-var">++</span><a href="#local-6989586621684747565"><span class="hs-identifier hs-var">ts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-947"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;exprIsLambda_maybe:Unfold&quot; (vcat [ppr e, ppr (x',e'')])</span><span>
</span><a name="line-948"></a><span>      </span><a href="#local-6989586621684747566"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-949"></a><span>
</span><a name="line-950"></a><span class="hs-identifier">exprIsLambda_maybe</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684747567"><a href="#local-6989586621684747567"><span class="hs-identifier">_e</span></a></a><span>
</span><a name="line-951"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;exprIsLambda_maybe:Fail&quot; (vcat [ppr _e])</span><span>
</span><a name="line-952"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-953"></a><span>
</span><a name="line-954"></a><span>
</span><a name="line-955"></a><span class="hs-comment">{- *********************************************************************
*                                                                      *
              The &quot;push rules&quot;
*                                                                      *
************************************************************************

Here we implement the &quot;push rules&quot; from FC papers:

* The push-argument rules, where we can move a coercion past an argument.
  We have
      (fun |&gt; co) arg
  and we want to transform it to
    (fun arg') |&gt; co'
  for some suitable co' and tranformed arg'.

* The PushK rule for data constructors.  We have
       (K e1 .. en) |&gt; co
  and we want to tranform to
       (K e1' .. en')
  by pushing the coercion into the arguments
-}</span><span>
</span><a name="line-976"></a><span>
</span><a name="line-977"></a><span class="hs-identifier">pushCoArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-978"></a><a name="pushCoArgs"><a href="CoreOpt.html#pushCoArgs"><span class="hs-identifier">pushCoArgs</span></a></a><span> </span><a name="local-6989586621684747568"><a href="#local-6989586621684747568"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621684747568"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-979"></a><span class="hs-identifier">pushCoArgs</span><span> </span><a name="local-6989586621684747569"><a href="#local-6989586621684747569"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684747570"><a href="#local-6989586621684747570"><span class="hs-identifier">arg</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621684747571"><a href="#local-6989586621684747571"><span class="hs-identifier">args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747572"><a href="#local-6989586621684747572"><span class="hs-identifier">arg'</span></a></a><span class="hs-special">,</span><span>  </span><a name="local-6989586621684747573"><a href="#local-6989586621684747573"><span class="hs-identifier">m_co1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoArg"><span class="hs-identifier hs-var">pushCoArg</span></a><span>  </span><a href="#local-6989586621684747569"><span class="hs-identifier hs-var">co</span></a><span>  </span><a href="#local-6989586621684747570"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-980"></a><span>                              </span><span class="hs-special">;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684747573"><span class="hs-identifier hs-var">m_co1</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-981"></a><span>                                  </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a name="local-6989586621684747574"><a href="#local-6989586621684747574"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747575"><a href="#local-6989586621684747575"><span class="hs-identifier">args'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747576"><a href="#local-6989586621684747576"><span class="hs-identifier">m_co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoArgs"><span class="hs-identifier hs-var">pushCoArgs</span></a><span> </span><a href="#local-6989586621684747574"><span class="hs-identifier hs-var">co1</span></a><span> </span><a href="#local-6989586621684747571"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-982"></a><span>                                                 </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747572"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747575"><span class="hs-identifier hs-var">args'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747576"><span class="hs-identifier hs-var">m_co2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-983"></a><span>                                  </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747572"><span class="hs-identifier hs-var">arg'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747571"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-984"></a><span>
</span><a name="line-985"></a><span class="hs-identifier">pushCoArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-986"></a><span class="hs-comment">-- We have (fun |&gt; co) arg, and we want to transform it to</span><span>
</span><a name="line-987"></a><span class="hs-comment">--         (fun arg) |&gt; co</span><span>
</span><a name="line-988"></a><span class="hs-comment">-- This may fail, e.g. if (fun :: N) where N is a newtype</span><span>
</span><a name="line-989"></a><span class="hs-comment">-- C.f. simplCast in Simplify.hs</span><span>
</span><a name="line-990"></a><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><a name="line-991"></a><span class="hs-comment">-- If the returned coercion is Nothing, then it would have been reflexive</span><span>
</span><a name="line-992"></a><a name="pushCoArg"><a href="CoreOpt.html#pushCoArg"><span class="hs-identifier">pushCoArg</span></a></a><span> </span><a name="local-6989586621684747577"><a href="#local-6989586621684747577"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684747578"><a href="#local-6989586621684747578"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747579"><a href="#local-6989586621684747579"><span class="hs-identifier">ty'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747580"><a href="#local-6989586621684747580"><span class="hs-identifier">m_co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoTyArg"><span class="hs-identifier hs-var">pushCoTyArg</span></a><span> </span><a href="#local-6989586621684747577"><span class="hs-identifier hs-var">co</span></a><span> </span><a href="#local-6989586621684747578"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-993"></a><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621684747579"><span class="hs-identifier hs-var">ty'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747580"><span class="hs-identifier hs-var">m_co'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-994"></a><span class="hs-identifier">pushCoArg</span><span> </span><a name="local-6989586621684747581"><a href="#local-6989586621684747581"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621684747582"><a href="#local-6989586621684747582"><span class="hs-identifier">val_arg</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747583"><a href="#local-6989586621684747583"><span class="hs-identifier">arg_co</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747584"><a href="#local-6989586621684747584"><span class="hs-identifier">m_co'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="CoreOpt.html#pushCoValArg"><span class="hs-identifier hs-var">pushCoValArg</span></a><span> </span><a href="#local-6989586621684747581"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-995"></a><span>                            </span><span class="hs-special">;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747582"><span class="hs-identifier hs-var">val_arg</span></a><span> </span><span class="hs-special">`</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747583"><span class="hs-identifier hs-var">arg_co</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747584"><span class="hs-identifier hs-var">m_co'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-996"></a><span>
</span><a name="line-997"></a><span class="hs-identifier">pushCoTyArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercionR"><span class="hs-identifier hs-type">MCoercionR</span></a><span class="hs-special">)</span><span>
</span><a name="line-998"></a><span class="hs-comment">-- We have (fun |&gt; co) @ty</span><span>
</span><a name="line-999"></a><span class="hs-comment">-- Push the coercion through to return</span><span>
</span><a name="line-1000"></a><span class="hs-comment">--         (fun @ty') |&gt; co'</span><span>
</span><a name="line-1001"></a><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><a name="line-1002"></a><span class="hs-comment">-- If the returned coercion is Nothing, then it would have been reflexive;</span><span>
</span><a name="line-1003"></a><span class="hs-comment">-- it's faster not to compute it, though.</span><span>
</span><a name="line-1004"></a><a name="pushCoTyArg"><a href="CoreOpt.html#pushCoTyArg"><span class="hs-identifier">pushCoTyArg</span></a></a><span> </span><a name="local-6989586621684747585"><a href="#local-6989586621684747585"><span class="hs-identifier">co</span></a></a><span> </span><a name="local-6989586621684747586"><a href="#local-6989586621684747586"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-1005"></a><span>  </span><span class="hs-comment">-- The following is inefficient - don't do `eqType` here, the coercion</span><span>
</span><a name="line-1006"></a><span>  </span><span class="hs-comment">-- optimizer will take care of it. See Trac #14737.</span><span>
</span><a name="line-1007"></a><span>  </span><span class="hs-comment">-- -- | tyL `eqType` tyR</span><span>
</span><a name="line-1008"></a><span>  </span><span class="hs-comment">-- -- = Just (ty, Nothing)</span><span>
</span><a name="line-1009"></a><span>
</span><a name="line-1010"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621684747585"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1011"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747586"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1012"></a><span>
</span><a name="line-1013"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a><span> </span><a href="#local-6989586621684747587"><span class="hs-identifier hs-var">tyL</span></a><span>
</span><a name="line-1014"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_ty</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">tyR</span></a><span class="hs-special">,</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">ty</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1015"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747586"><span class="hs-identifier hs-var">ty</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#mkCastTy"><span class="hs-identifier hs-var">mkCastTy</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747589"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621684747590"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1016"></a><span>
</span><a name="line-1017"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1018"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1019"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1020"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747587"><a href="#local-6989586621684747587"><span class="hs-identifier">tyL</span></a></a><span> </span><a name="local-6989586621684747588"><a href="#local-6989586621684747588"><span class="hs-identifier">tyR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747585"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1021"></a><span>       </span><span class="hs-comment">-- co :: tyL ~ tyR</span><span>
</span><a name="line-1022"></a><span>       </span><span class="hs-comment">-- tyL = forall (a1 :: k1). ty1</span><span>
</span><a name="line-1023"></a><span>       </span><span class="hs-comment">-- tyR = forall (a2 :: k2). ty2</span><span>
</span><a name="line-1024"></a><span>
</span><a name="line-1025"></a><span>    </span><a name="local-6989586621684747589"><a href="#local-6989586621684747589"><span class="hs-identifier">co1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684747585"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><span>       </span><span class="hs-comment">-- co1 :: k2 ~N k1</span><span>
</span><a name="line-1027"></a><span>       </span><span class="hs-comment">-- Note that NthCo can extract a Nominal equality between the</span><span>
</span><a name="line-1028"></a><span>       </span><span class="hs-comment">-- kinds of the types related by a coercion between forall-types.</span><span>
</span><a name="line-1029"></a><span>       </span><span class="hs-comment">-- See the NthCo case in CoreLint.</span><span>
</span><a name="line-1030"></a><span>
</span><a name="line-1031"></a><span>    </span><a name="local-6989586621684747590"><a href="#local-6989586621684747590"><span class="hs-identifier">co2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><a href="#local-6989586621684747585"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkGReflLeftCo"><span class="hs-identifier hs-var">mkGReflLeftCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><a href="#local-6989586621684747586"><span class="hs-identifier hs-var">ty</span></a><span> </span><a href="#local-6989586621684747589"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1032"></a><span>        </span><span class="hs-comment">-- co2 :: ty1[ (ty|&gt;co1)/a1 ] ~ ty2[ ty/a2 ]</span><span>
</span><a name="line-1033"></a><span>        </span><span class="hs-comment">-- Arg of mkInstCo is always nominal, hence mkNomReflCo</span><span>
</span><a name="line-1034"></a><span>
</span><a name="line-1035"></a><span class="hs-identifier">pushCoValArg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCoercion"><span class="hs-identifier hs-type">MCoercion</span></a><span class="hs-special">)</span><span>
</span><a name="line-1036"></a><span class="hs-comment">-- We have (fun |&gt; co) arg</span><span>
</span><a name="line-1037"></a><span class="hs-comment">-- Push the coercion through to return</span><span>
</span><a name="line-1038"></a><span class="hs-comment">--         (fun (arg |&gt; co_arg)) |&gt; co_res</span><span>
</span><a name="line-1039"></a><span class="hs-comment">-- 'co' is always Representational</span><span>
</span><a name="line-1040"></a><span class="hs-comment">-- If the second returned Coercion is actually Nothing, then no cast is necessary;</span><span>
</span><a name="line-1041"></a><span class="hs-comment">-- the returned coercion would have been reflexive.</span><span>
</span><a name="line-1042"></a><a name="pushCoValArg"><a href="CoreOpt.html#pushCoValArg"><span class="hs-identifier">pushCoValArg</span></a></a><span> </span><a name="local-6989586621684747591"><a href="#local-6989586621684747591"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1043"></a><span>  </span><span class="hs-comment">-- The following is inefficient - don't do `eqType` here, the coercion</span><span>
</span><a name="line-1044"></a><span>  </span><span class="hs-comment">-- optimizer will take care of it. See Trac #14737.</span><span>
</span><a name="line-1045"></a><span>  </span><span class="hs-comment">-- -- | tyL `eqType` tyR</span><span>
</span><a name="line-1046"></a><span>  </span><span class="hs-comment">-- -- = Just (mkRepReflCo arg, Nothing)</span><span>
</span><a name="line-1047"></a><span>
</span><a name="line-1048"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621684747591"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1049"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkRepReflCo"><span class="hs-identifier hs-var">mkRepReflCo</span></a><span> </span><a href="#local-6989586621684747592"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MRefl"><span class="hs-identifier hs-var">MRefl</span></a><span class="hs-special">)</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">isFunTy</span></a><span> </span><a href="#local-6989586621684747593"><span class="hs-identifier hs-var">tyL</span></a><span>
</span><a name="line-1052"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747595"><a href="#local-6989586621684747595"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747596"><a href="#local-6989586621684747596"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621684747591"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1053"></a><span>              </span><span class="hs-comment">-- If   co  :: (tyL1 -&gt; tyL2) ~ (tyR1 -&gt; tyR2)</span><span>
</span><a name="line-1054"></a><span>              </span><span class="hs-comment">-- then co1 :: tyL1 ~ tyR1</span><span>
</span><a name="line-1055"></a><span>              </span><span class="hs-comment">--      co2 :: tyL2 ~ tyR2</span><span>
</span><a name="line-1056"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isFunTy</span><span> </span><span class="hs-identifier">tyR</span><span class="hs-special">,</span><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="Type.html#isFunTy"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">arg</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1057"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkSymCo"><span class="hs-identifier hs-var">mkSymCo</span></a><span> </span><a href="#local-6989586621684747595"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#MCo"><span class="hs-identifier hs-var">MCo</span></a><span> </span><a href="#local-6989586621684747596"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1058"></a><span>
</span><a name="line-1059"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1060"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1061"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1062"></a><span>    </span><a name="local-6989586621684747592"><a href="#local-6989586621684747592"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#funArgTy"><span class="hs-identifier hs-var">funArgTy</span></a><span> </span><a href="#local-6989586621684747594"><span class="hs-identifier hs-var">tyR</span></a><span>
</span><a name="line-1063"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747593"><a href="#local-6989586621684747593"><span class="hs-identifier">tyL</span></a></a><span> </span><a name="local-6989586621684747594"><a href="#local-6989586621684747594"><span class="hs-identifier">tyR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747591"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1064"></a><span>
</span><a name="line-1065"></a><span class="hs-identifier">pushCoercionIntoLambda</span><span>
</span><a name="line-1066"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1067"></a><span class="hs-comment">-- This implements the Push rule from the paper on coercions</span><span>
</span><a name="line-1068"></a><span class="hs-comment">--    (\x. e) |&gt; co</span><span>
</span><a name="line-1069"></a><span class="hs-comment">-- ===&gt;</span><span>
</span><a name="line-1070"></a><span class="hs-comment">--    (\x'. e |&gt; co')</span><span>
</span><a name="line-1071"></a><a name="pushCoercionIntoLambda"><a href="CoreOpt.html#pushCoercionIntoLambda"><span class="hs-identifier">pushCoercionIntoLambda</span></a></a><span> </span><a name="local-6989586621684747597"><a href="#local-6989586621684747597"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684747598"><a href="#local-6989586621684747598"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621684747599"><a href="#local-6989586621684747599"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684747600"><a href="#local-6989586621684747600"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1072"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">not</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier">x</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">True</span><span>
</span><a name="line-1073"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747601"><a href="#local-6989586621684747601"><span class="hs-identifier">s1s2</span></a></a><span> </span><a name="local-6989586621684747602"><a href="#local-6989586621684747602"><span class="hs-identifier">t1t2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747600"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1074"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747603"><a href="#local-6989586621684747603"><span class="hs-identifier">_s1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747604"><a href="#local-6989586621684747604"><span class="hs-identifier">_s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-6989586621684747601"><span class="hs-identifier hs-var">s1s2</span></a><span>
</span><a name="line-1075"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747605"><a href="#local-6989586621684747605"><span class="hs-identifier">t1</span></a></a><span class="hs-special">,</span><a name="local-6989586621684747606"><a href="#local-6989586621684747606"><span class="hs-identifier">_t2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitFunTy_maybe"><span class="hs-identifier hs-var">splitFunTy_maybe</span></a><span> </span><a href="#local-6989586621684747602"><span class="hs-identifier hs-var">t1t2</span></a><span>
</span><a name="line-1076"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747607"><a href="#local-6989586621684747607"><span class="hs-identifier">co1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747608"><a href="#local-6989586621684747608"><span class="hs-identifier">co2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621684747600"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1077"></a><span>          </span><span class="hs-comment">-- Should we optimize the coercions here?</span><span>
</span><a name="line-1078"></a><span>          </span><span class="hs-comment">-- Otherwise they might not match too well</span><span>
</span><a name="line-1079"></a><span>          </span><a name="local-6989586621684747609"><a href="#local-6989586621684747609"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747598"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-special">`</span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747605"><span class="hs-identifier hs-var">t1</span></a><span>
</span><a name="line-1080"></a><span>          </span><a name="local-6989586621684747610"><a href="#local-6989586621684747610"><span class="hs-identifier">in_scope'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747597"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747609"><span class="hs-identifier hs-var">x'</span></a><span>
</span><a name="line-1081"></a><span>          </span><a name="local-6989586621684747611"><a href="#local-6989586621684747611"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span> </span><a href="#local-6989586621684747610"><span class="hs-identifier hs-var">in_scope'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1082"></a><span>                                </span><a href="#local-6989586621684747598"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1083"></a><span>                                </span><span class="hs-special">(</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684747609"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747607"><span class="hs-identifier hs-var">co1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1084"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747609"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;pushCoercionIntoLambda&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747611"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684747599"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">`</span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747608"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1085"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1086"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a><span> </span><span class="hs-string">&quot;exprIsLambda_maybe: Unexpected lambda in case&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621684747598"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621684747599"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1087"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1088"></a><span>
</span><a name="line-1089"></a><span class="hs-identifier">pushCoDataCon</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-1090"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="DataCon.html#DataCon"><span class="hs-identifier hs-type">DataCon</span></a><span>
</span><a name="line-1091"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">]</span><span>      </span><span class="hs-comment">-- Universal type args</span><span>
</span><a name="line-1092"></a><span>                       </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- All other args incl existentials</span><span>
</span><a name="line-1093"></a><span class="hs-comment">-- Implement the KPush reduction rule as described in &quot;Down with kinds&quot;</span><span>
</span><a name="line-1094"></a><span class="hs-comment">-- The transformation applies iff we have</span><span>
</span><a name="line-1095"></a><span class="hs-comment">--      (C e1 ... en) `cast` co</span><span>
</span><a name="line-1096"></a><span class="hs-comment">-- where co :: (T t1 .. tn) ~ to_ty</span><span>
</span><a name="line-1097"></a><span class="hs-comment">-- The left-hand one must be a T, because exprIsConApp returned True</span><span>
</span><a name="line-1098"></a><span class="hs-comment">-- but the right-hand one might not be.  (Though it usually will.)</span><span>
</span><a name="line-1099"></a><a name="pushCoDataCon"><a href="CoreOpt.html#pushCoDataCon"><span class="hs-identifier">pushCoDataCon</span></a></a><span> </span><a name="local-6989586621684747612"><a href="#local-6989586621684747612"><span class="hs-identifier">dc</span></a></a><span> </span><a name="local-6989586621684747613"><a href="#local-6989586621684747613"><span class="hs-identifier">dc_args</span></a></a><span> </span><a name="local-6989586621684747614"><a href="#local-6989586621684747614"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1100"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621684747614"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621684747615"><span class="hs-identifier hs-var">from_ty</span></a><span> </span><span class="hs-special">`</span><a href="Type.html#eqType"><span class="hs-identifier hs-var">eqType</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747616"><span class="hs-identifier hs-var">to_ty</span></a><span>  </span><span class="hs-comment">-- try cheap test first</span><span>
</span><a name="line-1101"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747617"><a href="#local-6989586621684747617"><span class="hs-identifier">univ_ty_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747618"><a href="#local-6989586621684747618"><span class="hs-identifier">rest_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><span class="hs-special">(</span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747613"><span class="hs-identifier hs-var">dc_args</span></a><span>
</span><a name="line-1102"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span> </span><a href="#local-6989586621684747617"><span class="hs-identifier hs-var">univ_ty_args</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747618"><span class="hs-identifier hs-var">rest_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1103"></a><span>
</span><a name="line-1104"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747619"><a href="#local-6989586621684747619"><span class="hs-identifier">to_tc</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747620"><a href="#local-6989586621684747620"><span class="hs-identifier">to_tc_arg_tys</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Type.html#splitTyConApp_maybe"><span class="hs-identifier hs-var">splitTyConApp_maybe</span></a><span> </span><a href="#local-6989586621684747616"><span class="hs-identifier hs-var">to_ty</span></a><span>
</span><a name="line-1105"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747619"><span class="hs-identifier hs-var">to_tc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="DataCon.html#dataConTyCon"><span class="hs-identifier hs-var">dataConTyCon</span></a><span> </span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1106"></a><span>        </span><span class="hs-comment">-- These two tests can fail; we might see</span><span>
</span><a name="line-1107"></a><span>        </span><span class="hs-comment">--      (C x y) `cast` (g :: T a ~ S [a]),</span><span>
</span><a name="line-1108"></a><span>        </span><span class="hs-comment">-- where S is a type function.  In fact, exprIsConApp</span><span>
</span><a name="line-1109"></a><span>        </span><span class="hs-comment">-- will probably not be called in such circumstances,</span><span>
</span><a name="line-1110"></a><span>        </span><span class="hs-comment">-- but there's nothing wrong with it</span><span>
</span><a name="line-1111"></a><span>
</span><a name="line-1112"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-1113"></a><span>        </span><a name="local-6989586621684747621"><a href="#local-6989586621684747621"><span class="hs-identifier">tc_arity</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">tyConArity</span><span> </span><a href="#local-6989586621684747619"><span class="hs-identifier hs-var">to_tc</span></a><span>
</span><a name="line-1114"></a><span>        </span><a name="local-6989586621684747622"><a href="#local-6989586621684747622"><span class="hs-identifier">dc_univ_tyvars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConUnivTyVars"><span class="hs-identifier hs-var">dataConUnivTyVars</span></a><span> </span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1115"></a><span>        </span><a name="local-6989586621684747623"><a href="#local-6989586621684747623"><span class="hs-identifier">dc_ex_tcvars</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConExTyCoVars"><span class="hs-identifier hs-var">dataConExTyCoVars</span></a><span> </span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1116"></a><span>        </span><a name="local-6989586621684747624"><a href="#local-6989586621684747624"><span class="hs-identifier">arg_tys</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="DataCon.html#dataConRepArgTys"><span class="hs-identifier hs-var">dataConRepArgTys</span></a><span> </span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span>
</span><a name="line-1117"></a><span>
</span><a name="line-1118"></a><span>        </span><a name="local-6989586621684747625"><a href="#local-6989586621684747625"><span class="hs-identifier">non_univ_args</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#dropList"><span class="hs-identifier hs-var">dropList</span></a><span> </span><a href="#local-6989586621684747622"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a><span> </span><a href="#local-6989586621684747613"><span class="hs-identifier hs-var">dc_args</span></a><span>
</span><a name="line-1119"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684747626"><a href="#local-6989586621684747626"><span class="hs-identifier">ex_args</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747627"><a href="#local-6989586621684747627"><span class="hs-identifier">val_args</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Util.html#splitAtList"><span class="hs-identifier hs-var">splitAtList</span></a><span> </span><a href="#local-6989586621684747623"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a><span> </span><a href="#local-6989586621684747625"><span class="hs-identifier hs-var">non_univ_args</span></a><span>
</span><a name="line-1120"></a><span>
</span><a name="line-1121"></a><span>        </span><span class="hs-comment">-- Make the &quot;Psi&quot; from the paper</span><span>
</span><a name="line-1122"></a><span>        </span><a name="local-6989586621684747628"><a href="#local-6989586621684747628"><span class="hs-identifier">omegas</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#decomposeCo"><span class="hs-identifier hs-var">decomposeCo</span></a><span> </span><a href="#local-6989586621684747621"><span class="hs-identifier hs-var">tc_arity</span></a><span> </span><a href="#local-6989586621684747614"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#tyConRolesRepresentational"><span class="hs-identifier hs-var">tyConRolesRepresentational</span></a><span> </span><a href="#local-6989586621684747619"><span class="hs-identifier hs-var">to_tc</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621684747629"><a href="#local-6989586621684747629"><span class="hs-identifier">psi_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747630"><a href="#local-6989586621684747630"><span class="hs-identifier">to_ex_arg_tys</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1124"></a><span>          </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#liftCoSubstWithEx"><span class="hs-identifier hs-var">liftCoSubstWithEx</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span>
</span><a name="line-1125"></a><span>                              </span><a href="#local-6989586621684747622"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a><span>
</span><a name="line-1126"></a><span>                              </span><a href="#local-6989586621684747628"><span class="hs-identifier hs-var">omegas</span></a><span>
</span><a name="line-1127"></a><span>                              </span><a href="#local-6989586621684747623"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a><span>
</span><a name="line-1128"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">exprToType</span></a><span> </span><a href="#local-6989586621684747626"><span class="hs-identifier hs-var">ex_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1129"></a><span>
</span><a name="line-1130"></a><span>          </span><span class="hs-comment">-- Cast the value arguments (which include dictionaries)</span><span>
</span><a name="line-1131"></a><span>        </span><a name="local-6989586621684747631"><a href="#local-6989586621684747631"><span class="hs-identifier">new_val_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zipWith</span><span> </span><a href="#local-6989586621684747632"><span class="hs-identifier hs-var">cast_arg</span></a><span> </span><a href="#local-6989586621684747624"><span class="hs-identifier hs-var">arg_tys</span></a><span> </span><a href="#local-6989586621684747627"><span class="hs-identifier hs-var">val_args</span></a><span>
</span><a name="line-1132"></a><span>        </span><a name="local-6989586621684747632"><a href="#local-6989586621684747632"><span class="hs-identifier">cast_arg</span></a></a><span> </span><a name="local-6989586621684747635"><a href="#local-6989586621684747635"><span class="hs-identifier">arg_ty</span></a></a><span> </span><a name="local-6989586621684747636"><a href="#local-6989586621684747636"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-6989586621684747636"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747629"><span class="hs-identifier hs-var">psi_subst</span></a><span> </span><a href="#local-6989586621684747635"><span class="hs-identifier hs-var">arg_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-1133"></a><span>
</span><a name="line-1134"></a><span>        </span><a name="local-6989586621684747633"><a href="#local-6989586621684747633"><span class="hs-identifier">to_ex_args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a href="#local-6989586621684747630"><span class="hs-identifier hs-var">to_ex_arg_tys</span></a><span>
</span><a name="line-1135"></a><span>
</span><a name="line-1136"></a><span>        </span><a name="local-6989586621684747634"><a href="#local-6989586621684747634"><span class="hs-identifier">dump_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span>      </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747622"><span class="hs-identifier hs-var">dc_univ_tyvars</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747623"><span class="hs-identifier hs-var">dc_ex_tcvars</span></a><span class="hs-special">,</span><span>
</span><a name="line-1137"></a><span>                         </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747624"><span class="hs-identifier hs-var">arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747613"><span class="hs-identifier hs-var">dc_args</span></a><span class="hs-special">,</span><span>
</span><a name="line-1138"></a><span>                         </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747626"><span class="hs-identifier hs-var">ex_args</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747627"><span class="hs-identifier hs-var">val_args</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747614"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747615"><span class="hs-identifier hs-var">from_ty</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747616"><span class="hs-identifier hs-var">to_ty</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684747619"><span class="hs-identifier hs-var">to_tc</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1139"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-1140"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">eqType</span><span> </span><span class="hs-identifier">from_ty</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkTyConApp</span><span> </span><span class="hs-identifier">to_tc</span><span> </span><span class="hs-special">(</span><a href="Type.html#mkTyConApp"><span class="hs-identifier hs-var">map</span></a><span> </span><span class="hs-identifier">exprToType</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="CoreSyn.html#exprToType"><span class="hs-identifier hs-var">takeList</span></a><span> </span><span class="hs-identifier">dc_univ_tyvars</span><span> </span><a href="#local-6989586621684747622"><span class="hs-identifier hs-var">dc_args</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dump_doc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1141"></a><span>    </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">equalLength</span><span> </span><span class="hs-identifier">val_args</span><span> </span><span class="hs-identifier">arg_tys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">dump_doc</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1142"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747612"><span class="hs-identifier hs-var">dc</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747620"><span class="hs-identifier hs-var">to_tc_arg_tys</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747633"><span class="hs-identifier hs-var">to_ex_args</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621684747631"><span class="hs-identifier hs-var">new_val_args</span></a><span class="hs-special">)</span><span>
</span><a name="line-1143"></a><span>
</span><a name="line-1144"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1145"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1146"></a><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1148"></a><span>    </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747615"><a href="#local-6989586621684747615"><span class="hs-identifier">from_ty</span></a></a><span> </span><a name="local-6989586621684747616"><a href="#local-6989586621684747616"><span class="hs-identifier">to_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747614"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1149"></a><span>
</span><a name="line-1150"></a><span class="hs-identifier">collectBindersPushingCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1151"></a><span class="hs-comment">-- Collect lambda binders, pushing coercions inside if possible</span><span>
</span><a name="line-1152"></a><span class="hs-comment">-- E.g.   (\x.e) |&gt; g         g :: &lt;Int&gt; -&gt; blah</span><span>
</span><a name="line-1153"></a><span class="hs-comment">--        = (\x. e |&gt; Nth 1 g)</span><span>
</span><a name="line-1154"></a><span class="hs-comment">--</span><span>
</span><a name="line-1155"></a><span class="hs-comment">-- That is,</span><span>
</span><a name="line-1156"></a><span class="hs-comment">--</span><span>
</span><a name="line-1157"></a><span class="hs-comment">-- collectBindersPushingCo ((\x.e) |&gt; g) === ([x], e |&gt; Nth 1 g)</span><span>
</span><a name="line-1158"></a><a name="collectBindersPushingCo"><a href="CoreOpt.html#collectBindersPushingCo"><span class="hs-identifier">collectBindersPushingCo</span></a></a><span> </span><a name="local-6989586621684747637"><a href="#local-6989586621684747637"><span class="hs-identifier">e</span></a></a><span>
</span><a name="line-1159"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747638"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621684747637"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1160"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1161"></a><span>    </span><span class="hs-comment">-- Peel off lambdas until we hit a cast.</span><span>
</span><a name="line-1162"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1163"></a><span>    </span><span class="hs-comment">-- The accumulator is in reverse order</span><span>
</span><a name="line-1164"></a><span>    </span><a name="local-6989586621684747638"><a href="#local-6989586621684747638"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621684747641"><a href="#local-6989586621684747641"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684747642"><a href="#local-6989586621684747642"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747643"><a href="#local-6989586621684747643"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747638"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747642"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747641"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747643"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-1165"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684747644"><a href="#local-6989586621684747644"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684747645"><a href="#local-6989586621684747645"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684747646"><a href="#local-6989586621684747646"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747639"><span class="hs-identifier hs-var">go_c</span></a><span> </span><a href="#local-6989586621684747644"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684747645"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684747646"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1166"></a><span>    </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621684747647"><a href="#local-6989586621684747647"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621684747648"><a href="#local-6989586621684747648"><span class="hs-identifier">e</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684747647"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684747648"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1167"></a><span>
</span><a name="line-1168"></a><span>    </span><span class="hs-comment">-- We are in a cast; peel off casts until we hit a lambda.</span><span>
</span><a name="line-1169"></a><span>    </span><span class="hs-identifier">go_c</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1170"></a><span>    </span><span class="hs-comment">-- (go_c bs e c) is same as (go bs e (e |&gt; c))</span><span>
</span><a name="line-1171"></a><span>    </span><a name="local-6989586621684747639"><a href="#local-6989586621684747639"><span class="hs-identifier">go_c</span></a></a><span> </span><a name="local-6989586621684747649"><a href="#local-6989586621684747649"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684747650"><a href="#local-6989586621684747650"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684747651"><a href="#local-6989586621684747651"><span class="hs-identifier">co1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684747652"><a href="#local-6989586621684747652"><span class="hs-identifier">co2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747639"><span class="hs-identifier hs-var">go_c</span></a><span> </span><a href="#local-6989586621684747649"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684747650"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747651"><span class="hs-identifier hs-var">co1</span></a><span> </span><span class="hs-special">`</span><a href="Coercion.html#mkTransCo"><span class="hs-identifier hs-var">mkTransCo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684747652"><span class="hs-identifier hs-var">co2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1172"></a><span>    </span><span class="hs-identifier">go_c</span><span> </span><a name="local-6989586621684747653"><a href="#local-6989586621684747653"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684747654"><a href="#local-6989586621684747654"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747655"><a href="#local-6989586621684747655"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><a name="local-6989586621684747656"><a href="#local-6989586621684747656"><span class="hs-identifier">co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747640"><span class="hs-identifier hs-var">go_lam</span></a><span> </span><a href="#local-6989586621684747653"><span class="hs-identifier hs-var">bs</span></a><span> </span><a href="#local-6989586621684747654"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684747655"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684747656"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1173"></a><span>    </span><span class="hs-identifier">go_c</span><span> </span><a name="local-6989586621684747657"><a href="#local-6989586621684747657"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621684747658"><a href="#local-6989586621684747658"><span class="hs-identifier">e</span></a></a><span>            </span><a name="local-6989586621684747659"><a href="#local-6989586621684747659"><span class="hs-identifier">co</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684747657"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><a href="#local-6989586621684747658"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684747659"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1174"></a><span>
</span><a name="line-1175"></a><span>    </span><span class="hs-comment">-- We are in a lambda under a cast; peel off lambdas and build a</span><span>
</span><a name="line-1176"></a><span>    </span><span class="hs-comment">-- new coercion for the body.</span><span>
</span><a name="line-1177"></a><span>    </span><span class="hs-identifier">go_lam</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CoercionR"><span class="hs-identifier hs-type">CoercionR</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><span>    </span><span class="hs-comment">-- (go_lam bs b e c) is same as (go_c bs (\b.e) c)</span><span>
</span><a name="line-1179"></a><span>    </span><a name="local-6989586621684747640"><a href="#local-6989586621684747640"><span class="hs-identifier">go_lam</span></a></a><span> </span><a name="local-6989586621684747660"><a href="#local-6989586621684747660"><span class="hs-identifier">bs</span></a></a><span> </span><a name="local-6989586621684747661"><a href="#local-6989586621684747661"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684747662"><a href="#local-6989586621684747662"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684747663"><a href="#local-6989586621684747663"><span class="hs-identifier">co</span></a></a><span>
</span><a name="line-1180"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1181"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747664"><a href="#local-6989586621684747664"><span class="hs-identifier">tyL</span></a></a><span> </span><a name="local-6989586621684747665"><a href="#local-6989586621684747665"><span class="hs-identifier">tyR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1182"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_ty</span><span> </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">tyL</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1183"></a><span>        </span><a href="Type.html#isForAllTy_ty"><span class="hs-identifier hs-var">isForAllTy_ty</span></a><span> </span><a href="#local-6989586621684747665"><span class="hs-identifier hs-var">tyR</span></a><span>
</span><a name="line-1184"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><a name="line-1185"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747639"><span class="hs-identifier hs-var">go_c</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747660"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747662"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">mkTyVarTy</span></a><span> </span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1186"></a><span>
</span><a name="line-1187"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1188"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747666"><a href="#local-6989586621684747666"><span class="hs-identifier">tyL</span></a></a><span> </span><a name="local-6989586621684747667"><a href="#local-6989586621684747667"><span class="hs-identifier">tyR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1189"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isForAllTy_co</span><span> </span><a href="Type.html#isForAllTy_co"><span class="hs-identifier hs-var">tyL</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-1190"></a><span>        </span><a href="Type.html#isForAllTy_co"><span class="hs-identifier hs-var">isForAllTy_co</span></a><span> </span><a href="#local-6989586621684747667"><span class="hs-identifier hs-var">tyR</span></a><span>
</span><a name="line-1191"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNthCo"><span class="hs-identifier hs-var">mkNthCo</span></a><span> </span><a href="CoAxiom.html#Nominal"><span class="hs-identifier hs-var">Nominal</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><a name="line-1192"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621684747668"><a href="#local-6989586621684747668"><span class="hs-identifier">cov</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1193"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747639"><span class="hs-identifier hs-var">go_c</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747660"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747662"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkInstCo"><span class="hs-identifier hs-var">mkInstCo</span></a><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkNomReflCo"><span class="hs-identifier hs-var">mkNomReflCo</span></a><span> </span><span class="hs-special">(</span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><a href="#local-6989586621684747668"><span class="hs-identifier hs-var">cov</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1194"></a><span>
</span><a name="line-1195"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-1196"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><a href="Pair.html#Pair"><span class="hs-identifier hs-var">Pair</span></a><span> </span><a name="local-6989586621684747669"><a href="#local-6989586621684747669"><span class="hs-identifier">tyL</span></a></a><span> </span><a name="local-6989586621684747670"><a href="#local-6989586621684747670"><span class="hs-identifier">tyR</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Coercion.html#coercionKind"><span class="hs-identifier hs-var">coercionKind</span></a><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1197"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isFunTy</span><span> </span><span class="hs-identifier hs-var">tyL</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">isFunTy</span><span> </span><span class="hs-identifier">tyR</span><span>
</span><a name="line-1198"></a><span>      </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684747671"><a href="#local-6989586621684747671"><span class="hs-identifier">co_arg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684747672"><a href="#local-6989586621684747672"><span class="hs-identifier">co_res</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Coercion.html#decomposeFunCo"><span class="hs-identifier hs-var">decomposeFunCo</span></a><span> </span><a href="CoAxiom.html#Representational"><span class="hs-identifier hs-var">Representational</span></a><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-1199"></a><span>      </span><span class="hs-special">,</span><span> </span><a href="Coercion.html#isReflCo"><span class="hs-identifier hs-var">isReflCo</span></a><span> </span><a href="#local-6989586621684747671"><span class="hs-identifier hs-var">co_arg</span></a><span>  </span><span class="hs-comment">-- See Note [collectBindersPushingCo]</span><span>
</span><a name="line-1200"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684747639"><span class="hs-identifier hs-var">go_c</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span class="hs-glyph">:</span><a href="#local-6989586621684747660"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747662"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621684747672"><span class="hs-identifier hs-var">co_res</span></a><span>
</span><a name="line-1201"></a><span>
</span><a name="line-1202"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621684747660"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">,</span><span> </span><a href="CoreUtils.html#mkCast"><span class="hs-identifier hs-var">mkCast</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621684747661"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621684747662"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684747663"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-1203"></a><span>
</span><a name="line-1204"></a><span class="hs-comment">{- Note [collectBindersPushingCo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We just look for coercions of form
   &lt;type&gt; -&gt; blah
(and similarly for foralls) to keep this function simple.  We could do
more elaborate stuff, but it'd involve substitution etc.
-}</span><span>
</span><a name="line-1211"></a></pre></body></html>