<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The GRASP/AQUA Project, Glasgow University, 1992-1998


Utility functions on @Core@ syntax
-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-10"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CoreSubst</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-11"></a><span>        </span><span class="hs-comment">-- * Main data types</span><span>
</span><a name="line-12"></a><span>        </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Implementation exported for supercompiler's Renaming.hs only</span><span>
</span><a name="line-13"></a><span>        </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span class="hs-special">,</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span>        </span><span class="hs-comment">-- ** Substituting into expressions and related types</span><span>
</span><a name="line-16"></a><span>        </span><a href="CoreSubst.html#deShadowBinds"><span class="hs-identifier hs-var">deShadowBinds</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substSpec"><span class="hs-identifier hs-var">substSpec</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substRulesForImportedIds"><span class="hs-identifier hs-var">substRulesForImportedIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substExprSC"><span class="hs-identifier hs-var">substExprSC</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substBindSC"><span class="hs-identifier hs-var">substBindSC</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substUnfoldingSC"><span class="hs-identifier hs-var">substUnfoldingSC</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>        </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#lookupTCvSubst"><span class="hs-identifier hs-var">lookupTCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substIdOcc"><span class="hs-identifier hs-var">substIdOcc</span></a><span class="hs-special">,</span><span>
</span><a name="line-20"></a><span>        </span><a href="CoreSubst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substDVarSet"><span class="hs-identifier hs-var">substDVarSet</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span class="hs-special">,</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>        </span><span class="hs-comment">-- ** Operations on substitutions</span><span>
</span><a name="line-23"></a><span>        </span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier hs-var">mkEmptySubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#mkSubst"><span class="hs-identifier hs-var">mkSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#mkOpenSubst"><span class="hs-identifier hs-var">mkOpenSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substInScope"><span class="hs-identifier hs-var">substInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier hs-var">extendIdSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendIdSubstList"><span class="hs-identifier hs-var">extendIdSubstList</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTCvSubst"><span class="hs-identifier hs-var">extendTCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendTvSubstList"><span class="hs-identifier hs-var">extendTvSubstList</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendSubstList"><span class="hs-identifier hs-var">extendSubstList</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendSubstWithVar"><span class="hs-identifier hs-var">extendSubstWithVar</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#zapSubstEnv"><span class="hs-identifier hs-var">zapSubstEnv</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="CoreSubst.html#addInScopeSet"><span class="hs-identifier hs-var">addInScopeSet</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendInScope"><span class="hs-identifier hs-var">extendInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendInScopeList"><span class="hs-identifier hs-var">extendInScopeList</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendInScopeIds"><span class="hs-identifier hs-var">extendInScopeIds</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="CoreSubst.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#setInScope"><span class="hs-identifier hs-var">setInScope</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="CoreSubst.html#delBndr"><span class="hs-identifier hs-var">delBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#delBndrs"><span class="hs-identifier hs-var">delBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>        </span><span class="hs-comment">-- ** Substituting and cloning binders</span><span>
</span><a name="line-31"></a><span>        </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="CoreSubst.html#cloneBndr"><span class="hs-identifier hs-var">cloneBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneBndrs"><span class="hs-identifier hs-var">cloneBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneIdBndr"><span class="hs-identifier hs-var">cloneIdBndr</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneIdBndrs"><span class="hs-identifier hs-var">cloneIdBndrs</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#cloneRecIdBndrs"><span class="hs-identifier hs-var">cloneRecIdBndrs</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span> </span><a href="CoreFVs.html"><span class="hs-identifier">CoreFVs</span></a><span>
</span><a name="line-43"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSeq.html"><span class="hs-identifier">CoreSeq</span></a><span>
</span><a name="line-44"></a><span class="hs-keyword">import</span><span> </span><a href="CoreUtils.html"><span class="hs-identifier">CoreUtils</span></a><span>
</span><a name="line-45"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>
</span><a name="line-46"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span>        </span><span class="hs-comment">-- We are defining local versions</span><span>
</span><a name="line-49"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span>     </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendCvSubst"><span class="hs-identifier hs-var">extendCvSubst</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#extendTvSubstList"><span class="hs-identifier hs-var">extendTvSubstList</span></a><span>
</span><a name="line-50"></a><span>                       </span><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#isInScope"><span class="hs-identifier hs-var">isInScope</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#cloneTyVarBndr"><span class="hs-identifier hs-var">cloneTyVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>
</span><a name="line-53"></a><span class="hs-keyword">import</span><span> </span><a href="PrelNames.html"><span class="hs-identifier">PrelNames</span></a><span>
</span><a name="line-54"></a><span class="hs-keyword">import</span><span> </span><a href="VarSet.html"><span class="hs-identifier">VarSet</span></a><span>
</span><a name="line-55"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-56"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-57"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>     </span><span class="hs-special">(</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-59"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSupply.html"><span class="hs-identifier">UniqSupply</span></a><span>
</span><a name="line-61"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-63"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><a href="PprCore.html"><span class="hs-identifier">PprCore</span></a><span>          </span><span class="hs-special">(</span><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- Instances</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Substitutions}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-76"></a><span>
</span><a name="line-77"></a><span class="hs-comment">-- | A substitution environment, containing 'Id', 'TyVar', and 'CoVar'</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- substitutions.</span><span>
</span><a name="line-79"></a><span class="hs-comment">--</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- Some invariants apply to how you use the substitution:</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- 1. Note [The substitution invariant] in TyCoRep</span><span>
</span><a name="line-83"></a><span class="hs-comment">--</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- 2. Note [Substitutions apply only once] in TyCoRep</span><span>
</span><a name="line-85"></a><span class="hs-keyword">data</span><span> </span><a name="Subst"><a href="CoreSubst.html#Subst"><span class="hs-identifier">Subst</span></a></a><span>
</span><a name="line-86"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Subst"><a href="CoreSubst.html#Subst"><span class="hs-identifier">Subst</span></a></a><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span>  </span><span class="hs-comment">-- Variables in in scope (both Ids and TyVars) /after/</span><span>
</span><a name="line-87"></a><span>                      </span><span class="hs-comment">-- applying the substitution</span><span>
</span><a name="line-88"></a><span>          </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span>  </span><span class="hs-comment">-- Substitution from NcIds to CoreExprs</span><span>
</span><a name="line-89"></a><span>          </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span>  </span><span class="hs-comment">-- Substitution from TyVars to Types</span><span>
</span><a name="line-90"></a><span>          </span><a href="TyCoRep.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a><span>  </span><span class="hs-comment">-- Substitution from CoVars to Coercions</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span>        </span><span class="hs-comment">-- INVARIANT 1: See TyCoRep Note [The substitution invariant]</span><span>
</span><a name="line-93"></a><span>        </span><span class="hs-comment">-- This is what lets us deal with name capture properly</span><span>
</span><a name="line-94"></a><span>        </span><span class="hs-comment">-- It's a hard invariant to check...</span><span>
</span><a name="line-95"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-96"></a><span>        </span><span class="hs-comment">-- INVARIANT 2: The substitution is apply-once; see Note [Apply once] with</span><span>
</span><a name="line-97"></a><span>        </span><span class="hs-comment">--              Types.TvSubstEnv</span><span>
</span><a name="line-98"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-99"></a><span>        </span><span class="hs-comment">-- INVARIANT 3: See Note [Extending the Subst]</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">{-
Note [Extending the Subst]
~~~~~~~~~~~~~~~~~~~~~~~~~~
For a core Subst, which binds Ids as well, we make a different choice for Ids
than we do for TyVars.

For TyVars, see Note [Extending the TCvSubst] with Type.TvSubstEnv

For Ids, we have a different invariant
        The IdSubstEnv is extended *only* when the Unique on an Id changes
        Otherwise, we just extend the InScopeSet

In consequence:

* If all subst envs are empty, substExpr would be a
  no-op, so substExprSC (&quot;short cut&quot;) does nothing.

  However, substExpr still goes ahead and substitutes.  Reason: we may
  want to replace existing Ids with new ones from the in-scope set, to
  avoid space leaks.

* In substIdBndr, we extend the IdSubstEnv only when the unique changes

* If the CvSubstEnv, TvSubstEnv and IdSubstEnv are all empty,
  substExpr does nothing (Note that the above rule for substIdBndr
  maintains this property.  If the incoming envts are both empty, then
  substituting the type and IdInfo can't change anything.)

* In lookupIdSubst, we *must* look up the Id in the in-scope set, because
  it may contain non-trivial changes.  Example:
        (/\a. \x:a. ...x...) Int
  We extend the TvSubstEnv with [a |-&gt; Int]; but x's unique does not change
  so we only extend the in-scope set.  Then we must look up in the in-scope
  set when we find the occurrence of x.

* The requirement to look up the Id in the in-scope set means that we
  must NOT take no-op short cut when the IdSubst is empty.
  We must still look up every Id in the in-scope set.

* (However, we don't need to do so for expressions found in the IdSubst
  itself, whose range is assumed to be correct wrt the in-scope set.)

Why do we make a different choice for the IdSubstEnv than the
TvSubstEnv and CvSubstEnv?

* For Ids, we change the IdInfo all the time (e.g. deleting the
  unfolding), and adding it back later, so using the TyVar convention
  would entail extending the substitution almost all the time

* The simplifier wants to look up in the in-scope set anyway, in case it
  can see a better unfolding from an enclosing case expression

* For TyVars, only coercion variables can possibly change, and they are
  easy to spot
-}</span><span>
</span><a name="line-156"></a><span>
</span><a name="line-157"></a><span class="hs-comment">-- | An environment for substituting for 'Id's</span><span>
</span><a name="line-158"></a><span class="hs-keyword">type</span><span> </span><a name="IdSubstEnv"><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier">IdSubstEnv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#IdEnv"><span class="hs-identifier hs-type">IdEnv</span></a><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>   </span><span class="hs-comment">-- Domain is NcIds, i.e. not coercions</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-comment">----------------------------</span><span>
</span><a name="line-161"></a><span class="hs-identifier">isEmptySubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-162"></a><a name="isEmptySubst"><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier">isEmptySubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674003"><a href="#local-6989586621684674003"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-6989586621684674004"><a href="#local-6989586621684674004"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-6989586621684674005"><a href="#local-6989586621684674005"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674003"><span class="hs-identifier hs-var">id_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674004"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674005"><span class="hs-identifier hs-var">cv_env</span></a><span>
</span><a name="line-164"></a><span>
</span><a name="line-165"></a><span class="hs-identifier">emptySubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-166"></a><a name="emptySubst"><a href="CoreSubst.html#emptySubst"><span class="hs-identifier">emptySubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="VarEnv.html#emptyInScopeSet"><span class="hs-identifier hs-var">emptyInScopeSet</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-identifier">mkEmptySubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-169"></a><a name="mkEmptySubst"><a href="CoreSubst.html#mkEmptySubst"><span class="hs-identifier">mkEmptySubst</span></a></a><span> </span><a name="local-6989586621684674006"><a href="#local-6989586621684674006"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674006"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-170"></a><span>
</span><a name="line-171"></a><span class="hs-identifier">mkSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TvSubstEnv"><span class="hs-identifier hs-type">TvSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#CvSubstEnv"><span class="hs-identifier hs-type">CvSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#IdSubstEnv"><span class="hs-identifier hs-type">IdSubstEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-172"></a><a name="mkSubst"><a href="CoreSubst.html#mkSubst"><span class="hs-identifier">mkSubst</span></a></a><span> </span><a name="local-6989586621684674007"><a href="#local-6989586621684674007"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674008"><a href="#local-6989586621684674008"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674009"><a href="#local-6989586621684674009"><span class="hs-identifier">cvs</span></a></a><span> </span><a name="local-6989586621684674010"><a href="#local-6989586621684674010"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674007"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674010"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674008"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674009"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">-- | Find the in-scope set: see TyCoRep Note [The substitution invariant]</span><span>
</span><a name="line-175"></a><span class="hs-identifier">substInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span>
</span><a name="line-176"></a><a name="substInScope"><a href="CoreSubst.html#substInScope"><span class="hs-identifier">substInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674011"><a href="#local-6989586621684674011"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674011"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-comment">-- | Remove all substitutions for 'Id's and 'Var's that might have been built up</span><span>
</span><a name="line-179"></a><span class="hs-comment">-- while preserving the in-scope set</span><span>
</span><a name="line-180"></a><span class="hs-identifier">zapSubstEnv</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-181"></a><a name="zapSubstEnv"><a href="CoreSubst.html#zapSubstEnv"><span class="hs-identifier">zapSubstEnv</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674012"><a href="#local-6989586621684674012"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674012"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span> </span><a href="VarEnv.html#emptyVarEnv"><span class="hs-identifier hs-var">emptyVarEnv</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-comment">-- | Add a substitution for an 'Id' to the 'Subst': you must ensure that the in-scope set is</span><span>
</span><a name="line-184"></a><span class="hs-comment">-- such that TyCoRep Note [The substitution invariant]</span><span>
</span><a name="line-185"></a><span class="hs-comment">-- holds after extending the substitution like this</span><span>
</span><a name="line-186"></a><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-187"></a><span class="hs-comment">-- ToDo: add an ASSERT that fvs(subst-result) is already in the in-scope set</span><span>
</span><a name="line-188"></a><a name="extendIdSubst"><a href="CoreSubst.html#extendIdSubst"><span class="hs-identifier">extendIdSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674013"><a href="#local-6989586621684674013"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674014"><a href="#local-6989586621684674014"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674015"><a href="#local-6989586621684674015"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674016"><a href="#local-6989586621684674016"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674017"><a href="#local-6989586621684674017"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684674018"><a href="#local-6989586621684674018"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-189"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isNonCoVarId</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-operator hs-var">$$</span></a><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">r</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674013"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684674014"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674017"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684674018"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674015"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674016"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- | Adds multiple 'Id' substitutions to the 'Subst': see also 'extendIdSubst'</span><span>
</span><a name="line-193"></a><span class="hs-identifier">extendIdSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-194"></a><a name="extendIdSubstList"><a href="CoreSubst.html#extendIdSubstList"><span class="hs-identifier">extendIdSubstList</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674019"><a href="#local-6989586621684674019"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674020"><a href="#local-6989586621684674020"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674021"><a href="#local-6989586621684674021"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674022"><a href="#local-6989586621684674022"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674023"><a href="#local-6989586621684674023"><span class="hs-identifier">prs</span></a></a><span>
</span><a name="line-195"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">all</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">isNonCoVarId</span><span> </span><span class="hs-operator">.</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">fst</span></a><span class="hs-special">)</span><span> </span><a href="Var.html#isNonCoVarId"><span class="hs-identifier hs-var">prs</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674019"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnvList"><span class="hs-identifier hs-var">extendVarEnvList</span></a><span> </span><a href="#local-6989586621684674020"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674023"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674021"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674022"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">-- | Add a substitution for a 'TyVar' to the 'Subst'</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- The 'TyVar' *must* be a real TyVar, and not a CoVar</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- You must ensure that the in-scope set is such that</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- TyCoRep Note [The substitution invariant] holds</span><span>
</span><a name="line-202"></a><span class="hs-comment">-- after extending the substitution like this.</span><span>
</span><a name="line-203"></a><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-204"></a><a name="extendTvSubst"><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier">extendTvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674024"><a href="#local-6989586621684674024"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674025"><a href="#local-6989586621684674025"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674026"><a href="#local-6989586621684674026"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674027"><a href="#local-6989586621684674027"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674028"><a href="#local-6989586621684674028"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621684674029"><a href="#local-6989586621684674029"><span class="hs-identifier">ty</span></a></a><span>
</span><a name="line-205"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">tv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-206"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674024"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674025"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684674026"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674028"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621684674029"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674027"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span class="hs-comment">-- | Adds multiple 'TyVar' substitutions to the 'Subst': see also 'extendTvSubst'</span><span>
</span><a name="line-209"></a><span class="hs-identifier">extendTvSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">,</span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-210"></a><a name="extendTvSubstList"><a href="CoreSubst.html#extendTvSubstList"><span class="hs-identifier">extendTvSubstList</span></a></a><span> </span><a name="local-6989586621684674030"><a href="#local-6989586621684674030"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674031"><a href="#local-6989586621684674031"><span class="hs-identifier">vrs</span></a></a><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621684674032"><span class="hs-identifier hs-var">extend</span></a><span> </span><a href="#local-6989586621684674030"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674031"><span class="hs-identifier hs-var">vrs</span></a><span>
</span><a name="line-212"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-213"></a><span>    </span><a name="local-6989586621684674032"><a href="#local-6989586621684674032"><span class="hs-identifier">extend</span></a></a><span> </span><a name="local-6989586621684674033"><a href="#local-6989586621684674033"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684674034"><a href="#local-6989586621684674034"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674035"><a href="#local-6989586621684674035"><span class="hs-identifier">r</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendTvSubst"><span class="hs-identifier hs-var">extendTvSubst</span></a><span> </span><a href="#local-6989586621684674033"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674034"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684674035"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">-- | Add a substitution from a 'CoVar' to a 'Coercion' to the 'Subst':</span><span>
</span><a name="line-216"></a><span class="hs-comment">-- you must ensure that the in-scope set satisfies</span><span>
</span><a name="line-217"></a><span class="hs-comment">-- TyCoRep Note [The substitution invariant]</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- after extending the substitution like this</span><span>
</span><a name="line-219"></a><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#CoVar"><span class="hs-identifier hs-type">CoVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-220"></a><a name="extendCvSubst"><a href="CoreSubst.html#extendCvSubst"><span class="hs-identifier">extendCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674036"><a href="#local-6989586621684674036"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674037"><a href="#local-6989586621684674037"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674038"><a href="#local-6989586621684674038"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674039"><a href="#local-6989586621684674039"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674040"><a href="#local-6989586621684674040"><span class="hs-identifier">v</span></a></a><span> </span><a name="local-6989586621684674041"><a href="#local-6989586621684674041"><span class="hs-identifier">r</span></a></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">v</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-222"></a><span>    </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674036"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674037"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674038"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684674039"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621684674040"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684674041"><span class="hs-identifier hs-var">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>
</span><a name="line-224"></a><span class="hs-comment">-- | Add a substitution appropriate to the thing being substituted</span><span>
</span><a name="line-225"></a><span class="hs-comment">--   (whether an expression, type, or coercion). See also</span><span>
</span><a name="line-226"></a><span class="hs-comment">--   'extendIdSubst', 'extendTvSubst', 'extendCvSubst'</span><span>
</span><a name="line-227"></a><span class="hs-identifier">extendSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-228"></a><a name="extendSubst"><a href="CoreSubst.html#extendSubst"><span class="hs-identifier">extendSubst</span></a></a><span> </span><a name="local-6989586621684674042"><a href="#local-6989586621684674042"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674043"><a href="#local-6989586621684674043"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621684674044"><a href="#local-6989586621684674044"><span class="hs-identifier">arg</span></a></a><span>
</span><a name="line-229"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684674044"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-230"></a><span>      </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684674045"><a href="#local-6989586621684674045"><span class="hs-identifier">ty</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-231"></a><span>      </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684674046"><a href="#local-6989586621684674046"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-232"></a><span>      </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span>    </span><span class="hs-identifier hs-var">var</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-identifier">extendSubstWithVar</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-235"></a><a name="extendSubstWithVar"><a href="CoreSubst.html#extendSubstWithVar"><span class="hs-identifier">extendSubstWithVar</span></a></a><span> </span><a name="local-6989586621684674047"><a href="#local-6989586621684674047"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674048"><a href="#local-6989586621684674048"><span class="hs-identifier">v1</span></a></a><span> </span><a name="local-6989586621684674049"><a href="#local-6989586621684674049"><span class="hs-identifier">v2</span></a></a><span>
</span><a name="line-236"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684674048"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isTyVar</span><span> </span><span class="hs-identifier hs-var">v2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendTvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkTyVarTy</span><span> </span><span class="hs-identifier">v2</span><span class="hs-special">)</span><span>
</span><a name="line-237"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684674048"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isCoVar</span><span> </span><span class="hs-identifier hs-var">v2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendCvSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">mkCoVarCo</span><span> </span><span class="hs-identifier">v2</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT</span><span class="hs-special">(</span><span> </span><a href="Util.html#debugIsOn"><span class="hs-identifier hs-var">isId</span></a><span>    </span><span class="hs-identifier hs-var">v2</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-identifier">extendIdSubst</span><span> </span><span class="hs-identifier">subst</span><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v1</span></a><span> </span><span class="hs-special">(</span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="Panic.html#assertPanic"><span class="hs-identifier hs-var">v2</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- | Add a substitution as appropriate to each of the terms being</span><span>
</span><a name="line-241"></a><span class="hs-comment">--   substituted (whether expressions, types, or coercions). See also</span><span>
</span><a name="line-242"></a><span class="hs-comment">--   'extendSubst'.</span><span>
</span><a name="line-243"></a><span class="hs-identifier">extendSubstList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-244"></a><a name="extendSubstList"><a href="CoreSubst.html#extendSubstList"><span class="hs-identifier">extendSubstList</span></a></a><span> </span><a name="local-6989586621684674050"><a href="#local-6989586621684674050"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674050"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-245"></a><span class="hs-identifier">extendSubstList</span><span> </span><a name="local-6989586621684674051"><a href="#local-6989586621684674051"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a name="local-6989586621684674052"><a href="#local-6989586621684674052"><span class="hs-identifier">var</span></a></a><span class="hs-special">,</span><a name="local-6989586621684674053"><a href="#local-6989586621684674053"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span class="hs-glyph">:</span><a name="local-6989586621684674054"><a href="#local-6989586621684674054"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#extendSubstList"><span class="hs-identifier hs-var">extendSubstList</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#extendSubst"><span class="hs-identifier hs-var">extendSubst</span></a><span> </span><a href="#local-6989586621684674051"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674052"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621684674053"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674054"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">-- | Find the substitution for an 'Id' in the 'Subst'</span><span>
</span><a name="line-248"></a><span class="hs-identifier">lookupIdSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-249"></a><a name="lookupIdSubst"><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier">lookupIdSubst</span></a></a><span> </span><a name="local-6989586621684674055"><a href="#local-6989586621684674055"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674056"><a href="#local-6989586621684674056"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674057"><a href="#local-6989586621684674057"><span class="hs-identifier">ids</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621684674058"><a href="#local-6989586621684674058"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-250"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Var.html#isLocalId"><span class="hs-identifier hs-var">isLocalId</span></a><span> </span><a href="#local-6989586621684674058"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684674058"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-251"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684674059"><a href="#local-6989586621684674059"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684674057"><span class="hs-identifier hs-var">ids</span></a><span>       </span><a href="#local-6989586621684674058"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674059"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-252"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684674060"><a href="#local-6989586621684674060"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="VarEnv.html#lookupInScope"><span class="hs-identifier hs-var">lookupInScope</span></a><span> </span><a href="#local-6989586621684674056"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674058"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684674060"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-253"></a><span>        </span><span class="hs-comment">-- Vital! See Note [Extending the Subst]</span><span>
</span><a name="line-254"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WARN</span><span class="hs-special">(</span><span> </span><a href="Outputable.html#warnPprTrace"><span class="hs-identifier hs-var">True</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">text</span><span> </span><span class="hs-string">&quot;CoreSubst.lookupIdSubst&quot;</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">doc</span><span> </span><span class="hs-operator">&lt;+&gt;</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">v</span><span>
</span><a name="line-255"></a><span>                            </span><span class="hs-operator">$$</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">in_scope</span><span class="hs-special">)</span><span>
</span><a name="line-256"></a><span>                </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684674058"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-257"></a><span>
</span><a name="line-258"></a><span class="hs-comment">-- | Find the substitution for a 'TyVar' in the 'Subst'</span><span>
</span><a name="line-259"></a><span class="hs-identifier">lookupTCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-260"></a><a name="lookupTCvSubst"><a href="CoreSubst.html#lookupTCvSubst"><span class="hs-identifier">lookupTCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674061"><a href="#local-6989586621684674061"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674062"><a href="#local-6989586621684674062"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674063"><a href="#local-6989586621684674063"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-261"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684674063"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-262"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684674061"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674063"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="TyCoRep.html#mkTyVarTy"><span class="hs-identifier hs-var">Type.mkTyVarTy</span></a><span> </span><a href="#local-6989586621684674063"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-263"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Type.html#mkCoercionTy"><span class="hs-identifier hs-var">mkCoercionTy</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684674062"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621684674063"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621684674063"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-265"></a><span>
</span><a name="line-266"></a><span class="hs-identifier">delBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-267"></a><a name="delBndr"><a href="CoreSubst.html#delBndr"><span class="hs-identifier">delBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674064"><a href="#local-6989586621684674064"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674065"><a href="#local-6989586621684674065"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674066"><a href="#local-6989586621684674066"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674067"><a href="#local-6989586621684674067"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674068"><a href="#local-6989586621684674068"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-268"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684674068"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674064"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674065"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674066"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-6989586621684674067"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621684674068"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-269"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684674068"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674064"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674065"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-6989586621684674066"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674068"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674067"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-270"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674064"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-6989586621684674065"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674068"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674066"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674067"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-271"></a><span>
</span><a name="line-272"></a><span class="hs-identifier">delBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-273"></a><a name="delBndrs"><a href="CoreSubst.html#delBndrs"><span class="hs-identifier">delBndrs</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674069"><a href="#local-6989586621684674069"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674070"><a href="#local-6989586621684674070"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674071"><a href="#local-6989586621684674071"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674072"><a href="#local-6989586621684674072"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674073"><a href="#local-6989586621684674073"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-274"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674069"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span> </span><a href="#local-6989586621684674070"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674073"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span> </span><a href="#local-6989586621684674071"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674073"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span> </span><a href="#local-6989586621684674072"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621684674073"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>      </span><span class="hs-comment">-- Easiest thing is just delete all from all!</span><span>
</span><a name="line-276"></a><span>
</span><a name="line-277"></a><span class="hs-comment">-- | Simultaneously substitute for a bunch of variables</span><span>
</span><a name="line-278"></a><span class="hs-comment">--   No left-right shadowing</span><span>
</span><a name="line-279"></a><span class="hs-comment">--   ie the substitution for   (\x \y. e) a1 a2</span><span>
</span><a name="line-280"></a><span class="hs-comment">--      so neither x nor y scope over a1 a2</span><span>
</span><a name="line-281"></a><span class="hs-identifier">mkOpenSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">,</span><a href="CoreSyn.html#CoreArg"><span class="hs-identifier hs-type">CoreArg</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-282"></a><a name="mkOpenSubst"><a href="CoreSubst.html#mkOpenSubst"><span class="hs-identifier">mkOpenSubst</span></a></a><span> </span><a name="local-6989586621684674074"><a href="#local-6989586621684674074"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674075"><a href="#local-6989586621684674075"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674074"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-283"></a><span>                                   </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684674076"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">,</span><a href="#local-6989586621684674077"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684674076"><a href="#local-6989586621684674076"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674077"><a href="#local-6989586621684674077"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684674075"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684674076"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-284"></a><span>                                   </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684674078"><span class="hs-identifier hs-var">tv</span></a><span class="hs-special">,</span><a href="#local-6989586621684674079"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684674078"><a href="#local-6989586621684674078"><span class="hs-identifier">tv</span></a></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684674079"><a href="#local-6989586621684674079"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684674075"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>                                   </span><span class="hs-special">(</span><a href="VarEnv.html#mkVarEnv"><span class="hs-identifier hs-var">mkVarEnv</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621684674080"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="#local-6989586621684674081"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684674080"><a href="#local-6989586621684674080"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684674081"><a href="#local-6989586621684674081"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621684674075"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-286"></a><span>
</span><a name="line-287"></a><span class="hs-comment">------------------------------</span><span>
</span><a name="line-288"></a><span class="hs-identifier">isInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-289"></a><a name="isInScope"><a href="CoreSubst.html#isInScope"><span class="hs-identifier">isInScope</span></a></a><span> </span><a name="local-6989586621684674082"><a href="#local-6989586621684674082"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674083"><a href="#local-6989586621684674083"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674082"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#elemInScopeSet"><span class="hs-identifier hs-var">elemInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674083"><span class="hs-identifier hs-var">in_scope</span></a><span>
</span><a name="line-290"></a><span>
</span><a name="line-291"></a><span class="hs-comment">-- | Add the 'Var' to the in-scope set, but do not remove</span><span>
</span><a name="line-292"></a><span class="hs-comment">-- any existing substitutions for it</span><span>
</span><a name="line-293"></a><span class="hs-identifier">addInScopeSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#VarSet"><span class="hs-identifier hs-type">VarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-294"></a><a name="addInScopeSet"><a href="CoreSubst.html#addInScopeSet"><span class="hs-identifier">addInScopeSet</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674084"><a href="#local-6989586621684674084"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674085"><a href="#local-6989586621684674085"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674086"><a href="#local-6989586621684674086"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674087"><a href="#local-6989586621684674087"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674088"><a href="#local-6989586621684674088"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-295"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674084"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetSet"><span class="hs-identifier hs-var">extendInScopeSetSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674088"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674085"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674086"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674087"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- | Add the 'Var' to the in-scope set: as a side effect,</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- and remove any existing substitutions for it</span><span>
</span><a name="line-299"></a><span class="hs-identifier">extendInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-300"></a><a name="extendInScope"><a href="CoreSubst.html#extendInScope"><span class="hs-identifier">extendInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674089"><a href="#local-6989586621684674089"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674090"><a href="#local-6989586621684674090"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674091"><a href="#local-6989586621684674091"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674092"><a href="#local-6989586621684674092"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674093"><a href="#local-6989586621684674093"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-301"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674089"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674093"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-302"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621684674090"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674093"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674091"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674093"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674092"><span class="hs-identifier hs-var">cvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674093"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-comment">-- | Add the 'Var's to the in-scope set: see also 'extendInScope'</span><span>
</span><a name="line-305"></a><span class="hs-identifier">extendInScopeList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-306"></a><a name="extendInScopeList"><a href="CoreSubst.html#extendInScopeList"><span class="hs-identifier">extendInScopeList</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674094"><a href="#local-6989586621684674094"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674095"><a href="#local-6989586621684674095"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674096"><a href="#local-6989586621684674096"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674097"><a href="#local-6989586621684674097"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674098"><a href="#local-6989586621684674098"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-307"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674094"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetList"><span class="hs-identifier hs-var">extendInScopeSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674098"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621684674095"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674098"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674096"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674098"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674097"><span class="hs-identifier hs-var">cvs</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674098"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-comment">-- | Optimized version of 'extendInScopeList' that can be used if you are certain</span><span>
</span><a name="line-311"></a><span class="hs-comment">-- all the things being added are 'Id's and hence none are 'TyVar's or 'CoVar's</span><span>
</span><a name="line-312"></a><span class="hs-identifier">extendInScopeIds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-313"></a><a name="extendInScopeIds"><a href="CoreSubst.html#extendInScopeIds"><span class="hs-identifier">extendInScopeIds</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674099"><a href="#local-6989586621684674099"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674100"><a href="#local-6989586621684674100"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674101"><a href="#local-6989586621684674101"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674102"><a href="#local-6989586621684674102"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674103"><a href="#local-6989586621684674103"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-314"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674099"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSetList"><span class="hs-identifier hs-var">extendInScopeSetList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674103"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span>
</span><a name="line-315"></a><span>          </span><span class="hs-special">(</span><a href="#local-6989586621684674100"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#delVarEnvList"><span class="hs-identifier hs-var">delVarEnvList</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674103"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674101"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674102"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-316"></a><span>
</span><a name="line-317"></a><span class="hs-identifier">setInScope</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#InScopeSet"><span class="hs-identifier hs-type">InScopeSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>
</span><a name="line-318"></a><a name="setInScope"><a href="CoreSubst.html#setInScope"><span class="hs-identifier">setInScope</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674104"><a href="#local-6989586621684674104"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674105"><a href="#local-6989586621684674105"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674106"><a href="#local-6989586621684674106"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674107"><a href="#local-6989586621684674107"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674107"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674104"><span class="hs-identifier hs-var">ids</span></a><span> </span><a href="#local-6989586621684674105"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674106"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-comment">-- Pretty printing, for debugging only</span><span>
</span><a name="line-321"></a><span>
</span><a name="line-322"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-323"></a><span>  </span><a name="local-8214565720324887700"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684673998"><a href="#local-6989586621684673998"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684673999"><a href="#local-6989586621684673999"><span class="hs-identifier">ids</span></a></a><span> </span><a name="local-6989586621684674000"><a href="#local-6989586621684674000"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674001"><a href="#local-6989586621684674001"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-324"></a><span>        </span><span class="hs-glyph">=</span><span>  </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;&lt;InScope =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="#local-6989586621684674002"><span class="hs-identifier hs-var">in_scope_doc</span></a><span>
</span><a name="line-325"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; IdSubst   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684673999"><span class="hs-identifier hs-var">ids</span></a><span>
</span><a name="line-326"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; TvSubst   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674000"><span class="hs-identifier hs-var">tvs</span></a><span>
</span><a name="line-327"></a><span>        </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; CvSubst   =&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674001"><span class="hs-identifier hs-var">cvs</span></a><span>
</span><a name="line-328"></a><span>         </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#char"><span class="hs-identifier hs-var">char</span></a><span> </span><span class="hs-char">'&gt;'</span><span>
</span><a name="line-329"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-330"></a><span>    </span><a name="local-6989586621684674002"><a href="#local-6989586621684674002"><span class="hs-identifier">in_scope_doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#pprVarSet"><span class="hs-identifier hs-var">pprVarSet</span></a><span> </span><span class="hs-special">(</span><a href="VarEnv.html#getInScopeVars"><span class="hs-identifier hs-var">getInScopeVars</span></a><span> </span><a href="#local-6989586621684673998"><span class="hs-identifier hs-var">in_scope</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#braces"><span class="hs-identifier hs-var">braces</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Outputable.html#fsep"><span class="hs-identifier hs-var">fsep</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span class="hs-special">)</span><span>
</span><a name="line-331"></a><span>
</span><a name="line-332"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Substituting expressions
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-comment">-- | Apply a substitution to an entire 'CoreExpr'. Remember, you may only</span><span>
</span><a name="line-341"></a><span class="hs-comment">-- apply the substitution /once/:</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- see Note [Substitutions apply only once] in TyCoRep</span><span>
</span><a name="line-343"></a><span class="hs-comment">--</span><span>
</span><a name="line-344"></a><span class="hs-comment">-- Do *not* attempt to short-cut in the case of an empty substitution!</span><span>
</span><a name="line-345"></a><span class="hs-comment">-- See Note [Extending the Subst]</span><span>
</span><a name="line-346"></a><span class="hs-identifier">substExprSC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-347"></a><a name="substExprSC"><a href="CoreSubst.html#substExprSC"><span class="hs-identifier">substExprSC</span></a></a><span> </span><a name="local-6989586621684674108"><a href="#local-6989586621684674108"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621684674109"><a href="#local-6989586621684674109"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674110"><a href="#local-6989586621684674110"><span class="hs-identifier">orig_expr</span></a></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-6989586621684674109"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674110"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-349"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;enter subst-expr&quot; (doc $$ ppr orig_expr) $</span><span>
</span><a name="line-350"></a><span>                         </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621684674108"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621684674109"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674110"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-351"></a><span>
</span><a name="line-352"></a><span class="hs-identifier">substExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-353"></a><a name="substExpr"><a href="CoreSubst.html#substExpr"><span class="hs-identifier">substExpr</span></a></a><span> </span><a name="local-6989586621684674111"><a href="#local-6989586621684674111"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621684674112"><a href="#local-6989586621684674112"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674113"><a href="#local-6989586621684674113"><span class="hs-identifier">orig_expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621684674111"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621684674112"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674113"><span class="hs-identifier hs-var">orig_expr</span></a><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-identifier">subst_expr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-356"></a><a name="subst_expr"><a href="CoreSubst.html#subst_expr"><span class="hs-identifier">subst_expr</span></a></a><span> </span><a name="local-6989586621684674114"><a href="#local-6989586621684674114"><span class="hs-identifier">doc</span></a></a><span> </span><a name="local-6989586621684674115"><a href="#local-6989586621684674115"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674116"><a href="#local-6989586621684674116"><span class="hs-identifier">expr</span></a></a><span>
</span><a name="line-357"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674117"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684674116"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-358"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-359"></a><span>    </span><a name="local-6989586621684674117"><a href="#local-6989586621684674117"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684674119"><a href="#local-6989586621684674119"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674114"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst_expr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674119"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-360"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684674120"><a href="#local-6989586621684674120"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674120"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-361"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684674121"><a href="#local-6989586621684674121"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674121"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-362"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621684674122"><a href="#local-6989586621684674122"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621684674122"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-363"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684674123"><a href="#local-6989586621684674123"><span class="hs-identifier">fun</span></a></a><span> </span><a name="local-6989586621684674124"><a href="#local-6989586621684674124"><span class="hs-identifier">arg</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674117"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684674123"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674117"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684674124"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span>
</span><a name="line-364"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684674125"><a href="#local-6989586621684674125"><span class="hs-identifier">tickish</span></a></a><span> </span><a name="local-6989586621684674126"><a href="#local-6989586621684674126"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#mkTick"><span class="hs-identifier hs-var">mkTick</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTickish"><span class="hs-identifier hs-var">substTickish</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674125"><span class="hs-identifier hs-var">tickish</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674117"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684674126"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684674127"><a href="#local-6989586621684674127"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684674128"><a href="#local-6989586621684674128"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674117"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684674127"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substCo"><span class="hs-identifier hs-var">substCo</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674128"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a><span>       </span><span class="hs-comment">-- Do not optimise even identity coercions</span><span>
</span><a name="line-367"></a><span>       </span><span class="hs-comment">-- Reason: substitution applies to the LHS of RULES, and</span><span>
</span><a name="line-368"></a><span>       </span><span class="hs-comment">--         if you &quot;optimise&quot; an identity coercion, you may</span><span>
</span><a name="line-369"></a><span>       </span><span class="hs-comment">--         lose a binder. We optimise the LHS of rules at</span><span>
</span><a name="line-370"></a><span>       </span><span class="hs-comment">--         construction time</span><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684674129"><a href="#local-6989586621684674129"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684674130"><a href="#local-6989586621684674130"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621684674132"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621684674114"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621684674131"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684674130"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>                       </span><span class="hs-keyword">where</span><span>
</span><a name="line-374"></a><span>                         </span><span class="hs-special">(</span><a name="local-6989586621684674131"><a href="#local-6989586621684674131"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674132"><a href="#local-6989586621684674132"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674129"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-375"></a><span>
</span><a name="line-376"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684674133"><a href="#local-6989586621684674133"><span class="hs-identifier">bind</span></a></a><span> </span><a name="local-6989586621684674134"><a href="#local-6989586621684674134"><span class="hs-identifier">body</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-6989586621684674136"><span class="hs-identifier hs-var">bind'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621684674114"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621684674135"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684674134"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span>
</span><a name="line-377"></a><span>                       </span><span class="hs-keyword">where</span><span>
</span><a name="line-378"></a><span>                         </span><span class="hs-special">(</span><a name="local-6989586621684674135"><a href="#local-6989586621684674135"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674136"><a href="#local-6989586621684674136"><span class="hs-identifier">bind'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674133"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-379"></a><span>
</span><a name="line-380"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684674137"><a href="#local-6989586621684674137"><span class="hs-identifier">scrut</span></a></a><span> </span><a name="local-6989586621684674138"><a href="#local-6989586621684674138"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684674139"><a href="#local-6989586621684674139"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684674140"><a href="#local-6989586621684674140"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674117"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621684674137"><span class="hs-identifier hs-var">scrut</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674142"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674139"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674118"><span class="hs-identifier hs-var">go_alt</span></a><span> </span><a href="#local-6989586621684674141"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674140"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-381"></a><span>                                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-382"></a><span>                                 </span><span class="hs-special">(</span><a name="local-6989586621684674141"><a href="#local-6989586621684674141"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674142"><a href="#local-6989586621684674142"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621684674115"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674138"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span>    </span><a name="local-6989586621684674118"><a href="#local-6989586621684674118"><span class="hs-identifier">go_alt</span></a></a><span> </span><a name="local-6989586621684674143"><a href="#local-6989586621684674143"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684674144"><a href="#local-6989586621684674144"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674145"><a href="#local-6989586621684674145"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674146"><a href="#local-6989586621684674146"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674144"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674148"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><a href="#local-6989586621684674114"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621684674147"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684674146"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-385"></a><span>                                 </span><span class="hs-keyword">where</span><span>
</span><a name="line-386"></a><span>                                   </span><span class="hs-special">(</span><a name="local-6989586621684674147"><a href="#local-6989586621684674147"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674148"><a href="#local-6989586621684674148"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621684674143"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674145"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-387"></a><span>
</span><a name="line-388"></a><span class="hs-comment">-- | Apply a substitution to an entire 'CoreBind', additionally returning an updated 'Subst'</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- that should be used by subsequent substitutions.</span><span>
</span><a name="line-390"></a><span class="hs-identifier">substBind</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">substBindSC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-391"></a><span>
</span><a name="line-392"></a><a name="substBindSC"><a href="CoreSubst.html#substBindSC"><span class="hs-identifier">substBindSC</span></a></a><span> </span><a name="local-6989586621684674149"><a href="#local-6989586621684674149"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674150"><a href="#local-6989586621684674150"><span class="hs-identifier">bind</span></a></a><span>    </span><span class="hs-comment">-- Short-cut if the substitution is empty</span><span>
</span><a name="line-393"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-6989586621684674149"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="#local-6989586621684674149"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674150"><span class="hs-identifier hs-var">bind</span></a><span>
</span><a name="line-395"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-396"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621684674150"><span class="hs-identifier hs-var">bind</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-397"></a><span>       </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621684674151"><a href="#local-6989586621684674151"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684674152"><a href="#local-6989586621684674152"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674153"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684674154"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><a href="#local-6989586621684674152"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-398"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-399"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684674153"><a href="#local-6989586621684674153"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674154"><a href="#local-6989586621684674154"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621684674149"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674151"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-400"></a><span>       </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621684674155"><a href="#local-6989586621684674155"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674158"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674159"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674160"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-401"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-402"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684674156"><a href="#local-6989586621684674156"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674157"><a href="#local-6989586621684674157"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621684674155"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-403"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621684674158"><a href="#local-6989586621684674158"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674159"><a href="#local-6989586621684674159"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span> </span><a href="#local-6989586621684674149"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674156"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-404"></a><span>            </span><a name="local-6989586621684674160"><a href="#local-6989586621684674160"><span class="hs-identifier">rhss'</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-6989586621684674158"><span class="hs-identifier hs-var">subst'</span></a><span>
</span><a name="line-405"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674157"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-406"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-407"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substBindSC&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674158"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674157"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-408"></a><span>
</span><a name="line-409"></a><a name="substBind"><a href="CoreSubst.html#substBind"><span class="hs-identifier">substBind</span></a></a><span> </span><a name="local-6989586621684674161"><a href="#local-6989586621684674161"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621684674162"><a href="#local-6989586621684674162"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684674163"><a href="#local-6989586621684674163"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674164"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684674165"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substBind&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674161"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674163"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-411"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-412"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684674164"><a href="#local-6989586621684674164"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674165"><a href="#local-6989586621684674165"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621684674161"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674162"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-413"></a><span>
</span><a name="line-414"></a><span class="hs-identifier">substBind</span><span> </span><a name="local-6989586621684674166"><a href="#local-6989586621684674166"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621684674167"><a href="#local-6989586621684674167"><span class="hs-identifier">pairs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674170"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674171"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674172"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-416"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-417"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621684674168"><a href="#local-6989586621684674168"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674169"><a href="#local-6989586621684674169"><span class="hs-identifier">rhss</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621684674167"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-418"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621684674170"><a href="#local-6989586621684674170"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674171"><a href="#local-6989586621684674171"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier hs-var">substRecBndrs</span></a><span> </span><a href="#local-6989586621684674166"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674168"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-419"></a><span>       </span><a name="local-6989586621684674172"><a href="#local-6989586621684674172"><span class="hs-identifier">rhss'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#subst_expr"><span class="hs-identifier hs-var">subst_expr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substBind&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674170"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674169"><span class="hs-identifier hs-var">rhss</span></a><span>
</span><a name="line-420"></a><span>
</span><a name="line-421"></a><span class="hs-comment">-- | De-shadowing the program is sometimes a useful pre-pass. It can be done simply</span><span>
</span><a name="line-422"></a><span class="hs-comment">-- by running over the bindings with an empty substitution, because substitution</span><span>
</span><a name="line-423"></a><span class="hs-comment">-- returns a result that has no-shadowing guaranteed.</span><span>
</span><a name="line-424"></a><span class="hs-comment">--</span><span>
</span><a name="line-425"></a><span class="hs-comment">-- (Actually, within a single /type/ there might still be shadowing, because</span><span>
</span><a name="line-426"></a><span class="hs-comment">-- 'substTy' is a no-op for the empty substitution, but that's probably OK.)</span><span>
</span><a name="line-427"></a><span class="hs-comment">--</span><span>
</span><a name="line-428"></a><span class="hs-comment">-- [Aug 09] This function is not used in GHC at the moment, but seems so</span><span>
</span><a name="line-429"></a><span class="hs-comment">--          short and simple that I'm going to leave it here</span><span>
</span><a name="line-430"></a><span class="hs-identifier">deShadowBinds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreProgram"><span class="hs-identifier hs-type">CoreProgram</span></a><span>
</span><a name="line-431"></a><a name="deShadowBinds"><a href="CoreSubst.html#deShadowBinds"><span class="hs-identifier">deShadowBinds</span></a></a><span> </span><a name="local-6989586621684674173"><a href="#local-6989586621684674173"><span class="hs-identifier">binds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="CoreSubst.html#substBind"><span class="hs-identifier hs-var">substBind</span></a><span> </span><a href="CoreSubst.html#emptySubst"><span class="hs-identifier hs-var">emptySubst</span></a><span> </span><a href="#local-6989586621684674173"><span class="hs-identifier hs-var">binds</span></a><span class="hs-special">)</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
        Substituting binders
*                                                                      *
************************************************************************

Remember that substBndr and friends are used when doing expression
substitution only.  Their only business is substitution, so they
preserve all IdInfo (suitably substituted).  For example, we *want* to
preserve occ info in rules.
-}</span><span>
</span><a name="line-445"></a><span>
</span><a name="line-446"></a><span class="hs-comment">-- | Substitutes a 'Var' for another one according to the 'Subst' given, returning</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- the result and an updated 'Subst' that should be used by subsequent substitutions.</span><span>
</span><a name="line-448"></a><span class="hs-comment">-- 'IdInfo' is preserved by this process, although it is substituted into appropriately.</span><span>
</span><a name="line-449"></a><span class="hs-identifier">substBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-450"></a><a name="substBndr"><a href="CoreSubst.html#substBndr"><span class="hs-identifier">substBndr</span></a></a><span> </span><a name="local-6989586621684674174"><a href="#local-6989586621684674174"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674175"><a href="#local-6989586621684674175"><span class="hs-identifier">bndr</span></a></a><span>
</span><a name="line-451"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684674175"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier hs-var">substTyVarBndr</span></a><span> </span><a href="#local-6989586621684674174"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674175"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-452"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684674175"><span class="hs-identifier hs-var">bndr</span></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier hs-var">substCoVarBndr</span></a><span> </span><a href="#local-6989586621684674174"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674175"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-453"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;var-bndr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674174"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674174"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674175"><span class="hs-identifier hs-var">bndr</span></a><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-comment">-- | Applies 'substBndr' to a number of 'Var's, accumulating a new 'Subst' left-to-right</span><span>
</span><a name="line-456"></a><span class="hs-identifier">substBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-457"></a><a name="substBndrs"><a href="CoreSubst.html#substBndrs"><span class="hs-identifier">substBndrs</span></a></a><span> </span><a name="local-6989586621684674176"><a href="#local-6989586621684674176"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674177"><a href="#local-6989586621684674177"><span class="hs-identifier">bndrs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="CoreSubst.html#substBndr"><span class="hs-identifier hs-var">substBndr</span></a><span> </span><a href="#local-6989586621684674176"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674177"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- | Substitute in a mutually recursive group of 'Id's</span><span>
</span><a name="line-460"></a><span class="hs-identifier">substRecBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-461"></a><a name="substRecBndrs"><a href="CoreSubst.html#substRecBndrs"><span class="hs-identifier">substRecBndrs</span></a></a><span> </span><a name="local-6989586621684674178"><a href="#local-6989586621684674178"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674179"><a href="#local-6989586621684674179"><span class="hs-identifier">bndrs</span></a></a><span>
</span><a name="line-462"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674180"><span class="hs-identifier hs-var">new_subst</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674181"><span class="hs-identifier hs-var">new_bndrs</span></a><span class="hs-special">)</span><span>
</span><a name="line-463"></a><span>  </span><span class="hs-keyword">where</span><span>         </span><span class="hs-comment">-- Here's the reason we need to pass rec_subst to subst_id</span><span>
</span><a name="line-464"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684674180"><a href="#local-6989586621684674180"><span class="hs-identifier">new_subst</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674181"><a href="#local-6989586621684674181"><span class="hs-identifier">new_bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substIdBndr"><span class="hs-identifier hs-var">substIdBndr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;rec-bndr&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674180"><span class="hs-identifier hs-var">new_subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674178"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674179"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-465"></a><span>
</span><a name="line-466"></a><span class="hs-identifier">substIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-467"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>            </span><span class="hs-comment">-- ^ Substitution to use for the IdInfo</span><span>
</span><a name="line-468"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>      </span><span class="hs-comment">-- ^ Substitution and Id to transform</span><span>
</span><a name="line-469"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>      </span><span class="hs-comment">-- ^ Transformed pair</span><span>
</span><a name="line-470"></a><span>                                </span><span class="hs-comment">-- NB: unfolding may be zapped</span><span>
</span><a name="line-471"></a><span>
</span><a name="line-472"></a><a name="substIdBndr"><a href="CoreSubst.html#substIdBndr"><span class="hs-identifier">substIdBndr</span></a></a><span> </span><a name="local-6989586621684674182"><a href="#local-6989586621684674182"><span class="hs-identifier">_doc</span></a></a><span> </span><a name="local-6989586621684674183"><a href="#local-6989586621684674183"><span class="hs-identifier">rec_subst</span></a></a><span> </span><a name="local-6989586621684674184"><a href="#local-6989586621684674184"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674185"><a href="#local-6989586621684674185"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674186"><a href="#local-6989586621684674186"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684674187"><a href="#local-6989586621684674187"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674188"><a href="#local-6989586621684674188"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674189"><a href="#local-6989586621684674189"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-473"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- pprTrace &quot;substIdBndr&quot; (doc $$ ppr old_id $$ ppr in_scope) $</span><span>
</span><a name="line-474"></a><span>    </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674185"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674194"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674196"><span class="hs-identifier hs-var">new_env</span></a><span> </span><a href="#local-6989586621684674187"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674188"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674194"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-476"></a><span>    </span><a name="local-6989586621684674190"><a href="#local-6989586621684674190"><span class="hs-identifier">id1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#uniqAway"><span class="hs-identifier hs-var">uniqAway</span></a><span> </span><a href="#local-6989586621684674185"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674189"><span class="hs-identifier hs-var">old_id</span></a><span>      </span><span class="hs-comment">-- id1 is cloned if necessary</span><span>
</span><a name="line-477"></a><span>    </span><a name="local-6989586621684674191"><a href="#local-6989586621684674191"><span class="hs-identifier">id2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684674193"><span class="hs-identifier hs-var">no_type_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674190"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-478"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span> </span><a href="#local-6989586621684674190"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684674184"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674192"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-479"></a><span>
</span><a name="line-480"></a><span>    </span><a name="local-6989586621684674192"><a href="#local-6989586621684674192"><span class="hs-identifier">old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684674189"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-481"></a><span>    </span><a name="local-6989586621684674193"><a href="#local-6989586621684674193"><span class="hs-identifier">no_type_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674187"><span class="hs-identifier hs-var">tvs</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674188"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span>
</span><a name="line-482"></a><span>                     </span><a href="TyCoRep.html#noFreeVarsOfType"><span class="hs-identifier hs-var">noFreeVarsOfType</span></a><span> </span><a href="#local-6989586621684674192"><span class="hs-identifier hs-var">old_ty</span></a><span>
</span><a name="line-483"></a><span>
</span><a name="line-484"></a><span>        </span><span class="hs-comment">-- new_id has the right IdInfo</span><span>
</span><a name="line-485"></a><span>        </span><span class="hs-comment">-- The lazy-set is because we're in a loop here, with</span><span>
</span><a name="line-486"></a><span>        </span><span class="hs-comment">-- rec_subst, when dealing with a mutually-recursive group</span><span>
</span><a name="line-487"></a><span>    </span><a name="local-6989586621684674194"><a href="#local-6989586621684674194"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a><span> </span><a href="#local-6989586621684674195"><span class="hs-identifier hs-var">mb_new_info</span></a><span> </span><a href="#local-6989586621684674191"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-488"></a><span>    </span><a name="local-6989586621684674195"><a href="#local-6989586621684674195"><span class="hs-identifier">mb_new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span> </span><a href="#local-6989586621684674183"><span class="hs-identifier hs-var">rec_subst</span></a><span> </span><a href="#local-6989586621684674191"><span class="hs-identifier hs-var">id2</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621684674191"><span class="hs-identifier hs-var">id2</span></a><span class="hs-special">)</span><span>
</span><a name="line-489"></a><span>        </span><span class="hs-comment">-- NB: unfolding info may be zapped</span><span>
</span><a name="line-490"></a><span>
</span><a name="line-491"></a><span>        </span><span class="hs-comment">-- Extend the substitution if the unique has changed</span><span>
</span><a name="line-492"></a><span>        </span><span class="hs-comment">-- See the notes with substTyVarBndr for the delVarEnv</span><span>
</span><a name="line-493"></a><span>    </span><a name="local-6989586621684674196"><a href="#local-6989586621684674196"><span class="hs-identifier">new_env</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684674197"><span class="hs-identifier hs-var">no_change</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#delVarEnv"><span class="hs-identifier hs-var">delVarEnv</span></a><span> </span><a href="#local-6989586621684674186"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684674189"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-494"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684674186"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684674189"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684674194"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-495"></a><span>
</span><a name="line-496"></a><span>    </span><a name="local-6989586621684674197"><a href="#local-6989586621684674197"><span class="hs-identifier">no_change</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674190"><span class="hs-identifier hs-var">id1</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621684674189"><span class="hs-identifier hs-var">old_id</span></a><span>
</span><a name="line-497"></a><span>        </span><span class="hs-comment">-- See Note [Extending the Subst]</span><span>
</span><a name="line-498"></a><span>        </span><span class="hs-comment">-- it's /not/ necessary to check mb_new_info and no_type_change</span><span>
</span><a name="line-499"></a><span>
</span><a name="line-500"></a><span class="hs-comment">{-
Now a variant that unconditionally allocates a new unique.
It also unconditionally zaps the OccInfo.
-}</span><span>
</span><a name="line-504"></a><span>
</span><a name="line-505"></a><span class="hs-comment">-- | Very similar to 'substBndr', but it always allocates a new 'Unique' for</span><span>
</span><a name="line-506"></a><span class="hs-comment">-- each variable in its output.  It substitutes the IdInfo though.</span><span>
</span><a name="line-507"></a><span class="hs-identifier">cloneIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>
</span><a name="line-508"></a><a name="cloneIdBndr"><a href="CoreSubst.html#cloneIdBndr"><span class="hs-identifier">cloneIdBndr</span></a></a><span> </span><a name="local-6989586621684674198"><a href="#local-6989586621684674198"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674199"><a href="#local-6989586621684674199"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684674200"><a href="#local-6989586621684674200"><span class="hs-identifier">old_id</span></a></a><span>
</span><a name="line-509"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-6989586621684674198"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674198"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674200"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">,</span><span> </span><a href="UniqSupply.html#uniqFromSupply"><span class="hs-identifier hs-var">uniqFromSupply</span></a><span> </span><a href="#local-6989586621684674199"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-510"></a><span>
</span><a name="line-511"></a><span class="hs-comment">-- | Applies 'cloneIdBndr' to a number of 'Id's, accumulating a final</span><span>
</span><a name="line-512"></a><span class="hs-comment">-- substitution from left to right</span><span>
</span><a name="line-513"></a><span class="hs-identifier">cloneIdBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-514"></a><a name="cloneIdBndrs"><a href="CoreSubst.html#cloneIdBndrs"><span class="hs-identifier">cloneIdBndrs</span></a></a><span> </span><a name="local-6989586621684674201"><a href="#local-6989586621684674201"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674202"><a href="#local-6989586621684674202"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684674203"><a href="#local-6989586621684674203"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-515"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-6989586621684674201"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674201"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674203"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="UniqSupply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a><span> </span><a href="#local-6989586621684674202"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-516"></a><span>
</span><a name="line-517"></a><span class="hs-identifier">cloneBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-518"></a><span class="hs-comment">-- Works for all kinds of variables (typically case binders)</span><span>
</span><a name="line-519"></a><span class="hs-comment">-- not just Ids</span><span>
</span><a name="line-520"></a><a name="cloneBndrs"><a href="CoreSubst.html#cloneBndrs"><span class="hs-identifier">cloneBndrs</span></a></a><span> </span><a name="local-6989586621684674204"><a href="#local-6989586621684674204"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674205"><a href="#local-6989586621684674205"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684674206"><a href="#local-6989586621684674206"><span class="hs-identifier">vs</span></a></a><span>
</span><a name="line-521"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621684674207"><a href="#local-6989586621684674207"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684674208"><a href="#local-6989586621684674208"><span class="hs-identifier">v</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674209"><a href="#local-6989586621684674209"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#cloneBndr"><span class="hs-identifier hs-var">cloneBndr</span></a><span> </span><a href="#local-6989586621684674207"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674209"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621684674208"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674204"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674206"><span class="hs-identifier hs-var">vs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="UniqSupply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a><span> </span><a href="#local-6989586621684674205"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-522"></a><span>
</span><a name="line-523"></a><span class="hs-identifier">cloneBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-524"></a><a name="cloneBndr"><a href="CoreSubst.html#cloneBndr"><span class="hs-identifier">cloneBndr</span></a></a><span> </span><a name="local-6989586621684674210"><a href="#local-6989586621684674210"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674211"><a href="#local-6989586621684674211"><span class="hs-identifier">uniq</span></a></a><span> </span><a name="local-6989586621684674212"><a href="#local-6989586621684674212"><span class="hs-identifier">v</span></a></a><span>
</span><a name="line-525"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyVar"><span class="hs-identifier hs-var">isTyVar</span></a><span> </span><a href="#local-6989586621684674212"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#cloneTyVarBndr"><span class="hs-identifier hs-var">cloneTyVarBndr</span></a><span> </span><a href="#local-6989586621684674210"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674212"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621684674211"><span class="hs-identifier hs-var">uniq</span></a><span>
</span><a name="line-526"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-6989586621684674210"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674210"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674212"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="#local-6989586621684674211"><span class="hs-identifier hs-var">uniq</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Works for coercion variables too</span><span>
</span><a name="line-527"></a><span>
</span><a name="line-528"></a><span class="hs-comment">-- | Clone a mutually recursive group of 'Id's</span><span>
</span><a name="line-529"></a><span class="hs-identifier">cloneRecIdBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqSupply.html#UniqSupply"><span class="hs-identifier hs-type">UniqSupply</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-530"></a><a name="cloneRecIdBndrs"><a href="CoreSubst.html#cloneRecIdBndrs"><span class="hs-identifier">cloneRecIdBndrs</span></a></a><span> </span><a name="local-6989586621684674213"><a href="#local-6989586621684674213"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674214"><a href="#local-6989586621684674214"><span class="hs-identifier">us</span></a></a><span> </span><a name="local-6989586621684674215"><a href="#local-6989586621684674215"><span class="hs-identifier">ids</span></a></a><span>
</span><a name="line-531"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674216"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674217"><span class="hs-identifier hs-var">ids'</span></a><span class="hs-special">)</span><span>
</span><a name="line-532"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-533"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684674216"><a href="#local-6989586621684674216"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674217"><a href="#local-6989586621684674217"><span class="hs-identifier">ids'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#clone_id"><span class="hs-identifier hs-var">clone_id</span></a><span> </span><a href="#local-6989586621684674216"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674213"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-534"></a><span>                               </span><span class="hs-special">(</span><a href="#local-6989586621684674215"><span class="hs-identifier hs-var">ids</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">zip</span><span class="hs-special">`</span><span> </span><a href="UniqSupply.html#uniqsFromSupply"><span class="hs-identifier hs-var">uniqsFromSupply</span></a><span> </span><a href="#local-6989586621684674214"><span class="hs-identifier hs-var">us</span></a><span class="hs-special">)</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span class="hs-comment">-- Just like substIdBndr, except that it always makes a new unique</span><span>
</span><a name="line-537"></a><span class="hs-comment">-- It is given the unique to use</span><span>
</span><a name="line-538"></a><span class="hs-identifier">clone_id</span><span>    </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span>                    </span><span class="hs-comment">-- Substitution for the IdInfo</span><span>
</span><a name="line-539"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- Substitution and Id to transform</span><span>
</span><a name="line-540"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>              </span><span class="hs-comment">-- Transformed pair</span><span>
</span><a name="line-541"></a><span>
</span><a name="line-542"></a><a name="clone_id"><a href="CoreSubst.html#clone_id"><span class="hs-identifier">clone_id</span></a></a><span> </span><a name="local-6989586621684674218"><a href="#local-6989586621684674218"><span class="hs-identifier">rec_subst</span></a></a><span> </span><a name="local-6989586621684674219"><a href="#local-6989586621684674219"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674220"><a href="#local-6989586621684674220"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674221"><a href="#local-6989586621684674221"><span class="hs-identifier">idvs</span></a></a><span> </span><a name="local-6989586621684674222"><a href="#local-6989586621684674222"><span class="hs-identifier">tvs</span></a></a><span> </span><a name="local-6989586621684674223"><a href="#local-6989586621684674223"><span class="hs-identifier">cvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684674224"><a href="#local-6989586621684674224"><span class="hs-identifier">old_id</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674225"><a href="#local-6989586621684674225"><span class="hs-identifier">uniq</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-543"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674220"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><span class="hs-special">`</span><a href="VarEnv.html#extendInScopeSet"><span class="hs-identifier hs-var">extendInScopeSet</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674228"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674229"><span class="hs-identifier hs-var">new_idvs</span></a><span> </span><a href="#local-6989586621684674222"><span class="hs-identifier hs-var">tvs</span></a><span> </span><a href="#local-6989586621684674230"><span class="hs-identifier hs-var">new_cvs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674228"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-544"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-545"></a><span>    </span><a name="local-6989586621684674226"><a href="#local-6989586621684674226"><span class="hs-identifier">id1</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#setVarUnique"><span class="hs-identifier hs-var">setVarUnique</span></a><span> </span><a href="#local-6989586621684674224"><span class="hs-identifier hs-var">old_id</span></a><span> </span><a href="#local-6989586621684674225"><span class="hs-identifier hs-var">uniq</span></a><span>
</span><a name="line-546"></a><span>    </span><a name="local-6989586621684674227"><a href="#local-6989586621684674227"><span class="hs-identifier">id2</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substIdType"><span class="hs-identifier hs-var">substIdType</span></a><span> </span><a href="#local-6989586621684674219"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674226"><span class="hs-identifier hs-var">id1</span></a><span>
</span><a name="line-547"></a><span>    </span><a name="local-6989586621684674228"><a href="#local-6989586621684674228"><span class="hs-identifier">new_id</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#maybeModifyIdInfo"><span class="hs-identifier hs-var">maybeModifyIdInfo</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier hs-var">substIdInfo</span></a><span> </span><a href="#local-6989586621684674218"><span class="hs-identifier hs-var">rec_subst</span></a><span> </span><a href="#local-6989586621684674227"><span class="hs-identifier hs-var">id2</span></a><span> </span><span class="hs-special">(</span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621684674224"><span class="hs-identifier hs-var">old_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674227"><span class="hs-identifier hs-var">id2</span></a><span>
</span><a name="line-548"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684674229"><a href="#local-6989586621684674229"><span class="hs-identifier">new_idvs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674230"><a href="#local-6989586621684674230"><span class="hs-identifier">new_cvs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isCoVar"><span class="hs-identifier hs-var">isCoVar</span></a><span> </span><a href="#local-6989586621684674224"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674221"><span class="hs-identifier hs-var">idvs</span></a><span class="hs-special">,</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684674223"><span class="hs-identifier hs-var">cvs</span></a><span> </span><a href="#local-6989586621684674224"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="Coercion.html#mkCoVarCo"><span class="hs-identifier hs-var">mkCoVarCo</span></a><span> </span><a href="#local-6989586621684674228"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-549"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684674221"><span class="hs-identifier hs-var">idvs</span></a><span> </span><a href="#local-6989586621684674224"><span class="hs-identifier hs-var">old_id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a href="#local-6989586621684674228"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674223"><span class="hs-identifier hs-var">cvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-550"></a><span>
</span><a name="line-551"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
                Types and Coercions
*                                                                      *
************************************************************************

For types and coercions we just call the corresponding functions in
Type and Coercion, but we have to repackage the substitution, from a
Subst to a TCvSubst.
-}</span><span>
</span><a name="line-562"></a><span>
</span><a name="line-563"></a><span class="hs-identifier">substTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-564"></a><a name="substTyVarBndr"><a href="CoreSubst.html#substTyVarBndr"><span class="hs-identifier">substTyVarBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674231"><a href="#local-6989586621684674231"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674232"><a href="#local-6989586621684674232"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-6989586621684674233"><a href="#local-6989586621684674233"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-6989586621684674234"><a href="#local-6989586621684674234"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674235"><a href="#local-6989586621684674235"><span class="hs-identifier">tv</span></a></a><span>
</span><a name="line-565"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCoRep.html#substTyVarBndr"><span class="hs-identifier hs-var">Type.substTyVarBndr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-6989586621684674231"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674233"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-6989586621684674234"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674235"><span class="hs-identifier hs-var">tv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-566"></a><span>        </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a name="local-6989586621684674236"><a href="#local-6989586621684674236"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-6989586621684674237"><a href="#local-6989586621684674237"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-6989586621684674238"><a href="#local-6989586621684674238"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674239"><a href="#local-6989586621684674239"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-567"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674236"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-6989586621684674232"><span class="hs-identifier hs-var">id_env</span></a><span> </span><a href="#local-6989586621684674237"><span class="hs-identifier hs-var">tv_env'</span></a><span> </span><a href="#local-6989586621684674238"><span class="hs-identifier hs-var">cv_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674239"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-568"></a><span>
</span><a name="line-569"></a><span class="hs-identifier">cloneTyVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Unique.html#Unique"><span class="hs-identifier hs-type">Unique</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-570"></a><a name="cloneTyVarBndr"><a href="CoreSubst.html#cloneTyVarBndr"><span class="hs-identifier">cloneTyVarBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674240"><a href="#local-6989586621684674240"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674241"><a href="#local-6989586621684674241"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-6989586621684674242"><a href="#local-6989586621684674242"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-6989586621684674243"><a href="#local-6989586621684674243"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674244"><a href="#local-6989586621684674244"><span class="hs-identifier">tv</span></a></a><span> </span><a name="local-6989586621684674245"><a href="#local-6989586621684674245"><span class="hs-identifier">uniq</span></a></a><span>
</span><a name="line-571"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCoRep.html#cloneTyVarBndr"><span class="hs-identifier hs-var">Type.cloneTyVarBndr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-6989586621684674240"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674242"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-6989586621684674243"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674244"><span class="hs-identifier hs-var">tv</span></a><span> </span><a href="#local-6989586621684674245"><span class="hs-identifier hs-var">uniq</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-572"></a><span>        </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a name="local-6989586621684674246"><a href="#local-6989586621684674246"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-6989586621684674247"><a href="#local-6989586621684674247"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-6989586621684674248"><a href="#local-6989586621684674248"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674249"><a href="#local-6989586621684674249"><span class="hs-identifier">tv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674246"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-6989586621684674241"><span class="hs-identifier hs-var">id_env</span></a><span> </span><a href="#local-6989586621684674247"><span class="hs-identifier hs-var">tv_env'</span></a><span> </span><a href="#local-6989586621684674248"><span class="hs-identifier hs-var">cv_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674249"><span class="hs-identifier hs-var">tv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-574"></a><span>
</span><a name="line-575"></a><span class="hs-identifier">substCoVarBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#TyVar"><span class="hs-identifier hs-type">TyVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-576"></a><a name="substCoVarBndr"><a href="CoreSubst.html#substCoVarBndr"><span class="hs-identifier">substCoVarBndr</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674250"><a href="#local-6989586621684674250"><span class="hs-identifier">in_scope</span></a></a><span> </span><a name="local-6989586621684674251"><a href="#local-6989586621684674251"><span class="hs-identifier">id_env</span></a></a><span> </span><a name="local-6989586621684674252"><a href="#local-6989586621684674252"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-6989586621684674253"><a href="#local-6989586621684674253"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674254"><a href="#local-6989586621684674254"><span class="hs-identifier">cv</span></a></a><span>
</span><a name="line-577"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="TyCoRep.html#substCoVarBndr"><span class="hs-identifier hs-var">Coercion.substCoVarBndr</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-6989586621684674250"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674252"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><a href="#local-6989586621684674253"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674254"><span class="hs-identifier hs-var">cv</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-578"></a><span>        </span><span class="hs-special">(</span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a name="local-6989586621684674255"><a href="#local-6989586621684674255"><span class="hs-identifier">in_scope'</span></a></a><span> </span><a name="local-6989586621684674256"><a href="#local-6989586621684674256"><span class="hs-identifier">tv_env'</span></a></a><span> </span><a name="local-6989586621684674257"><a href="#local-6989586621684674257"><span class="hs-identifier">cv_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674258"><a href="#local-6989586621684674258"><span class="hs-identifier">cv'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-579"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a href="#local-6989586621684674255"><span class="hs-identifier hs-var">in_scope'</span></a><span> </span><a href="#local-6989586621684674251"><span class="hs-identifier hs-var">id_env</span></a><span> </span><a href="#local-6989586621684674256"><span class="hs-identifier hs-var">tv_env'</span></a><span> </span><a href="#local-6989586621684674257"><span class="hs-identifier hs-var">cv_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684674258"><span class="hs-identifier hs-var">cv'</span></a><span class="hs-special">)</span><span>
</span><a name="line-580"></a><span>
</span><a name="line-581"></a><span class="hs-comment">-- | See 'Type.substTy'</span><span>
</span><a name="line-582"></a><span class="hs-identifier">substTy</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Type"><span class="hs-identifier hs-type">Type</span></a><span>
</span><a name="line-583"></a><a name="substTy"><a href="CoreSubst.html#substTy"><span class="hs-identifier">substTy</span></a></a><span> </span><a name="local-6989586621684674259"><a href="#local-6989586621684674259"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674260"><a href="#local-6989586621684674260"><span class="hs-identifier">ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substTyUnchecked"><span class="hs-identifier hs-var">Type.substTyUnchecked</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621684674259"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674260"><span class="hs-identifier hs-var">ty</span></a><span>
</span><a name="line-584"></a><span>
</span><a name="line-585"></a><span class="hs-identifier">getTCvSubst</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-type">TCvSubst</span></a><span>
</span><a name="line-586"></a><a name="getTCvSubst"><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier">getTCvSubst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><a name="local-6989586621684674261"><a href="#local-6989586621684674261"><span class="hs-identifier">in_scope</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674262"><a href="#local-6989586621684674262"><span class="hs-identifier">tenv</span></a></a><span> </span><a name="local-6989586621684674263"><a href="#local-6989586621684674263"><span class="hs-identifier">cenv</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#TCvSubst"><span class="hs-identifier hs-var">TCvSubst</span></a><span> </span><a href="#local-6989586621684674261"><span class="hs-identifier hs-var">in_scope</span></a><span> </span><a href="#local-6989586621684674262"><span class="hs-identifier hs-var">tenv</span></a><span> </span><a href="#local-6989586621684674263"><span class="hs-identifier hs-var">cenv</span></a><span>
</span><a name="line-587"></a><span>
</span><a name="line-588"></a><span class="hs-comment">-- | See 'Coercion.substCo'</span><span>
</span><a name="line-589"></a><span class="hs-identifier">substCo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TyCoRep.html#Coercion"><span class="hs-identifier hs-type">Coercion</span></a><span>
</span><a name="line-590"></a><a name="substCo"><a href="CoreSubst.html#substCo"><span class="hs-identifier">substCo</span></a></a><span> </span><a name="local-6989586621684674264"><a href="#local-6989586621684674264"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674265"><a href="#local-6989586621684674265"><span class="hs-identifier">co</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#substCo"><span class="hs-identifier hs-var">Coercion.substCo</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#getTCvSubst"><span class="hs-identifier hs-var">getTCvSubst</span></a><span> </span><a href="#local-6989586621684674264"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674265"><span class="hs-identifier hs-var">co</span></a><span>
</span><a name="line-591"></a><span>
</span><a name="line-592"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\section{IdInfo substitution}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span class="hs-identifier">substIdType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-601"></a><a name="substIdType"><a href="CoreSubst.html#substIdType"><span class="hs-identifier">substIdType</span></a></a><span> </span><a name="local-6989586621684674266"><a href="#local-6989586621684674266"><span class="hs-identifier">subst</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-var">Subst</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674267"><a href="#local-6989586621684674267"><span class="hs-identifier">tv_env</span></a></a><span> </span><a name="local-6989586621684674268"><a href="#local-6989586621684674268"><span class="hs-identifier">cv_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684674269"><a href="#local-6989586621684674269"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-602"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674267"><span class="hs-identifier hs-var">tv_env</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="VarEnv.html#isEmptyVarEnv"><span class="hs-identifier hs-var">isEmptyVarEnv</span></a><span> </span><a href="#local-6989586621684674268"><span class="hs-identifier hs-var">cv_env</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="TyCoRep.html#noFreeVarsOfType"><span class="hs-identifier hs-var">noFreeVarsOfType</span></a><span> </span><a href="#local-6989586621684674270"><span class="hs-identifier hs-var">old_ty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674269"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-603"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#setIdType"><span class="hs-identifier hs-var">setIdType</span></a><span> </span><a href="#local-6989586621684674269"><span class="hs-identifier hs-var">id</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substTy"><span class="hs-identifier hs-var">substTy</span></a><span> </span><a href="#local-6989586621684674266"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674270"><span class="hs-identifier hs-var">old_ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-604"></a><span>                </span><span class="hs-comment">-- The tyCoVarsOfType is cheaper than it looks</span><span>
</span><a name="line-605"></a><span>                </span><span class="hs-comment">-- because we cache the free tyvars of the type</span><span>
</span><a name="line-606"></a><span>                </span><span class="hs-comment">-- in a Note in the id's type itself</span><span>
</span><a name="line-607"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-608"></a><span>    </span><a name="local-6989586621684674270"><a href="#local-6989586621684674270"><span class="hs-identifier">old_ty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684674269"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-609"></a><span>
</span><a name="line-610"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-611"></a><span class="hs-comment">-- | Substitute into some 'IdInfo' with regard to the supplied new 'Id'.</span><span>
</span><a name="line-612"></a><span class="hs-identifier">substIdInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="IdInfo.html#IdInfo"><span class="hs-identifier hs-type">IdInfo</span></a><span>
</span><a name="line-613"></a><a name="substIdInfo"><a href="CoreSubst.html#substIdInfo"><span class="hs-identifier">substIdInfo</span></a></a><span> </span><a name="local-6989586621684674271"><a href="#local-6989586621684674271"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674272"><a href="#local-6989586621684674272"><span class="hs-identifier">new_id</span></a></a><span> </span><a name="local-6989586621684674273"><a href="#local-6989586621684674273"><span class="hs-identifier">info</span></a></a><span>
</span><a name="line-614"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621684674276"><span class="hs-identifier hs-var">nothing_to_do</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-615"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674273"><span class="hs-identifier hs-var">info</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setRuleInfo"><span class="hs-identifier hs-var">setRuleInfo</span></a><span class="hs-special">`</span><span>      </span><a href="CoreSubst.html#substSpec"><span class="hs-identifier hs-var">substSpec</span></a><span> </span><a href="#local-6989586621684674271"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674272"><span class="hs-identifier hs-var">new_id</span></a><span> </span><a href="#local-6989586621684674274"><span class="hs-identifier hs-var">old_rules</span></a><span>
</span><a name="line-616"></a><span>                               </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span> </span><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a><span> </span><a href="#local-6989586621684674271"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674275"><span class="hs-identifier hs-var">old_unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-618"></a><span>    </span><a name="local-6989586621684674274"><a href="#local-6989586621684674274"><span class="hs-identifier">old_rules</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ruleInfo</span><span> </span><a href="#local-6989586621684674273"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-619"></a><span>    </span><a name="local-6989586621684674275"><a href="#local-6989586621684674275"><span class="hs-identifier">old_unf</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621684674273"><span class="hs-identifier hs-var">info</span></a><span>
</span><a name="line-620"></a><span>    </span><a name="local-6989586621684674276"><a href="#local-6989586621684674276"><span class="hs-identifier">nothing_to_do</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#isEmptyRuleInfo"><span class="hs-identifier hs-var">isEmptyRuleInfo</span></a><span> </span><a href="#local-6989586621684674274"><span class="hs-identifier hs-var">old_rules</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isFragileUnfolding"><span class="hs-identifier hs-var">isFragileUnfolding</span></a><span> </span><a href="#local-6989586621684674275"><span class="hs-identifier hs-var">old_unf</span></a><span class="hs-special">)</span><span>
</span><a name="line-621"></a><span>
</span><a name="line-622"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-623"></a><span class="hs-comment">-- | Substitutes for the 'Id's within an unfolding</span><span>
</span><a name="line-624"></a><span class="hs-identifier">substUnfolding</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">substUnfoldingSC</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-625"></a><span>        </span><span class="hs-comment">-- Seq'ing on the returned Unfolding is enough to cause</span><span>
</span><a name="line-626"></a><span>        </span><span class="hs-comment">-- all the substitutions to happen completely</span><span>
</span><a name="line-627"></a><span>
</span><a name="line-628"></a><a name="substUnfoldingSC"><a href="CoreSubst.html#substUnfoldingSC"><span class="hs-identifier">substUnfoldingSC</span></a></a><span> </span><a name="local-6989586621684674277"><a href="#local-6989586621684674277"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674278"><a href="#local-6989586621684674278"><span class="hs-identifier">unf</span></a></a><span>       </span><span class="hs-comment">-- Short-cut version</span><span>
</span><a name="line-629"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSubst.html#isEmptySubst"><span class="hs-identifier hs-var">isEmptySubst</span></a><span> </span><a href="#local-6989586621684674277"><span class="hs-identifier hs-var">subst</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674278"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-630"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier hs-var">substUnfolding</span></a><span> </span><a href="#local-6989586621684674277"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674278"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-631"></a><span>
</span><a name="line-632"></a><a name="substUnfolding"><a href="CoreSubst.html#substUnfolding"><span class="hs-identifier">substUnfolding</span></a></a><span> </span><a name="local-6989586621684674279"><a href="#local-6989586621684674279"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674280"><a href="#local-6989586621684674280"><span class="hs-identifier">df</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674281"><a href="#local-6989586621684674281"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674282"><a href="#local-6989586621684674282"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-633"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674280"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674284"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674285"><span class="hs-identifier hs-var">args'</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-634"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-635"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684674283"><a href="#local-6989586621684674283"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><a name="local-6989586621684674284"><a href="#local-6989586621684674284"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621684674279"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674281"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-636"></a><span>    </span><a name="local-6989586621684674285"><a href="#local-6989586621684674285"><span class="hs-identifier">args'</span></a></a><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst-unf:dfun&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674283"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674282"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-637"></a><span>
</span><a name="line-638"></a><span class="hs-identifier">substUnfolding</span><span> </span><a name="local-6989586621684674286"><a href="#local-6989586621684674286"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674287"><a href="#local-6989586621684674287"><span class="hs-identifier">unf</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674288"><a href="#local-6989586621684674288"><span class="hs-identifier">tmpl</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674289"><a href="#local-6989586621684674289"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-639"></a><span>        </span><span class="hs-comment">-- Retain an InlineRule!</span><span>
</span><a name="line-640"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621684674289"><span class="hs-identifier hs-var">src</span></a><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Zap an unstable unfolding, to save substitution work</span><span>
</span><a name="line-641"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#NoUnfolding"><span class="hs-identifier hs-var">NoUnfolding</span></a><span>
</span><a name="line-642"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-comment">-- But keep a stable one!</span><span>
</span><a name="line-643"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSeq.html#seqExpr"><span class="hs-identifier hs-var">seqExpr</span></a><span> </span><a href="#local-6989586621684674290"><span class="hs-identifier hs-var">new_tmpl</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span>
</span><a name="line-644"></a><span>    </span><a href="#local-6989586621684674287"><span class="hs-identifier hs-var">unf</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674290"><span class="hs-identifier hs-var">new_tmpl</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-645"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-646"></a><span>    </span><a name="local-6989586621684674290"><a href="#local-6989586621684674290"><span class="hs-identifier">new_tmpl</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst-unf&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674286"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674288"><span class="hs-identifier hs-var">tmpl</span></a><span>
</span><a name="line-647"></a><span>
</span><a name="line-648"></a><span class="hs-identifier">substUnfolding</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674291"><a href="#local-6989586621684674291"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674291"><span class="hs-identifier hs-var">unf</span></a><span>      </span><span class="hs-comment">-- NoUnfolding, OtherCon</span><span>
</span><a name="line-649"></a><span>
</span><a name="line-650"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-651"></a><span class="hs-identifier">substIdOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-652"></a><span class="hs-comment">-- These Ids should not be substituted to non-Ids</span><span>
</span><a name="line-653"></a><a name="substIdOcc"><a href="CoreSubst.html#substIdOcc"><span class="hs-identifier">substIdOcc</span></a></a><span> </span><a name="local-6989586621684674292"><a href="#local-6989586621684674292"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674293"><a href="#local-6989586621684674293"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substIdOcc&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674292"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674293"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-654"></a><span>                        </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684674294"><a href="#local-6989586621684674294"><span class="hs-identifier">v'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684674294"><span class="hs-identifier hs-var">v'</span></a><span>
</span><a name="line-655"></a><span>                        </span><a name="local-6989586621684674295"><a href="#local-6989586621684674295"><span class="hs-identifier">other</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;substIdOcc&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">[</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674293"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674295"><span class="hs-identifier hs-var">other</span></a><span class="hs-special">,</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674292"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-658"></a><span class="hs-comment">-- | Substitutes for the 'Id's within the 'WorkerInfo' given the new function 'Id'</span><span>
</span><a name="line-659"></a><span class="hs-identifier">substSpec</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-type">RuleInfo</span></a><span>
</span><a name="line-660"></a><a name="substSpec"><a href="CoreSubst.html#substSpec"><span class="hs-identifier">substSpec</span></a></a><span> </span><a name="local-6989586621684674296"><a href="#local-6989586621684674296"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674297"><a href="#local-6989586621684674297"><span class="hs-identifier">new_id</span></a></a><span> </span><span class="hs-special">(</span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><a name="local-6989586621684674298"><a href="#local-6989586621684674298"><span class="hs-identifier">rules</span></a></a><span> </span><a name="local-6989586621684674299"><a href="#local-6989586621684674299"><span class="hs-identifier">rhs_fvs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-661"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreSeq.html#seqRuleInfo"><span class="hs-identifier hs-var">seqRuleInfo</span></a><span> </span><a href="#local-6989586621684674301"><span class="hs-identifier hs-var">new_spec</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684674301"><span class="hs-identifier hs-var">new_spec</span></a><span>
</span><a name="line-662"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-663"></a><span>    </span><a name="local-6989586621684674300"><a href="#local-6989586621684674300"><span class="hs-identifier">subst_ru_fn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621684674297"><span class="hs-identifier hs-var">new_id</span></a><span class="hs-special">)</span><span>
</span><a name="line-664"></a><span>    </span><a name="local-6989586621684674301"><a href="#local-6989586621684674301"><span class="hs-identifier">new_spec</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#RuleInfo"><span class="hs-identifier hs-var">RuleInfo</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a><span> </span><a href="#local-6989586621684674296"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674300"><span class="hs-identifier hs-var">subst_ru_fn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674298"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-665"></a><span>                        </span><span class="hs-special">(</span><a href="CoreSubst.html#substDVarSet"><span class="hs-identifier hs-var">substDVarSet</span></a><span> </span><a href="#local-6989586621684674296"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674299"><span class="hs-identifier hs-var">rhs_fvs</span></a><span class="hs-special">)</span><span>
</span><a name="line-666"></a><span>
</span><a name="line-667"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-668"></a><span class="hs-identifier">substRulesForImportedIds</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-669"></a><a name="substRulesForImportedIds"><a href="CoreSubst.html#substRulesForImportedIds"><span class="hs-identifier">substRulesForImportedIds</span></a></a><span> </span><a name="local-6989586621684674302"><a href="#local-6989586621684674302"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674303"><a href="#local-6989586621684674303"><span class="hs-identifier">rules</span></a></a><span>
</span><a name="line-670"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substRule"><span class="hs-identifier hs-var">substRule</span></a><span> </span><a href="#local-6989586621684674302"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674304"><span class="hs-identifier hs-var">not_needed</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674303"><span class="hs-identifier hs-var">rules</span></a><span>
</span><a name="line-671"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-672"></a><span>    </span><a name="local-6989586621684674304"><a href="#local-6989586621684674304"><span class="hs-identifier">not_needed</span></a></a><span> </span><a name="local-6989586621684674305"><a href="#local-6989586621684674305"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;substRulesForImportedIds&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674305"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-675"></a><span class="hs-identifier">substRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span>
</span><a name="line-676"></a><span>
</span><a name="line-677"></a><span class="hs-comment">-- The subst_ru_fn argument is applied to substitute the ru_fn field</span><span>
</span><a name="line-678"></a><span class="hs-comment">-- of the rule:</span><span>
</span><a name="line-679"></a><span class="hs-comment">--    - Rules for *imported* Ids never change ru_fn</span><span>
</span><a name="line-680"></a><span class="hs-comment">--    - Rules for *local* Ids are in the IdInfo for that Id,</span><span>
</span><a name="line-681"></a><span class="hs-comment">--      and the ru_fn field is simply replaced by the new name</span><span>
</span><a name="line-682"></a><span class="hs-comment">--      of the Id</span><span>
</span><a name="line-683"></a><a name="substRule"><a href="CoreSubst.html#substRule"><span class="hs-identifier">substRule</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684674306"><a href="#local-6989586621684674306"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674306"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-684"></a><span class="hs-identifier">substRule</span><span> </span><a name="local-6989586621684674307"><a href="#local-6989586621684674307"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674308"><a href="#local-6989586621684674308"><span class="hs-identifier">subst_ru_fn</span></a></a><span> </span><a name="local-6989586621684674309"><a href="#local-6989586621684674309"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674310"><a href="#local-6989586621684674310"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674311"><a href="#local-6989586621684674311"><span class="hs-identifier">args</span></a></a><span>
</span><a name="line-685"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674312"><a href="#local-6989586621684674312"><span class="hs-identifier">fn_name</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674313"><a href="#local-6989586621684674313"><span class="hs-identifier">rhs</span></a></a><span>
</span><a name="line-686"></a><span>                                       </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_local</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684674314"><a href="#local-6989586621684674314"><span class="hs-identifier">is_local</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-687"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674309"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674317"><span class="hs-identifier hs-var">bndrs'</span></a><span>
</span><a name="line-688"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_fn</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621684674314"><span class="hs-identifier hs-var">is_local</span></a><span>
</span><a name="line-689"></a><span>                        </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621684674308"><span class="hs-identifier hs-var">subst_ru_fn</span></a><span> </span><a href="#local-6989586621684674312"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-690"></a><span>                        </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621684674312"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-691"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><a href="#local-6989586621684674315"><span class="hs-identifier hs-var">doc</span></a><span> </span><a href="#local-6989586621684674316"><span class="hs-identifier hs-var">subst'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674311"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-692"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substExpr"><span class="hs-identifier hs-var">substExpr</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;foo&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674316"><span class="hs-identifier hs-var">subst'</span></a><span> </span><a href="#local-6989586621684674313"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-693"></a><span>           </span><span class="hs-comment">-- Do NOT optimise the RHS (previously we did simplOptExpr here)</span><span>
</span><a name="line-694"></a><span>           </span><span class="hs-comment">-- See Note [Substitute lazily]</span><span>
</span><a name="line-695"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-696"></a><span>    </span><a name="local-6989586621684674315"><a href="#local-6989586621684674315"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst-rule&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621684674312"><span class="hs-identifier hs-var">fn_name</span></a><span>
</span><a name="line-697"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684674316"><a href="#local-6989586621684674316"><span class="hs-identifier">subst'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684674317"><a href="#local-6989586621684674317"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSubst.html#substBndrs"><span class="hs-identifier hs-var">substBndrs</span></a><span> </span><a href="#local-6989586621684674307"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674310"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-698"></a><span>
</span><a name="line-699"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-700"></a><span class="hs-identifier">substDVarSet</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarSet.html#DVarSet"><span class="hs-identifier hs-type">DVarSet</span></a><span>
</span><a name="line-701"></a><a name="substDVarSet"><a href="CoreSubst.html#substDVarSet"><span class="hs-identifier">substDVarSet</span></a></a><span> </span><a name="local-6989586621684674318"><a href="#local-6989586621684674318"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674319"><a href="#local-6989586621684674319"><span class="hs-identifier">fvs</span></a></a><span>
</span><a name="line-702"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="VarSet.html#mkDVarSet"><span class="hs-identifier hs-var">mkDVarSet</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684674320"><span class="hs-identifier hs-var">subst_fv</span></a><span> </span><a href="#local-6989586621684674318"><span class="hs-identifier hs-var">subst</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="VarSet.html#dVarSetElems"><span class="hs-identifier hs-var">dVarSetElems</span></a><span> </span><a href="#local-6989586621684674319"><span class="hs-identifier hs-var">fvs</span></a><span>
</span><a name="line-703"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-704"></a><span>  </span><a name="local-6989586621684674320"><a href="#local-6989586621684674320"><span class="hs-identifier">subst_fv</span></a></a><span> </span><a name="local-6989586621684674321"><a href="#local-6989586621684674321"><span class="hs-identifier">subst</span></a></a><span> </span><a name="local-6989586621684674322"><a href="#local-6989586621684674322"><span class="hs-identifier">fv</span></a></a><span> </span><a name="local-6989586621684674323"><a href="#local-6989586621684674323"><span class="hs-identifier">acc</span></a></a><span>
</span><a name="line-705"></a><span>     </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isId"><span class="hs-identifier hs-var">isId</span></a><span> </span><a href="#local-6989586621684674322"><span class="hs-identifier hs-var">fv</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreFVs.html#expr_fvs"><span class="hs-identifier hs-var">expr_fvs</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;substDVarSet&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674321"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674322"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span> </span><a href="Var.html#isLocalVar"><span class="hs-identifier hs-var">isLocalVar</span></a><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621684674323"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-706"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tyCoFVsOfType"><span class="hs-identifier hs-var">tyCoFVsOfType</span></a><span> </span><span class="hs-special">(</span><a href="CoreSubst.html#lookupTCvSubst"><span class="hs-identifier hs-var">lookupTCvSubst</span></a><span> </span><a href="#local-6989586621684674321"><span class="hs-identifier hs-var">subst</span></a><span> </span><a href="#local-6989586621684674322"><span class="hs-identifier hs-var">fv</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">)</span><span> </span><a href="VarSet.html#emptyVarSet"><span class="hs-identifier hs-var">emptyVarSet</span></a><span> </span><span class="hs-operator hs-var">$!</span><span> </span><a href="#local-6989586621684674323"><span class="hs-identifier hs-var">acc</span></a><span>
</span><a name="line-707"></a><span>
</span><a name="line-708"></a><span class="hs-comment">------------------</span><span>
</span><a name="line-709"></a><span class="hs-identifier">substTickish</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="CoreSubst.html#Subst"><span class="hs-identifier hs-type">Subst</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-710"></a><a name="substTickish"><a href="CoreSubst.html#substTickish"><span class="hs-identifier">substTickish</span></a></a><span> </span><a name="local-6989586621684674324"><a href="#local-6989586621684674324"><span class="hs-identifier">subst</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a name="local-6989586621684674325"><a href="#local-6989586621684674325"><span class="hs-identifier">n</span></a></a><span> </span><a name="local-6989586621684674326"><a href="#local-6989586621684674326"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-711"></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a href="#local-6989586621684674325"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621684674327"><span class="hs-identifier hs-var">do_one</span></a><span> </span><a href="#local-6989586621684674326"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-713"></a><span>    </span><a name="local-6989586621684674327"><a href="#local-6989586621684674327"><span class="hs-identifier">do_one</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreUtils.html#getIdFromTrivialExpr"><span class="hs-identifier hs-var">getIdFromTrivialExpr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="CoreSubst.html#lookupIdSubst"><span class="hs-identifier hs-var">lookupIdSubst</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;subst_tickish&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684674324"><span class="hs-identifier hs-var">subst</span></a><span>
</span><a name="line-714"></a><span class="hs-identifier">substTickish</span><span> </span><a name="local-6989586621684674328"><a href="#local-6989586621684674328"><span class="hs-identifier">_subst</span></a></a><span> </span><a name="local-6989586621684674329"><a href="#local-6989586621684674329"><span class="hs-identifier">other</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684674329"><span class="hs-identifier hs-var">other</span></a><span>
</span><a name="line-715"></a><span>
</span><a name="line-716"></a><span class="hs-comment">{- Note [Substitute lazily]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
The functions that substitute over IdInfo must be pretty lazy, because
they are knot-tied by substRecBndrs.

One case in point was Trac #10627 in which a rule for a function 'f'
referred to 'f' (at a different type) on the RHS.  But instead of just
substituting in the rhs of the rule, we were calling simpleOptExpr, which
looked at the idInfo for 'f'; result &lt;&lt;loop&gt;&gt;.

In any case we don't need to optimise the RHS of rules, or unfoldings,
because the simplifier will do that.


Note [substTickish]
~~~~~~~~~~~~~~~~~~~~~~
A Breakpoint contains a list of Ids.  What happens if we ever want to
substitute an expression for one of these Ids?

First, we ensure that we only ever substitute trivial expressions for
these Ids, by marking them as NoOccInfo in the occurrence analyser.
Then, when substituting for the Id, we unwrap any type applications
and abstractions to get back to an Id, with getIdFromTrivialExpr.

Second, we have to ensure that we never try to substitute a literal
for an Id in a breakpoint.  We ensure this by never storing an Id with
an unlifted type in a Breakpoint - see Coverage.mkTickish.
Breakpoints can't handle free variables with unlifted types anyway.
-}</span><span>
</span><a name="line-745"></a><span>
</span><a name="line-746"></a><span class="hs-comment">{-
Note [Worker inlining]
~~~~~~~~~~~~~~~~~~~~~~
A worker can get sustituted away entirely.
        - it might be trivial
        - it might simply be very small
We do not treat an InlWrapper as an 'occurrence' in the occurrence
analyser, so it's possible that the worker is not even in scope any more.

In all all these cases we simply drop the special case, returning to
InlVanilla.  The WARN is just so I can see if it happens a lot.
-}</span><span>
</span><a name="line-758"></a><span>
</span><a name="line-759"></a></pre></body></html>