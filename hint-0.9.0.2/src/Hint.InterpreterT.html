<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hint.InterpreterT</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-2"></a><span>    </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span class="hs-special">,</span><span> </span><a href="Hint.InterpreterT.html#Interpreter"><span class="hs-identifier hs-type">Interpreter</span></a><span class="hs-special">,</span><span>
</span><a name="line-3"></a><span>    </span><a href="Hint.InterpreterT.html#runInterpreter"><span class="hs-identifier hs-var">runInterpreter</span></a><span class="hs-special">,</span><span> </span><a href="Hint.InterpreterT.html#runInterpreterWithArgs"><span class="hs-identifier hs-var">runInterpreterWithArgs</span></a><span class="hs-special">,</span><span> </span><a href="Hint.InterpreterT.html#runInterpreterWithArgsLibdir"><span class="hs-identifier hs-var">runInterpreterWithArgsLibdir</span></a><span class="hs-special">,</span><span>
</span><a name="line-4"></a><span>    </span><a href="Hint.InterpreterT.html#MultipleInstancesNotAllowed"><span class="hs-identifier hs-type">MultipleInstancesNotAllowed</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-5"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Prelude</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><a href="Hint.Base.html"><span class="hs-identifier">Hint.Base</span></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><a href="Hint.Context.html"><span class="hs-identifier">Hint.Context</span></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="Hint.Configuration.html"><span class="hs-identifier">Hint.Configuration</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="Hint.Extension.html"><span class="hs-identifier">Hint.Extension</span></a><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Reader</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MC</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Typeable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Concurrent.MVar</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Unsafe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unsafePerformIO</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Maybe</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">GHC.Paths</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Hint.GHC.html"><span class="hs-identifier">Hint.GHC</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">type</span><span> </span><a name="Interpreter"><a href="Hint.InterpreterT.html#Interpreter"><span class="hs-identifier">Interpreter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><span class="hs-identifier hs-type">IO</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">newtype</span><span> </span><a name="InterpreterT"><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier">InterpreterT</span></a></a><span> </span><a name="local-6989586621679215117"><a href="#local-6989586621679215117"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679215118"><a href="#local-6989586621679215118"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="InterpreterT"><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier">InterpreterT</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-32"></a><span>                             </span><a name="unInterpreterT"><a href="Hint.InterpreterT.html#unInterpreterT"><span class="hs-identifier">unInterpreterT</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">ReaderT</span><span> </span><a href="Hint.Base.html#InterpreterSession"><span class="hs-identifier hs-type">InterpreterSession</span></a><span> </span><span class="hs-special">(</span><a href="Control.Monad.Ghc.html#GhcT"><span class="hs-identifier hs-type">GHC.GhcT</span></a><span> </span><a href="#local-6989586621679215117"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679215118"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-33"></a><span>                           </span><span class="hs-special">}</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Functor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monad</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadCatch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-identifier">execute</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215296"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215296"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-38"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hint.Base.html#InterpreterSession"><span class="hs-identifier hs-type">InterpreterSession</span></a><span>
</span><a name="line-39"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><a href="#local-6989586621679215296"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679215297"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-40"></a><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215296"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Hint.Base.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="#local-6989586621679215297"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-41"></a><a name="execute"><a href="Hint.InterpreterT.html#execute"><span class="hs-identifier">execute</span></a></a><span> </span><a name="local-6989586621679215298"><a href="#local-6989586621679215298"><span class="hs-identifier">libdir</span></a></a><span> </span><a name="local-6989586621679215299"><a href="#local-6989586621679215299"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">try</span><span>
</span><a name="line-42"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><a href="Control.Monad.Ghc.html#runGhcT"><span class="hs-identifier hs-var">GHC.runGhcT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679215298"><span class="hs-identifier hs-var">libdir</span></a><span class="hs-special">)</span><span>
</span><a name="line-43"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier">runReaderT</span><span> </span><a href="#local-6989586621679215299"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-44"></a><span>                 </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unInterpreterT</span><span>
</span><a name="line-45"></a><span>
</span><a name="line-46"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadTrans</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-47"></a><span>    </span><a name="local-8214565720323815716"><span class="hs-identifier">lift</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-var">InterpreterT</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">lift</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-identifier">runGhcImpl</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215294"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215294"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Hint.Base.html#RunGhc"><span class="hs-identifier hs-type">RunGhc</span></a><span> </span><span class="hs-special">(</span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><a href="#local-6989586621679215294"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679215295"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-51"></a><a name="runGhcImpl"><a href="Hint.InterpreterT.html#runGhcImpl"><span class="hs-identifier">runGhcImpl</span></a></a><span> </span><a name="local-6989586621679215300"><a href="#local-6989586621679215300"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-52"></a><span>  </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-var">InterpreterT</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lift</span><span> </span><a href="#local-6989586621679215300"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-53"></a><span>   </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catches</span><span class="hs-special">`</span><span>
</span><a name="line-54"></a><span>   </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679215303"><a href="#local-6989586621679215303"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.SourceError</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-55"></a><span>     </span><a name="local-6989586621679215304"><a href="#local-6989586621679215304"><span class="hs-identifier">dynFlags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hint.Base.html#runGhc"><span class="hs-identifier hs-var">runGhc</span></a><span> </span><span class="hs-identifier hs-var">GHC.getSessionDynFlags</span><span>
</span><a name="line-56"></a><span>     </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679215301"><span class="hs-identifier hs-var">compilationError</span></a><span> </span><a href="#local-6989586621679215304"><span class="hs-identifier hs-var">dynFlags</span></a><span> </span><a href="#local-6989586621679215303"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>   </span><span class="hs-special">,</span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679215305"><a href="#local-6989586621679215305"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.GhcApiError</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hint.Base.html#GhcException"><span class="hs-identifier hs-var">GhcException</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679215305"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><span>   </span><span class="hs-special">,</span><span class="hs-identifier hs-var">Handler</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679215306"><a href="#local-6989586621679215306"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.GhcException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hint.Base.html#GhcException"><span class="hs-identifier hs-var">GhcException</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hint.InterpreterT.html#showGhcEx"><span class="hs-identifier hs-var">showGhcEx</span></a><span> </span><a href="#local-6989586621679215306"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>   </span><span class="hs-special">]</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-61"></a><span>    </span><a name="local-6989586621679215301"><a href="#local-6989586621679215301"><span class="hs-identifier">compilationError</span></a></a><span> </span><a name="local-6989586621679215302"><a href="#local-6989586621679215302"><span class="hs-identifier">dynFlags</span></a></a><span>
</span><a name="line-62"></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Hint.Base.html#WontCompile"><span class="hs-identifier hs-var">WontCompile</span></a><span>
</span><a name="line-63"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Hint.Base.html#GhcError"><span class="hs-identifier hs-var">GhcError</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">GHC.showSDoc</span><span> </span><a href="#local-6989586621679215302"><span class="hs-identifier hs-var">dynFlags</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">GHC.pprErrMsgBagWithLoc</span><span>
</span><a name="line-65"></a><span>      </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">GHC.srcErrorMessages</span><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-identifier">showGhcEx</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">GHC.GhcException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-68"></a><a name="showGhcEx"><a href="Hint.InterpreterT.html#showGhcEx"><span class="hs-identifier">showGhcEx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">GHC.showGhcException</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-comment">-- ================= Executing the interpreter ==================</span><span>
</span><a name="line-71"></a><span>
</span><a name="line-72"></a><span class="hs-identifier">initialize</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215293"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadThrow</span><span> </span><a href="#local-6989586621679215293"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215293"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679215293"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>           </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-74"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><a href="#local-6989586621679215293"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><a name="initialize"><a href="Hint.InterpreterT.html#initialize"><span class="hs-identifier">initialize</span></a></a><span> </span><a name="local-6989586621679215307"><a href="#local-6989586621679215307"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-76"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679215308"><a href="#local-6989586621679215308"><span class="hs-identifier">log_handler</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hint.Base.html#fromSession"><span class="hs-identifier hs-var">fromSession</span></a><span> </span><span class="hs-identifier">ghcErrLogger</span><span>
</span><a name="line-77"></a><span>       </span><span class="hs-comment">-- Set a custom log handler, to intercept error messages :S</span><span>
</span><a name="line-78"></a><span>       </span><a name="local-6989586621679215309"><a href="#local-6989586621679215309"><span class="hs-identifier">df0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hint.Base.html#runGhc"><span class="hs-identifier hs-var">runGhc</span></a><span> </span><span class="hs-identifier hs-var">GHC.getSessionDynFlags</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679215310"><a href="#local-6989586621679215310"><span class="hs-identifier">df1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.Configuration.html#configureDynFlags"><span class="hs-identifier hs-var">configureDynFlags</span></a><span> </span><a href="#local-6989586621679215309"><span class="hs-identifier hs-var">df0</span></a><span>
</span><a name="line-81"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621679215311"><a href="#local-6989586621679215311"><span class="hs-identifier">df2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679215312"><a href="#local-6989586621679215312"><span class="hs-identifier">extra</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hint.Base.html#runGhc2"><span class="hs-identifier hs-var">runGhc2</span></a><span> </span><a href="Hint.Configuration.html#parseDynamicFlags"><span class="hs-identifier hs-var">parseDynamicFlags</span></a><span> </span><a href="#local-6989586621679215310"><span class="hs-identifier hs-var">df1</span></a><span> </span><a href="#local-6989586621679215307"><span class="hs-identifier hs-var">args</span></a><span>
</span><a name="line-82"></a><span>       </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621679215312"><span class="hs-identifier hs-var">extra</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-83"></a><span>            </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Hint.Base.html#UnknownError"><span class="hs-identifier hs-var">UnknownError</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;flags: '&quot;</span><span>
</span><a name="line-84"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unwords</span><span> </span><a href="#local-6989586621679215312"><span class="hs-identifier hs-var">extra</span></a><span>
</span><a name="line-85"></a><span>                                          </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;' not recognized&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>
</span><a name="line-87"></a><span>       </span><span class="hs-comment">-- Observe that, setSessionDynFlags loads info on packages</span><span>
</span><a name="line-88"></a><span>       </span><span class="hs-comment">-- available; calling this function once is mandatory!</span><span>
</span><a name="line-89"></a><span>       </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Hint.Base.html#runGhc1"><span class="hs-identifier hs-var">runGhc1</span></a><span> </span><span class="hs-identifier hs-var">GHC.setSessionDynFlags</span><span> </span><a href="#local-6989586621679215311"><span class="hs-identifier hs-var">df2</span></a><span class="hs-special">{</span><span class="hs-identifier">GHC.log_action</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679215308"><span class="hs-identifier hs-var">log_handler</span></a><span class="hs-special">}</span><span>
</span><a name="line-90"></a><span>
</span><a name="line-91"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679215313"><a href="#local-6989586621679215313"><span class="hs-identifier">extMap</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679215314"><a href="#local-6989586621679215314"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">GHC.flagSpecName</span><span> </span><a href="#local-6989586621679215314"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">GHC.flagSpecFlag</span><span> </span><a href="#local-6989586621679215314"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">GHC.xFlags</span><span>
</span><a name="line-92"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679215315"><a href="#local-6989586621679215315"><span class="hs-identifier">toOpt</span></a></a><span> </span><a name="local-6989586621679215316"><a href="#local-6989586621679215316"><span class="hs-identifier">e</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679215317"><a href="#local-6989586621679215317"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;init error: unknown ext:&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679215316"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>                         </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-6989586621679215317"><span class="hs-identifier hs-var">err</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679215316"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621679215313"><span class="hs-identifier hs-var">extMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679215318"><a href="#local-6989586621679215318"><span class="hs-identifier">getOptVal</span></a></a><span> </span><a name="local-6989586621679215319"><a href="#local-6989586621679215319"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Hint.Extension.html#asExtension"><span class="hs-identifier hs-var">asExtension</span></a><span> </span><a href="#local-6989586621679215319"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">GHC.xopt</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679215315"><span class="hs-identifier hs-var">toOpt</span></a><span> </span><a href="#local-6989586621679215319"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679215311"><span class="hs-identifier hs-var">df2</span></a><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span>       </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679215320"><a href="#local-6989586621679215320"><span class="hs-identifier">defExts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span>  </span><a href="#local-6989586621679215318"><span class="hs-identifier hs-var">getOptVal</span></a><span> </span><a href="Hint.Extension.html#supportedExtensions"><span class="hs-identifier hs-var">supportedExtensions</span></a><span>
</span><a name="line-96"></a><span>
</span><a name="line-97"></a><span>       </span><a href="Hint.Base.html#onState"><span class="hs-identifier hs-var">onState</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679215321"><a href="#local-6989586621679215321"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215321"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">{</span><span class="hs-identifier">defaultExts</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679215320"><span class="hs-identifier hs-var">defExts</span></a><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>
</span><a name="line-99"></a><span>       </span><a href="Hint.Context.html#reset"><span class="hs-identifier hs-var">reset</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- | Executes the interpreter. Returns @Left InterpreterError@ in case of error.</span><span>
</span><a name="line-102"></a><span class="hs-comment">--</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- NB. In hint-0.7.0 and earlier, the underlying ghc was accidentally</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- overwriting certain signal handlers (SIGINT, SIGHUP, SIGTERM, SIGQUIT on</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- Posix systems, Ctrl-C handler on Windows).</span><span>
</span><a name="line-106"></a><span class="hs-identifier">runInterpreter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215291"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215291"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-107"></a><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><a href="#local-6989586621679215291"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679215292"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-108"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215291"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Hint.Base.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="#local-6989586621679215292"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-109"></a><a name="runInterpreter"><a href="Hint.InterpreterT.html#runInterpreter"><span class="hs-identifier">runInterpreter</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.InterpreterT.html#runInterpreterWithArgs"><span class="hs-identifier hs-var">runInterpreterWithArgs</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-110"></a><span>
</span><a name="line-111"></a><span class="hs-comment">-- | Executes the interpreter, setting args passed in as though they</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- were command-line args. Returns @Left InterpreterError@ in case of</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- error.</span><span>
</span><a name="line-114"></a><span class="hs-identifier">runInterpreterWithArgs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215289"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215289"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-115"></a><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-116"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><a href="#local-6989586621679215289"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679215290"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-117"></a><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215289"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Hint.Base.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="#local-6989586621679215290"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><a name="runInterpreterWithArgs"><a href="Hint.InterpreterT.html#runInterpreterWithArgs"><span class="hs-identifier">runInterpreterWithArgs</span></a></a><span> </span><a name="local-6989586621679215322"><a href="#local-6989586621679215322"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.InterpreterT.html#runInterpreterWithArgsLibdir"><span class="hs-identifier hs-var">runInterpreterWithArgsLibdir</span></a><span> </span><a href="#local-6989586621679215322"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-identifier hs-var">GHC.Paths.libdir</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-identifier">runInterpreterWithArgsLibdir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215287"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215287"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-121"></a><span>                             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-122"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-123"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Hint.InterpreterT.html#InterpreterT"><span class="hs-identifier hs-type">InterpreterT</span></a><span> </span><a href="#local-6989586621679215287"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679215288"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-124"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215287"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Hint.Base.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span> </span><a href="#local-6989586621679215288"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-125"></a><a name="runInterpreterWithArgsLibdir"><a href="Hint.InterpreterT.html#runInterpreterWithArgsLibdir"><span class="hs-identifier">runInterpreterWithArgsLibdir</span></a></a><span> </span><a name="local-6989586621679215323"><a href="#local-6989586621679215323"><span class="hs-identifier">args</span></a></a><span> </span><a name="local-6989586621679215324"><a href="#local-6989586621679215324"><span class="hs-identifier">libdir</span></a></a><span> </span><a name="local-6989586621679215325"><a href="#local-6989586621679215325"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-126"></a><span>  </span><a href="Hint.InterpreterT.html#ifInterpreterNotRunning"><span class="hs-identifier hs-var">ifInterpreterNotRunning</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-127"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679215329"><a href="#local-6989586621679215329"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679215327"><span class="hs-identifier hs-var">newInterpreterSession</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">MC.catch</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679215326"><span class="hs-identifier hs-var">rethrowGhcException</span></a><span>
</span><a name="line-128"></a><span>       </span><a href="Hint.InterpreterT.html#execute"><span class="hs-identifier hs-var">execute</span></a><span> </span><a href="#local-6989586621679215324"><span class="hs-identifier hs-var">libdir</span></a><span> </span><a href="#local-6989586621679215329"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">(</span><a href="Hint.InterpreterT.html#initialize"><span class="hs-identifier hs-var">initialize</span></a><span> </span><a href="#local-6989586621679215323"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><a href="#local-6989586621679215325"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">finally</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679215328"><span class="hs-identifier hs-var">cleanSession</span></a><span class="hs-special">)</span><span>
</span><a name="line-129"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621679215326"><a href="#local-6989586621679215326"><span class="hs-identifier">rethrowGhcException</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Hint.Base.html#GhcException"><span class="hs-identifier hs-var">GhcException</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Hint.InterpreterT.html#showGhcEx"><span class="hs-identifier hs-var">showGhcEx</span></a><span>
</span><a name="line-130"></a><span>          </span><a name="local-6989586621679215327"><a href="#local-6989586621679215327"><span class="hs-identifier">newInterpreterSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.InterpreterT.html#newSessionData"><span class="hs-identifier hs-var">newSessionData</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-131"></a><span>          </span><a name="local-6989586621679215328"><a href="#local-6989586621679215328"><span class="hs-identifier">cleanSession</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.Context.html#cleanPhantomModules"><span class="hs-identifier hs-var">cleanPhantomModules</span></a><span>
</span><a name="line-132"></a><span>
</span><a name="line-133"></a><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="hs-pragma">uniqueToken</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-134"></a><span class="hs-identifier">uniqueToken</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><a name="uniqueToken"><a href="Hint.InterpreterT.html#uniqueToken"><span class="hs-identifier">uniqueToken</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unsafePerformIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">newMVar</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-identifier">ifInterpreterNotRunning</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679215285"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679215285"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679215285"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679215286"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215285"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679215286"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-138"></a><a name="ifInterpreterNotRunning"><a href="Hint.InterpreterT.html#ifInterpreterNotRunning"><span class="hs-identifier">ifInterpreterNotRunning</span></a></a><span> </span><a name="local-6989586621679215349"><a href="#local-6989586621679215349"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-139"></a><span>    </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621679215350"><a href="#local-6989586621679215350"><span class="hs-identifier">maybe_token</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryTakeMVar</span><span> </span><a href="Hint.InterpreterT.html#uniqueToken"><span class="hs-identifier hs-var">uniqueToken</span></a><span>
</span><a name="line-140"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679215350"><span class="hs-identifier hs-var">maybe_token</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-141"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">throwM</span><span> </span><a href="Hint.InterpreterT.html#MultipleInstancesNotAllowed"><span class="hs-identifier hs-var">MultipleInstancesNotAllowed</span></a><span>
</span><a name="line-142"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679215351"><a href="#local-6989586621679215351"><span class="hs-identifier">x</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679215349"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">finally</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">putMVar</span><span> </span><a href="Hint.InterpreterT.html#uniqueToken"><span class="hs-identifier hs-var">uniqueToken</span></a><span> </span><a href="#local-6989586621679215351"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- | The installed version of ghc is not thread-safe. This exception</span><span>
</span><a name="line-145"></a><span class="hs-comment">--   is thrown whenever you try to execute @runInterpreter@ while another</span><span>
</span><a name="line-146"></a><span class="hs-comment">--   instance is already running.</span><span>
</span><a name="line-147"></a><span class="hs-keyword">data</span><span> </span><a name="MultipleInstancesNotAllowed"><a href="Hint.InterpreterT.html#MultipleInstancesNotAllowed"><span class="hs-identifier">MultipleInstancesNotAllowed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="MultipleInstancesNotAllowed"><a href="Hint.InterpreterT.html#MultipleInstancesNotAllowed"><span class="hs-identifier">MultipleInstancesNotAllowed</span></a></a><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="Hint.InterpreterT.html#MultipleInstancesNotAllowed"><span class="hs-identifier hs-type">MultipleInstancesNotAllowed</span></a><span>
</span><a name="line-150"></a><span>
</span><a name="line-151"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Show</span><span> </span><a href="Hint.InterpreterT.html#MultipleInstancesNotAllowed"><span class="hs-identifier hs-type">MultipleInstancesNotAllowed</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-152"></a><span>    </span><a name="local-8214565720323790323"><span class="hs-identifier">show</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;This version of GHC is not thread-safe,&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-153"></a><span>             </span><span class="hs-string">&quot;can't safely run two instances of the interpreter simultaneously&quot;</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-identifier">initialState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hint.Base.html#InterpreterState"><span class="hs-identifier hs-type">InterpreterState</span></a><span>
</span><a name="line-156"></a><a name="initialState"><a href="Hint.InterpreterT.html#initialState"><span class="hs-identifier">initialState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Hint.Base.html#St"><span class="hs-identifier hs-var">St</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-157"></a><span>                   </span><span class="hs-identifier">activePhantoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-158"></a><span>                   </span><span class="hs-identifier">zombiePhantoms</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-159"></a><span class="hs-cpp">#if defined(NEED_PHANTOM_DIRECTORY)
</span><span>                   </span><span class="hs-identifier">phantomDirectory</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">,</span><span>
</span><a name="line-161"></a><span class="hs-cpp">#endif
</span><span class="">                   hintSupportModule = error &quot;No support module loaded!&quot;,
                   importQualHackMod = Nothing,
                   qualImports       = [],
                   defaultExts       = error &quot;defaultExts missing!&quot;,
                   configuration     = defaultConf
                  }

newSessionData :: MonadIO m =&gt; a -&gt; m (SessionData a)
newSessionData a =
    do initial_state    &lt;- liftIO $ newIORef initialState
       ghc_err_list_ref &lt;- liftIO $ newIORef []
       return SessionData {
         internalState   = initial_state,
         versionSpecific = a,
         ghcErrListRef   = ghc_err_list_ref,
         ghcErrLogger    = mkLogHandler ghc_err_list_ref
       }

mkLogHandler :: IORef [GhcError] -&gt; GhcErrLogger
mkLogHandler r df _ _ src style msg =
    let renderErrMsg = GHC.showSDoc df
        errorEntry = mkGhcError renderErrMsg src style msg
    in modifyIORef r (errorEntry :)

mkGhcError :: (GHC.SDoc -&gt; String) -&gt; GHC.SrcSpan -&gt; GHC.PprStyle -&gt; GHC.Message -&gt; GhcError
mkGhcError render src_span style msg = GhcError{errMsg = niceErrMsg}
    where niceErrMsg = render . GHC.withPprStyle style $
                         GHC.mkLocMessage GHC.SevError src_span msg

-- The MonadInterpreter instance

instance (MonadIO m, MonadMask m, Functor m) =&gt; MonadInterpreter (InterpreterT m) where
    fromSession f = InterpreterT $ asks f
    --
    modifySessionRef target f =
        do ref &lt;- fromSession target
           liftIO $ atomicModifyIORef ref (\a -&gt; (f a, a))
    --
    runGhc = runGhcImpl

instance (Monad m) =&gt; Applicative (InterpreterT m) where
    pure  = return
    (&lt;*&gt;) = ap
</span></pre></body></html>