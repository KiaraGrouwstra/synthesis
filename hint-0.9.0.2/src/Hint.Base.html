<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hint.Base</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-2"></a><span>    </span><a href="Hint.Base.html#MonadInterpreter"><span class="hs-identifier hs-type">MonadInterpreter</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#RunGhc"><span class="hs-identifier hs-type">RunGhc</span></a><span class="hs-special">,</span><span>
</span><a name="line-3"></a><span>
</span><a name="line-4"></a><span>    </span><a href="Hint.Base.html#GhcError"><span class="hs-identifier hs-type">GhcError</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#InterpreterError"><span class="hs-identifier hs-type">InterpreterError</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#mayFail"><span class="hs-identifier hs-var">mayFail</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#catchIE"><span class="hs-identifier hs-var">catchIE</span></a><span class="hs-special">,</span><span>
</span><a name="line-5"></a><span>
</span><a name="line-6"></a><span>    </span><a href="Hint.Base.html#InterpreterSession"><span class="hs-identifier hs-type">InterpreterSession</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#SessionData"><span class="hs-identifier hs-type">SessionData</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#GhcErrLogger"><span class="hs-identifier hs-type">GhcErrLogger</span></a><span class="hs-special">,</span><span>
</span><a name="line-7"></a><span>    </span><a href="Hint.Base.html#InterpreterState"><span class="hs-identifier hs-type">InterpreterState</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#fromState"><span class="hs-identifier hs-var">fromState</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#onState"><span class="hs-identifier hs-var">onState</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>    </span><a href="Hint.Base.html#InterpreterConfiguration"><span class="hs-identifier hs-type">InterpreterConfiguration</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-9"></a><span>    </span><a href="Hint.Base.html#ImportList"><span class="hs-identifier hs-type">ImportList</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#ModuleQualification"><span class="hs-identifier hs-type">ModuleQualification</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#ModuleImport"><span class="hs-identifier hs-type">ModuleImport</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span>    </span><a href="Hint.Base.html#runGhc1"><span class="hs-identifier hs-var">runGhc1</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#runGhc2"><span class="hs-identifier hs-var">runGhc2</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span>    </span><a href="Hint.Base.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#PhantomModule"><span class="hs-identifier hs-type">PhantomModule</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>    </span><a href="Hint.Base.html#findModule"><span class="hs-identifier hs-var">findModule</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#moduleIsLoaded"><span class="hs-identifier hs-var">moduleIsLoaded</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>    </span><a href="Hint.Base.html#withDynFlags"><span class="hs-identifier hs-var">withDynFlags</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>
</span><a name="line-17"></a><span>    </span><a href="Hint.Base.html#ghcVersion"><span class="hs-identifier hs-var">ghcVersion</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span>    </span><a href="Hint.Base.html#debug"><span class="hs-identifier hs-var">debug</span></a><span class="hs-special">,</span><span> </span><a href="Hint.Base.html#showGHC"><span class="hs-identifier hs-var">showGHC</span></a><span>
</span><a name="line-20"></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Trans</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad.Catch</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MC</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Dynamic</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Hint.GHC.html"><span class="hs-identifier">Hint.GHC</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">GHC</span><span>
</span><a name="line-30"></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Hint.Extension.html"><span class="hs-identifier">Hint.Extension</span></a><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-comment">-- | Version of the underlying ghc api. Values are:</span><span>
</span><a name="line-34"></a><span class="hs-comment">--</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- * @804@ for GHC 8.4.x</span><span>
</span><a name="line-36"></a><span class="hs-comment">--</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- * @806@ for GHC 8.6.x</span><span>
</span><a name="line-38"></a><span class="hs-comment">--</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- * etc...</span><span>
</span><a name="line-40"></a><span class="hs-identifier">ghcVersion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-41"></a><a name="ghcVersion"><a href="Hint.Base.html#ghcVersion"><span class="hs-identifier">ghcVersion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">__GLASGOW_HASKELL__</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadMask</span><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a name="MonadInterpreter"><a href="Hint.Base.html#MonadInterpreter"><span class="hs-identifier">MonadInterpreter</span></a></a><span> </span><a name="local-6989586621679185302"><a href="#local-6989586621679185302"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-44"></a><span>    </span><a name="fromSession"><a href="Hint.Base.html#fromSession"><span class="hs-identifier">fromSession</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><a href="Hint.Base.html#FromSession"><span class="hs-identifier hs-type">FromSession</span></a><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679185303"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-45"></a><span>    </span><a name="modifySessionRef"><a href="Hint.Base.html#modifySessionRef"><span class="hs-identifier">modifySessionRef</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Hint.Base.html#ModifySessionRef"><span class="hs-identifier hs-type">ModifySessionRef</span></a><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679185304"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-46"></a><span>    </span><a name="runGhc"><a href="Hint.Base.html#runGhc"><span class="hs-identifier">runGhc</span></a></a><span>           </span><span class="hs-glyph">::</span><span> </span><a href="Hint.Base.html#RunGhc"><span class="hs-identifier hs-type">RunGhc</span></a><span> </span><a href="#local-6989586621679185302"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679185305"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">-- this is for hiding the actual types in haddock</span><span>
</span><a name="line-49"></a><span class="hs-keyword">type</span><span> </span><a name="FromSession"><a href="Hint.Base.html#FromSession"><span class="hs-identifier">FromSession</span></a></a><span>      </span><a name="local-6989586621679185300"><a href="#local-6989586621679185300"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679185301"><a href="#local-6989586621679185301"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Hint.Base.html#InterpreterSession"><span class="hs-identifier hs-type">InterpreterSession</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679185301"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679185300"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679185301"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-50"></a><span class="hs-keyword">type</span><span> </span><a name="ModifySessionRef"><a href="Hint.Base.html#ModifySessionRef"><span class="hs-identifier">ModifySessionRef</span></a></a><span> </span><a name="local-6989586621679185298"><a href="#local-6989586621679185298"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679185299"><a href="#local-6989586621679185299"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Hint.Base.html#InterpreterSession"><span class="hs-identifier hs-type">InterpreterSession</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="#local-6989586621679185299"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679185299"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679185299"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679185298"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679185299"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-51"></a><span>
</span><a name="line-52"></a><span class="hs-keyword">data</span><span> </span><a name="InterpreterError"><a href="Hint.Base.html#InterpreterError"><span class="hs-identifier">InterpreterError</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="UnknownError"><a href="Hint.Base.html#UnknownError"><span class="hs-identifier">UnknownError</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-53"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="WontCompile"><a href="Hint.Base.html#WontCompile"><span class="hs-identifier">WontCompile</span></a></a><span> </span><span class="hs-special">[</span><a href="Hint.Base.html#GhcError"><span class="hs-identifier hs-type">GhcError</span></a><span class="hs-special">]</span><span>
</span><a name="line-54"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="NotAllowed"><a href="Hint.Base.html#NotAllowed"><span class="hs-identifier">NotAllowed</span></a></a><span>  </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-55"></a><span>                      </span><span class="hs-comment">-- | GhcExceptions from the underlying GHC API are caught</span><span>
</span><a name="line-56"></a><span>                      </span><span class="hs-comment">-- and rethrown as this.</span><span>
</span><a name="line-57"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="GhcException"><a href="Hint.Base.html#GhcException"><span class="hs-identifier">GhcException</span></a></a><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-58"></a><span>                      </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">data</span><span> </span><a name="InterpreterState"><a href="Hint.Base.html#InterpreterState"><span class="hs-identifier">InterpreterState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="St"><a href="Hint.Base.html#St"><span class="hs-identifier">St</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-61"></a><span>                           </span><a name="activePhantoms"><a href="Hint.Base.html#activePhantoms"><span class="hs-identifier">activePhantoms</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Hint.Base.html#PhantomModule"><span class="hs-identifier hs-type">PhantomModule</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>                           </span><a name="zombiePhantoms"><a href="Hint.Base.html#zombiePhantoms"><span class="hs-identifier">zombiePhantoms</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Hint.Base.html#PhantomModule"><span class="hs-identifier hs-type">PhantomModule</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-63"></a><span class="hs-cpp">#if defined(NEED_PHANTOM_DIRECTORY)
</span><span>                           </span><a name="phantomDirectory"><a href="Hint.Base.html#phantomDirectory"><span class="hs-identifier">phantomDirectory</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span>
</span><a name="line-65"></a><span class="hs-cpp">#endif
</span><span class="">                           hintSupportModule :: PhantomModule,
                           importQualHackMod :: Maybe PhantomModule,
                           qualImports       :: [ModuleImport],
                           defaultExts       :: [(Extension, Bool)], -- R/O
                           configuration     :: InterpreterConfiguration
                        }

data ImportList = NoImportList | ImportList [String] | HidingList [String]
  deriving (Eq, Show)
data ModuleQualification = NotQualified | ImportAs String | QualifiedAs (Maybe String)
  deriving (Eq, Show)

-- | Represent module import statement.
--   See 'setImportsF'
data ModuleImport = ModuleImport { modName :: String
                                 , modQual :: ModuleQualification
                                 , modImp  :: ImportList
                                 } deriving (Show)

data InterpreterConfiguration = Conf {
                                  searchFilePath :: [FilePath],
                                  languageExts   :: [Extension],
                                  allModsInScope :: Bool
                                }

type InterpreterSession = SessionData ()

instance Exception InterpreterError
  where
    displayException (UnknownError err) = &quot;UnknownError: &quot; ++ err
    displayException (WontCompile  es)  = unlines . Data.List.nub . map errMsg $ es
    displayException (NotAllowed   err) = &quot;NotAllowed: &quot;   ++ err
    displayException (GhcException err) = &quot;GhcException: &quot; ++ err

type RunGhc  m a =
    (forall n.(MonadIO n, MonadMask n) =&gt; GHC.GhcT n a)
 -&gt; m a

type RunGhc1 m a b =
    (forall n.(MonadIO n, MonadMask n) =&gt; a -&gt; GHC.GhcT n b)
 -&gt; (a -&gt; m b)

type RunGhc2 m a b c =
    (forall n.(MonadIO n, MonadMask n) =&gt; a -&gt; b -&gt; GHC.GhcT n c)
 -&gt; (a -&gt; b -&gt; m c)

data SessionData a = SessionData {
                       internalState   :: IORef InterpreterState,
                       versionSpecific :: a,
                       ghcErrListRef   :: IORef [GhcError],
                       ghcErrLogger    :: GhcErrLogger
                     }

-- When intercepting errors reported by GHC, we only get a ErrUtils.Message
-- and a SrcLoc.SrcSpan. The latter holds the file name and the location
-- of the error. However, SrcSpan is abstract and it doesn't provide
-- functions to retrieve the line and column of the error... we can only
-- generate a string with this information. Maybe I can parse this string
-- later.... (sigh)
newtype GhcError = GhcError{errMsg :: String} deriving Show

mapGhcExceptions :: MonadInterpreter m
                 =&gt; (String -&gt; InterpreterError)
                 -&gt; m a
                 -&gt; m a
mapGhcExceptions buildEx action =
    action
      `MC.catch` (\err -&gt; case err of
                            GhcException s -&gt; throwM (buildEx s)
                            _              -&gt; throwM err)

catchIE :: MonadInterpreter m =&gt; m a -&gt; (InterpreterError -&gt; m a) -&gt; m a
catchIE = MC.catch

type GhcErrLogger = GHC.LogAction

-- | Module names are _not_ filepaths.
type ModuleName = String

runGhc1 :: MonadInterpreter m =&gt; RunGhc1 m a b
runGhc1 f a = runGhc (f a)

runGhc2 :: MonadInterpreter m =&gt; RunGhc2 m a b c
runGhc2 f a = runGhc1 (f a)

-- ================ Handling the interpreter state =================

fromState :: MonadInterpreter m =&gt; (InterpreterState -&gt; a) -&gt; m a
fromState f = do ref_st &lt;- fromSession internalState
                 liftIO $ f `fmap` readIORef ref_st

onState :: MonadInterpreter m =&gt; (InterpreterState -&gt; InterpreterState) -&gt; m ()
onState f = modifySessionRef internalState f &gt;&gt; return ()

-- =============== Error handling ==============================

mayFail :: MonadInterpreter m =&gt; m (Maybe a) -&gt; m a
mayFail action =
    do
        maybe_res &lt;- action
        --
        es &lt;- modifySessionRef ghcErrListRef (const [])
        --
        case (maybe_res, null es) of
            (Nothing, True)  -&gt; throwM $ UnknownError &quot;Got no error message&quot;
            (Nothing, False) -&gt; throwM $ WontCompile (reverse es)
            (Just a, _)      -&gt; return a

-- ================= Debugging stuff ===============

debug :: MonadInterpreter m =&gt; String -&gt; m ()
debug = liftIO . putStrLn . (&quot;!! &quot; ++)

showGHC :: (MonadInterpreter m, GHC.Outputable a) =&gt; a -&gt; m String
showGHC a
 = do unqual &lt;- runGhc GHC.getPrintUnqual
      withDynFlags $ \df -&gt;
        return $ GHC.showSDocForUser df unqual (GHC.ppr a)

-- ================ Misc ===================================

-- this type ought to go in Hint.Context, but ghc dislikes cyclic imports...
data PhantomModule = PhantomModule{pmName :: ModuleName, pmFile :: FilePath}
                   deriving (Eq, Show)

findModule :: MonadInterpreter m =&gt; ModuleName -&gt; m GHC.Module
findModule mn = mapGhcExceptions NotAllowed $
                    runGhc2 GHC.findModule mod_name Nothing
    where mod_name = GHC.mkModuleName mn

moduleIsLoaded :: MonadInterpreter m =&gt; ModuleName -&gt; m Bool
moduleIsLoaded mn = (findModule mn &gt;&gt; return True)
                   `catchIE` (\e -&gt; case e of
                                      NotAllowed{}  -&gt; return False
                                      WontCompile{} -&gt; return False
                                      _             -&gt; throwM e)

withDynFlags :: MonadInterpreter m =&gt; (GHC.DynFlags -&gt; m a) -&gt; m a
withDynFlags action
 = do df &lt;- runGhc GHC.getSessionDynFlags
      action df
</span></pre></body></html>