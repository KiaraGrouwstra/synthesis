<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{-
(c) The University of Glasgow 2006
(c) The AQUA Project, Glasgow University, 1996-1998


This module contains &quot;tidying&quot; code for *nested* expressions, bindings, rules.
The code for *top-level* bindings is in TidyPgm.
-}</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">CoreTidy</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-12"></a><span>        </span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span class="hs-special">,</span><span> </span><a href="CoreTidy.html#tidyRule"><span class="hs-identifier hs-var">tidyRule</span></a><span class="hs-special">,</span><span> </span><a href="CoreTidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a><span class="hs-special">,</span><span> </span><a href="CoreTidy.html#tidyUnfolding"><span class="hs-identifier hs-var">tidyUnfolding</span></a><span>
</span><a name="line-13"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSyn.html"><span class="hs-identifier">CoreSyn</span></a><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><a href="CoreSeq.html"><span class="hs-identifier">CoreSeq</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="CoreSeq.html#seqUnfolding"><span class="hs-identifier hs-var">seqUnfolding</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="CoreArity.html"><span class="hs-identifier">CoreArity</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="Id.html"><span class="hs-identifier">Id</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="IdInfo.html"><span class="hs-identifier">IdInfo</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="Demand.html"><span class="hs-identifier">Demand</span></a><span> </span><span class="hs-special">(</span><span> </span><a href="Demand.html#zapUsageEnvSig"><span class="hs-identifier hs-var">zapUsageEnvSig</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Type.html"><span class="hs-identifier">Type</span></a><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span class="hs-special">,</span><span> </span><a href="TyCoRep.html#tidyVarBndr"><span class="hs-identifier hs-var">tidyVarBndr</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Coercion.html"><span class="hs-identifier">Coercion</span></a><span class="hs-special">(</span><span> </span><a href="TyCoRep.html#tidyCo"><span class="hs-identifier hs-var">tidyCo</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Var.html"><span class="hs-identifier">Var</span></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="VarEnv.html"><span class="hs-identifier">VarEnv</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><a href="Name.html#tidyNameOcc"><span class="hs-identifier hs-var">tidyNameOcc</span></a><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="SrcLoc.html"><span class="hs-identifier">SrcLoc</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Tidying expressions, rules}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-identifier">tidyBind</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span>
</span><a name="line-44"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span>
</span><a name="line-45"></a><span>         </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>
</span><a name="line-47"></a><a name="tidyBind"><a href="CoreTidy.html#tidyBind"><span class="hs-identifier">tidyBind</span></a></a><span> </span><a name="local-6989586621684766561"><a href="#local-6989586621684766561"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a name="local-6989586621684766562"><a href="#local-6989586621684766562"><span class="hs-identifier">bndr</span></a></a><span> </span><a name="local-6989586621684766563"><a href="#local-6989586621684766563"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyLetBndr"><span class="hs-identifier hs-var">tidyLetBndr</span></a><span> </span><a href="#local-6989586621684766561"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766561"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621684766562"><span class="hs-identifier hs-var">bndr</span></a><span class="hs-special">,</span><a href="#local-6989586621684766563"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span> </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766564"><a href="#local-6989586621684766564"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766565"><a href="#local-6989586621684766565"><span class="hs-identifier">bndr'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684766564"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a><span> </span><a href="#local-6989586621684766565"><span class="hs-identifier hs-var">bndr'</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766564"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684766563"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-identifier">tidyBind</span><span> </span><a name="local-6989586621684766566"><a href="#local-6989586621684766566"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><a name="local-6989586621684766567"><a href="#local-6989586621684766567"><span class="hs-identifier">prs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span>
</span><a name="line-53"></a><span>       </span><span class="hs-special">(</span><a name="local-6989586621684766568"><a href="#local-6989586621684766568"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766569"><a href="#local-6989586621684766569"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyLetBndr"><span class="hs-identifier hs-var">tidyLetBndr</span></a><span> </span><a href="#local-6989586621684766568"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766566"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766567"><span class="hs-identifier hs-var">prs</span></a><span>
</span><a name="line-54"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766568"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">snd</span><span> </span><a href="#local-6989586621684766567"><span class="hs-identifier hs-var">prs</span></a><span class="hs-special">)</span><span>   </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621684766570"><a href="#local-6989586621684766570"><span class="hs-identifier">rhss'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684766568"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#Rec"><span class="hs-identifier hs-var">Rec</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621684766569"><span class="hs-identifier hs-var">bndrs'</span></a><span> </span><a href="#local-6989586621684766570"><span class="hs-identifier hs-var">rhss'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>
</span><a name="line-58"></a><span>
</span><a name="line-59"></a><span class="hs-comment">------------  Expressions  --------------</span><span>
</span><a name="line-60"></a><span class="hs-identifier">tidyExpr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span>
</span><a name="line-61"></a><a name="tidyExpr"><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier">tidyExpr</span></a></a><span> </span><a name="local-6989586621684766571"><a href="#local-6989586621684766571"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><a name="local-6989586621684766572"><a href="#local-6989586621684766572"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span>       </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Var"><span class="hs-identifier hs-var">Var</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyVarOcc"><span class="hs-identifier hs-var">tidyVarOcc</span></a><span> </span><a href="#local-6989586621684766571"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766572"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span>
</span><a name="line-62"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766573"><a href="#local-6989586621684766573"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><a name="local-6989586621684766574"><a href="#local-6989586621684766574"><span class="hs-identifier">ty</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Type"><span class="hs-identifier hs-var">Type</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621684766573"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766574"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766575"><a href="#local-6989586621684766575"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><a name="local-6989586621684766576"><a href="#local-6989586621684766576"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Coercion"><span class="hs-identifier hs-var">Coercion</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyCo"><span class="hs-identifier hs-var">tidyCo</span></a><span> </span><a href="#local-6989586621684766575"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766576"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-identifier">tidyExpr</span><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">(</span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a name="local-6989586621684766577"><a href="#local-6989586621684766577"><span class="hs-identifier">lit</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Lit"><span class="hs-identifier hs-var">Lit</span></a><span> </span><a href="#local-6989586621684766577"><span class="hs-identifier hs-var">lit</span></a><span>
</span><a name="line-65"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766578"><a href="#local-6989586621684766578"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><a name="local-6989586621684766579"><a href="#local-6989586621684766579"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621684766580"><a href="#local-6989586621684766580"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#App"><span class="hs-identifier hs-var">App</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766578"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766579"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766578"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766580"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766581"><a href="#local-6989586621684766581"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><a name="local-6989586621684766582"><a href="#local-6989586621684766582"><span class="hs-identifier">t</span></a></a><span> </span><a name="local-6989586621684766583"><a href="#local-6989586621684766583"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Tick"><span class="hs-identifier hs-var">Tick</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyTickish"><span class="hs-identifier hs-var">tidyTickish</span></a><span> </span><a href="#local-6989586621684766581"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766582"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766581"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766583"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766584"><a href="#local-6989586621684766584"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><a name="local-6989586621684766585"><a href="#local-6989586621684766585"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684766586"><a href="#local-6989586621684766586"><span class="hs-identifier">co</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Cast"><span class="hs-identifier hs-var">Cast</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766584"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766585"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyCo"><span class="hs-identifier hs-var">tidyCo</span></a><span> </span><a href="#local-6989586621684766584"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766586"><span class="hs-identifier hs-var">co</span></a><span class="hs-special">)</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766587"><a href="#local-6989586621684766587"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a name="local-6989586621684766588"><a href="#local-6989586621684766588"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684766589"><a href="#local-6989586621684766589"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyBind"><span class="hs-identifier hs-var">tidyBind</span></a><span> </span><a href="#local-6989586621684766587"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766588"><span class="hs-identifier hs-var">b</span></a><span>      </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766590"><a href="#local-6989586621684766590"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766591"><a href="#local-6989586621684766591"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-71"></a><span>    </span><a href="CoreSyn.html#Let"><span class="hs-identifier hs-var">Let</span></a><span> </span><a href="#local-6989586621684766591"><span class="hs-identifier hs-var">b'</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766590"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684766589"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766592"><a href="#local-6989586621684766592"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><a name="local-6989586621684766593"><a href="#local-6989586621684766593"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621684766594"><a href="#local-6989586621684766594"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684766595"><a href="#local-6989586621684766595"><span class="hs-identifier">ty</span></a></a><span> </span><a name="local-6989586621684766596"><a href="#local-6989586621684766596"><span class="hs-identifier">alts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyBndr"><span class="hs-identifier hs-var">tidyBndr</span></a><span> </span><a href="#local-6989586621684766592"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766594"><span class="hs-identifier hs-var">b</span></a><span>  </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766597"><a href="#local-6989586621684766597"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766598"><a href="#local-6989586621684766598"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-75"></a><span>    </span><a href="CoreSyn.html#Case"><span class="hs-identifier hs-var">Case</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766592"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766593"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766598"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621684766592"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766595"><span class="hs-identifier hs-var">ty</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyAlt"><span class="hs-identifier hs-var">tidyAlt</span></a><span> </span><a href="#local-6989586621684766597"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766596"><span class="hs-identifier hs-var">alts</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-identifier">tidyExpr</span><span> </span><a name="local-6989586621684766599"><a href="#local-6989586621684766599"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a name="local-6989586621684766600"><a href="#local-6989586621684766600"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621684766601"><a href="#local-6989586621684766601"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyBndr"><span class="hs-identifier hs-var">tidyBndr</span></a><span> </span><a href="#local-6989586621684766599"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766600"><span class="hs-identifier hs-var">b</span></a><span>      </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766602"><a href="#local-6989586621684766602"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766603"><a href="#local-6989586621684766603"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-80"></a><span>    </span><a href="CoreSyn.html#Lam"><span class="hs-identifier hs-var">Lam</span></a><span> </span><a href="#local-6989586621684766603"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766602"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684766601"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-comment">------------  Case alternatives  --------------</span><span>
</span><a name="line-83"></a><span class="hs-identifier">tidyAlt</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreAlt"><span class="hs-identifier hs-type">CoreAlt</span></a><span>
</span><a name="line-84"></a><a name="tidyAlt"><a href="CoreTidy.html#tidyAlt"><span class="hs-identifier">tidyAlt</span></a></a><span> </span><a name="local-6989586621684766604"><a href="#local-6989586621684766604"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684766605"><a href="#local-6989586621684766605"><span class="hs-identifier">con</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766606"><a href="#local-6989586621684766606"><span class="hs-identifier">vs</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766607"><a href="#local-6989586621684766607"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyBndrs"><span class="hs-identifier hs-var">tidyBndrs</span></a><span> </span><a href="#local-6989586621684766604"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766606"><span class="hs-identifier hs-var">vs</span></a><span>    </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766608"><a href="#local-6989586621684766608"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766609"><a href="#local-6989586621684766609"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684766605"><span class="hs-identifier hs-var">con</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684766609"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">,</span><span> </span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766608"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684766607"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span class="hs-comment">------------  Tickish  --------------</span><span>
</span><a name="line-89"></a><span class="hs-identifier">tidyTickish</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Tickish"><span class="hs-identifier hs-type">Tickish</span></a><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span>
</span><a name="line-90"></a><a name="tidyTickish"><a href="CoreTidy.html#tidyTickish"><span class="hs-identifier">tidyTickish</span></a></a><span> </span><a name="local-6989586621684766610"><a href="#local-6989586621684766610"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a name="local-6989586621684766611"><a href="#local-6989586621684766611"><span class="hs-identifier">ix</span></a></a><span> </span><a name="local-6989586621684766612"><a href="#local-6989586621684766612"><span class="hs-identifier">ids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSyn.html#Breakpoint"><span class="hs-identifier hs-var">Breakpoint</span></a><span> </span><a href="#local-6989586621684766611"><span class="hs-identifier hs-var">ix</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyVarOcc"><span class="hs-identifier hs-var">tidyVarOcc</span></a><span> </span><a href="#local-6989586621684766610"><span class="hs-identifier hs-var">env</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766612"><span class="hs-identifier hs-var">ids</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span class="hs-identifier">tidyTickish</span><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621684766613"><a href="#local-6989586621684766613"><span class="hs-identifier">other_tickish</span></a></a><span>       </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766613"><span class="hs-identifier hs-var">other_tickish</span></a><span>
</span><a name="line-92"></a><span>
</span><a name="line-93"></a><span class="hs-comment">------------  Rules  --------------</span><span>
</span><a name="line-94"></a><span class="hs-identifier">tidyRules</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span class="hs-special">]</span><span>
</span><a name="line-95"></a><a name="tidyRules"><a href="CoreTidy.html#tidyRules"><span class="hs-identifier">tidyRules</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-96"></a><span class="hs-identifier">tidyRules</span><span> </span><a name="local-6989586621684766614"><a href="#local-6989586621684766614"><span class="hs-identifier">env</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621684766615"><a href="#local-6989586621684766615"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621684766616"><a href="#local-6989586621684766616"><span class="hs-identifier">rules</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyRule"><span class="hs-identifier hs-var">tidyRule</span></a><span> </span><a href="#local-6989586621684766614"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766615"><span class="hs-identifier hs-var">rule</span></a><span>           </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621684766617"><a href="#local-6989586621684766617"><span class="hs-identifier">rule</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-98"></a><span>    </span><a href="CoreTidy.html#tidyRules"><span class="hs-identifier hs-var">tidyRules</span></a><span> </span><a href="#local-6989586621684766614"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766616"><span class="hs-identifier hs-var">rules</span></a><span>         </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621684766618"><a href="#local-6989586621684766618"><span class="hs-identifier">rules</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-99"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621684766617"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621684766618"><span class="hs-identifier hs-var">rules</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-identifier">tidyRule</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a><span>
</span><a name="line-102"></a><a name="tidyRule"><a href="CoreTidy.html#tidyRule"><span class="hs-identifier">tidyRule</span></a></a><span> </span><span class="hs-identifier">_</span><span>   </span><a name="local-6989586621684766619"><a href="#local-6989586621684766619"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#BuiltinRule"><span class="hs-identifier hs-var">BuiltinRule</span></a><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766619"><span class="hs-identifier hs-var">rule</span></a><span>
</span><a name="line-103"></a><span class="hs-identifier">tidyRule</span><span> </span><a name="local-6989586621684766620"><a href="#local-6989586621684766620"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684766621"><a href="#local-6989586621684766621"><span class="hs-identifier">rule</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#Rule"><span class="hs-identifier hs-var">Rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766622"><a href="#local-6989586621684766622"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766623"><a href="#local-6989586621684766623"><span class="hs-identifier">args</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rhs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766624"><a href="#local-6989586621684766624"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-104"></a><span>                          </span><span class="hs-identifier">ru_fn</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766625"><a href="#local-6989586621684766625"><span class="hs-identifier">fn</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_rough</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766626"><a href="#local-6989586621684766626"><span class="hs-identifier">mb_ns</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-105"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyBndrs"><span class="hs-identifier hs-var">tidyBndrs</span></a><span> </span><a href="#local-6989586621684766620"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766622"><span class="hs-identifier hs-var">bndrs</span></a><span>         </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766627"><a href="#local-6989586621684766627"><span class="hs-identifier">env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766628"><a href="#local-6989586621684766628"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-106"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766627"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766623"><span class="hs-identifier hs-var">args</span></a><span>    </span><a href="CoreTidy.html#%3D%3A"><span class="hs-operator hs-var">=:</span></a><span> </span><span class="hs-glyph">\</span><span> </span><a name="local-6989586621684766629"><a href="#local-6989586621684766629"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-107"></a><span>    </span><a href="#local-6989586621684766621"><span class="hs-identifier hs-var">rule</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ru_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766628"><span class="hs-identifier hs-var">bndrs</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">ru_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766629"><span class="hs-identifier hs-var">args</span></a><span class="hs-special">,</span><span>
</span><a name="line-108"></a><span>           </span><span class="hs-identifier">ru_rhs</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766627"><span class="hs-identifier hs-var">env'</span></a><span> </span><a href="#local-6989586621684766624"><span class="hs-identifier hs-var">rhs</span></a><span class="hs-special">,</span><span>
</span><a name="line-109"></a><span>           </span><span class="hs-identifier">ru_fn</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyNameOcc"><span class="hs-identifier hs-var">tidyNameOcc</span></a><span> </span><a href="#local-6989586621684766620"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766625"><span class="hs-identifier hs-var">fn</span></a><span class="hs-special">,</span><span>
</span><a name="line-110"></a><span>           </span><span class="hs-identifier">ru_rough</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyNameOcc"><span class="hs-identifier hs-var">tidyNameOcc</span></a><span> </span><a href="#local-6989586621684766627"><span class="hs-identifier hs-var">env'</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766626"><span class="hs-identifier hs-var">mb_ns</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-111"></a><span>
</span><a name="line-112"></a><span class="hs-comment">{-
************************************************************************
*                                                                      *
\subsection{Tidying non-top-level binders}
*                                                                      *
************************************************************************
-}</span><span>
</span><a name="line-119"></a><span>
</span><a name="line-120"></a><span class="hs-identifier">tidyNameOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span>
</span><a name="line-121"></a><span class="hs-comment">-- In rules and instances, we have Names, and we must tidy them too</span><span>
</span><a name="line-122"></a><span class="hs-comment">-- Fortunately, we can lookup in the VarEnv with a name</span><span>
</span><a name="line-123"></a><a name="tidyNameOcc"><a href="CoreTidy.html#tidyNameOcc"><span class="hs-identifier">tidyNameOcc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684766630"><a href="#local-6989586621684766630"><span class="hs-identifier">var_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684766631"><a href="#local-6989586621684766631"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="UniqFM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a><span> </span><a href="#local-6989586621684766630"><span class="hs-identifier hs-var">var_env</span></a><span> </span><a href="#local-6989586621684766631"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-124"></a><span>                                </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684766631"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-125"></a><span>                                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621684766632"><a href="#local-6989586621684766632"><span class="hs-identifier">v</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Id.html#idName"><span class="hs-identifier hs-var">idName</span></a><span> </span><a href="#local-6989586621684766632"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-126"></a><span>
</span><a name="line-127"></a><span class="hs-identifier">tidyVarOcc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span>
</span><a name="line-128"></a><a name="tidyVarOcc"><a href="CoreTidy.html#tidyVarOcc"><span class="hs-identifier">tidyVarOcc</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621684766633"><a href="#local-6989586621684766633"><span class="hs-identifier">var_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684766634"><a href="#local-6989586621684766634"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#lookupVarEnv"><span class="hs-identifier hs-var">lookupVarEnv</span></a><span> </span><a href="#local-6989586621684766633"><span class="hs-identifier hs-var">var_env</span></a><span> </span><a href="#local-6989586621684766634"><span class="hs-identifier hs-var">v</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684766634"><span class="hs-identifier hs-var">v</span></a><span>
</span><a name="line-129"></a><span>
</span><a name="line-130"></a><span class="hs-comment">-- tidyBndr is used for lambda and case binders</span><span>
</span><a name="line-131"></a><span class="hs-identifier">tidyBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><a name="tidyBndr"><a href="CoreTidy.html#tidyBndr"><span class="hs-identifier">tidyBndr</span></a></a><span> </span><a name="local-6989586621684766635"><a href="#local-6989586621684766635"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684766636"><a href="#local-6989586621684766636"><span class="hs-identifier">var</span></a></a><span>
</span><a name="line-133"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Var.html#isTyCoVar"><span class="hs-identifier hs-var">isTyCoVar</span></a><span> </span><a href="#local-6989586621684766636"><span class="hs-identifier hs-var">var</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyVarBndr"><span class="hs-identifier hs-var">tidyVarBndr</span></a><span> </span><a href="#local-6989586621684766635"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766636"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-134"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyIdBndr"><span class="hs-identifier hs-var">tidyIdBndr</span></a><span> </span><a href="#local-6989586621684766635"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766636"><span class="hs-identifier hs-var">var</span></a><span>
</span><a name="line-135"></a><span>
</span><a name="line-136"></a><span class="hs-identifier">tidyBndrs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-137"></a><a name="tidyBndrs"><a href="CoreTidy.html#tidyBndrs"><span class="hs-identifier">tidyBndrs</span></a></a><span> </span><a name="local-6989586621684766637"><a href="#local-6989586621684766637"><span class="hs-identifier">env</span></a></a><span> </span><a name="local-6989586621684766638"><a href="#local-6989586621684766638"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapAccumL</span><span> </span><a href="CoreTidy.html#tidyBndr"><span class="hs-identifier hs-var">tidyBndr</span></a><span> </span><a href="#local-6989586621684766637"><span class="hs-identifier hs-var">env</span></a><span> </span><a href="#local-6989586621684766638"><span class="hs-identifier hs-var">vars</span></a><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- Non-top-level variables, not covars</span><span>
</span><a name="line-140"></a><span class="hs-identifier">tidyIdBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><a name="tidyIdBndr"><a href="CoreTidy.html#tidyIdBndr"><span class="hs-identifier">tidyIdBndr</span></a></a><span> </span><a name="local-6989586621684766639"><a href="#local-6989586621684766639"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684766640"><a href="#local-6989586621684766640"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766641"><a href="#local-6989586621684766641"><span class="hs-identifier">var_env</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621684766642"><a href="#local-6989586621684766642"><span class="hs-identifier">id</span></a></a><span>
</span><a name="line-142"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Do this pattern match strictly, otherwise we end up holding on to</span><span>
</span><a name="line-143"></a><span>    </span><span class="hs-comment">-- stuff in the OccName.</span><span>
</span><a name="line-144"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="OccName.html#tidyOccName"><span class="hs-identifier hs-var">tidyOccName</span></a><span> </span><a href="#local-6989586621684766640"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a><span> </span><a href="#local-6989586621684766642"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766643"><a href="#local-6989586621684766643"><span class="hs-identifier">tidy_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766644"><a href="#local-6989586621684766644"><span class="hs-identifier">occ'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-145"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-146"></a><span>        </span><span class="hs-comment">-- Give the Id a fresh print-name, *and* rename its type</span><span>
</span><a name="line-147"></a><span>        </span><span class="hs-comment">-- The SrcLoc isn't important now,</span><span>
</span><a name="line-148"></a><span>        </span><span class="hs-comment">-- though we could extract it from the Id</span><span>
</span><a name="line-149"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-150"></a><span>        </span><a name="local-6989586621684766645"><a href="#local-6989586621684766645"><span class="hs-identifier">ty'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621684766639"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684766642"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-151"></a><span>        </span><a name="local-6989586621684766646"><a href="#local-6989586621684766646"><span class="hs-identifier">name'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnique"><span class="hs-identifier hs-var">idUnique</span></a><span> </span><a href="#local-6989586621684766642"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766644"><span class="hs-identifier hs-var">occ'</span></a><span> </span><a href="SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a><span>
</span><a name="line-152"></a><span>        </span><a name="local-6989586621684766647"><a href="#local-6989586621684766647"><span class="hs-identifier">id'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Id.html#mkLocalIdWithInfo"><span class="hs-identifier hs-var">mkLocalIdWithInfo</span></a><span> </span><a href="#local-6989586621684766646"><span class="hs-identifier hs-var">name'</span></a><span> </span><a href="#local-6989586621684766645"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621684766649"><span class="hs-identifier hs-var">new_info</span></a><span>
</span><a name="line-153"></a><span>        </span><a name="local-6989586621684766648"><a href="#local-6989586621684766648"><span class="hs-identifier">var_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684766641"><span class="hs-identifier hs-var">var_env</span></a><span> </span><a href="#local-6989586621684766642"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684766647"><span class="hs-identifier hs-var">id'</span></a><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span>        </span><span class="hs-comment">-- Note [Tidy IdInfo]</span><span>
</span><a name="line-156"></a><span>        </span><a name="local-6989586621684766649"><a href="#local-6989586621684766649"><span class="hs-identifier">new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a><span> </span><span class="hs-special">`</span><a href="IdInfo.html#setOccInfo"><span class="hs-identifier hs-var">setOccInfo</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">occInfo</span><span> </span><a href="#local-6989586621684766650"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-157"></a><span>                                 </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621684766652"><span class="hs-identifier hs-var">new_unf</span></a><span>
</span><a name="line-158"></a><span>                                  </span><span class="hs-comment">-- see Note [Preserve OneShotInfo]</span><span>
</span><a name="line-159"></a><span>                                 </span><span class="hs-special">`</span><a href="IdInfo.html#setOneShotInfo"><span class="hs-identifier hs-var">setOneShotInfo</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">oneShotInfo</span><span> </span><a href="#local-6989586621684766650"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-160"></a><span>        </span><a name="local-6989586621684766650"><a href="#local-6989586621684766650"><span class="hs-identifier">old_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621684766642"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-161"></a><span>        </span><a name="local-6989586621684766651"><a href="#local-6989586621684766651"><span class="hs-identifier">old_unf</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621684766650"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-162"></a><span>        </span><a name="local-6989586621684766652"><a href="#local-6989586621684766652"><span class="hs-identifier">new_unf</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#zapUnfolding"><span class="hs-identifier hs-var">zapUnfolding</span></a><span> </span><a href="#local-6989586621684766651"><span class="hs-identifier hs-var">old_unf</span></a><span>  </span><span class="hs-comment">-- See Note [Preserve evaluatedness]</span><span>
</span><a name="line-163"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-164"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684766643"><span class="hs-identifier hs-var">tidy_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684766648"><span class="hs-identifier hs-var">var_env'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684766647"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>   </span><span class="hs-special">}</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-identifier">tidyLetBndr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span>         </span><span class="hs-comment">-- Knot-tied version for unfoldings</span><span>
</span><a name="line-168"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span>         </span><span class="hs-comment">-- The one to extend</span><span>
</span><a name="line-169"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Var.html#Id"><span class="hs-identifier hs-type">Id</span></a><span class="hs-special">,</span><span> </span><a href="CoreSyn.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span class="hs-special">,</span><span> </span><a href="Var.html#Var"><span class="hs-identifier hs-type">Var</span></a><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- Used for local (non-top-level) let(rec)s</span><span>
</span><a name="line-171"></a><span class="hs-comment">-- Just like tidyIdBndr above, but with more IdInfo</span><span>
</span><a name="line-172"></a><a name="tidyLetBndr"><a href="CoreTidy.html#tidyLetBndr"><span class="hs-identifier">tidyLetBndr</span></a></a><span> </span><a name="local-6989586621684766653"><a href="#local-6989586621684766653"><span class="hs-identifier">rec_tidy_env</span></a></a><span> </span><a name="local-6989586621684766654"><a href="#local-6989586621684766654"><span class="hs-identifier">env</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621684766655"><a href="#local-6989586621684766655"><span class="hs-identifier">tidy_env</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766656"><a href="#local-6989586621684766656"><span class="hs-identifier">var_env</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766657"><a href="#local-6989586621684766657"><span class="hs-identifier">id</span></a></a><span class="hs-special">,</span><a name="local-6989586621684766658"><a href="#local-6989586621684766658"><span class="hs-identifier">rhs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="OccName.html#tidyOccName"><span class="hs-identifier hs-var">tidyOccName</span></a><span> </span><a href="#local-6989586621684766655"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><span class="hs-special">(</span><a href="Name.html#getOccName"><span class="hs-identifier hs-var">getOccName</span></a><span> </span><a href="#local-6989586621684766657"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><a name="local-6989586621684766659"><a href="#local-6989586621684766659"><span class="hs-identifier">tidy_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766660"><a href="#local-6989586621684766660"><span class="hs-identifier">occ'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-174"></a><span>    </span><span class="hs-keyword">let</span><span>
</span><a name="line-175"></a><span>        </span><a name="local-6989586621684766661"><a href="#local-6989586621684766661"><span class="hs-identifier">ty'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="TyCoRep.html#tidyType"><span class="hs-identifier hs-var">tidyType</span></a><span> </span><a href="#local-6989586621684766654"><span class="hs-identifier hs-var">env</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idType"><span class="hs-identifier hs-var">idType</span></a><span> </span><a href="#local-6989586621684766657"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>        </span><a name="local-6989586621684766662"><a href="#local-6989586621684766662"><span class="hs-identifier">name'</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Name.html#mkInternalName"><span class="hs-identifier hs-var">mkInternalName</span></a><span> </span><span class="hs-special">(</span><a href="Id.html#idUnique"><span class="hs-identifier hs-var">idUnique</span></a><span> </span><a href="#local-6989586621684766657"><span class="hs-identifier hs-var">id</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766660"><span class="hs-identifier hs-var">occ'</span></a><span> </span><a href="SrcLoc.html#noSrcSpan"><span class="hs-identifier hs-var">noSrcSpan</span></a><span>
</span><a name="line-177"></a><span>        </span><a name="local-6989586621684766663"><a href="#local-6989586621684766663"><span class="hs-identifier">details</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idDetails"><span class="hs-identifier hs-var">idDetails</span></a><span> </span><a href="#local-6989586621684766657"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-178"></a><span>        </span><a name="local-6989586621684766664"><a href="#local-6989586621684766664"><span class="hs-identifier">id'</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#mkLocalVar"><span class="hs-identifier hs-var">mkLocalVar</span></a><span> </span><a href="#local-6989586621684766663"><span class="hs-identifier hs-var">details</span></a><span> </span><a href="#local-6989586621684766662"><span class="hs-identifier hs-var">name'</span></a><span> </span><a href="#local-6989586621684766661"><span class="hs-identifier hs-var">ty'</span></a><span> </span><a href="#local-6989586621684766667"><span class="hs-identifier hs-var">new_info</span></a><span>
</span><a name="line-179"></a><span>        </span><a name="local-6989586621684766665"><a href="#local-6989586621684766665"><span class="hs-identifier">var_env'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="VarEnv.html#extendVarEnv"><span class="hs-identifier hs-var">extendVarEnv</span></a><span> </span><a href="#local-6989586621684766656"><span class="hs-identifier hs-var">var_env</span></a><span> </span><a href="#local-6989586621684766657"><span class="hs-identifier hs-var">id</span></a><span> </span><a href="#local-6989586621684766664"><span class="hs-identifier hs-var">id'</span></a><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span>        </span><span class="hs-comment">-- Note [Tidy IdInfo]</span><span>
</span><a name="line-182"></a><span>        </span><span class="hs-comment">-- We need to keep around any interesting strictness and</span><span>
</span><a name="line-183"></a><span>        </span><span class="hs-comment">-- demand info because later on we may need to use it when</span><span>
</span><a name="line-184"></a><span>        </span><span class="hs-comment">-- converting to A-normal form.</span><span>
</span><a name="line-185"></a><span>        </span><span class="hs-comment">-- eg.</span><span>
</span><a name="line-186"></a><span>        </span><span class="hs-comment">--      f (g x),  where f is strict in its argument, will be converted</span><span>
</span><a name="line-187"></a><span>        </span><span class="hs-comment">--      into  case (g x) of z -&gt; f z  by CorePrep, but only if f still</span><span>
</span><a name="line-188"></a><span>        </span><span class="hs-comment">--      has its strictness info.</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-190"></a><span>        </span><span class="hs-comment">-- Similarly for the demand info - on a let binder, this tells</span><span>
</span><a name="line-191"></a><span>        </span><span class="hs-comment">-- CorePrep to turn the let into a case.</span><span>
</span><a name="line-192"></a><span>        </span><span class="hs-comment">-- But: Remove the usage demand here</span><span>
</span><a name="line-193"></a><span>        </span><span class="hs-comment">--      (See Note [Zapping DmdEnv after Demand Analyzer] in WorkWrap)</span><span>
</span><a name="line-194"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-195"></a><span>        </span><span class="hs-comment">-- Similarly arity info for eta expansion in CorePrep</span><span>
</span><a name="line-196"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-comment">-- Set inline-prag info so that we preseve it across</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-comment">-- separate compilation boundaries</span><span>
</span><a name="line-199"></a><span>        </span><a name="local-6989586621684766666"><a href="#local-6989586621684766666"><span class="hs-identifier">old_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Var.html#idInfo"><span class="hs-identifier hs-var">idInfo</span></a><span> </span><a href="#local-6989586621684766657"><span class="hs-identifier hs-var">id</span></a><span>
</span><a name="line-200"></a><span>        </span><a name="local-6989586621684766667"><a href="#local-6989586621684766667"><span class="hs-identifier">new_info</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#vanillaIdInfo"><span class="hs-identifier hs-var">vanillaIdInfo</span></a><span>
</span><a name="line-201"></a><span>                    </span><span class="hs-special">`</span><a href="IdInfo.html#setOccInfo"><span class="hs-identifier hs-var">setOccInfo</span></a><span class="hs-special">`</span><span>        </span><span class="hs-identifier">occInfo</span><span> </span><a href="#local-6989586621684766666"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-202"></a><span>                    </span><span class="hs-special">`</span><a href="IdInfo.html#setArityInfo"><span class="hs-identifier hs-var">setArityInfo</span></a><span class="hs-special">`</span><span>      </span><a href="CoreArity.html#exprArity"><span class="hs-identifier hs-var">exprArity</span></a><span> </span><a href="#local-6989586621684766658"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-203"></a><span>                    </span><span class="hs-special">`</span><a href="IdInfo.html#setStrictnessInfo"><span class="hs-identifier hs-var">setStrictnessInfo</span></a><span class="hs-special">`</span><span> </span><a href="Demand.html#zapUsageEnvSig"><span class="hs-identifier hs-var">zapUsageEnvSig</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">strictnessInfo</span><span> </span><a href="#local-6989586621684766666"><span class="hs-identifier hs-var">old_info</span></a><span class="hs-special">)</span><span>
</span><a name="line-204"></a><span>                    </span><span class="hs-special">`</span><a href="IdInfo.html#setDemandInfo"><span class="hs-identifier hs-var">setDemandInfo</span></a><span class="hs-special">`</span><span>     </span><span class="hs-identifier">demandInfo</span><span> </span><a href="#local-6989586621684766666"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-205"></a><span>                    </span><span class="hs-special">`</span><a href="IdInfo.html#setInlinePragInfo"><span class="hs-identifier hs-var">setInlinePragInfo</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">inlinePragInfo</span><span> </span><a href="#local-6989586621684766666"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-206"></a><span>                    </span><span class="hs-special">`</span><a href="IdInfo.html#setUnfoldingInfo"><span class="hs-identifier hs-var">setUnfoldingInfo</span></a><span class="hs-special">`</span><span>  </span><a href="#local-6989586621684766669"><span class="hs-identifier hs-var">new_unf</span></a><span>
</span><a name="line-207"></a><span>
</span><a name="line-208"></a><span>        </span><a name="local-6989586621684766668"><a href="#local-6989586621684766668"><span class="hs-identifier">old_unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">unfoldingInfo</span><span> </span><a href="#local-6989586621684766666"><span class="hs-identifier hs-var">old_info</span></a><span>
</span><a name="line-209"></a><span>        </span><a name="local-6989586621684766669"><a href="#local-6989586621684766669"><span class="hs-identifier">new_unf</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isStableUnfolding"><span class="hs-identifier hs-var">isStableUnfolding</span></a><span> </span><a href="#local-6989586621684766668"><span class="hs-identifier hs-var">old_unf</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyUnfolding"><span class="hs-identifier hs-var">tidyUnfolding</span></a><span> </span><a href="#local-6989586621684766653"><span class="hs-identifier hs-var">rec_tidy_env</span></a><span> </span><a href="#local-6989586621684766668"><span class="hs-identifier hs-var">old_unf</span></a><span> </span><a href="#local-6989586621684766668"><span class="hs-identifier hs-var">old_unf</span></a><span>
</span><a name="line-210"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><a href="IdInfo.html#zapUnfolding"><span class="hs-identifier hs-var">zapUnfolding</span></a><span> </span><a href="#local-6989586621684766668"><span class="hs-identifier hs-var">old_unf</span></a><span>
</span><a name="line-211"></a><span>                                              </span><span class="hs-comment">-- See Note [Preserve evaluatedness]</span><span>
</span><a name="line-212"></a><span>    </span><span class="hs-keyword">in</span><span>
</span><a name="line-213"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621684766659"><span class="hs-identifier hs-var">tidy_env'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621684766665"><span class="hs-identifier hs-var">var_env'</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621684766664"><span class="hs-identifier hs-var">id'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-214"></a><span>
</span><a name="line-215"></a><span class="hs-comment">------------ Unfolding  --------------</span><span>
</span><a name="line-216"></a><span class="hs-identifier">tidyUnfolding</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="VarEnv.html#TidyEnv"><span class="hs-identifier hs-type">TidyEnv</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="CoreSyn.html#Unfolding"><span class="hs-identifier hs-type">Unfolding</span></a><span>
</span><a name="line-217"></a><a name="tidyUnfolding"><a href="CoreTidy.html#tidyUnfolding"><span class="hs-identifier">tidyUnfolding</span></a></a><span> </span><a name="local-6989586621684766670"><a href="#local-6989586621684766670"><span class="hs-identifier">tidy_env</span></a></a><span> </span><a name="local-6989586621684766671"><a href="#local-6989586621684766671"><span class="hs-identifier">df</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#DFunUnfolding"><span class="hs-identifier hs-var">DFunUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766672"><a href="#local-6989586621684766672"><span class="hs-identifier">bndrs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766673"><a href="#local-6989586621684766673"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-218"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766671"><span class="hs-identifier hs-var">df</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">df_bndrs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766675"><span class="hs-identifier hs-var">bndrs'</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">df_args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766674"><span class="hs-identifier hs-var">tidy_env'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621684766673"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-219"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-220"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621684766674"><a href="#local-6989586621684766674"><span class="hs-identifier">tidy_env'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621684766675"><a href="#local-6989586621684766675"><span class="hs-identifier">bndrs'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyBndrs"><span class="hs-identifier hs-var">tidyBndrs</span></a><span> </span><a href="#local-6989586621684766670"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621684766672"><span class="hs-identifier hs-var">bndrs</span></a><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-identifier">tidyUnfolding</span><span> </span><a name="local-6989586621684766676"><a href="#local-6989586621684766676"><span class="hs-identifier">tidy_env</span></a></a><span>
</span><a name="line-223"></a><span>              </span><a name="local-6989586621684766677"><a href="#local-6989586621684766677"><span class="hs-identifier">unf</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="CoreSyn.html#CoreUnfolding"><span class="hs-identifier hs-var">CoreUnfolding</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766678"><a href="#local-6989586621684766678"><span class="hs-identifier">unf_rhs</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uf_src</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621684766679"><a href="#local-6989586621684766679"><span class="hs-identifier">src</span></a></a><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><a name="line-224"></a><span>              </span><a name="local-6989586621684766680"><a href="#local-6989586621684766680"><span class="hs-identifier">unf_from_rhs</span></a></a><span>
</span><a name="line-225"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="CoreSyn.html#isStableSource"><span class="hs-identifier hs-var">isStableSource</span></a><span> </span><a href="#local-6989586621684766679"><span class="hs-identifier hs-var">src</span></a><span>
</span><a name="line-226"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766681"><span class="hs-identifier hs-var">seqIt</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621684766677"><span class="hs-identifier hs-var">unf</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uf_tmpl</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreTidy.html#tidyExpr"><span class="hs-identifier hs-var">tidyExpr</span></a><span> </span><a href="#local-6989586621684766676"><span class="hs-identifier hs-var">tidy_env</span></a><span> </span><a href="#local-6989586621684766678"><span class="hs-identifier hs-var">unf_rhs</span></a><span> </span><span class="hs-special">}</span><span>    </span><span class="hs-comment">-- Preserves OccInfo</span><span>
</span><a name="line-227"></a><span>    </span><span class="hs-comment">-- This seqIt avoids a space leak: otherwise the uf_is_value,</span><span>
</span><a name="line-228"></a><span>    </span><span class="hs-comment">-- uf_is_conlike, ... fields may retain a reference to the</span><span>
</span><a name="line-229"></a><span>    </span><span class="hs-comment">-- pre-tidied expression forever (ToIface doesn't look at them)</span><span>
</span><a name="line-230"></a><span>
</span><a name="line-231"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-232"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766680"><span class="hs-identifier hs-var">unf_from_rhs</span></a><span>
</span><a name="line-233"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621684766681"><a href="#local-6989586621684766681"><span class="hs-identifier">seqIt</span></a></a><span> </span><a name="local-6989586621684766682"><a href="#local-6989586621684766682"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="CoreSeq.html#seqUnfolding"><span class="hs-identifier hs-var">seqUnfolding</span></a><span> </span><a href="#local-6989586621684766682"><span class="hs-identifier hs-var">unf</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684766682"><span class="hs-identifier hs-var">unf</span></a><span>
</span><a name="line-234"></a><span class="hs-identifier">tidyUnfolding</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621684766683"><a href="#local-6989586621684766683"><span class="hs-identifier">unf</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766683"><span class="hs-identifier hs-var">unf</span></a><span>     </span><span class="hs-comment">-- NoUnfolding or OtherCon</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">{-
Note [Tidy IdInfo]
~~~~~~~~~~~~~~~~~~
All nested Ids now have the same IdInfo, namely vanillaIdInfo, which
should save some space; except that we preserve occurrence info for
two reasons:

  (a) To make printing tidy core nicer

  (b) Because we tidy RULES and InlineRules, which may then propagate
      via --make into the compilation of the next module, and we want
      the benefit of that occurrence analysis when we use the rule or
      or inline the function.  In particular, it's vital not to lose
      loop-breaker info, else we get an infinite inlining loop

Note that tidyLetBndr puts more IdInfo back.

Note [Preserve evaluatedness]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider
  data T = MkT !Bool
  ....(case v of MkT y -&gt;
       let z# = case y of
                  True -&gt; 1#
                  False -&gt; 2#
       in ...)

The z# binding is ok because the RHS is ok-for-speculation,
but Lint will complain unless it can *see* that.  So we
preserve the evaluated-ness on 'y' in tidyBndr.

(Another alternative would be to tidy unboxed lets into cases,
but that seems more indirect and surprising.)

Note [Preserve OneShotInfo]
~~~~~~~~~~~~~~~~~~~~~~~~~~~
We keep the OneShotInfo because we want it to propagate into the interface.
Not all OneShotInfo is determined by a compiler analysis; some is added by a
call of GHC.Exts.oneShot, which is then discarded before the end of the
optimisation pipeline, leaving only the OneShotInfo on the lambda. Hence we
must preserve this info in inlinings. See Note [The oneShot function] in MkId.

This applies to lambda binders only, hence it is stored in IfaceLamBndr.
-}</span><span>
</span><a name="line-280"></a><span>
</span><a name="line-281"></a><span class="hs-special">(</span><span class="hs-operator">=:</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621684766559"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621684766559"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684766560"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621684766560"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-282"></a><a name="local-6989586621684766684"><a href="#local-6989586621684766684"><span class="hs-identifier">m</span></a></a><span> </span><a name="%3D%3A"><a href="CoreTidy.html#%3D%3A"><span class="hs-operator">=:</span></a></a><span> </span><a name="local-6989586621684766685"><a href="#local-6989586621684766685"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621684766684"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">seq</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621684766685"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621684766684"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-283"></a></pre></body></html>