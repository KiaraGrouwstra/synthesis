<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">FileCleanup</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="FileCleanup.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#cleanTempDirs"><span class="hs-identifier hs-var">cleanTempDirs</span></a><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#cleanTempFiles"><span class="hs-identifier hs-var">cleanTempFiles</span></a><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#cleanCurrentModuleTempFiles"><span class="hs-identifier hs-var">cleanCurrentModuleTempFiles</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#changeTempFilesLifetime"><span class="hs-identifier hs-var">changeTempFilesLifetime</span></a><span>
</span><a name="line-6"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#newTempName"><span class="hs-identifier hs-var">newTempName</span></a><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#newTempLibName"><span class="hs-identifier hs-var">newTempLibName</span></a><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#newTempDir"><span class="hs-identifier hs-var">newTempDir</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#withSystemTempDirectory"><span class="hs-identifier hs-var">withSystemTempDirectory</span></a><span class="hs-special">,</span><span> </span><a href="FileCleanup.html#withTempDirectory"><span class="hs-identifier hs-var">withTempDirectory</span></a><span>
</span><a name="line-8"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-9"></a><span>
</span><a name="line-10"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-11"></a><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><a href="Exception.html"><span class="hs-identifier">Exception</span></a><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><a href="DriverPhases.html"><span class="hs-identifier">DriverPhases</span></a><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.IORef</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.IO.Error</span><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-cpp">#if !defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.Posix.Internals</span><span>
</span><a name="line-30"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-32"></a><span class="hs-comment">-- | Used when a temp file is created. This determines which component Set of</span><span>
</span><a name="line-33"></a><span class="hs-comment">-- FilesToClean will get the temp file</span><span>
</span><a name="line-34"></a><span class="hs-keyword">data</span><span> </span><a name="TempFileLifetime"><a href="FileCleanup.html#TempFileLifetime"><span class="hs-identifier">TempFileLifetime</span></a></a><span>
</span><a name="line-35"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="TFL_CurrentModule"><a href="FileCleanup.html#TFL_CurrentModule"><span class="hs-identifier">TFL_CurrentModule</span></a></a><span>
</span><a name="line-36"></a><span>  </span><span class="hs-comment">-- ^ A file with lifetime TFL_CurrentModule will be cleaned up at the</span><span>
</span><a name="line-37"></a><span>  </span><span class="hs-comment">-- end of upweep_mod</span><span>
</span><a name="line-38"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="TFL_GhcSession"><a href="FileCleanup.html#TFL_GhcSession"><span class="hs-identifier">TFL_GhcSession</span></a></a><span>
</span><a name="line-39"></a><span>  </span><span class="hs-comment">-- ^ A file with lifetime TFL_GhcSession will be cleaned up at the end of</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-comment">-- runGhc(T)</span><span>
</span><a name="line-41"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-identifier">cleanTempDirs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><a name="cleanTempDirs"><a href="FileCleanup.html#cleanTempDirs"><span class="hs-identifier">cleanTempDirs</span></a></a><span> </span><a name="local-6989586621681279189"><a href="#local-6989586621681279189"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-45"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_KeepTmpFiles"><span class="hs-identifier hs-var">Opt_KeepTmpFiles</span></a><span> </span><a href="#local-6989586621681279189"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mask_</span><span>
</span><a name="line-47"></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279190"><a href="#local-6989586621681279190"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dirsToClean</span><span> </span><a href="#local-6989586621681279189"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-48"></a><span>        </span><a name="local-6989586621681279192"><a href="#local-6989586621681279192"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621681279190"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681279191"><a href="#local-6989586621681279191"><span class="hs-identifier">ds</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681279191"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>        </span><a href="FileCleanup.html#removeTmpDirs"><span class="hs-identifier hs-var">removeTmpDirs</span></a><span> </span><a href="#local-6989586621681279189"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681279192"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- | Delete all files in @filesToClean dflags@.</span><span>
</span><a name="line-52"></a><span class="hs-identifier">cleanTempFiles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-53"></a><a name="cleanTempFiles"><a href="FileCleanup.html#cleanTempFiles"><span class="hs-identifier">cleanTempFiles</span></a></a><span> </span><a name="local-6989586621681279193"><a href="#local-6989586621681279193"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-54"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_KeepTmpFiles"><span class="hs-identifier hs-var">Opt_KeepTmpFiles</span></a><span> </span><a href="#local-6989586621681279193"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mask_</span><span>
</span><a name="line-56"></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279194"><a href="#local-6989586621681279194"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621681279193"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-57"></a><span>        </span><a name="local-6989586621681279197"><a href="#local-6989586621681279197"><span class="hs-identifier">to_delete</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621681279194"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-58"></a><span>            </span><span class="hs-glyph">\</span><a href="DynFlags.html#FilesToClean"><span class="hs-identifier hs-var">FilesToClean</span></a><span>
</span><a name="line-59"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279195"><a href="#local-6989586621681279195"><span class="hs-identifier">cm_files</span></a></a><span>
</span><a name="line-60"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ftcGhcSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279196"><a href="#local-6989586621681279196"><span class="hs-identifier">gs_files</span></a></a><span>
</span><a name="line-61"></a><span>                </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span> </span><a href="DynFlags.html#emptyFilesToClean"><span class="hs-identifier hs-var">emptyFilesToClean</span></a><span>
</span><a name="line-62"></a><span>                     </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621681279195"><span class="hs-identifier hs-var">cm_files</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621681279196"><span class="hs-identifier hs-var">gs_files</span></a><span class="hs-special">)</span><span>
</span><a name="line-63"></a><span>        </span><a href="FileCleanup.html#removeTmpFiles"><span class="hs-identifier hs-var">removeTmpFiles</span></a><span> </span><a href="#local-6989586621681279193"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681279197"><span class="hs-identifier hs-var">to_delete</span></a><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | Delete all files in @filesToClean dflags@. That have lifetime</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- TFL_CurrentModule.</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- If a file must be cleaned eventually, but must survive a</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- cleanCurrentModuleTempFiles, ensure it has lifetime TFL_GhcSession.</span><span>
</span><a name="line-69"></a><span class="hs-identifier">cleanCurrentModuleTempFiles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-70"></a><a name="cleanCurrentModuleTempFiles"><a href="FileCleanup.html#cleanCurrentModuleTempFiles"><span class="hs-identifier">cleanCurrentModuleTempFiles</span></a></a><span> </span><a name="local-6989586621681279198"><a href="#local-6989586621681279198"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-71"></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_KeepTmpFiles"><span class="hs-identifier hs-var">Opt_KeepTmpFiles</span></a><span> </span><a href="#local-6989586621681279198"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-72"></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mask_</span><span>
</span><a name="line-73"></a><span>   </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279199"><a href="#local-6989586621681279199"><span class="hs-identifier">ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621681279198"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-74"></a><span>        </span><a name="local-6989586621681279202"><a href="#local-6989586621681279202"><span class="hs-identifier">to_delete</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621681279199"><span class="hs-identifier hs-var">ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-75"></a><span>            </span><span class="hs-glyph">\</span><a name="local-6989586621681279200"><a href="#local-6989586621681279200"><span class="hs-identifier">ftc</span></a></a><span class="hs-glyph">@</span><a href="DynFlags.html#FilesToClean"><span class="hs-identifier hs-var">FilesToClean</span></a><span class="hs-special">{</span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279201"><a href="#local-6989586621681279201"><span class="hs-identifier">cm_files</span></a></a><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-76"></a><span>                </span><span class="hs-special">(</span><a href="#local-6989586621681279200"><span class="hs-identifier hs-var">ftc</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.empty</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621681279201"><span class="hs-identifier hs-var">cm_files</span></a><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>        </span><a href="FileCleanup.html#removeTmpFiles"><span class="hs-identifier hs-var">removeTmpFiles</span></a><span> </span><a href="#local-6989586621681279198"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681279202"><span class="hs-identifier hs-var">to_delete</span></a><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span class="hs-comment">-- | Ensure that new_files are cleaned on the next call of</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- 'cleanTempFiles' or 'cleanCurrentModuleTempFiles', depending on lifetime.</span><span>
</span><a name="line-81"></a><span class="hs-comment">-- If any of new_files are already tracked, they will have their lifetime</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- updated.</span><span>
</span><a name="line-83"></a><span class="hs-identifier">addFilesToClean</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FileCleanup.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><a name="addFilesToClean"><a href="FileCleanup.html#addFilesToClean"><span class="hs-identifier">addFilesToClean</span></a></a><span> </span><a name="local-6989586621681279203"><a href="#local-6989586621681279203"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279204"><a href="#local-6989586621681279204"><span class="hs-identifier">lifetime</span></a></a><span> </span><a name="local-6989586621681279205"><a href="#local-6989586621681279205"><span class="hs-identifier">new_files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">modifyIORef'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621681279203"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">\</span><a href="DynFlags.html#FilesToClean"><span class="hs-identifier hs-var">FilesToClean</span></a><span>
</span><a name="line-86"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279207"><a href="#local-6989586621681279207"><span class="hs-identifier">cm_files</span></a></a><span>
</span><a name="line-87"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ftcGhcSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279208"><a href="#local-6989586621681279208"><span class="hs-identifier">gs_files</span></a></a><span>
</span><a name="line-88"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681279204"><span class="hs-identifier hs-var">lifetime</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-89"></a><span>      </span><a href="FileCleanup.html#TFL_CurrentModule"><span class="hs-identifier hs-var">TFL_CurrentModule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#FilesToClean"><span class="hs-identifier hs-var">FilesToClean</span></a><span>
</span><a name="line-90"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279207"><span class="hs-identifier hs-var">cm_files</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681279206"><span class="hs-identifier hs-var">new_files_set</span></a><span>
</span><a name="line-91"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ftcGhcSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279208"><span class="hs-identifier hs-var">gs_files</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681279206"><span class="hs-identifier hs-var">new_files_set</span></a><span>
</span><a name="line-92"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-93"></a><span>      </span><a href="FileCleanup.html#TFL_GhcSession"><span class="hs-identifier hs-var">TFL_GhcSession</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#FilesToClean"><span class="hs-identifier hs-var">FilesToClean</span></a><span>
</span><a name="line-94"></a><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279207"><span class="hs-identifier hs-var">cm_files</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.difference</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681279206"><span class="hs-identifier hs-var">new_files_set</span></a><span>
</span><a name="line-95"></a><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ftcGhcSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279208"><span class="hs-identifier hs-var">gs_files</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681279206"><span class="hs-identifier hs-var">new_files_set</span></a><span>
</span><a name="line-96"></a><span>        </span><span class="hs-special">}</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-98"></a><span>    </span><a name="local-6989586621681279206"><a href="#local-6989586621681279206"><span class="hs-identifier">new_files_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.fromList</span><span> </span><a href="#local-6989586621681279205"><span class="hs-identifier hs-var">new_files</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- | Update the lifetime of files already being tracked. If any files are</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- not being tracked they will be discarded.</span><span>
</span><a name="line-102"></a><span class="hs-identifier">changeTempFilesLifetime</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FileCleanup.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-103"></a><a name="changeTempFilesLifetime"><a href="FileCleanup.html#changeTempFilesLifetime"><span class="hs-identifier">changeTempFilesLifetime</span></a></a><span> </span><a name="local-6989586621681279209"><a href="#local-6989586621681279209"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279210"><a href="#local-6989586621681279210"><span class="hs-identifier">lifetime</span></a></a><span> </span><a name="local-6989586621681279211"><a href="#local-6989586621681279211"><span class="hs-identifier">files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>  </span><a href="DynFlags.html#FilesToClean"><span class="hs-identifier hs-var">FilesToClean</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">ftcCurrentModule</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279212"><a href="#local-6989586621681279212"><span class="hs-identifier">cm_files</span></a></a><span>
</span><a name="line-106"></a><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ftcGhcSession</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681279213"><a href="#local-6989586621681279213"><span class="hs-identifier">gs_files</span></a></a><span>
</span><a name="line-107"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">filesToClean</span><span> </span><a href="#local-6989586621681279209"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-108"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279214"><a href="#local-6989586621681279214"><span class="hs-identifier">old_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681279210"><span class="hs-identifier hs-var">lifetime</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-109"></a><span>        </span><a href="FileCleanup.html#TFL_CurrentModule"><span class="hs-identifier hs-var">TFL_CurrentModule</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681279213"><span class="hs-identifier hs-var">gs_files</span></a><span>
</span><a name="line-110"></a><span>        </span><a href="FileCleanup.html#TFL_GhcSession"><span class="hs-identifier hs-var">TFL_GhcSession</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681279212"><span class="hs-identifier hs-var">cm_files</span></a><span>
</span><a name="line-111"></a><span>      </span><a name="local-6989586621681279215"><a href="#local-6989586621681279215"><span class="hs-identifier">existing_files</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681279216"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681279216"><a href="#local-6989586621681279216"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681279211"><span class="hs-identifier hs-var">files</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681279216"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Set.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681279214"><span class="hs-identifier hs-var">old_set</span></a><span class="hs-special">]</span><span>
</span><a name="line-112"></a><span>  </span><a href="FileCleanup.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a><span> </span><a href="#local-6989586621681279209"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681279210"><span class="hs-identifier hs-var">lifetime</span></a><span> </span><a href="#local-6989586621681279215"><span class="hs-identifier hs-var">existing_files</span></a><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span class="hs-comment">-- Return a unique numeric temp file suffix</span><span>
</span><a name="line-115"></a><span class="hs-identifier">newTempSuffix</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-116"></a><a name="newTempSuffix"><a href="FileCleanup.html#newTempSuffix"><span class="hs-identifier">newTempSuffix</span></a></a><span> </span><a name="local-6989586621681279217"><a href="#local-6989586621681279217"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-117"></a><span>  </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">nextTempSuffix</span><span> </span><a href="#local-6989586621681279217"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681279218"><a href="#local-6989586621681279218"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279218"><span class="hs-identifier hs-var">n</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">,</span><a href="#local-6989586621681279218"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- Find a temporary name that doesn't already exist.</span><span>
</span><a name="line-120"></a><span class="hs-identifier">newTempName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FileCleanup.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Util.html#Suffix"><span class="hs-identifier hs-type">Suffix</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-121"></a><a name="newTempName"><a href="FileCleanup.html#newTempName"><span class="hs-identifier">newTempName</span></a></a><span> </span><a name="local-6989586621681279219"><a href="#local-6989586621681279219"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279220"><a href="#local-6989586621681279220"><span class="hs-identifier">lifetime</span></a></a><span> </span><a name="local-6989586621681279221"><a href="#local-6989586621681279221"><span class="hs-identifier">extn</span></a></a><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681279227"><a href="#local-6989586621681279227"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#getTempDir"><span class="hs-identifier hs-var">getTempDir</span></a><span> </span><a href="#local-6989586621681279219"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-123"></a><span>       </span><a href="#local-6989586621681279222"><span class="hs-identifier hs-var">findTempName</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279227"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;ghc_&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- See Note [Deterministic base name]</span><span>
</span><a name="line-124"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-identifier">findTempName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-126"></a><span>    </span><a name="local-6989586621681279222"><a href="#local-6989586621681279222"><span class="hs-identifier">findTempName</span></a></a><span> </span><a name="local-6989586621681279223"><a href="#local-6989586621681279223"><span class="hs-identifier">prefix</span></a></a><span>
</span><a name="line-127"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681279224"><a href="#local-6989586621681279224"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a><span> </span><a href="#local-6989586621681279219"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-128"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279225"><a href="#local-6989586621681279225"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279223"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279224"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621681279221"><span class="hs-identifier hs-var">extn</span></a><span>
</span><a name="line-129"></a><span>           </span><a name="local-6989586621681279226"><a href="#local-6989586621681279226"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621681279225"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-130"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681279226"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681279222"><span class="hs-identifier hs-var">findTempName</span></a><span> </span><a href="#local-6989586621681279223"><span class="hs-identifier hs-var">prefix</span></a><span>
</span><a name="line-131"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- clean it up later</span><span>
</span><a name="line-132"></a><span>                        </span><a href="FileCleanup.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a><span> </span><a href="#local-6989586621681279219"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681279220"><span class="hs-identifier hs-var">lifetime</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681279225"><span class="hs-identifier hs-var">filename</span></a><span class="hs-special">]</span><span>
</span><a name="line-133"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681279225"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-134"></a><span>
</span><a name="line-135"></a><span class="hs-identifier">newTempDir</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-136"></a><a name="newTempDir"><a href="FileCleanup.html#newTempDir"><span class="hs-identifier">newTempDir</span></a></a><span> </span><a name="local-6989586621681279228"><a href="#local-6989586621681279228"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681279234"><a href="#local-6989586621681279234"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#getTempDir"><span class="hs-identifier hs-var">getTempDir</span></a><span> </span><a href="#local-6989586621681279228"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-138"></a><span>       </span><a href="#local-6989586621681279229"><span class="hs-identifier hs-var">findTempDir</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279234"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;ghc_&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-139"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-140"></a><span>    </span><span class="hs-identifier">findTempDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-141"></a><span>    </span><a name="local-6989586621681279229"><a href="#local-6989586621681279229"><span class="hs-identifier">findTempDir</span></a></a><span> </span><a name="local-6989586621681279230"><a href="#local-6989586621681279230"><span class="hs-identifier">prefix</span></a></a><span>
</span><a name="line-142"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681279231"><a href="#local-6989586621681279231"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a><span> </span><a href="#local-6989586621681279228"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-143"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279232"><a href="#local-6989586621681279232"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279230"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279231"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-144"></a><span>           </span><a name="local-6989586621681279233"><a href="#local-6989586621681279233"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621681279232"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-145"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681279233"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681279229"><span class="hs-identifier hs-var">findTempDir</span></a><span> </span><a href="#local-6989586621681279230"><span class="hs-identifier hs-var">prefix</span></a><span>
</span><a name="line-146"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier hs-var">createDirectory</span><span> </span><a href="#local-6989586621681279232"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-147"></a><span>                        </span><span class="hs-comment">-- see mkTempDir below; this is wrong: -&gt; consIORef (dirsToClean dflags) filename</span><span>
</span><a name="line-148"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681279232"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">newTempLibName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FileCleanup.html#TempFileLifetime"><span class="hs-identifier hs-type">TempFileLifetime</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Util.html#Suffix"><span class="hs-identifier hs-type">Suffix</span></a><span>
</span><a name="line-151"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-152"></a><a name="newTempLibName"><a href="FileCleanup.html#newTempLibName"><span class="hs-identifier">newTempLibName</span></a></a><span> </span><a name="local-6989586621681279235"><a href="#local-6989586621681279235"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279236"><a href="#local-6989586621681279236"><span class="hs-identifier">lifetime</span></a></a><span> </span><a name="local-6989586621681279237"><a href="#local-6989586621681279237"><span class="hs-identifier">extn</span></a></a><span>
</span><a name="line-153"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681279245"><a href="#local-6989586621681279245"><span class="hs-identifier">d</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#getTempDir"><span class="hs-identifier hs-var">getTempDir</span></a><span> </span><a href="#local-6989586621681279235"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-154"></a><span>       </span><a href="#local-6989586621681279238"><span class="hs-identifier hs-var">findTempName</span></a><span> </span><a href="#local-6989586621681279245"><span class="hs-identifier hs-var">d</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;ghc_&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-156"></a><span>    </span><span class="hs-identifier">findTempName</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span>    </span><a name="local-6989586621681279238"><a href="#local-6989586621681279238"><span class="hs-identifier">findTempName</span></a></a><span> </span><a name="local-6989586621681279239"><a href="#local-6989586621681279239"><span class="hs-identifier">dir</span></a></a><span> </span><a name="local-6989586621681279240"><a href="#local-6989586621681279240"><span class="hs-identifier">prefix</span></a></a><span>
</span><a name="line-158"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><a name="local-6989586621681279241"><a href="#local-6989586621681279241"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a><span> </span><a href="#local-6989586621681279235"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-comment">-- See Note [Deterministic base name]</span><span>
</span><a name="line-159"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279242"><a href="#local-6989586621681279242"><span class="hs-identifier">libname</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279240"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279241"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-160"></a><span>               </span><a name="local-6989586621681279243"><a href="#local-6989586621681279243"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279239"><span class="hs-identifier hs-var">dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681279242"><span class="hs-identifier hs-var">libname</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><a href="#local-6989586621681279237"><span class="hs-identifier hs-var">extn</span></a><span>
</span><a name="line-161"></a><span>           </span><a name="local-6989586621681279244"><a href="#local-6989586621681279244"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621681279243"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-162"></a><span>           </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681279244"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681279238"><span class="hs-identifier hs-var">findTempName</span></a><span> </span><a href="#local-6989586621681279239"><span class="hs-identifier hs-var">dir</span></a><span> </span><a href="#local-6989586621681279240"><span class="hs-identifier hs-var">prefix</span></a><span>
</span><a name="line-163"></a><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- clean it up later</span><span>
</span><a name="line-164"></a><span>                        </span><a href="FileCleanup.html#addFilesToClean"><span class="hs-identifier hs-var">addFilesToClean</span></a><span> </span><a href="#local-6989586621681279235"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681279236"><span class="hs-identifier hs-var">lifetime</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681279243"><span class="hs-identifier hs-var">filename</span></a><span class="hs-special">]</span><span>
</span><a name="line-165"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279243"><span class="hs-identifier hs-var">filename</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681279239"><span class="hs-identifier hs-var">dir</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681279242"><span class="hs-identifier hs-var">libname</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- Return our temporary directory within tmp_dir, creating one if we</span><span>
</span><a name="line-169"></a><span class="hs-comment">-- don't have one yet.</span><span>
</span><a name="line-170"></a><span class="hs-identifier">getTempDir</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-171"></a><a name="getTempDir"><a href="FileCleanup.html#getTempDir"><span class="hs-identifier">getTempDir</span></a></a><span> </span><a name="local-6989586621681279246"><a href="#local-6989586621681279246"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-172"></a><span>    </span><a name="local-6989586621681279258"><a href="#local-6989586621681279258"><span class="hs-identifier">mapping</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621681279248"><span class="hs-identifier hs-var">dir_ref</span></a><span>
</span><a name="line-173"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681279247"><span class="hs-identifier hs-var">tmp_dir</span></a><span> </span><a href="#local-6989586621681279258"><span class="hs-identifier hs-var">mapping</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-174"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-175"></a><span>            </span><a name="local-6989586621681279259"><a href="#local-6989586621681279259"><span class="hs-identifier">pid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#getProcessID"><span class="hs-identifier hs-var">getProcessID</span></a><span>
</span><a name="line-176"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279260"><a href="#local-6989586621681279260"><span class="hs-identifier">prefix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279247"><span class="hs-identifier hs-var">tmp_dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;ghc&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279259"><span class="hs-identifier hs-var">pid</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_&quot;</span><span>
</span><a name="line-177"></a><span>            </span><span class="hs-identifier hs-var">mask_</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681279249"><span class="hs-identifier hs-var">mkTempDir</span></a><span> </span><a href="#local-6989586621681279260"><span class="hs-identifier hs-var">prefix</span></a><span>
</span><a name="line-178"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681279261"><a href="#local-6989586621681279261"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681279261"><span class="hs-identifier hs-var">dir</span></a><span>
</span><a name="line-179"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-180"></a><span>    </span><a name="local-6989586621681279247"><a href="#local-6989586621681279247"><span class="hs-identifier">tmp_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#tmpDir"><span class="hs-identifier hs-var">tmpDir</span></a><span> </span><a href="#local-6989586621681279246"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-181"></a><span>    </span><a name="local-6989586621681279248"><a href="#local-6989586621681279248"><span class="hs-identifier">dir_ref</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">dirsToClean</span><span> </span><a href="#local-6989586621681279246"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">mkTempDir</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-184"></a><span>    </span><a name="local-6989586621681279249"><a href="#local-6989586621681279249"><span class="hs-identifier">mkTempDir</span></a></a><span> </span><a name="local-6989586621681279250"><a href="#local-6989586621681279250"><span class="hs-identifier">prefix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>        </span><a name="local-6989586621681279251"><a href="#local-6989586621681279251"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#newTempSuffix"><span class="hs-identifier hs-var">newTempSuffix</span></a><span> </span><a href="#local-6989586621681279246"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-186"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279252"><a href="#local-6989586621681279252"><span class="hs-identifier">our_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279250"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279251"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-187"></a><span>
</span><a name="line-188"></a><span>        </span><span class="hs-comment">-- 1. Speculatively create our new directory.</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-identifier hs-var">createDirectory</span><span> </span><a href="#local-6989586621681279252"><span class="hs-identifier hs-var">our_dir</span></a><span>
</span><a name="line-190"></a><span>
</span><a name="line-191"></a><span>        </span><span class="hs-comment">-- 2. Update the dirsToClean mapping unless an entry already exists</span><span>
</span><a name="line-192"></a><span>        </span><span class="hs-comment">-- (i.e. unless another thread beat us to it).</span><span>
</span><a name="line-193"></a><span>        </span><a name="local-6989586621681279255"><a href="#local-6989586621681279255"><span class="hs-identifier">their_dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621681279248"><span class="hs-identifier hs-var">dir_ref</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681279253"><a href="#local-6989586621681279253"><span class="hs-identifier">mapping</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-194"></a><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681279247"><span class="hs-identifier hs-var">tmp_dir</span></a><span> </span><a href="#local-6989586621681279253"><span class="hs-identifier hs-var">mapping</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-195"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681279254"><a href="#local-6989586621681279254"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279253"><span class="hs-identifier hs-var">mapping</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681279254"><span class="hs-identifier hs-var">dir</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.insert</span><span> </span><a href="#local-6989586621681279247"><span class="hs-identifier hs-var">tmp_dir</span></a><span> </span><a href="#local-6989586621681279252"><span class="hs-identifier hs-var">our_dir</span></a><span> </span><a href="#local-6989586621681279253"><span class="hs-identifier hs-var">mapping</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span>        </span><span class="hs-comment">-- 3. If there was an existing entry, return it and delete the</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-comment">-- directory we created.  Otherwise return the directory we created.</span><span>
</span><a name="line-200"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681279255"><span class="hs-identifier hs-var">their_dir</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-201"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>                </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681279246"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-203"></a><span>                    </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Created temporary directory:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681279252"><span class="hs-identifier hs-var">our_dir</span></a><span>
</span><a name="line-204"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681279252"><span class="hs-identifier hs-var">our_dir</span></a><span>
</span><a name="line-205"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681279256"><a href="#local-6989586621681279256"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-206"></a><span>                </span><span class="hs-identifier hs-var">removeDirectory</span><span> </span><a href="#local-6989586621681279252"><span class="hs-identifier hs-var">our_dir</span></a><span>
</span><a name="line-207"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681279256"><span class="hs-identifier hs-var">dir</span></a><span>
</span><a name="line-208"></a><span>      </span><span class="hs-special">`</span><a href="Exception.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681279257"><a href="#local-6989586621681279257"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isAlreadyExistsError</span><span> </span><a href="#local-6989586621681279257"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-209"></a><span>                      </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681279249"><span class="hs-identifier hs-var">mkTempDir</span></a><span> </span><a href="#local-6989586621681279250"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><a href="#local-6989586621681279257"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-210"></a><span>
</span><a name="line-211"></a><span class="hs-comment">{- Note [Deterministic base name]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The filename of temporary files, especially the basename of C files, can end
up in the output in some form, e.g. as part of linker debug information. In the
interest of bit-wise exactly reproducible compilation (#4012), the basename of
the temporary file no longer contains random information (it used to contain
the process id).

This is ok, as the temporary directory used contains the pid (see getTempDir).
-}</span><span>
</span><a name="line-222"></a><span class="hs-identifier">removeTmpDirs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-223"></a><a name="removeTmpDirs"><a href="FileCleanup.html#removeTmpDirs"><span class="hs-identifier">removeTmpDirs</span></a></a><span> </span><a name="local-6989586621681279262"><a href="#local-6989586621681279262"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279263"><a href="#local-6989586621681279263"><span class="hs-identifier">ds</span></a></a><span>
</span><a name="line-224"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="ErrUtils.html#traceCmd"><span class="hs-identifier hs-var">traceCmd</span></a><span> </span><a href="#local-6989586621681279262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Deleting temp dirs&quot;</span><span>
</span><a name="line-225"></a><span>             </span><span class="hs-special">(</span><span class="hs-string">&quot;Deleting: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unwords</span><span> </span><a href="#local-6989586621681279263"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-226"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="FileCleanup.html#removeWith"><span class="hs-identifier hs-var">removeWith</span></a><span> </span><a href="#local-6989586621681279262"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">removeDirectory</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681279263"><span class="hs-identifier hs-var">ds</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-identifier">removeTmpFiles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><a name="removeTmpFiles"><a href="FileCleanup.html#removeTmpFiles"><span class="hs-identifier">removeTmpFiles</span></a></a><span> </span><a name="local-6989586621681279264"><a href="#local-6989586621681279264"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279265"><a href="#local-6989586621681279265"><span class="hs-identifier">fs</span></a></a><span>
</span><a name="line-230"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279266"><span class="hs-identifier hs-var">warnNon</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-231"></a><span>    </span><a href="ErrUtils.html#traceCmd"><span class="hs-identifier hs-var">traceCmd</span></a><span> </span><a href="#local-6989586621681279264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-string">&quot;Deleting temp files&quot;</span><span>
</span><a name="line-232"></a><span>             </span><span class="hs-special">(</span><span class="hs-string">&quot;Deleting: &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">unwords</span><span> </span><a href="#local-6989586621681279268"><span class="hs-identifier hs-var">deletees</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapM_</span><span> </span><span class="hs-special">(</span><a href="FileCleanup.html#removeWith"><span class="hs-identifier hs-var">removeWith</span></a><span> </span><a href="#local-6989586621681279264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-identifier hs-var">removeFile</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681279268"><span class="hs-identifier hs-var">deletees</span></a><span class="hs-special">)</span><span>
</span><a name="line-234"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-235"></a><span>     </span><span class="hs-comment">-- Flat out refuse to delete files that are likely to be source input</span><span>
</span><a name="line-236"></a><span>     </span><span class="hs-comment">-- files (is there a worse bug than having a compiler delete your source</span><span>
</span><a name="line-237"></a><span>     </span><span class="hs-comment">-- files?)</span><span>
</span><a name="line-238"></a><span>     </span><span class="hs-comment">--</span><span>
</span><a name="line-239"></a><span>     </span><span class="hs-comment">-- Deleting source files is a sign of a bug elsewhere, so prominently flag</span><span>
</span><a name="line-240"></a><span>     </span><span class="hs-comment">-- the condition.</span><span>
</span><a name="line-241"></a><span>    </span><a name="local-6989586621681279266"><a href="#local-6989586621681279266"><span class="hs-identifier">warnNon</span></a></a><span> </span><a name="local-6989586621681279269"><a href="#local-6989586621681279269"><span class="hs-identifier">act</span></a></a><span>
</span><a name="line-242"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681279267"><span class="hs-identifier hs-var">non_deletees</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279269"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-243"></a><span>     </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-244"></a><span>        </span><a href="ErrUtils.html#putMsg"><span class="hs-identifier hs-var">putMsg</span></a><span> </span><a href="#local-6989586621681279264"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;WARNING - NOT deleting source files:&quot;</span><span>
</span><a name="line-245"></a><span>                       </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681279267"><span class="hs-identifier hs-var">non_deletees</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>        </span><a href="#local-6989586621681279269"><span class="hs-identifier hs-var">act</span></a><span>
</span><a name="line-247"></a><span>
</span><a name="line-248"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681279267"><a href="#local-6989586621681279267"><span class="hs-identifier">non_deletees</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681279268"><a href="#local-6989586621681279268"><span class="hs-identifier">deletees</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="DriverPhases.html#isHaskellUserSrcFilename"><span class="hs-identifier hs-var">isHaskellUserSrcFilename</span></a><span> </span><a href="#local-6989586621681279265"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-identifier">removeWith</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-251"></a><a name="removeWith"><a href="FileCleanup.html#removeWith"><span class="hs-identifier">removeWith</span></a></a><span> </span><a name="local-6989586621681279270"><a href="#local-6989586621681279270"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681279271"><a href="#local-6989586621681279271"><span class="hs-identifier">remover</span></a></a><span> </span><a name="local-6989586621681279272"><a href="#local-6989586621681279272"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279271"><span class="hs-identifier hs-var">remover</span></a><span> </span><a href="#local-6989586621681279272"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">`</span><a href="Exception.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span class="hs-special">`</span><span>
</span><a name="line-252"></a><span>  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681279273"><a href="#local-6989586621681279273"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-253"></a><span>   </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279274"><a href="#local-6989586621681279274"><span class="hs-identifier">msg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isDoesNotExistError</span><span> </span><a href="#local-6989586621681279273"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-254"></a><span>             </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Warning: deleting non-existent&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681279272"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-255"></a><span>             </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Warning: exception raised when deleting&quot;</span><span>
</span><a name="line-256"></a><span>                                            </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681279272"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#colon"><span class="hs-identifier hs-var">colon</span></a><span>
</span><a name="line-257"></a><span>               </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279273"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>   </span><span class="hs-keyword">in</span><span> </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681279270"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621681279274"><span class="hs-identifier hs-var">msg</span></a><span>
</span><a name="line-259"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-260"></a><span>
</span><a name="line-261"></a><span class="hs-cpp">#if defined(mingw32_HOST_OS)
</span><span class="hs-comment">-- relies on Int == Int32 on Windows</span><span>
</span><a name="line-263"></a><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;_getpid&quot;</span><span> </span><span class="hs-identifier">getProcessID</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Int</span><span>
</span><a name="line-264"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">getProcessID</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-266"></a><a name="getProcessID"><a href="FileCleanup.html#getProcessID"><span class="hs-identifier">getProcessID</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">System.Posix.Internals.c_getpid</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span>
</span><a name="line-267"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-269"></a><span class="hs-comment">-- The following three functions are from the `temporary` package.</span><span>
</span><a name="line-270"></a><span>
</span><a name="line-271"></a><span class="hs-comment">-- | Create and use a temporary directory in the system standard temporary</span><span>
</span><a name="line-272"></a><span class="hs-comment">-- directory.</span><span>
</span><a name="line-273"></a><span class="hs-comment">--</span><span>
</span><a name="line-274"></a><span class="hs-comment">-- Behaves exactly the same as 'withTempDirectory', except that the parent</span><span>
</span><a name="line-275"></a><span class="hs-comment">-- temporary directory will be that returned by 'getTemporaryDirectory'.</span><span>
</span><a name="line-276"></a><span class="hs-identifier">withSystemTempDirectory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>   </span><span class="hs-comment">-- ^ Directory name template. See 'openTempFile'.</span><span>
</span><a name="line-277"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681279188"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Callback that can use the directory</span><span>
</span><a name="line-278"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681279188"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-279"></a><a name="withSystemTempDirectory"><a href="FileCleanup.html#withSystemTempDirectory"><span class="hs-identifier">withSystemTempDirectory</span></a></a><span> </span><a name="local-6989586621681279275"><a href="#local-6989586621681279275"><span class="hs-identifier">template</span></a></a><span> </span><a name="local-6989586621681279276"><a href="#local-6989586621681279276"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-identifier hs-var">getTemporaryDirectory</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681279277"><a href="#local-6989586621681279277"><span class="hs-identifier">tmpDir</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FileCleanup.html#withTempDirectory"><span class="hs-identifier hs-var">withTempDirectory</span></a><span> </span><a href="#local-6989586621681279277"><span class="hs-identifier hs-var">tmpDir</span></a><span> </span><a href="#local-6989586621681279275"><span class="hs-identifier hs-var">template</span></a><span> </span><a href="#local-6989586621681279276"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span>
</span><a name="line-283"></a><span class="hs-comment">-- | Create and use a temporary directory.</span><span>
</span><a name="line-284"></a><span class="hs-comment">--</span><span>
</span><a name="line-285"></a><span class="hs-comment">-- Creates a new temporary directory inside the given directory, making use</span><span>
</span><a name="line-286"></a><span class="hs-comment">-- of the template. The temp directory is deleted after use. For example:</span><span>
</span><a name="line-287"></a><span class="hs-comment">--</span><span>
</span><a name="line-288"></a><span class="hs-comment">-- &gt; withTempDirectory &quot;src&quot; &quot;sdist.&quot; $ \tmpDir -&gt; do ...</span><span>
</span><a name="line-289"></a><span class="hs-comment">--</span><span>
</span><a name="line-290"></a><span class="hs-comment">-- The @tmpDir@ will be a new subdirectory of the given directory, e.g.</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- @src/sdist.342@.</span><span>
</span><a name="line-292"></a><span class="hs-identifier">withTempDirectory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-comment">-- ^ Temp directory to create the directory in</span><span>
</span><a name="line-293"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span>   </span><span class="hs-comment">-- ^ Directory name template. See 'openTempFile'.</span><span>
</span><a name="line-294"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681279187"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Callback that can use the directory</span><span>
</span><a name="line-295"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681279187"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-296"></a><a name="withTempDirectory"><a href="FileCleanup.html#withTempDirectory"><span class="hs-identifier">withTempDirectory</span></a></a><span> </span><a name="local-6989586621681279278"><a href="#local-6989586621681279278"><span class="hs-identifier">targetDir</span></a></a><span> </span><a name="local-6989586621681279279"><a href="#local-6989586621681279279"><span class="hs-identifier">template</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-297"></a><span>  </span><span class="hs-identifier hs-var">Exception.bracket</span><span>
</span><a name="line-298"></a><span>    </span><span class="hs-special">(</span><a href="FileCleanup.html#createTempDirectory"><span class="hs-identifier hs-var">createTempDirectory</span></a><span> </span><a href="#local-6989586621681279278"><span class="hs-identifier hs-var">targetDir</span></a><span> </span><a href="#local-6989586621681279279"><span class="hs-identifier hs-var">template</span></a><span class="hs-special">)</span><span>
</span><a name="line-299"></a><span>    </span><span class="hs-special">(</span><a href="FileCleanup.html#ignoringIOErrors"><span class="hs-identifier hs-var">ignoringIOErrors</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">removeDirectoryRecursive</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-identifier">ignoringIOErrors</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-302"></a><a name="ignoringIOErrors"><a href="FileCleanup.html#ignoringIOErrors"><span class="hs-identifier">ignoringIOErrors</span></a></a><span> </span><a name="local-6989586621681279280"><a href="#local-6989586621681279280"><span class="hs-identifier">ioe</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279280"><span class="hs-identifier hs-var">ioe</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">catch</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681279281"><a href="#local-6989586621681279281"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">const</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279281"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IOError</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span>
</span><a name="line-305"></a><span class="hs-identifier">createTempDirectory</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-306"></a><a name="createTempDirectory"><a href="FileCleanup.html#createTempDirectory"><span class="hs-identifier">createTempDirectory</span></a></a><span> </span><a name="local-6989586621681279282"><a href="#local-6989586621681279282"><span class="hs-identifier">dir</span></a></a><span> </span><a name="local-6989586621681279283"><a href="#local-6989586621681279283"><span class="hs-identifier">template</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-307"></a><span>  </span><a name="local-6989586621681279288"><a href="#local-6989586621681279288"><span class="hs-identifier">pid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="FileCleanup.html#getProcessID"><span class="hs-identifier hs-var">getProcessID</span></a><span>
</span><a name="line-308"></a><span>  </span><a href="#local-6989586621681279284"><span class="hs-identifier hs-var">findTempName</span></a><span> </span><a href="#local-6989586621681279288"><span class="hs-identifier hs-var">pid</span></a><span>
</span><a name="line-309"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681279284"><a href="#local-6989586621681279284"><span class="hs-identifier">findTempName</span></a></a><span> </span><a name="local-6989586621681279285"><a href="#local-6989586621681279285"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-310"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681279286"><a href="#local-6989586621681279286"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681279282"><span class="hs-identifier hs-var">dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621681279283"><span class="hs-identifier hs-var">template</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621681279285"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-311"></a><span>            </span><span class="hs-identifier hs-var">createDirectory</span><span> </span><a href="#local-6989586621681279286"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-312"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681279286"><span class="hs-identifier hs-var">path</span></a><span>
</span><a name="line-313"></a><span>          </span><span class="hs-special">`</span><a href="Exception.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681279287"><a href="#local-6989586621681279287"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isAlreadyExistsError</span><span> </span><a href="#local-6989586621681279287"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-314"></a><span>                          </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681279284"><span class="hs-identifier hs-var">findTempName</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681279285"><span class="hs-identifier hs-var">x</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">ioError</span><span> </span><a href="#local-6989586621681279287"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-315"></a></pre></body></html>