<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- (c) The University of Glasgow, 2006</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE CPP, ScopedTypeVariables, BangPatterns, FlexibleContexts #-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">-- | Package manipulation</span><span>
</span><a name="line-6"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Packages</span><span> </span><span class="hs-special">(</span><span>
</span><a name="line-7"></a><span>        </span><span class="hs-keyword">module</span><span> </span><a href="PackageConfig.html"><span class="hs-identifier">PackageConfig</span></a><span class="hs-special">,</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span>        </span><span class="hs-comment">-- * Reading the package config, and processing cmdline args</span><span>
</span><a name="line-10"></a><span>        </span><a href="Packages.html#PackageState"><span class="hs-identifier hs-type">PackageState</span></a><span class="hs-special">(</span><span class="hs-identifier">preloadPackages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">explicitPackages</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">moduleToPkgConfAll</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">requirementContext</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-11"></a><span>        </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-12"></a><span>        </span><a href="Packages.html#emptyPackageState"><span class="hs-identifier hs-var">emptyPackageState</span></a><span class="hs-special">,</span><span>
</span><a name="line-13"></a><span>        </span><a href="Packages.html#initPackages"><span class="hs-identifier hs-var">initPackages</span></a><span class="hs-special">,</span><span>
</span><a name="line-14"></a><span>        </span><a href="Packages.html#readPackageConfigs"><span class="hs-identifier hs-var">readPackageConfigs</span></a><span class="hs-special">,</span><span>
</span><a name="line-15"></a><span>        </span><a href="Packages.html#getPackageConfRefs"><span class="hs-identifier hs-var">getPackageConfRefs</span></a><span class="hs-special">,</span><span>
</span><a name="line-16"></a><span>        </span><a href="Packages.html#resolvePackageConfig"><span class="hs-identifier hs-var">resolvePackageConfig</span></a><span class="hs-special">,</span><span>
</span><a name="line-17"></a><span>        </span><a href="Packages.html#readPackageConfig"><span class="hs-identifier hs-var">readPackageConfig</span></a><span class="hs-special">,</span><span>
</span><a name="line-18"></a><span>        </span><a href="Packages.html#listPackageConfigMap"><span class="hs-identifier hs-var">listPackageConfigMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span>        </span><span class="hs-comment">-- * Querying the package config</span><span>
</span><a name="line-21"></a><span>        </span><a href="Packages.html#lookupPackage"><span class="hs-identifier hs-var">lookupPackage</span></a><span class="hs-special">,</span><span>
</span><a name="line-22"></a><span>        </span><a href="Packages.html#lookupPackage%27"><span class="hs-identifier hs-var">lookupPackage'</span></a><span class="hs-special">,</span><span>
</span><a name="line-23"></a><span>        </span><a href="Packages.html#lookupInstalledPackage"><span class="hs-identifier hs-var">lookupInstalledPackage</span></a><span class="hs-special">,</span><span>
</span><a name="line-24"></a><span>        </span><a href="Packages.html#lookupPackageName"><span class="hs-identifier hs-var">lookupPackageName</span></a><span class="hs-special">,</span><span>
</span><a name="line-25"></a><span>        </span><a href="Packages.html#improveUnitId"><span class="hs-identifier hs-var">improveUnitId</span></a><span class="hs-special">,</span><span>
</span><a name="line-26"></a><span>        </span><a href="Packages.html#searchPackageId"><span class="hs-identifier hs-var">searchPackageId</span></a><span class="hs-special">,</span><span>
</span><a name="line-27"></a><span>        </span><a href="Packages.html#getPackageDetails"><span class="hs-identifier hs-var">getPackageDetails</span></a><span class="hs-special">,</span><span>
</span><a name="line-28"></a><span>        </span><a href="Packages.html#getInstalledPackageDetails"><span class="hs-identifier hs-var">getInstalledPackageDetails</span></a><span class="hs-special">,</span><span>
</span><a name="line-29"></a><span>        </span><a href="Packages.html#componentIdString"><span class="hs-identifier hs-var">componentIdString</span></a><span class="hs-special">,</span><span>
</span><a name="line-30"></a><span>        </span><a href="Packages.html#displayInstalledUnitId"><span class="hs-identifier hs-var">displayInstalledUnitId</span></a><span class="hs-special">,</span><span>
</span><a name="line-31"></a><span>        </span><a href="Packages.html#listVisibleModuleNames"><span class="hs-identifier hs-var">listVisibleModuleNames</span></a><span class="hs-special">,</span><span>
</span><a name="line-32"></a><span>        </span><a href="Packages.html#lookupModuleInAllPackages"><span class="hs-identifier hs-var">lookupModuleInAllPackages</span></a><span class="hs-special">,</span><span>
</span><a name="line-33"></a><span>        </span><a href="Packages.html#lookupModuleWithSuggestions"><span class="hs-identifier hs-var">lookupModuleWithSuggestions</span></a><span class="hs-special">,</span><span>
</span><a name="line-34"></a><span>        </span><a href="Packages.html#lookupPluginModuleWithSuggestions"><span class="hs-identifier hs-var">lookupPluginModuleWithSuggestions</span></a><span class="hs-special">,</span><span>
</span><a name="line-35"></a><span>        </span><a href="Packages.html#LookupResult"><span class="hs-identifier hs-type">LookupResult</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-36"></a><span>        </span><a href="Packages.html#ModuleSuggestion"><span class="hs-identifier hs-type">ModuleSuggestion</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-37"></a><span>        </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-38"></a><span>        </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-39"></a><span>        </span><a href="Packages.html#pprReason"><span class="hs-identifier hs-var">pprReason</span></a><span class="hs-special">,</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span>        </span><span class="hs-comment">-- * Inspecting the set of packages in scope</span><span>
</span><a name="line-42"></a><span>        </span><a href="Packages.html#getPackageIncludePath"><span class="hs-identifier hs-var">getPackageIncludePath</span></a><span class="hs-special">,</span><span>
</span><a name="line-43"></a><span>        </span><a href="Packages.html#getPackageLibraryPath"><span class="hs-identifier hs-var">getPackageLibraryPath</span></a><span class="hs-special">,</span><span>
</span><a name="line-44"></a><span>        </span><a href="Packages.html#getPackageLinkOpts"><span class="hs-identifier hs-var">getPackageLinkOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-45"></a><span>        </span><a href="Packages.html#getPackageExtraCcOpts"><span class="hs-identifier hs-var">getPackageExtraCcOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-46"></a><span>        </span><a href="Packages.html#getPackageFrameworkPath"><span class="hs-identifier hs-var">getPackageFrameworkPath</span></a><span class="hs-special">,</span><span>
</span><a name="line-47"></a><span>        </span><a href="Packages.html#getPackageFrameworks"><span class="hs-identifier hs-var">getPackageFrameworks</span></a><span class="hs-special">,</span><span>
</span><a name="line-48"></a><span>        </span><a href="Packages.html#getPackageConfigMap"><span class="hs-identifier hs-var">getPackageConfigMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-49"></a><span>        </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span class="hs-special">,</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span>        </span><a href="Packages.html#collectArchives"><span class="hs-identifier hs-var">collectArchives</span></a><span class="hs-special">,</span><span>
</span><a name="line-52"></a><span>        </span><a href="Packages.html#collectIncludeDirs"><span class="hs-identifier hs-var">collectIncludeDirs</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#collectLibraryPaths"><span class="hs-identifier hs-var">collectLibraryPaths</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#collectLinkOpts"><span class="hs-identifier hs-var">collectLinkOpts</span></a><span class="hs-special">,</span><span>
</span><a name="line-53"></a><span>        </span><a href="Packages.html#packageHsLibs"><span class="hs-identifier hs-var">packageHsLibs</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#getLibs"><span class="hs-identifier hs-var">getLibs</span></a><span class="hs-special">,</span><span>
</span><a name="line-54"></a><span>
</span><a name="line-55"></a><span>        </span><span class="hs-comment">-- * Utils</span><span>
</span><a name="line-56"></a><span>        </span><a href="Packages.html#unwireUnitId"><span class="hs-identifier hs-var">unwireUnitId</span></a><span class="hs-special">,</span><span>
</span><a name="line-57"></a><span>        </span><a href="Packages.html#pprFlag"><span class="hs-identifier hs-var">pprFlag</span></a><span class="hs-special">,</span><span>
</span><a name="line-58"></a><span>        </span><a href="Packages.html#pprPackages"><span class="hs-identifier hs-var">pprPackages</span></a><span class="hs-special">,</span><span>
</span><a name="line-59"></a><span>        </span><a href="Packages.html#pprPackagesSimple"><span class="hs-identifier hs-var">pprPackagesSimple</span></a><span class="hs-special">,</span><span>
</span><a name="line-60"></a><span>        </span><a href="Packages.html#pprModuleMap"><span class="hs-identifier hs-var">pprModuleMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-61"></a><span>        </span><a href="Packages.html#isIndefinite"><span class="hs-identifier hs-var">isIndefinite</span></a><span class="hs-special">,</span><span>
</span><a name="line-62"></a><span>        </span><a href="Packages.html#isDllName"><span class="hs-identifier hs-var">isDllName</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span class="hs-keyword">where</span><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-cpp">#include &quot;HsVersions.h&quot;
</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><a href="GhcPrelude.html"><span class="hs-identifier">GhcPrelude</span></a><span>
</span><a name="line-69"></a><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><a href="GHC.PackageDb.html"><span class="hs-identifier">GHC.PackageDb</span></a><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><a href="PackageConfig.html"><span class="hs-identifier">PackageConfig</span></a><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><a href="DynFlags.html"><span class="hs-identifier">DynFlags</span></a><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><a href="Name.html"><span class="hs-identifier">Name</span></a><span>             </span><span class="hs-special">(</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span class="hs-special">,</span><span> </span><a href="Name.html#nameModule_maybe"><span class="hs-identifier hs-var">nameModule_maybe</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span class="hs-keyword">import</span><span> </span><a href="UniqFM.html"><span class="hs-identifier">UniqFM</span></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><a href="UniqDFM.html"><span class="hs-identifier">UniqDFM</span></a><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><a href="UniqSet.html"><span class="hs-identifier">UniqSet</span></a><span>
</span><a name="line-77"></a><span class="hs-keyword">import</span><span> </span><a href="Module.html"><span class="hs-identifier">Module</span></a><span>
</span><a name="line-78"></a><span class="hs-keyword">import</span><span> </span><a href="Util.html"><span class="hs-identifier">Util</span></a><span>
</span><a name="line-79"></a><span class="hs-keyword">import</span><span> </span><a href="Panic.html"><span class="hs-identifier">Panic</span></a><span>
</span><a name="line-80"></a><span class="hs-keyword">import</span><span> </span><a href="Platform.html"><span class="hs-identifier">Platform</span></a><span>
</span><a name="line-81"></a><span class="hs-keyword">import</span><span> </span><a href="Outputable.html"><span class="hs-identifier">Outputable</span></a><span>
</span><a name="line-82"></a><span class="hs-keyword">import</span><span> </span><a href="Maybes.html"><span class="hs-identifier">Maybes</span></a><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Environment</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">getEnv</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span class="hs-keyword">import</span><span> </span><a href="FastString.html"><span class="hs-identifier">FastString</span></a><span>
</span><a name="line-86"></a><span class="hs-keyword">import</span><span> </span><a href="ErrUtils.html"><span class="hs-identifier">ErrUtils</span></a><span>         </span><span class="hs-special">(</span><span> </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span class="hs-special">,</span><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span class="hs-special">,</span><span> </span><a href="ErrUtils.html#dumpIfSet_dyn"><span class="hs-identifier hs-var">dumpIfSet_dyn</span></a><span> </span><span class="hs-special">)</span><span>
</span><a name="line-87"></a><span class="hs-keyword">import</span><span> </span><a href="Exception.html"><span class="hs-identifier">Exception</span></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.Directory</span><span>
</span><a name="line-90"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FilePath</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">FilePath</span><span>
</span><a name="line-91"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">System.FilePath.Posix</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">FilePath.Posix</span><span>
</span><a name="line-92"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-93"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Graph</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">stronglyConnComp</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SCC</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-94"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">toUpper</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-95"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">List</span><span>
</span><a name="line-96"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">First</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Semigroup</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Semigroup</span><span>
</span><a name="line-100"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Map</span><span>
</span><a name="line-101"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Map.Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">MapStrict</span><span>
</span><a name="line-102"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Set</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Set</span><span>
</span><a name="line-103"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Version</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- ---------------------------------------------------------------------------</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- The Package state</span><span>
</span><a name="line-107"></a><span>
</span><a name="line-108"></a><span class="hs-comment">-- | Package state is all stored in 'DynFlags', including the details of</span><span>
</span><a name="line-109"></a><span class="hs-comment">-- all packages, which packages are exposed, and which modules they</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- provide.</span><span>
</span><a name="line-111"></a><span class="hs-comment">--</span><span>
</span><a name="line-112"></a><span class="hs-comment">-- The package state is computed by 'initPackages', and kept in DynFlags.</span><span>
</span><a name="line-113"></a><span class="hs-comment">-- It is influenced by various package flags:</span><span>
</span><a name="line-114"></a><span class="hs-comment">--</span><span>
</span><a name="line-115"></a><span class="hs-comment">--   * @-package &lt;pkg&gt;@ and @-package-id &lt;pkg&gt;@ cause @&lt;pkg&gt;@ to become exposed.</span><span>
</span><a name="line-116"></a><span class="hs-comment">--     If @-hide-all-packages@ was not specified, these commands also cause</span><span>
</span><a name="line-117"></a><span class="hs-comment">--      all other packages with the same name to become hidden.</span><span>
</span><a name="line-118"></a><span class="hs-comment">--</span><span>
</span><a name="line-119"></a><span class="hs-comment">--   * @-hide-package &lt;pkg&gt;@ causes @&lt;pkg&gt;@ to become hidden.</span><span>
</span><a name="line-120"></a><span class="hs-comment">--</span><span>
</span><a name="line-121"></a><span class="hs-comment">--   * (there are a few more flags, check below for their semantics)</span><span>
</span><a name="line-122"></a><span class="hs-comment">--</span><span>
</span><a name="line-123"></a><span class="hs-comment">-- The package state has the following properties.</span><span>
</span><a name="line-124"></a><span class="hs-comment">--</span><span>
</span><a name="line-125"></a><span class="hs-comment">--   * Let @exposedPackages@ be the set of packages thus exposed.</span><span>
</span><a name="line-126"></a><span class="hs-comment">--     Let @depExposedPackages@ be the transitive closure from @exposedPackages@ of</span><span>
</span><a name="line-127"></a><span class="hs-comment">--     their dependencies.</span><span>
</span><a name="line-128"></a><span class="hs-comment">--</span><span>
</span><a name="line-129"></a><span class="hs-comment">--   * When searching for a module from a preload import declaration,</span><span>
</span><a name="line-130"></a><span class="hs-comment">--     only the exposed modules in @exposedPackages@ are valid.</span><span>
</span><a name="line-131"></a><span class="hs-comment">--</span><span>
</span><a name="line-132"></a><span class="hs-comment">--   * When searching for a module from an implicit import, all modules</span><span>
</span><a name="line-133"></a><span class="hs-comment">--     from @depExposedPackages@ are valid.</span><span>
</span><a name="line-134"></a><span class="hs-comment">--</span><span>
</span><a name="line-135"></a><span class="hs-comment">--   * When linking in a compilation manager mode, we link in packages the</span><span>
</span><a name="line-136"></a><span class="hs-comment">--     program depends on (the compiler knows this list by the</span><span>
</span><a name="line-137"></a><span class="hs-comment">--     time it gets to the link step).  Also, we link in all packages</span><span>
</span><a name="line-138"></a><span class="hs-comment">--     which were mentioned with preload @-package@ flags on the command-line,</span><span>
</span><a name="line-139"></a><span class="hs-comment">--     or are a transitive dependency of same, or are \&quot;base\&quot;\/\&quot;rts\&quot;.</span><span>
</span><a name="line-140"></a><span class="hs-comment">--     The reason for this is that we might need packages which don't</span><span>
</span><a name="line-141"></a><span class="hs-comment">--     contain any Haskell modules, and therefore won't be discovered</span><span>
</span><a name="line-142"></a><span class="hs-comment">--     by the normal mechanism of dependency tracking.</span><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span class="hs-comment">-- Notes on DLLs</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- ~~~~~~~~~~~~~</span><span>
</span><a name="line-146"></a><span class="hs-comment">-- When compiling module A, which imports module B, we need to</span><span>
</span><a name="line-147"></a><span class="hs-comment">-- know whether B will be in the same DLL as A.</span><span>
</span><a name="line-148"></a><span class="hs-comment">--      If it's in the same DLL, we refer to B_f_closure</span><span>
</span><a name="line-149"></a><span class="hs-comment">--      If it isn't, we refer to _imp__B_f_closure</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- When compiling A, we record in B's Module value whether it's</span><span>
</span><a name="line-151"></a><span class="hs-comment">-- in a different DLL, by setting the DLL flag.</span><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | Given a module name, there may be multiple ways it came into scope,</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- possibly simultaneously.  This data type tracks all the possible ways</span><span>
</span><a name="line-155"></a><span class="hs-comment">-- it could have come into scope.  Warning: don't use the record functions,</span><span>
</span><a name="line-156"></a><span class="hs-comment">-- they're partial!</span><span>
</span><a name="line-157"></a><span class="hs-keyword">data</span><span> </span><a name="ModuleOrigin"><a href="Packages.html#ModuleOrigin"><span class="hs-identifier">ModuleOrigin</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-158"></a><span>    </span><span class="hs-comment">-- | Module is hidden, and thus never will be available for import.</span><span>
</span><a name="line-159"></a><span>    </span><span class="hs-comment">-- (But maybe the user didn't realize), so we'll still keep track</span><span>
</span><a name="line-160"></a><span>    </span><span class="hs-comment">-- of these modules.)</span><span>
</span><a name="line-161"></a><span>    </span><a name="ModHidden"><a href="Packages.html#ModHidden"><span class="hs-identifier">ModHidden</span></a></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-comment">-- | Module is unavailable because the package is unusable.</span><span>
</span><a name="line-163"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ModUnusable"><a href="Packages.html#ModUnusable"><span class="hs-identifier">ModUnusable</span></a></a><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span>
</span><a name="line-164"></a><span>    </span><span class="hs-comment">-- | Module is public, and could have come from some places.</span><span>
</span><a name="line-165"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ModOrigin"><a href="Packages.html#ModOrigin"><span class="hs-identifier">ModOrigin</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-166"></a><span>        </span><span class="hs-comment">-- | @Just False@ means that this module is in</span><span>
</span><a name="line-167"></a><span>        </span><span class="hs-comment">-- someone's @exported-modules@ list, but that package is hidden;</span><span>
</span><a name="line-168"></a><span>        </span><span class="hs-comment">-- @Just True@ means that it is available; @Nothing@ means neither</span><span>
</span><a name="line-169"></a><span>        </span><span class="hs-comment">-- applies.</span><span>
</span><a name="line-170"></a><span>        </span><a name="fromOrigPackage"><a href="Packages.html#fromOrigPackage"><span class="hs-identifier">fromOrigPackage</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-171"></a><span>        </span><span class="hs-comment">-- | Is the module available from a reexport of an exposed package?</span><span>
</span><a name="line-172"></a><span>        </span><span class="hs-comment">-- There could be multiple.</span><span>
</span><a name="line-173"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="fromExposedReexport"><a href="Packages.html#fromExposedReexport"><span class="hs-identifier">fromExposedReexport</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-174"></a><span>        </span><span class="hs-comment">-- | Is the module available from a reexport of a hidden package?</span><span>
</span><a name="line-175"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="fromHiddenReexport"><a href="Packages.html#fromHiddenReexport"><span class="hs-identifier">fromHiddenReexport</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-176"></a><span>        </span><span class="hs-comment">-- | Did the module export come from a package flag? (ToDo: track</span><span>
</span><a name="line-177"></a><span>        </span><span class="hs-comment">-- more information.</span><span>
</span><a name="line-178"></a><span>      </span><span class="hs-special">,</span><span> </span><a name="fromPackageFlag"><a href="Packages.html#fromPackageFlag"><span class="hs-identifier">fromPackageFlag</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-179"></a><span>      </span><span class="hs-special">}</span><span>
</span><a name="line-180"></a><span>
</span><a name="line-181"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-182"></a><span>    </span><a name="local-8214565720324908102"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Packages.html#ModHidden"><span class="hs-identifier hs-var">ModHidden</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;hidden module&quot;</span><span>
</span><a name="line-183"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Packages.html#ModUnusable"><span class="hs-identifier hs-var">ModUnusable</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;unusable module&quot;</span><span>
</span><a name="line-184"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><a name="local-6989586621681219901"><a href="#local-6989586621681219901"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681219902"><a href="#local-6989586621681219902"><span class="hs-identifier">res</span></a></a><span> </span><a name="local-6989586621681219903"><a href="#local-6989586621681219903"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621681219904"><a href="#local-6989586621681219904"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#punctuate"><span class="hs-identifier hs-var">punctuate</span></a><span> </span><a href="Outputable.html#comma"><span class="hs-identifier hs-var">comma</span></a><span> </span><span class="hs-special">(</span><span>
</span><a name="line-185"></a><span>        </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681219901"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-186"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-187"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;hidden package&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-188"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;exposed package&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-189"></a><span>        </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681219902"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-190"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-191"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;reexport by&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-192"></a><span>                    </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219902"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-193"></a><span>        </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681219903"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-194"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-195"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;hidden reexport by&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-196"></a><span>                    </span><a href="Outputable.html#sep"><span class="hs-identifier hs-var">sep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219902"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-197"></a><span>        </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219904"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;package flag&quot;</span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-198"></a><span>        </span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-199"></a><span>
</span><a name="line-200"></a><span class="hs-comment">-- | Smart constructor for a module which is in @exposed-modules@.  Takes</span><span>
</span><a name="line-201"></a><span class="hs-comment">-- as an argument whether or not the defining package is exposed.</span><span>
</span><a name="line-202"></a><span class="hs-identifier">fromExposedModules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-203"></a><a name="fromExposedModules"><a href="Packages.html#fromExposedModules"><span class="hs-identifier">fromExposedModules</span></a></a><span> </span><a name="local-6989586621681219915"><a href="#local-6989586621681219915"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681219915"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- | Smart constructor for a module which is in @reexported-modules@.  Takes</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- as an argument whether or not the reexporting package is expsed, and</span><span>
</span><a name="line-207"></a><span class="hs-comment">-- also its 'PackageConfig'.</span><span>
</span><a name="line-208"></a><span class="hs-identifier">fromReexportedModules</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-209"></a><a name="fromReexportedModules"><a href="Packages.html#fromReexportedModules"><span class="hs-identifier">fromReexportedModules</span></a></a><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621681219916"><a href="#local-6989586621681219916"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681219916"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-210"></a><span class="hs-identifier">fromReexportedModules</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a name="local-6989586621681219917"><a href="#local-6989586621681219917"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621681219917"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-211"></a><span>
</span><a name="line-212"></a><span class="hs-comment">-- | Smart constructor for a module which was bound by a package flag.</span><span>
</span><a name="line-213"></a><span class="hs-identifier">fromFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-214"></a><a name="fromFlag"><a href="Packages.html#fromFlag"><span class="hs-identifier">fromFlag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-217"></a><span>    </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><a name="local-6989586621681219886"><a href="#local-6989586621681219886"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681219887"><a href="#local-6989586621681219887"><span class="hs-identifier">res</span></a></a><span> </span><a name="local-6989586621681219888"><a href="#local-6989586621681219888"><span class="hs-identifier">rhs</span></a></a><span> </span><a name="local-6989586621681219889"><a href="#local-6989586621681219889"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><a name="local-6989586621681219890"><a href="#local-6989586621681219890"><span class="hs-identifier">e'</span></a></a><span> </span><a name="local-6989586621681219891"><a href="#local-6989586621681219891"><span class="hs-identifier">res'</span></a></a><span> </span><a name="local-6989586621681219892"><a href="#local-6989586621681219892"><span class="hs-identifier">rhs'</span></a></a><span> </span><a name="local-6989586621681219893"><a href="#local-6989586621681219893"><span class="hs-identifier">f'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-218"></a><span>        </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219894"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-6989586621681219886"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621681219890"><span class="hs-identifier hs-var">e'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219887"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681219891"><span class="hs-identifier hs-var">res'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219888"><span class="hs-identifier hs-var">rhs</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681219892"><span class="hs-identifier hs-var">rhs'</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219889"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681219893"><span class="hs-identifier hs-var">f'</span></a><span class="hs-special">)</span><span>
</span><a name="line-219"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681219894"><a href="#local-6989586621681219894"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681219895"><a href="#local-6989586621681219895"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681219896"><a href="#local-6989586621681219896"><span class="hs-identifier">b'</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>                </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681219895"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681219896"><span class="hs-identifier hs-var">b'</span></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681219895"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-221"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="PlainPanic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;ModOrigin: package both exposed/hidden&quot;</span><span>
</span><a name="line-222"></a><span>            </span><span class="hs-identifier">g</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><a name="local-6989586621681219897"><a href="#local-6989586621681219897"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219897"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-223"></a><span>            </span><span class="hs-identifier">g</span><span> </span><a name="local-6989586621681219898"><a href="#local-6989586621681219898"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219898"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-224"></a><span>    </span><a name="local-6989586621681219899"><a href="#local-6989586621681219899"><span class="hs-identifier">_x</span></a></a><span> </span><span class="hs-operator">&lt;&gt;</span><span> </span><a name="local-6989586621681219900"><a href="#local-6989586621681219900"><span class="hs-identifier">_y</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PlainPanic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;ModOrigin: hidden module redefined&quot;</span><span>
</span><a name="line-225"></a><span>
</span><a name="line-226"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-227"></a><span>    </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-228"></a><span>    </span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">Semigroup.&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-229"></a><span>
</span><a name="line-230"></a><span class="hs-comment">-- | Is the name from the import actually visible? (i.e. does it cause</span><span>
</span><a name="line-231"></a><span class="hs-comment">-- ambiguity, or is it only relevant when we're making suggestions?)</span><span>
</span><a name="line-232"></a><span class="hs-identifier">originVisible</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-233"></a><a name="originVisible"><a href="Packages.html#originVisible"><span class="hs-identifier">originVisible</span></a></a><span> </span><a href="Packages.html#ModHidden"><span class="hs-identifier hs-var">ModHidden</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-234"></a><span class="hs-identifier">originVisible</span><span> </span><span class="hs-special">(</span><a href="Packages.html#ModUnusable"><span class="hs-identifier hs-var">ModUnusable</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-235"></a><span class="hs-identifier">originVisible</span><span> </span><span class="hs-special">(</span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><a name="local-6989586621681219918"><a href="#local-6989586621681219918"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621681219919"><a href="#local-6989586621681219919"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681219920"><a href="#local-6989586621681219920"><span class="hs-identifier">f</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219918"><span class="hs-identifier hs-var">b</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681219919"><span class="hs-identifier hs-var">res</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681219920"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-236"></a><span>
</span><a name="line-237"></a><span class="hs-comment">-- | Are there actually no providers for this module?  This will never occur</span><span>
</span><a name="line-238"></a><span class="hs-comment">-- except when we're filtering based on package imports.</span><span>
</span><a name="line-239"></a><span class="hs-identifier">originEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-240"></a><a name="originEmpty"><a href="Packages.html#originEmpty"><span class="hs-identifier">originEmpty</span></a></a><span> </span><span class="hs-special">(</span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-241"></a><span class="hs-identifier">originEmpty</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-242"></a><span>
</span><a name="line-243"></a><span class="hs-comment">-- | 'UniqFM' map from 'InstalledUnitId'</span><span>
</span><a name="line-244"></a><span class="hs-keyword">type</span><span> </span><a name="InstalledUnitIdMap"><a href="Packages.html#InstalledUnitIdMap"><span class="hs-identifier">InstalledUnitIdMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#UniqDFM"><span class="hs-identifier hs-type">UniqDFM</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- | 'UniqFM' map from 'UnitId' to 'PackageConfig', plus</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- the transitive closure of preload packages.</span><span>
</span><a name="line-248"></a><span class="hs-keyword">data</span><span> </span><a name="PackageConfigMap"><a href="Packages.html#PackageConfigMap"><span class="hs-identifier">PackageConfigMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PackageConfigMap"><a href="Packages.html#PackageConfigMap"><span class="hs-identifier">PackageConfigMap</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-249"></a><span>        </span><a name="unPackageConfigMap"><a href="Packages.html#unPackageConfigMap"><span class="hs-identifier">unPackageConfigMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#InstalledUnitIdMap"><span class="hs-identifier hs-type">InstalledUnitIdMap</span></a><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span>
</span><a name="line-250"></a><span>        </span><span class="hs-comment">-- | The set of transitively reachable packages according</span><span>
</span><a name="line-251"></a><span>        </span><span class="hs-comment">-- to the explicitly provided command line arguments.</span><span>
</span><a name="line-252"></a><span>        </span><span class="hs-comment">-- See Note [UnitId to InstalledUnitId improvement]</span><span>
</span><a name="line-253"></a><span>        </span><a name="preloadClosure"><a href="Packages.html#preloadClosure"><span class="hs-identifier">preloadClosure</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="UniqSet.html#UniqSet"><span class="hs-identifier hs-type">UniqSet</span></a><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span>
</span><a name="line-254"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-255"></a><span>
</span><a name="line-256"></a><span class="hs-comment">-- | 'UniqFM' map from 'UnitId' to a 'UnitVisibility'.</span><span>
</span><a name="line-257"></a><span class="hs-keyword">type</span><span> </span><a name="VisibilityMap"><a href="Packages.html#VisibilityMap"><span class="hs-identifier">VisibilityMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-type">UnitVisibility</span></a><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-comment">-- | 'UnitVisibility' records the various aspects of visibility of a particular</span><span>
</span><a name="line-260"></a><span class="hs-comment">-- 'UnitId'.</span><span>
</span><a name="line-261"></a><span class="hs-keyword">data</span><span> </span><a name="UnitVisibility"><a href="Packages.html#UnitVisibility"><span class="hs-identifier">UnitVisibility</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="UnitVisibility"><a href="Packages.html#UnitVisibility"><span class="hs-identifier">UnitVisibility</span></a></a><span>
</span><a name="line-262"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="uv_expose_all"><a href="Packages.html#uv_expose_all"><span class="hs-identifier">uv_expose_all</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-263"></a><span>      </span><span class="hs-comment">--  ^ Should all modules in exposed-modules should be dumped into scope?</span><span>
</span><a name="line-264"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="uv_renamings"><a href="Packages.html#uv_renamings"><span class="hs-identifier">uv_renamings</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-265"></a><span>      </span><span class="hs-comment">-- ^ Any custom renamings that should bring extra 'ModuleName's into</span><span>
</span><a name="line-266"></a><span>      </span><span class="hs-comment">-- scope.</span><span>
</span><a name="line-267"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="uv_package_name"><a href="Packages.html#uv_package_name"><span class="hs-identifier">uv_package_name</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">First</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-268"></a><span>      </span><span class="hs-comment">-- ^ The package name is associated with the 'UnitId'.  This is used</span><span>
</span><a name="line-269"></a><span>      </span><span class="hs-comment">-- to implement legacy behavior where @-package foo-0.1@ implicitly</span><span>
</span><a name="line-270"></a><span>      </span><span class="hs-comment">-- hides any packages named @foo@</span><span>
</span><a name="line-271"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="uv_requirements"><a href="Packages.html#uv_requirements"><span class="hs-identifier">uv_requirements</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Set</span><span> </span><a href="Module.html#IndefModule"><span class="hs-identifier hs-type">IndefModule</span></a><span class="hs-special">)</span><span>
</span><a name="line-272"></a><span>      </span><span class="hs-comment">-- ^ The signatures which are contributed to the requirements context</span><span>
</span><a name="line-273"></a><span>      </span><span class="hs-comment">-- from this unit ID.</span><span>
</span><a name="line-274"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="uv_explicit"><a href="Packages.html#uv_explicit"><span class="hs-identifier">uv_explicit</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-275"></a><span>      </span><span class="hs-comment">-- ^ Whether or not this unit was explicitly brought into scope,</span><span>
</span><a name="line-276"></a><span>      </span><span class="hs-comment">-- as opposed to implicitly via the 'exposed' fields in the</span><span>
</span><a name="line-277"></a><span>      </span><span class="hs-comment">-- package database (when @-hide-all-packages@ is not passed.)</span><span>
</span><a name="line-278"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-type">UnitVisibility</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-281"></a><span>    </span><a name="local-8214565720324908102"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><span class="hs-special">(</span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-var">UnitVisibility</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-282"></a><span>        </span><span class="hs-identifier">uv_expose_all</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681219881"><a href="#local-6989586621681219881"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-283"></a><span>        </span><span class="hs-identifier">uv_renamings</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681219882"><a href="#local-6989586621681219882"><span class="hs-identifier">rns</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-284"></a><span>        </span><span class="hs-identifier">uv_package_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><a name="local-6989586621681219883"><a href="#local-6989586621681219883"><span class="hs-identifier">mb_pn</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-285"></a><span>        </span><span class="hs-identifier">uv_requirements</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681219884"><a href="#local-6989586621681219884"><span class="hs-identifier">reqs</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-286"></a><span>        </span><span class="hs-identifier">uv_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681219885"><a href="#local-6989586621681219885"><span class="hs-identifier">explicit</span></a></a><span>
</span><a name="line-287"></a><span>    </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219881"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681219882"><span class="hs-identifier hs-var">rns</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681219883"><span class="hs-identifier hs-var">mb_pn</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681219884"><span class="hs-identifier hs-var">reqs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681219885"><span class="hs-identifier hs-var">explicit</span></a><span class="hs-special">)</span><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-type">UnitVisibility</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-290"></a><span>    </span><a name="local-6989586621681219879"><a href="#local-6989586621681219879"><span class="hs-identifier">uv1</span></a></a><span> </span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span> </span><a name="local-6989586621681219880"><a href="#local-6989586621681219880"><span class="hs-identifier">uv2</span></a></a><span>
</span><a name="line-291"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-var">UnitVisibility</span></a><span>
</span><a name="line-292"></a><span>          </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uv_expose_all</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uv_expose_all</span><span> </span><a href="#local-6989586621681219879"><span class="hs-identifier hs-var">uv1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">uv_expose_all</span><span> </span><a href="#local-6989586621681219880"><span class="hs-identifier hs-var">uv2</span></a><span>
</span><a name="line-293"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_renamings</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uv_renamings</span><span> </span><a href="#local-6989586621681219879"><span class="hs-identifier hs-var">uv1</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">uv_renamings</span><span> </span><a href="#local-6989586621681219880"><span class="hs-identifier hs-var">uv2</span></a><span>
</span><a name="line-294"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_package_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mappend</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uv_package_name</span><span> </span><a href="#local-6989586621681219879"><span class="hs-identifier hs-var">uv1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uv_package_name</span><span> </span><a href="#local-6989586621681219880"><span class="hs-identifier hs-var">uv2</span></a><span class="hs-special">)</span><span>
</span><a name="line-295"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_requirements</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.unionWith</span><span> </span><span class="hs-identifier hs-var">Set.union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uv_requirements</span><span> </span><a href="#local-6989586621681219879"><span class="hs-identifier hs-var">uv1</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uv_requirements</span><span> </span><a href="#local-6989586621681219880"><span class="hs-identifier hs-var">uv2</span></a><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uv_explicit</span><span> </span><a href="#local-6989586621681219879"><span class="hs-identifier hs-var">uv1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier">uv_explicit</span><span> </span><a href="#local-6989586621681219880"><span class="hs-identifier hs-var">uv2</span></a><span>
</span><a name="line-297"></a><span>          </span><span class="hs-special">}</span><span>
</span><a name="line-298"></a><span>
</span><a name="line-299"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-type">UnitVisibility</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-300"></a><span>    </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-var">UnitVisibility</span></a><span>
</span><a name="line-301"></a><span>             </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uv_expose_all</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-302"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_renamings</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-303"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_package_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-304"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_requirements</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-305"></a><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-306"></a><span>             </span><span class="hs-special">}</span><span>
</span><a name="line-307"></a><span>    </span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">Semigroup.&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-308"></a><span>
</span><a name="line-309"></a><span class="hs-keyword">type</span><span> </span><a name="WiredUnitId"><a href="Packages.html#WiredUnitId"><span class="hs-identifier">WiredUnitId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#DefUnitId"><span class="hs-identifier hs-type">DefUnitId</span></a><span>
</span><a name="line-310"></a><span class="hs-keyword">type</span><span> </span><a name="PreloadUnitId"><a href="Packages.html#PreloadUnitId"><span class="hs-identifier">PreloadUnitId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- | Map from 'ModuleName' to 'Module' to all the origins of the bindings</span><span>
</span><a name="line-313"></a><span class="hs-comment">-- in scope.  The 'PackageConf' is not cached, mostly for convenience reasons</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- (since this is the slow path, we'll just look it up again).</span><span>
</span><a name="line-315"></a><span class="hs-keyword">type</span><span> </span><a name="ModuleToPkgConfAll"><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier">ModuleToPkgConfAll</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-316"></a><span>    </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-keyword">data</span><span> </span><a name="PackageState"><a href="Packages.html#PackageState"><span class="hs-identifier">PackageState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="PackageState"><a href="Packages.html#PackageState"><span class="hs-identifier">PackageState</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-319"></a><span>  </span><span class="hs-comment">-- | A mapping of 'UnitId' to 'PackageConfig'.  This list is adjusted</span><span>
</span><a name="line-320"></a><span>  </span><span class="hs-comment">-- so that only valid packages are here.  'PackageConfig' reflects</span><span>
</span><a name="line-321"></a><span>  </span><span class="hs-comment">-- what was stored *on disk*, except for the 'trusted' flag, which</span><span>
</span><a name="line-322"></a><span>  </span><span class="hs-comment">-- is adjusted at runtime.  (In particular, some packages in this map</span><span>
</span><a name="line-323"></a><span>  </span><span class="hs-comment">-- may have the 'exposed' flag be 'False'.)</span><span>
</span><a name="line-324"></a><span>  </span><a name="pkgIdMap"><a href="Packages.html#pkgIdMap"><span class="hs-identifier">pkgIdMap</span></a></a><span>              </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span>  </span><span class="hs-comment">-- | A mapping of 'PackageName' to 'ComponentId'.  This is used when</span><span>
</span><a name="line-327"></a><span>  </span><span class="hs-comment">-- users refer to packages in Backpack includes.</span><span>
</span><a name="line-328"></a><span>  </span><a name="packageNameMap"><a href="Packages.html#packageNameMap"><span class="hs-identifier">packageNameMap</span></a></a><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="PackageConfig.html#PackageName"><span class="hs-identifier hs-type">PackageName</span></a><span> </span><a href="Module.html#ComponentId"><span class="hs-identifier hs-type">ComponentId</span></a><span class="hs-special">,</span><span>
</span><a name="line-329"></a><span>
</span><a name="line-330"></a><span>  </span><span class="hs-comment">-- | A mapping from wired in names to the original names from the</span><span>
</span><a name="line-331"></a><span>  </span><span class="hs-comment">-- package database.</span><span>
</span><a name="line-332"></a><span>  </span><a name="unwireMap"><a href="Packages.html#unwireMap"><span class="hs-identifier">unwireMap</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Packages.html#WiredUnitId"><span class="hs-identifier hs-type">WiredUnitId</span></a><span> </span><a href="Packages.html#WiredUnitId"><span class="hs-identifier hs-type">WiredUnitId</span></a><span class="hs-special">,</span><span>
</span><a name="line-333"></a><span>
</span><a name="line-334"></a><span>  </span><span class="hs-comment">-- | The packages we're going to link in eagerly.  This list</span><span>
</span><a name="line-335"></a><span>  </span><span class="hs-comment">-- should be in reverse dependency order; that is, a package</span><span>
</span><a name="line-336"></a><span>  </span><span class="hs-comment">-- is always mentioned before the packages it depends on.</span><span>
</span><a name="line-337"></a><span>  </span><a name="preloadPackages"><a href="Packages.html#preloadPackages"><span class="hs-identifier">preloadPackages</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span>  </span><span class="hs-comment">-- | Packages which we explicitly depend on (from a command line flag).</span><span>
</span><a name="line-340"></a><span>  </span><span class="hs-comment">-- We'll use this to generate version macros.</span><span>
</span><a name="line-341"></a><span>  </span><a name="explicitPackages"><a href="Packages.html#explicitPackages"><span class="hs-identifier">explicitPackages</span></a></a><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span>  </span><span class="hs-comment">-- | This is a full map from 'ModuleName' to all modules which may possibly</span><span>
</span><a name="line-344"></a><span>  </span><span class="hs-comment">-- be providing it.  These providers may be hidden (but we'll still want</span><span>
</span><a name="line-345"></a><span>  </span><span class="hs-comment">-- to report them in error messages), or it may be an ambiguous import.</span><span>
</span><a name="line-346"></a><span>  </span><a name="moduleToPkgConfAll"><a href="Packages.html#moduleToPkgConfAll"><span class="hs-identifier">moduleToPkgConfAll</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier hs-type">ModuleToPkgConfAll</span></a><span class="hs-special">,</span><span>
</span><a name="line-347"></a><span>
</span><a name="line-348"></a><span>  </span><span class="hs-comment">-- | A map, like 'moduleToPkgConfAll', but controlling plugin visibility.</span><span>
</span><a name="line-349"></a><span>  </span><a name="pluginModuleToPkgConfAll"><a href="Packages.html#pluginModuleToPkgConfAll"><span class="hs-identifier">pluginModuleToPkgConfAll</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier hs-type">ModuleToPkgConfAll</span></a><span class="hs-special">,</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span>  </span><span class="hs-comment">-- | A map saying, for each requirement, what interfaces must be merged</span><span>
</span><a name="line-352"></a><span>  </span><span class="hs-comment">-- together when we use them.  For example, if our dependencies</span><span>
</span><a name="line-353"></a><span>  </span><span class="hs-comment">-- are @p[A=&lt;A&gt;]@ and @q[A=&lt;A&gt;,B=r[C=&lt;A&gt;]:B]@, then the interfaces</span><span>
</span><a name="line-354"></a><span>  </span><span class="hs-comment">-- to merge for A are @p[A=&lt;A&gt;]:A@, @q[A=&lt;A&gt;,B=r[C=&lt;A&gt;]:B]:A@</span><span>
</span><a name="line-355"></a><span>  </span><span class="hs-comment">-- and @r[C=&lt;A&gt;]:C@.</span><span>
</span><a name="line-356"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-357"></a><span>  </span><span class="hs-comment">-- There's an entry in this map for each hole in our home library.</span><span>
</span><a name="line-358"></a><span>  </span><a name="requirementContext"><a href="Packages.html#requirementContext"><span class="hs-identifier">requirementContext</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><span class="hs-special">[</span><a href="Module.html#IndefModule"><span class="hs-identifier hs-type">IndefModule</span></a><span class="hs-special">]</span><span>
</span><a name="line-359"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-identifier">emptyPackageState</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageState"><span class="hs-identifier hs-type">PackageState</span></a><span>
</span><a name="line-362"></a><a name="emptyPackageState"><a href="Packages.html#emptyPackageState"><span class="hs-identifier">emptyPackageState</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#PackageState"><span class="hs-identifier hs-var">PackageState</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-363"></a><span>    </span><span class="hs-identifier">pkgIdMap</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#emptyPackageConfigMap"><span class="hs-identifier hs-var">emptyPackageConfigMap</span></a><span class="hs-special">,</span><span>
</span><a name="line-364"></a><span>    </span><span class="hs-identifier">packageNameMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-365"></a><span>    </span><span class="hs-identifier">unwireMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-366"></a><span>    </span><span class="hs-identifier">preloadPackages</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-367"></a><span>    </span><span class="hs-identifier">explicitPackages</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-368"></a><span>    </span><span class="hs-identifier">moduleToPkgConfAll</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-369"></a><span>    </span><span class="hs-identifier">pluginModuleToPkgConfAll</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-370"></a><span>    </span><span class="hs-identifier">requirementContext</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-371"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-372"></a><span>
</span><a name="line-373"></a><span class="hs-keyword">type</span><span> </span><a name="InstalledPackageIndex"><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier">InstalledPackageIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-374"></a><span>
</span><a name="line-375"></a><span class="hs-comment">-- | Empty package configuration map</span><span>
</span><a name="line-376"></a><span class="hs-identifier">emptyPackageConfigMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-377"></a><a name="emptyPackageConfigMap"><a href="Packages.html#emptyPackageConfigMap"><span class="hs-identifier">emptyPackageConfigMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><a href="UniqDFM.html#emptyUDFM"><span class="hs-identifier hs-var">emptyUDFM</span></a><span> </span><a href="UniqSet.html#emptyUniqSet"><span class="hs-identifier hs-var">emptyUniqSet</span></a><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- | Find the package we know about with the given unit id, if any</span><span>
</span><a name="line-380"></a><span class="hs-identifier">lookupPackage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-381"></a><a name="lookupPackage"><a href="Packages.html#lookupPackage"><span class="hs-identifier">lookupPackage</span></a></a><span> </span><a name="local-6989586621681219921"><a href="#local-6989586621681219921"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#lookupPackage%27"><span class="hs-identifier hs-var">lookupPackage'</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#isIndefinite"><span class="hs-identifier hs-var">isIndefinite</span></a><span> </span><a href="#local-6989586621681219921"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgIdMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681219921"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-382"></a><span>
</span><a name="line-383"></a><span class="hs-comment">-- | A more specialized interface, which takes a boolean specifying</span><span>
</span><a name="line-384"></a><span class="hs-comment">-- whether or not to look for on-the-fly renamed interfaces, and</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- just a 'PackageConfigMap' rather than a 'DynFlags' (so it can</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- be used while we're initializing 'DynFlags'</span><span>
</span><a name="line-387"></a><span class="hs-identifier">lookupPackage'</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-388"></a><a name="lookupPackage%27"><a href="Packages.html#lookupPackage%27"><span class="hs-identifier">lookupPackage'</span></a></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">(</span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><a name="local-6989586621681219922"><a href="#local-6989586621681219922"><span class="hs-identifier">pkg_map</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681219923"><a href="#local-6989586621681219923"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621681219922"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681219923"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-389"></a><span class="hs-identifier">lookupPackage'</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><a name="local-6989586621681219924"><a href="#local-6989586621681219924"><span class="hs-identifier">m</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><a name="local-6989586621681219925"><a href="#local-6989586621681219925"><span class="hs-identifier">pkg_map</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681219926"><a href="#local-6989586621681219926"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-390"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Module.html#splitUnitIdInsts"><span class="hs-identifier hs-var">splitUnitIdInsts</span></a><span> </span><a href="#local-6989586621681219926"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-391"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681219927"><a href="#local-6989586621681219927"><span class="hs-identifier">iuid</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681219928"><a href="#local-6989586621681219928"><span class="hs-identifier">indef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-392"></a><span>            </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Packages.html#renamePackage"><span class="hs-identifier hs-var">renamePackage</span></a><span> </span><a href="#local-6989586621681219924"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><a href="#local-6989586621681219928"><span class="hs-identifier hs-var">indef</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-393"></a><span>                 </span><span class="hs-special">(</span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621681219925"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681219927"><span class="hs-identifier hs-var">iuid</span></a><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621681219925"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681219926"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-395"></a><span>
</span><a name="line-396"></a><span class="hs-comment">{-
-- | Find the indefinite package for a given 'ComponentId'.
-- The way this works is just by fiat'ing that every indefinite package's
-- unit key is precisely its component ID; and that they share uniques.
lookupComponentId :: DynFlags -&gt; ComponentId -&gt; Maybe PackageConfig
lookupComponentId dflags (ComponentId cid_fs) = lookupUDFM pkg_map cid_fs
  where
    PackageConfigMap pkg_map = pkgIdMap (pkgState dflags)
-}</span><span>
</span><a name="line-405"></a><span>
</span><a name="line-406"></a><span class="hs-comment">-- | Find the package we know about with the given package name (e.g. @foo@), if any</span><span>
</span><a name="line-407"></a><span class="hs-comment">-- (NB: there might be a locally defined unit name which overrides this)</span><span>
</span><a name="line-408"></a><span class="hs-identifier">lookupPackageName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageName"><span class="hs-identifier hs-type">PackageName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Module.html#ComponentId"><span class="hs-identifier hs-type">ComponentId</span></a><span>
</span><a name="line-409"></a><a name="lookupPackageName"><a href="Packages.html#lookupPackageName"><span class="hs-identifier">lookupPackageName</span></a></a><span> </span><a name="local-6989586621681219929"><a href="#local-6989586621681219929"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681219930"><a href="#local-6989586621681219930"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681219930"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">packageNameMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681219929"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-410"></a><span>
</span><a name="line-411"></a><span class="hs-comment">-- | Search for packages with a given package ID (e.g. \&quot;foo-0.1\&quot;)</span><span>
</span><a name="line-412"></a><span class="hs-identifier">searchPackageId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#SourcePackageId"><span class="hs-identifier hs-type">SourcePackageId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-413"></a><a name="searchPackageId"><a href="Packages.html#searchPackageId"><span class="hs-identifier">searchPackageId</span></a></a><span> </span><a name="local-6989586621681219931"><a href="#local-6989586621681219931"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681219932"><a href="#local-6989586621681219932"><span class="hs-identifier">pid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621681219932"><span class="hs-identifier hs-var">pid</span></a><span> </span><span class="hs-operator hs-var">==</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">sourcePackageId</span><span class="hs-special">)</span><span>
</span><a name="line-414"></a><span>                               </span><span class="hs-special">(</span><a href="Packages.html#listPackageConfigMap"><span class="hs-identifier hs-var">listPackageConfigMap</span></a><span> </span><a href="#local-6989586621681219931"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-415"></a><span>
</span><a name="line-416"></a><span class="hs-comment">-- | Extends the package configuration map with a list of package configs.</span><span>
</span><a name="line-417"></a><span class="hs-identifier">extendPackageConfigMap</span><span>
</span><a name="line-418"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-419"></a><a name="extendPackageConfigMap"><a href="Packages.html#extendPackageConfigMap"><span class="hs-identifier">extendPackageConfigMap</span></a></a><span> </span><span class="hs-special">(</span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><a name="local-6989586621681219933"><a href="#local-6989586621681219933"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681219934"><a href="#local-6989586621681219934"><span class="hs-identifier">closure</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681219935"><a href="#local-6989586621681219935"><span class="hs-identifier">new_pkgs</span></a></a><span>
</span><a name="line-420"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621681219936"><span class="hs-identifier hs-var">add</span></a><span> </span><a href="#local-6989586621681219933"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681219935"><span class="hs-identifier hs-var">new_pkgs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219934"><span class="hs-identifier hs-var">closure</span></a><span>
</span><a name="line-421"></a><span>    </span><span class="hs-comment">-- We also add the expanded version of the packageConfigId, so that</span><span>
</span><a name="line-422"></a><span>    </span><span class="hs-comment">-- 'improveUnitId' can find it.</span><span>
</span><a name="line-423"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681219936"><a href="#local-6989586621681219936"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621681219937"><a href="#local-6989586621681219937"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681219938"><a href="#local-6989586621681219938"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#addToUDFM"><span class="hs-identifier hs-var">addToUDFM</span></a><span> </span><span class="hs-special">(</span><a href="UniqDFM.html#addToUDFM"><span class="hs-identifier hs-var">addToUDFM</span></a><span> </span><a href="#local-6989586621681219937"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#expandedPackageConfigId"><span class="hs-identifier hs-var">expandedPackageConfigId</span></a><span> </span><a href="#local-6989586621681219938"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219938"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-424"></a><span>                                  </span><span class="hs-special">(</span><a href="PackageConfig.html#installedPackageConfigId"><span class="hs-identifier hs-var">installedPackageConfigId</span></a><span> </span><a href="#local-6989586621681219938"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219938"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span class="hs-comment">-- | Looks up the package with the given id in the package state, panicing if it is</span><span>
</span><a name="line-427"></a><span class="hs-comment">-- not found</span><span>
</span><a name="line-428"></a><span class="hs-identifier">getPackageDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-429"></a><a name="getPackageDetails"><a href="Packages.html#getPackageDetails"><span class="hs-identifier">getPackageDetails</span></a></a><span> </span><a name="local-6989586621681219939"><a href="#local-6989586621681219939"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681219940"><a href="#local-6989586621681219940"><span class="hs-identifier">pid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-430"></a><span>    </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;getPackageDetails&quot;</span><span> </span><span class="hs-special">(</span><a href="Packages.html#lookupPackage"><span class="hs-identifier hs-var">lookupPackage</span></a><span> </span><a href="#local-6989586621681219939"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681219940"><span class="hs-identifier hs-var">pid</span></a><span class="hs-special">)</span><span>
</span><a name="line-431"></a><span>
</span><a name="line-432"></a><span class="hs-identifier">lookupInstalledPackage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-433"></a><a name="lookupInstalledPackage"><a href="Packages.html#lookupInstalledPackage"><span class="hs-identifier">lookupInstalledPackage</span></a></a><span> </span><a name="local-6989586621681219941"><a href="#local-6989586621681219941"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681219942"><a href="#local-6989586621681219942"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#lookupInstalledPackage%27"><span class="hs-identifier hs-var">lookupInstalledPackage'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgIdMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681219941"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219942"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-434"></a><span>
</span><a name="line-435"></a><span class="hs-identifier">lookupInstalledPackage'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-436"></a><a name="lookupInstalledPackage%27"><a href="Packages.html#lookupInstalledPackage%27"><span class="hs-identifier">lookupInstalledPackage'</span></a></a><span> </span><span class="hs-special">(</span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><a name="local-6989586621681219943"><a href="#local-6989586621681219943"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><a name="local-6989586621681219944"><a href="#local-6989586621681219944"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621681219943"><span class="hs-identifier hs-var">db</span></a><span> </span><a href="#local-6989586621681219944"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-437"></a><span>
</span><a name="line-438"></a><span class="hs-identifier">getInstalledPackageDetails</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-439"></a><a name="getInstalledPackageDetails"><a href="Packages.html#getInstalledPackageDetails"><span class="hs-identifier">getInstalledPackageDetails</span></a></a><span> </span><a name="local-6989586621681219945"><a href="#local-6989586621681219945"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681219946"><a href="#local-6989586621681219946"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-440"></a><span>    </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;getInstalledPackageDetails&quot;</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-441"></a><span>        </span><a href="Packages.html#lookupInstalledPackage"><span class="hs-identifier hs-var">lookupInstalledPackage</span></a><span> </span><a href="#local-6989586621681219945"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681219946"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-comment">-- | Get a list of entries from the package database.  NB: be careful with</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- this function, although all packages in this map are &quot;visible&quot;, this</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- does not imply that the exposed-modules of the package are available</span><span>
</span><a name="line-446"></a><span class="hs-comment">-- (they may have been thinned or renamed).</span><span>
</span><a name="line-447"></a><span class="hs-identifier">listPackageConfigMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-448"></a><a name="listPackageConfigMap"><a href="Packages.html#listPackageConfigMap"><span class="hs-identifier">listPackageConfigMap</span></a></a><span> </span><a name="local-6989586621681219947"><a href="#local-6989586621681219947"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#eltsUDFM"><span class="hs-identifier hs-var">eltsUDFM</span></a><span> </span><a href="#local-6989586621681219948"><span class="hs-identifier hs-var">pkg_map</span></a><span>
</span><a name="line-449"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-450"></a><span>    </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-var">PackageConfigMap</span></a><span> </span><a name="local-6989586621681219948"><a href="#local-6989586621681219948"><span class="hs-identifier">pkg_map</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pkgIdMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681219947"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-453"></a><span class="hs-comment">-- Loading the package db files and building up the package state</span><span>
</span><a name="line-454"></a><span>
</span><a name="line-455"></a><span class="hs-comment">-- | Call this after 'DynFlags.parseDynFlags'.  It reads the package</span><span>
</span><a name="line-456"></a><span class="hs-comment">-- database files, and sets up various internal tables of package</span><span>
</span><a name="line-457"></a><span class="hs-comment">-- information, according to the package-related flags on the</span><span>
</span><a name="line-458"></a><span class="hs-comment">-- command-line (@-package@, @-hide-package@ etc.)</span><span>
</span><a name="line-459"></a><span class="hs-comment">--</span><span>
</span><a name="line-460"></a><span class="hs-comment">-- Returns a list of packages to link in if we're doing dynamic linking.</span><span>
</span><a name="line-461"></a><span class="hs-comment">-- This list contains the packages that the user explicitly mentioned with</span><span>
</span><a name="line-462"></a><span class="hs-comment">-- @-package@ flags.</span><span>
</span><a name="line-463"></a><span class="hs-comment">--</span><span>
</span><a name="line-464"></a><span class="hs-comment">-- 'initPackages' can be called again subsequently after updating the</span><span>
</span><a name="line-465"></a><span class="hs-comment">-- 'packageFlags' field of the 'DynFlags', and it will update the</span><span>
</span><a name="line-466"></a><span class="hs-comment">-- 'pkgState' in 'DynFlags' and return a list of packages to</span><span>
</span><a name="line-467"></a><span class="hs-comment">-- link in.</span><span>
</span><a name="line-468"></a><span class="hs-identifier">initPackages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-469"></a><a name="initPackages"><a href="Packages.html#initPackages"><span class="hs-identifier">initPackages</span></a></a><span> </span><a name="local-6989586621681219949"><a href="#local-6989586621681219949"><span class="hs-identifier">dflags0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-470"></a><span>  </span><a name="local-6989586621681219950"><a href="#local-6989586621681219950"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#interpretPackageEnv"><span class="hs-identifier hs-var">interpretPackageEnv</span></a><span> </span><a href="#local-6989586621681219949"><span class="hs-identifier hs-var">dflags0</span></a><span>
</span><a name="line-471"></a><span>  </span><a name="local-6989586621681219954"><a href="#local-6989586621681219954"><span class="hs-identifier">pkg_db</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-472"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">pkgDatabase</span><span> </span><a href="#local-6989586621681219950"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-473"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#readPackageConfigs"><span class="hs-identifier hs-var">readPackageConfigs</span></a><span> </span><a href="#local-6989586621681219950"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-474"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681219951"><a href="#local-6989586621681219951"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681219952"><a href="#local-6989586621681219952"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681219953"><a href="#local-6989586621681219953"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-475"></a><span>                                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219952"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#setBatchPackageFlags"><span class="hs-identifier hs-var">setBatchPackageFlags</span></a><span> </span><a href="#local-6989586621681219950"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681219953"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219951"><span class="hs-identifier hs-var">db</span></a><span>
</span><a name="line-476"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681219955"><a href="#local-6989586621681219955"><span class="hs-identifier">pkg_state</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681219956"><a href="#local-6989586621681219956"><span class="hs-identifier">preload</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681219957"><a href="#local-6989586621681219957"><span class="hs-identifier">insts</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-477"></a><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#mkPackageState"><span class="hs-identifier hs-var">mkPackageState</span></a><span> </span><a href="#local-6989586621681219950"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681219954"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219950"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">pkgDatabase</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681219954"><span class="hs-identifier hs-var">pkg_db</span></a><span class="hs-special">,</span><span>
</span><a name="line-479"></a><span>                  </span><span class="hs-identifier">pkgState</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219955"><span class="hs-identifier hs-var">pkg_state</span></a><span class="hs-special">,</span><span>
</span><a name="line-480"></a><span>                  </span><span class="hs-identifier">thisUnitIdInsts_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219957"><span class="hs-identifier hs-var">insts</span></a><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><a name="line-481"></a><span>          </span><a href="#local-6989586621681219956"><span class="hs-identifier hs-var">preload</span></a><span class="hs-special">)</span><span>
</span><a name="line-482"></a><span>
</span><a name="line-483"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-484"></a><span class="hs-comment">-- Reading the package database(s)</span><span>
</span><a name="line-485"></a><span>
</span><a name="line-486"></a><span class="hs-identifier">readPackageConfigs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-487"></a><a name="readPackageConfigs"><a href="Packages.html#readPackageConfigs"><span class="hs-identifier">readPackageConfigs</span></a></a><span> </span><a name="local-6989586621681219958"><a href="#local-6989586621681219958"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-488"></a><span>  </span><a name="local-6989586621681219959"><a href="#local-6989586621681219959"><span class="hs-identifier">conf_refs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#getPackageConfRefs"><span class="hs-identifier hs-var">getPackageConfRefs</span></a><span> </span><a href="#local-6989586621681219958"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-489"></a><span>  </span><a name="local-6989586621681219960"><a href="#local-6989586621681219960"><span class="hs-identifier">confs</span></a></a><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#resolvePackageConfig"><span class="hs-identifier hs-var">resolvePackageConfig</span></a><span> </span><a href="#local-6989586621681219958"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219959"><span class="hs-identifier hs-var">conf_refs</span></a><span>
</span><a name="line-490"></a><span>  </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#readPackageConfig"><span class="hs-identifier hs-var">readPackageConfig</span></a><span> </span><a href="#local-6989586621681219958"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681219960"><span class="hs-identifier hs-var">confs</span></a><span>
</span><a name="line-491"></a><span>
</span><a name="line-492"></a><span>
</span><a name="line-493"></a><span class="hs-identifier">getPackageConfRefs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="DynFlags.html#PkgConfRef"><span class="hs-identifier hs-type">PkgConfRef</span></a><span class="hs-special">]</span><span>
</span><a name="line-494"></a><a name="getPackageConfRefs"><a href="Packages.html#getPackageConfRefs"><span class="hs-identifier">getPackageConfRefs</span></a></a><span> </span><a name="local-6989586621681219961"><a href="#local-6989586621681219961"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-495"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681219969"><a href="#local-6989586621681219969"><span class="hs-identifier">system_conf_refs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="DynFlags.html#UserPkgConf"><span class="hs-identifier hs-var">UserPkgConf</span></a><span class="hs-special">,</span><span> </span><a href="DynFlags.html#GlobalPkgConf"><span class="hs-identifier hs-var">GlobalPkgConf</span></a><span class="hs-special">]</span><span>
</span><a name="line-496"></a><span>
</span><a name="line-497"></a><span>  </span><a name="local-6989586621681219970"><a href="#local-6989586621681219970"><span class="hs-identifier">e_pkg_path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Exception.html#tryIO"><span class="hs-identifier hs-var">tryIO</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getEnv</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">toUpper</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#programName"><span class="hs-identifier hs-var">programName</span></a><span> </span><a href="#local-6989586621681219961"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;_PACKAGE_PATH&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681219971"><a href="#local-6989586621681219971"><span class="hs-identifier">base_conf_refs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681219970"><span class="hs-identifier hs-var">e_pkg_path</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-499"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681219969"><span class="hs-identifier hs-var">system_conf_refs</span></a><span>
</span><a name="line-500"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681219972"><a href="#local-6989586621681219972"><span class="hs-identifier">path</span></a></a><span>
</span><a name="line-501"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681219972"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">isSearchPathSeparator</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">last</span><span> </span><a href="#local-6989586621681219972"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-502"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="DynFlags.html#PkgConfFile"><span class="hs-identifier hs-var">PkgConfFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">splitSearchPath</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">init</span><span> </span><a href="#local-6989586621681219972"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681219969"><span class="hs-identifier hs-var">system_conf_refs</span></a><span>
</span><a name="line-503"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-504"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="DynFlags.html#PkgConfFile"><span class="hs-identifier hs-var">PkgConfFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">splitSearchPath</span><span> </span><a href="#local-6989586621681219972"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-505"></a><span>
</span><a name="line-506"></a><span>  </span><span class="hs-comment">-- Apply the package DB-related flags from the command line to get the</span><span>
</span><a name="line-507"></a><span>  </span><span class="hs-comment">-- final list of package DBs.</span><span>
</span><a name="line-508"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-509"></a><span>  </span><span class="hs-comment">-- Notes on ordering:</span><span>
</span><a name="line-510"></a><span>  </span><span class="hs-comment">--  * The list of flags is reversed (later ones first)</span><span>
</span><a name="line-511"></a><span>  </span><span class="hs-comment">--  * We work with the package DB list in &quot;left shadows right&quot; order</span><span>
</span><a name="line-512"></a><span>  </span><span class="hs-comment">--  * and finally reverse it at the end, to get &quot;right shadows left&quot;</span><span>
</span><a name="line-513"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-514"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldr</span><span> </span><a href="#local-6989586621681219962"><span class="hs-identifier hs-var">doFlag</span></a><span> </span><a href="#local-6989586621681219971"><span class="hs-identifier hs-var">base_conf_refs</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">packageDBFlags</span><span> </span><a href="#local-6989586621681219961"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-515"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-516"></a><span>  </span><a name="local-6989586621681219962"><a href="#local-6989586621681219962"><span class="hs-identifier">doFlag</span></a></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PackageDB"><span class="hs-identifier hs-var">PackageDB</span></a><span> </span><a name="local-6989586621681219965"><a href="#local-6989586621681219965"><span class="hs-identifier">p</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681219966"><a href="#local-6989586621681219966"><span class="hs-identifier">dbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219965"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681219966"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-517"></a><span>  </span><span class="hs-identifier">doFlag</span><span> </span><a href="DynFlags.html#NoUserPackageDB"><span class="hs-identifier hs-var">NoUserPackageDB</span></a><span> </span><a name="local-6989586621681219967"><a href="#local-6989586621681219967"><span class="hs-identifier">dbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681219963"><span class="hs-identifier hs-var">isNotUser</span></a><span> </span><a href="#local-6989586621681219967"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-518"></a><span>  </span><span class="hs-identifier">doFlag</span><span> </span><a href="DynFlags.html#NoGlobalPackageDB"><span class="hs-identifier hs-var">NoGlobalPackageDB</span></a><span> </span><a name="local-6989586621681219968"><a href="#local-6989586621681219968"><span class="hs-identifier">dbs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681219964"><span class="hs-identifier hs-var">isNotGlobal</span></a><span> </span><a href="#local-6989586621681219968"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-519"></a><span>  </span><span class="hs-identifier">doFlag</span><span> </span><a href="DynFlags.html#ClearPackageDBs"><span class="hs-identifier hs-var">ClearPackageDBs</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-520"></a><span>
</span><a name="line-521"></a><span>  </span><a name="local-6989586621681219963"><a href="#local-6989586621681219963"><span class="hs-identifier">isNotUser</span></a></a><span> </span><a href="DynFlags.html#UserPkgConf"><span class="hs-identifier hs-var">UserPkgConf</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-522"></a><span>  </span><span class="hs-identifier">isNotUser</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-523"></a><span>
</span><a name="line-524"></a><span>  </span><a name="local-6989586621681219964"><a href="#local-6989586621681219964"><span class="hs-identifier">isNotGlobal</span></a></a><span> </span><a href="DynFlags.html#GlobalPkgConf"><span class="hs-identifier hs-var">GlobalPkgConf</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-525"></a><span>  </span><span class="hs-identifier">isNotGlobal</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-526"></a><span>
</span><a name="line-527"></a><span class="hs-identifier">resolvePackageConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#PkgConfRef"><span class="hs-identifier hs-type">PkgConfRef</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">)</span><span>
</span><a name="line-528"></a><a name="resolvePackageConfig"><a href="Packages.html#resolvePackageConfig"><span class="hs-identifier">resolvePackageConfig</span></a></a><span> </span><a name="local-6989586621681219973"><a href="#local-6989586621681219973"><span class="hs-identifier">dflags</span></a></a><span> </span><a href="DynFlags.html#GlobalPkgConf"><span class="hs-identifier hs-var">GlobalPkgConf</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#systemPackageConfig"><span class="hs-identifier hs-var">systemPackageConfig</span></a><span> </span><a href="#local-6989586621681219973"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-529"></a><span class="hs-comment">-- NB: This logic is reimplemented in Cabal, so if you change it,</span><span>
</span><a name="line-530"></a><span class="hs-comment">-- make sure you update Cabal.  (Or, better yet, dump it in the</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- compiler info so Cabal can use the info.)</span><span>
</span><a name="line-532"></a><span class="hs-identifier">resolvePackageConfig</span><span> </span><a name="local-6989586621681219974"><a href="#local-6989586621681219974"><span class="hs-identifier">dflags</span></a></a><span> </span><a href="DynFlags.html#UserPkgConf"><span class="hs-identifier hs-var">UserPkgConf</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">runMaybeT</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-533"></a><span>  </span><a name="local-6989586621681219975"><a href="#local-6989586621681219975"><span class="hs-identifier">dir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DynFlags.html#versionedAppDir"><span class="hs-identifier hs-var">versionedAppDir</span></a><span> </span><a href="#local-6989586621681219974"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-534"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681219976"><a href="#local-6989586621681219976"><span class="hs-identifier">pkgconf</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219975"><span class="hs-identifier hs-var">dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;package.conf.d&quot;</span><span>
</span><a name="line-535"></a><span>  </span><a name="local-6989586621681219977"><a href="#local-6989586621681219977"><span class="hs-identifier">exist</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Maybes.html#tryMaybeT"><span class="hs-identifier hs-var">tryMaybeT</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621681219976"><span class="hs-identifier hs-var">pkgconf</span></a><span>
</span><a name="line-536"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219977"><span class="hs-identifier hs-var">exist</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681219976"><span class="hs-identifier hs-var">pkgconf</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mzero</span><span>
</span><a name="line-537"></a><span class="hs-identifier">resolvePackageConfig</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PkgConfFile"><span class="hs-identifier hs-var">PkgConfFile</span></a><span> </span><a name="local-6989586621681219978"><a href="#local-6989586621681219978"><span class="hs-identifier">name</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681219978"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-538"></a><span>
</span><a name="line-539"></a><span class="hs-identifier">readPackageConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-540"></a><a name="readPackageConfig"><a href="Packages.html#readPackageConfig"><span class="hs-identifier">readPackageConfig</span></a></a><span> </span><a name="local-6989586621681219979"><a href="#local-6989586621681219979"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681219980"><a href="#local-6989586621681219980"><span class="hs-identifier">conf_file</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-541"></a><span>  </span><a name="local-6989586621681219990"><a href="#local-6989586621681219990"><span class="hs-identifier">isdir</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span>  </span><a name="local-6989586621681219994"><a href="#local-6989586621681219994"><span class="hs-identifier">proto_pkg_configs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-544"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219990"><span class="hs-identifier hs-var">isdir</span></a><span>
</span><a name="line-545"></a><span>       </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681219981"><span class="hs-identifier hs-var">readDirStylePackageConfig</span></a><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span>
</span><a name="line-546"></a><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-547"></a><span>            </span><a name="local-6989586621681219991"><a href="#local-6989586621681219991"><span class="hs-identifier">isfile</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span>
</span><a name="line-548"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219991"><span class="hs-identifier hs-var">isfile</span></a><span>
</span><a name="line-549"></a><span>               </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-550"></a><span>                 </span><a name="local-6989586621681219992"><a href="#local-6989586621681219992"><span class="hs-identifier">mpkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681219982"><span class="hs-identifier hs-var">tryReadOldFileStylePackageConfig</span></a><span>
</span><a name="line-551"></a><span>                 </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681219992"><span class="hs-identifier hs-var">mpkgs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-552"></a><span>                   </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681219993"><a href="#local-6989586621681219993"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681219993"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-553"></a><span>                   </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-554"></a><span>                      </span><span class="hs-string">&quot;ghc no longer supports single-file style package &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-555"></a><span>                      </span><span class="hs-string">&quot;databases (&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-556"></a><span>                      </span><span class="hs-string">&quot;) use 'ghc-pkg init' to create the database with &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-557"></a><span>                      </span><span class="hs-string">&quot;the correct format.&quot;</span><span>
</span><a name="line-558"></a><span>               </span><span class="hs-keyword">else</span><span> </span><a href="Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-559"></a><span>                      </span><span class="hs-string">&quot;can't find a package database at &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span>
</span><a name="line-560"></a><span>
</span><a name="line-561"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-562"></a><span>      </span><a name="local-6989586621681219995"><a href="#local-6989586621681219995"><span class="hs-identifier">top_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#topDir"><span class="hs-identifier hs-var">topDir</span></a><span> </span><a href="#local-6989586621681219979"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-563"></a><span>      </span><a name="local-6989586621681219996"><a href="#local-6989586621681219996"><span class="hs-identifier">pkgroot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span>
</span><a name="line-564"></a><span>      </span><a name="local-6989586621681219997"><a href="#local-6989586621681219997"><span class="hs-identifier">pkg_configs1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Packages.html#mungePackageConfig"><span class="hs-identifier hs-var">mungePackageConfig</span></a><span> </span><a href="#local-6989586621681219995"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><a href="#local-6989586621681219996"><span class="hs-identifier hs-var">pkgroot</span></a><span class="hs-special">)</span><span>
</span><a name="line-565"></a><span>                         </span><a href="#local-6989586621681219994"><span class="hs-identifier hs-var">proto_pkg_configs</span></a><span>
</span><a name="line-566"></a><span>      </span><a name="local-6989586621681219998"><a href="#local-6989586621681219998"><span class="hs-identifier">pkg_configs2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#setBatchPackageFlags"><span class="hs-identifier hs-var">setBatchPackageFlags</span></a><span> </span><a href="#local-6989586621681219979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681219997"><span class="hs-identifier hs-var">pkg_configs1</span></a><span>
</span><a name="line-567"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-568"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681219998"><span class="hs-identifier hs-var">pkg_configs2</span></a><span class="hs-special">)</span><span>
</span><a name="line-569"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-570"></a><span>    </span><a name="local-6989586621681219981"><a href="#local-6989586621681219981"><span class="hs-identifier">readDirStylePackageConfig</span></a></a><span> </span><a name="local-6989586621681219983"><a href="#local-6989586621681219983"><span class="hs-identifier">conf_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-571"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681219984"><a href="#local-6989586621681219984"><span class="hs-identifier">filename</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219983"><span class="hs-identifier hs-var">conf_dir</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-string">&quot;package.cache&quot;</span><span>
</span><a name="line-572"></a><span>      </span><a name="local-6989586621681219985"><a href="#local-6989586621681219985"><span class="hs-identifier">cache_exists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><a href="#local-6989586621681219984"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-573"></a><span>      </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219985"><span class="hs-identifier hs-var">cache_exists</span></a><span>
</span><a name="line-574"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-575"></a><span>          </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681219979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Using binary package database:&quot;</span><span>
</span><a name="line-576"></a><span>                                    </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681219984"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-577"></a><span>          </span><a href="GHC.PackageDb.html#readPackageDbForGhc"><span class="hs-identifier hs-var">readPackageDbForGhc</span></a><span> </span><a href="#local-6989586621681219984"><span class="hs-identifier hs-var">filename</span></a><span>
</span><a name="line-578"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-579"></a><span>          </span><span class="hs-comment">-- If there is no package.cache file, we check if the database is not</span><span>
</span><a name="line-580"></a><span>          </span><span class="hs-comment">-- empty by inspecting if the directory contains any .conf file. If it</span><span>
</span><a name="line-581"></a><span>          </span><span class="hs-comment">-- does, something is wrong and we fail. Otherwise we assume that the</span><span>
</span><a name="line-582"></a><span>          </span><span class="hs-comment">-- database is empty.</span><span>
</span><a name="line-583"></a><span>          </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681219979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;There is no package.cache in&quot;</span><span>
</span><a name="line-584"></a><span>                               </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681219983"><span class="hs-identifier hs-var">conf_dir</span></a><span>
</span><a name="line-585"></a><span>                                </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;, checking if the database is empty&quot;</span><span>
</span><a name="line-586"></a><span>          </span><a name="local-6989586621681219986"><a href="#local-6989586621681219986"><span class="hs-identifier">db_empty</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">isSuffixOf</span><span> </span><span class="hs-string">&quot;.conf&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-587"></a><span>                   </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">getDirectoryContents</span><span> </span><a href="#local-6989586621681219983"><span class="hs-identifier hs-var">conf_dir</span></a><span>
</span><a name="line-588"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219986"><span class="hs-identifier hs-var">db_empty</span></a><span>
</span><a name="line-589"></a><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-590"></a><span>              </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681219979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">3</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;There are no .conf files in&quot;</span><span>
</span><a name="line-591"></a><span>                                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681219983"><span class="hs-identifier hs-var">conf_dir</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;, treating&quot;</span><span>
</span><a name="line-592"></a><span>                                   </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;package database as empty&quot;</span><span>
</span><a name="line-593"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-594"></a><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-595"></a><span>              </span><a href="Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-596"></a><span>                </span><span class="hs-string">&quot;there is no package.cache in &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681219983"><span class="hs-identifier hs-var">conf_dir</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-597"></a><span>                </span><span class="hs-string">&quot; even though package database is not empty&quot;</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span>
</span><a name="line-600"></a><span>    </span><span class="hs-comment">-- Single-file style package dbs have been deprecated for some time, but</span><span>
</span><a name="line-601"></a><span>    </span><span class="hs-comment">-- it turns out that Cabal was using them in one place. So this is a</span><span>
</span><a name="line-602"></a><span>    </span><span class="hs-comment">-- workaround to allow older Cabal versions to use this newer ghc.</span><span>
</span><a name="line-603"></a><span>    </span><span class="hs-comment">-- We check if the file db contains just &quot;[]&quot; and if so, we look for a new</span><span>
</span><a name="line-604"></a><span>    </span><span class="hs-comment">-- dir-style db in conf_file.d/, ie in a dir next to the given file.</span><span>
</span><a name="line-605"></a><span>    </span><span class="hs-comment">-- We cannot just replace the file with a new dir style since Cabal still</span><span>
</span><a name="line-606"></a><span>    </span><span class="hs-comment">-- assumes it's a file and tries to overwrite with 'writeFile'.</span><span>
</span><a name="line-607"></a><span>    </span><span class="hs-comment">-- ghc-pkg also cooperates with this workaround.</span><span>
</span><a name="line-608"></a><span>    </span><a name="local-6989586621681219982"><a href="#local-6989586621681219982"><span class="hs-identifier">tryReadOldFileStylePackageConfig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-609"></a><span>      </span><a name="local-6989586621681219987"><a href="#local-6989586621681219987"><span class="hs-identifier">content</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span> </span><span class="hs-special">`</span><a href="Exception.html#catchIO"><span class="hs-identifier hs-var">catchIO</span></a><span class="hs-special">`</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-610"></a><span>      </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">take</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621681219987"><span class="hs-identifier hs-var">content</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-string">&quot;[]&quot;</span><span>
</span><a name="line-611"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-612"></a><span>          </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681219988"><a href="#local-6989586621681219988"><span class="hs-identifier">conf_dir</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681219980"><span class="hs-identifier hs-var">conf_file</span></a><span> </span><span class="hs-operator hs-var">&lt;.&gt;</span><span> </span><span class="hs-string">&quot;d&quot;</span><span>
</span><a name="line-613"></a><span>          </span><a name="local-6989586621681219989"><a href="#local-6989586621681219989"><span class="hs-identifier">direxists</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">doesDirectoryExist</span><span> </span><a href="#local-6989586621681219988"><span class="hs-identifier hs-var">conf_dir</span></a><span>
</span><a name="line-614"></a><span>          </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681219989"><span class="hs-identifier hs-var">direxists</span></a><span>
</span><a name="line-615"></a><span>             </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681219979"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;Ignoring old file-style db and trying:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681219988"><span class="hs-identifier hs-var">conf_dir</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><span>                     </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219981"><span class="hs-identifier hs-var">readDirStylePackageConfig</span></a><span> </span><a href="#local-6989586621681219988"><span class="hs-identifier hs-var">conf_dir</span></a><span class="hs-special">)</span><span>
</span><a name="line-617"></a><span>             </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ghc-pkg will create it when it's updated</span><span>
</span><a name="line-618"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-619"></a><span>
</span><a name="line-620"></a><span class="hs-identifier">setBatchPackageFlags</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-621"></a><a name="setBatchPackageFlags"><a href="Packages.html#setBatchPackageFlags"><span class="hs-identifier">setBatchPackageFlags</span></a></a><span> </span><a name="local-6989586621681219999"><a href="#local-6989586621681219999"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220000"><a href="#local-6989586621681220000"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220001"><span class="hs-identifier hs-var">maybeDistrustAll</span></a><span> </span><a href="#local-6989586621681220000"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-622"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-623"></a><span>    </span><a name="local-6989586621681220001"><a href="#local-6989586621681220001"><span class="hs-identifier">maybeDistrustAll</span></a></a><span> </span><a name="local-6989586621681220003"><a href="#local-6989586621681220003"><span class="hs-identifier">pkgs'</span></a></a><span>
</span><a name="line-624"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_DistrustAllPackages"><span class="hs-identifier hs-var">Opt_DistrustAllPackages</span></a><span> </span><a href="#local-6989586621681219999"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220002"><span class="hs-identifier hs-var">distrust</span></a><span> </span><a href="#local-6989586621681220003"><span class="hs-identifier hs-var">pkgs'</span></a><span>
</span><a name="line-625"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                           </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220003"><span class="hs-identifier hs-var">pkgs'</span></a><span>
</span><a name="line-626"></a><span>
</span><a name="line-627"></a><span>    </span><a name="local-6989586621681220002"><a href="#local-6989586621681220002"><span class="hs-identifier">distrust</span></a></a><span> </span><a name="local-6989586621681220004"><a href="#local-6989586621681220004"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220004"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">{</span><span> </span><span class="hs-identifier">trusted</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-628"></a><span>
</span><a name="line-629"></a><span class="hs-identifier">mungePackageConfig</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-630"></a><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-631"></a><a name="mungePackageConfig"><a href="Packages.html#mungePackageConfig"><span class="hs-identifier">mungePackageConfig</span></a></a><span> </span><a name="local-6989586621681220005"><a href="#local-6989586621681220005"><span class="hs-identifier">top_dir</span></a></a><span> </span><a name="local-6989586621681220006"><a href="#local-6989586621681220006"><span class="hs-identifier">pkgroot</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-632"></a><span>    </span><a href="Packages.html#mungeDynLibFields"><span class="hs-identifier hs-var">mungeDynLibFields</span></a><span>
</span><a name="line-633"></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Packages.html#mungePackagePaths"><span class="hs-identifier hs-var">mungePackagePaths</span></a><span> </span><a href="#local-6989586621681220005"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><a href="#local-6989586621681220006"><span class="hs-identifier hs-var">pkgroot</span></a><span>
</span><a name="line-634"></a><span>
</span><a name="line-635"></a><span class="hs-identifier">mungeDynLibFields</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-636"></a><a name="mungeDynLibFields"><a href="Packages.html#mungeDynLibFields"><span class="hs-identifier">mungeDynLibFields</span></a></a><span> </span><a name="local-6989586621681220007"><a href="#local-6989586621681220007"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-637"></a><span>    </span><a href="#local-6989586621681220007"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-638"></a><span>      </span><span class="hs-identifier">libraryDynDirs</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">libraryDynDirs</span><span> </span><a href="#local-6989586621681220007"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-639"></a><span>                </span><span class="hs-special">`</span><a href="#local-6989586621681220008"><span class="hs-identifier hs-var">orIfNull</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">libraryDirs</span><span> </span><a href="#local-6989586621681220007"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-640"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-641"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-642"></a><span>    </span><a name="local-6989586621681220008"><a href="#local-6989586621681220008"><span class="hs-identifier">orIfNull</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a name="local-6989586621681220009"><a href="#local-6989586621681220009"><span class="hs-identifier">flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220009"><span class="hs-identifier hs-var">flags</span></a><span>
</span><a name="line-643"></a><span>    </span><span class="hs-identifier">orIfNull</span><span> </span><a name="local-6989586621681220010"><a href="#local-6989586621681220010"><span class="hs-identifier">flags</span></a></a><span> </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220010"><span class="hs-identifier hs-var">flags</span></a><span>
</span><a name="line-644"></a><span>
</span><a name="line-645"></a><span class="hs-comment">-- TODO: This code is duplicated in utils/ghc-pkg/Main.hs</span><span>
</span><a name="line-646"></a><span class="hs-identifier">mungePackagePaths</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-647"></a><span class="hs-comment">-- Perform path/URL variable substitution as per the Cabal ${pkgroot} spec</span><span>
</span><a name="line-648"></a><span class="hs-comment">-- (http://www.haskell.org/pipermail/libraries/2009-May/011772.html)</span><span>
</span><a name="line-649"></a><span class="hs-comment">-- Paths/URLs can be relative to ${pkgroot} or ${pkgrooturl}.</span><span>
</span><a name="line-650"></a><span class="hs-comment">-- The &quot;pkgroot&quot; is the directory containing the package database.</span><span>
</span><a name="line-651"></a><span class="hs-comment">--</span><span>
</span><a name="line-652"></a><span class="hs-comment">-- Also perform a similar substitution for the older GHC-specific</span><span>
</span><a name="line-653"></a><span class="hs-comment">-- &quot;$topdir&quot; variable. The &quot;topdir&quot; is the location of the ghc</span><span>
</span><a name="line-654"></a><span class="hs-comment">-- installation (obtained from the -B option).</span><span>
</span><a name="line-655"></a><a name="mungePackagePaths"><a href="Packages.html#mungePackagePaths"><span class="hs-identifier">mungePackagePaths</span></a></a><span> </span><a name="local-6989586621681220011"><a href="#local-6989586621681220011"><span class="hs-identifier">top_dir</span></a></a><span> </span><a name="local-6989586621681220012"><a href="#local-6989586621681220012"><span class="hs-identifier">pkgroot</span></a></a><span> </span><a name="local-6989586621681220013"><a href="#local-6989586621681220013"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-656"></a><span>    </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-657"></a><span>      </span><span class="hs-identifier">importDirs</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220014"><span class="hs-identifier hs-var">munge_paths</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">importDirs</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-658"></a><span>      </span><span class="hs-identifier">includeDirs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220014"><span class="hs-identifier hs-var">munge_paths</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">includeDirs</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-659"></a><span>      </span><span class="hs-identifier">libraryDirs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220014"><span class="hs-identifier hs-var">munge_paths</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">libraryDirs</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-660"></a><span>      </span><span class="hs-identifier">libraryDynDirs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220014"><span class="hs-identifier hs-var">munge_paths</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">libraryDynDirs</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-661"></a><span>      </span><span class="hs-identifier">frameworkDirs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220014"><span class="hs-identifier hs-var">munge_paths</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">frameworkDirs</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-662"></a><span>      </span><span class="hs-identifier">haddockInterfaces</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220014"><span class="hs-identifier hs-var">munge_paths</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">haddockInterfaces</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-663"></a><span>      </span><span class="hs-identifier">haddockHTMLs</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220015"><span class="hs-identifier hs-var">munge_urls</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">haddockHTMLs</span><span> </span><a href="#local-6989586621681220013"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-664"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-665"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-666"></a><span>    </span><a name="local-6989586621681220014"><a href="#local-6989586621681220014"><span class="hs-identifier">munge_paths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220016"><span class="hs-identifier hs-var">munge_path</span></a><span>
</span><a name="line-667"></a><span>    </span><a name="local-6989586621681220015"><a href="#local-6989586621681220015"><span class="hs-identifier">munge_urls</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220017"><span class="hs-identifier hs-var">munge_url</span></a><span>
</span><a name="line-668"></a><span>
</span><a name="line-669"></a><span>    </span><a name="local-6989586621681220016"><a href="#local-6989586621681220016"><span class="hs-identifier">munge_path</span></a></a><span> </span><a name="local-6989586621681220020"><a href="#local-6989586621681220020"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-670"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220021"><a href="#local-6989586621681220021"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220019"><span class="hs-identifier hs-var">stripVarPrefix</span></a><span> </span><span class="hs-string">&quot;${pkgroot}&quot;</span><span> </span><a href="#local-6989586621681220020"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220012"><span class="hs-identifier hs-var">pkgroot</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220021"><span class="hs-identifier hs-var">p'</span></a><span>
</span><a name="line-671"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220022"><a href="#local-6989586621681220022"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220019"><span class="hs-identifier hs-var">stripVarPrefix</span></a><span> </span><span class="hs-string">&quot;$topdir&quot;</span><span>    </span><a href="#local-6989586621681220020"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220011"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220022"><span class="hs-identifier hs-var">p'</span></a><span>
</span><a name="line-672"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220020"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-673"></a><span>
</span><a name="line-674"></a><span>    </span><a name="local-6989586621681220017"><a href="#local-6989586621681220017"><span class="hs-identifier">munge_url</span></a></a><span> </span><a name="local-6989586621681220023"><a href="#local-6989586621681220023"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-675"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220024"><a href="#local-6989586621681220024"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220019"><span class="hs-identifier hs-var">stripVarPrefix</span></a><span> </span><span class="hs-string">&quot;${pkgrooturl}&quot;</span><span> </span><a href="#local-6989586621681220023"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220018"><span class="hs-identifier hs-var">toUrlPath</span></a><span> </span><a href="#local-6989586621681220012"><span class="hs-identifier hs-var">pkgroot</span></a><span> </span><a href="#local-6989586621681220024"><span class="hs-identifier hs-var">p'</span></a><span>
</span><a name="line-676"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220025"><a href="#local-6989586621681220025"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220019"><span class="hs-identifier hs-var">stripVarPrefix</span></a><span> </span><span class="hs-string">&quot;$httptopdir&quot;</span><span>   </span><a href="#local-6989586621681220023"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220018"><span class="hs-identifier hs-var">toUrlPath</span></a><span> </span><a href="#local-6989586621681220011"><span class="hs-identifier hs-var">top_dir</span></a><span> </span><a href="#local-6989586621681220025"><span class="hs-identifier hs-var">p'</span></a><span>
</span><a name="line-677"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                                   </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220023"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-678"></a><span>
</span><a name="line-679"></a><span>    </span><a name="local-6989586621681220018"><a href="#local-6989586621681220018"><span class="hs-identifier">toUrlPath</span></a></a><span> </span><a name="local-6989586621681220026"><a href="#local-6989586621681220026"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621681220027"><a href="#local-6989586621681220027"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;file:///&quot;</span><span>
</span><a name="line-680"></a><span>                 </span><span class="hs-comment">-- URLs always use posix style '/' separators:</span><span>
</span><a name="line-681"></a><span>                 </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">FilePath.Posix.joinPath</span><span>
</span><a name="line-682"></a><span>                        </span><span class="hs-special">(</span><a href="#local-6989586621681220026"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-comment">-- We need to drop a leading &quot;/&quot; or &quot;\\&quot;</span><span>
</span><a name="line-683"></a><span>                             </span><span class="hs-comment">-- if there is one:</span><span>
</span><a name="line-684"></a><span>                             </span><span class="hs-identifier hs-var">dropWhile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><span class="hs-identifier hs-var">isPathSeparator</span><span class="hs-special">)</span><span>
</span><a name="line-685"></a><span>                                       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FilePath.splitDirectories</span><span> </span><a href="#local-6989586621681220027"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-686"></a><span>
</span><a name="line-687"></a><span>    </span><span class="hs-comment">-- We could drop the separator here, and then use &lt;/&gt; above. However,</span><span>
</span><a name="line-688"></a><span>    </span><span class="hs-comment">-- by leaving it in and using ++ we keep the same path separator</span><span>
</span><a name="line-689"></a><span>    </span><span class="hs-comment">-- rather than letting FilePath change it to use \ as the separator</span><span>
</span><a name="line-690"></a><span>    </span><a name="local-6989586621681220019"><a href="#local-6989586621681220019"><span class="hs-identifier">stripVarPrefix</span></a></a><span> </span><a name="local-6989586621681220028"><a href="#local-6989586621681220028"><span class="hs-identifier">var</span></a></a><span> </span><a name="local-6989586621681220029"><a href="#local-6989586621681220029"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">stripPrefix</span><span> </span><a href="#local-6989586621681220028"><span class="hs-identifier hs-var">var</span></a><span> </span><a href="#local-6989586621681220029"><span class="hs-identifier hs-var">path</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-691"></a><span>                              </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-692"></a><span>                              </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220030"><a href="#local-6989586621681220030"><span class="hs-identifier">cs</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a name="local-6989586621681220031"><a href="#local-6989586621681220031"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">isPathSeparator</span><span> </span><a href="#local-6989586621681220031"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681220030"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-693"></a><span>                              </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-694"></a><span>
</span><a name="line-695"></a><span>
</span><a name="line-696"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-697"></a><span class="hs-comment">-- Modify our copy of the package database based on trust flags,</span><span>
</span><a name="line-698"></a><span class="hs-comment">-- -trust and -distrust.</span><span>
</span><a name="line-699"></a><span>
</span><a name="line-700"></a><span class="hs-identifier">applyTrustFlag</span><span>
</span><a name="line-701"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-702"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span>
</span><a name="line-703"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span>
</span><a name="line-704"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-705"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#TrustFlag"><span class="hs-identifier hs-type">TrustFlag</span></a><span>
</span><a name="line-706"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-707"></a><a name="applyTrustFlag"><a href="Packages.html#applyTrustFlag"><span class="hs-identifier">applyTrustFlag</span></a></a><span> </span><a name="local-6989586621681220032"><a href="#local-6989586621681220032"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220033"><a href="#local-6989586621681220033"><span class="hs-identifier">prec_map</span></a></a><span> </span><a name="local-6989586621681220034"><a href="#local-6989586621681220034"><span class="hs-identifier">unusable</span></a></a><span> </span><a name="local-6989586621681220035"><a href="#local-6989586621681220035"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621681220036"><a href="#local-6989586621681220036"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-708"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220036"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-709"></a><span>    </span><span class="hs-comment">-- we trust all matching packages. Maybe should only trust first one?</span><span>
</span><a name="line-710"></a><span>    </span><span class="hs-comment">-- and leave others the same or set them untrusted</span><span>
</span><a name="line-711"></a><span>    </span><a href="DynFlags.html#TrustPackage"><span class="hs-identifier hs-var">TrustPackage</span></a><span> </span><a name="local-6989586621681220037"><a href="#local-6989586621681220037"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-712"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#selectPackages"><span class="hs-identifier hs-var">selectPackages</span></a><span> </span><a href="#local-6989586621681220033"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-var">PackageArg</span></a><span> </span><a href="#local-6989586621681220037"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220035"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><a href="#local-6989586621681220034"><span class="hs-identifier hs-var">unusable</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-713"></a><span>         </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681220038"><a href="#local-6989586621681220038"><span class="hs-identifier">ps</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#trustFlagErr"><span class="hs-identifier hs-var">trustFlagErr</span></a><span> </span><a href="#local-6989586621681220032"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220036"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681220038"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-714"></a><span>         </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220039"><a href="#local-6989586621681220039"><span class="hs-identifier">ps</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220040"><a href="#local-6989586621681220040"><span class="hs-identifier">qs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220041"><span class="hs-identifier hs-var">trust</span></a><span> </span><a href="#local-6989586621681220039"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220040"><span class="hs-identifier hs-var">qs</span></a><span class="hs-special">)</span><span>
</span><a name="line-715"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220041"><a href="#local-6989586621681220041"><span class="hs-identifier">trust</span></a></a><span> </span><a name="local-6989586621681220042"><a href="#local-6989586621681220042"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220042"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">trusted</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">True</span><span class="hs-special">}</span><span>
</span><a name="line-716"></a><span>
</span><a name="line-717"></a><span>    </span><a href="DynFlags.html#DistrustPackage"><span class="hs-identifier hs-var">DistrustPackage</span></a><span> </span><a name="local-6989586621681220043"><a href="#local-6989586621681220043"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-718"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#selectPackages"><span class="hs-identifier hs-var">selectPackages</span></a><span> </span><a href="#local-6989586621681220033"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-var">PackageArg</span></a><span> </span><a href="#local-6989586621681220043"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220035"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><a href="#local-6989586621681220034"><span class="hs-identifier hs-var">unusable</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-719"></a><span>         </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681220044"><a href="#local-6989586621681220044"><span class="hs-identifier">ps</span></a></a><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#trustFlagErr"><span class="hs-identifier hs-var">trustFlagErr</span></a><span> </span><a href="#local-6989586621681220032"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220036"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681220044"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-720"></a><span>         </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220045"><a href="#local-6989586621681220045"><span class="hs-identifier">ps</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220046"><a href="#local-6989586621681220046"><span class="hs-identifier">qs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220047"><span class="hs-identifier hs-var">distrust</span></a><span> </span><a href="#local-6989586621681220045"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220046"><span class="hs-identifier hs-var">qs</span></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220047"><a href="#local-6989586621681220047"><span class="hs-identifier">distrust</span></a></a><span> </span><a name="local-6989586621681220048"><a href="#local-6989586621681220048"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220048"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">{</span><span class="hs-identifier">trusted</span><span class="hs-glyph">=</span><span class="hs-identifier hs-var">False</span><span class="hs-special">}</span><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span class="hs-comment">-- | A little utility to tell if the 'thisPackage' is indefinite</span><span>
</span><a name="line-724"></a><span class="hs-comment">-- (if it is not, we should never use on-the-fly renaming.)</span><span>
</span><a name="line-725"></a><span class="hs-identifier">isIndefinite</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-726"></a><a name="isIndefinite"><a href="Packages.html#isIndefinite"><span class="hs-identifier">isIndefinite</span></a></a><span> </span><a name="local-6989586621681220049"><a href="#local-6989586621681220049"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="Module.html#unitIdIsDefinite"><span class="hs-identifier hs-var">unitIdIsDefinite</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#thisPackage"><span class="hs-identifier hs-var">thisPackage</span></a><span> </span><a href="#local-6989586621681220049"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-727"></a><span>
</span><a name="line-728"></a><span class="hs-identifier">applyPackageFlag</span><span>
</span><a name="line-729"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-730"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span>
</span><a name="line-731"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-732"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span>
</span><a name="line-733"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-comment">-- if False, if you expose a package, it implicitly hides</span><span>
</span><a name="line-734"></a><span>           </span><span class="hs-comment">-- any previously exposed packages with the same name</span><span>
</span><a name="line-735"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-736"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#VisibilityMap"><span class="hs-identifier hs-type">VisibilityMap</span></a><span>           </span><span class="hs-comment">-- Initially exposed</span><span>
</span><a name="line-737"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#PackageFlag"><span class="hs-identifier hs-type">PackageFlag</span></a><span>               </span><span class="hs-comment">-- flag to apply</span><span>
</span><a name="line-738"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="Packages.html#VisibilityMap"><span class="hs-identifier hs-type">VisibilityMap</span></a><span>        </span><span class="hs-comment">-- Now exposed</span><span>
</span><a name="line-739"></a><span>
</span><a name="line-740"></a><a name="applyPackageFlag"><a href="Packages.html#applyPackageFlag"><span class="hs-identifier">applyPackageFlag</span></a></a><span> </span><a name="local-6989586621681220050"><a href="#local-6989586621681220050"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220051"><a href="#local-6989586621681220051"><span class="hs-identifier">prec_map</span></a></a><span> </span><a name="local-6989586621681220052"><a href="#local-6989586621681220052"><span class="hs-identifier">pkg_db</span></a></a><span> </span><a name="local-6989586621681220053"><a href="#local-6989586621681220053"><span class="hs-identifier">unusable</span></a></a><span> </span><a name="local-6989586621681220054"><a href="#local-6989586621681220054"><span class="hs-identifier">no_hide_others</span></a></a><span> </span><a name="local-6989586621681220055"><a href="#local-6989586621681220055"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621681220056"><a href="#local-6989586621681220056"><span class="hs-identifier">vm</span></a></a><span> </span><a name="local-6989586621681220057"><a href="#local-6989586621681220057"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-741"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220057"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-742"></a><span>    </span><a href="DynFlags.html#ExposePackage"><span class="hs-identifier hs-var">ExposePackage</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681220058"><a href="#local-6989586621681220058"><span class="hs-identifier">arg</span></a></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#ModRenaming"><span class="hs-identifier hs-var">ModRenaming</span></a><span> </span><a name="local-6989586621681220059"><a href="#local-6989586621681220059"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621681220060"><a href="#local-6989586621681220060"><span class="hs-identifier">rns</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-743"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#findPackages"><span class="hs-identifier hs-var">findPackages</span></a><span> </span><a href="#local-6989586621681220051"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220052"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><a href="#local-6989586621681220058"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621681220055"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><a href="#local-6989586621681220053"><span class="hs-identifier hs-var">unusable</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-744"></a><span>         </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681220061"><a href="#local-6989586621681220061"><span class="hs-identifier">ps</span></a></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#packageFlagErr"><span class="hs-identifier hs-var">packageFlagErr</span></a><span> </span><a href="#local-6989586621681220050"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220057"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681220061"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-745"></a><span>         </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220062"><a href="#local-6989586621681220062"><span class="hs-identifier">p</span></a></a><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681220067"><span class="hs-identifier hs-var">vm'</span></a><span>
</span><a name="line-746"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-747"></a><span>           </span><a name="local-6989586621681220063"><a href="#local-6989586621681220063"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#fsPackageName"><span class="hs-identifier hs-var">fsPackageName</span></a><span> </span><a href="#local-6989586621681220062"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-748"></a><span>
</span><a name="line-749"></a><span>           </span><span class="hs-comment">-- If a user says @-unit-id p[A=&lt;A&gt;]@, this imposes</span><span>
</span><a name="line-750"></a><span>           </span><span class="hs-comment">-- a requirement on us: whatever our signature A is,</span><span>
</span><a name="line-751"></a><span>           </span><span class="hs-comment">-- it must fulfill all of p[A=&lt;A&gt;]:A's requirements.</span><span>
</span><a name="line-752"></a><span>           </span><span class="hs-comment">-- This method is responsible for computing what our</span><span>
</span><a name="line-753"></a><span>           </span><span class="hs-comment">-- inherited requirements are.</span><span>
</span><a name="line-754"></a><span>           </span><a name="local-6989586621681220064"><a href="#local-6989586621681220064"><span class="hs-identifier">reqs</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#UnitIdArg"><span class="hs-identifier hs-var">UnitIdArg</span></a><span> </span><a name="local-6989586621681220069"><a href="#local-6989586621681220069"><span class="hs-identifier">orig_uid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220058"><span class="hs-identifier hs-var">arg</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220065"><span class="hs-identifier hs-var">collectHoles</span></a><span> </span><a href="#local-6989586621681220069"><span class="hs-identifier hs-var">orig_uid</span></a><span>
</span><a name="line-755"></a><span>                </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-756"></a><span>
</span><a name="line-757"></a><span>           </span><a name="local-6989586621681220065"><a href="#local-6989586621681220065"><span class="hs-identifier">collectHoles</span></a></a><span> </span><a name="local-6989586621681220070"><a href="#local-6989586621681220070"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Module.html#splitUnitIdInsts"><span class="hs-identifier hs-var">splitUnitIdInsts</span></a><span> </span><a href="#local-6989586621681220070"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-758"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220071"><a href="#local-6989586621681220071"><span class="hs-identifier">indef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-759"></a><span>                  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220072"><a href="#local-6989586621681220072"><span class="hs-identifier">local</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">Map.singleton</span><span>
</span><a name="line-760"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621681220075"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-761"></a><span>                                  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.singleton</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Module.html#IndefModule"><span class="hs-identifier hs-var">IndefModule</span></a><span> </span><a href="#local-6989586621681220071"><span class="hs-identifier hs-var">indef</span></a><span> </span><a href="#local-6989586621681220074"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">)</span><span>
</span><a name="line-762"></a><span>                              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220074"><a href="#local-6989586621681220074"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220075"><a href="#local-6989586621681220075"><span class="hs-identifier">mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><a href="#local-6989586621681220071"><span class="hs-identifier hs-var">indef</span></a><span>
</span><a name="line-763"></a><span>                              </span><span class="hs-special">,</span><span> </span><a href="Module.html#isHoleModule"><span class="hs-identifier hs-var">isHoleModule</span></a><span> </span><a href="#local-6989586621681220075"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-764"></a><span>                      </span><a name="local-6989586621681220073"><a href="#local-6989586621681220073"><span class="hs-identifier">recurse</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681220065"><span class="hs-identifier hs-var">collectHoles</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681220076"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-765"></a><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220076"><a href="#local-6989586621681220076"><span class="hs-identifier">mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><a href="#local-6989586621681220071"><span class="hs-identifier hs-var">indef</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-766"></a><span>                  </span><span class="hs-keyword">in</span><span> </span><span class="hs-identifier hs-var">Map.unionsWith</span><span> </span><span class="hs-identifier hs-var">Set.union</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681220072"><span class="hs-identifier hs-var">local</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220073"><span class="hs-identifier hs-var">recurse</span></a><span>
</span><a name="line-767"></a><span>                </span><span class="hs-comment">-- Other types of unit identities don't have holes</span><span>
</span><a name="line-768"></a><span>                </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>
</span><a name="line-771"></a><span>           </span><a name="local-6989586621681220066"><a href="#local-6989586621681220066"><span class="hs-identifier">uv</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-var">UnitVisibility</span></a><span>
</span><a name="line-772"></a><span>                </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uv_expose_all</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220059"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-773"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_renamings</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220060"><span class="hs-identifier hs-var">rns</span></a><span>
</span><a name="line-774"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_package_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681220063"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span>
</span><a name="line-775"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_requirements</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220064"><span class="hs-identifier hs-var">reqs</span></a><span>
</span><a name="line-776"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-777"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-778"></a><span>           </span><a name="local-6989586621681220067"><a href="#local-6989586621681220067"><span class="hs-identifier">vm'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insertWith</span><span> </span><span class="hs-identifier hs-var">mappend</span><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220062"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220066"><span class="hs-identifier hs-var">uv</span></a><span> </span><a href="#local-6989586621681220068"><span class="hs-identifier hs-var">vm_cleared</span></a><span>
</span><a name="line-779"></a><span>           </span><span class="hs-comment">-- In the old days, if you said `ghc -package p-0.1 -package p-0.2`</span><span>
</span><a name="line-780"></a><span>           </span><span class="hs-comment">-- (or if p-0.1 was registered in the pkgdb as exposed: True),</span><span>
</span><a name="line-781"></a><span>           </span><span class="hs-comment">-- the second package flag would override the first one and you</span><span>
</span><a name="line-782"></a><span>           </span><span class="hs-comment">-- would only see p-0.2 in exposed modules.  This is good for</span><span>
</span><a name="line-783"></a><span>           </span><span class="hs-comment">-- usability.</span><span>
</span><a name="line-784"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-785"></a><span>           </span><span class="hs-comment">-- However, with thinning and renaming (or Backpack), there might be</span><span>
</span><a name="line-786"></a><span>           </span><span class="hs-comment">-- situations where you legitimately want to see two versions of a</span><span>
</span><a name="line-787"></a><span>           </span><span class="hs-comment">-- package at the same time, and this behavior would make it</span><span>
</span><a name="line-788"></a><span>           </span><span class="hs-comment">-- impossible to do so.  So we decided that if you pass</span><span>
</span><a name="line-789"></a><span>           </span><span class="hs-comment">-- -hide-all-packages, this should turn OFF the overriding behavior</span><span>
</span><a name="line-790"></a><span>           </span><span class="hs-comment">-- where an exposed package hides all other packages with the same</span><span>
</span><a name="line-791"></a><span>           </span><span class="hs-comment">-- name.  This should not affect Cabal at all, which only ever</span><span>
</span><a name="line-792"></a><span>           </span><span class="hs-comment">-- exposes one package at a time.</span><span>
</span><a name="line-793"></a><span>           </span><span class="hs-comment">--</span><span>
</span><a name="line-794"></a><span>           </span><span class="hs-comment">-- NB: Why a variable no_hide_others?  We have to apply this logic to</span><span>
</span><a name="line-795"></a><span>           </span><span class="hs-comment">-- -plugin-package too, and it's more consistent if the switch in</span><span>
</span><a name="line-796"></a><span>           </span><span class="hs-comment">-- behavior is based off of</span><span>
</span><a name="line-797"></a><span>           </span><span class="hs-comment">-- -hide-all-packages/-hide-all-plugin-packages depending on what</span><span>
</span><a name="line-798"></a><span>           </span><span class="hs-comment">-- flag is in question.</span><span>
</span><a name="line-799"></a><span>           </span><a name="local-6989586621681220068"><a href="#local-6989586621681220068"><span class="hs-identifier">vm_cleared</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681220054"><span class="hs-identifier hs-var">no_hide_others</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220056"><span class="hs-identifier hs-var">vm</span></a><span>
</span><a name="line-800"></a><span>                      </span><span class="hs-comment">-- NB: renamings never clear</span><span>
</span><a name="line-801"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220060"><span class="hs-identifier hs-var">rns</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220056"><span class="hs-identifier hs-var">vm</span></a><span>
</span><a name="line-802"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.filterWithKey</span><span>
</span><a name="line-803"></a><span>                            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681220077"><a href="#local-6989586621681220077"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621681220078"><a href="#local-6989586621681220078"><span class="hs-identifier">uv</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220077"><span class="hs-identifier hs-var">k</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220062"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-804"></a><span>                                   </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681220063"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">uv_package_name</span><span> </span><a href="#local-6989586621681220078"><span class="hs-identifier hs-var">uv</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220056"><span class="hs-identifier hs-var">vm</span></a><span>
</span><a name="line-805"></a><span>         </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PlainPanic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-string">&quot;applyPackageFlag&quot;</span><span>
</span><a name="line-806"></a><span>
</span><a name="line-807"></a><span>    </span><a href="DynFlags.html#HidePackage"><span class="hs-identifier hs-var">HidePackage</span></a><span> </span><a name="local-6989586621681220079"><a href="#local-6989586621681220079"><span class="hs-identifier">str</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-808"></a><span>       </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#findPackages"><span class="hs-identifier hs-var">findPackages</span></a><span> </span><a href="#local-6989586621681220051"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220052"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-var">PackageArg</span></a><span> </span><a href="#local-6989586621681220079"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220055"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><a href="#local-6989586621681220053"><span class="hs-identifier hs-var">unusable</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-809"></a><span>         </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621681220080"><a href="#local-6989586621681220080"><span class="hs-identifier">ps</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#packageFlagErr"><span class="hs-identifier hs-var">packageFlagErr</span></a><span> </span><a href="#local-6989586621681220050"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220057"><span class="hs-identifier hs-var">flag</span></a><span> </span><a href="#local-6989586621681220080"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-810"></a><span>         </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621681220081"><a href="#local-6989586621681220081"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681220082"><span class="hs-identifier hs-var">vm'</span></a><span>
</span><a name="line-811"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220082"><a href="#local-6989586621681220082"><span class="hs-identifier">vm'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">Map.delete</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220056"><span class="hs-identifier hs-var">vm</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220081"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-812"></a><span>
</span><a name="line-813"></a><span class="hs-comment">-- | Like 'selectPackages', but doesn't return a list of unmatched</span><span>
</span><a name="line-814"></a><span class="hs-comment">-- packages.  Furthermore, any packages it returns are *renamed*</span><span>
</span><a name="line-815"></a><span class="hs-comment">-- if the 'UnitArg' has a renaming associated with it.</span><span>
</span><a name="line-816"></a><span class="hs-identifier">findPackages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span>
</span><a name="line-817"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-type">PackageArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-818"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span>
</span><a name="line-819"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-820"></a><span>                </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-821"></a><a name="findPackages"><a href="Packages.html#findPackages"><span class="hs-identifier">findPackages</span></a></a><span> </span><a name="local-6989586621681220083"><a href="#local-6989586621681220083"><span class="hs-identifier">prec_map</span></a></a><span> </span><a name="local-6989586621681220084"><a href="#local-6989586621681220084"><span class="hs-identifier">pkg_db</span></a></a><span> </span><a name="local-6989586621681220085"><a href="#local-6989586621681220085"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621681220086"><a href="#local-6989586621681220086"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621681220087"><a href="#local-6989586621681220087"><span class="hs-identifier">unusable</span></a></a><span>
</span><a name="line-822"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220096"><a href="#local-6989586621681220096"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220088"><span class="hs-identifier hs-var">finder</span></a><span> </span><a href="#local-6989586621681220085"><span class="hs-identifier hs-var">arg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220086"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-823"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681220096"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-824"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mapMaybe</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681220097"><a href="#local-6989586621681220097"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220098"><a href="#local-6989586621681220098"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220088"><span class="hs-identifier hs-var">finder</span></a><span> </span><a href="#local-6989586621681220085"><span class="hs-identifier hs-var">arg</span></a><span> </span><a href="#local-6989586621681220097"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681220099"><a href="#local-6989586621681220099"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220099"><span class="hs-identifier hs-var">x'</span></a><span class="hs-special">,</span><a href="#local-6989586621681220098"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-825"></a><span>                            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220087"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-826"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="Packages.html#sortByPreference"><span class="hs-identifier hs-var">sortByPreference</span></a><span> </span><a href="#local-6989586621681220083"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220096"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-827"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-828"></a><span>    </span><a name="local-6989586621681220088"><a href="#local-6989586621681220088"><span class="hs-identifier">finder</span></a></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-var">PackageArg</span></a><span> </span><a name="local-6989586621681220089"><a href="#local-6989586621681220089"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681220090"><a href="#local-6989586621681220090"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-829"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681220089"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#sourcePackageIdString"><span class="hs-identifier hs-var">sourcePackageIdString</span></a><span> </span><a href="#local-6989586621681220090"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681220089"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span> </span><a href="#local-6989586621681220090"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-830"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681220090"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-831"></a><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-832"></a><span>    </span><span class="hs-identifier">finder</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#UnitIdArg"><span class="hs-identifier hs-var">UnitIdArg</span></a><span> </span><a name="local-6989586621681220091"><a href="#local-6989586621681220091"><span class="hs-identifier">uid</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681220092"><a href="#local-6989586621681220092"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-833"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220093"><a href="#local-6989586621681220093"><span class="hs-identifier">iuid</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220094"><a href="#local-6989586621681220094"><span class="hs-identifier">mb_indef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#splitUnitIdInsts"><span class="hs-identifier hs-var">splitUnitIdInsts</span></a><span> </span><a href="#local-6989586621681220091"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-834"></a><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681220093"><span class="hs-identifier hs-var">iuid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#installedPackageConfigId"><span class="hs-identifier hs-var">installedPackageConfigId</span></a><span> </span><a href="#local-6989586621681220092"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-835"></a><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220094"><span class="hs-identifier hs-var">mb_indef</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-836"></a><span>                            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220092"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-837"></a><span>                            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220095"><a href="#local-6989586621681220095"><span class="hs-identifier">indef</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#renamePackage"><span class="hs-identifier hs-var">renamePackage</span></a><span> </span><a href="#local-6989586621681220084"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><a href="#local-6989586621681220095"><span class="hs-identifier hs-var">indef</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220092"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-838"></a><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-839"></a><span>
</span><a name="line-840"></a><span class="hs-identifier">selectPackages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-type">PackageArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-841"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span>
</span><a name="line-842"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-843"></a><span>                  </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-844"></a><a name="selectPackages"><a href="Packages.html#selectPackages"><span class="hs-identifier">selectPackages</span></a></a><span> </span><a name="local-6989586621681220100"><a href="#local-6989586621681220100"><span class="hs-identifier">prec_map</span></a></a><span> </span><a name="local-6989586621681220101"><a href="#local-6989586621681220101"><span class="hs-identifier">arg</span></a></a><span> </span><a name="local-6989586621681220102"><a href="#local-6989586621681220102"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621681220103"><a href="#local-6989586621681220103"><span class="hs-identifier">unusable</span></a></a><span>
</span><a name="line-845"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220104"><a href="#local-6989586621681220104"><span class="hs-identifier">matches</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#matching"><span class="hs-identifier hs-var">matching</span></a><span> </span><a href="#local-6989586621681220101"><span class="hs-identifier hs-var">arg</span></a><span>
</span><a name="line-846"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621681220105"><a href="#local-6989586621681220105"><span class="hs-identifier">ps</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220106"><a href="#local-6989586621681220106"><span class="hs-identifier">rest</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><a href="#local-6989586621681220104"><span class="hs-identifier hs-var">matches</span></a><span> </span><a href="#local-6989586621681220102"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-847"></a><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681220105"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-848"></a><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220104"><span class="hs-identifier hs-var">matches</span></a><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220103"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-849"></a><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><a href="Packages.html#sortByPreference"><span class="hs-identifier hs-var">sortByPreference</span></a><span> </span><a href="#local-6989586621681220100"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220105"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220106"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-850"></a><span>
</span><a name="line-851"></a><span class="hs-comment">-- | Rename a 'PackageConfig' according to some module instantiation.</span><span>
</span><a name="line-852"></a><span class="hs-identifier">renamePackage</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-853"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-854"></a><a name="renamePackage"><a href="Packages.html#renamePackage"><span class="hs-identifier">renamePackage</span></a></a><span> </span><a name="local-6989586621681220107"><a href="#local-6989586621681220107"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681220108"><a href="#local-6989586621681220108"><span class="hs-identifier">insts</span></a></a><span> </span><a name="local-6989586621681220109"><a href="#local-6989586621681220109"><span class="hs-identifier">conf</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-855"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220110"><a href="#local-6989586621681220110"><span class="hs-identifier">hsubst</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#listToUFM"><span class="hs-identifier hs-var">listToUFM</span></a><span> </span><a href="#local-6989586621681220108"><span class="hs-identifier hs-var">insts</span></a><span>
</span><a name="line-856"></a><span>        </span><a name="local-6989586621681220111"><a href="#local-6989586621681220111"><span class="hs-identifier">smod</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#renameHoleModule%27"><span class="hs-identifier hs-var">renameHoleModule'</span></a><span> </span><a href="#local-6989586621681220107"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681220110"><span class="hs-identifier hs-var">hsubst</span></a><span>
</span><a name="line-857"></a><span>        </span><a name="local-6989586621681220112"><a href="#local-6989586621681220112"><span class="hs-identifier">new_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681220113"><a href="#local-6989586621681220113"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220114"><a href="#local-6989586621681220114"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220113"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><a href="#local-6989586621681220111"><span class="hs-identifier hs-var">smod</span></a><span> </span><a href="#local-6989586621681220114"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">instantiatedWith</span><span> </span><a href="#local-6989586621681220109"><span class="hs-identifier hs-var">conf</span></a><span class="hs-special">)</span><span>
</span><a name="line-858"></a><span>    </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621681220109"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-859"></a><span>        </span><span class="hs-identifier">instantiatedWith</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220112"><span class="hs-identifier hs-var">new_insts</span></a><span class="hs-special">,</span><span>
</span><a name="line-860"></a><span>        </span><span class="hs-identifier">exposedModules</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681220115"><a href="#local-6989586621681220115"><span class="hs-identifier">mod_name</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220116"><a href="#local-6989586621681220116"><span class="hs-identifier">mb_mod</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220115"><span class="hs-identifier hs-var">mod_name</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="#local-6989586621681220111"><span class="hs-identifier hs-var">smod</span></a><span> </span><a href="#local-6989586621681220116"><span class="hs-identifier hs-var">mb_mod</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-861"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier">exposedModules</span><span> </span><a href="#local-6989586621681220109"><span class="hs-identifier hs-var">conf</span></a><span class="hs-special">)</span><span>
</span><a name="line-862"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-863"></a><span>
</span><a name="line-864"></a><span>
</span><a name="line-865"></a><span class="hs-comment">-- A package named on the command line can either include the</span><span>
</span><a name="line-866"></a><span class="hs-comment">-- version, or just the name if it is unambiguous.</span><span>
</span><a name="line-867"></a><span class="hs-identifier">matchingStr</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-868"></a><a name="matchingStr"><a href="Packages.html#matchingStr"><span class="hs-identifier">matchingStr</span></a></a><span> </span><a name="local-6989586621681220117"><a href="#local-6989586621681220117"><span class="hs-identifier">str</span></a></a><span> </span><a name="local-6989586621681220118"><a href="#local-6989586621681220118"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-869"></a><span>        </span><span class="hs-glyph">=</span><span>  </span><a href="#local-6989586621681220117"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#sourcePackageIdString"><span class="hs-identifier hs-var">sourcePackageIdString</span></a><span> </span><a href="#local-6989586621681220118"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-870"></a><span>        </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621681220117"><span class="hs-identifier hs-var">str</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span> </span><a href="#local-6989586621681220118"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-871"></a><span>
</span><a name="line-872"></a><span class="hs-identifier">matchingId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-873"></a><a name="matchingId"><a href="Packages.html#matchingId"><span class="hs-identifier">matchingId</span></a></a><span> </span><a name="local-6989586621681220119"><a href="#local-6989586621681220119"><span class="hs-identifier">uid</span></a></a><span> </span><a name="local-6989586621681220120"><a href="#local-6989586621681220120"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220119"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="PackageConfig.html#installedPackageConfigId"><span class="hs-identifier hs-var">installedPackageConfigId</span></a><span> </span><a href="#local-6989586621681220120"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-874"></a><span>
</span><a name="line-875"></a><span class="hs-identifier">matching</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-type">PackageArg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-876"></a><a name="matching"><a href="Packages.html#matching"><span class="hs-identifier">matching</span></a></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#PackageArg"><span class="hs-identifier hs-var">PackageArg</span></a><span> </span><a name="local-6989586621681220121"><a href="#local-6989586621681220121"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#matchingStr"><span class="hs-identifier hs-var">matchingStr</span></a><span> </span><a href="#local-6989586621681220121"><span class="hs-identifier hs-var">str</span></a><span>
</span><a name="line-877"></a><span class="hs-identifier">matching</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#UnitIdArg"><span class="hs-identifier hs-var">UnitIdArg</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#DefUnitId"><span class="hs-identifier hs-var">DefUnitId</span></a><span> </span><a name="local-6989586621681220122"><a href="#local-6989586621681220122"><span class="hs-identifier">uid</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#matchingId"><span class="hs-identifier hs-var">matchingId</span></a><span> </span><a href="#local-6989586621681220122"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-878"></a><span class="hs-identifier">matching</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#UnitIdArg"><span class="hs-identifier hs-var">UnitIdArg</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- TODO: warn in this case</span><span>
</span><a name="line-879"></a><span>
</span><a name="line-880"></a><span class="hs-comment">-- | This sorts a list of packages, putting &quot;preferred&quot; packages first.</span><span>
</span><a name="line-881"></a><span class="hs-comment">-- See 'compareByPreference' for the semantics of &quot;preference&quot;.</span><span>
</span><a name="line-882"></a><span class="hs-identifier">sortByPreference</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-883"></a><a name="sortByPreference"><a href="Packages.html#sortByPreference"><span class="hs-identifier">sortByPreference</span></a></a><span> </span><a name="local-6989586621681220123"><a href="#local-6989586621681220123"><span class="hs-identifier">prec_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><a href="Packages.html#compareByPreference"><span class="hs-identifier hs-var">compareByPreference</span></a><span> </span><a href="#local-6989586621681220123"><span class="hs-identifier hs-var">prec_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-884"></a><span>
</span><a name="line-885"></a><span class="hs-comment">-- | Returns 'GT' if @pkg@ should be preferred over @pkg'@ when picking</span><span>
</span><a name="line-886"></a><span class="hs-comment">-- which should be &quot;active&quot;.  Here is the order of preference:</span><span>
</span><a name="line-887"></a><span class="hs-comment">--</span><span>
</span><a name="line-888"></a><span class="hs-comment">--      1. First, prefer the latest version</span><span>
</span><a name="line-889"></a><span class="hs-comment">--      2. If the versions are the same, prefer the package that</span><span>
</span><a name="line-890"></a><span class="hs-comment">--      came in the latest package database.</span><span>
</span><a name="line-891"></a><span class="hs-comment">--</span><span>
</span><a name="line-892"></a><span class="hs-comment">-- Pursuant to #12518, we could change this policy to, for example, remove</span><span>
</span><a name="line-893"></a><span class="hs-comment">-- the version preference, meaning that we would always prefer the packages</span><span>
</span><a name="line-894"></a><span class="hs-comment">-- in later package database.</span><span>
</span><a name="line-895"></a><span class="hs-comment">--</span><span>
</span><a name="line-896"></a><span class="hs-comment">-- Instead, we use that preference based policy only when one of the packages</span><span>
</span><a name="line-897"></a><span class="hs-comment">-- is integer-gmp and the other is integer-simple.</span><span>
</span><a name="line-898"></a><span class="hs-comment">-- This currently only happens when we're looking up which concrete</span><span>
</span><a name="line-899"></a><span class="hs-comment">-- package to use in place of @integer-wired-in@ and that two different</span><span>
</span><a name="line-900"></a><span class="hs-comment">-- package databases supply a different integer library. For more about</span><span>
</span><a name="line-901"></a><span class="hs-comment">-- the fake @integer-wired-in@ package, see Note [The integer library]</span><span>
</span><a name="line-902"></a><span class="hs-comment">-- in the @PrelNames@ module.</span><span>
</span><a name="line-903"></a><span class="hs-identifier">compareByPreference</span><span>
</span><a name="line-904"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span>
</span><a name="line-905"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-906"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-907"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-908"></a><a name="compareByPreference"><a href="Packages.html#compareByPreference"><span class="hs-identifier">compareByPreference</span></a></a><span> </span><a name="local-6989586621681220124"><a href="#local-6989586621681220124"><span class="hs-identifier">prec_map</span></a></a><span> </span><a name="local-6989586621681220125"><a href="#local-6989586621681220125"><span class="hs-identifier">pkg</span></a></a><span> </span><a name="local-6989586621681220126"><a href="#local-6989586621681220126"><span class="hs-identifier">pkg'</span></a></a><span>
</span><a name="line-909"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220132"><a href="#local-6989586621681220132"><span class="hs-identifier">prec</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220125"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621681220124"><span class="hs-identifier hs-var">prec_map</span></a><span>
</span><a name="line-910"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220133"><a href="#local-6989586621681220133"><span class="hs-identifier">prec'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220126"><span class="hs-identifier hs-var">pkg'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220124"><span class="hs-identifier hs-var">prec_map</span></a><span>
</span><a name="line-911"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220128"><span class="hs-identifier hs-var">differentIntegerPkgs</span></a><span> </span><a href="#local-6989586621681220125"><span class="hs-identifier hs-var">pkg</span></a><span> </span><a href="#local-6989586621681220126"><span class="hs-identifier hs-var">pkg'</span></a><span>
</span><a name="line-912"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621681220132"><span class="hs-identifier hs-var">prec</span></a><span> </span><a href="#local-6989586621681220133"><span class="hs-identifier hs-var">prec'</span></a><span>
</span><a name="line-913"></a><span>
</span><a name="line-914"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-915"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#comparing"><span class="hs-identifier hs-var">comparing</span></a><span> </span><span class="hs-identifier">packageVersion</span><span> </span><a href="#local-6989586621681220125"><span class="hs-identifier hs-var">pkg</span></a><span> </span><a href="#local-6989586621681220126"><span class="hs-identifier hs-var">pkg'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-916"></a><span>        </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">GT</span><span>
</span><a name="line-917"></a><span>        </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220134"><a href="#local-6989586621681220134"><span class="hs-identifier">prec</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220125"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>  </span><a href="#local-6989586621681220124"><span class="hs-identifier hs-var">prec_map</span></a><span>
</span><a name="line-918"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220135"><a href="#local-6989586621681220135"><span class="hs-identifier">prec'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220126"><span class="hs-identifier hs-var">pkg'</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220124"><span class="hs-identifier hs-var">prec_map</span></a><span>
</span><a name="line-919"></a><span>           </span><span class="hs-comment">-- Prefer the package from the later DB flag (i.e., higher</span><span>
</span><a name="line-920"></a><span>           </span><span class="hs-comment">-- precedence)</span><span>
</span><a name="line-921"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621681220134"><span class="hs-identifier hs-var">prec</span></a><span> </span><a href="#local-6989586621681220135"><span class="hs-identifier hs-var">prec'</span></a><span>
</span><a name="line-922"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-923"></a><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-924"></a><span>        </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">LT</span><span>
</span><a name="line-925"></a><span>
</span><a name="line-926"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220127"><a href="#local-6989586621681220127"><span class="hs-identifier">isIntegerPkg</span></a></a><span> </span><a name="local-6989586621681220129"><a href="#local-6989586621681220129"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span> </span><a href="#local-6989586621681220129"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span>
</span><a name="line-927"></a><span>          </span><span class="hs-special">[</span><span class="hs-string">&quot;integer-simple&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;integer-gmp&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-928"></a><span>        </span><a name="local-6989586621681220128"><a href="#local-6989586621681220128"><span class="hs-identifier">differentIntegerPkgs</span></a></a><span> </span><a name="local-6989586621681220130"><a href="#local-6989586621681220130"><span class="hs-identifier">p</span></a></a><span> </span><a name="local-6989586621681220131"><a href="#local-6989586621681220131"><span class="hs-identifier">p'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-929"></a><span>          </span><a href="#local-6989586621681220127"><span class="hs-identifier hs-var">isIntegerPkg</span></a><span> </span><a href="#local-6989586621681220130"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681220127"><span class="hs-identifier hs-var">isIntegerPkg</span></a><span> </span><a href="#local-6989586621681220131"><span class="hs-identifier hs-var">p'</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span>
</span><a name="line-930"></a><span>          </span><span class="hs-special">(</span><span class="hs-identifier">packageName</span><span> </span><a href="#local-6989586621681220130"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">packageName</span><span> </span><a href="#local-6989586621681220131"><span class="hs-identifier hs-var">p'</span></a><span class="hs-special">)</span><span>
</span><a name="line-931"></a><span>
</span><a name="line-932"></a><span class="hs-identifier">comparing</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621681219913"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681219914"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681219913"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681219914"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681219914"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Ordering</span><span>
</span><a name="line-933"></a><a name="comparing"><a href="Packages.html#comparing"><span class="hs-identifier">comparing</span></a></a><span> </span><a name="local-6989586621681220136"><a href="#local-6989586621681220136"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621681220137"><a href="#local-6989586621681220137"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621681220138"><a href="#local-6989586621681220138"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220136"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681220137"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">compare</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220136"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681220138"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-934"></a><span>
</span><a name="line-935"></a><span class="hs-identifier">packageFlagErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-936"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#PackageFlag"><span class="hs-identifier hs-type">PackageFlag</span></a><span>
</span><a name="line-937"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-938"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681219912"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-939"></a><a name="packageFlagErr"><a href="Packages.html#packageFlagErr"><span class="hs-identifier">packageFlagErr</span></a></a><span> </span><a name="local-6989586621681220139"><a href="#local-6989586621681220139"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220140"><a href="#local-6989586621681220140"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681220141"><a href="#local-6989586621681220141"><span class="hs-identifier">reasons</span></a></a><span>
</span><a name="line-940"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#packageFlagErr%27"><span class="hs-identifier hs-var">packageFlagErr'</span></a><span> </span><a href="#local-6989586621681220139"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#pprFlag"><span class="hs-identifier hs-var">pprFlag</span></a><span> </span><a href="#local-6989586621681220140"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220141"><span class="hs-identifier hs-var">reasons</span></a><span>
</span><a name="line-941"></a><span>
</span><a name="line-942"></a><span class="hs-identifier">trustFlagErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-943"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#TrustFlag"><span class="hs-identifier hs-type">TrustFlag</span></a><span>
</span><a name="line-944"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-945"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681219911"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-946"></a><a name="trustFlagErr"><a href="Packages.html#trustFlagErr"><span class="hs-identifier">trustFlagErr</span></a></a><span> </span><a name="local-6989586621681220142"><a href="#local-6989586621681220142"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220143"><a href="#local-6989586621681220143"><span class="hs-identifier">flag</span></a></a><span> </span><a name="local-6989586621681220144"><a href="#local-6989586621681220144"><span class="hs-identifier">reasons</span></a></a><span>
</span><a name="line-947"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#packageFlagErr%27"><span class="hs-identifier hs-var">packageFlagErr'</span></a><span> </span><a href="#local-6989586621681220142"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#pprTrustFlag"><span class="hs-identifier hs-var">pprTrustFlag</span></a><span> </span><a href="#local-6989586621681220143"><span class="hs-identifier hs-var">flag</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220144"><span class="hs-identifier hs-var">reasons</span></a><span>
</span><a name="line-948"></a><span>
</span><a name="line-949"></a><span class="hs-identifier">packageFlagErr'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-950"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-951"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-952"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681219910"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-953"></a><a name="packageFlagErr%27"><a href="Packages.html#packageFlagErr%27"><span class="hs-identifier">packageFlagErr'</span></a></a><span> </span><a name="local-6989586621681220145"><a href="#local-6989586621681220145"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220146"><a href="#local-6989586621681220146"><span class="hs-identifier">flag_doc</span></a></a><span> </span><a name="local-6989586621681220147"><a href="#local-6989586621681220147"><span class="hs-identifier">reasons</span></a></a><span>
</span><a name="line-954"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a><span> </span><span class="hs-special">(</span><a href="Panic.html#CmdLineError"><span class="hs-identifier hs-var">CmdLineError</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#showSDoc"><span class="hs-identifier hs-var">showSDoc</span></a><span> </span><a href="#local-6989586621681220145"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681220148"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-955"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220148"><a href="#local-6989586621681220148"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;cannot satisfy &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="#local-6989586621681220146"><span class="hs-identifier hs-var">flag_doc</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-956"></a><span>                </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681220147"><span class="hs-identifier hs-var">reasons</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable.empty</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;: &quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-957"></a><span>              </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">4</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220149"><span class="hs-identifier hs-var">ppr_reasons</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-958"></a><span>                      </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;(use -v for more information)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>        </span><a name="local-6989586621681220149"><a href="#local-6989586621681220149"><span class="hs-identifier">ppr_reasons</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220150"><span class="hs-identifier hs-var">ppr_reason</span></a><span> </span><a href="#local-6989586621681220147"><span class="hs-identifier hs-var">reasons</span></a><span class="hs-special">)</span><span>
</span><a name="line-960"></a><span>        </span><a name="local-6989586621681220150"><a href="#local-6989586621681220150"><span class="hs-identifier">ppr_reason</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220151"><a href="#local-6989586621681220151"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220152"><a href="#local-6989586621681220152"><span class="hs-identifier">reason</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-961"></a><span>            </span><a href="Packages.html#pprReason"><span class="hs-identifier hs-var">pprReason</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220151"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220152"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-962"></a><span>
</span><a name="line-963"></a><span class="hs-identifier">pprFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#PackageFlag"><span class="hs-identifier hs-type">PackageFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-964"></a><a name="pprFlag"><a href="Packages.html#pprFlag"><span class="hs-identifier">pprFlag</span></a></a><span> </span><a name="local-6989586621681220153"><a href="#local-6989586621681220153"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220153"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-965"></a><span>    </span><a href="DynFlags.html#HidePackage"><span class="hs-identifier hs-var">HidePackage</span></a><span> </span><a name="local-6989586621681220154"><a href="#local-6989586621681220154"><span class="hs-identifier">p</span></a></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;-hide-package &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220154"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-966"></a><span>    </span><a href="DynFlags.html#ExposePackage"><span class="hs-identifier hs-var">ExposePackage</span></a><span> </span><a name="local-6989586621681220155"><a href="#local-6989586621681220155"><span class="hs-identifier">doc</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220155"><span class="hs-identifier hs-var">doc</span></a><span>
</span><a name="line-967"></a><span>
</span><a name="line-968"></a><span class="hs-identifier">pprTrustFlag</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#TrustFlag"><span class="hs-identifier hs-type">TrustFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-969"></a><a name="pprTrustFlag"><a href="Packages.html#pprTrustFlag"><span class="hs-identifier">pprTrustFlag</span></a></a><span> </span><a name="local-6989586621681220156"><a href="#local-6989586621681220156"><span class="hs-identifier">flag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220156"><span class="hs-identifier hs-var">flag</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-970"></a><span>    </span><a href="DynFlags.html#TrustPackage"><span class="hs-identifier hs-var">TrustPackage</span></a><span> </span><a name="local-6989586621681220157"><a href="#local-6989586621681220157"><span class="hs-identifier">p</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;-trust &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220157"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-971"></a><span>    </span><a href="DynFlags.html#DistrustPackage"><span class="hs-identifier hs-var">DistrustPackage</span></a><span> </span><a name="local-6989586621681220158"><a href="#local-6989586621681220158"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;-distrust &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220158"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-972"></a><span>
</span><a name="line-973"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-974"></a><span class="hs-comment">-- Wired-in packages</span><span>
</span><a name="line-975"></a><span class="hs-comment">--</span><span>
</span><a name="line-976"></a><span class="hs-comment">-- See Note [Wired-in packages] in Module</span><span>
</span><a name="line-977"></a><span>
</span><a name="line-978"></a><span class="hs-keyword">type</span><span> </span><a name="WiredInUnitId"><a href="Packages.html#WiredInUnitId"><span class="hs-identifier">WiredInUnitId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-979"></a><span class="hs-keyword">type</span><span> </span><a name="WiredPackagesMap"><a href="Packages.html#WiredPackagesMap"><span class="hs-identifier">WiredPackagesMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Packages.html#WiredUnitId"><span class="hs-identifier hs-type">WiredUnitId</span></a><span> </span><a href="Packages.html#WiredUnitId"><span class="hs-identifier hs-type">WiredUnitId</span></a><span>
</span><a name="line-980"></a><span>
</span><a name="line-981"></a><span class="hs-identifier">wired_in_pkgids</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Packages.html#WiredInUnitId"><span class="hs-identifier hs-type">WiredInUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-982"></a><a name="wired_in_pkgids"><a href="Packages.html#wired_in_pkgids"><span class="hs-identifier">wired_in_pkgids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Module.html#unitIdString"><span class="hs-identifier hs-var">unitIdString</span></a><span> </span><a href="Module.html#wiredInUnitIds"><span class="hs-identifier hs-var">wiredInUnitIds</span></a><span>
</span><a name="line-983"></a><span>
</span><a name="line-984"></a><span class="hs-identifier">findWiredInPackages</span><span>
</span><a name="line-985"></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-986"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span>
</span><a name="line-987"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>           </span><span class="hs-comment">-- database</span><span>
</span><a name="line-988"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#VisibilityMap"><span class="hs-identifier hs-type">VisibilityMap</span></a><span>             </span><span class="hs-comment">-- info on what packages are visible</span><span>
</span><a name="line-989"></a><span>                                </span><span class="hs-comment">-- for wired in selection</span><span>
</span><a name="line-990"></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- package database updated for wired in</span><span>
</span><a name="line-991"></a><span>          </span><a href="Packages.html#WiredPackagesMap"><span class="hs-identifier hs-type">WiredPackagesMap</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- map from unit id to wired identity</span><span>
</span><a name="line-992"></a><span>
</span><a name="line-993"></a><a name="findWiredInPackages"><a href="Packages.html#findWiredInPackages"><span class="hs-identifier">findWiredInPackages</span></a></a><span> </span><a name="local-6989586621681220159"><a href="#local-6989586621681220159"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220160"><a href="#local-6989586621681220160"><span class="hs-identifier">prec_map</span></a></a><span> </span><a name="local-6989586621681220161"><a href="#local-6989586621681220161"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621681220162"><a href="#local-6989586621681220162"><span class="hs-identifier">vis_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-994"></a><span>  </span><span class="hs-comment">-- Now we must find our wired-in packages, and rename them to</span><span>
</span><a name="line-995"></a><span>  </span><span class="hs-comment">-- their canonical names (eg. base-1.0 ==&gt; base), as described</span><span>
</span><a name="line-996"></a><span>  </span><span class="hs-comment">-- in Note [Wired-in packages] in Module</span><span>
</span><a name="line-997"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-998"></a><span>        </span><span class="hs-identifier">matches</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#WiredInUnitId"><span class="hs-identifier hs-type">WiredInUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-999"></a><span>        </span><a name="local-6989586621681220165"><a href="#local-6989586621681220165"><span class="hs-identifier">pc</span></a></a><span> </span><span class="hs-special">`</span><a name="local-6989586621681220163"><a href="#local-6989586621681220163"><span class="hs-identifier">matches</span></a></a><span class="hs-special">`</span><span> </span><a name="local-6989586621681220166"><a href="#local-6989586621681220166"><span class="hs-identifier">pid</span></a></a><span>
</span><a name="line-1000"></a><span>            </span><span class="hs-comment">-- See Note [The integer library] in PrelNames</span><span>
</span><a name="line-1001"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681220166"><span class="hs-identifier hs-var">pid</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Module.html#unitIdString"><span class="hs-identifier hs-var">unitIdString</span></a><span> </span><a href="Module.html#integerUnitId"><span class="hs-identifier hs-var">integerUnitId</span></a><span>
</span><a name="line-1002"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span> </span><a href="#local-6989586621681220165"><span class="hs-identifier hs-var">pc</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;integer-gmp&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;integer-simple&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-1003"></a><span>        </span><a name="local-6989586621681220167"><a href="#local-6989586621681220167"><span class="hs-identifier">pc</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">matches</span><span class="hs-special">`</span><span> </span><a name="local-6989586621681220168"><a href="#local-6989586621681220168"><span class="hs-identifier">pid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span> </span><a href="#local-6989586621681220167"><span class="hs-identifier hs-var">pc</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681220168"><span class="hs-identifier hs-var">pid</span></a><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span>        </span><span class="hs-comment">-- find which package corresponds to each wired-in package</span><span>
</span><a name="line-1006"></a><span>        </span><span class="hs-comment">-- delete any other packages with the same name</span><span>
</span><a name="line-1007"></a><span>        </span><span class="hs-comment">-- update the package and any dependencies to point to the new</span><span>
</span><a name="line-1008"></a><span>        </span><span class="hs-comment">-- one.</span><span>
</span><a name="line-1009"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1010"></a><span>        </span><span class="hs-comment">-- When choosing which package to map to a wired-in package</span><span>
</span><a name="line-1011"></a><span>        </span><span class="hs-comment">-- name, we try to pick the latest version of exposed packages.</span><span>
</span><a name="line-1012"></a><span>        </span><span class="hs-comment">-- However, if there are no exposed wired in packages available</span><span>
</span><a name="line-1013"></a><span>        </span><span class="hs-comment">-- (e.g. -hide-all-packages was used), we can't bail: we *have*</span><span>
</span><a name="line-1014"></a><span>        </span><span class="hs-comment">-- to assign a package for the wired-in package: so we try again</span><span>
</span><a name="line-1015"></a><span>        </span><span class="hs-comment">-- with hidden packages included to (and pick the latest</span><span>
</span><a name="line-1016"></a><span>        </span><span class="hs-comment">-- version).</span><span>
</span><a name="line-1017"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1018"></a><span>        </span><span class="hs-comment">-- You can also override the default choice by using -ignore-package:</span><span>
</span><a name="line-1019"></a><span>        </span><span class="hs-comment">-- this works even when there is no exposed wired in package</span><span>
</span><a name="line-1020"></a><span>        </span><span class="hs-comment">-- available.</span><span>
</span><a name="line-1021"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1022"></a><span>        </span><span class="hs-identifier">findWiredInPackage</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#WiredInUnitId"><span class="hs-identifier hs-type">WiredInUnitId</span></a><span>
</span><a name="line-1023"></a><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Packages.html#WiredInUnitId"><span class="hs-identifier hs-type">WiredInUnitId</span></a><span class="hs-special">,</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>        </span><a name="local-6989586621681220164"><a href="#local-6989586621681220164"><span class="hs-identifier">findWiredInPackage</span></a></a><span> </span><a name="local-6989586621681220169"><a href="#local-6989586621681220169"><span class="hs-identifier">pkgs</span></a></a><span> </span><a name="local-6989586621681220170"><a href="#local-6989586621681220170"><span class="hs-identifier">wired_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1025"></a><span>           </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220174"><a href="#local-6989586621681220174"><span class="hs-identifier">all_ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681220176"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220176"><a href="#local-6989586621681220176"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220169"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220176"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><a href="#local-6989586621681220163"><span class="hs-identifier hs-var">matches</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220170"><span class="hs-identifier hs-var">wired_pkg</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1026"></a><span>               </span><a name="local-6989586621681220175"><a href="#local-6989586621681220175"><span class="hs-identifier">all_exposed_ps</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1027"></a><span>                    </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681220177"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220177"><a href="#local-6989586621681220177"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220174"><span class="hs-identifier hs-var">all_ps</span></a><span>
</span><a name="line-1028"></a><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map.member</span><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220177"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220162"><span class="hs-identifier hs-var">vis_map</span></a><span> </span><span class="hs-special">]</span><span> </span><span class="hs-keyword">in</span><span>
</span><a name="line-1029"></a><span>           </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220175"><span class="hs-identifier hs-var">all_exposed_ps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1030"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220174"><span class="hs-identifier hs-var">all_ps</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1031"></a><span>                       </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220171"><span class="hs-identifier hs-var">notfound</span></a><span>
</span><a name="line-1032"></a><span>                       </span><a name="local-6989586621681220178"><a href="#local-6989586621681220178"><span class="hs-identifier">many</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220172"><span class="hs-identifier hs-var">pick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-special">(</span><a href="Packages.html#sortByPreference"><span class="hs-identifier hs-var">sortByPreference</span></a><span> </span><a href="#local-6989586621681220160"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220178"><span class="hs-identifier hs-var">many</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1033"></a><span>            </span><a name="local-6989586621681220179"><a href="#local-6989586621681220179"><span class="hs-identifier">many</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220172"><span class="hs-identifier hs-var">pick</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">head</span><span> </span><span class="hs-special">(</span><a href="Packages.html#sortByPreference"><span class="hs-identifier hs-var">sortByPreference</span></a><span> </span><a href="#local-6989586621681220160"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220179"><span class="hs-identifier hs-var">many</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1034"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-1035"></a><span>                </span><a name="local-6989586621681220171"><a href="#local-6989586621681220171"><span class="hs-identifier">notfound</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1036"></a><span>                          </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220159"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1037"></a><span>                            </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;wired-in package &quot;</span><span>
</span><a name="line-1038"></a><span>                                 </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220170"><span class="hs-identifier hs-var">wired_pkg</span></a><span>
</span><a name="line-1039"></a><span>                                 </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; not found.&quot;</span><span>
</span><a name="line-1040"></a><span>                          </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1041"></a><span>                </span><span class="hs-identifier">pick</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-1042"></a><span>                     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Packages.html#WiredInUnitId"><span class="hs-identifier hs-type">WiredInUnitId</span></a><span class="hs-special">,</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1043"></a><span>                </span><a name="local-6989586621681220172"><a href="#local-6989586621681220172"><span class="hs-identifier">pick</span></a></a><span> </span><a name="local-6989586621681220173"><a href="#local-6989586621681220173"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1044"></a><span>                        </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220159"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1045"></a><span>                            </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;wired-in package &quot;</span><span>
</span><a name="line-1046"></a><span>                                 </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220170"><span class="hs-identifier hs-var">wired_pkg</span></a><span>
</span><a name="line-1047"></a><span>                                 </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; mapped to &quot;</span><span>
</span><a name="line-1048"></a><span>                                 </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220173"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1049"></a><span>                        </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220170"><span class="hs-identifier hs-var">wired_pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220173"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1050"></a><span>
</span><a name="line-1051"></a><span>
</span><a name="line-1052"></a><span>  </span><a name="local-6989586621681220180"><a href="#local-6989586621681220180"><span class="hs-identifier">mb_wired_in_pkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">mapM</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220164"><span class="hs-identifier hs-var">findWiredInPackage</span></a><span> </span><a href="#local-6989586621681220161"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span> </span><a href="Packages.html#wired_in_pkgids"><span class="hs-identifier hs-var">wired_in_pkgids</span></a><span>
</span><a name="line-1053"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-1054"></a><span>        </span><a name="local-6989586621681220181"><a href="#local-6989586621681220181"><span class="hs-identifier">wired_in_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">catMaybes</span><span> </span><a href="#local-6989586621681220180"><span class="hs-identifier hs-var">mb_wired_in_pkgs</span></a><span>
</span><a name="line-1055"></a><span>
</span><a name="line-1056"></a><span>        </span><span class="hs-comment">-- this is old: we used to assume that if there were</span><span>
</span><a name="line-1057"></a><span>        </span><span class="hs-comment">-- multiple versions of wired-in packages installed that</span><span>
</span><a name="line-1058"></a><span>        </span><span class="hs-comment">-- they were mutually exclusive.  Now we're assuming that</span><span>
</span><a name="line-1059"></a><span>        </span><span class="hs-comment">-- you have one &quot;main&quot; version of each wired-in package</span><span>
</span><a name="line-1060"></a><span>        </span><span class="hs-comment">-- (the latest version), and the others are backward-compat</span><span>
</span><a name="line-1061"></a><span>        </span><span class="hs-comment">-- wrappers that depend on this one.  e.g. base-4.0 is the</span><span>
</span><a name="line-1062"></a><span>        </span><span class="hs-comment">-- latest, base-3.0 is a compat wrapper depending on base-4.0.</span><span>
</span><a name="line-1063"></a><span>        </span><span class="hs-comment">{-
        deleteOtherWiredInPackages pkgs = filterOut bad pkgs
          where bad p = any (p `matches`) wired_in_pkgids
                      &amp;&amp; package p `notElem` map fst wired_in_ids
        -}</span><span>
</span><a name="line-1068"></a><span>
</span><a name="line-1069"></a><span>        </span><span class="hs-identifier">wiredInMap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Packages.html#WiredUnitId"><span class="hs-identifier hs-type">WiredUnitId</span></a><span> </span><a href="Packages.html#WiredUnitId"><span class="hs-identifier hs-type">WiredUnitId</span></a><span>
</span><a name="line-1070"></a><span>        </span><a name="local-6989586621681220182"><a href="#local-6989586621681220182"><span class="hs-identifier">wiredInMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span>
</span><a name="line-1071"></a><span>          </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220186"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#DefUnitId"><span class="hs-identifier hs-var">DefUnitId</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#stringToInstalledUnitId"><span class="hs-identifier hs-var">stringToInstalledUnitId</span></a><span> </span><a href="#local-6989586621681220184"><span class="hs-identifier hs-var">wiredInUnitId</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1072"></a><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220184"><a href="#local-6989586621681220184"><span class="hs-identifier">wiredInUnitId</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220185"><a href="#local-6989586621681220185"><span class="hs-identifier">pkg</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220181"><span class="hs-identifier hs-var">wired_in_pkgs</span></a><span>
</span><a name="line-1073"></a><span>          </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220186"><a href="#local-6989586621681220186"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="PackageConfig.html#definitePackageConfigId"><span class="hs-identifier hs-var">definitePackageConfigId</span></a><span> </span><a href="#local-6989586621681220185"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1074"></a><span>          </span><span class="hs-special">]</span><span>
</span><a name="line-1075"></a><span>
</span><a name="line-1076"></a><span>        </span><a name="local-6989586621681220183"><a href="#local-6989586621681220183"><span class="hs-identifier">updateWiredInDependencies</span></a></a><span> </span><a name="local-6989586621681220187"><a href="#local-6989586621681220187"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220189"><span class="hs-identifier hs-var">upd_deps</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681220188"><span class="hs-identifier hs-var">upd_pkg</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220187"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1077"></a><span>          </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220188"><a href="#local-6989586621681220188"><span class="hs-identifier">upd_pkg</span></a></a><span> </span><a name="local-6989586621681220190"><a href="#local-6989586621681220190"><span class="hs-identifier">pkg</span></a></a><span>
</span><a name="line-1078"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220191"><a href="#local-6989586621681220191"><span class="hs-identifier">def_uid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="PackageConfig.html#definitePackageConfigId"><span class="hs-identifier hs-var">definitePackageConfigId</span></a><span> </span><a href="#local-6989586621681220190"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1079"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220192"><a href="#local-6989586621681220192"><span class="hs-identifier">wiredInUnitId</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220191"><span class="hs-identifier hs-var">def_uid</span></a><span> </span><a href="#local-6989586621681220182"><span class="hs-identifier hs-var">wiredInMap</span></a><span>
</span><a name="line-1080"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220193"><a href="#local-6989586621681220193"><span class="hs-identifier">fs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">installedUnitIdFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unDefUnitId</span><span> </span><a href="#local-6989586621681220192"><span class="hs-identifier hs-var">wiredInUnitId</span></a><span class="hs-special">)</span><span>
</span><a name="line-1081"></a><span>                    </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621681220190"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1082"></a><span>                      </span><span class="hs-identifier">unitId</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#fsToInstalledUnitId"><span class="hs-identifier hs-var">fsToInstalledUnitId</span></a><span> </span><a href="#local-6989586621681220193"><span class="hs-identifier hs-var">fs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1083"></a><span>                      </span><span class="hs-identifier">componentId</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#ComponentId"><span class="hs-identifier hs-var">ComponentId</span></a><span> </span><a href="#local-6989586621681220193"><span class="hs-identifier hs-var">fs</span></a><span>
</span><a name="line-1084"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-1085"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1086"></a><span>                  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220190"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1087"></a><span>                </span><a name="local-6989586621681220189"><a href="#local-6989586621681220189"><span class="hs-identifier">upd_deps</span></a></a><span> </span><a name="local-6989586621681220194"><a href="#local-6989586621681220194"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220194"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1088"></a><span>                      </span><span class="hs-comment">-- temporary harmless DefUnitId invariant violation</span><span>
</span><a name="line-1089"></a><span>                      </span><span class="hs-identifier">depends</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unDefUnitId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Packages.html#upd_wired_in"><span class="hs-identifier hs-var">upd_wired_in</span></a><span> </span><a href="#local-6989586621681220182"><span class="hs-identifier hs-var">wiredInMap</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Module.html#DefUnitId"><span class="hs-identifier hs-var">DefUnitId</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">depends</span><span> </span><a href="#local-6989586621681220194"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1090"></a><span>                      </span><span class="hs-identifier">exposedModules</span><span>
</span><a name="line-1091"></a><span>                        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681220195"><a href="#local-6989586621681220195"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220196"><a href="#local-6989586621681220196"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220195"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Packages.html#upd_wired_in_mod"><span class="hs-identifier hs-var">upd_wired_in_mod</span></a><span> </span><a href="#local-6989586621681220182"><span class="hs-identifier hs-var">wiredInMap</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220196"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1092"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier">exposedModules</span><span> </span><a href="#local-6989586621681220194"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1093"></a><span>                    </span><span class="hs-special">}</span><span>
</span><a name="line-1094"></a><span>
</span><a name="line-1095"></a><span>
</span><a name="line-1096"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220183"><span class="hs-identifier hs-var">updateWiredInDependencies</span></a><span> </span><a href="#local-6989586621681220161"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220182"><span class="hs-identifier hs-var">wiredInMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-1097"></a><span>
</span><a name="line-1098"></a><span class="hs-comment">-- Helper functions for rewiring Module and UnitId.  These</span><span>
</span><a name="line-1099"></a><span class="hs-comment">-- rewrite UnitIds of modules in wired-in packages to the form known to the</span><span>
</span><a name="line-1100"></a><span class="hs-comment">-- compiler, as described in Note [Wired-in packages] in Module.</span><span>
</span><a name="line-1101"></a><span class="hs-comment">--</span><span>
</span><a name="line-1102"></a><span class="hs-comment">-- For instance, base-4.9.0.0 will be rewritten to just base, to match</span><span>
</span><a name="line-1103"></a><span class="hs-comment">-- what appears in PrelNames.</span><span>
</span><a name="line-1104"></a><span>
</span><a name="line-1105"></a><span class="hs-identifier">upd_wired_in_mod</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#WiredPackagesMap"><span class="hs-identifier hs-type">WiredPackagesMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span>
</span><a name="line-1106"></a><a name="upd_wired_in_mod"><a href="Packages.html#upd_wired_in_mod"><span class="hs-identifier">upd_wired_in_mod</span></a></a><span> </span><a name="local-6989586621681220197"><a href="#local-6989586621681220197"><span class="hs-identifier">wiredInMap</span></a></a><span> </span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-var">Module</span></a><span> </span><a name="local-6989586621681220198"><a href="#local-6989586621681220198"><span class="hs-identifier">uid</span></a></a><span> </span><a name="local-6989586621681220199"><a href="#local-6989586621681220199"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-var">Module</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#upd_wired_in_uid"><span class="hs-identifier hs-var">upd_wired_in_uid</span></a><span> </span><a href="#local-6989586621681220197"><span class="hs-identifier hs-var">wiredInMap</span></a><span> </span><a href="#local-6989586621681220198"><span class="hs-identifier hs-var">uid</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220199"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1107"></a><span>
</span><a name="line-1108"></a><span class="hs-identifier">upd_wired_in_uid</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#WiredPackagesMap"><span class="hs-identifier hs-type">WiredPackagesMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span>
</span><a name="line-1109"></a><a name="upd_wired_in_uid"><a href="Packages.html#upd_wired_in_uid"><span class="hs-identifier">upd_wired_in_uid</span></a></a><span> </span><a name="local-6989586621681220200"><a href="#local-6989586621681220200"><span class="hs-identifier">wiredInMap</span></a></a><span> </span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><a name="local-6989586621681220201"><a href="#local-6989586621681220201"><span class="hs-identifier">def_uid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1110"></a><span>    </span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#upd_wired_in"><span class="hs-identifier hs-var">upd_wired_in</span></a><span> </span><a href="#local-6989586621681220200"><span class="hs-identifier hs-var">wiredInMap</span></a><span> </span><a href="#local-6989586621681220201"><span class="hs-identifier hs-var">def_uid</span></a><span class="hs-special">)</span><span>
</span><a name="line-1111"></a><span class="hs-identifier">upd_wired_in_uid</span><span> </span><a name="local-6989586621681220202"><a href="#local-6989586621681220202"><span class="hs-identifier">wiredInMap</span></a></a><span> </span><span class="hs-special">(</span><a href="Module.html#IndefiniteUnitId"><span class="hs-identifier hs-var">IndefiniteUnitId</span></a><span> </span><a name="local-6989586621681220203"><a href="#local-6989586621681220203"><span class="hs-identifier">indef_uid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1112"></a><span>    </span><a href="Module.html#IndefiniteUnitId"><span class="hs-identifier hs-var">IndefiniteUnitId</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Module.html#newIndefUnitId"><span class="hs-identifier hs-var">newIndefUnitId</span></a><span>
</span><a name="line-1113"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">indefUnitIdComponentId</span><span> </span><a href="#local-6989586621681220203"><span class="hs-identifier hs-var">indef_uid</span></a><span class="hs-special">)</span><span>
</span><a name="line-1114"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621681220204"><a href="#local-6989586621681220204"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220205"><a href="#local-6989586621681220205"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220204"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><a href="Packages.html#upd_wired_in_mod"><span class="hs-identifier hs-var">upd_wired_in_mod</span></a><span> </span><a href="#local-6989586621681220202"><span class="hs-identifier hs-var">wiredInMap</span></a><span> </span><a href="#local-6989586621681220205"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">indefUnitIdInsts</span><span> </span><a href="#local-6989586621681220203"><span class="hs-identifier hs-var">indef_uid</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1115"></a><span>
</span><a name="line-1116"></a><span class="hs-identifier">upd_wired_in</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#WiredPackagesMap"><span class="hs-identifier hs-type">WiredPackagesMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#DefUnitId"><span class="hs-identifier hs-type">DefUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#DefUnitId"><span class="hs-identifier hs-type">DefUnitId</span></a><span>
</span><a name="line-1117"></a><a name="upd_wired_in"><a href="Packages.html#upd_wired_in"><span class="hs-identifier">upd_wired_in</span></a></a><span> </span><a name="local-6989586621681220206"><a href="#local-6989586621681220206"><span class="hs-identifier">wiredInMap</span></a></a><span> </span><a name="local-6989586621681220207"><a href="#local-6989586621681220207"><span class="hs-identifier">key</span></a></a><span>
</span><a name="line-1118"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220208"><a href="#local-6989586621681220208"><span class="hs-identifier">key'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220207"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-6989586621681220206"><span class="hs-identifier hs-var">wiredInMap</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220208"><span class="hs-identifier hs-var">key'</span></a><span>
</span><a name="line-1119"></a><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220207"><span class="hs-identifier hs-var">key</span></a><span>
</span><a name="line-1120"></a><span>
</span><a name="line-1121"></a><span class="hs-identifier">updateVisibilityMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#WiredPackagesMap"><span class="hs-identifier hs-type">WiredPackagesMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#VisibilityMap"><span class="hs-identifier hs-type">VisibilityMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#VisibilityMap"><span class="hs-identifier hs-type">VisibilityMap</span></a><span>
</span><a name="line-1122"></a><a name="updateVisibilityMap"><a href="Packages.html#updateVisibilityMap"><span class="hs-identifier">updateVisibilityMap</span></a></a><span> </span><a name="local-6989586621681220209"><a href="#local-6989586621681220209"><span class="hs-identifier">wiredInMap</span></a></a><span> </span><a name="local-6989586621681220210"><a href="#local-6989586621681220210"><span class="hs-identifier">vis_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621681220211"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681220210"><span class="hs-identifier hs-var">vis_map</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220209"><span class="hs-identifier hs-var">wiredInMap</span></a><span class="hs-special">)</span><span>
</span><a name="line-1123"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220211"><a href="#local-6989586621681220211"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621681220212"><a href="#local-6989586621681220212"><span class="hs-identifier">vm</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220213"><a href="#local-6989586621681220213"><span class="hs-identifier">from</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220214"><a href="#local-6989586621681220214"><span class="hs-identifier">to</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><a href="#local-6989586621681220213"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220210"><span class="hs-identifier hs-var">vis_map</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1124"></a><span>                    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220212"><span class="hs-identifier hs-var">vm</span></a><span>
</span><a name="line-1125"></a><span>                    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220215"><a href="#local-6989586621681220215"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><a href="#local-6989586621681220214"><span class="hs-identifier hs-var">to</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220215"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1126"></a><span>                                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.delete</span><span> </span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><a href="#local-6989586621681220213"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220212"><span class="hs-identifier hs-var">vm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1127"></a><span>
</span><a name="line-1128"></a><span>
</span><a name="line-1129"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-1130"></a><span>
</span><a name="line-1131"></a><span class="hs-comment">-- | The reason why a package is unusable.</span><span>
</span><a name="line-1132"></a><span class="hs-keyword">data</span><span> </span><a name="UnusablePackageReason"><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier">UnusablePackageReason</span></a></a><span>
</span><a name="line-1133"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | We ignored it explicitly using @-ignore-package@.</span><span>
</span><a name="line-1134"></a><span>    </span><a name="IgnoredWithFlag"><a href="Packages.html#IgnoredWithFlag"><span class="hs-identifier">IgnoredWithFlag</span></a></a><span>
</span><a name="line-1135"></a><span>    </span><span class="hs-comment">-- | This package transitively depends on a package that was never present</span><span>
</span><a name="line-1136"></a><span>    </span><span class="hs-comment">-- in any of the provided databases.</span><span>
</span><a name="line-1137"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="BrokenDependencies"><a href="Packages.html#BrokenDependencies"><span class="hs-identifier">BrokenDependencies</span></a></a><span>   </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1138"></a><span>    </span><span class="hs-comment">-- | This package transitively depends on a package involved in a cycle.</span><span>
</span><a name="line-1139"></a><span>    </span><span class="hs-comment">-- Note that the list of 'InstalledUnitId' reports the direct dependencies</span><span>
</span><a name="line-1140"></a><span>    </span><span class="hs-comment">-- of this package that (transitively) depended on the cycle, and not</span><span>
</span><a name="line-1141"></a><span>    </span><span class="hs-comment">-- the actual cycle itself (which we report separately at high verbosity.)</span><span>
</span><a name="line-1142"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="CyclicDependencies"><a href="Packages.html#CyclicDependencies"><span class="hs-identifier">CyclicDependencies</span></a></a><span>   </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1143"></a><span>    </span><span class="hs-comment">-- | This package transitively depends on a package which was ignored.</span><span>
</span><a name="line-1144"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="IgnoredDependencies"><a href="Packages.html#IgnoredDependencies"><span class="hs-identifier">IgnoredDependencies</span></a></a><span>  </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1145"></a><span>    </span><span class="hs-comment">-- | This package transitively depends on a package which was</span><span>
</span><a name="line-1146"></a><span>    </span><span class="hs-comment">-- shadowed by an ABI-incompatible package.</span><span>
</span><a name="line-1147"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="ShadowedDependencies"><a href="Packages.html#ShadowedDependencies"><span class="hs-identifier">ShadowedDependencies</span></a></a><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1148"></a><span>
</span><a name="line-1149"></a><span class="hs-keyword">instance</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1150"></a><span>    </span><a name="local-8214565720324908102"><a href="Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></a><span> </span><a href="Packages.html#IgnoredWithFlag"><span class="hs-identifier hs-var">IgnoredWithFlag</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;[ignored with flag]&quot;</span><span>
</span><a name="line-1151"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Packages.html#BrokenDependencies"><span class="hs-identifier hs-var">BrokenDependencies</span></a><span> </span><a name="local-6989586621681219875"><a href="#local-6989586621681219875"><span class="hs-identifier">uids</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;broken&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681219875"><span class="hs-identifier hs-var">uids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1152"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Packages.html#CyclicDependencies"><span class="hs-identifier hs-var">CyclicDependencies</span></a><span> </span><a name="local-6989586621681219876"><a href="#local-6989586621681219876"><span class="hs-identifier">uids</span></a></a><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;cyclic&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681219876"><span class="hs-identifier hs-var">uids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1153"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Packages.html#IgnoredDependencies"><span class="hs-identifier hs-var">IgnoredDependencies</span></a><span> </span><a name="local-6989586621681219877"><a href="#local-6989586621681219877"><span class="hs-identifier">uids</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ignored&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681219877"><span class="hs-identifier hs-var">uids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1154"></a><span>    </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-special">(</span><a href="Packages.html#ShadowedDependencies"><span class="hs-identifier hs-var">ShadowedDependencies</span></a><span> </span><a name="local-6989586621681219878"><a href="#local-6989586621681219878"><span class="hs-identifier">uids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;shadowed&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681219878"><span class="hs-identifier hs-var">uids</span></a><span class="hs-special">)</span><span>
</span><a name="line-1155"></a><span>
</span><a name="line-1156"></a><span class="hs-keyword">type</span><span> </span><a name="UnusablePackages"><a href="Packages.html#UnusablePackages"><span class="hs-identifier">UnusablePackages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span>
</span><a name="line-1157"></a><span>                            </span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span class="hs-special">)</span><span>
</span><a name="line-1158"></a><span>
</span><a name="line-1159"></a><span class="hs-identifier">pprReason</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackageReason"><span class="hs-identifier hs-type">UnusablePackageReason</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-1160"></a><a name="pprReason"><a href="Packages.html#pprReason"><span class="hs-identifier">pprReason</span></a></a><span> </span><a name="local-6989586621681220216"><a href="#local-6989586621681220216"><span class="hs-identifier">pref</span></a></a><span> </span><a name="local-6989586621681220217"><a href="#local-6989586621681220217"><span class="hs-identifier">reason</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220217"><span class="hs-identifier hs-var">reason</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1161"></a><span>  </span><a href="Packages.html#IgnoredWithFlag"><span class="hs-identifier hs-var">IgnoredWithFlag</span></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1162"></a><span>      </span><a href="#local-6989586621681220216"><span class="hs-identifier hs-var">pref</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;ignored due to an -ignore-package flag&quot;</span><span>
</span><a name="line-1163"></a><span>  </span><a href="Packages.html#BrokenDependencies"><span class="hs-identifier hs-var">BrokenDependencies</span></a><span> </span><a name="local-6989586621681220218"><a href="#local-6989586621681220218"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1164"></a><span>      </span><a href="#local-6989586621681220216"><span class="hs-identifier hs-var">pref</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;unusable due to missing dependencies:&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1165"></a><span>        </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220218"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1166"></a><span>  </span><a href="Packages.html#CyclicDependencies"><span class="hs-identifier hs-var">CyclicDependencies</span></a><span> </span><a name="local-6989586621681220219"><a href="#local-6989586621681220219"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1167"></a><span>      </span><a href="#local-6989586621681220216"><span class="hs-identifier hs-var">pref</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;unusable due to cyclic dependencies:&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1168"></a><span>        </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220219"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1169"></a><span>  </span><a href="Packages.html#IgnoredDependencies"><span class="hs-identifier hs-var">IgnoredDependencies</span></a><span> </span><a name="local-6989586621681220220"><a href="#local-6989586621681220220"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1170"></a><span>      </span><a href="#local-6989586621681220216"><span class="hs-identifier hs-var">pref</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;unusable because the -ignore-package flag was used to &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-1171"></a><span>                     </span><span class="hs-string">&quot;ignore at least one of its dependencies:&quot;</span><span class="hs-special">)</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1172"></a><span>        </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220220"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1173"></a><span>  </span><a href="Packages.html#ShadowedDependencies"><span class="hs-identifier hs-var">ShadowedDependencies</span></a><span> </span><a name="local-6989586621681220221"><a href="#local-6989586621681220221"><span class="hs-identifier">deps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1174"></a><span>      </span><a href="#local-6989586621681220216"><span class="hs-identifier hs-var">pref</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;unusable due to shadowed dependencies:&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1175"></a><span>        </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220221"><span class="hs-identifier hs-var">deps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1176"></a><span>
</span><a name="line-1177"></a><span class="hs-identifier">reportCycles</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1178"></a><a name="reportCycles"><a href="Packages.html#reportCycles"><span class="hs-identifier">reportCycles</span></a></a><span> </span><a name="local-6989586621681220222"><a href="#local-6989586621681220222"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220223"><a href="#local-6989586621681220223"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621681220224"><span class="hs-identifier hs-var">report</span></a><span> </span><a href="#local-6989586621681220223"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-1179"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1180"></a><span>    </span><a name="local-6989586621681220224"><a href="#local-6989586621681220224"><span class="hs-identifier">report</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1181"></a><span>    </span><span class="hs-identifier">report</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621681220225"><a href="#local-6989586621681220225"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1182"></a><span>        </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220222"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1183"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;these packages are involved in a cycle:&quot;</span><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span>
</span><a name="line-1184"></a><span>            </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#hsep"><span class="hs-identifier hs-var">hsep</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unitId</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220225"><span class="hs-identifier hs-var">vs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1185"></a><span>
</span><a name="line-1186"></a><span class="hs-identifier">reportUnusable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1187"></a><a name="reportUnusable"><a href="Packages.html#reportUnusable"><span class="hs-identifier">reportUnusable</span></a></a><span> </span><a name="local-6989586621681220226"><a href="#local-6989586621681220226"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220227"><a href="#local-6989586621681220227"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mapM_</span><span> </span><a href="#local-6989586621681220228"><span class="hs-identifier hs-var">report</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220227"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1188"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1189"></a><span>    </span><a name="local-6989586621681220228"><a href="#local-6989586621681220228"><span class="hs-identifier">report</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220229"><a href="#local-6989586621681220229"><span class="hs-identifier">ipid</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220230"><a href="#local-6989586621681220230"><span class="hs-identifier">reason</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1190"></a><span>       </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220226"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1191"></a><span>         </span><a href="Packages.html#pprReason"><span class="hs-identifier hs-var">pprReason</span></a><span>
</span><a name="line-1192"></a><span>           </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;package&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220229"><span class="hs-identifier hs-var">ipid</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;is&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220230"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-1193"></a><span>
</span><a name="line-1194"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-1195"></a><span class="hs-comment">--</span><span>
</span><a name="line-1196"></a><span class="hs-comment">-- Utilities on the database</span><span>
</span><a name="line-1197"></a><span class="hs-comment">--</span><span>
</span><a name="line-1198"></a><span>
</span><a name="line-1199"></a><span class="hs-comment">-- | A reverse dependency index, mapping an 'InstalledUnitId' to</span><span>
</span><a name="line-1200"></a><span class="hs-comment">-- the 'InstalledUnitId's which have a dependency on it.</span><span>
</span><a name="line-1201"></a><span class="hs-keyword">type</span><span> </span><a name="RevIndex"><a href="Packages.html#RevIndex"><span class="hs-identifier">RevIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1202"></a><span>
</span><a name="line-1203"></a><span class="hs-comment">-- | Compute the reverse dependency index of a package database.</span><span>
</span><a name="line-1204"></a><span class="hs-identifier">reverseDeps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#RevIndex"><span class="hs-identifier hs-type">RevIndex</span></a><span>
</span><a name="line-1205"></a><a name="reverseDeps"><a href="Packages.html#reverseDeps"><span class="hs-identifier">reverseDeps</span></a></a><span> </span><a name="local-6989586621681220231"><a href="#local-6989586621681220231"><span class="hs-identifier">db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.foldl'</span><span> </span><a href="#local-6989586621681220232"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621681220231"><span class="hs-identifier hs-var">db</span></a><span>
</span><a name="line-1206"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1207"></a><span>    </span><a name="local-6989586621681220232"><a href="#local-6989586621681220232"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681220234"><a href="#local-6989586621681220234"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621681220235"><a href="#local-6989586621681220235"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220233"><span class="hs-identifier hs-var">go'</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220235"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220234"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">depends</span><span> </span><a href="#local-6989586621681220235"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1208"></a><span>    </span><a name="local-6989586621681220233"><a href="#local-6989586621681220233"><span class="hs-identifier">go'</span></a></a><span> </span><a name="local-6989586621681220236"><a href="#local-6989586621681220236"><span class="hs-identifier">from</span></a></a><span> </span><a name="local-6989586621681220237"><a href="#local-6989586621681220237"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621681220238"><a href="#local-6989586621681220238"><span class="hs-identifier">to</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insertWith</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220238"><span class="hs-identifier hs-var">to</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681220236"><span class="hs-identifier hs-var">from</span></a><span class="hs-special">]</span><span> </span><a href="#local-6989586621681220237"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1209"></a><span>
</span><a name="line-1210"></a><span class="hs-comment">-- | Given a list of 'InstalledUnitId's to remove, a database,</span><span>
</span><a name="line-1211"></a><span class="hs-comment">-- and a reverse dependency index (as computed by 'reverseDeps'),</span><span>
</span><a name="line-1212"></a><span class="hs-comment">-- remove those packages, plus any packages which depend on them.</span><span>
</span><a name="line-1213"></a><span class="hs-comment">-- Returns the pruned database, as well as a list of 'PackageConfig's</span><span>
</span><a name="line-1214"></a><span class="hs-comment">-- that was removed.</span><span>
</span><a name="line-1215"></a><span class="hs-identifier">removePackages</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#RevIndex"><span class="hs-identifier hs-type">RevIndex</span></a><span>
</span><a name="line-1216"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span>
</span><a name="line-1217"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1218"></a><a name="removePackages"><a href="Packages.html#removePackages"><span class="hs-identifier">removePackages</span></a></a><span> </span><a name="local-6989586621681220239"><a href="#local-6989586621681220239"><span class="hs-identifier">uids</span></a></a><span> </span><a name="local-6989586621681220240"><a href="#local-6989586621681220240"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621681220241"><a href="#local-6989586621681220241"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220242"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220239"><span class="hs-identifier hs-var">uids</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220241"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1219"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1220"></a><span>    </span><a name="local-6989586621681220242"><a href="#local-6989586621681220242"><span class="hs-identifier">go</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220243"><a href="#local-6989586621681220243"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220244"><a href="#local-6989586621681220244"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220243"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><a href="#local-6989586621681220244"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1221"></a><span>    </span><span class="hs-identifier">go</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220245"><a href="#local-6989586621681220245"><span class="hs-identifier">uid</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621681220246"><a href="#local-6989586621681220246"><span class="hs-identifier">uids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220247"><a href="#local-6989586621681220247"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220248"><a href="#local-6989586621681220248"><span class="hs-identifier">pkgs</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1222"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220249"><a href="#local-6989586621681220249"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220245"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621681220247"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1223"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220245"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621681220240"><span class="hs-identifier hs-var">index</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1224"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220242"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220246"><span class="hs-identifier hs-var">uids</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.delete</span><span> </span><a href="#local-6989586621681220245"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621681220247"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220249"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681220248"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1225"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220250"><a href="#local-6989586621681220250"><span class="hs-identifier">rdeps</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220242"><span class="hs-identifier hs-var">go</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220250"><span class="hs-identifier hs-var">rdeps</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220246"><span class="hs-identifier hs-var">uids</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.delete</span><span> </span><a href="#local-6989586621681220245"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="#local-6989586621681220247"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220249"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681220248"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1226"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1227"></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220242"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220246"><span class="hs-identifier hs-var">uids</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220247"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><a href="#local-6989586621681220248"><span class="hs-identifier hs-var">pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1228"></a><span>
</span><a name="line-1229"></a><span class="hs-comment">-- | Given a 'PackageConfig' from some 'InstalledPackageIndex',</span><span>
</span><a name="line-1230"></a><span class="hs-comment">-- return all entries in 'depends' which correspond to packages</span><span>
</span><a name="line-1231"></a><span class="hs-comment">-- that do not exist in the index.</span><span>
</span><a name="line-1232"></a><span class="hs-identifier">depsNotAvailable</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span>
</span><a name="line-1233"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-1234"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1235"></a><a name="depsNotAvailable"><a href="Packages.html#depsNotAvailable"><span class="hs-identifier">depsNotAvailable</span></a></a><span> </span><a name="local-6989586621681220251"><a href="#local-6989586621681220251"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681220252"><a href="#local-6989586621681220252"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.member</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220251"><span class="hs-identifier hs-var">pkg_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">depends</span><span> </span><a href="#local-6989586621681220252"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1236"></a><span>
</span><a name="line-1237"></a><span class="hs-comment">-- | Given a 'PackageConfig' from some 'InstalledPackageIndex'</span><span>
</span><a name="line-1238"></a><span class="hs-comment">-- return all entries in 'abiDepends' which correspond to packages</span><span>
</span><a name="line-1239"></a><span class="hs-comment">-- that do not exist, OR have mismatching ABIs.</span><span>
</span><a name="line-1240"></a><span class="hs-identifier">depsAbiMismatch</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span>
</span><a name="line-1241"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-1242"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1243"></a><a name="depsAbiMismatch"><a href="Packages.html#depsAbiMismatch"><span class="hs-identifier">depsAbiMismatch</span></a></a><span> </span><a name="local-6989586621681220253"><a href="#local-6989586621681220253"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681220254"><a href="#local-6989586621681220254"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681220255"><span class="hs-identifier hs-var">abiMatch</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">abiDepends</span><span> </span><a href="#local-6989586621681220254"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1244"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1245"></a><span>    </span><a name="local-6989586621681220255"><a href="#local-6989586621681220255"><span class="hs-identifier">abiMatch</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220256"><a href="#local-6989586621681220256"><span class="hs-identifier">dep_uid</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220257"><a href="#local-6989586621681220257"><span class="hs-identifier">abi</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-1246"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220258"><a href="#local-6989586621681220258"><span class="hs-identifier">dep_pkg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220256"><span class="hs-identifier hs-var">dep_uid</span></a><span> </span><a href="#local-6989586621681220253"><span class="hs-identifier hs-var">pkg_map</span></a><span>
</span><a name="line-1247"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">abiHash</span><span> </span><a href="#local-6989586621681220258"><span class="hs-identifier hs-var">dep_pkg</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621681220257"><span class="hs-identifier hs-var">abi</span></a><span>
</span><a name="line-1248"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1249"></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1250"></a><span>
</span><a name="line-1251"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1252"></a><span class="hs-comment">-- Ignore packages</span><span>
</span><a name="line-1253"></a><span>
</span><a name="line-1254"></a><span class="hs-identifier">ignorePackages</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="DynFlags.html#IgnorePackageFlag"><span class="hs-identifier hs-type">IgnorePackageFlag</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span>
</span><a name="line-1255"></a><a name="ignorePackages"><a href="Packages.html#ignorePackages"><span class="hs-identifier">ignorePackages</span></a></a><span> </span><a name="local-6989586621681220259"><a href="#local-6989586621681220259"><span class="hs-identifier">flags</span></a></a><span> </span><a name="local-6989586621681220260"><a href="#local-6989586621681220260"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621681220261"><span class="hs-identifier hs-var">doit</span></a><span> </span><a href="#local-6989586621681220259"><span class="hs-identifier hs-var">flags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1256"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1257"></a><span>  </span><a name="local-6989586621681220261"><a href="#local-6989586621681220261"><span class="hs-identifier">doit</span></a></a><span> </span><span class="hs-special">(</span><a href="DynFlags.html#IgnorePackage"><span class="hs-identifier hs-var">IgnorePackage</span></a><span> </span><a name="local-6989586621681220262"><a href="#local-6989586621681220262"><span class="hs-identifier">str</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1258"></a><span>     </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">partition</span><span> </span><span class="hs-special">(</span><a href="Packages.html#matchingStr"><span class="hs-identifier hs-var">matchingStr</span></a><span> </span><a href="#local-6989586621681220262"><span class="hs-identifier hs-var">str</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220260"><span class="hs-identifier hs-var">pkgs</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1259"></a><span>         </span><span class="hs-special">(</span><a name="local-6989586621681220263"><a href="#local-6989586621681220263"><span class="hs-identifier">ps</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220264"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220264"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#IgnoredWithFlag"><span class="hs-identifier hs-var">IgnoredWithFlag</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1260"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220264"><a href="#local-6989586621681220264"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220263"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1261"></a><span>        </span><span class="hs-comment">-- missing package is not an error for -ignore-package,</span><span>
</span><a name="line-1262"></a><span>        </span><span class="hs-comment">-- because a common usage is to -ignore-package P as</span><span>
</span><a name="line-1263"></a><span>        </span><span class="hs-comment">-- a preventative measure just in case P exists.</span><span>
</span><a name="line-1264"></a><span>
</span><a name="line-1265"></a><span class="hs-comment">-- ----------------------------------------------------------------------------</span><span>
</span><a name="line-1266"></a><span class="hs-comment">--</span><span>
</span><a name="line-1267"></a><span class="hs-comment">-- Merging databases</span><span>
</span><a name="line-1268"></a><span class="hs-comment">--</span><span>
</span><a name="line-1269"></a><span>
</span><a name="line-1270"></a><span class="hs-comment">-- | For each package, a mapping from uid -&gt; i indicates that this</span><span>
</span><a name="line-1271"></a><span class="hs-comment">-- package was brought into GHC by the ith @-package-db@ flag on</span><span>
</span><a name="line-1272"></a><span class="hs-comment">-- the command line.  We use this mapping to make sure we prefer</span><span>
</span><a name="line-1273"></a><span class="hs-comment">-- packages that were defined later on the command line, if there</span><span>
</span><a name="line-1274"></a><span class="hs-comment">-- is an ambiguity.</span><span>
</span><a name="line-1275"></a><span class="hs-keyword">type</span><span> </span><a name="PackagePrecedenceIndex"><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier">PackagePrecedenceIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-1276"></a><span>
</span><a name="line-1277"></a><span class="hs-comment">-- | Given a list of databases, merge them together, where</span><span>
</span><a name="line-1278"></a><span class="hs-comment">-- packages with the same unit id in later databases override</span><span>
</span><a name="line-1279"></a><span class="hs-comment">-- earlier ones.  This does NOT check if the resulting database</span><span>
</span><a name="line-1280"></a><span class="hs-comment">-- makes sense (that's done by 'validateDatabase').</span><span>
</span><a name="line-1281"></a><span class="hs-identifier">mergeDatabases</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1282"></a><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span class="hs-special">)</span><span>
</span><a name="line-1283"></a><a name="mergeDatabases"><a href="Packages.html#mergeDatabases"><span class="hs-identifier">mergeDatabases</span></a></a><span> </span><a name="local-6989586621681220265"><a href="#local-6989586621681220265"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621681220266"><span class="hs-identifier hs-var">merge</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-1284"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1285"></a><span>    </span><a name="local-6989586621681220266"><a href="#local-6989586621681220266"><span class="hs-identifier">merge</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220267"><a href="#local-6989586621681220267"><span class="hs-identifier">pkg_map</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220268"><a href="#local-6989586621681220268"><span class="hs-identifier">prec_map</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220269"><a href="#local-6989586621681220269"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220270"><a href="#local-6989586621681220270"><span class="hs-identifier">db_path</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220271"><a href="#local-6989586621681220271"><span class="hs-identifier">db</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1286"></a><span>      </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220265"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1287"></a><span>          </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;loading package database&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><a href="#local-6989586621681220270"><span class="hs-identifier hs-var">db_path</span></a><span>
</span><a name="line-1288"></a><span>      </span><span class="hs-identifier hs-var">forM_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span> </span><a href="#local-6989586621681220274"><span class="hs-identifier hs-var">override_set</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681220278"><a href="#local-6989586621681220278"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1289"></a><span>          </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220265"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1290"></a><span>              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;package&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220278"><span class="hs-identifier hs-var">pkg</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1291"></a><span>              </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;overrides a previously defined package&quot;</span><span>
</span><a name="line-1292"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220275"><span class="hs-identifier hs-var">pkg_map'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220276"><span class="hs-identifier hs-var">prec_map'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1293"></a><span>     </span><span class="hs-keyword">where</span><span>
</span><a name="line-1294"></a><span>      </span><a name="local-6989586621681220272"><a href="#local-6989586621681220272"><span class="hs-identifier">db_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220273"><span class="hs-identifier hs-var">mk_pkg_map</span></a><span> </span><a href="#local-6989586621681220271"><span class="hs-identifier hs-var">db</span></a><span>
</span><a name="line-1295"></a><span>      </span><a name="local-6989586621681220273"><a href="#local-6989586621681220273"><span class="hs-identifier">mk_pkg_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681220277"><a href="#local-6989586621681220277"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220277"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220277"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1296"></a><span>
</span><a name="line-1297"></a><span>      </span><span class="hs-comment">-- The set of UnitIds which appear in both db and pkgs.  These are the</span><span>
</span><a name="line-1298"></a><span>      </span><span class="hs-comment">-- ones that get overridden.  Compute this just to give some</span><span>
</span><a name="line-1299"></a><span>      </span><span class="hs-comment">-- helpful debug messages at -v2</span><span>
</span><a name="line-1300"></a><span>      </span><span class="hs-identifier">override_set</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Set</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span>
</span><a name="line-1301"></a><span>      </span><a name="local-6989586621681220274"><a href="#local-6989586621681220274"><span class="hs-identifier">override_set</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Set.intersection</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621681220272"><span class="hs-identifier hs-var">db_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-1302"></a><span>                                      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.keysSet</span><span> </span><a href="#local-6989586621681220267"><span class="hs-identifier hs-var">pkg_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-1303"></a><span>
</span><a name="line-1304"></a><span>      </span><span class="hs-comment">-- Now merge the sets together (NB: in case of duplicate,</span><span>
</span><a name="line-1305"></a><span>      </span><span class="hs-comment">-- first argument preferred)</span><span>
</span><a name="line-1306"></a><span>      </span><span class="hs-identifier">pkg_map'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span>
</span><a name="line-1307"></a><span>      </span><a name="local-6989586621681220275"><a href="#local-6989586621681220275"><span class="hs-identifier">pkg_map'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><a href="#local-6989586621681220272"><span class="hs-identifier hs-var">db_map</span></a><span> </span><a href="#local-6989586621681220267"><span class="hs-identifier hs-var">pkg_map</span></a><span>
</span><a name="line-1308"></a><span>
</span><a name="line-1309"></a><span>      </span><span class="hs-identifier">prec_map'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackagePrecedenceIndex"><span class="hs-identifier hs-type">PackagePrecedenceIndex</span></a><span>
</span><a name="line-1310"></a><span>      </span><a name="local-6989586621681220276"><a href="#local-6989586621681220276"><span class="hs-identifier">prec_map'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621681220269"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220272"><span class="hs-identifier hs-var">db_map</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220268"><span class="hs-identifier hs-var">prec_map</span></a><span>
</span><a name="line-1311"></a><span>
</span><a name="line-1312"></a><span class="hs-comment">-- | Validates a database, removing unusable packages from it</span><span>
</span><a name="line-1313"></a><span class="hs-comment">-- (this includes removing packages that the user has explicitly</span><span>
</span><a name="line-1314"></a><span class="hs-comment">-- ignored.)  Our general strategy:</span><span>
</span><a name="line-1315"></a><span class="hs-comment">--</span><span>
</span><a name="line-1316"></a><span class="hs-comment">-- 1. Remove all broken packages (dangling dependencies)</span><span>
</span><a name="line-1317"></a><span class="hs-comment">-- 2. Remove all packages that are cyclic</span><span>
</span><a name="line-1318"></a><span class="hs-comment">-- 3. Apply ignore flags</span><span>
</span><a name="line-1319"></a><span class="hs-comment">-- 4. Remove all packages which have deps with mismatching ABIs</span><span>
</span><a name="line-1320"></a><span class="hs-comment">--</span><span>
</span><a name="line-1321"></a><span class="hs-identifier">validateDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span>
</span><a name="line-1322"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Packages.html#InstalledPackageIndex"><span class="hs-identifier hs-type">InstalledPackageIndex</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">SCC</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1323"></a><a name="validateDatabase"><a href="Packages.html#validateDatabase"><span class="hs-identifier">validateDatabase</span></a></a><span> </span><a name="local-6989586621681220279"><a href="#local-6989586621681220279"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220280"><a href="#local-6989586621681220280"><span class="hs-identifier">pkg_map1</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1324"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621681220298"><span class="hs-identifier hs-var">pkg_map5</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220301"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220288"><span class="hs-identifier hs-var">sccs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1325"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1326"></a><span>    </span><a name="local-6989586621681220281"><a href="#local-6989586621681220281"><span class="hs-identifier">ignore_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ignorePackageFlags</span><span> </span><a href="#local-6989586621681220279"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1327"></a><span>
</span><a name="line-1328"></a><span>    </span><span class="hs-comment">-- Compute the reverse dependency index</span><span>
</span><a name="line-1329"></a><span>    </span><a name="local-6989586621681220282"><a href="#local-6989586621681220282"><span class="hs-identifier">index</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#reverseDeps"><span class="hs-identifier hs-var">reverseDeps</span></a><span> </span><a href="#local-6989586621681220280"><span class="hs-identifier hs-var">pkg_map1</span></a><span>
</span><a name="line-1330"></a><span>
</span><a name="line-1331"></a><span>    </span><span class="hs-comment">-- Helper function</span><span>
</span><a name="line-1332"></a><span>    </span><a name="local-6989586621681220283"><a href="#local-6989586621681220283"><span class="hs-identifier">mk_unusable</span></a></a><span> </span><a name="local-6989586621681220302"><a href="#local-6989586621681220302"><span class="hs-identifier">mk_err</span></a></a><span> </span><a name="local-6989586621681220303"><a href="#local-6989586621681220303"><span class="hs-identifier">dep_matcher</span></a></a><span> </span><a name="local-6989586621681220304"><a href="#local-6989586621681220304"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621681220305"><a href="#local-6989586621681220305"><span class="hs-identifier">uids</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1333"></a><span>      </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220306"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220306"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220302"><span class="hs-identifier hs-var">mk_err</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220303"><span class="hs-identifier hs-var">dep_matcher</span></a><span> </span><a href="#local-6989586621681220304"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621681220306"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1334"></a><span>                   </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220306"><a href="#local-6989586621681220306"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220305"><span class="hs-identifier hs-var">uids</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1335"></a><span>
</span><a name="line-1336"></a><span>    </span><span class="hs-comment">-- Find broken packages</span><span>
</span><a name="line-1337"></a><span>    </span><a name="local-6989586621681220284"><a href="#local-6989586621681220284"><span class="hs-identifier">directly_broken</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Packages.html#depsNotAvailable"><span class="hs-identifier hs-var">depsNotAvailable</span></a><span> </span><a href="#local-6989586621681220280"><span class="hs-identifier hs-var">pkg_map1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1338"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220280"><span class="hs-identifier hs-var">pkg_map1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1339"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681220285"><a href="#local-6989586621681220285"><span class="hs-identifier">pkg_map2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220286"><a href="#local-6989586621681220286"><span class="hs-identifier">broken</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#removePackages"><span class="hs-identifier hs-var">removePackages</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220284"><span class="hs-identifier hs-var">directly_broken</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220282"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621681220280"><span class="hs-identifier hs-var">pkg_map1</span></a><span>
</span><a name="line-1340"></a><span>    </span><a name="local-6989586621681220287"><a href="#local-6989586621681220287"><span class="hs-identifier">unusable_broken</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220283"><span class="hs-identifier hs-var">mk_unusable</span></a><span> </span><a href="Packages.html#BrokenDependencies"><span class="hs-identifier hs-var">BrokenDependencies</span></a><span> </span><a href="Packages.html#depsNotAvailable"><span class="hs-identifier hs-var">depsNotAvailable</span></a><span> </span><a href="#local-6989586621681220285"><span class="hs-identifier hs-var">pkg_map2</span></a><span> </span><a href="#local-6989586621681220286"><span class="hs-identifier hs-var">broken</span></a><span>
</span><a name="line-1341"></a><span>
</span><a name="line-1342"></a><span>    </span><span class="hs-comment">-- Find recursive packages</span><span>
</span><a name="line-1343"></a><span>    </span><a name="local-6989586621681220288"><a href="#local-6989586621681220288"><span class="hs-identifier">sccs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">stronglyConnComp</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220307"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220307"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">depends</span><span> </span><a href="#local-6989586621681220307"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1344"></a><span>                            </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220307"><a href="#local-6989586621681220307"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220285"><span class="hs-identifier hs-var">pkg_map2</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1345"></a><span>    </span><a name="local-6989586621681220289"><a href="#local-6989586621681220289"><span class="hs-identifier">getCyclicSCC</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">CyclicSCC</span><span> </span><a name="local-6989586621681220308"><a href="#local-6989586621681220308"><span class="hs-identifier">vs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220308"><span class="hs-identifier hs-var">vs</span></a><span>
</span><a name="line-1346"></a><span>    </span><span class="hs-identifier">getCyclicSCC</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AcyclicSCC</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1347"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681220290"><a href="#local-6989586621681220290"><span class="hs-identifier">pkg_map3</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220291"><a href="#local-6989586621681220291"><span class="hs-identifier">cyclic</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#removePackages"><span class="hs-identifier hs-var">removePackages</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><a href="#local-6989586621681220289"><span class="hs-identifier hs-var">getCyclicSCC</span></a><span> </span><a href="#local-6989586621681220288"><span class="hs-identifier hs-var">sccs</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220282"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621681220285"><span class="hs-identifier hs-var">pkg_map2</span></a><span>
</span><a name="line-1348"></a><span>    </span><a name="local-6989586621681220292"><a href="#local-6989586621681220292"><span class="hs-identifier">unusable_cyclic</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220283"><span class="hs-identifier hs-var">mk_unusable</span></a><span> </span><a href="Packages.html#CyclicDependencies"><span class="hs-identifier hs-var">CyclicDependencies</span></a><span> </span><a href="Packages.html#depsNotAvailable"><span class="hs-identifier hs-var">depsNotAvailable</span></a><span> </span><a href="#local-6989586621681220290"><span class="hs-identifier hs-var">pkg_map3</span></a><span> </span><a href="#local-6989586621681220291"><span class="hs-identifier hs-var">cyclic</span></a><span>
</span><a name="line-1349"></a><span>
</span><a name="line-1350"></a><span>    </span><span class="hs-comment">-- Apply ignore flags</span><span>
</span><a name="line-1351"></a><span>    </span><a name="local-6989586621681220293"><a href="#local-6989586621681220293"><span class="hs-identifier">directly_ignored</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ignorePackages"><span class="hs-identifier hs-var">ignorePackages</span></a><span> </span><a href="#local-6989586621681220281"><span class="hs-identifier hs-var">ignore_flags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220290"><span class="hs-identifier hs-var">pkg_map3</span></a><span class="hs-special">)</span><span>
</span><a name="line-1352"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681220294"><a href="#local-6989586621681220294"><span class="hs-identifier">pkg_map4</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220295"><a href="#local-6989586621681220295"><span class="hs-identifier">ignored</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#removePackages"><span class="hs-identifier hs-var">removePackages</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.keys</span><span> </span><a href="#local-6989586621681220293"><span class="hs-identifier hs-var">directly_ignored</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220282"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621681220290"><span class="hs-identifier hs-var">pkg_map3</span></a><span>
</span><a name="line-1353"></a><span>    </span><a name="local-6989586621681220296"><a href="#local-6989586621681220296"><span class="hs-identifier">unusable_ignored</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220283"><span class="hs-identifier hs-var">mk_unusable</span></a><span> </span><a href="Packages.html#IgnoredDependencies"><span class="hs-identifier hs-var">IgnoredDependencies</span></a><span> </span><a href="Packages.html#depsNotAvailable"><span class="hs-identifier hs-var">depsNotAvailable</span></a><span> </span><a href="#local-6989586621681220294"><span class="hs-identifier hs-var">pkg_map4</span></a><span> </span><a href="#local-6989586621681220295"><span class="hs-identifier hs-var">ignored</span></a><span>
</span><a name="line-1354"></a><span>
</span><a name="line-1355"></a><span>    </span><span class="hs-comment">-- Knock out packages whose dependencies don't agree with ABI</span><span>
</span><a name="line-1356"></a><span>    </span><span class="hs-comment">-- (i.e., got invalidated due to shadowing)</span><span>
</span><a name="line-1357"></a><span>    </span><a name="local-6989586621681220297"><a href="#local-6989586621681220297"><span class="hs-identifier">directly_shadowed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Packages.html#depsAbiMismatch"><span class="hs-identifier hs-var">depsAbiMismatch</span></a><span> </span><a href="#local-6989586621681220294"><span class="hs-identifier hs-var">pkg_map4</span></a><span class="hs-special">)</span><span>
</span><a name="line-1358"></a><span>                               </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220294"><span class="hs-identifier hs-var">pkg_map4</span></a><span class="hs-special">)</span><span>
</span><a name="line-1359"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621681220298"><a href="#local-6989586621681220298"><span class="hs-identifier">pkg_map5</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220299"><a href="#local-6989586621681220299"><span class="hs-identifier">shadowed</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#removePackages"><span class="hs-identifier hs-var">removePackages</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220297"><span class="hs-identifier hs-var">directly_shadowed</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220282"><span class="hs-identifier hs-var">index</span></a><span> </span><a href="#local-6989586621681220294"><span class="hs-identifier hs-var">pkg_map4</span></a><span>
</span><a name="line-1360"></a><span>    </span><a name="local-6989586621681220300"><a href="#local-6989586621681220300"><span class="hs-identifier">unusable_shadowed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220283"><span class="hs-identifier hs-var">mk_unusable</span></a><span> </span><a href="Packages.html#ShadowedDependencies"><span class="hs-identifier hs-var">ShadowedDependencies</span></a><span> </span><a href="Packages.html#depsAbiMismatch"><span class="hs-identifier hs-var">depsAbiMismatch</span></a><span> </span><a href="#local-6989586621681220298"><span class="hs-identifier hs-var">pkg_map5</span></a><span> </span><a href="#local-6989586621681220299"><span class="hs-identifier hs-var">shadowed</span></a><span>
</span><a name="line-1361"></a><span>
</span><a name="line-1362"></a><span>    </span><a name="local-6989586621681220301"><a href="#local-6989586621681220301"><span class="hs-identifier">unusable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220293"><span class="hs-identifier hs-var">directly_ignored</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220296"><span class="hs-identifier hs-var">unusable_ignored</span></a><span>
</span><a name="line-1363"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220287"><span class="hs-identifier hs-var">unusable_broken</span></a><span>
</span><a name="line-1364"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220292"><span class="hs-identifier hs-var">unusable_cyclic</span></a><span>
</span><a name="line-1365"></a><span>                                </span><span class="hs-special">`</span><span class="hs-identifier hs-var">Map.union</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220300"><span class="hs-identifier hs-var">unusable_shadowed</span></a><span>
</span><a name="line-1366"></a><span>
</span><a name="line-1367"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1368"></a><span class="hs-comment">-- When all the command-line options are in, we can process our package</span><span>
</span><a name="line-1369"></a><span class="hs-comment">-- settings and populate the package state.</span><span>
</span><a name="line-1370"></a><span>
</span><a name="line-1371"></a><span class="hs-identifier">mkPackageState</span><span>
</span><a name="line-1372"></a><span>    </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1373"></a><span>    </span><span class="hs-comment">-- initial databases, in the order they were specified on</span><span>
</span><a name="line-1374"></a><span>    </span><span class="hs-comment">-- the command line (later databases shadow earlier ones)</span><span>
</span><a name="line-1375"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1376"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span>              </span><span class="hs-comment">-- preloaded packages</span><span>
</span><a name="line-1377"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="Packages.html#PackageState"><span class="hs-identifier hs-type">PackageState</span></a><span class="hs-special">,</span><span>
</span><a name="line-1378"></a><span>           </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span>         </span><span class="hs-comment">-- new packages to preload</span><span>
</span><a name="line-1379"></a><span>           </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1380"></a><span>
</span><a name="line-1381"></a><a name="mkPackageState"><a href="Packages.html#mkPackageState"><span class="hs-identifier">mkPackageState</span></a></a><span> </span><a name="local-6989586621681220309"><a href="#local-6989586621681220309"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220310"><a href="#local-6989586621681220310"><span class="hs-identifier">dbs</span></a></a><span> </span><a name="local-6989586621681220311"><a href="#local-6989586621681220311"><span class="hs-identifier">preload0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1382"></a><span class="hs-comment">{-
   Plan.

   There are two main steps for making the package state:

    1. We want to build a single, unified package database based
       on all of the input databases, which upholds the invariant that
       there is only one package per any UnitId and there are no
       dangling dependencies.  We'll do this by merging, and
       then successively filtering out bad dependencies.

       a) Merge all the databases together.
          If an input database defines unit ID that is already in
          the unified database, that package SHADOWS the existing
          package in the current unified database.  Note that
          order is important: packages defined later in the list of
          command line arguments shadow those defined earlier.

       b) Remove all packages with missing dependencies, or
          mutually recursive dependencies.

       b) Remove packages selected by -ignore-package from input database

       c) Remove all packages which depended on packages that are now
          shadowed by an ABI-incompatible package

       d) report (with -v) any packages that were removed by steps 1-3

    2. We want to look at the flags controlling package visibility,
       and build a mapping of what module names are in scope and
       where they live.

       a) on the final, unified database, we apply -trust/-distrust
          flags directly, modifying the database so that the 'trusted'
          field has the correct value.

       b) we use the -package/-hide-package flags to compute a
          visibility map, stating what packages are &quot;exposed&quot; for
          the purposes of computing the module map.
          * if any flag refers to a package which was removed by 1-5, then
            we can give an error message explaining why
          * if -hide-all-packages what not specified, this step also
            hides packages which are superseded by later exposed packages
          * this step is done TWICE if -plugin-package/-hide-all-plugin-packages
            are used

       c) based on the visibility map, we pick wired packages and rewrite
          them to have the expected unitId.

       d) finally, using the visibility map and the package database,
          we build a mapping saying what every in scope module name points to.
-}</span><span>
</span><a name="line-1434"></a><span>
</span><a name="line-1435"></a><span>  </span><span class="hs-comment">-- This, and the other reverse's that you will see, are due to the face that</span><span>
</span><a name="line-1436"></a><span>  </span><span class="hs-comment">-- packageFlags, pluginPackageFlags, etc. are all specified in *reverse* order</span><span>
</span><a name="line-1437"></a><span>  </span><span class="hs-comment">-- than they are on the command line.</span><span>
</span><a name="line-1438"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220312"><a href="#local-6989586621681220312"><span class="hs-identifier">other_flags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">packageFlags</span><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1439"></a><span>  </span><a href="ErrUtils.html#debugTraceMsg"><span class="hs-identifier hs-var">debugTraceMsg</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-1440"></a><span>      </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;package flags&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220312"><span class="hs-identifier hs-var">other_flags</span></a><span>
</span><a name="line-1441"></a><span>
</span><a name="line-1442"></a><span>  </span><span class="hs-comment">-- Merge databases together, without checking validity</span><span>
</span><a name="line-1443"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681220313"><a href="#local-6989586621681220313"><span class="hs-identifier">pkg_map1</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220314"><a href="#local-6989586621681220314"><span class="hs-identifier">prec_map</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#mergeDatabases"><span class="hs-identifier hs-var">mergeDatabases</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220310"><span class="hs-identifier hs-var">dbs</span></a><span>
</span><a name="line-1444"></a><span>
</span><a name="line-1445"></a><span>  </span><span class="hs-comment">-- Now that we've merged everything together, prune out unusable</span><span>
</span><a name="line-1446"></a><span>  </span><span class="hs-comment">-- packages.</span><span>
</span><a name="line-1447"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220315"><a href="#local-6989586621681220315"><span class="hs-identifier">pkg_map2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220316"><a href="#local-6989586621681220316"><span class="hs-identifier">unusable</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220317"><a href="#local-6989586621681220317"><span class="hs-identifier">sccs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#validateDatabase"><span class="hs-identifier hs-var">validateDatabase</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220313"><span class="hs-identifier hs-var">pkg_map1</span></a><span>
</span><a name="line-1448"></a><span>
</span><a name="line-1449"></a><span>  </span><a href="Packages.html#reportCycles"><span class="hs-identifier hs-var">reportCycles</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220317"><span class="hs-identifier hs-var">sccs</span></a><span>
</span><a name="line-1450"></a><span>  </span><a href="Packages.html#reportUnusable"><span class="hs-identifier hs-var">reportUnusable</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220316"><span class="hs-identifier hs-var">unusable</span></a><span>
</span><a name="line-1451"></a><span>
</span><a name="line-1452"></a><span>  </span><span class="hs-comment">-- Apply trust flags (these flags apply regardless of whether</span><span>
</span><a name="line-1453"></a><span>  </span><span class="hs-comment">-- or not packages are visible or not)</span><span>
</span><a name="line-1454"></a><span>  </span><a name="local-6989586621681220318"><a href="#local-6989586621681220318"><span class="hs-identifier">pkgs1</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#applyTrustFlag"><span class="hs-identifier hs-var">applyTrustFlag</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220314"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220316"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">)</span><span>
</span><a name="line-1455"></a><span>                 </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220315"><span class="hs-identifier hs-var">pkg_map2</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">trustFlags</span><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1456"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220319"><a href="#local-6989586621681220319"><span class="hs-identifier">prelim_pkg_db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#extendPackageConfigMap"><span class="hs-identifier hs-var">extendPackageConfigMap</span></a><span> </span><a href="Packages.html#emptyPackageConfigMap"><span class="hs-identifier hs-var">emptyPackageConfigMap</span></a><span> </span><a href="#local-6989586621681220318"><span class="hs-identifier hs-var">pkgs1</span></a><span>
</span><a name="line-1457"></a><span>
</span><a name="line-1458"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1459"></a><span>  </span><span class="hs-comment">-- Calculate the initial set of units from package databases, prior to any package flags.</span><span>
</span><a name="line-1460"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1461"></a><span>  </span><span class="hs-comment">-- Conceptually, we select the latest versions of all valid (not unusable) *packages*</span><span>
</span><a name="line-1462"></a><span>  </span><span class="hs-comment">-- (not units). This is empty if we have -hide-all-packages.</span><span>
</span><a name="line-1463"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1464"></a><span>  </span><span class="hs-comment">-- Then we create an initial visibility map with default visibilities for all</span><span>
</span><a name="line-1465"></a><span>  </span><span class="hs-comment">-- exposed, definite units which belong to the latest valid packages.</span><span>
</span><a name="line-1466"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1467"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220320"><a href="#local-6989586621681220320"><span class="hs-identifier">preferLater</span></a></a><span> </span><span class="hs-keyword">unit</span><span> </span><a name="local-6989586621681220326"><a href="#local-6989586621681220326"><span class="hs-identifier">unit'</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1468"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#compareByPreference"><span class="hs-identifier hs-var">compareByPreference</span></a><span> </span><a href="#local-6989586621681220314"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><span class="hs-keyword">unit</span><span> </span><a href="#local-6989586621681220326"><span class="hs-identifier hs-var">unit'</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1469"></a><span>            </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">unit</span><span>
</span><a name="line-1470"></a><span>            </span><span class="hs-identifier">_</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220326"><span class="hs-identifier hs-var">unit'</span></a><span>
</span><a name="line-1471"></a><span>      </span><a name="local-6989586621681220321"><a href="#local-6989586621681220321"><span class="hs-identifier">addIfMorePreferable</span></a></a><span> </span><a name="local-6989586621681220327"><a href="#local-6989586621681220327"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-keyword">unit</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqDFM.html#addToUDFM_C"><span class="hs-identifier hs-var">addToUDFM_C</span></a><span> </span><a href="#local-6989586621681220320"><span class="hs-identifier hs-var">preferLater</span></a><span> </span><a href="#local-6989586621681220327"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#fsPackageName"><span class="hs-identifier hs-var">fsPackageName</span></a><span> </span><span class="hs-keyword">unit</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">unit</span><span>
</span><a name="line-1472"></a><span>      </span><span class="hs-comment">-- This is the set of maximally preferable packages. In fact, it is a set of</span><span>
</span><a name="line-1473"></a><span>      </span><span class="hs-comment">-- most preferable *units* keyed by package name, which act as stand-ins in </span><span>
</span><a name="line-1474"></a><span>      </span><span class="hs-comment">-- for &quot;a package in a database&quot;. We use units here because we don't have </span><span>
</span><a name="line-1475"></a><span>      </span><span class="hs-comment">-- &quot;a package in a database&quot; as a type currently.</span><span>
</span><a name="line-1476"></a><span>      </span><a name="local-6989586621681220322"><a href="#local-6989586621681220322"><span class="hs-identifier">mostPreferablePackageReps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_HideAllPackages"><span class="hs-identifier hs-var">Opt_HideAllPackages</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1477"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><a href="UniqDFM.html#emptyUDFM"><span class="hs-identifier hs-var">emptyUDFM</span></a><span>
</span><a name="line-1478"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621681220321"><span class="hs-identifier hs-var">addIfMorePreferable</span></a><span> </span><a href="UniqDFM.html#emptyUDFM"><span class="hs-identifier hs-var">emptyUDFM</span></a><span> </span><a href="#local-6989586621681220318"><span class="hs-identifier hs-var">pkgs1</span></a><span>
</span><a name="line-1479"></a><span>      </span><span class="hs-comment">-- When exposing units, we want to consider all of those in the most preferable</span><span>
</span><a name="line-1480"></a><span>      </span><span class="hs-comment">-- packages. We can implement that by looking for units that are equi-preferable</span><span>
</span><a name="line-1481"></a><span>      </span><span class="hs-comment">-- with the most preferable unit for package. Being equi-preferable means that</span><span>
</span><a name="line-1482"></a><span>      </span><span class="hs-comment">-- they must be in the same database, with the same version, and the same pacakge name.</span><span>
</span><a name="line-1483"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1484"></a><span>      </span><span class="hs-comment">-- We must take care to consider all these units and not just the most </span><span>
</span><a name="line-1485"></a><span>      </span><span class="hs-comment">-- preferable one, otherwise we can end up with problems like #16228.</span><span>
</span><a name="line-1486"></a><span>      </span><a name="local-6989586621681220323"><a href="#local-6989586621681220323"><span class="hs-identifier">mostPreferable</span></a></a><span> </span><a name="local-6989586621681220329"><a href="#local-6989586621681220329"><span class="hs-identifier">u</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1487"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="UniqDFM.html#lookupUDFM"><span class="hs-identifier hs-var">lookupUDFM</span></a><span> </span><a href="#local-6989586621681220322"><span class="hs-identifier hs-var">mostPreferablePackageReps</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#fsPackageName"><span class="hs-identifier hs-var">fsPackageName</span></a><span> </span><a href="#local-6989586621681220329"><span class="hs-identifier hs-var">u</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1488"></a><span>          </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1489"></a><span>          </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220330"><a href="#local-6989586621681220330"><span class="hs-identifier">u'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#compareByPreference"><span class="hs-identifier hs-var">compareByPreference</span></a><span> </span><a href="#local-6989586621681220314"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220329"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621681220330"><span class="hs-identifier hs-var">u'</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">EQ</span><span>
</span><a name="line-1490"></a><span>      </span><a name="local-6989586621681220324"><a href="#local-6989586621681220324"><span class="hs-identifier">vis_map1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681220331"><a href="#local-6989586621681220331"><span class="hs-identifier">vm</span></a></a><span> </span><a name="local-6989586621681220332"><a href="#local-6989586621681220332"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1491"></a><span>                            </span><span class="hs-comment">-- Note: we NEVER expose indefinite packages by</span><span>
</span><a name="line-1492"></a><span>                            </span><span class="hs-comment">-- default, because it's almost assuredly not</span><span>
</span><a name="line-1493"></a><span>                            </span><span class="hs-comment">-- what you want (no mix-in linking has occurred).</span><span>
</span><a name="line-1494"></a><span>                            </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">exposed</span><span> </span><a href="#local-6989586621681220332"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="Module.html#unitIdIsDefinite"><span class="hs-identifier hs-var">unitIdIsDefinite</span></a><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220332"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-6989586621681220323"><span class="hs-identifier hs-var">mostPreferable</span></a><span> </span><a href="#local-6989586621681220332"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-1495"></a><span>                               </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220332"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-1496"></a><span>                                               </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-var">UnitVisibility</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1497"></a><span>                                                 </span><span class="hs-identifier">uv_expose_all</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span class="hs-special">,</span><span>
</span><a name="line-1498"></a><span>                                                 </span><span class="hs-identifier">uv_renamings</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1499"></a><span>                                                 </span><span class="hs-identifier">uv_package_name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">First</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Packages.html#fsPackageName"><span class="hs-identifier hs-var">fsPackageName</span></a><span> </span><a href="#local-6989586621681220332"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-1500"></a><span>                                                 </span><span class="hs-identifier">uv_requirements</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span class="hs-special">,</span><span>
</span><a name="line-1501"></a><span>                                                 </span><span class="hs-identifier">uv_explicit</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-1502"></a><span>                                               </span><span class="hs-special">}</span><span>
</span><a name="line-1503"></a><span>                                               </span><a href="#local-6989586621681220331"><span class="hs-identifier hs-var">vm</span></a><span>
</span><a name="line-1504"></a><span>                               </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681220331"><span class="hs-identifier hs-var">vm</span></a><span class="hs-special">)</span><span>
</span><a name="line-1505"></a><span>                         </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621681220318"><span class="hs-identifier hs-var">pkgs1</span></a><span>
</span><a name="line-1506"></a><span>
</span><a name="line-1507"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1508"></a><span>  </span><span class="hs-comment">-- Compute a visibility map according to the command-line flags (-package,</span><span>
</span><a name="line-1509"></a><span>  </span><span class="hs-comment">-- -hide-package).  This needs to know about the unusable packages, since if a</span><span>
</span><a name="line-1510"></a><span>  </span><span class="hs-comment">-- user tries to enable an unusable package, we should let them know.</span><span>
</span><a name="line-1511"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1512"></a><span>  </span><a name="local-6989586621681220333"><a href="#local-6989586621681220333"><span class="hs-identifier">vis_map2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#applyPackageFlag"><span class="hs-identifier hs-var">applyPackageFlag</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220314"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220319"><span class="hs-identifier hs-var">prelim_pkg_db</span></a><span> </span><a href="#local-6989586621681220316"><span class="hs-identifier hs-var">unusable</span></a><span>
</span><a name="line-1513"></a><span>                        </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_HideAllPackages"><span class="hs-identifier hs-var">Opt_HideAllPackages</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220318"><span class="hs-identifier hs-var">pkgs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1514"></a><span>                            </span><a href="#local-6989586621681220324"><span class="hs-identifier hs-var">vis_map1</span></a><span> </span><a href="#local-6989586621681220312"><span class="hs-identifier hs-var">other_flags</span></a><span>
</span><a name="line-1515"></a><span>
</span><a name="line-1516"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1517"></a><span>  </span><span class="hs-comment">-- Sort out which packages are wired in. This has to be done last, since</span><span>
</span><a name="line-1518"></a><span>  </span><span class="hs-comment">-- it modifies the unit ids of wired in packages, but when we process</span><span>
</span><a name="line-1519"></a><span>  </span><span class="hs-comment">-- package arguments we need to key against the old versions.</span><span>
</span><a name="line-1520"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1521"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621681220334"><a href="#local-6989586621681220334"><span class="hs-identifier">pkgs2</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220335"><a href="#local-6989586621681220335"><span class="hs-identifier">wired_map</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#findWiredInPackages"><span class="hs-identifier hs-var">findWiredInPackages</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220314"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220318"><span class="hs-identifier hs-var">pkgs1</span></a><span> </span><a href="#local-6989586621681220333"><span class="hs-identifier hs-var">vis_map2</span></a><span>
</span><a name="line-1522"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220336"><a href="#local-6989586621681220336"><span class="hs-identifier">pkg_db</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#extendPackageConfigMap"><span class="hs-identifier hs-var">extendPackageConfigMap</span></a><span> </span><a href="Packages.html#emptyPackageConfigMap"><span class="hs-identifier hs-var">emptyPackageConfigMap</span></a><span> </span><a href="#local-6989586621681220334"><span class="hs-identifier hs-var">pkgs2</span></a><span>
</span><a name="line-1523"></a><span>
</span><a name="line-1524"></a><span>  </span><span class="hs-comment">-- Update the visibility map, so we treat wired packages as visible.</span><span>
</span><a name="line-1525"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220337"><a href="#local-6989586621681220337"><span class="hs-identifier">vis_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#updateVisibilityMap"><span class="hs-identifier hs-var">updateVisibilityMap</span></a><span> </span><a href="#local-6989586621681220335"><span class="hs-identifier hs-var">wired_map</span></a><span> </span><a href="#local-6989586621681220333"><span class="hs-identifier hs-var">vis_map2</span></a><span>
</span><a name="line-1526"></a><span>
</span><a name="line-1527"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220338"><a href="#local-6989586621681220338"><span class="hs-identifier">hide_plugin_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_HideAllPluginPackages"><span class="hs-identifier hs-var">Opt_HideAllPluginPackages</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1528"></a><span>  </span><a name="local-6989586621681220341"><a href="#local-6989586621681220341"><span class="hs-identifier">plugin_vis_map</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-1529"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">pluginPackageFlags</span><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1530"></a><span>        </span><span class="hs-comment">-- common case; try to share the old vis_map</span><span>
</span><a name="line-1531"></a><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><a href="#local-6989586621681220338"><span class="hs-identifier hs-var">hide_plugin_pkgs</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681220337"><span class="hs-identifier hs-var">vis_map</span></a><span>
</span><a name="line-1532"></a><span>           </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-1533"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220339"><a href="#local-6989586621681220339"><span class="hs-identifier">plugin_vis_map1</span></a></a><span>
</span><a name="line-1534"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681220338"><span class="hs-identifier hs-var">hide_plugin_pkgs</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-1535"></a><span>                        </span><span class="hs-comment">-- Use the vis_map PRIOR to wired in,</span><span>
</span><a name="line-1536"></a><span>                        </span><span class="hs-comment">-- because otherwise applyPackageFlag</span><span>
</span><a name="line-1537"></a><span>                        </span><span class="hs-comment">-- won't work.</span><span>
</span><a name="line-1538"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220333"><span class="hs-identifier hs-var">vis_map2</span></a><span>
</span><a name="line-1539"></a><span>                </span><a name="local-6989586621681220340"><a href="#local-6989586621681220340"><span class="hs-identifier">plugin_vis_map2</span></a></a><span>
</span><a name="line-1540"></a><span>                    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#applyPackageFlag"><span class="hs-identifier hs-var">applyPackageFlag</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220314"><span class="hs-identifier hs-var">prec_map</span></a><span> </span><a href="#local-6989586621681220319"><span class="hs-identifier hs-var">prelim_pkg_db</span></a><span> </span><a href="#local-6989586621681220316"><span class="hs-identifier hs-var">unusable</span></a><span>
</span><a name="line-1541"></a><span>                                </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_HideAllPluginPackages"><span class="hs-identifier hs-var">Opt_HideAllPluginPackages</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220318"><span class="hs-identifier hs-var">pkgs1</span></a><span class="hs-special">)</span><span>
</span><a name="line-1542"></a><span>                             </span><a href="#local-6989586621681220339"><span class="hs-identifier hs-var">plugin_vis_map1</span></a><span>
</span><a name="line-1543"></a><span>                             </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pluginPackageFlags</span><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1544"></a><span>                </span><span class="hs-comment">-- Updating based on wired in packages is mostly</span><span>
</span><a name="line-1545"></a><span>                </span><span class="hs-comment">-- good hygiene, because it won't matter: no wired in</span><span>
</span><a name="line-1546"></a><span>                </span><span class="hs-comment">-- package has a compiler plugin.</span><span>
</span><a name="line-1547"></a><span>                </span><span class="hs-comment">-- TODO: If a wired in package had a compiler plugin,</span><span>
</span><a name="line-1548"></a><span>                </span><span class="hs-comment">-- and you tried to pick different wired in packages</span><span>
</span><a name="line-1549"></a><span>                </span><span class="hs-comment">-- with the plugin flags and the normal flags... what</span><span>
</span><a name="line-1550"></a><span>                </span><span class="hs-comment">-- would happen?  I don't know!  But this doesn't seem</span><span>
</span><a name="line-1551"></a><span>                </span><span class="hs-comment">-- likely to actually happen.</span><span>
</span><a name="line-1552"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="Packages.html#updateVisibilityMap"><span class="hs-identifier hs-var">updateVisibilityMap</span></a><span> </span><a href="#local-6989586621681220335"><span class="hs-identifier hs-var">wired_map</span></a><span> </span><a href="#local-6989586621681220340"><span class="hs-identifier hs-var">plugin_vis_map2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1553"></a><span>
</span><a name="line-1554"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1555"></a><span>  </span><span class="hs-comment">-- Here we build up a set of the packages mentioned in -package</span><span>
</span><a name="line-1556"></a><span>  </span><span class="hs-comment">-- flags on the command line; these are called the &quot;preload&quot;</span><span>
</span><a name="line-1557"></a><span>  </span><span class="hs-comment">-- packages.  we link these packages in eagerly.  The preload set</span><span>
</span><a name="line-1558"></a><span>  </span><span class="hs-comment">-- should contain at least rts &amp; base, which is why we pretend that</span><span>
</span><a name="line-1559"></a><span>  </span><span class="hs-comment">-- the command line contains -package rts &amp; -package base.</span><span>
</span><a name="line-1560"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1561"></a><span>  </span><span class="hs-comment">-- NB: preload IS important even for type-checking, because we</span><span>
</span><a name="line-1562"></a><span>  </span><span class="hs-comment">-- need the correct include path to be set.</span><span>
</span><a name="line-1563"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-1564"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220342"><a href="#local-6989586621681220342"><span class="hs-identifier">preload1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.filter</span><span> </span><span class="hs-identifier">uv_explicit</span><span> </span><a href="#local-6989586621681220337"><span class="hs-identifier hs-var">vis_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-1565"></a><span>
</span><a name="line-1566"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220343"><a href="#local-6989586621681220343"><span class="hs-identifier">pkgname_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621681220344"><span class="hs-identifier hs-var">add</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621681220334"><span class="hs-identifier hs-var">pkgs2</span></a><span>
</span><a name="line-1567"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220344"><a href="#local-6989586621681220344"><span class="hs-identifier">add</span></a></a><span> </span><a name="local-6989586621681220345"><a href="#local-6989586621681220345"><span class="hs-identifier">pn_map</span></a></a><span> </span><a name="local-6989586621681220346"><a href="#local-6989586621681220346"><span class="hs-identifier">p</span></a></a><span>
</span><a name="line-1568"></a><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.insert</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">packageName</span><span> </span><a href="#local-6989586621681220346"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">componentId</span><span> </span><a href="#local-6989586621681220346"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220345"><span class="hs-identifier hs-var">pn_map</span></a><span>
</span><a name="line-1569"></a><span>
</span><a name="line-1570"></a><span>  </span><span class="hs-comment">-- The explicitPackages accurately reflects the set of packages we have turned</span><span>
</span><a name="line-1571"></a><span>  </span><span class="hs-comment">-- on; as such, it also is the only way one can come up with requirements.</span><span>
</span><a name="line-1572"></a><span>  </span><span class="hs-comment">-- The requirement context is directly based off of this: we simply</span><span>
</span><a name="line-1573"></a><span>  </span><span class="hs-comment">-- look for nested unit IDs that are directly fed holes: the requirements</span><span>
</span><a name="line-1574"></a><span>  </span><span class="hs-comment">-- of those units are precisely the ones we need to track</span><span>
</span><a name="line-1575"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220347"><a href="#local-6989586621681220347"><span class="hs-identifier">explicit_pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.keys</span><span> </span><a href="#local-6989586621681220337"><span class="hs-identifier hs-var">vis_map</span></a><span>
</span><a name="line-1576"></a><span>      </span><a name="local-6989586621681220348"><a href="#local-6989586621681220348"><span class="hs-identifier">req_ctx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Set.toList</span><span class="hs-special">)</span><span>
</span><a name="line-1577"></a><span>              </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Map.unionsWith</span><span> </span><span class="hs-identifier hs-var">Set.union</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">uv_requirements</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220337"><span class="hs-identifier hs-var">vis_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1578"></a><span>
</span><a name="line-1579"></a><span>
</span><a name="line-1580"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220349"><a href="#local-6989586621681220349"><span class="hs-identifier">preload2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220342"><span class="hs-identifier hs-var">preload1</span></a><span>
</span><a name="line-1581"></a><span>
</span><a name="line-1582"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-1583"></a><span>      </span><span class="hs-comment">-- add base &amp; rts to the preload packages</span><span>
</span><a name="line-1584"></a><span>      </span><a name="local-6989586621681220350"><a href="#local-6989586621681220350"><span class="hs-identifier">basicLinkedPackages</span></a></a><span>
</span><a name="line-1585"></a><span>       </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_AutoLinkPackages"><span class="hs-identifier hs-var">Opt_AutoLinkPackages</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1586"></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">flip</span><span> </span><a href="UniqDFM.html#elemUDFM"><span class="hs-identifier hs-var">elemUDFM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unPackageConfigMap</span><span> </span><a href="#local-6989586621681220336"><span class="hs-identifier hs-var">pkg_db</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1587"></a><span>                </span><span class="hs-special">[</span><a href="Module.html#baseUnitId"><span class="hs-identifier hs-var">baseUnitId</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#rtsUnitId"><span class="hs-identifier hs-var">rtsUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-1588"></a><span>       </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1589"></a><span>      </span><span class="hs-comment">-- but in any case remove the current package from the set of</span><span>
</span><a name="line-1590"></a><span>      </span><span class="hs-comment">-- preloaded packages so that base/rts does not end up in the</span><span>
</span><a name="line-1591"></a><span>      </span><span class="hs-comment">-- set up preloaded package when we are just building it</span><span>
</span><a name="line-1592"></a><span>      </span><span class="hs-comment">-- (NB: since this is only relevant for base/rts it doesn't matter</span><span>
</span><a name="line-1593"></a><span>      </span><span class="hs-comment">-- that thisUnitIdInsts_ is not wired yet)</span><span>
</span><a name="line-1594"></a><span>      </span><span class="hs-comment">--</span><span>
</span><a name="line-1595"></a><span>      </span><a name="local-6989586621681220351"><a href="#local-6989586621681220351"><span class="hs-identifier">preload3</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="DynFlags.html#thisPackage"><span class="hs-identifier hs-var">thisPackage</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1596"></a><span>                     </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220350"><span class="hs-identifier hs-var">basicLinkedPackages</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220349"><span class="hs-identifier hs-var">preload2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1597"></a><span>
</span><a name="line-1598"></a><span>  </span><span class="hs-comment">-- Close the preload packages with their dependencies</span><span>
</span><a name="line-1599"></a><span>  </span><a name="local-6989586621681220352"><a href="#local-6989586621681220352"><span class="hs-identifier">dep_preload</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#closeDeps"><span class="hs-identifier hs-var">closeDeps</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220336"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">zip</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="Module.html#toInstalledUnitId"><span class="hs-identifier hs-var">toInstalledUnitId</span></a><span> </span><a href="#local-6989586621681220351"><span class="hs-identifier hs-var">preload3</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1600"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220353"><a href="#local-6989586621681220353"><span class="hs-identifier">new_dep_preload</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220311"><span class="hs-identifier hs-var">preload0</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220352"><span class="hs-identifier hs-var">dep_preload</span></a><span>
</span><a name="line-1601"></a><span>
</span><a name="line-1602"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220354"><a href="#local-6989586621681220354"><span class="hs-identifier">mod_map1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#mkModuleToPkgConfAll"><span class="hs-identifier hs-var">mkModuleToPkgConfAll</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220336"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><a href="#local-6989586621681220337"><span class="hs-identifier hs-var">vis_map</span></a><span>
</span><a name="line-1603"></a><span>      </span><a name="local-6989586621681220355"><a href="#local-6989586621681220355"><span class="hs-identifier">mod_map2</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#mkUnusableModuleToPkgConfAll"><span class="hs-identifier hs-var">mkUnusableModuleToPkgConfAll</span></a><span> </span><a href="#local-6989586621681220316"><span class="hs-identifier hs-var">unusable</span></a><span>
</span><a name="line-1604"></a><span>      </span><a name="local-6989586621681220356"><a href="#local-6989586621681220356"><span class="hs-identifier">mod_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><a href="#local-6989586621681220354"><span class="hs-identifier hs-var">mod_map1</span></a><span> </span><a href="#local-6989586621681220355"><span class="hs-identifier hs-var">mod_map2</span></a><span>
</span><a name="line-1605"></a><span>
</span><a name="line-1606"></a><span>  </span><a href="ErrUtils.html#dumpIfSet_dyn"><span class="hs-identifier hs-var">dumpIfSet_dyn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">pprCols</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">200</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><a href="DynFlags.html#Opt_D_dump_mod_map"><span class="hs-identifier hs-var">Opt_D_dump_mod_map</span></a><span> </span><span class="hs-string">&quot;Mod Map&quot;</span><span>
</span><a name="line-1607"></a><span>    </span><span class="hs-special">(</span><a href="Packages.html#pprModuleMap"><span class="hs-identifier hs-var">pprModuleMap</span></a><span> </span><a href="#local-6989586621681220356"><span class="hs-identifier hs-var">mod_map</span></a><span class="hs-special">)</span><span>
</span><a name="line-1608"></a><span>
</span><a name="line-1609"></a><span>  </span><span class="hs-comment">-- Force pstate to avoid leaking the dflags0 passed to mkPackageState</span><span>
</span><a name="line-1610"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><a name="local-6989586621681220357"><a href="#local-6989586621681220357"><span class="hs-identifier">pstate</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#PackageState"><span class="hs-identifier hs-var">PackageState</span></a><span class="hs-special">{</span><span>
</span><a name="line-1611"></a><span>    </span><span class="hs-identifier">preloadPackages</span><span>     </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220352"><span class="hs-identifier hs-var">dep_preload</span></a><span class="hs-special">,</span><span>
</span><a name="line-1612"></a><span>    </span><span class="hs-identifier">explicitPackages</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220347"><span class="hs-identifier hs-var">explicit_pkgs</span></a><span class="hs-special">,</span><span>
</span><a name="line-1613"></a><span>    </span><span class="hs-identifier">pkgIdMap</span><span>            </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220336"><span class="hs-identifier hs-var">pkg_db</span></a><span class="hs-special">,</span><span>
</span><a name="line-1614"></a><span>    </span><span class="hs-identifier">moduleToPkgConfAll</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220356"><span class="hs-identifier hs-var">mod_map</span></a><span class="hs-special">,</span><span>
</span><a name="line-1615"></a><span>    </span><span class="hs-identifier">pluginModuleToPkgConfAll</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#mkModuleToPkgConfAll"><span class="hs-identifier hs-var">mkModuleToPkgConfAll</span></a><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220336"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><a href="#local-6989586621681220341"><span class="hs-identifier hs-var">plugin_vis_map</span></a><span class="hs-special">,</span><span>
</span><a name="line-1616"></a><span>    </span><span class="hs-identifier">packageNameMap</span><span>          </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220343"><span class="hs-identifier hs-var">pkgname_map</span></a><span class="hs-special">,</span><span>
</span><a name="line-1617"></a><span>    </span><span class="hs-identifier">unwireMap</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220359"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><a href="#local-6989586621681220358"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220358"><a href="#local-6989586621681220358"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220359"><a href="#local-6989586621681220359"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220335"><span class="hs-identifier hs-var">wired_map</span></a><span> </span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><a name="line-1618"></a><span>    </span><span class="hs-identifier">requirementContext</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220348"><span class="hs-identifier hs-var">req_ctx</span></a><span>
</span><a name="line-1619"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-1620"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220360"><a href="#local-6989586621681220360"><span class="hs-identifier">new_insts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Packages.html#upd_wired_in_mod"><span class="hs-identifier hs-var">upd_wired_in_mod</span></a><span> </span><a href="#local-6989586621681220335"><span class="hs-identifier hs-var">wired_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">thisUnitIdInsts_</span><span> </span><a href="#local-6989586621681220309"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1621"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220357"><span class="hs-identifier hs-var">pstate</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220353"><span class="hs-identifier hs-var">new_dep_preload</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220360"><span class="hs-identifier hs-var">new_insts</span></a><span class="hs-special">)</span><span>
</span><a name="line-1622"></a><span>
</span><a name="line-1623"></a><span class="hs-comment">-- | Given a wired-in 'UnitId', &quot;unwire&quot; it into the 'UnitId'</span><span>
</span><a name="line-1624"></a><span class="hs-comment">-- that it was recorded as in the package database.</span><span>
</span><a name="line-1625"></a><span class="hs-identifier">unwireUnitId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span>
</span><a name="line-1626"></a><a name="unwireUnitId"><a href="Packages.html#unwireUnitId"><span class="hs-identifier">unwireUnitId</span></a></a><span> </span><a name="local-6989586621681220361"><a href="#local-6989586621681220361"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220362"><a href="#local-6989586621681220362"><span class="hs-identifier">uid</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><a name="local-6989586621681220363"><a href="#local-6989586621681220363"><span class="hs-identifier">def_uid</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1627"></a><span>    </span><span class="hs-identifier hs-var">maybe</span><span> </span><a href="#local-6989586621681220362"><span class="hs-identifier hs-var">uid</span></a><span> </span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220363"><span class="hs-identifier hs-var">def_uid</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unwireMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681220361"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1628"></a><span class="hs-identifier">unwireUnitId</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681220364"><a href="#local-6989586621681220364"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220364"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-1629"></a><span>
</span><a name="line-1630"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1631"></a><span class="hs-comment">-- | Makes the mapping from module to package info</span><span>
</span><a name="line-1632"></a><span>
</span><a name="line-1633"></a><span class="hs-comment">-- Slight irritation: we proceed by leafing through everything</span><span>
</span><a name="line-1634"></a><span class="hs-comment">-- in the installed package database, which makes handling indefinite</span><span>
</span><a name="line-1635"></a><span class="hs-comment">-- packages a bit bothersome.</span><span>
</span><a name="line-1636"></a><span>
</span><a name="line-1637"></a><span class="hs-identifier">mkModuleToPkgConfAll</span><span>
</span><a name="line-1638"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1639"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-1640"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#VisibilityMap"><span class="hs-identifier hs-type">VisibilityMap</span></a><span>
</span><a name="line-1641"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier hs-type">ModuleToPkgConfAll</span></a><span>
</span><a name="line-1642"></a><a name="mkModuleToPkgConfAll"><a href="Packages.html#mkModuleToPkgConfAll"><span class="hs-identifier">mkModuleToPkgConfAll</span></a></a><span> </span><a name="local-6989586621681220365"><a href="#local-6989586621681220365"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220366"><a href="#local-6989586621681220366"><span class="hs-identifier">pkg_db</span></a></a><span> </span><a name="local-6989586621681220367"><a href="#local-6989586621681220367"><span class="hs-identifier">vis_map</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1643"></a><span>    </span><span class="hs-comment">-- What should we fold on?  Both situations are awkward:</span><span>
</span><a name="line-1644"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1645"></a><span>    </span><span class="hs-comment">--    * Folding on the visibility map means that we won't create</span><span>
</span><a name="line-1646"></a><span>    </span><span class="hs-comment">--      entries for packages that aren't mentioned in vis_map</span><span>
</span><a name="line-1647"></a><span>    </span><span class="hs-comment">--      (e.g., hidden packages, causing #14717)</span><span>
</span><a name="line-1648"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1649"></a><span>    </span><span class="hs-comment">--    * Folding on pkg_db is awkward because if we have an</span><span>
</span><a name="line-1650"></a><span>    </span><span class="hs-comment">--      Backpack instantiation, we need to possibly add a</span><span>
</span><a name="line-1651"></a><span>    </span><span class="hs-comment">--      package from pkg_db multiple times to the actual</span><span>
</span><a name="line-1652"></a><span>    </span><span class="hs-comment">--      ModuleToPkgConfAll.  Also, we don't really want</span><span>
</span><a name="line-1653"></a><span>    </span><span class="hs-comment">--      definite package instantiations to show up in the</span><span>
</span><a name="line-1654"></a><span>    </span><span class="hs-comment">--      list of possibilities.</span><span>
</span><a name="line-1655"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-1656"></a><span>    </span><span class="hs-comment">-- So what will we do instead?  We'll extend vis_map with</span><span>
</span><a name="line-1657"></a><span>    </span><span class="hs-comment">-- entries for every definite (for non-Backpack) and</span><span>
</span><a name="line-1658"></a><span>    </span><span class="hs-comment">-- indefinite (for Backpack) package, so that we get the</span><span>
</span><a name="line-1659"></a><span>    </span><span class="hs-comment">-- hidden entries we need.</span><span>
</span><a name="line-1660"></a><span>    </span><span class="hs-identifier hs-var">Map.foldlWithKey</span><span> </span><a href="#local-6989586621681220372"><span class="hs-identifier hs-var">extend_modmap</span></a><span> </span><a href="#local-6989586621681220370"><span class="hs-identifier hs-var">emptyMap</span></a><span> </span><a href="#local-6989586621681220368"><span class="hs-identifier hs-var">vis_map_extended</span></a><span>
</span><a name="line-1661"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1662"></a><span>  </span><a name="local-6989586621681220368"><a href="#local-6989586621681220368"><span class="hs-identifier">vis_map_extended</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.union</span><span> </span><a href="#local-6989586621681220367"><span class="hs-identifier hs-var">vis_map</span></a><span> </span><span class="hs-comment">{- preferred -}</span><span> </span><a href="#local-6989586621681220369"><span class="hs-identifier hs-var">default_vis</span></a><span>
</span><a name="line-1663"></a><span>
</span><a name="line-1664"></a><span>  </span><a name="local-6989586621681220369"><a href="#local-6989586621681220369"><span class="hs-identifier">default_vis</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.fromList</span><span>
</span><a name="line-1665"></a><span>                  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220373"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">mempty</span><span class="hs-special">)</span><span>
</span><a name="line-1666"></a><span>                  </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220373"><a href="#local-6989586621681220373"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="UniqDFM.html#eltsUDFM"><span class="hs-identifier hs-var">eltsUDFM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">unPackageConfigMap</span><span> </span><a href="#local-6989586621681220366"><span class="hs-identifier hs-var">pkg_db</span></a><span class="hs-special">)</span><span>
</span><a name="line-1667"></a><span>                  </span><span class="hs-comment">-- Exclude specific instantiations of an indefinite</span><span>
</span><a name="line-1668"></a><span>                  </span><span class="hs-comment">-- package</span><span>
</span><a name="line-1669"></a><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">indefinite</span><span> </span><a href="#local-6989586621681220373"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">instantiatedWith</span><span> </span><a href="#local-6989586621681220373"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-1670"></a><span>                  </span><span class="hs-special">]</span><span>
</span><a name="line-1671"></a><span>
</span><a name="line-1672"></a><span>  </span><a name="local-6989586621681220370"><a href="#local-6989586621681220370"><span class="hs-identifier">emptyMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.empty</span><span>
</span><a name="line-1673"></a><span>  </span><a name="local-6989586621681220371"><a href="#local-6989586621681220371"><span class="hs-identifier">setOrigins</span></a></a><span> </span><a name="local-6989586621681220374"><a href="#local-6989586621681220374"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621681220375"><a href="#local-6989586621681220375"><span class="hs-identifier">os</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">const</span><span> </span><a href="#local-6989586621681220375"><span class="hs-identifier hs-var">os</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220374"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1674"></a><span>  </span><a name="local-6989586621681220372"><a href="#local-6989586621681220372"><span class="hs-identifier">extend_modmap</span></a></a><span> </span><a name="local-6989586621681220376"><a href="#local-6989586621681220376"><span class="hs-identifier">modmap</span></a></a><span> </span><a name="local-6989586621681220377"><a href="#local-6989586621681220377"><span class="hs-identifier">uid</span></a></a><span>
</span><a name="line-1675"></a><span>    </span><a href="Packages.html#UnitVisibility"><span class="hs-identifier hs-var">UnitVisibility</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">uv_expose_all</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681220378"><a href="#local-6989586621681220378"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">uv_renamings</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681220379"><a href="#local-6989586621681220379"><span class="hs-identifier">rns</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1676"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#addListTo"><span class="hs-identifier hs-var">addListTo</span></a><span> </span><a href="#local-6989586621681220376"><span class="hs-identifier hs-var">modmap</span></a><span> </span><a href="#local-6989586621681220381"><span class="hs-identifier hs-var">theBindings</span></a><span>
</span><a name="line-1677"></a><span>   </span><span class="hs-keyword">where</span><span>
</span><a name="line-1678"></a><span>    </span><a name="local-6989586621681220380"><a href="#local-6989586621681220380"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220388"><span class="hs-identifier hs-var">pkg_lookup</span></a><span> </span><a href="#local-6989586621681220377"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-1679"></a><span>
</span><a name="line-1680"></a><span>    </span><span class="hs-identifier">theBindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1681"></a><span>    </span><a name="local-6989586621681220381"><a href="#local-6989586621681220381"><span class="hs-identifier">theBindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220382"><span class="hs-identifier hs-var">newBindings</span></a><span> </span><a href="#local-6989586621681220378"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="#local-6989586621681220379"><span class="hs-identifier hs-var">rns</span></a><span>
</span><a name="line-1682"></a><span>
</span><a name="line-1683"></a><span>    </span><span class="hs-identifier">newBindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-1684"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1685"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1686"></a><span>    </span><a name="local-6989586621681220382"><a href="#local-6989586621681220382"><span class="hs-identifier">newBindings</span></a></a><span> </span><a name="local-6989586621681220391"><a href="#local-6989586621681220391"><span class="hs-identifier">e</span></a></a><span> </span><a name="local-6989586621681220392"><a href="#local-6989586621681220392"><span class="hs-identifier">rns</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220384"><span class="hs-identifier hs-var">es</span></a><span> </span><a href="#local-6989586621681220391"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220386"><span class="hs-identifier hs-var">hiddens</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220383"><span class="hs-identifier hs-var">rnBinding</span></a><span> </span><a href="#local-6989586621681220392"><span class="hs-identifier hs-var">rns</span></a><span>
</span><a name="line-1687"></a><span>
</span><a name="line-1688"></a><span>    </span><span class="hs-identifier">rnBinding</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">)</span><span>
</span><a name="line-1689"></a><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1690"></a><span>    </span><a name="local-6989586621681220383"><a href="#local-6989586621681220383"><span class="hs-identifier">rnBinding</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220393"><a href="#local-6989586621681220393"><span class="hs-identifier">orig</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220394"><a href="#local-6989586621681220394"><span class="hs-identifier">new</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220394"><span class="hs-identifier hs-var">new</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220371"><span class="hs-identifier hs-var">setOrigins</span></a><span> </span><a href="#local-6989586621681220395"><span class="hs-identifier hs-var">origEntry</span></a><span> </span><a href="Packages.html#fromFlag"><span class="hs-identifier hs-var">fromFlag</span></a><span class="hs-special">)</span><span>
</span><a name="line-1691"></a><span>     </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220395"><a href="#local-6989586621681220395"><span class="hs-identifier">origEntry</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="UniqFM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a><span> </span><a href="#local-6989586621681220385"><span class="hs-identifier hs-var">esmap</span></a><span> </span><a href="#local-6989586621681220393"><span class="hs-identifier hs-var">orig</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1692"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220396"><a href="#local-6989586621681220396"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220396"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-1693"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#throwGhcException"><span class="hs-identifier hs-var">throwGhcException</span></a><span> </span><span class="hs-special">(</span><a href="Panic.html#CmdLineError"><span class="hs-identifier hs-var">CmdLineError</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#showSDoc"><span class="hs-identifier hs-var">showSDoc</span></a><span> </span><a href="#local-6989586621681220365"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1694"></a><span>                        </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;package flag: could not find module name&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span>
</span><a name="line-1695"></a><span>                            </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220393"><span class="hs-identifier hs-var">orig</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;in package&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220387"><span class="hs-identifier hs-var">pk</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1696"></a><span>
</span><a name="line-1697"></a><span>    </span><span class="hs-identifier">es</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1698"></a><span>    </span><a name="local-6989586621681220384"><a href="#local-6989586621681220384"><span class="hs-identifier">es</span></a></a><span> </span><a name="local-6989586621681220397"><a href="#local-6989586621681220397"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1699"></a><span>     </span><span class="hs-special">(</span><a name="local-6989586621681220398"><a href="#local-6989586621681220398"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220399"><a href="#local-6989586621681220399"><span class="hs-identifier">exposedReexport</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220389"><span class="hs-identifier hs-var">exposed_mods</span></a><span>
</span><a name="line-1700"></a><span>     </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220400"><a href="#local-6989586621681220400"><span class="hs-identifier">pk'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220401"><a href="#local-6989586621681220401"><span class="hs-identifier">m'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220402"><a href="#local-6989586621681220402"><span class="hs-identifier">origin'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1701"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220399"><span class="hs-identifier hs-var">exposedReexport</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1702"></a><span>           </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220387"><span class="hs-identifier hs-var">pk</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220398"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#fromExposedModules"><span class="hs-identifier hs-var">fromExposedModules</span></a><span> </span><a href="#local-6989586621681220397"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-1703"></a><span>           </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-var">Module</span></a><span> </span><a name="local-6989586621681220403"><a href="#local-6989586621681220403"><span class="hs-identifier">pk'</span></a></a><span> </span><a name="local-6989586621681220404"><a href="#local-6989586621681220404"><span class="hs-identifier">m'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1704"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220405"><a href="#local-6989586621681220405"><span class="hs-identifier">pkg'</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220388"><span class="hs-identifier hs-var">pkg_lookup</span></a><span> </span><a href="#local-6989586621681220403"><span class="hs-identifier hs-var">pk'</span></a><span>
</span><a name="line-1705"></a><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220403"><span class="hs-identifier hs-var">pk'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220404"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#fromReexportedModules"><span class="hs-identifier hs-var">fromReexportedModules</span></a><span> </span><a href="#local-6989586621681220397"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="#local-6989586621681220405"><span class="hs-identifier hs-var">pkg'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1706"></a><span>     </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220398"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#mkModMap"><span class="hs-identifier hs-var">mkModMap</span></a><span> </span><a href="#local-6989586621681220400"><span class="hs-identifier hs-var">pk'</span></a><span> </span><a href="#local-6989586621681220401"><span class="hs-identifier hs-var">m'</span></a><span> </span><a href="#local-6989586621681220402"><span class="hs-identifier hs-var">origin'</span></a><span class="hs-special">)</span><span>
</span><a name="line-1707"></a><span>
</span><a name="line-1708"></a><span>    </span><span class="hs-identifier">esmap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UniqFM.html#UniqFM"><span class="hs-identifier hs-type">UniqFM</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1709"></a><span>    </span><a name="local-6989586621681220385"><a href="#local-6989586621681220385"><span class="hs-identifier">esmap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UniqFM.html#listToUFM"><span class="hs-identifier hs-var">listToUFM</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220384"><span class="hs-identifier hs-var">es</span></a><span> </span><span class="hs-identifier hs-var">False</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- parameter here doesn't matter, orig will</span><span>
</span><a name="line-1710"></a><span>                                 </span><span class="hs-comment">-- be overwritten</span><span>
</span><a name="line-1711"></a><span>
</span><a name="line-1712"></a><span>    </span><a name="local-6989586621681220386"><a href="#local-6989586621681220386"><span class="hs-identifier">hiddens</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681220406"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#mkModMap"><span class="hs-identifier hs-var">mkModMap</span></a><span> </span><a href="#local-6989586621681220387"><span class="hs-identifier hs-var">pk</span></a><span> </span><a href="#local-6989586621681220406"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="Packages.html#ModHidden"><span class="hs-identifier hs-var">ModHidden</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220406"><a href="#local-6989586621681220406"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220390"><span class="hs-identifier hs-var">hidden_mods</span></a><span class="hs-special">]</span><span>
</span><a name="line-1713"></a><span>
</span><a name="line-1714"></a><span>    </span><a name="local-6989586621681220387"><a href="#local-6989586621681220387"><span class="hs-identifier">pk</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220380"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1715"></a><span>    </span><a name="local-6989586621681220388"><a href="#local-6989586621681220388"><span class="hs-identifier">pkg_lookup</span></a></a><span> </span><a name="local-6989586621681220407"><a href="#local-6989586621681220407"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#lookupPackage%27"><span class="hs-identifier hs-var">lookupPackage'</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#isIndefinite"><span class="hs-identifier hs-var">isIndefinite</span></a><span> </span><a href="#local-6989586621681220365"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220366"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><a href="#local-6989586621681220407"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-1716"></a><span>                        </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;pkg_lookup&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220407"><span class="hs-identifier hs-var">uid</span></a><span class="hs-special">)</span><span>
</span><a name="line-1717"></a><span>
</span><a name="line-1718"></a><span>    </span><a name="local-6989586621681220389"><a href="#local-6989586621681220389"><span class="hs-identifier">exposed_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">exposedModules</span><span> </span><a href="#local-6989586621681220380"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1719"></a><span>    </span><a name="local-6989586621681220390"><a href="#local-6989586621681220390"><span class="hs-identifier">hidden_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hiddenModules</span><span> </span><a href="#local-6989586621681220380"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1720"></a><span>
</span><a name="line-1721"></a><span class="hs-comment">-- | Make a 'ModuleToPkgConfAll' covering a set of unusable packages.</span><span>
</span><a name="line-1722"></a><span class="hs-identifier">mkUnusableModuleToPkgConfAll</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#UnusablePackages"><span class="hs-identifier hs-type">UnusablePackages</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier hs-type">ModuleToPkgConfAll</span></a><span>
</span><a name="line-1723"></a><a name="mkUnusableModuleToPkgConfAll"><a href="Packages.html#mkUnusableModuleToPkgConfAll"><span class="hs-identifier">mkUnusableModuleToPkgConfAll</span></a></a><span> </span><a name="local-6989586621681220408"><a href="#local-6989586621681220408"><span class="hs-identifier">unusables</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1724"></a><span>    </span><span class="hs-identifier hs-var">Map.foldl'</span><span> </span><a href="#local-6989586621681220409"><span class="hs-identifier hs-var">extend_modmap</span></a><span> </span><span class="hs-identifier hs-var">Map.empty</span><span> </span><a href="#local-6989586621681220408"><span class="hs-identifier hs-var">unusables</span></a><span>
</span><a name="line-1725"></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-1726"></a><span>    </span><a name="local-6989586621681220409"><a href="#local-6989586621681220409"><span class="hs-identifier">extend_modmap</span></a></a><span> </span><a name="local-6989586621681220410"><a href="#local-6989586621681220410"><span class="hs-identifier">modmap</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220411"><a href="#local-6989586621681220411"><span class="hs-identifier">pkg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220412"><a href="#local-6989586621681220412"><span class="hs-identifier">reason</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#addListTo"><span class="hs-identifier hs-var">addListTo</span></a><span> </span><a href="#local-6989586621681220410"><span class="hs-identifier hs-var">modmap</span></a><span> </span><a href="#local-6989586621681220413"><span class="hs-identifier hs-var">bindings</span></a><span>
</span><a name="line-1727"></a><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">bindings</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1728"></a><span>            </span><a name="local-6989586621681220413"><a href="#local-6989586621681220413"><span class="hs-identifier">bindings</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220416"><span class="hs-identifier hs-var">exposed</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220417"><span class="hs-identifier hs-var">hidden</span></a><span>
</span><a name="line-1729"></a><span>
</span><a name="line-1730"></a><span>            </span><a name="local-6989586621681220414"><a href="#local-6989586621681220414"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#ModUnusable"><span class="hs-identifier hs-var">ModUnusable</span></a><span> </span><a href="#local-6989586621681220412"><span class="hs-identifier hs-var">reason</span></a><span>
</span><a name="line-1731"></a><span>            </span><a name="local-6989586621681220415"><a href="#local-6989586621681220415"><span class="hs-identifier">pkg_id</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220411"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1732"></a><span>
</span><a name="line-1733"></a><span>            </span><a name="local-6989586621681220416"><a href="#local-6989586621681220416"><span class="hs-identifier">exposed</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220418"><span class="hs-identifier hs-var">get_exposed</span></a><span> </span><a href="#local-6989586621681220419"><span class="hs-identifier hs-var">exposed_mods</span></a><span>
</span><a name="line-1734"></a><span>            </span><a name="local-6989586621681220417"><a href="#local-6989586621681220417"><span class="hs-identifier">hidden</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681220421"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#mkModMap"><span class="hs-identifier hs-var">mkModMap</span></a><span> </span><a href="#local-6989586621681220415"><span class="hs-identifier hs-var">pkg_id</span></a><span> </span><a href="#local-6989586621681220421"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621681220414"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220421"><a href="#local-6989586621681220421"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220420"><span class="hs-identifier hs-var">hidden_mods</span></a><span class="hs-special">]</span><span>
</span><a name="line-1735"></a><span>
</span><a name="line-1736"></a><span>            </span><a name="local-6989586621681220418"><a href="#local-6989586621681220418"><span class="hs-identifier">get_exposed</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220422"><a href="#local-6989586621681220422"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220423"><a href="#local-6989586621681220423"><span class="hs-identifier">mod'</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220422"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><a href="#local-6989586621681220423"><span class="hs-identifier hs-var">mod'</span></a><span> </span><a href="#local-6989586621681220414"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1737"></a><span>            </span><span class="hs-identifier">get_exposed</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220424"><a href="#local-6989586621681220424"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220424"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#mkModMap"><span class="hs-identifier hs-var">mkModMap</span></a><span> </span><a href="#local-6989586621681220415"><span class="hs-identifier hs-var">pkg_id</span></a><span> </span><a href="#local-6989586621681220424"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681220414"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1738"></a><span>
</span><a name="line-1739"></a><span>            </span><a name="local-6989586621681220419"><a href="#local-6989586621681220419"><span class="hs-identifier">exposed_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">exposedModules</span><span> </span><a href="#local-6989586621681220411"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1740"></a><span>            </span><a name="local-6989586621681220420"><a href="#local-6989586621681220420"><span class="hs-identifier">hidden_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hiddenModules</span><span> </span><a href="#local-6989586621681220411"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1741"></a><span>
</span><a name="line-1742"></a><span class="hs-comment">-- | Add a list of key/value pairs to a nested map.</span><span>
</span><a name="line-1743"></a><span class="hs-comment">--</span><span>
</span><a name="line-1744"></a><span class="hs-comment">-- The outer map is processed with 'Data.Map.Strict' to prevent memory leaks</span><span>
</span><a name="line-1745"></a><span class="hs-comment">-- when reloading modules in GHCi (see Trac #4029). This ensures that each</span><span>
</span><a name="line-1746"></a><span class="hs-comment">-- value is forced before installing into the map.</span><span>
</span><a name="line-1747"></a><span class="hs-identifier">addListTo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621681219907"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621681219908"><span class="hs-identifier hs-type">k1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="#local-6989586621681219909"><span class="hs-identifier hs-type">k2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1748"></a><span>          </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621681219908"><span class="hs-identifier hs-type">k1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621681219909"><span class="hs-identifier hs-type">k2</span></a><span> </span><a href="#local-6989586621681219907"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1749"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681219908"><span class="hs-identifier hs-type">k1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621681219909"><span class="hs-identifier hs-type">k2</span></a><span> </span><a href="#local-6989586621681219907"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1750"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621681219908"><span class="hs-identifier hs-type">k1</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Map</span><span> </span><a href="#local-6989586621681219909"><span class="hs-identifier hs-type">k2</span></a><span> </span><a href="#local-6989586621681219907"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-1751"></a><a name="addListTo"><a href="Packages.html#addListTo"><span class="hs-identifier">addListTo</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621681220425"><span class="hs-identifier hs-var">merge</span></a><span>
</span><a name="line-1752"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220425"><a href="#local-6989586621681220425"><span class="hs-identifier">merge</span></a></a><span> </span><a name="local-6989586621681220426"><a href="#local-6989586621681220426"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220427"><a href="#local-6989586621681220427"><span class="hs-identifier">k</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220428"><a href="#local-6989586621681220428"><span class="hs-identifier">v</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">MapStrict.insertWith</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.unionWith</span><span> </span><span class="hs-identifier hs-var">mappend</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220427"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621681220428"><span class="hs-identifier hs-var">v</span></a><span> </span><a href="#local-6989586621681220426"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-1753"></a><span>
</span><a name="line-1754"></a><span class="hs-comment">-- | Create a singleton module mapping</span><span>
</span><a name="line-1755"></a><span class="hs-identifier">mkModMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-1756"></a><a name="mkModMap"><a href="Packages.html#mkModMap"><span class="hs-identifier">mkModMap</span></a></a><span> </span><a name="local-6989586621681220536"><a href="#local-6989586621681220536"><span class="hs-identifier">pkg</span></a></a><span> </span><a name="local-6989586621681220537"><a href="#local-6989586621681220537"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Map.singleton</span><span> </span><span class="hs-special">(</span><a href="Module.html#mkModule"><span class="hs-identifier hs-var">mkModule</span></a><span> </span><a href="#local-6989586621681220536"><span class="hs-identifier hs-var">pkg</span></a><span> </span><a href="#local-6989586621681220537"><span class="hs-identifier hs-var">mod</span></a><span class="hs-special">)</span><span>
</span><a name="line-1757"></a><span>
</span><a name="line-1758"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1759"></a><span class="hs-comment">-- Extracting information from the packages in scope</span><span>
</span><a name="line-1760"></a><span>
</span><a name="line-1761"></a><span class="hs-comment">-- Many of these functions take a list of packages: in those cases,</span><span>
</span><a name="line-1762"></a><span class="hs-comment">-- the list is expected to contain the &quot;dependent packages&quot;,</span><span>
</span><a name="line-1763"></a><span class="hs-comment">-- i.e. those packages that were found to be depended on by the</span><span>
</span><a name="line-1764"></a><span class="hs-comment">-- current module/program.  These can be auto or non-auto packages, it</span><span>
</span><a name="line-1765"></a><span class="hs-comment">-- doesn't really matter.  The list is always combined with the list</span><span>
</span><a name="line-1766"></a><span class="hs-comment">-- of preload (command-line) packages to determine which packages to</span><span>
</span><a name="line-1767"></a><span class="hs-comment">-- use.</span><span>
</span><a name="line-1768"></a><span>
</span><a name="line-1769"></a><span class="hs-comment">-- | Find all the include directories in these and the preload packages</span><span>
</span><a name="line-1770"></a><span class="hs-identifier">getPackageIncludePath</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1771"></a><a name="getPackageIncludePath"><a href="Packages.html#getPackageIncludePath"><span class="hs-identifier">getPackageIncludePath</span></a></a><span> </span><a name="local-6989586621681220538"><a href="#local-6989586621681220538"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220539"><a href="#local-6989586621681220539"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1772"></a><span>  </span><a href="Packages.html#collectIncludeDirs"><span class="hs-identifier hs-var">collectIncludeDirs</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220538"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220539"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1773"></a><span>
</span><a name="line-1774"></a><span class="hs-identifier">collectIncludeDirs</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1775"></a><a name="collectIncludeDirs"><a href="Packages.html#collectIncludeDirs"><span class="hs-identifier">collectIncludeDirs</span></a></a><span> </span><a name="local-6989586621681220540"><a href="#local-6989586621681220540"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">includeDirs</span><span> </span><a href="#local-6989586621681220540"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1776"></a><span>
</span><a name="line-1777"></a><span class="hs-comment">-- | Find all the library paths in these and the preload packages</span><span>
</span><a name="line-1778"></a><span class="hs-identifier">getPackageLibraryPath</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1779"></a><a name="getPackageLibraryPath"><a href="Packages.html#getPackageLibraryPath"><span class="hs-identifier">getPackageLibraryPath</span></a></a><span> </span><a name="local-6989586621681220541"><a href="#local-6989586621681220541"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220542"><a href="#local-6989586621681220542"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1780"></a><span>  </span><a href="Packages.html#collectLibraryPaths"><span class="hs-identifier hs-var">collectLibraryPaths</span></a><span> </span><a href="#local-6989586621681220541"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220541"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220542"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1781"></a><span>
</span><a name="line-1782"></a><span class="hs-identifier">collectLibraryPaths</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1783"></a><a name="collectLibraryPaths"><a href="Packages.html#collectLibraryPaths"><span class="hs-identifier">collectLibraryPaths</span></a></a><span> </span><a name="local-6989586621681220543"><a href="#local-6989586621681220543"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span>
</span><a name="line-1784"></a><span>                           </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><a href="Packages.html#libraryDirsForWay"><span class="hs-identifier hs-var">libraryDirsForWay</span></a><span> </span><a href="#local-6989586621681220543"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-1785"></a><span>
</span><a name="line-1786"></a><span class="hs-comment">-- | Find all the link options in these and the preload packages,</span><span>
</span><a name="line-1787"></a><span class="hs-comment">-- returning (package hs lib options, extra library options, other flags)</span><span>
</span><a name="line-1788"></a><span class="hs-identifier">getPackageLinkOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1789"></a><a name="getPackageLinkOpts"><a href="Packages.html#getPackageLinkOpts"><span class="hs-identifier">getPackageLinkOpts</span></a></a><span> </span><a name="local-6989586621681220544"><a href="#local-6989586621681220544"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220545"><a href="#local-6989586621681220545"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1790"></a><span>  </span><a href="Packages.html#collectLinkOpts"><span class="hs-identifier hs-var">collectLinkOpts</span></a><span> </span><a href="#local-6989586621681220544"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">fmap</span><span class="hs-special">`</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220544"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220545"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1791"></a><span>
</span><a name="line-1792"></a><span class="hs-identifier">collectLinkOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-1793"></a><a name="collectLinkOpts"><a href="Packages.html#collectLinkOpts"><span class="hs-identifier">collectLinkOpts</span></a></a><span> </span><a name="local-6989586621681220546"><a href="#local-6989586621681220546"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220547"><a href="#local-6989586621681220547"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1794"></a><span>    </span><span class="hs-special">(</span><span>
</span><a name="line-1795"></a><span>        </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-l&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Packages.html#packageHsLibs"><span class="hs-identifier hs-var">packageHsLibs</span></a><span> </span><a href="#local-6989586621681220546"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220547"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">,</span><span>
</span><a name="line-1796"></a><span>        </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;-l&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">extraLibraries</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220547"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">,</span><span>
</span><a name="line-1797"></a><span>        </span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">ldOptions</span><span> </span><a href="#local-6989586621681220547"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-1798"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-1799"></a><span class="hs-identifier">collectArchives</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">FilePath</span><span class="hs-special">]</span><span>
</span><a name="line-1800"></a><a name="collectArchives"><a href="Packages.html#collectArchives"><span class="hs-identifier">collectArchives</span></a></a><span> </span><a name="local-6989586621681220548"><a href="#local-6989586621681220548"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220549"><a href="#local-6989586621681220549"><span class="hs-identifier">pc</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1801"></a><span>  </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><span class="hs-special">[</span><span> </span><a href="#local-6989586621681220552"><span class="hs-identifier hs-var">searchPath</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220553"><span class="hs-identifier hs-var">lib</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.a&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-1802"></a><span>                        </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220552"><a href="#local-6989586621681220552"><span class="hs-identifier">searchPath</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220550"><span class="hs-identifier hs-var">searchPaths</span></a><span>
</span><a name="line-1803"></a><span>                        </span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220553"><a href="#local-6989586621681220553"><span class="hs-identifier">lib</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621681220551"><span class="hs-identifier hs-var">libs</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1804"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220550"><a href="#local-6989586621681220550"><span class="hs-identifier">searchPaths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Packages.html#libraryDirsForWay"><span class="hs-identifier hs-var">libraryDirsForWay</span></a><span> </span><a href="#local-6989586621681220548"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621681220549"><span class="hs-identifier hs-var">pc</span></a><span>
</span><a name="line-1805"></a><span>        </span><a name="local-6989586621681220551"><a href="#local-6989586621681220551"><span class="hs-identifier">libs</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#packageHsLibs"><span class="hs-identifier hs-var">packageHsLibs</span></a><span> </span><a href="#local-6989586621681220548"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220549"><span class="hs-identifier hs-var">pc</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier">extraLibraries</span><span> </span><a href="#local-6989586621681220549"><span class="hs-identifier hs-var">pc</span></a><span>
</span><a name="line-1806"></a><span>
</span><a name="line-1807"></a><span class="hs-identifier">getLibs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span class="hs-identifier hs-type">String</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1808"></a><a name="getLibs"><a href="Packages.html#getLibs"><span class="hs-identifier">getLibs</span></a></a><span> </span><a name="local-6989586621681220554"><a href="#local-6989586621681220554"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220555"><a href="#local-6989586621681220555"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1809"></a><span>  </span><a name="local-6989586621681220556"><a href="#local-6989586621681220556"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220554"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220555"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1810"></a><span>  </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">forM</span><span> </span><a href="#local-6989586621681220556"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621681220557"><a href="#local-6989586621681220557"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1811"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220558"><a href="#local-6989586621681220558"><span class="hs-identifier">candidates</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220559"><span class="hs-identifier hs-var">l</span></a><span> </span><span class="hs-operator hs-var">&lt;/&gt;</span><span> </span><a href="#local-6989586621681220561"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220561"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><a name="local-6989586621681220559"><a href="#local-6989586621681220559"><span class="hs-identifier">l</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#collectLibraryPaths"><span class="hs-identifier hs-var">collectLibraryPaths</span></a><span> </span><a href="#local-6989586621681220554"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621681220557"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">]</span><span>
</span><a name="line-1812"></a><span>                                    </span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220561"><a href="#local-6989586621681220561"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621681220560"><a href="#local-6989586621681220560"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;lib&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220560"><span class="hs-identifier hs-var">n</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;.a&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Packages.html#packageHsLibs"><span class="hs-identifier hs-var">packageHsLibs</span></a><span> </span><a href="#local-6989586621681220554"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220557"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-1813"></a><span>    </span><span class="hs-identifier hs-var">filterM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">doesFileExist</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220558"><span class="hs-identifier hs-var">candidates</span></a><span>
</span><a name="line-1814"></a><span>
</span><a name="line-1815"></a><span class="hs-identifier">packageHsLibs</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1816"></a><a name="packageHsLibs"><a href="Packages.html#packageHsLibs"><span class="hs-identifier">packageHsLibs</span></a></a><span> </span><a name="local-6989586621681220562"><a href="#local-6989586621681220562"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220563"><a href="#local-6989586621681220563"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220569"><span class="hs-identifier hs-var">mkDynName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621681220570"><span class="hs-identifier hs-var">addSuffix</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hsLibraries</span><span> </span><a href="#local-6989586621681220563"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-1817"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1818"></a><span>        </span><a name="local-6989586621681220564"><a href="#local-6989586621681220564"><span class="hs-identifier">ways0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621681220562"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1819"></a><span>
</span><a name="line-1820"></a><span>        </span><a name="local-6989586621681220565"><a href="#local-6989586621681220565"><span class="hs-identifier">ways1</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="DynFlags.html#WayDyn"><span class="hs-identifier hs-var">WayDyn</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220564"><span class="hs-identifier hs-var">ways0</span></a><span>
</span><a name="line-1821"></a><span>        </span><span class="hs-comment">-- the name of a shared library is libHSfoo-ghc&lt;version&gt;.so</span><span>
</span><a name="line-1822"></a><span>        </span><span class="hs-comment">-- we leave out the _dyn, because it is superfluous</span><span>
</span><a name="line-1823"></a><span>
</span><a name="line-1824"></a><span>        </span><span class="hs-comment">-- debug and profiled RTSs include support for -eventlog</span><span>
</span><a name="line-1825"></a><span>        </span><a name="local-6989586621681220566"><a href="#local-6989586621681220566"><span class="hs-identifier">ways2</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#WayDebug"><span class="hs-identifier hs-var">WayDebug</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220565"><span class="hs-identifier hs-var">ways1</span></a><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="DynFlags.html#WayProf"><span class="hs-identifier hs-var">WayProf</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220565"><span class="hs-identifier hs-var">ways1</span></a><span>
</span><a name="line-1826"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><a href="DynFlags.html#WayEventLog"><span class="hs-identifier hs-var">WayEventLog</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220565"><span class="hs-identifier hs-var">ways1</span></a><span>
</span><a name="line-1827"></a><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1828"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220565"><span class="hs-identifier hs-var">ways1</span></a><span>
</span><a name="line-1829"></a><span>
</span><a name="line-1830"></a><span>        </span><a name="local-6989586621681220567"><a href="#local-6989586621681220567"><span class="hs-identifier">tag</span></a></a><span>     </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#mkBuildTag"><span class="hs-identifier hs-var">mkBuildTag</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="DynFlags.html#wayRTSOnly"><span class="hs-identifier hs-var">wayRTSOnly</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220566"><span class="hs-identifier hs-var">ways2</span></a><span class="hs-special">)</span><span>
</span><a name="line-1831"></a><span>        </span><a name="local-6989586621681220568"><a href="#local-6989586621681220568"><span class="hs-identifier">rts_tag</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="DynFlags.html#mkBuildTag"><span class="hs-identifier hs-var">mkBuildTag</span></a><span> </span><a href="#local-6989586621681220566"><span class="hs-identifier hs-var">ways2</span></a><span>
</span><a name="line-1832"></a><span>
</span><a name="line-1833"></a><span>        </span><a name="local-6989586621681220569"><a href="#local-6989586621681220569"><span class="hs-identifier">mkDynName</span></a></a><span> </span><a name="local-6989586621681220572"><a href="#local-6989586621681220572"><span class="hs-identifier">x</span></a></a><span>
</span><a name="line-1834"></a><span>         </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#WayDyn"><span class="hs-identifier hs-var">WayDyn</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">notElem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621681220562"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220572"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-1835"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-string">&quot;HS&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">isPrefixOf</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220572"><span class="hs-identifier hs-var">x</span></a><span>          </span><span class="hs-glyph">=</span><span>
</span><a name="line-1836"></a><span>              </span><a href="#local-6989586621681220572"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-char">'-'</span><span class="hs-glyph">:</span><a href="DynFlags.html#programName"><span class="hs-identifier hs-var">programName</span></a><span> </span><a href="#local-6989586621681220562"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="DynFlags.html#projectVersion"><span class="hs-identifier hs-var">projectVersion</span></a><span> </span><a href="#local-6989586621681220562"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1837"></a><span>           </span><span class="hs-comment">-- For non-Haskell libraries, we use the name &quot;Cfoo&quot;. The .a</span><span>
</span><a name="line-1838"></a><span>           </span><span class="hs-comment">-- file is libCfoo.a, and the .so is libfoo.so. That way the</span><span>
</span><a name="line-1839"></a><span>           </span><span class="hs-comment">-- linker knows what we mean for the vanilla (-lCfoo) and dyn</span><span>
</span><a name="line-1840"></a><span>           </span><span class="hs-comment">-- (-lfoo) ways. We therefore need to strip the 'C' off here.</span><span>
</span><a name="line-1841"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220573"><a href="#local-6989586621681220573"><span class="hs-identifier">x'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">stripPrefix</span><span> </span><span class="hs-string">&quot;C&quot;</span><span> </span><a href="#local-6989586621681220572"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220573"><span class="hs-identifier hs-var">x'</span></a><span>
</span><a name="line-1842"></a><span>         </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1843"></a><span>            </span><span class="hs-glyph">=</span><span> </span><a href="PlainPanic.html#panic"><span class="hs-identifier hs-var">panic</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Don't understand library name &quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621681220572"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-1844"></a><span>
</span><a name="line-1845"></a><span>        </span><span class="hs-comment">-- Add _thr and other rts suffixes to packages named</span><span>
</span><a name="line-1846"></a><span>        </span><span class="hs-comment">-- `rts` or `rts-1.0`. Why both?  Traditionally the rts</span><span>
</span><a name="line-1847"></a><span>        </span><span class="hs-comment">-- package is called `rts` only.  However the tooling</span><span>
</span><a name="line-1848"></a><span>        </span><span class="hs-comment">-- usually expects a package name to have a version.</span><span>
</span><a name="line-1849"></a><span>        </span><span class="hs-comment">-- As such we will gradually move towards the `rts-1.0`</span><span>
</span><a name="line-1850"></a><span>        </span><span class="hs-comment">-- package name, at which point the `rts` package name</span><span>
</span><a name="line-1851"></a><span>        </span><span class="hs-comment">-- will eventually be unused.</span><span>
</span><a name="line-1852"></a><span>        </span><span class="hs-comment">--</span><span>
</span><a name="line-1853"></a><span>        </span><span class="hs-comment">-- This change elevates the need to add custom hooks</span><span>
</span><a name="line-1854"></a><span>        </span><span class="hs-comment">-- and handling specifically for the `rts` package for</span><span>
</span><a name="line-1855"></a><span>        </span><span class="hs-comment">-- example in ghc-cabal.</span><span>
</span><a name="line-1856"></a><span>        </span><a name="local-6989586621681220570"><a href="#local-6989586621681220570"><span class="hs-identifier">addSuffix</span></a></a><span> </span><a name="local-6989586621681220574"><a href="#local-6989586621681220574"><span class="hs-identifier">rts</span></a></a><span class="hs-glyph">@</span><span class="hs-string">&quot;HSrts&quot;</span><span>    </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220574"><span class="hs-identifier hs-var">rts</span></a><span>       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220571"><span class="hs-identifier hs-var">expandTag</span></a><span> </span><a href="#local-6989586621681220568"><span class="hs-identifier hs-var">rts_tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-1857"></a><span>        </span><span class="hs-identifier">addSuffix</span><span> </span><a name="local-6989586621681220575"><a href="#local-6989586621681220575"><span class="hs-identifier">rts</span></a></a><span class="hs-glyph">@</span><span class="hs-string">&quot;HSrts-1.0&quot;</span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220575"><span class="hs-identifier hs-var">rts</span></a><span>       </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220571"><span class="hs-identifier hs-var">expandTag</span></a><span> </span><a href="#local-6989586621681220568"><span class="hs-identifier hs-var">rts_tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-1858"></a><span>        </span><span class="hs-identifier">addSuffix</span><span> </span><a name="local-6989586621681220576"><a href="#local-6989586621681220576"><span class="hs-identifier">other_lib</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220576"><span class="hs-identifier hs-var">other_lib</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220571"><span class="hs-identifier hs-var">expandTag</span></a><span> </span><a href="#local-6989586621681220567"><span class="hs-identifier hs-var">tag</span></a><span class="hs-special">)</span><span>
</span><a name="line-1859"></a><span>
</span><a name="line-1860"></a><span>        </span><a name="local-6989586621681220571"><a href="#local-6989586621681220571"><span class="hs-identifier">expandTag</span></a></a><span> </span><a name="local-6989586621681220577"><a href="#local-6989586621681220577"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><a href="#local-6989586621681220577"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-1861"></a><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-char">'_'</span><span class="hs-glyph">:</span><a href="#local-6989586621681220577"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1862"></a><span>
</span><a name="line-1863"></a><span class="hs-comment">-- | Either the 'libraryDirs' or 'libraryDynDirs' as appropriate for the way.</span><span>
</span><a name="line-1864"></a><span class="hs-identifier">libraryDirsForWay</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1865"></a><a name="libraryDirsForWay"><a href="Packages.html#libraryDirsForWay"><span class="hs-identifier">libraryDirsForWay</span></a></a><span> </span><a name="local-6989586621681220578"><a href="#local-6989586621681220578"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1866"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#WayDyn"><span class="hs-identifier hs-var">WayDyn</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">ways</span><span> </span><a href="#local-6989586621681220578"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">libraryDynDirs</span><span>
</span><a name="line-1867"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">libraryDirs</span><span>
</span><a name="line-1868"></a><span>
</span><a name="line-1869"></a><span class="hs-comment">-- | Find all the C-compiler options in these and the preload packages</span><span>
</span><a name="line-1870"></a><span class="hs-identifier">getPackageExtraCcOpts</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1871"></a><a name="getPackageExtraCcOpts"><a href="Packages.html#getPackageExtraCcOpts"><span class="hs-identifier">getPackageExtraCcOpts</span></a></a><span> </span><a name="local-6989586621681220579"><a href="#local-6989586621681220579"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220580"><a href="#local-6989586621681220580"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1872"></a><span>  </span><a name="local-6989586621681220581"><a href="#local-6989586621681220581"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220579"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220580"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1873"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">ccOptions</span><span> </span><a href="#local-6989586621681220581"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1874"></a><span>
</span><a name="line-1875"></a><span class="hs-comment">-- | Find all the package framework paths in these and the preload packages</span><span>
</span><a name="line-1876"></a><span class="hs-identifier">getPackageFrameworkPath</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1877"></a><a name="getPackageFrameworkPath"><a href="Packages.html#getPackageFrameworkPath"><span class="hs-identifier">getPackageFrameworkPath</span></a></a><span> </span><a name="local-6989586621681220582"><a href="#local-6989586621681220582"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220583"><a href="#local-6989586621681220583"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1878"></a><span>  </span><a name="local-6989586621681220584"><a href="#local-6989586621681220584"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220582"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220583"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1879"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">nub</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Util.html#notNull"><span class="hs-identifier hs-var">notNull</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">frameworkDirs</span><span> </span><a href="#local-6989586621681220584"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1880"></a><span>
</span><a name="line-1881"></a><span class="hs-comment">-- | Find all the package frameworks in these and the preload packages</span><span>
</span><a name="line-1882"></a><span class="hs-identifier">getPackageFrameworks</span><span>  </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">String</span><span class="hs-special">]</span><span>
</span><a name="line-1883"></a><a name="getPackageFrameworks"><a href="Packages.html#getPackageFrameworks"><span class="hs-identifier">getPackageFrameworks</span></a></a><span> </span><a name="local-6989586621681220585"><a href="#local-6989586621681220585"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220586"><a href="#local-6989586621681220586"><span class="hs-identifier">pkgs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1884"></a><span>  </span><a name="local-6989586621681220587"><a href="#local-6989586621681220587"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier hs-var">getPreloadPackagesAnd</span></a><span> </span><a href="#local-6989586621681220585"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220586"><span class="hs-identifier hs-var">pkgs</span></a><span>
</span><a name="line-1885"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concatMap</span><span> </span><span class="hs-identifier">frameworks</span><span> </span><a href="#local-6989586621681220587"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-1886"></a><span>
</span><a name="line-1887"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-1888"></a><span class="hs-comment">-- Package Utils</span><span>
</span><a name="line-1889"></a><span>
</span><a name="line-1890"></a><span class="hs-comment">-- | Takes a 'ModuleName', and if the module is in any package returns</span><span>
</span><a name="line-1891"></a><span class="hs-comment">-- list of modules which take that name.</span><span>
</span><a name="line-1892"></a><span class="hs-identifier">lookupModuleInAllPackages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1893"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span>
</span><a name="line-1894"></a><span>                          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1895"></a><a name="lookupModuleInAllPackages"><a href="Packages.html#lookupModuleInAllPackages"><span class="hs-identifier">lookupModuleInAllPackages</span></a></a><span> </span><a name="local-6989586621681220588"><a href="#local-6989586621681220588"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220589"><a href="#local-6989586621681220589"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-1896"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#lookupModuleWithSuggestions"><span class="hs-identifier hs-var">lookupModuleWithSuggestions</span></a><span> </span><a href="#local-6989586621681220588"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220589"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1897"></a><span>      </span><a href="Packages.html#LookupFound"><span class="hs-identifier hs-var">LookupFound</span></a><span> </span><a name="local-6989586621681220590"><a href="#local-6989586621681220590"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621681220591"><a href="#local-6989586621681220591"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621681220590"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><a href="#local-6989586621681220591"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1898"></a><span>      </span><a href="Packages.html#LookupMultiple"><span class="hs-identifier hs-var">LookupMultiple</span></a><span> </span><a name="local-6989586621681220592"><a href="#local-6989586621681220592"><span class="hs-identifier">rs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220593"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621681220592"><span class="hs-identifier hs-var">rs</span></a><span>
</span><a name="line-1899"></a><span>        </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220593"><a href="#local-6989586621681220593"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220594"><a href="#local-6989586621681220594"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220594"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="Maybes.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a><span> </span><span class="hs-string">&quot;lookupModule&quot;</span><span> </span><span class="hs-special">(</span><a href="Packages.html#lookupPackage"><span class="hs-identifier hs-var">lookupPackage</span></a><span> </span><a href="#local-6989586621681220588"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1900"></a><span>                                                         </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681220594"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1901"></a><span>      </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1902"></a><span>
</span><a name="line-1903"></a><span class="hs-comment">-- | The result of performing a lookup</span><span>
</span><a name="line-1904"></a><span class="hs-keyword">data</span><span> </span><a name="LookupResult"><a href="Packages.html#LookupResult"><span class="hs-identifier">LookupResult</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1905"></a><span>    </span><span class="hs-comment">-- | Found the module uniquely, nothing else to do</span><span>
</span><a name="line-1906"></a><span>    </span><a name="LookupFound"><a href="Packages.html#LookupFound"><span class="hs-identifier">LookupFound</span></a></a><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-1907"></a><span>    </span><span class="hs-comment">-- | Multiple modules with the same name in scope</span><span>
</span><a name="line-1908"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LookupMultiple"><a href="Packages.html#LookupMultiple"><span class="hs-identifier">LookupMultiple</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1909"></a><span>    </span><span class="hs-comment">-- | No modules found, but there were some hidden ones with</span><span>
</span><a name="line-1910"></a><span>    </span><span class="hs-comment">-- an exact name match.  First is due to package hidden, second</span><span>
</span><a name="line-1911"></a><span>    </span><span class="hs-comment">-- is due to module being hidden</span><span>
</span><a name="line-1912"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LookupHidden"><a href="Packages.html#LookupHidden"><span class="hs-identifier">LookupHidden</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1913"></a><span>    </span><span class="hs-comment">-- | No modules found, but there were some unusable ones with</span><span>
</span><a name="line-1914"></a><span>    </span><span class="hs-comment">-- an exact name match</span><span>
</span><a name="line-1915"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LookupUnusable"><a href="Packages.html#LookupUnusable"><span class="hs-identifier">LookupUnusable</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-1916"></a><span>    </span><span class="hs-comment">-- | Nothing found, here are some suggested different names</span><span>
</span><a name="line-1917"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="LookupNotFound"><a href="Packages.html#LookupNotFound"><span class="hs-identifier">LookupNotFound</span></a></a><span> </span><span class="hs-special">[</span><a href="Packages.html#ModuleSuggestion"><span class="hs-identifier hs-type">ModuleSuggestion</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- suggestions</span><span>
</span><a name="line-1918"></a><span>
</span><a name="line-1919"></a><span class="hs-keyword">data</span><span> </span><a name="ModuleSuggestion"><a href="Packages.html#ModuleSuggestion"><span class="hs-identifier">ModuleSuggestion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SuggestVisible"><a href="Packages.html#SuggestVisible"><span class="hs-identifier">SuggestVisible</span></a></a><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-1920"></a><span>                      </span><span class="hs-glyph">|</span><span> </span><a name="SuggestHidden"><a href="Packages.html#SuggestHidden"><span class="hs-identifier">SuggestHidden</span></a></a><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-1921"></a><span>
</span><a name="line-1922"></a><span class="hs-identifier">lookupModuleWithSuggestions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1923"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span>
</span><a name="line-1924"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-1925"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupResult"><span class="hs-identifier hs-type">LookupResult</span></a><span>
</span><a name="line-1926"></a><a name="lookupModuleWithSuggestions"><a href="Packages.html#lookupModuleWithSuggestions"><span class="hs-identifier">lookupModuleWithSuggestions</span></a></a><span> </span><a name="local-6989586621681220595"><a href="#local-6989586621681220595"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1927"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#lookupModuleWithSuggestions%27"><span class="hs-identifier hs-var">lookupModuleWithSuggestions'</span></a><span> </span><a href="#local-6989586621681220595"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1928"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">moduleToPkgConfAll</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681220595"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1929"></a><span>
</span><a name="line-1930"></a><span class="hs-identifier">lookupPluginModuleWithSuggestions</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1931"></a><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span>
</span><a name="line-1932"></a><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-1933"></a><span>                                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupResult"><span class="hs-identifier hs-type">LookupResult</span></a><span>
</span><a name="line-1934"></a><a name="lookupPluginModuleWithSuggestions"><a href="Packages.html#lookupPluginModuleWithSuggestions"><span class="hs-identifier">lookupPluginModuleWithSuggestions</span></a></a><span> </span><a name="local-6989586621681220596"><a href="#local-6989586621681220596"><span class="hs-identifier">dflags</span></a></a><span>
</span><a name="line-1935"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#lookupModuleWithSuggestions%27"><span class="hs-identifier hs-var">lookupModuleWithSuggestions'</span></a><span> </span><a href="#local-6989586621681220596"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-1936"></a><span>        </span><span class="hs-special">(</span><span class="hs-identifier">pluginModuleToPkgConfAll</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681220596"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-1937"></a><span>
</span><a name="line-1938"></a><span class="hs-identifier">lookupModuleWithSuggestions'</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-1939"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier hs-type">ModuleToPkgConfAll</span></a><span>
</span><a name="line-1940"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span>
</span><a name="line-1941"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-1942"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupResult"><span class="hs-identifier hs-type">LookupResult</span></a><span>
</span><a name="line-1943"></a><a name="lookupModuleWithSuggestions%27"><a href="Packages.html#lookupModuleWithSuggestions%27"><span class="hs-identifier">lookupModuleWithSuggestions'</span></a></a><span> </span><a name="local-6989586621681220597"><a href="#local-6989586621681220597"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220598"><a href="#local-6989586621681220598"><span class="hs-identifier">mod_map</span></a></a><span> </span><a name="local-6989586621681220599"><a href="#local-6989586621681220599"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621681220600"><a href="#local-6989586621681220600"><span class="hs-identifier">mb_pn</span></a></a><span>
</span><a name="line-1944"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">Map.lookup</span><span> </span><a href="#local-6989586621681220599"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="#local-6989586621681220598"><span class="hs-identifier hs-var">mod_map</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1945"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupNotFound"><span class="hs-identifier hs-var">LookupNotFound</span></a><span> </span><a href="#local-6989586621681220605"><span class="hs-identifier hs-var">suggestions</span></a><span>
</span><a name="line-1946"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220632"><a href="#local-6989586621681220632"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1947"></a><span>          </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><a href="#local-6989586621681220601"><span class="hs-identifier hs-var">classify</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220632"><span class="hs-identifier hs-var">xs</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1948"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupNotFound"><span class="hs-identifier hs-var">LookupNotFound</span></a><span> </span><a href="#local-6989586621681220605"><span class="hs-identifier hs-var">suggestions</span></a><span>
</span><a name="line-1949"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a name="local-6989586621681220633"><a href="#local-6989586621681220633"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupFound"><span class="hs-identifier hs-var">LookupFound</span></a><span> </span><a href="#local-6989586621681220633"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220603"><span class="hs-identifier hs-var">mod_pkg</span></a><span> </span><a href="#local-6989586621681220633"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1950"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220634"><a href="#local-6989586621681220634"><span class="hs-identifier">exposed</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupMultiple"><span class="hs-identifier hs-var">LookupMultiple</span></a><span> </span><a href="#local-6989586621681220634"><span class="hs-identifier hs-var">exposed</span></a><span>
</span><a name="line-1951"></a><span>            </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220635"><a href="#local-6989586621681220635"><span class="hs-identifier">unusable</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#LookupUnusable"><span class="hs-identifier hs-var">LookupUnusable</span></a><span> </span><a href="#local-6989586621681220635"><span class="hs-identifier hs-var">unusable</span></a><span>
</span><a name="line-1952"></a><span>            </span><span class="hs-special">(</span><a name="local-6989586621681220636"><a href="#local-6989586621681220636"><span class="hs-identifier">hidden_pkg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220637"><a href="#local-6989586621681220637"><span class="hs-identifier">hidden_mod</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-1953"></a><span>              </span><a href="Packages.html#LookupHidden"><span class="hs-identifier hs-var">LookupHidden</span></a><span> </span><a href="#local-6989586621681220636"><span class="hs-identifier hs-var">hidden_pkg</span></a><span> </span><a href="#local-6989586621681220637"><span class="hs-identifier hs-var">hidden_mod</span></a><span>
</span><a name="line-1954"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-1955"></a><span>    </span><a name="local-6989586621681220601"><a href="#local-6989586621681220601"><span class="hs-identifier">classify</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220608"><a href="#local-6989586621681220608"><span class="hs-identifier">hidden_pkg</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220609"><a href="#local-6989586621681220609"><span class="hs-identifier">hidden_mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220610"><a href="#local-6989586621681220610"><span class="hs-identifier">unusable</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220611"><a href="#local-6989586621681220611"><span class="hs-identifier">exposed</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220612"><a href="#local-6989586621681220612"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220613"><a href="#local-6989586621681220613"><span class="hs-identifier">origin0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1956"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220614"><a href="#local-6989586621681220614"><span class="hs-identifier">origin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220604"><span class="hs-identifier hs-var">filterOrigin</span></a><span> </span><a href="#local-6989586621681220600"><span class="hs-identifier hs-var">mb_pn</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220603"><span class="hs-identifier hs-var">mod_pkg</span></a><span> </span><a href="#local-6989586621681220612"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220613"><span class="hs-identifier hs-var">origin0</span></a><span>
</span><a name="line-1957"></a><span>          </span><a name="local-6989586621681220615"><a href="#local-6989586621681220615"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220612"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220614"><span class="hs-identifier hs-var">origin</span></a><span class="hs-special">)</span><span>
</span><a name="line-1958"></a><span>      </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220614"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1959"></a><span>          </span><a href="Packages.html#ModHidden"><span class="hs-identifier hs-var">ModHidden</span></a><span>
</span><a name="line-1960"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220608"><span class="hs-identifier hs-var">hidden_pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220615"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681220609"><span class="hs-identifier hs-var">hidden_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220610"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220611"><span class="hs-identifier hs-var">exposed</span></a><span class="hs-special">)</span><span>
</span><a name="line-1961"></a><span>          </span><a href="Packages.html#ModUnusable"><span class="hs-identifier hs-var">ModUnusable</span></a><span> </span><span class="hs-identifier">_</span><span>
</span><a name="line-1962"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220608"><span class="hs-identifier hs-var">hidden_pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220609"><span class="hs-identifier hs-var">hidden_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220615"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681220610"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220611"><span class="hs-identifier hs-var">exposed</span></a><span class="hs-special">)</span><span>
</span><a name="line-1963"></a><span>          </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">|</span><span> </span><a href="Packages.html#originEmpty"><span class="hs-identifier hs-var">originEmpty</span></a><span> </span><a href="#local-6989586621681220614"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-1964"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220608"><span class="hs-identifier hs-var">hidden_pkg</span></a><span class="hs-special">,</span><span>   </span><a href="#local-6989586621681220609"><span class="hs-identifier hs-var">hidden_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220610"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220611"><span class="hs-identifier hs-var">exposed</span></a><span class="hs-special">)</span><span>
</span><a name="line-1965"></a><span>            </span><span class="hs-glyph">|</span><span> </span><a href="Packages.html#originVisible"><span class="hs-identifier hs-var">originVisible</span></a><span> </span><a href="#local-6989586621681220614"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-1966"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220608"><span class="hs-identifier hs-var">hidden_pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220609"><span class="hs-identifier hs-var">hidden_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220610"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220615"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681220611"><span class="hs-identifier hs-var">exposed</span></a><span class="hs-special">)</span><span>
</span><a name="line-1967"></a><span>            </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>
</span><a name="line-1968"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220615"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621681220608"><span class="hs-identifier hs-var">hidden_pkg</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220609"><span class="hs-identifier hs-var">hidden_mod</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220610"><span class="hs-identifier hs-var">unusable</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220611"><span class="hs-identifier hs-var">exposed</span></a><span class="hs-special">)</span><span>
</span><a name="line-1969"></a><span>
</span><a name="line-1970"></a><span>    </span><a name="local-6989586621681220602"><a href="#local-6989586621681220602"><span class="hs-identifier">pkg_lookup</span></a></a><span> </span><a name="local-6989586621681220616"><a href="#local-6989586621681220616"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#lookupPackage"><span class="hs-identifier hs-var">lookupPackage</span></a><span> </span><a href="#local-6989586621681220597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220616"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><a href="Maybes.html#orElse"><span class="hs-identifier hs-var">orElse</span></a><span class="hs-special">`</span><span> </span><a href="Outputable.html#pprPanic"><span class="hs-identifier hs-var">pprPanic</span></a><span> </span><span class="hs-string">&quot;lookupModuleWithSuggestions&quot;</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220616"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220599"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1971"></a><span>    </span><a name="local-6989586621681220603"><a href="#local-6989586621681220603"><span class="hs-identifier">mod_pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220602"><span class="hs-identifier hs-var">pkg_lookup</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">moduleUnitId</span><span>
</span><a name="line-1972"></a><span>
</span><a name="line-1973"></a><span>    </span><span class="hs-comment">-- Filters out origins which are not associated with the given package</span><span>
</span><a name="line-1974"></a><span>    </span><span class="hs-comment">-- qualifier.  No-op if there is no package qualifier.  Test if this</span><span>
</span><a name="line-1975"></a><span>    </span><span class="hs-comment">-- excluded all origins with 'originEmpty'.</span><span>
</span><a name="line-1976"></a><span>    </span><span class="hs-identifier">filterOrigin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-1977"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span>
</span><a name="line-1978"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-1979"></a><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModuleOrigin"><span class="hs-identifier hs-type">ModuleOrigin</span></a><span>
</span><a name="line-1980"></a><span>    </span><a name="local-6989586621681220604"><a href="#local-6989586621681220604"><span class="hs-identifier">filterOrigin</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681220617"><a href="#local-6989586621681220617"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220617"><span class="hs-identifier hs-var">o</span></a><span>
</span><a name="line-1981"></a><span>    </span><span class="hs-identifier">filterOrigin</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220618"><a href="#local-6989586621681220618"><span class="hs-identifier">pn</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621681220619"><a href="#local-6989586621681220619"><span class="hs-identifier">pkg</span></a></a><span> </span><a name="local-6989586621681220620"><a href="#local-6989586621681220620"><span class="hs-identifier">o</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1982"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220620"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-1983"></a><span>          </span><a href="Packages.html#ModHidden"><span class="hs-identifier hs-var">ModHidden</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681220621"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220619"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Packages.html#ModHidden"><span class="hs-identifier hs-var">ModHidden</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-1984"></a><span>          </span><span class="hs-special">(</span><a href="Packages.html#ModUnusable"><span class="hs-identifier hs-var">ModUnusable</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681220621"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220619"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681220620"><span class="hs-identifier hs-var">o</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-1985"></a><span>          </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">fromOrigPackage</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681220623"><a href="#local-6989586621681220623"><span class="hs-identifier">e</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromExposedReexport</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681220624"><a href="#local-6989586621681220624"><span class="hs-identifier">res</span></a></a><span class="hs-special">,</span><span>
</span><a name="line-1986"></a><span>                      </span><span class="hs-identifier">fromHiddenReexport</span><span> </span><span class="hs-glyph">=</span><span> </span><a name="local-6989586621681220625"><a href="#local-6989586621681220625"><span class="hs-identifier">rhs</span></a></a><span> </span><span class="hs-special">}</span><span>
</span><a name="line-1987"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#ModOrigin"><span class="hs-identifier hs-var">ModOrigin</span></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-1988"></a><span>                  </span><span class="hs-identifier">fromOrigPackage</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621681220621"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220619"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="#local-6989586621681220623"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-1989"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromExposedReexport</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681220621"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220624"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-1990"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromHiddenReexport</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681220621"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621681220625"><span class="hs-identifier hs-var">rhs</span></a><span>
</span><a name="line-1991"></a><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">fromPackageFlag</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span> </span><span class="hs-comment">-- always excluded</span><span>
</span><a name="line-1992"></a><span>                </span><span class="hs-special">}</span><span>
</span><a name="line-1993"></a><span>      </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220621"><a href="#local-6989586621681220621"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621681220622"><a href="#local-6989586621681220622"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220618"><span class="hs-identifier hs-var">pn</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="Packages.html#fsPackageName"><span class="hs-identifier hs-var">fsPackageName</span></a><span> </span><a href="#local-6989586621681220622"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-1994"></a><span>
</span><a name="line-1995"></a><span>    </span><a name="local-6989586621681220605"><a href="#local-6989586621681220605"><span class="hs-identifier">suggestions</span></a></a><span>
</span><a name="line-1996"></a><span>      </span><span class="hs-glyph">|</span><span> </span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_HelpfulErrors"><span class="hs-identifier hs-var">Opt_HelpfulErrors</span></a><span> </span><a href="#local-6989586621681220597"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1997"></a><span>           </span><a href="Util.html#fuzzyLookup"><span class="hs-identifier hs-var">fuzzyLookup</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#moduleNameString"><span class="hs-identifier hs-var">moduleNameString</span></a><span> </span><a href="#local-6989586621681220599"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220606"><span class="hs-identifier hs-var">all_mods</span></a><span>
</span><a name="line-1998"></a><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1999"></a><span>
</span><a name="line-2000"></a><span>    </span><span class="hs-identifier">all_mods</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">String</span><span class="hs-special">,</span><span> </span><a href="Packages.html#ModuleSuggestion"><span class="hs-identifier hs-type">ModuleSuggestion</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>     </span><span class="hs-comment">-- All modules</span><span>
</span><a name="line-2001"></a><span>    </span><a name="local-6989586621681220606"><a href="#local-6989586621681220606"><span class="hs-identifier">all_mods</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sortBy</span><span> </span><span class="hs-special">(</span><a href="Packages.html#comparing"><span class="hs-identifier hs-var">comparing</span></a><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2002"></a><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><a href="Module.html#moduleNameString"><span class="hs-identifier hs-var">moduleNameString</span></a><span> </span><a href="#local-6989586621681220626"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220628"><span class="hs-identifier hs-var">suggestion</span></a><span class="hs-special">)</span><span>
</span><a name="line-2003"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><a name="local-6989586621681220626"><a href="#local-6989586621681220626"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220627"><a href="#local-6989586621681220627"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">Map.toList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleToPkgConfAll</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681220597"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2004"></a><span>        </span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220628"><a href="#local-6989586621681220628"><span class="hs-identifier">suggestion</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220607"><span class="hs-identifier hs-var">getSuggestion</span></a><span> </span><a href="#local-6989586621681220626"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220627"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span>
</span><a name="line-2005"></a><span>        </span><span class="hs-special">]</span><span>
</span><a name="line-2006"></a><span>    </span><a name="local-6989586621681220607"><a href="#local-6989586621681220607"><span class="hs-identifier">getSuggestion</span></a></a><span> </span><a name="local-6989586621681220629"><a href="#local-6989586621681220629"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220630"><a href="#local-6989586621681220630"><span class="hs-identifier">mod</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220631"><a href="#local-6989586621681220631"><span class="hs-identifier">origin</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2007"></a><span>        </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><a href="Packages.html#originVisible"><span class="hs-identifier hs-var">originVisible</span></a><span> </span><a href="#local-6989586621681220631"><span class="hs-identifier hs-var">origin</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Packages.html#SuggestVisible"><span class="hs-identifier hs-var">SuggestVisible</span></a><span> </span><span class="hs-keyword">else</span><span> </span><a href="Packages.html#SuggestHidden"><span class="hs-identifier hs-var">SuggestHidden</span></a><span class="hs-special">)</span><span>
</span><a name="line-2008"></a><span>            </span><a href="#local-6989586621681220629"><span class="hs-identifier hs-var">name</span></a><span> </span><a href="#local-6989586621681220630"><span class="hs-identifier hs-var">mod</span></a><span> </span><a href="#local-6989586621681220631"><span class="hs-identifier hs-var">origin</span></a><span>
</span><a name="line-2009"></a><span>
</span><a name="line-2010"></a><span class="hs-identifier">listVisibleModuleNames</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span class="hs-special">]</span><span>
</span><a name="line-2011"></a><a name="listVisibleModuleNames"><a href="Packages.html#listVisibleModuleNames"><span class="hs-identifier">listVisibleModuleNames</span></a></a><span> </span><a name="local-6989586621681220638"><a href="#local-6989586621681220638"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2012"></a><span>    </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">fst</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">filter</span><span> </span><a href="#local-6989586621681220639"><span class="hs-identifier hs-var">visible</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleToPkgConfAll</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681220638"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2013"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220639"><a href="#local-6989586621681220639"><span class="hs-identifier">visible</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621681220640"><a href="#local-6989586621681220640"><span class="hs-identifier">ms</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><a href="Packages.html#originVisible"><span class="hs-identifier hs-var">originVisible</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.elems</span><span> </span><a href="#local-6989586621681220640"><span class="hs-identifier hs-var">ms</span></a><span class="hs-special">)</span><span>
</span><a name="line-2014"></a><span>
</span><a name="line-2015"></a><span class="hs-comment">-- | Find all the 'PackageConfig' in both the preload packages from 'DynFlags' and corresponding to the list of</span><span>
</span><a name="line-2016"></a><span class="hs-comment">-- 'PackageConfig's</span><span>
</span><a name="line-2017"></a><span class="hs-identifier">getPreloadPackagesAnd</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span class="hs-special">]</span><span>
</span><a name="line-2018"></a><a name="getPreloadPackagesAnd"><a href="Packages.html#getPreloadPackagesAnd"><span class="hs-identifier">getPreloadPackagesAnd</span></a></a><span> </span><a name="local-6989586621681220641"><a href="#local-6989586621681220641"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220642"><a href="#local-6989586621681220642"><span class="hs-identifier">pkgids0</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2019"></a><span>  </span><span class="hs-keyword">let</span><span>
</span><a name="line-2020"></a><span>      </span><a name="local-6989586621681220643"><a href="#local-6989586621681220643"><span class="hs-identifier">pkgids</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220642"><span class="hs-identifier hs-var">pkgids0</span></a><span> </span><span class="hs-operator hs-var">++</span><span>
</span><a name="line-2021"></a><span>                  </span><span class="hs-comment">-- An indefinite package will have insts to HOLE,</span><span>
</span><a name="line-2022"></a><span>                  </span><span class="hs-comment">-- which is not a real package. Don't look it up.</span><span>
</span><a name="line-2023"></a><span>                  </span><span class="hs-comment">-- Fixes #14525</span><span>
</span><a name="line-2024"></a><span>                  </span><span class="hs-keyword">if</span><span> </span><a href="Packages.html#isIndefinite"><span class="hs-identifier hs-var">isIndefinite</span></a><span> </span><a href="#local-6989586621681220641"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2025"></a><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-2026"></a><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Module.html#toInstalledUnitId"><span class="hs-identifier hs-var">toInstalledUnitId</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">snd</span><span class="hs-special">)</span><span>
</span><a name="line-2027"></a><span>                             </span><span class="hs-special">(</span><a href="DynFlags.html#thisUnitIdInsts"><span class="hs-identifier hs-var">thisUnitIdInsts</span></a><span> </span><a href="#local-6989586621681220641"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span>
</span><a name="line-2028"></a><span>      </span><a name="local-6989586621681220644"><a href="#local-6989586621681220644"><span class="hs-identifier">state</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pkgState</span><span> </span><a href="#local-6989586621681220641"><span class="hs-identifier hs-var">dflags</span></a><span>
</span><a name="line-2029"></a><span>      </span><a name="local-6989586621681220645"><a href="#local-6989586621681220645"><span class="hs-identifier">pkg_map</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pkgIdMap</span><span> </span><a href="#local-6989586621681220644"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-2030"></a><span>      </span><a name="local-6989586621681220646"><a href="#local-6989586621681220646"><span class="hs-identifier">preload</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">preloadPackages</span><span> </span><a href="#local-6989586621681220644"><span class="hs-identifier hs-var">state</span></a><span>
</span><a name="line-2031"></a><span>      </span><a name="local-6989586621681220647"><a href="#local-6989586621681220647"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621681220643"><span class="hs-identifier hs-var">pkgids</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">repeat</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-2032"></a><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2033"></a><span>  </span><a name="local-6989586621681220648"><a href="#local-6989586621681220648"><span class="hs-identifier">all_pkgs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#throwErr"><span class="hs-identifier hs-var">throwErr</span></a><span> </span><a href="#local-6989586621681220641"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#add_package"><span class="hs-identifier hs-var">add_package</span></a><span> </span><a href="#local-6989586621681220641"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220645"><span class="hs-identifier hs-var">pkg_map</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220646"><span class="hs-identifier hs-var">preload</span></a><span> </span><a href="#local-6989586621681220647"><span class="hs-identifier hs-var">pairs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2034"></a><span>  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Packages.html#getInstalledPackageDetails"><span class="hs-identifier hs-var">getInstalledPackageDetails</span></a><span> </span><a href="#local-6989586621681220641"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621681220648"><span class="hs-identifier hs-var">all_pkgs</span></a><span class="hs-special">)</span><span>
</span><a name="line-2035"></a><span>
</span><a name="line-2036"></a><span class="hs-comment">-- Takes a list of packages, and returns the list with dependencies included,</span><span>
</span><a name="line-2037"></a><span class="hs-comment">-- in reverse dependency order (a package appears before those it depends on).</span><span>
</span><a name="line-2038"></a><span class="hs-identifier">closeDeps</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-2039"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-2040"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2041"></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-2042"></a><a name="closeDeps"><a href="Packages.html#closeDeps"><span class="hs-identifier">closeDeps</span></a></a><span> </span><a name="local-6989586621681220649"><a href="#local-6989586621681220649"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220650"><a href="#local-6989586621681220650"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681220651"><a href="#local-6989586621681220651"><span class="hs-identifier">ps</span></a></a><span>
</span><a name="line-2043"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#throwErr"><span class="hs-identifier hs-var">throwErr</span></a><span> </span><a href="#local-6989586621681220649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#closeDepsErr"><span class="hs-identifier hs-var">closeDepsErr</span></a><span> </span><a href="#local-6989586621681220649"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220650"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681220651"><span class="hs-identifier hs-var">ps</span></a><span class="hs-special">)</span><span>
</span><a name="line-2044"></a><span>
</span><a name="line-2045"></a><span class="hs-identifier">throwErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Maybes.html#MaybeErr"><span class="hs-identifier hs-type">MaybeErr</span></a><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span> </span><a href="#local-6989586621681219906"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621681219906"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-2046"></a><a name="throwErr"><a href="Packages.html#throwErr"><span class="hs-identifier">throwErr</span></a></a><span> </span><a name="local-6989586621681220652"><a href="#local-6989586621681220652"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220653"><a href="#local-6989586621681220653"><span class="hs-identifier">m</span></a></a><span>
</span><a name="line-2047"></a><span>              </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621681220653"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2048"></a><span>                </span><a href="Maybes.html#Failed"><span class="hs-identifier hs-var">Failed</span></a><span> </span><a name="local-6989586621681220654"><a href="#local-6989586621681220654"><span class="hs-identifier">e</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Panic.html#throwGhcExceptionIO"><span class="hs-identifier hs-var">throwGhcExceptionIO</span></a><span> </span><span class="hs-special">(</span><a href="Panic.html#CmdLineError"><span class="hs-identifier hs-var">CmdLineError</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#showSDoc"><span class="hs-identifier hs-var">showSDoc</span></a><span> </span><a href="#local-6989586621681220652"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220654"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2049"></a><span>                </span><a href="Maybes.html#Succeeded"><span class="hs-identifier hs-var">Succeeded</span></a><span> </span><a name="local-6989586621681220655"><a href="#local-6989586621681220655"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681220655"><span class="hs-identifier hs-var">r</span></a><span>
</span><a name="line-2050"></a><span>
</span><a name="line-2051"></a><span class="hs-identifier">closeDepsErr</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-2052"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-2053"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-2054"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Maybes.html#MaybeErr"><span class="hs-identifier hs-type">MaybeErr</span></a><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span> </span><span class="hs-special">[</span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-2055"></a><a name="closeDepsErr"><a href="Packages.html#closeDepsErr"><span class="hs-identifier">closeDepsErr</span></a></a><span> </span><a name="local-6989586621681220656"><a href="#local-6989586621681220656"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220657"><a href="#local-6989586621681220657"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681220658"><a href="#local-6989586621681220658"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><span class="hs-special">(</span><a href="Packages.html#add_package"><span class="hs-identifier hs-var">add_package</span></a><span> </span><a href="#local-6989586621681220656"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220657"><span class="hs-identifier hs-var">pkg_map</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621681220658"><span class="hs-identifier hs-var">ps</span></a><span>
</span><a name="line-2056"></a><span>
</span><a name="line-2057"></a><span class="hs-comment">-- internal helper</span><span>
</span><a name="line-2058"></a><span class="hs-identifier">add_package</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span>
</span><a name="line-2059"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-2060"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-2061"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">,</span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">)</span><span>
</span><a name="line-2062"></a><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Maybes.html#MaybeErr"><span class="hs-identifier hs-type">MaybeErr</span></a><span> </span><a href="ErrUtils.html#MsgDoc"><span class="hs-identifier hs-type">MsgDoc</span></a><span> </span><span class="hs-special">[</span><a href="Packages.html#PreloadUnitId"><span class="hs-identifier hs-type">PreloadUnitId</span></a><span class="hs-special">]</span><span>
</span><a name="line-2063"></a><a name="add_package"><a href="Packages.html#add_package"><span class="hs-identifier">add_package</span></a></a><span> </span><a name="local-6989586621681220659"><a href="#local-6989586621681220659"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220660"><a href="#local-6989586621681220660"><span class="hs-identifier">pkg_db</span></a></a><span> </span><a name="local-6989586621681220661"><a href="#local-6989586621681220661"><span class="hs-identifier">ps</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220662"><a href="#local-6989586621681220662"><span class="hs-identifier">p</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621681220663"><a href="#local-6989586621681220663"><span class="hs-identifier">mb_parent</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2064"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681220662"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">elem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621681220661"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621681220661"><span class="hs-identifier hs-var">ps</span></a><span>     </span><span class="hs-comment">-- Check if we've already added this package</span><span>
</span><a name="line-2065"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2066"></a><span>      </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#lookupInstalledPackage%27"><span class="hs-identifier hs-var">lookupInstalledPackage'</span></a><span> </span><a href="#local-6989586621681220660"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><a href="#local-6989586621681220662"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2067"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Maybes.html#Failed"><span class="hs-identifier hs-var">Failed</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#missingPackageMsg"><span class="hs-identifier hs-var">missingPackageMsg</span></a><span> </span><a href="#local-6989586621681220662"><span class="hs-identifier hs-var">p</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span>
</span><a name="line-2068"></a><span>                           </span><a href="Packages.html#missingDependencyMsg"><span class="hs-identifier hs-var">missingDependencyMsg</span></a><span> </span><a href="#local-6989586621681220663"><span class="hs-identifier hs-var">mb_parent</span></a><span class="hs-special">)</span><span>
</span><a name="line-2069"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220664"><a href="#local-6989586621681220664"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2070"></a><span>           </span><span class="hs-comment">-- Add the package's dependents also</span><span>
</span><a name="line-2071"></a><span>           </span><a name="local-6989586621681220668"><a href="#local-6989586621681220668"><span class="hs-identifier">ps'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">foldM</span><span> </span><a href="#local-6989586621681220665"><span class="hs-identifier hs-var">add_unit_key</span></a><span> </span><a href="#local-6989586621681220661"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">depends</span><span> </span><a href="#local-6989586621681220664"><span class="hs-identifier hs-var">pkg</span></a><span class="hs-special">)</span><span>
</span><a name="line-2072"></a><span>           </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220662"><span class="hs-identifier hs-var">p</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621681220668"><span class="hs-identifier hs-var">ps'</span></a><span class="hs-special">)</span><span>
</span><a name="line-2073"></a><span>          </span><span class="hs-keyword">where</span><span>
</span><a name="line-2074"></a><span>            </span><a name="local-6989586621681220665"><a href="#local-6989586621681220665"><span class="hs-identifier">add_unit_key</span></a></a><span> </span><a name="local-6989586621681220666"><a href="#local-6989586621681220666"><span class="hs-identifier">ps</span></a></a><span> </span><a name="local-6989586621681220667"><a href="#local-6989586621681220667"><span class="hs-identifier">key</span></a></a><span>
</span><a name="line-2075"></a><span>              </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#add_package"><span class="hs-identifier hs-var">add_package</span></a><span> </span><a href="#local-6989586621681220659"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220660"><span class="hs-identifier hs-var">pkg_db</span></a><span> </span><a href="#local-6989586621681220666"><span class="hs-identifier hs-var">ps</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220667"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621681220662"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span>
</span><a name="line-2076"></a><span>
</span><a name="line-2077"></a><span class="hs-identifier">missingPackageMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621681219905"><span class="hs-identifier hs-type">pkgid</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621681219905"><span class="hs-identifier hs-type">pkgid</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2078"></a><a name="missingPackageMsg"><a href="Packages.html#missingPackageMsg"><span class="hs-identifier">missingPackageMsg</span></a></a><span> </span><a name="local-6989586621681220669"><a href="#local-6989586621681220669"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;unknown package:&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220669"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-2079"></a><span>
</span><a name="line-2080"></a><span class="hs-identifier">missingDependencyMsg</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2081"></a><a name="missingDependencyMsg"><a href="Packages.html#missingDependencyMsg"><span class="hs-identifier">missingDependencyMsg</span></a></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#empty"><span class="hs-identifier hs-var">Outputable.empty</span></a><span>
</span><a name="line-2082"></a><span class="hs-identifier">missingDependencyMsg</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220670"><a href="#local-6989586621681220670"><span class="hs-identifier">parent</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2083"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#space"><span class="hs-identifier hs-var">space</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;dependency of&quot;</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">installedUnitIdFS</span><span> </span><a href="#local-6989586621681220670"><span class="hs-identifier hs-var">parent</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2084"></a><span>
</span><a name="line-2085"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-2086"></a><span>
</span><a name="line-2087"></a><span class="hs-identifier">componentIdString</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#ComponentId"><span class="hs-identifier hs-type">ComponentId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-2088"></a><a name="componentIdString"><a href="Packages.html#componentIdString"><span class="hs-identifier">componentIdString</span></a></a><span> </span><a name="local-6989586621681220671"><a href="#local-6989586621681220671"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220672"><a href="#local-6989586621681220672"><span class="hs-identifier">cid</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-2089"></a><span>    </span><a name="local-6989586621681220673"><a href="#local-6989586621681220673"><span class="hs-identifier">conf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Packages.html#lookupInstalledPackage"><span class="hs-identifier hs-var">lookupInstalledPackage</span></a><span> </span><a href="#local-6989586621681220671"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-special">(</span><a href="Module.html#componentIdToInstalledUnitId"><span class="hs-identifier hs-var">componentIdToInstalledUnitId</span></a><span> </span><a href="#local-6989586621681220672"><span class="hs-identifier hs-var">cid</span></a><span class="hs-special">)</span><span>
</span><a name="line-2090"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-2091"></a><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">sourceLibName</span><span> </span><a href="#local-6989586621681220673"><span class="hs-identifier hs-var">conf</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2092"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="PackageConfig.html#sourcePackageIdString"><span class="hs-identifier hs-var">sourcePackageIdString</span></a><span> </span><a href="#local-6989586621681220673"><span class="hs-identifier hs-var">conf</span></a><span>
</span><a name="line-2093"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#PackageName"><span class="hs-identifier hs-var">PackageName</span></a><span> </span><a name="local-6989586621681220674"><a href="#local-6989586621681220674"><span class="hs-identifier">libname</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2094"></a><span>                </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span> </span><a href="#local-6989586621681220673"><span class="hs-identifier hs-var">conf</span></a><span>
</span><a name="line-2095"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;-&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-identifier hs-var">showVersion</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">packageVersion</span><span> </span><a href="#local-6989586621681220673"><span class="hs-identifier hs-var">conf</span></a><span class="hs-special">)</span><span>
</span><a name="line-2096"></a><span>                    </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot;:&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a><span> </span><a href="#local-6989586621681220674"><span class="hs-identifier hs-var">libname</span></a><span>
</span><a name="line-2097"></a><span>
</span><a name="line-2098"></a><span class="hs-identifier">displayInstalledUnitId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#InstalledUnitId"><span class="hs-identifier hs-type">InstalledUnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">String</span><span>
</span><a name="line-2099"></a><a name="displayInstalledUnitId"><a href="Packages.html#displayInstalledUnitId"><span class="hs-identifier">displayInstalledUnitId</span></a></a><span> </span><a name="local-6989586621681220675"><a href="#local-6989586621681220675"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220676"><a href="#local-6989586621681220676"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2100"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><a href="PackageConfig.html#sourcePackageIdString"><span class="hs-identifier hs-var">sourcePackageIdString</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#lookupInstalledPackage"><span class="hs-identifier hs-var">lookupInstalledPackage</span></a><span> </span><a href="#local-6989586621681220675"><span class="hs-identifier hs-var">dflags</span></a><span> </span><a href="#local-6989586621681220676"><span class="hs-identifier hs-var">uid</span></a><span class="hs-special">)</span><span>
</span><a name="line-2101"></a><span>
</span><a name="line-2102"></a><span class="hs-comment">-- | Will the 'Name' come from a dynamically linked library?</span><span>
</span><a name="line-2103"></a><span class="hs-identifier">isDllName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Name.html#Name"><span class="hs-identifier hs-type">Name</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-2104"></a><span class="hs-comment">-- Despite the &quot;dll&quot;, I think this function just means that</span><span>
</span><a name="line-2105"></a><span class="hs-comment">-- the symbol comes from another dynamically-linked package,</span><span>
</span><a name="line-2106"></a><span class="hs-comment">-- and applies on all platforms, not just Windows</span><span>
</span><a name="line-2107"></a><a name="isDllName"><a href="Packages.html#isDllName"><span class="hs-identifier">isDllName</span></a></a><span> </span><a name="local-6989586621681220677"><a href="#local-6989586621681220677"><span class="hs-identifier">dflags</span></a></a><span> </span><a name="local-6989586621681220678"><a href="#local-6989586621681220678"><span class="hs-identifier">this_mod</span></a></a><span> </span><a name="local-6989586621681220679"><a href="#local-6989586621681220679"><span class="hs-identifier">name</span></a></a><span>
</span><a name="line-2108"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><a href="DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a><span> </span><a href="DynFlags.html#Opt_ExternalDynamicRefs"><span class="hs-identifier hs-var">Opt_ExternalDynamicRefs</span></a><span> </span><a href="#local-6989586621681220677"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-2109"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220680"><a href="#local-6989586621681220680"><span class="hs-identifier">mod</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Name.html#nameModule_maybe"><span class="hs-identifier hs-var">nameModule_maybe</span></a><span> </span><a href="#local-6989586621681220679"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-2110"></a><span>    </span><span class="hs-comment">-- Issue #8696 - when GHC is dynamically linked, it will attempt</span><span>
</span><a name="line-2111"></a><span>    </span><span class="hs-comment">-- to load the dynamic dependencies of object files at compile</span><span>
</span><a name="line-2112"></a><span>    </span><span class="hs-comment">-- time for things like QuasiQuotes or</span><span>
</span><a name="line-2113"></a><span>    </span><span class="hs-comment">-- TemplateHaskell. Unfortunately, this interacts badly with</span><span>
</span><a name="line-2114"></a><span>    </span><span class="hs-comment">-- intra-package linking, because we don't generate indirect</span><span>
</span><a name="line-2115"></a><span>    </span><span class="hs-comment">-- (dynamic) symbols for intra-package calls. This means that if a</span><span>
</span><a name="line-2116"></a><span>    </span><span class="hs-comment">-- module with an intra-package call is loaded without its</span><span>
</span><a name="line-2117"></a><span>    </span><span class="hs-comment">-- dependencies, then GHC fails to link. This is the cause of #</span><span>
</span><a name="line-2118"></a><span>    </span><span class="hs-comment">--</span><span>
</span><a name="line-2119"></a><span>    </span><span class="hs-comment">-- In the mean time, always force dynamic indirections to be</span><span>
</span><a name="line-2120"></a><span>    </span><span class="hs-comment">-- generated: when the module name isn't the module being</span><span>
</span><a name="line-2121"></a><span>    </span><span class="hs-comment">-- compiled, references are dynamic.</span><span>
</span><a name="line-2122"></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">platformOS</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DynFlags.html#targetPlatform"><span class="hs-identifier hs-var">targetPlatform</span></a><span> </span><a href="#local-6989586621681220677"><span class="hs-identifier hs-var">dflags</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2123"></a><span>        </span><span class="hs-comment">-- On Windows the hack for #8696 makes it unlinkable.</span><span>
</span><a name="line-2124"></a><span>        </span><span class="hs-comment">-- As the entire setup of the code from Cmm down to the RTS expects</span><span>
</span><a name="line-2125"></a><span>        </span><span class="hs-comment">-- the use of trampolines for the imported functions only when</span><span>
</span><a name="line-2126"></a><span>        </span><span class="hs-comment">-- doing intra-package linking, e.g. refering to a symbol defined in the same</span><span>
</span><a name="line-2127"></a><span>        </span><span class="hs-comment">-- package should not use a trampoline.</span><span>
</span><a name="line-2128"></a><span>        </span><span class="hs-comment">-- I much rather have dynamic TH not supported than the entire Dynamic linking</span><span>
</span><a name="line-2129"></a><span>        </span><span class="hs-comment">-- not due to a hack.</span><span>
</span><a name="line-2130"></a><span>        </span><span class="hs-comment">-- Also not sure this would break on Windows anyway.</span><span>
</span><a name="line-2131"></a><span>        </span><a href="Platform.html#OSMinGW32"><span class="hs-identifier hs-var">OSMinGW32</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681220680"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681220678"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-2132"></a><span>
</span><a name="line-2133"></a><span>        </span><span class="hs-comment">-- For the other platforms, still perform the hack</span><span>
</span><a name="line-2134"></a><span>        </span><span class="hs-identifier">_</span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220680"><span class="hs-identifier hs-var">mod</span></a><span> </span><span class="hs-operator hs-var">/=</span><span> </span><a href="#local-6989586621681220678"><span class="hs-identifier hs-var">this_mod</span></a><span>
</span><a name="line-2135"></a><span>
</span><a name="line-2136"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>  </span><span class="hs-comment">-- no, it is not even an external name</span><span>
</span><a name="line-2137"></a><span>
</span><a name="line-2138"></a><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><a name="line-2139"></a><span class="hs-comment">-- Displaying packages</span><span>
</span><a name="line-2140"></a><span>
</span><a name="line-2141"></a><span class="hs-comment">-- | Show (very verbose) package info</span><span>
</span><a name="line-2142"></a><span class="hs-identifier">pprPackages</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2143"></a><a name="pprPackages"><a href="Packages.html#pprPackages"><span class="hs-identifier">pprPackages</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#pprPackagesWith"><span class="hs-identifier hs-var">pprPackagesWith</span></a><span> </span><a href="PackageConfig.html#pprPackageConfig"><span class="hs-identifier hs-var">pprPackageConfig</span></a><span>
</span><a name="line-2144"></a><span>
</span><a name="line-2145"></a><span class="hs-identifier">pprPackagesWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2146"></a><a name="pprPackagesWith"><a href="Packages.html#pprPackagesWith"><span class="hs-identifier">pprPackagesWith</span></a></a><span> </span><a name="local-6989586621681220681"><a href="#local-6989586621681220681"><span class="hs-identifier">pprIPI</span></a></a><span> </span><a name="local-6989586621681220682"><a href="#local-6989586621681220682"><span class="hs-identifier">dflags</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2147"></a><span>    </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">intersperse</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;---&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220681"><span class="hs-identifier hs-var">pprIPI</span></a><span> </span><span class="hs-special">(</span><a href="Packages.html#listPackageConfigMap"><span class="hs-identifier hs-var">listPackageConfigMap</span></a><span> </span><a href="#local-6989586621681220682"><span class="hs-identifier hs-var">dflags</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2148"></a><span>
</span><a name="line-2149"></a><span class="hs-comment">-- | Show simplified package info.</span><span>
</span><a name="line-2150"></a><span class="hs-comment">--</span><span>
</span><a name="line-2151"></a><span class="hs-comment">-- The idea is to only print package id, and any information that might</span><span>
</span><a name="line-2152"></a><span class="hs-comment">-- be different from the package databases (exposure, trust)</span><span>
</span><a name="line-2153"></a><span class="hs-identifier">pprPackagesSimple</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2154"></a><a name="pprPackagesSimple"><a href="Packages.html#pprPackagesSimple"><span class="hs-identifier">pprPackagesSimple</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Packages.html#pprPackagesWith"><span class="hs-identifier hs-var">pprPackagesWith</span></a><span> </span><a href="#local-6989586621681220683"><span class="hs-identifier hs-var">pprIPI</span></a><span>
</span><a name="line-2155"></a><span>    </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621681220683"><a href="#local-6989586621681220683"><span class="hs-identifier">pprIPI</span></a></a><span> </span><a name="local-6989586621681220684"><a href="#local-6989586621681220684"><span class="hs-identifier">ipi</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621681220685"><a href="#local-6989586621681220685"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">installedUnitIdFS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">unitId</span><span> </span><a href="#local-6989586621681220684"><span class="hs-identifier hs-var">ipi</span></a><span class="hs-special">)</span><span>
</span><a name="line-2156"></a><span>                           </span><a name="local-6989586621681220686"><a href="#local-6989586621681220686"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">exposed</span><span> </span><a href="#local-6989586621681220684"><span class="hs-identifier hs-var">ipi</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;E&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; &quot;</span><span>
</span><a name="line-2157"></a><span>                           </span><a name="local-6989586621681220687"><a href="#local-6989586621681220687"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">trusted</span><span> </span><a href="#local-6989586621681220684"><span class="hs-identifier hs-var">ipi</span></a><span> </span><span class="hs-keyword">then</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;T&quot;</span><span> </span><span class="hs-keyword">else</span><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot; &quot;</span><span>
</span><a name="line-2158"></a><span>                       </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621681220686"><span class="hs-identifier hs-var">e</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="#local-6989586621681220687"><span class="hs-identifier hs-var">t</span></a><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#text"><span class="hs-identifier hs-var">text</span></a><span> </span><span class="hs-string">&quot;  &quot;</span><span> </span><a href="Outputable.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a><span> </span><a href="Outputable.html#ftext"><span class="hs-identifier hs-var">ftext</span></a><span> </span><a href="#local-6989586621681220685"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-2159"></a><span>
</span><a name="line-2160"></a><span class="hs-comment">-- | Show the mapping of modules to where they come from.</span><span>
</span><a name="line-2161"></a><span class="hs-identifier">pprModuleMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#ModuleToPkgConfAll"><span class="hs-identifier hs-type">ModuleToPkgConfAll</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2162"></a><a name="pprModuleMap"><a href="Packages.html#pprModuleMap"><span class="hs-identifier">pprModuleMap</span></a></a><span> </span><a name="local-6989586621681220688"><a href="#local-6989586621681220688"><span class="hs-identifier">mod_map</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2163"></a><span>  </span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621681220689"><span class="hs-identifier hs-var">pprLine</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220688"><span class="hs-identifier hs-var">mod_map</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2164"></a><span>    </span><span class="hs-keyword">where</span><span>
</span><a name="line-2165"></a><span>      </span><a name="local-6989586621681220689"><a href="#local-6989586621681220689"><span class="hs-identifier">pprLine</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220692"><a href="#local-6989586621681220692"><span class="hs-identifier">m</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220693"><a href="#local-6989586621681220693"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220692"><span class="hs-identifier hs-var">m</span></a><span> </span><a href="Outputable.html#%24%24"><span class="hs-operator hs-var">$$</span></a><span> </span><a href="Outputable.html#nest"><span class="hs-identifier hs-var">nest</span></a><span> </span><span class="hs-number">50</span><span> </span><span class="hs-special">(</span><a href="Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621681220690"><span class="hs-identifier hs-var">pprEntry</span></a><span> </span><a href="#local-6989586621681220692"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Map.toList</span><span> </span><a href="#local-6989586621681220693"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-2166"></a><span>      </span><span class="hs-identifier">pprEntry</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Outputable.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a><span> </span><a href="#local-6989586621681220691"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Module.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Module.html#Module"><span class="hs-identifier hs-type">Module</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621681220691"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Outputable.html#SDoc"><span class="hs-identifier hs-type">SDoc</span></a><span>
</span><a name="line-2167"></a><span>      </span><a name="local-6989586621681220690"><a href="#local-6989586621681220690"><span class="hs-identifier">pprEntry</span></a></a><span> </span><a name="local-6989586621681220694"><a href="#local-6989586621681220694"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621681220695"><a href="#local-6989586621681220695"><span class="hs-identifier">m'</span></a></a><span class="hs-special">,</span><a name="local-6989586621681220696"><a href="#local-6989586621681220696"><span class="hs-identifier">o</span></a></a><span class="hs-special">)</span><span>
</span><a name="line-2168"></a><span>        </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621681220694"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier">moduleName</span><span> </span><a href="#local-6989586621681220695"><span class="hs-identifier hs-var">m'</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">moduleUnitId</span><span> </span><a href="#local-6989586621681220695"><span class="hs-identifier hs-var">m'</span></a><span class="hs-special">)</span><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220696"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-2169"></a><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220695"><span class="hs-identifier hs-var">m'</span></a><span> </span><a href="Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a><span> </span><a href="Outputable.html#parens"><span class="hs-identifier hs-var">parens</span></a><span> </span><span class="hs-special">(</span><a href="Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a><span> </span><a href="#local-6989586621681220696"><span class="hs-identifier hs-var">o</span></a><span class="hs-special">)</span><span>
</span><a name="line-2170"></a><span>
</span><a name="line-2171"></a><span class="hs-identifier">fsPackageName</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="PackageConfig.html#PackageConfig"><span class="hs-identifier hs-type">PackageConfig</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a><span>
</span><a name="line-2172"></a><a name="fsPackageName"><a href="Packages.html#fsPackageName"><span class="hs-identifier">fsPackageName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="FastString.html#mkFastString"><span class="hs-identifier hs-var">mkFastString</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="PackageConfig.html#packageNameString"><span class="hs-identifier hs-var">packageNameString</span></a><span>
</span><a name="line-2173"></a><span>
</span><a name="line-2174"></a><span class="hs-comment">-- | Given a fully instantiated 'UnitId', improve it into a</span><span>
</span><a name="line-2175"></a><span class="hs-comment">-- 'InstalledUnitId' if we can find it in the package database.</span><span>
</span><a name="line-2176"></a><span class="hs-identifier">improveUnitId</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Module.html#UnitId"><span class="hs-identifier hs-type">UnitId</span></a><span>
</span><a name="line-2177"></a><a name="improveUnitId"><a href="Packages.html#improveUnitId"><span class="hs-identifier">improveUnitId</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621681220697"><a href="#local-6989586621681220697"><span class="hs-identifier">uid</span></a></a><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Module.html#DefiniteUnitId"><span class="hs-identifier hs-var">DefiniteUnitId</span></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621681220697"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-comment">-- short circuit</span><span>
</span><a name="line-2178"></a><span class="hs-identifier">improveUnitId</span><span> </span><a name="local-6989586621681220698"><a href="#local-6989586621681220698"><span class="hs-identifier">pkg_map</span></a></a><span> </span><a name="local-6989586621681220699"><a href="#local-6989586621681220699"><span class="hs-identifier">uid</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-2179"></a><span>    </span><span class="hs-comment">-- Do NOT lookup indefinite ones, they won't be useful!</span><span>
</span><a name="line-2180"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Packages.html#lookupPackage%27"><span class="hs-identifier hs-var">lookupPackage'</span></a><span> </span><span class="hs-identifier hs-var">False</span><span> </span><a href="#local-6989586621681220698"><span class="hs-identifier hs-var">pkg_map</span></a><span> </span><a href="#local-6989586621681220699"><span class="hs-identifier hs-var">uid</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-2181"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621681220699"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-2182"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621681220700"><a href="#local-6989586621681220700"><span class="hs-identifier">pkg</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-2183"></a><span>            </span><span class="hs-comment">-- Do NOT improve if the indefinite unit id is not</span><span>
</span><a name="line-2184"></a><span>            </span><span class="hs-comment">-- part of the closure unique set.  See</span><span>
</span><a name="line-2185"></a><span>            </span><span class="hs-comment">-- Note [UnitId to InstalledUnitId improvement]</span><span>
</span><a name="line-2186"></a><span>            </span><span class="hs-keyword">if</span><span> </span><a href="PackageConfig.html#installedPackageConfigId"><span class="hs-identifier hs-var">installedPackageConfigId</span></a><span> </span><a href="#local-6989586621681220700"><span class="hs-identifier hs-var">pkg</span></a><span> </span><span class="hs-special">`</span><a href="UniqSet.html#elementOfUniqSet"><span class="hs-identifier hs-var">elementOfUniqSet</span></a><span class="hs-special">`</span><span> </span><span class="hs-identifier">preloadClosure</span><span> </span><a href="#local-6989586621681220698"><span class="hs-identifier hs-var">pkg_map</span></a><span>
</span><a name="line-2187"></a><span>                </span><span class="hs-keyword">then</span><span> </span><a href="PackageConfig.html#packageConfigId"><span class="hs-identifier hs-var">packageConfigId</span></a><span> </span><a href="#local-6989586621681220700"><span class="hs-identifier hs-var">pkg</span></a><span>
</span><a name="line-2188"></a><span>                </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621681220699"><span class="hs-identifier hs-var">uid</span></a><span>
</span><a name="line-2189"></a><span>
</span><a name="line-2190"></a><span class="hs-comment">-- | Retrieve the 'PackageConfigMap' from 'DynFlags'; used</span><span>
</span><a name="line-2191"></a><span class="hs-comment">-- in the @hs-boot@ loop-breaker.</span><span>
</span><a name="line-2192"></a><span class="hs-identifier">getPackageConfigMap</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="DynFlags.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Packages.html#PackageConfigMap"><span class="hs-identifier hs-type">PackageConfigMap</span></a><span>
</span><a name="line-2193"></a><a name="getPackageConfigMap"><a href="Packages.html#getPackageConfigMap"><span class="hs-identifier">getPackageConfigMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pkgIdMap</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">pkgState</span><span>
</span><a name="line-2194"></a></pre></body></html>